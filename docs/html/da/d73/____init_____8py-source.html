<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Emeraldion Lodge (codename Zelda): /Users/delphine/Development/SVN/emeraldion.it/zelda/node_modules/gulp-sass/node_modules/node-sass/node_modules/node-gyp/gyp/pylib/gyp/__init__.py Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css">
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.8 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="../../main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="../../files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="../../globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>/Users/delphine/Development/SVN/emeraldion.it/zelda/node_modules/gulp-sass/node_modules/node-sass/node_modules/node-gyp/gyp/pylib/gyp/__init__.py</h1><a href="../../d3/d9a/____init_____8py.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a><a class="code" href="../../d9/d41/namespacegyp.html">00001</a> <span class="comment">#!/usr/bin/env python</span>
<a name="l00002"></a>00002 
<a name="l00003"></a>00003 <span class="comment"># Copyright (c) 2012 Google Inc. All rights reserved.</span>
<a name="l00004"></a>00004 <span class="comment"># Use of this source code is governed by a BSD-style license that can be</span>
<a name="l00005"></a>00005 <span class="comment"># found in the LICENSE file.</span>
<a name="l00006"></a>00006 
<a name="l00007"></a>00007 <span class="keyword">import</span> copy
<a name="l00008"></a>00008 <span class="keyword">import</span> gyp.input
<a name="l00009"></a>00009 <span class="keyword">import</span> optparse
<a name="l00010"></a>00010 <span class="keyword">import</span> os.path
<a name="l00011"></a>00011 <span class="keyword">import</span> re
<a name="l00012"></a>00012 <span class="keyword">import</span> shlex
<a name="l00013"></a>00013 <span class="keyword">import</span> sys
<a name="l00014"></a>00014 <span class="keyword">import</span> traceback
<a name="l00015"></a>00015 <span class="keyword">from</span> gyp.common <span class="keyword">import</span> GypError
<a name="l00016"></a>00016 
<a name="l00017"></a>00017 <span class="comment"># Default debug modes for GYP</span>
<a name="l00018"></a><a class="code" href="../../d9/d41/namespacegyp.html#a5530ee76b3ca9eb8b84c4b4c9e0da70">00018</a> debug = {}
<a name="l00019"></a>00019 
<a name="l00020"></a>00020 <span class="comment"># List of "official" debug modes, but you can use anything you like.</span>
<a name="l00021"></a><a class="code" href="../../d9/d41/namespacegyp.html#1426057e4fece4708998b719cb8b41fb">00021</a> DEBUG_GENERAL = <span class="stringliteral">'general'</span>
<a name="l00022"></a><a class="code" href="../../d9/d41/namespacegyp.html#7f0ea9e244d6671724e6c5e3f0f80e5f">00022</a> DEBUG_VARIABLES = <span class="stringliteral">'variables'</span>
<a name="l00023"></a><a class="code" href="../../d9/d41/namespacegyp.html#2dfe6ab720742fb55ba982266f17081b">00023</a> DEBUG_INCLUDES = <span class="stringliteral">'includes'</span>
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 
<a name="l00026"></a><a class="code" href="../../d9/d41/namespacegyp.html#1c1a8da42454324c020fb518a0ebe563">00026</a> <span class="keyword">def </span><a class="code" href="../../d9/d41/namespacegyp.html#1c1a8da42454324c020fb518a0ebe563">DebugOutput</a>(mode, message, *args):
<a name="l00027"></a>00027   <span class="keywordflow">if</span> <span class="stringliteral">'all'</span> <span class="keywordflow">in</span> gyp.debug <span class="keywordflow">or</span> mode <span class="keywordflow">in</span> gyp.debug:
<a name="l00028"></a>00028     ctx = (<span class="stringliteral">'unknown'</span>, 0, <span class="stringliteral">'unknown'</span>)
<a name="l00029"></a>00029     <span class="keywordflow">try</span>:
<a name="l00030"></a>00030       f = traceback.extract_stack(limit=2)
<a name="l00031"></a>00031       <span class="keywordflow">if</span> f:
<a name="l00032"></a>00032         ctx = f[0][:3]
<a name="l00033"></a>00033     <span class="keywordflow">except</span>:
<a name="l00034"></a>00034       <span class="keywordflow">pass</span>
<a name="l00035"></a>00035     <span class="keywordflow">if</span> args:
<a name="l00036"></a>00036       message %= args
<a name="l00037"></a>00037     <span class="keywordflow">print</span> <span class="stringliteral">'%s:%s:%d:%s %s'</span> % (mode.upper(), os.path.basename(ctx[0]),
<a name="l00038"></a>00038                               ctx[1], ctx[2], message)
<a name="l00039"></a>00039 
<a name="l00040"></a><a class="code" href="../../d9/d41/namespacegyp.html#bbec481ebae21557b88d8f5c90f8542e">00040</a> <span class="keyword">def </span><a class="code" href="../../d9/d41/namespacegyp.html#bbec481ebae21557b88d8f5c90f8542e">FindBuildFiles</a>():
<a name="l00041"></a>00041   extension = <span class="stringliteral">'.gyp'</span>
<a name="l00042"></a>00042   files = os.listdir(os.getcwd())
<a name="l00043"></a>00043   build_files = []
<a name="l00044"></a>00044   <span class="keywordflow">for</span> file <span class="keywordflow">in</span> files:
<a name="l00045"></a>00045     <span class="keywordflow">if</span> file.endswith(extension):
<a name="l00046"></a>00046       build_files.append(file)
<a name="l00047"></a>00047   <span class="keywordflow">return</span> build_files
<a name="l00048"></a>00048 
<a name="l00049"></a>00049 
<a name="l00050"></a><a class="code" href="../../d9/d41/namespacegyp.html#359f0c7c931eb162c8ec9d40d66085b6">00050</a> <span class="keyword">def </span><a class="code" href="../../d9/d41/namespacegyp.html#359f0c7c931eb162c8ec9d40d66085b6">Load</a>(build_files, format, default_variables={},
<a name="l00051"></a>00051          includes=[], depth=<span class="stringliteral">'.'</span>, params=<span class="keywordtype">None</span>, check=<span class="keyword">False</span>,
<a name="l00052"></a>00052          circular_check=<span class="keyword">True</span>):
<a name="l00053"></a>00053   <span class="stringliteral">"""</span>
<a name="l00054"></a>00054 <span class="stringliteral">  Loads one or more specified build files.</span>
<a name="l00055"></a>00055 <span class="stringliteral">  default_variables and includes will be copied before use.</span>
<a name="l00056"></a>00056 <span class="stringliteral">  Returns the generator for the specified format and the</span>
<a name="l00057"></a>00057 <span class="stringliteral">  data returned by loading the specified build files.</span>
<a name="l00058"></a>00058 <span class="stringliteral">  """</span>
<a name="l00059"></a>00059   <span class="keywordflow">if</span> params <span class="keywordflow">is</span> <span class="keywordtype">None</span>:
<a name="l00060"></a>00060     params = {}
<a name="l00061"></a>00061 
<a name="l00062"></a>00062   <span class="keywordflow">if</span> <span class="stringliteral">'-'</span> <span class="keywordflow">in</span> format:
<a name="l00063"></a>00063     format, params[<span class="stringliteral">'flavor'</span>] = format.split(<span class="stringliteral">'-'</span>, 1)
<a name="l00064"></a>00064 
<a name="l00065"></a>00065   default_variables = copy.copy(default_variables)
<a name="l00066"></a>00066 
<a name="l00067"></a>00067   <span class="comment"># Default variables provided by this program and its modules should be</span>
<a name="l00068"></a>00068   <span class="comment"># named WITH_CAPITAL_LETTERS to provide a distinct "best practice" namespace,</span>
<a name="l00069"></a>00069   <span class="comment"># avoiding collisions with user and automatic variables.</span>
<a name="l00070"></a>00070   default_variables[<span class="stringliteral">'GENERATOR'</span>] = format
<a name="l00071"></a>00071   default_variables[<span class="stringliteral">'GENERATOR_FLAVOR'</span>] = params.get(<span class="stringliteral">'flavor'</span>, <span class="stringliteral">''</span>)
<a name="l00072"></a>00072 
<a name="l00073"></a>00073   <span class="comment"># Format can be a custom python file, or by default the name of a module</span>
<a name="l00074"></a>00074   <span class="comment"># within gyp.generator.</span>
<a name="l00075"></a>00075   <span class="keywordflow">if</span> format.endswith(<span class="stringliteral">'.py'</span>):
<a name="l00076"></a>00076     generator_name = os.path.splitext(format)[0]
<a name="l00077"></a>00077     path, generator_name = os.path.split(generator_name)
<a name="l00078"></a>00078 
<a name="l00079"></a>00079     <span class="comment"># Make sure the path to the custom generator is in sys.path</span>
<a name="l00080"></a>00080     <span class="comment"># Don't worry about removing it once we are done.  Keeping the path</span>
<a name="l00081"></a>00081     <span class="comment"># to each generator that is used in sys.path is likely harmless and</span>
<a name="l00082"></a>00082     <span class="comment"># arguably a good idea.</span>
<a name="l00083"></a>00083     path = os.path.abspath(path)
<a name="l00084"></a>00084     <span class="keywordflow">if</span> path <span class="keywordflow">not</span> <span class="keywordflow">in</span> sys.path:
<a name="l00085"></a>00085       sys.path.insert(0, path)
<a name="l00086"></a>00086   <span class="keywordflow">else</span>:
<a name="l00087"></a>00087     generator_name = <span class="stringliteral">'gyp.generator.'</span> + format
<a name="l00088"></a>00088 
<a name="l00089"></a>00089   <span class="comment"># These parameters are passed in order (as opposed to by key)</span>
<a name="l00090"></a>00090   <span class="comment"># because ActivePython cannot handle key parameters to __import__.</span>
<a name="l00091"></a>00091   generator = __import__(generator_name, globals(), locals(), generator_name)
<a name="l00092"></a>00092   <span class="keywordflow">for</span> (key, val) <span class="keywordflow">in</span> generator.generator_default_variables.items():
<a name="l00093"></a>00093     default_variables.setdefault(key, val)
<a name="l00094"></a>00094 
<a name="l00095"></a>00095   <span class="comment"># Give the generator the opportunity to set additional variables based on</span>
<a name="l00096"></a>00096   <span class="comment"># the params it will receive in the output phase.</span>
<a name="l00097"></a>00097   <span class="keywordflow">if</span> getattr(generator, <span class="stringliteral">'CalculateVariables'</span>, <span class="keywordtype">None</span>):
<a name="l00098"></a>00098     generator.CalculateVariables(default_variables, params)
<a name="l00099"></a>00099 
<a name="l00100"></a>00100   <span class="comment"># Give the generator the opportunity to set generator_input_info based on</span>
<a name="l00101"></a>00101   <span class="comment"># the params it will receive in the output phase.</span>
<a name="l00102"></a>00102   <span class="keywordflow">if</span> getattr(generator, <span class="stringliteral">'CalculateGeneratorInputInfo'</span>, <span class="keywordtype">None</span>):
<a name="l00103"></a>00103     generator.CalculateGeneratorInputInfo(params)
<a name="l00104"></a>00104 
<a name="l00105"></a>00105   <span class="comment"># Fetch the generator specific info that gets fed to input, we use getattr</span>
<a name="l00106"></a>00106   <span class="comment"># so we can default things and the generators only have to provide what</span>
<a name="l00107"></a>00107   <span class="comment"># they need.</span>
<a name="l00108"></a>00108   generator_input_info = {
<a name="l00109"></a>00109     <span class="stringliteral">'non_configuration_keys'</span>:
<a name="l00110"></a>00110         getattr(generator, <span class="stringliteral">'generator_additional_non_configuration_keys'</span>, []),
<a name="l00111"></a>00111     <span class="stringliteral">'path_sections'</span>:
<a name="l00112"></a>00112         getattr(generator, <span class="stringliteral">'generator_additional_path_sections'</span>, []),
<a name="l00113"></a>00113     <span class="stringliteral">'extra_sources_for_rules'</span>:
<a name="l00114"></a>00114         getattr(generator, <span class="stringliteral">'generator_extra_sources_for_rules'</span>, []),
<a name="l00115"></a>00115     <span class="stringliteral">'generator_supports_multiple_toolsets'</span>:
<a name="l00116"></a>00116         getattr(generator, <span class="stringliteral">'generator_supports_multiple_toolsets'</span>, <span class="keyword">False</span>),
<a name="l00117"></a>00117     <span class="stringliteral">'generator_wants_static_library_dependencies_adjusted'</span>:
<a name="l00118"></a>00118         getattr(generator,
<a name="l00119"></a>00119                 <span class="stringliteral">'generator_wants_static_library_dependencies_adjusted'</span>, <span class="keyword">True</span>),
<a name="l00120"></a>00120     <span class="stringliteral">'generator_wants_sorted_dependencies'</span>:
<a name="l00121"></a>00121         getattr(generator, <span class="stringliteral">'generator_wants_sorted_dependencies'</span>, <span class="keyword">False</span>),
<a name="l00122"></a>00122     <span class="stringliteral">'generator_filelist_paths'</span>:
<a name="l00123"></a>00123         getattr(generator, <span class="stringliteral">'generator_filelist_paths'</span>, <span class="keywordtype">None</span>),
<a name="l00124"></a>00124   }
<a name="l00125"></a>00125 
<a name="l00126"></a>00126   <span class="comment"># Process the input specific to this generator.</span>
<a name="l00127"></a>00127   result = gyp.input.Load(build_files, default_variables, includes[:],
<a name="l00128"></a>00128                           depth, generator_input_info, check, circular_check,
<a name="l00129"></a>00129                           params[<span class="stringliteral">'parallel'</span>], params[<span class="stringliteral">'root_targets'</span>])
<a name="l00130"></a>00130   <span class="keywordflow">return</span> [generator] + result
<a name="l00131"></a>00131 
<a name="l00132"></a><a class="code" href="../../d9/d41/namespacegyp.html#838b6f65db54c64e0bb1152c166874ce">00132</a> <span class="keyword">def </span><a class="code" href="../../d9/d41/namespacegyp.html#838b6f65db54c64e0bb1152c166874ce">NameValueListToDict</a>(name_value_list):
<a name="l00133"></a>00133   <span class="stringliteral">"""</span>
<a name="l00134"></a>00134 <span class="stringliteral">  Takes an array of strings of the form 'NAME=VALUE' and creates a dictionary</span>
<a name="l00135"></a>00135 <span class="stringliteral">  of the pairs.  If a string is simply NAME, then the value in the dictionary</span>
<a name="l00136"></a>00136 <span class="stringliteral">  is set to True.  If VALUE can be converted to an integer, it is.</span>
<a name="l00137"></a>00137 <span class="stringliteral">  """</span>
<a name="l00138"></a>00138   result = { }
<a name="l00139"></a>00139   <span class="keywordflow">for</span> item <span class="keywordflow">in</span> name_value_list:
<a name="l00140"></a>00140     tokens = item.split(<span class="stringliteral">'='</span>, 1)
<a name="l00141"></a>00141     <span class="keywordflow">if</span> len(tokens) == 2:
<a name="l00142"></a>00142       <span class="comment"># If we can make it an int, use that, otherwise, use the string.</span>
<a name="l00143"></a>00143       <span class="keywordflow">try</span>:
<a name="l00144"></a>00144         token_value = int(tokens[1])
<a name="l00145"></a>00145       <span class="keywordflow">except</span> ValueError:
<a name="l00146"></a>00146         token_value = tokens[1]
<a name="l00147"></a>00147       <span class="comment"># Set the variable to the supplied value.</span>
<a name="l00148"></a>00148       result[tokens[0]] = token_value
<a name="l00149"></a>00149     <span class="keywordflow">else</span>:
<a name="l00150"></a>00150       <span class="comment"># No value supplied, treat it as a boolean and set it.</span>
<a name="l00151"></a>00151       result[tokens[0]] = <span class="keyword">True</span>
<a name="l00152"></a>00152   <span class="keywordflow">return</span> result
<a name="l00153"></a>00153 
<a name="l00154"></a><a class="code" href="../../d9/d41/namespacegyp.html#e325d5b3040f6ca1d24e0efa6eda4225">00154</a> <span class="keyword">def </span><a class="code" href="../../d9/d41/namespacegyp.html#e325d5b3040f6ca1d24e0efa6eda4225">ShlexEnv</a>(env_name):
<a name="l00155"></a>00155   flags = os.environ.get(env_name, [])
<a name="l00156"></a>00156   <span class="keywordflow">if</span> flags:
<a name="l00157"></a>00157     flags = shlex.split(flags)
<a name="l00158"></a>00158   <span class="keywordflow">return</span> flags
<a name="l00159"></a>00159 
<a name="l00160"></a><a class="code" href="../../d9/d41/namespacegyp.html#9497817684ec49f2b297fa3bf970420f">00160</a> <span class="keyword">def </span><a class="code" href="../../d9/d41/namespacegyp.html#9497817684ec49f2b297fa3bf970420f">FormatOpt</a>(opt, value):
<a name="l00161"></a>00161   <span class="keywordflow">if</span> opt.startswith(<span class="stringliteral">'--'</span>):
<a name="l00162"></a>00162     <span class="keywordflow">return</span> <span class="stringliteral">'%s=%s'</span> % (opt, value)
<a name="l00163"></a>00163   <span class="keywordflow">return</span> opt + value
<a name="l00164"></a>00164 
<a name="l00165"></a><a class="code" href="../../d9/d41/namespacegyp.html#437cb887c887e667f2b6929d2db4adb1">00165</a> <span class="keyword">def </span><a class="code" href="../../d9/d41/namespacegyp.html#437cb887c887e667f2b6929d2db4adb1">RegenerateAppendFlag</a>(flag, values, predicate, env_name, options):
<a name="l00166"></a>00166   <span class="stringliteral">"""Regenerate a list of command line flags, for an option of action='append'.</span>
<a name="l00167"></a>00167 <span class="stringliteral"></span>
<a name="l00168"></a>00168 <span class="stringliteral">  The |env_name|, if given, is checked in the environment and used to generate</span>
<a name="l00169"></a>00169 <span class="stringliteral">  an initial list of options, then the options that were specified on the</span>
<a name="l00170"></a>00170 <span class="stringliteral">  command line (given in |values|) are appended.  This matches the handling of</span>
<a name="l00171"></a>00171 <span class="stringliteral">  environment variables and command line flags where command line flags override</span>
<a name="l00172"></a>00172 <span class="stringliteral">  the environment, while not requiring the environment to be set when the flags</span>
<a name="l00173"></a>00173 <span class="stringliteral">  are used again.</span>
<a name="l00174"></a>00174 <span class="stringliteral">  """</span>
<a name="l00175"></a>00175   flags = []
<a name="l00176"></a>00176   <span class="keywordflow">if</span> options.use_environment <span class="keywordflow">and</span> env_name:
<a name="l00177"></a>00177     <span class="keywordflow">for</span> flag_value <span class="keywordflow">in</span> ShlexEnv(env_name):
<a name="l00178"></a>00178       value = FormatOpt(flag, predicate(flag_value))
<a name="l00179"></a>00179       <span class="keywordflow">if</span> value <span class="keywordflow">in</span> flags:
<a name="l00180"></a>00180         flags.remove(value)
<a name="l00181"></a>00181       flags.append(value)
<a name="l00182"></a>00182   <span class="keywordflow">if</span> values:
<a name="l00183"></a>00183     <span class="keywordflow">for</span> flag_value <span class="keywordflow">in</span> values:
<a name="l00184"></a>00184       flags.append(FormatOpt(flag, predicate(flag_value)))
<a name="l00185"></a>00185   <span class="keywordflow">return</span> flags
<a name="l00186"></a>00186 
<a name="l00187"></a><a class="code" href="../../d9/d41/namespacegyp.html#eaf9d344effc7f3947c2f31a25c275fe">00187</a> <span class="keyword">def </span><a class="code" href="../../d9/d41/namespacegyp.html#eaf9d344effc7f3947c2f31a25c275fe">RegenerateFlags</a>(options):
<a name="l00188"></a>00188   <span class="stringliteral">"""Given a parsed options object, and taking the environment variables into</span>
<a name="l00189"></a>00189 <span class="stringliteral">  account, returns a list of flags that should regenerate an equivalent options</span>
<a name="l00190"></a>00190 <span class="stringliteral">  object (even in the absence of the environment variables.)</span>
<a name="l00191"></a>00191 <span class="stringliteral"></span>
<a name="l00192"></a>00192 <span class="stringliteral">  Any path options will be normalized relative to depth.</span>
<a name="l00193"></a>00193 <span class="stringliteral"></span>
<a name="l00194"></a>00194 <span class="stringliteral">  The format flag is not included, as it is assumed the calling generator will</span>
<a name="l00195"></a>00195 <span class="stringliteral">  set that as appropriate.</span>
<a name="l00196"></a>00196 <span class="stringliteral">  """</span>
<a name="l00197"></a>00197   <span class="keyword">def </span>FixPath(path):
<a name="l00198"></a>00198     path = gyp.common.FixIfRelativePath(path, options.depth)
<a name="l00199"></a>00199     <span class="keywordflow">if</span> <span class="keywordflow">not</span> path:
<a name="l00200"></a>00200       <span class="keywordflow">return</span> os.path.curdir
<a name="l00201"></a>00201     <span class="keywordflow">return</span> path
<a name="l00202"></a>00202 
<a name="l00203"></a>00203   <span class="keyword">def </span>Noop(value):
<a name="l00204"></a>00204     <span class="keywordflow">return</span> value
<a name="l00205"></a>00205 
<a name="l00206"></a>00206   <span class="comment"># We always want to ignore the environment when regenerating, to avoid</span>
<a name="l00207"></a>00207   <span class="comment"># duplicate or changed flags in the environment at the time of regeneration.</span>
<a name="l00208"></a>00208   flags = [<span class="stringliteral">'--ignore-environment'</span>]
<a name="l00209"></a>00209   <span class="keywordflow">for</span> name, metadata <span class="keywordflow">in</span> options._regeneration_metadata.iteritems():
<a name="l00210"></a>00210     opt = metadata[<span class="stringliteral">'opt'</span>]
<a name="l00211"></a>00211     value = getattr(options, name)
<a name="l00212"></a>00212     value_predicate = metadata[<span class="stringliteral">'type'</span>] == <span class="stringliteral">'path'</span> <span class="keywordflow">and</span> FixPath <span class="keywordflow">or</span> Noop
<a name="l00213"></a>00213     action = metadata[<span class="stringliteral">'action'</span>]
<a name="l00214"></a>00214     env_name = metadata[<span class="stringliteral">'env_name'</span>]
<a name="l00215"></a>00215     <span class="keywordflow">if</span> action == <span class="stringliteral">'append'</span>:
<a name="l00216"></a>00216       flags.extend(RegenerateAppendFlag(opt, value, value_predicate,
<a name="l00217"></a>00217                                         env_name, options))
<a name="l00218"></a>00218     <span class="keywordflow">elif</span> action <span class="keywordflow">in</span> (<span class="stringliteral">'store'</span>, <span class="keywordtype">None</span>):  <span class="comment"># None is a synonym for 'store'.</span>
<a name="l00219"></a>00219       <span class="keywordflow">if</span> value:
<a name="l00220"></a>00220         flags.append(FormatOpt(opt, value_predicate(value)))
<a name="l00221"></a>00221       <span class="keywordflow">elif</span> options.use_environment <span class="keywordflow">and</span> env_name <span class="keywordflow">and</span> os.environ.get(env_name):
<a name="l00222"></a>00222         flags.append(FormatOpt(opt, value_predicate(os.environ.get(env_name))))
<a name="l00223"></a>00223     <span class="keywordflow">elif</span> action <span class="keywordflow">in</span> (<span class="stringliteral">'store_true'</span>, <span class="stringliteral">'store_false'</span>):
<a name="l00224"></a>00224       <span class="keywordflow">if</span> ((action == <span class="stringliteral">'store_true'</span> <span class="keywordflow">and</span> value) <span class="keywordflow">or</span>
<a name="l00225"></a>00225           (action == <span class="stringliteral">'store_false'</span> <span class="keywordflow">and</span> <span class="keywordflow">not</span> value)):
<a name="l00226"></a>00226         flags.append(opt)
<a name="l00227"></a>00227       <span class="keywordflow">elif</span> options.use_environment <span class="keywordflow">and</span> env_name:
<a name="l00228"></a>00228         <span class="keywordflow">print</span> &gt;&gt;sys.stderr, (<span class="stringliteral">'Warning: environment regeneration unimplemented '</span>
<a name="l00229"></a>00229                              <span class="stringliteral">'for %s flag %r env_name %r'</span> % (action, opt,
<a name="l00230"></a>00230                                                              env_name))
<a name="l00231"></a>00231     <span class="keywordflow">else</span>:
<a name="l00232"></a>00232       <span class="keywordflow">print</span> &gt;&gt;sys.stderr, (<span class="stringliteral">'Warning: regeneration unimplemented for action %r '</span>
<a name="l00233"></a>00233                            <span class="stringliteral">'flag %r'</span> % (action, opt))
<a name="l00234"></a>00234 
<a name="l00235"></a>00235   <span class="keywordflow">return</span> flags
<a name="l00236"></a>00236 
<a name="l00237"></a><a class="code" href="../../d0/dd0/classgyp_1_1_regeneratable_option_parser.html">00237</a> <span class="keyword">class </span><a class="code" href="../../d0/dd0/classgyp_1_1_regeneratable_option_parser.html">RegeneratableOptionParser</a>(optparse.OptionParser):
<a name="l00238"></a><a class="code" href="../../d0/dd0/classgyp_1_1_regeneratable_option_parser.html#c775ee34451fdfa742b318538164070e">00238</a>   <span class="keyword">def </span><a class="code" href="../../d0/dd0/classgyp_1_1_regeneratable_option_parser.html#c775ee34451fdfa742b318538164070e">__init__</a>(self):
<a name="l00239"></a><a class="code" href="../../d0/dd0/classgyp_1_1_regeneratable_option_parser.html#4c001088f8b2e3b484e995c9546d0d9e">00239</a>     self.<a class="code" href="../../d0/dd0/classgyp_1_1_regeneratable_option_parser.html#4c001088f8b2e3b484e995c9546d0d9e">__regeneratable_options</a> = {}
<a name="l00240"></a>00240     optparse.OptionParser.__init__(self)
<a name="l00241"></a>00241 
<a name="l00242"></a><a class="code" href="../../d0/dd0/classgyp_1_1_regeneratable_option_parser.html#d3eee4a96db4c61670bde07b2af08320">00242</a>   <span class="keyword">def </span><a class="code" href="../../d0/dd0/classgyp_1_1_regeneratable_option_parser.html#d3eee4a96db4c61670bde07b2af08320">add_option</a>(self, *args, **kw):
<a name="l00243"></a>00243     <span class="stringliteral">"""Add an option to the parser.</span>
<a name="l00244"></a>00244 <span class="stringliteral"></span>
<a name="l00245"></a>00245 <span class="stringliteral">    This accepts the same arguments as OptionParser.add_option, plus the</span>
<a name="l00246"></a>00246 <span class="stringliteral">    following:</span>
<a name="l00247"></a>00247 <span class="stringliteral">      regenerate: can be set to False to prevent this option from being included</span>
<a name="l00248"></a>00248 <span class="stringliteral">                  in regeneration.</span>
<a name="l00249"></a>00249 <span class="stringliteral">      env_name: name of environment variable that additional values for this</span>
<a name="l00250"></a>00250 <span class="stringliteral">                option come from.</span>
<a name="l00251"></a>00251 <span class="stringliteral">      type: adds type='path', to tell the regenerator that the values of</span>
<a name="l00252"></a>00252 <span class="stringliteral">            this option need to be made relative to options.depth</span>
<a name="l00253"></a>00253 <span class="stringliteral">    """</span>
<a name="l00254"></a>00254     env_name = kw.pop(<span class="stringliteral">'env_name'</span>, <span class="keywordtype">None</span>)
<a name="l00255"></a>00255     <span class="keywordflow">if</span> <span class="stringliteral">'dest'</span> <span class="keywordflow">in</span> kw <span class="keywordflow">and</span> kw.pop(<span class="stringliteral">'regenerate'</span>, <span class="keyword">True</span>):
<a name="l00256"></a>00256       dest = kw[<span class="stringliteral">'dest'</span>]
<a name="l00257"></a>00257 
<a name="l00258"></a>00258       <span class="comment"># The path type is needed for regenerating, for optparse we can just treat</span>
<a name="l00259"></a>00259       <span class="comment"># it as a string.</span>
<a name="l00260"></a>00260       type = kw.get(<span class="stringliteral">'type'</span>)
<a name="l00261"></a>00261       <span class="keywordflow">if</span> type == <span class="stringliteral">'path'</span>:
<a name="l00262"></a>00262         kw[<span class="stringliteral">'type'</span>] = <span class="stringliteral">'string'</span>
<a name="l00263"></a>00263 
<a name="l00264"></a>00264       self.<a class="code" href="../../d0/dd0/classgyp_1_1_regeneratable_option_parser.html#4c001088f8b2e3b484e995c9546d0d9e">__regeneratable_options</a>[dest] = {
<a name="l00265"></a>00265           <span class="stringliteral">'action'</span>: kw.get(<span class="stringliteral">'action'</span>),
<a name="l00266"></a>00266           <span class="stringliteral">'type'</span>: type,
<a name="l00267"></a>00267           <span class="stringliteral">'env_name'</span>: env_name,
<a name="l00268"></a>00268           <span class="stringliteral">'opt'</span>: args[0],
<a name="l00269"></a>00269         }
<a name="l00270"></a>00270 
<a name="l00271"></a>00271     optparse.OptionParser.add_option(self, *args, **kw)
<a name="l00272"></a>00272 
<a name="l00273"></a><a class="code" href="../../d0/dd0/classgyp_1_1_regeneratable_option_parser.html#4354871619b866b2d7855e024477196e">00273</a>   <span class="keyword">def </span><a class="code" href="../../d0/dd0/classgyp_1_1_regeneratable_option_parser.html#4354871619b866b2d7855e024477196e">parse_args</a>(self, *args):
<a name="l00274"></a>00274     values, args = optparse.OptionParser.parse_args(self, *args)
<a name="l00275"></a>00275     values._regeneration_metadata = self.<a class="code" href="../../d0/dd0/classgyp_1_1_regeneratable_option_parser.html#4c001088f8b2e3b484e995c9546d0d9e">__regeneratable_options</a>
<a name="l00276"></a>00276     <span class="keywordflow">return</span> values, args
<a name="l00277"></a>00277 
<a name="l00278"></a><a class="code" href="../../d9/d41/namespacegyp.html#2b1f284544c7e8e94df536a5b5399b63">00278</a> <span class="keyword">def </span><a class="code" href="../../d9/d41/namespacegyp.html#2b1f284544c7e8e94df536a5b5399b63">gyp_main</a>(args):
<a name="l00279"></a>00279   my_name = os.path.basename(sys.argv[0])
<a name="l00280"></a>00280 
<a name="l00281"></a>00281   parser = RegeneratableOptionParser()
<a name="l00282"></a>00282   usage = <span class="stringliteral">'usage: %s [options ...] [build_file ...]'</span>
<a name="l00283"></a>00283   parser.set_usage(usage.replace(<span class="stringliteral">'%s'</span>, <span class="stringliteral">'%prog'</span>))
<a name="l00284"></a>00284   parser.add_option(<span class="stringliteral">'--build'</span>, dest=<span class="stringliteral">'configs'</span>, action=<span class="stringliteral">'append'</span>,
<a name="l00285"></a>00285                     help=<span class="stringliteral">'configuration for build after project generation'</span>)
<a name="l00286"></a>00286   parser.add_option(<span class="stringliteral">'--check'</span>, dest=<span class="stringliteral">'check'</span>, action=<span class="stringliteral">'store_true'</span>,
<a name="l00287"></a>00287                     help=<span class="stringliteral">'check format of gyp files'</span>)
<a name="l00288"></a>00288   parser.add_option(<span class="stringliteral">'--config-dir'</span>, dest=<span class="stringliteral">'config_dir'</span>, action=<span class="stringliteral">'store'</span>,
<a name="l00289"></a>00289                     env_name=<span class="stringliteral">'GYP_CONFIG_DIR'</span>, default=<span class="keywordtype">None</span>,
<a name="l00290"></a>00290                     help=<span class="stringliteral">'The location for configuration files like '</span>
<a name="l00291"></a>00291                     <span class="stringliteral">'include.gypi.'</span>)
<a name="l00292"></a>00292   parser.add_option(<span class="stringliteral">'-d'</span>, <span class="stringliteral">'--debug'</span>, dest=<span class="stringliteral">'debug'</span>, metavar=<span class="stringliteral">'DEBUGMODE'</span>,
<a name="l00293"></a>00293                     action=<span class="stringliteral">'append'</span>, default=[], help=<span class="stringliteral">'turn on a debugging '</span>
<a name="l00294"></a>00294                     <span class="stringliteral">'mode for debugging GYP.  Supported modes are "variables", '</span>
<a name="l00295"></a>00295                     <span class="stringliteral">'"includes" and "general" or "all" for all of them.'</span>)
<a name="l00296"></a>00296   parser.add_option(<span class="stringliteral">'-D'</span>, dest=<span class="stringliteral">'defines'</span>, action=<span class="stringliteral">'append'</span>, metavar=<span class="stringliteral">'VAR=VAL'</span>,
<a name="l00297"></a>00297                     env_name=<span class="stringliteral">'GYP_DEFINES'</span>,
<a name="l00298"></a>00298                     help=<span class="stringliteral">'sets variable VAR to value VAL'</span>)
<a name="l00299"></a>00299   parser.add_option(<span class="stringliteral">'--depth'</span>, dest=<span class="stringliteral">'depth'</span>, metavar=<span class="stringliteral">'PATH'</span>, type=<span class="stringliteral">'path'</span>,
<a name="l00300"></a>00300                     help=<span class="stringliteral">'set DEPTH gyp variable to a relative path to PATH'</span>)
<a name="l00301"></a>00301   parser.add_option(<span class="stringliteral">'-f'</span>, <span class="stringliteral">'--format'</span>, dest=<span class="stringliteral">'formats'</span>, action=<span class="stringliteral">'append'</span>,
<a name="l00302"></a>00302                     env_name=<span class="stringliteral">'GYP_GENERATORS'</span>, regenerate=<span class="keyword">False</span>,
<a name="l00303"></a>00303                     help=<span class="stringliteral">'output formats to generate'</span>)
<a name="l00304"></a>00304   parser.add_option(<span class="stringliteral">'-G'</span>, dest=<span class="stringliteral">'generator_flags'</span>, action=<span class="stringliteral">'append'</span>, default=[],
<a name="l00305"></a>00305                     metavar=<span class="stringliteral">'FLAG=VAL'</span>, env_name=<span class="stringliteral">'GYP_GENERATOR_FLAGS'</span>,
<a name="l00306"></a>00306                     help=<span class="stringliteral">'sets generator flag FLAG to VAL'</span>)
<a name="l00307"></a>00307   parser.add_option(<span class="stringliteral">'--generator-output'</span>, dest=<span class="stringliteral">'generator_output'</span>,
<a name="l00308"></a>00308                     action=<span class="stringliteral">'store'</span>, default=<span class="keywordtype">None</span>, metavar=<span class="stringliteral">'DIR'</span>, type=<span class="stringliteral">'path'</span>,
<a name="l00309"></a>00309                     env_name=<span class="stringliteral">'GYP_GENERATOR_OUTPUT'</span>,
<a name="l00310"></a>00310                     help=<span class="stringliteral">'puts generated build files under DIR'</span>)
<a name="l00311"></a>00311   parser.add_option(<span class="stringliteral">'--ignore-environment'</span>, dest=<span class="stringliteral">'use_environment'</span>,
<a name="l00312"></a>00312                     action=<span class="stringliteral">'store_false'</span>, default=<span class="keyword">True</span>, regenerate=<span class="keyword">False</span>,
<a name="l00313"></a>00313                     help=<span class="stringliteral">'do not read options from environment variables'</span>)
<a name="l00314"></a>00314   parser.add_option(<span class="stringliteral">'-I'</span>, <span class="stringliteral">'--include'</span>, dest=<span class="stringliteral">'includes'</span>, action=<span class="stringliteral">'append'</span>,
<a name="l00315"></a>00315                     metavar=<span class="stringliteral">'INCLUDE'</span>, type=<span class="stringliteral">'path'</span>,
<a name="l00316"></a>00316                     help=<span class="stringliteral">'files to include in all loaded .gyp files'</span>)
<a name="l00317"></a>00317   <span class="comment"># --no-circular-check disables the check for circular relationships between</span>
<a name="l00318"></a>00318   <span class="comment"># .gyp files.  These relationships should not exist, but they've only been</span>
<a name="l00319"></a>00319   <span class="comment"># observed to be harmful with the Xcode generator.  Chromium's .gyp files</span>
<a name="l00320"></a>00320   <span class="comment"># currently have some circular relationships on non-Mac platforms, so this</span>
<a name="l00321"></a>00321   <span class="comment"># option allows the strict behavior to be used on Macs and the lenient</span>
<a name="l00322"></a>00322   <span class="comment"># behavior to be used elsewhere.</span>
<a name="l00323"></a>00323   <span class="comment"># TODO(mark): Remove this option when http://crbug.com/35878 is fixed.</span>
<a name="l00324"></a>00324   parser.add_option(<span class="stringliteral">'--no-circular-check'</span>, dest=<span class="stringliteral">'circular_check'</span>,
<a name="l00325"></a>00325                     action=<span class="stringliteral">'store_false'</span>, default=<span class="keyword">True</span>, regenerate=<span class="keyword">False</span>,
<a name="l00326"></a>00326                     help=<span class="stringliteral">"don't check for circular relationships between files"</span>)
<a name="l00327"></a>00327   parser.add_option(<span class="stringliteral">'--no-parallel'</span>, action=<span class="stringliteral">'store_true'</span>, default=<span class="keyword">False</span>,
<a name="l00328"></a>00328                     help=<span class="stringliteral">'Disable multiprocessing'</span>)
<a name="l00329"></a>00329   parser.add_option(<span class="stringliteral">'-S'</span>, <span class="stringliteral">'--suffix'</span>, dest=<span class="stringliteral">'suffix'</span>, default=<span class="stringliteral">''</span>,
<a name="l00330"></a>00330                     help=<span class="stringliteral">'suffix to add to generated files'</span>)
<a name="l00331"></a>00331   parser.add_option(<span class="stringliteral">'--toplevel-dir'</span>, dest=<span class="stringliteral">'toplevel_dir'</span>, action=<span class="stringliteral">'store'</span>,
<a name="l00332"></a>00332                     default=<span class="keywordtype">None</span>, metavar=<span class="stringliteral">'DIR'</span>, type=<span class="stringliteral">'path'</span>,
<a name="l00333"></a>00333                     help=<span class="stringliteral">'directory to use as the root of the source tree'</span>)
<a name="l00334"></a>00334   parser.add_option(<span class="stringliteral">'-R'</span>, <span class="stringliteral">'--root-target'</span>, dest=<span class="stringliteral">'root_targets'</span>,
<a name="l00335"></a>00335                     action=<span class="stringliteral">'append'</span>, metavar=<span class="stringliteral">'TARGET'</span>,
<a name="l00336"></a>00336                     help=<span class="stringliteral">'include only TARGET and its deep dependencies'</span>)
<a name="l00337"></a>00337 
<a name="l00338"></a>00338   options, build_files_arg = parser.parse_args(args)
<a name="l00339"></a>00339   build_files = build_files_arg
<a name="l00340"></a>00340 
<a name="l00341"></a>00341   <span class="comment"># Set up the configuration directory (defaults to ~/.gyp)</span>
<a name="l00342"></a>00342   <span class="keywordflow">if</span> <span class="keywordflow">not</span> options.config_dir:
<a name="l00343"></a>00343     home = <span class="keywordtype">None</span>
<a name="l00344"></a>00344     home_dot_gyp = <span class="keywordtype">None</span>
<a name="l00345"></a>00345     <span class="keywordflow">if</span> options.use_environment:
<a name="l00346"></a>00346       home_dot_gyp = os.environ.get(<span class="stringliteral">'GYP_CONFIG_DIR'</span>, <span class="keywordtype">None</span>)
<a name="l00347"></a>00347       <span class="keywordflow">if</span> home_dot_gyp:
<a name="l00348"></a>00348         home_dot_gyp = os.path.expanduser(home_dot_gyp)
<a name="l00349"></a>00349 
<a name="l00350"></a>00350     <span class="keywordflow">if</span> <span class="keywordflow">not</span> home_dot_gyp:
<a name="l00351"></a>00351       home_vars = [<span class="stringliteral">'HOME'</span>]
<a name="l00352"></a>00352       <span class="keywordflow">if</span> sys.platform <span class="keywordflow">in</span> (<span class="stringliteral">'cygwin'</span>, <span class="stringliteral">'win32'</span>):
<a name="l00353"></a>00353         home_vars.append(<span class="stringliteral">'USERPROFILE'</span>)
<a name="l00354"></a>00354       <span class="keywordflow">for</span> home_var <span class="keywordflow">in</span> home_vars:
<a name="l00355"></a>00355         home = os.getenv(home_var)
<a name="l00356"></a>00356         <span class="keywordflow">if</span> home != <span class="keywordtype">None</span>:
<a name="l00357"></a>00357           home_dot_gyp = os.path.join(home, <span class="stringliteral">'.gyp'</span>)
<a name="l00358"></a>00358           <span class="keywordflow">if</span> <span class="keywordflow">not</span> os.path.exists(home_dot_gyp):
<a name="l00359"></a>00359             home_dot_gyp = <span class="keywordtype">None</span>
<a name="l00360"></a>00360           <span class="keywordflow">else</span>:
<a name="l00361"></a>00361             <span class="keywordflow">break</span>
<a name="l00362"></a>00362   <span class="keywordflow">else</span>:
<a name="l00363"></a>00363     home_dot_gyp = os.path.expanduser(options.config_dir)
<a name="l00364"></a>00364 
<a name="l00365"></a>00365   <span class="keywordflow">if</span> home_dot_gyp <span class="keywordflow">and</span> <span class="keywordflow">not</span> os.path.exists(home_dot_gyp):
<a name="l00366"></a>00366     home_dot_gyp = <span class="keywordtype">None</span>
<a name="l00367"></a>00367 
<a name="l00368"></a>00368   <span class="keywordflow">if</span> <span class="keywordflow">not</span> options.formats:
<a name="l00369"></a>00369     <span class="comment"># If no format was given on the command line, then check the env variable.</span>
<a name="l00370"></a>00370     generate_formats = []
<a name="l00371"></a>00371     <span class="keywordflow">if</span> options.use_environment:
<a name="l00372"></a>00372       generate_formats = os.environ.get(<span class="stringliteral">'GYP_GENERATORS'</span>, [])
<a name="l00373"></a>00373     <span class="keywordflow">if</span> generate_formats:
<a name="l00374"></a>00374       generate_formats = re.split(<span class="stringliteral">r'[\s,]'</span>, generate_formats)
<a name="l00375"></a>00375     <span class="keywordflow">if</span> generate_formats:
<a name="l00376"></a>00376       options.formats = generate_formats
<a name="l00377"></a>00377     <span class="keywordflow">else</span>:
<a name="l00378"></a>00378       <span class="comment"># Nothing in the variable, default based on platform.</span>
<a name="l00379"></a>00379       <span class="keywordflow">if</span> sys.platform == <span class="stringliteral">'darwin'</span>:
<a name="l00380"></a>00380         options.formats = [<span class="stringliteral">'xcode'</span>]
<a name="l00381"></a>00381       <span class="keywordflow">elif</span> sys.platform <span class="keywordflow">in</span> (<span class="stringliteral">'win32'</span>, <span class="stringliteral">'cygwin'</span>):
<a name="l00382"></a>00382         options.formats = [<span class="stringliteral">'msvs'</span>]
<a name="l00383"></a>00383       <span class="keywordflow">else</span>:
<a name="l00384"></a>00384         options.formats = [<span class="stringliteral">'make'</span>]
<a name="l00385"></a>00385 
<a name="l00386"></a>00386   <span class="keywordflow">if</span> <span class="keywordflow">not</span> options.generator_output <span class="keywordflow">and</span> options.use_environment:
<a name="l00387"></a>00387     g_o = os.environ.get(<span class="stringliteral">'GYP_GENERATOR_OUTPUT'</span>)
<a name="l00388"></a>00388     <span class="keywordflow">if</span> g_o:
<a name="l00389"></a>00389       options.generator_output = g_o
<a name="l00390"></a>00390 
<a name="l00391"></a>00391   options.parallel = <span class="keywordflow">not</span> options.no_parallel
<a name="l00392"></a>00392 
<a name="l00393"></a>00393   <span class="keywordflow">for</span> mode <span class="keywordflow">in</span> options.debug:
<a name="l00394"></a>00394     gyp.debug[mode] = 1
<a name="l00395"></a>00395 
<a name="l00396"></a>00396   <span class="comment"># Do an extra check to avoid work when we're not debugging.</span>
<a name="l00397"></a>00397   <span class="keywordflow">if</span> DEBUG_GENERAL <span class="keywordflow">in</span> gyp.debug:
<a name="l00398"></a>00398     DebugOutput(DEBUG_GENERAL, <span class="stringliteral">'running with these options:'</span>)
<a name="l00399"></a>00399     <span class="keywordflow">for</span> option, value <span class="keywordflow">in</span> sorted(options.__dict__.items()):
<a name="l00400"></a>00400       <span class="keywordflow">if</span> option[0] == <span class="stringliteral">'_'</span>:
<a name="l00401"></a>00401         <span class="keywordflow">continue</span>
<a name="l00402"></a>00402       <span class="keywordflow">if</span> isinstance(value, basestring):
<a name="l00403"></a>00403         DebugOutput(DEBUG_GENERAL, <span class="stringliteral">"  %s: '%s'"</span>, option, value)
<a name="l00404"></a>00404       <span class="keywordflow">else</span>:
<a name="l00405"></a>00405         DebugOutput(DEBUG_GENERAL, <span class="stringliteral">"  %s: %s"</span>, option, value)
<a name="l00406"></a>00406 
<a name="l00407"></a>00407   <span class="keywordflow">if</span> <span class="keywordflow">not</span> build_files:
<a name="l00408"></a>00408     build_files = FindBuildFiles()
<a name="l00409"></a>00409   <span class="keywordflow">if</span> <span class="keywordflow">not</span> build_files:
<a name="l00410"></a>00410     <span class="keywordflow">raise</span> GypError((usage + <span class="stringliteral">'\n\n%s: error: no build_file'</span>) %
<a name="l00411"></a>00411                    (my_name, my_name))
<a name="l00412"></a>00412 
<a name="l00413"></a>00413   <span class="comment"># TODO(mark): Chromium-specific hack!</span>
<a name="l00414"></a>00414   <span class="comment"># For Chromium, the gyp "depth" variable should always be a relative path</span>
<a name="l00415"></a>00415   <span class="comment"># to Chromium's top-level "src" directory.  If no depth variable was set</span>
<a name="l00416"></a>00416   <span class="comment"># on the command line, try to find a "src" directory by looking at the</span>
<a name="l00417"></a>00417   <span class="comment"># absolute path to each build file's directory.  The first "src" component</span>
<a name="l00418"></a>00418   <span class="comment"># found will be treated as though it were the path used for --depth.</span>
<a name="l00419"></a>00419   <span class="keywordflow">if</span> <span class="keywordflow">not</span> options.depth:
<a name="l00420"></a>00420     <span class="keywordflow">for</span> build_file <span class="keywordflow">in</span> build_files:
<a name="l00421"></a>00421       build_file_dir = os.path.abspath(os.path.dirname(build_file))
<a name="l00422"></a>00422       build_file_dir_components = build_file_dir.split(os.path.sep)
<a name="l00423"></a>00423       components_len = len(build_file_dir_components)
<a name="l00424"></a>00424       <span class="keywordflow">for</span> index <span class="keywordflow">in</span> xrange(components_len - 1, -1, -1):
<a name="l00425"></a>00425         <span class="keywordflow">if</span> build_file_dir_components[index] == <span class="stringliteral">'src'</span>:
<a name="l00426"></a>00426           options.depth = os.path.sep.join(build_file_dir_components)
<a name="l00427"></a>00427           <span class="keywordflow">break</span>
<a name="l00428"></a>00428         del build_file_dir_components[index]
<a name="l00429"></a>00429 
<a name="l00430"></a>00430       <span class="comment"># If the inner loop found something, break without advancing to another</span>
<a name="l00431"></a>00431       <span class="comment"># build file.</span>
<a name="l00432"></a>00432       <span class="keywordflow">if</span> options.depth:
<a name="l00433"></a>00433         <span class="keywordflow">break</span>
<a name="l00434"></a>00434 
<a name="l00435"></a>00435     <span class="keywordflow">if</span> <span class="keywordflow">not</span> options.depth:
<a name="l00436"></a>00436       <span class="keywordflow">raise</span> GypError(<span class="stringliteral">'Could not automatically locate src directory.  This is'</span>
<a name="l00437"></a>00437                      <span class="stringliteral">'a temporary Chromium feature that will be removed.  Use'</span>
<a name="l00438"></a>00438                      <span class="stringliteral">'--depth as a workaround.'</span>)
<a name="l00439"></a>00439 
<a name="l00440"></a>00440   <span class="comment"># If toplevel-dir is not set, we assume that depth is the root of our source</span>
<a name="l00441"></a>00441   <span class="comment"># tree.</span>
<a name="l00442"></a>00442   <span class="keywordflow">if</span> <span class="keywordflow">not</span> options.toplevel_dir:
<a name="l00443"></a>00443     options.toplevel_dir = options.depth
<a name="l00444"></a>00444 
<a name="l00445"></a>00445   <span class="comment"># -D on the command line sets variable defaults - D isn't just for define,</span>
<a name="l00446"></a>00446   <span class="comment"># it's for default.  Perhaps there should be a way to force (-F?) a</span>
<a name="l00447"></a>00447   <span class="comment"># variable's value so that it can't be overridden by anything else.</span>
<a name="l00448"></a>00448   cmdline_default_variables = {}
<a name="l00449"></a>00449   defines = []
<a name="l00450"></a>00450   <span class="keywordflow">if</span> options.use_environment:
<a name="l00451"></a>00451     defines += ShlexEnv(<span class="stringliteral">'GYP_DEFINES'</span>)
<a name="l00452"></a>00452   <span class="keywordflow">if</span> options.defines:
<a name="l00453"></a>00453     defines += options.defines
<a name="l00454"></a>00454   cmdline_default_variables = NameValueListToDict(defines)
<a name="l00455"></a>00455   <span class="keywordflow">if</span> DEBUG_GENERAL <span class="keywordflow">in</span> gyp.debug:
<a name="l00456"></a>00456     DebugOutput(DEBUG_GENERAL,
<a name="l00457"></a>00457                 <span class="stringliteral">"cmdline_default_variables: %s"</span>, cmdline_default_variables)
<a name="l00458"></a>00458 
<a name="l00459"></a>00459   <span class="comment"># Set up includes.</span>
<a name="l00460"></a>00460   includes = []
<a name="l00461"></a>00461 
<a name="l00462"></a>00462   <span class="comment"># If ~/.gyp/include.gypi exists, it'll be forcibly included into every</span>
<a name="l00463"></a>00463   <span class="comment"># .gyp file that's loaded, before anything else is included.</span>
<a name="l00464"></a>00464   <span class="keywordflow">if</span> home_dot_gyp != <span class="keywordtype">None</span>:
<a name="l00465"></a>00465     default_include = os.path.join(home_dot_gyp, <span class="stringliteral">'include.gypi'</span>)
<a name="l00466"></a>00466     <span class="keywordflow">if</span> os.path.exists(default_include):
<a name="l00467"></a>00467       <span class="keywordflow">print</span> <span class="stringliteral">'Using overrides found in '</span> + default_include
<a name="l00468"></a>00468       includes.append(default_include)
<a name="l00469"></a>00469 
<a name="l00470"></a>00470   <span class="comment"># Command-line --include files come after the default include.</span>
<a name="l00471"></a>00471   <span class="keywordflow">if</span> options.includes:
<a name="l00472"></a>00472     includes.extend(options.includes)
<a name="l00473"></a>00473 
<a name="l00474"></a>00474   <span class="comment"># Generator flags should be prefixed with the target generator since they</span>
<a name="l00475"></a>00475   <span class="comment"># are global across all generator runs.</span>
<a name="l00476"></a>00476   gen_flags = []
<a name="l00477"></a>00477   <span class="keywordflow">if</span> options.use_environment:
<a name="l00478"></a>00478     gen_flags += ShlexEnv(<span class="stringliteral">'GYP_GENERATOR_FLAGS'</span>)
<a name="l00479"></a>00479   <span class="keywordflow">if</span> options.generator_flags:
<a name="l00480"></a>00480     gen_flags += options.generator_flags
<a name="l00481"></a>00481   generator_flags = NameValueListToDict(gen_flags)
<a name="l00482"></a>00482   <span class="keywordflow">if</span> DEBUG_GENERAL <span class="keywordflow">in</span> gyp.debug.keys():
<a name="l00483"></a>00483     DebugOutput(DEBUG_GENERAL, <span class="stringliteral">"generator_flags: %s"</span>, generator_flags)
<a name="l00484"></a>00484 
<a name="l00485"></a>00485   <span class="comment"># Generate all requested formats (use a set in case we got one format request</span>
<a name="l00486"></a>00486   <span class="comment"># twice)</span>
<a name="l00487"></a>00487   <span class="keywordflow">for</span> format <span class="keywordflow">in</span> set(options.formats):
<a name="l00488"></a>00488     params = {<span class="stringliteral">'options'</span>: options,
<a name="l00489"></a>00489               <span class="stringliteral">'build_files'</span>: build_files,
<a name="l00490"></a>00490               <span class="stringliteral">'generator_flags'</span>: generator_flags,
<a name="l00491"></a>00491               <span class="stringliteral">'cwd'</span>: os.getcwd(),
<a name="l00492"></a>00492               <span class="stringliteral">'build_files_arg'</span>: build_files_arg,
<a name="l00493"></a>00493               <span class="stringliteral">'gyp_binary'</span>: sys.argv[0],
<a name="l00494"></a>00494               <span class="stringliteral">'home_dot_gyp'</span>: home_dot_gyp,
<a name="l00495"></a>00495               <span class="stringliteral">'parallel'</span>: options.parallel,
<a name="l00496"></a>00496               <span class="stringliteral">'root_targets'</span>: options.root_targets,
<a name="l00497"></a>00497               <span class="stringliteral">'target_arch'</span>: cmdline_default_variables.get(<span class="stringliteral">'target_arch'</span>, <span class="stringliteral">''</span>)}
<a name="l00498"></a>00498 
<a name="l00499"></a>00499     <span class="comment"># Start with the default variables from the command line.</span>
<a name="l00500"></a>00500     [generator, flat_list, targets, data] = Load(
<a name="l00501"></a>00501         build_files, format, cmdline_default_variables, includes, options.depth,
<a name="l00502"></a>00502         params, options.check, options.circular_check)
<a name="l00503"></a>00503 
<a name="l00504"></a>00504     <span class="comment"># TODO(mark): Pass |data| for now because the generator needs a list of</span>
<a name="l00505"></a>00505     <span class="comment"># build files that came in.  In the future, maybe it should just accept</span>
<a name="l00506"></a>00506     <span class="comment"># a list, and not the whole data dict.</span>
<a name="l00507"></a>00507     <span class="comment"># NOTE: flat_list is the flattened dependency graph specifying the order</span>
<a name="l00508"></a>00508     <span class="comment"># that targets may be built.  Build systems that operate serially or that</span>
<a name="l00509"></a>00509     <span class="comment"># need to have dependencies defined before dependents reference them should</span>
<a name="l00510"></a>00510     <span class="comment"># generate targets in the order specified in flat_list.</span>
<a name="l00511"></a>00511     generator.GenerateOutput(flat_list, targets, data, params)
<a name="l00512"></a>00512 
<a name="l00513"></a>00513     <span class="keywordflow">if</span> options.configs:
<a name="l00514"></a>00514       valid_configs = targets[flat_list[0]][<span class="stringliteral">'configurations'</span>].keys()
<a name="l00515"></a>00515       <span class="keywordflow">for</span> conf <span class="keywordflow">in</span> options.configs:
<a name="l00516"></a>00516         <span class="keywordflow">if</span> conf <span class="keywordflow">not</span> <span class="keywordflow">in</span> valid_configs:
<a name="l00517"></a>00517           <span class="keywordflow">raise</span> GypError(<span class="stringliteral">'Invalid config specified via --build: %s'</span> % conf)
<a name="l00518"></a>00518       generator.PerformBuild(data, options.configs, params)
<a name="l00519"></a>00519 
<a name="l00520"></a>00520   <span class="comment"># Done</span>
<a name="l00521"></a>00521   <span class="keywordflow">return</span> 0
<a name="l00522"></a>00522 
<a name="l00523"></a>00523 
<a name="l00524"></a><a class="code" href="../../d9/d41/namespacegyp.html#0de859bd6c2896e44f13e6ab9d4ecdc6">00524</a> <span class="keyword">def </span><a class="code" href="../../d9/d41/namespacegyp.html#0de859bd6c2896e44f13e6ab9d4ecdc6">main</a>(args):
<a name="l00525"></a>00525   <span class="keywordflow">try</span>:
<a name="l00526"></a>00526     <span class="keywordflow">return</span> gyp_main(args)
<a name="l00527"></a>00527   <span class="keywordflow">except</span> GypError, e:
<a name="l00528"></a>00528     sys.stderr.write(<span class="stringliteral">"gyp: %s\n"</span> % e)
<a name="l00529"></a>00529     <span class="keywordflow">return</span> 1
<a name="l00530"></a>00530 
<a name="l00531"></a>00531 <span class="comment"># NOTE: setuptools generated console_scripts calls function with no arguments</span>
<a name="l00532"></a><a class="code" href="../../d9/d41/namespacegyp.html#c8b7dddb8c054914499fa7d77c2e2497">00532</a> <span class="keyword">def </span><a class="code" href="../../d9/d41/namespacegyp.html#c8b7dddb8c054914499fa7d77c2e2497">script_main</a>():
<a name="l00533"></a>00533   <span class="keywordflow">return</span> main(sys.argv[1:])
<a name="l00534"></a>00534 
<a name="l00535"></a>00535 <span class="keywordflow">if</span> __name__ == <span class="stringliteral">'__main__'</span>:
<a name="l00536"></a>00536   sys.exit(script_main())
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Wed Oct 7 19:26:25 2015 for Emeraldion Lodge (codename Zelda) by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.8 </small></address>
</body>
</html>
