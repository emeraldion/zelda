<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Emeraldion Lodge (codename Zelda): /Users/delphine/Development/SVN/emeraldion.it/zelda/node_modules/gulp-sass/node_modules/node-sass/node_modules/node-gyp/gyp/pylib/gyp/msvs_emulation.py Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css">
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.8 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="../../main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="../../files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="../../globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>/Users/delphine/Development/SVN/emeraldion.it/zelda/node_modules/gulp-sass/node_modules/node-sass/node_modules/node-gyp/gyp/pylib/gyp/msvs_emulation.py</h1><a href="../../d3/d70/msvs__emulation_8py.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a><a class="code" href="../../d1/ddf/namespacegyp_1_1msvs__emulation.html">00001</a> <span class="comment"># Copyright (c) 2012 Google Inc. All rights reserved.</span>
<a name="l00002"></a>00002 <span class="comment"># Use of this source code is governed by a BSD-style license that can be</span>
<a name="l00003"></a>00003 <span class="comment"># found in the LICENSE file.</span>
<a name="l00004"></a>00004 
<a name="l00005"></a>00005 <span class="stringliteral">"""</span>
<a name="l00006"></a>00006 <span class="stringliteral">This module helps emulate Visual Studio 2008 behavior on top of other</span>
<a name="l00007"></a>00007 <span class="stringliteral">build systems, primarily ninja.</span>
<a name="l00008"></a>00008 <span class="stringliteral">"""</span>
<a name="l00009"></a>00009 
<a name="l00010"></a>00010 <span class="keyword">import</span> os
<a name="l00011"></a>00011 <span class="keyword">import</span> re
<a name="l00012"></a>00012 <span class="keyword">import</span> subprocess
<a name="l00013"></a>00013 <span class="keyword">import</span> sys
<a name="l00014"></a>00014 
<a name="l00015"></a>00015 <span class="keyword">from</span> gyp.common <span class="keyword">import</span> OrderedSet
<a name="l00016"></a>00016 <span class="keyword">import</span> gyp.MSVSUtil
<a name="l00017"></a>00017 <span class="keyword">import</span> gyp.MSVSVersion
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 
<a name="l00020"></a><a class="code" href="../../d1/ddf/namespacegyp_1_1msvs__emulation.html#e5e3246ded8faa9be0a0473dc002d54b">00020</a> windows_quoter_regex = re.compile(<span class="stringliteral">r'(\\*)"'</span>)
<a name="l00021"></a>00021 
<a name="l00022"></a>00022 
<a name="l00023"></a>00023 <span class="keyword">def </span>QuoteForRspFile(arg):
<a name="l00024"></a>00024   <span class="stringliteral">"""Quote a command line argument so that it appears as one argument when</span>
<a name="l00025"></a>00025 <span class="stringliteral">  processed via cmd.exe and parsed by CommandLineToArgvW (as is typical for</span>
<a name="l00026"></a>00026 <span class="stringliteral">  Windows programs)."""</span>
<a name="l00027"></a>00027   <span class="comment"># See http://goo.gl/cuFbX and http://goo.gl/dhPnp including the comment</span>
<a name="l00028"></a>00028   <span class="comment"># threads. This is actually the quoting rules for CommandLineToArgvW, not</span>
<a name="l00029"></a>00029   <span class="comment"># for the shell, because the shell doesn't do anything in Windows. This</span>
<a name="l00030"></a>00030   <span class="comment"># works more or less because most programs (including the compiler, etc.)</span>
<a name="l00031"></a>00031   <span class="comment"># use that function to handle command line arguments.</span>
<a name="l00032"></a>00032 
<a name="l00033"></a>00033   <span class="comment"># For a literal quote, CommandLineToArgvW requires 2n+1 backslashes</span>
<a name="l00034"></a>00034   <span class="comment"># preceding it, and results in n backslashes + the quote. So we substitute</span>
<a name="l00035"></a>00035   <span class="comment"># in 2* what we match, +1 more, plus the quote.</span>
<a name="l00036"></a>00036   arg = windows_quoter_regex.sub(<span class="keyword">lambda</span> mo: 2 * mo.group(1) + <span class="stringliteral">'\\"'</span>, arg)
<a name="l00037"></a>00037 
<a name="l00038"></a>00038   <span class="comment"># %'s also need to be doubled otherwise they're interpreted as batch</span>
<a name="l00039"></a>00039   <span class="comment"># positional arguments. Also make sure to escape the % so that they're</span>
<a name="l00040"></a>00040   <span class="comment"># passed literally through escaping so they can be singled to just the</span>
<a name="l00041"></a>00041   <span class="comment"># original %. Otherwise, trying to pass the literal representation that</span>
<a name="l00042"></a>00042   <span class="comment"># looks like an environment variable to the shell (e.g. %PATH%) would fail.</span>
<a name="l00043"></a><a class="code" href="../../d1/ddf/namespacegyp_1_1msvs__emulation.html#4ef4a85aab5149bdab1fbd46db2fa082">00043</a>   arg = arg.replace(<span class="stringliteral">'%'</span>, <span class="stringliteral">'%%'</span>)
<a name="l00044"></a>00044 
<a name="l00045"></a>00045   <span class="comment"># These commands are used in rsp files, so no escaping for the shell (via ^)</span>
<a name="l00046"></a>00046   <span class="comment"># is necessary.</span>
<a name="l00047"></a>00047 
<a name="l00048"></a>00048   <span class="comment"># Finally, wrap the whole thing in quotes so that the above quote rule</span>
<a name="l00049"></a>00049   <span class="comment"># applies and whitespace isn't a word break.</span>
<a name="l00050"></a>00050   <span class="keywordflow">return</span> <span class="stringliteral">'"'</span> + arg + <span class="stringliteral">'"'</span>
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 
<a name="l00053"></a><a class="code" href="../../d1/ddf/namespacegyp_1_1msvs__emulation.html#12404ba740f3b9e8c18ff474bbd3714a">00053</a> <span class="keyword">def </span><a class="code" href="../../d1/ddf/namespacegyp_1_1msvs__emulation.html#12404ba740f3b9e8c18ff474bbd3714a">EncodeRspFileList</a>(args):
<a name="l00054"></a>00054   <span class="stringliteral">"""Process a list of arguments using QuoteCmdExeArgument."""</span>
<a name="l00055"></a>00055   <span class="comment"># Note that the first argument is assumed to be the command. Don't add</span>
<a name="l00056"></a>00056   <span class="comment"># quotes around it because then built-ins like 'echo', etc. won't work.</span>
<a name="l00057"></a>00057   <span class="comment"># Take care to normpath only the path in the case of 'call ../x.bat' because</span>
<a name="l00058"></a>00058   <span class="comment"># otherwise the whole thing is incorrectly interpreted as a path and not</span>
<a name="l00059"></a>00059   <span class="comment"># normalized correctly.</span>
<a name="l00060"></a>00060   <span class="keywordflow">if</span> <span class="keywordflow">not</span> args: <span class="keywordflow">return</span> <span class="stringliteral">''</span>
<a name="l00061"></a>00061   <span class="keywordflow">if</span> args[0].startswith(<span class="stringliteral">'call '</span>):
<a name="l00062"></a>00062     call, program = args[0].split(<span class="stringliteral">' '</span>, 1)
<a name="l00063"></a>00063     program = call + <span class="stringliteral">' '</span> + os.path.normpath(program)
<a name="l00064"></a>00064   <span class="keywordflow">else</span>:
<a name="l00065"></a>00065     program = os.path.normpath(args[0])
<a name="l00066"></a>00066   <span class="keywordflow">return</span> program + <span class="stringliteral">' '</span> + <span class="stringliteral">' '</span>.join(QuoteForRspFile(arg) <span class="keywordflow">for</span> arg <span class="keywordflow">in</span> args[1:])
<a name="l00067"></a>00067 
<a name="l00068"></a>00068 
<a name="l00069"></a><a class="code" href="../../d1/ddf/namespacegyp_1_1msvs__emulation.html#6dd59e02c997e95367a1be13c130111f">00069</a> <span class="keyword">def </span><a class="code" href="../../d1/ddf/namespacegyp_1_1msvs__emulation.html#6dd59e02c997e95367a1be13c130111f">_GenericRetrieve</a>(root, default, path):
<a name="l00070"></a>00070   <span class="stringliteral">"""Given a list of dictionary keys |path| and a tree of dicts |root|, find</span>
<a name="l00071"></a>00071 <span class="stringliteral">  value at path, or return |default| if any of the path doesn't exist."""</span>
<a name="l00072"></a>00072   <span class="keywordflow">if</span> <span class="keywordflow">not</span> root:
<a name="l00073"></a>00073     <span class="keywordflow">return</span> default
<a name="l00074"></a>00074   <span class="keywordflow">if</span> <span class="keywordflow">not</span> path:
<a name="l00075"></a>00075     <span class="keywordflow">return</span> root
<a name="l00076"></a>00076   <span class="keywordflow">return</span> _GenericRetrieve(root.get(path[0]), default, path[1:])
<a name="l00077"></a>00077 
<a name="l00078"></a>00078 
<a name="l00079"></a><a class="code" href="../../d1/ddf/namespacegyp_1_1msvs__emulation.html#64d10bc342e3733594b6f0a8d6b4bc37">00079</a> <span class="keyword">def </span><a class="code" href="../../d1/ddf/namespacegyp_1_1msvs__emulation.html#64d10bc342e3733594b6f0a8d6b4bc37">_AddPrefix</a>(element, prefix):
<a name="l00080"></a>00080   <span class="stringliteral">"""Add |prefix| to |element| or each subelement if element is iterable."""</span>
<a name="l00081"></a>00081   <span class="keywordflow">if</span> element <span class="keywordflow">is</span> <span class="keywordtype">None</span>:
<a name="l00082"></a>00082     <span class="keywordflow">return</span> element
<a name="l00083"></a>00083   <span class="comment"># Note, not Iterable because we don't want to handle strings like that.</span>
<a name="l00084"></a>00084   <span class="keywordflow">if</span> isinstance(element, list) <span class="keywordflow">or</span> isinstance(element, tuple):
<a name="l00085"></a>00085     <span class="keywordflow">return</span> [prefix + e <span class="keywordflow">for</span> e <span class="keywordflow">in</span> element]
<a name="l00086"></a>00086   <span class="keywordflow">else</span>:
<a name="l00087"></a>00087     <span class="keywordflow">return</span> prefix + element
<a name="l00088"></a>00088 
<a name="l00089"></a>00089 
<a name="l00090"></a><a class="code" href="../../d1/ddf/namespacegyp_1_1msvs__emulation.html#9ab06d8f6c75cb97b7e86a3d41aaf2c4">00090</a> <span class="keyword">def </span><a class="code" href="../../d1/ddf/namespacegyp_1_1msvs__emulation.html#9ab06d8f6c75cb97b7e86a3d41aaf2c4">_DoRemapping</a>(element, map):
<a name="l00091"></a>00091   <span class="stringliteral">"""If |element| then remap it through |map|. If |element| is iterable then</span>
<a name="l00092"></a>00092 <span class="stringliteral">  each item will be remapped. Any elements not found will be removed."""</span>
<a name="l00093"></a>00093   <span class="keywordflow">if</span> map <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span> <span class="keywordflow">and</span> element <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:
<a name="l00094"></a>00094     <span class="keywordflow">if</span> <span class="keywordflow">not</span> callable(map):
<a name="l00095"></a>00095       map = map.get <span class="comment"># Assume it's a dict, otherwise a callable to do the remap.</span>
<a name="l00096"></a>00096     <span class="keywordflow">if</span> isinstance(element, list) <span class="keywordflow">or</span> isinstance(element, tuple):
<a name="l00097"></a>00097       element = filter(<span class="keywordtype">None</span>, [map(elem) <span class="keywordflow">for</span> elem <span class="keywordflow">in</span> element])
<a name="l00098"></a>00098     <span class="keywordflow">else</span>:
<a name="l00099"></a>00099       element = map(element)
<a name="l00100"></a>00100   <span class="keywordflow">return</span> element
<a name="l00101"></a>00101 
<a name="l00102"></a>00102 
<a name="l00103"></a><a class="code" href="../../d1/ddf/namespacegyp_1_1msvs__emulation.html#c01fa1d5810e7952cc1ebacf62d21558">00103</a> <span class="keyword">def </span><a class="code" href="../../d1/ddf/namespacegyp_1_1msvs__emulation.html#c01fa1d5810e7952cc1ebacf62d21558">_AppendOrReturn</a>(append, element):
<a name="l00104"></a>00104   <span class="stringliteral">"""If |append| is None, simply return |element|. If |append| is not None,</span>
<a name="l00105"></a>00105 <span class="stringliteral">  then add |element| to it, adding each item in |element| if it's a list or</span>
<a name="l00106"></a>00106 <span class="stringliteral">  tuple."""</span>
<a name="l00107"></a>00107   <span class="keywordflow">if</span> append <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span> <span class="keywordflow">and</span> element <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:
<a name="l00108"></a>00108     <span class="keywordflow">if</span> isinstance(element, list) <span class="keywordflow">or</span> isinstance(element, tuple):
<a name="l00109"></a>00109       append.extend(element)
<a name="l00110"></a>00110     <span class="keywordflow">else</span>:
<a name="l00111"></a>00111       append.append(element)
<a name="l00112"></a>00112   <span class="keywordflow">else</span>:
<a name="l00113"></a>00113     <span class="keywordflow">return</span> element
<a name="l00114"></a>00114 
<a name="l00115"></a>00115 
<a name="l00116"></a><a class="code" href="../../d1/ddf/namespacegyp_1_1msvs__emulation.html#88f773fcdb688c064710418774e821fe">00116</a> <span class="keyword">def </span><a class="code" href="../../d1/ddf/namespacegyp_1_1msvs__emulation.html#88f773fcdb688c064710418774e821fe">_FindDirectXInstallation</a>():
<a name="l00117"></a>00117   <span class="stringliteral">"""Try to find an installation location for the DirectX SDK. Check for the</span>
<a name="l00118"></a>00118 <span class="stringliteral">  standard environment variable, and if that doesn't exist, try to find</span>
<a name="l00119"></a>00119 <span class="stringliteral">  via the registry. May return None if not found in either location."""</span>
<a name="l00120"></a>00120   <span class="comment"># Return previously calculated value, if there is one</span>
<a name="l00121"></a>00121   <span class="keywordflow">if</span> hasattr(_FindDirectXInstallation, <span class="stringliteral">'dxsdk_dir'</span>):
<a name="l00122"></a>00122     <span class="keywordflow">return</span> _FindDirectXInstallation.dxsdk_dir
<a name="l00123"></a>00123 
<a name="l00124"></a>00124   dxsdk_dir = os.environ.get(<span class="stringliteral">'DXSDK_DIR'</span>)
<a name="l00125"></a>00125   <span class="keywordflow">if</span> <span class="keywordflow">not</span> dxsdk_dir:
<a name="l00126"></a>00126     <span class="comment"># Setup params to pass to and attempt to launch reg.exe.</span>
<a name="l00127"></a>00127     cmd = [<span class="stringliteral">'reg.exe'</span>, <span class="stringliteral">'query'</span>, <span class="stringliteral">r'HKLM\Software\Microsoft\DirectX'</span>, <span class="stringliteral">'/s'</span>]
<a name="l00128"></a>00128     p = subprocess.Popen(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
<a name="l00129"></a>00129     <span class="keywordflow">for</span> line <span class="keywordflow">in</span> p.communicate()[0].splitlines():
<a name="l00130"></a>00130       <span class="keywordflow">if</span> <span class="stringliteral">'InstallPath'</span> <span class="keywordflow">in</span> line:
<a name="l00131"></a>00131         dxsdk_dir = line.split(<span class="stringliteral">'    '</span>)[3] + <span class="stringliteral">"\\"</span>
<a name="l00132"></a>00132 
<a name="l00133"></a>00133   <span class="comment"># Cache return value</span>
<a name="l00134"></a>00134   _FindDirectXInstallation.dxsdk_dir = dxsdk_dir
<a name="l00135"></a>00135   <span class="keywordflow">return</span> dxsdk_dir
<a name="l00136"></a>00136 
<a name="l00137"></a>00137 
<a name="l00138"></a><a class="code" href="../../d1/ddf/namespacegyp_1_1msvs__emulation.html#5f6ee80944f725869718283d97ecc834">00138</a> <span class="keyword">def </span><a class="code" href="../../d1/ddf/namespacegyp_1_1msvs__emulation.html#5f6ee80944f725869718283d97ecc834">GetGlobalVSMacroEnv</a>(vs_version):
<a name="l00139"></a>00139   <span class="stringliteral">"""Get a dict of variables mapping internal VS macro names to their gyp</span>
<a name="l00140"></a>00140 <span class="stringliteral">  equivalents. Returns all variables that are independent of the target."""</span>
<a name="l00141"></a>00141   env = {}
<a name="l00142"></a>00142   <span class="comment"># '$(VSInstallDir)' and '$(VCInstallDir)' are available when and only when</span>
<a name="l00143"></a>00143   <span class="comment"># Visual Studio is actually installed.</span>
<a name="l00144"></a>00144   <span class="keywordflow">if</span> vs_version.Path():
<a name="l00145"></a>00145     env[<span class="stringliteral">'$(VSInstallDir)'</span>] = vs_version.Path()
<a name="l00146"></a>00146     env[<span class="stringliteral">'$(VCInstallDir)'</span>] = os.path.join(vs_version.Path(), <span class="stringliteral">'VC'</span>) + <span class="stringliteral">'\\'</span>
<a name="l00147"></a>00147   <span class="comment"># Chromium uses DXSDK_DIR in include/lib paths, but it may or may not be</span>
<a name="l00148"></a>00148   <span class="comment"># set. This happens when the SDK is sync'd via src-internal, rather than</span>
<a name="l00149"></a>00149   <span class="comment"># by typical end-user installation of the SDK. If it's not set, we don't</span>
<a name="l00150"></a>00150   <span class="comment"># want to leave the unexpanded variable in the path, so simply strip it.</span>
<a name="l00151"></a>00151   dxsdk_dir = _FindDirectXInstallation()
<a name="l00152"></a>00152   env[<span class="stringliteral">'$(DXSDK_DIR)'</span>] = dxsdk_dir <span class="keywordflow">if</span> dxsdk_dir <span class="keywordflow">else</span> <span class="stringliteral">''</span>
<a name="l00153"></a>00153   <span class="comment"># Try to find an installation location for the Windows DDK by checking</span>
<a name="l00154"></a>00154   <span class="comment"># the WDK_DIR environment variable, may be None.</span>
<a name="l00155"></a>00155   env[<span class="stringliteral">'$(WDK_DIR)'</span>] = os.environ.get(<span class="stringliteral">'WDK_DIR'</span>, <span class="stringliteral">''</span>)
<a name="l00156"></a>00156   <span class="keywordflow">return</span> env
<a name="l00157"></a>00157 
<a name="l00158"></a><a class="code" href="../../d1/ddf/namespacegyp_1_1msvs__emulation.html#485dd08dd4aca945f837eba3e68cda3e">00158</a> <span class="keyword">def </span><a class="code" href="../../d1/ddf/namespacegyp_1_1msvs__emulation.html#485dd08dd4aca945f837eba3e68cda3e">ExtractSharedMSVSSystemIncludes</a>(configs, generator_flags):
<a name="l00159"></a>00159   <span class="stringliteral">"""Finds msvs_system_include_dirs that are common to all targets, removes</span>
<a name="l00160"></a>00160 <span class="stringliteral">  them from all targets, and returns an OrderedSet containing them."""</span>
<a name="l00161"></a>00161   all_system_includes = OrderedSet(
<a name="l00162"></a>00162       configs[0].get(<span class="stringliteral">'msvs_system_include_dirs'</span>, []))
<a name="l00163"></a>00163   <span class="keywordflow">for</span> config <span class="keywordflow">in</span> configs[1:]:
<a name="l00164"></a>00164     system_includes = config.get(<span class="stringliteral">'msvs_system_include_dirs'</span>, [])
<a name="l00165"></a>00165     all_system_includes = all_system_includes &amp; OrderedSet(system_includes)
<a name="l00166"></a>00166   <span class="keywordflow">if</span> <span class="keywordflow">not</span> all_system_includes:
<a name="l00167"></a>00167     <span class="keywordflow">return</span> <span class="keywordtype">None</span>
<a name="l00168"></a>00168   <span class="comment"># Expand macros in all_system_includes.</span>
<a name="l00169"></a>00169   env = GetGlobalVSMacroEnv(GetVSVersion(generator_flags))
<a name="l00170"></a>00170   expanded_system_includes = OrderedSet([ExpandMacros(include, env)
<a name="l00171"></a>00171                                          <span class="keywordflow">for</span> include <span class="keywordflow">in</span> all_system_includes])
<a name="l00172"></a>00172   <span class="keywordflow">if</span> any([<span class="stringliteral">'$'</span> <span class="keywordflow">in</span> include <span class="keywordflow">for</span> include <span class="keywordflow">in</span> expanded_system_includes]):
<a name="l00173"></a>00173     <span class="comment"># Some path relies on target-specific variables, bail.</span>
<a name="l00174"></a>00174     <span class="keywordflow">return</span> <span class="keywordtype">None</span>
<a name="l00175"></a>00175 
<a name="l00176"></a>00176   <span class="comment"># Remove system includes shared by all targets from the targets.</span>
<a name="l00177"></a>00177   <span class="keywordflow">for</span> config <span class="keywordflow">in</span> configs:
<a name="l00178"></a>00178     includes = config.get(<span class="stringliteral">'msvs_system_include_dirs'</span>, [])
<a name="l00179"></a>00179     <span class="keywordflow">if</span> includes:  <span class="comment"># Don't insert a msvs_system_include_dirs key if not needed.</span>
<a name="l00180"></a>00180       <span class="comment"># This must check the unexpanded includes list:</span>
<a name="l00181"></a>00181       new_includes = [i <span class="keywordflow">for</span> i <span class="keywordflow">in</span> includes <span class="keywordflow">if</span> i <span class="keywordflow">not</span> <span class="keywordflow">in</span> all_system_includes]
<a name="l00182"></a>00182       config[<span class="stringliteral">'msvs_system_include_dirs'</span>] = new_includes
<a name="l00183"></a>00183   <span class="keywordflow">return</span> expanded_system_includes
<a name="l00184"></a>00184 
<a name="l00185"></a>00185 
<a name="l00186"></a><a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html">00186</a> <span class="keyword">class </span><a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html">MsvsSettings</a>(object):
<a name="l00187"></a>00187   <span class="stringliteral">"""A class that understands the gyp 'msvs_...' values (especially the</span>
<a name="l00188"></a>00188 <span class="stringliteral">  msvs_settings field). They largely correpond to the VS2008 IDE DOM. This</span>
<a name="l00189"></a>00189 <span class="stringliteral">  class helps map those settings to command line options."""</span>
<a name="l00190"></a>00190 
<a name="l00191"></a><a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#c775ee34451fdfa742b318538164070e">00191</a>   <span class="keyword">def </span><a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#c775ee34451fdfa742b318538164070e">__init__</a>(self, spec, generator_flags):
<a name="l00192"></a><a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#daf1b66faf18504ec4b5c8c0b7f6763b">00192</a>     self.<a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#daf1b66faf18504ec4b5c8c0b7f6763b">spec</a> = spec
<a name="l00193"></a><a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#365c5b6a02f70877282b2b7dbf443b0a">00193</a>     self.<a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#365c5b6a02f70877282b2b7dbf443b0a">vs_version</a> = GetVSVersion(generator_flags)
<a name="l00194"></a>00194 
<a name="l00195"></a>00195     supported_fields = [
<a name="l00196"></a>00196         (<span class="stringliteral">'msvs_configuration_attributes'</span>, dict),
<a name="l00197"></a>00197         (<span class="stringliteral">'msvs_settings'</span>, dict),
<a name="l00198"></a>00198         (<span class="stringliteral">'msvs_system_include_dirs'</span>, list),
<a name="l00199"></a>00199         (<span class="stringliteral">'msvs_disabled_warnings'</span>, list),
<a name="l00200"></a>00200         (<span class="stringliteral">'msvs_precompiled_header'</span>, str),
<a name="l00201"></a>00201         (<span class="stringliteral">'msvs_precompiled_source'</span>, str),
<a name="l00202"></a>00202         (<span class="stringliteral">'msvs_configuration_platform'</span>, str),
<a name="l00203"></a>00203         (<span class="stringliteral">'msvs_target_platform'</span>, str),
<a name="l00204"></a>00204         ]
<a name="l00205"></a>00205     configs = spec[<span class="stringliteral">'configurations'</span>]
<a name="l00206"></a>00206     <span class="keywordflow">for</span> field, default <span class="keywordflow">in</span> supported_fields:
<a name="l00207"></a>00207       setattr(self, field, {})
<a name="l00208"></a>00208       <span class="keywordflow">for</span> configname, config <span class="keywordflow">in</span> configs.iteritems():
<a name="l00209"></a>00209         getattr(self, field)[configname] = config.get(field, default())
<a name="l00210"></a>00210 
<a name="l00211"></a><a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#ed0ff08fbb29dbca99043f5910012c08">00211</a>     self.<a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#ed0ff08fbb29dbca99043f5910012c08">msvs_cygwin_dirs</a> = spec.get(<span class="stringliteral">'msvs_cygwin_dirs'</span>, [<span class="stringliteral">'.'</span>])
<a name="l00212"></a>00212 
<a name="l00213"></a>00213     unsupported_fields = [
<a name="l00214"></a>00214         <span class="stringliteral">'msvs_prebuild'</span>,
<a name="l00215"></a>00215         <span class="stringliteral">'msvs_postbuild'</span>,
<a name="l00216"></a>00216     ]
<a name="l00217"></a>00217     unsupported = []
<a name="l00218"></a>00218     <span class="keywordflow">for</span> field <span class="keywordflow">in</span> unsupported_fields:
<a name="l00219"></a>00219       <span class="keywordflow">for</span> config <span class="keywordflow">in</span> configs.values():
<a name="l00220"></a>00220         <span class="keywordflow">if</span> field <span class="keywordflow">in</span> config:
<a name="l00221"></a>00221           unsupported += [<span class="stringliteral">"%s not supported (target %s)."</span> %
<a name="l00222"></a>00222                           (field, spec[<span class="stringliteral">'target_name'</span>])]
<a name="l00223"></a>00223     <span class="keywordflow">if</span> unsupported:
<a name="l00224"></a>00224       <span class="keywordflow">raise</span> Exception(<span class="stringliteral">'\n'</span>.join(unsupported))
<a name="l00225"></a>00225 
<a name="l00226"></a><a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#5541d2dfb3c5a7b87ae67e0509937e9a">00226</a>   <span class="keyword">def </span><a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#5541d2dfb3c5a7b87ae67e0509937e9a">GetExtension</a>(self):
<a name="l00227"></a>00227     <span class="stringliteral">"""Returns the extension for the target, with no leading dot.</span>
<a name="l00228"></a>00228 <span class="stringliteral"></span>
<a name="l00229"></a>00229 <span class="stringliteral">    Uses 'product_extension' if specified, otherwise uses MSVS defaults based on</span>
<a name="l00230"></a>00230 <span class="stringliteral">    the target type.</span>
<a name="l00231"></a>00231 <span class="stringliteral">    """</span>
<a name="l00232"></a>00232     ext = self.<a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#daf1b66faf18504ec4b5c8c0b7f6763b">spec</a>.get(<span class="stringliteral">'product_extension'</span>, <span class="keywordtype">None</span>)
<a name="l00233"></a>00233     <span class="keywordflow">if</span> ext:
<a name="l00234"></a>00234       <span class="keywordflow">return</span> ext
<a name="l00235"></a>00235     <span class="keywordflow">return</span> gyp.MSVSUtil.TARGET_TYPE_EXT.get(self.<a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#daf1b66faf18504ec4b5c8c0b7f6763b">spec</a>[<span class="stringliteral">'type'</span>], <span class="stringliteral">''</span>)
<a name="l00236"></a>00236 
<a name="l00237"></a><a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#dd98cc8f2dd05b26bafd6c8a208a3389">00237</a>   <span class="keyword">def </span><a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#dd98cc8f2dd05b26bafd6c8a208a3389">GetVSMacroEnv</a>(self, base_to_build=None, config=None):
<a name="l00238"></a>00238     <span class="stringliteral">"""Get a dict of variables mapping internal VS macro names to their gyp</span>
<a name="l00239"></a>00239 <span class="stringliteral">    equivalents."""</span>
<a name="l00240"></a>00240     target_platform = <span class="stringliteral">'Win32'</span> <span class="keywordflow">if</span> self.<a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#727eacd31a0e10c816473ff9eaeb82ec">GetArch</a>(config) == <span class="stringliteral">'x86'</span> <span class="keywordflow">else</span> <span class="stringliteral">'x64'</span>
<a name="l00241"></a>00241     target_name = self.<a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#daf1b66faf18504ec4b5c8c0b7f6763b">spec</a>.get(<span class="stringliteral">'product_prefix'</span>, <span class="stringliteral">''</span>) + \
<a name="l00242"></a>00242         self.<a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#daf1b66faf18504ec4b5c8c0b7f6763b">spec</a>.get(<span class="stringliteral">'product_name'</span>, self.<a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#daf1b66faf18504ec4b5c8c0b7f6763b">spec</a>[<span class="stringliteral">'target_name'</span>])
<a name="l00243"></a>00243     target_dir = base_to_build + <span class="stringliteral">'\\'</span> <span class="keywordflow">if</span> base_to_build <span class="keywordflow">else</span> <span class="stringliteral">''</span>
<a name="l00244"></a>00244     target_ext = <span class="stringliteral">'.'</span> + self.<a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#5541d2dfb3c5a7b87ae67e0509937e9a">GetExtension</a>()
<a name="l00245"></a>00245     target_file_name = target_name + target_ext
<a name="l00246"></a>00246 
<a name="l00247"></a>00247     replacements = {
<a name="l00248"></a>00248         <span class="stringliteral">'$(InputName)'</span>: <span class="stringliteral">'${root}'</span>,
<a name="l00249"></a>00249         <span class="stringliteral">'$(InputPath)'</span>: <span class="stringliteral">'${source}'</span>,
<a name="l00250"></a>00250         <span class="stringliteral">'$(IntDir)'</span>: <span class="stringliteral">'$!INTERMEDIATE_DIR'</span>,
<a name="l00251"></a>00251         <span class="stringliteral">'$(OutDir)\\'</span>: target_dir,
<a name="l00252"></a>00252         <span class="stringliteral">'$(PlatformName)'</span>: target_platform,
<a name="l00253"></a>00253         <span class="stringliteral">'$(ProjectDir)\\'</span>: <span class="stringliteral">''</span>,
<a name="l00254"></a>00254         <span class="stringliteral">'$(ProjectName)'</span>: self.<a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#daf1b66faf18504ec4b5c8c0b7f6763b">spec</a>[<span class="stringliteral">'target_name'</span>],
<a name="l00255"></a>00255         <span class="stringliteral">'$(TargetDir)\\'</span>: target_dir,
<a name="l00256"></a>00256         <span class="stringliteral">'$(TargetExt)'</span>: target_ext,
<a name="l00257"></a>00257         <span class="stringliteral">'$(TargetFileName)'</span>: target_file_name,
<a name="l00258"></a>00258         <span class="stringliteral">'$(TargetName)'</span>: target_name,
<a name="l00259"></a>00259         <span class="stringliteral">'$(TargetPath)'</span>: os.path.join(target_dir, target_file_name),
<a name="l00260"></a>00260     }
<a name="l00261"></a>00261     replacements.update(GetGlobalVSMacroEnv(self.<a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#365c5b6a02f70877282b2b7dbf443b0a">vs_version</a>))
<a name="l00262"></a>00262     <span class="keywordflow">return</span> replacements
<a name="l00263"></a>00263 
<a name="l00264"></a><a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#ebdaa9196d84bbc3c2ac3021874ba626">00264</a>   <span class="keyword">def </span><a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#ebdaa9196d84bbc3c2ac3021874ba626">ConvertVSMacros</a>(self, s, base_to_build=None, config=None):
<a name="l00265"></a>00265     <span class="stringliteral">"""Convert from VS macro names to something equivalent."""</span>
<a name="l00266"></a>00266     env = self.<a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#dd98cc8f2dd05b26bafd6c8a208a3389">GetVSMacroEnv</a>(base_to_build, config=config)
<a name="l00267"></a>00267     <span class="keywordflow">return</span> ExpandMacros(s, env)
<a name="l00268"></a>00268 
<a name="l00269"></a><a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#8e0a56cdcdf26a3f66c0ccd0477da300">00269</a>   <span class="keyword">def </span><a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#8e0a56cdcdf26a3f66c0ccd0477da300">AdjustLibraries</a>(self, libraries):
<a name="l00270"></a>00270     <span class="stringliteral">"""Strip -l from library if it's specified with that."""</span>
<a name="l00271"></a>00271     libs = [lib[2:] <span class="keywordflow">if</span> lib.startswith(<span class="stringliteral">'-l'</span>) <span class="keywordflow">else</span> lib <span class="keywordflow">for</span> lib <span class="keywordflow">in</span> libraries]
<a name="l00272"></a>00272     <span class="keywordflow">return</span> [lib + <span class="stringliteral">'.lib'</span> <span class="keywordflow">if</span> <span class="keywordflow">not</span> lib.endswith(<span class="stringliteral">'.lib'</span>) <span class="keywordflow">else</span> lib <span class="keywordflow">for</span> lib <span class="keywordflow">in</span> libs]
<a name="l00273"></a>00273 
<a name="l00274"></a><a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#038c3ba15e25488129c3edee0b697942">00274</a>   <span class="keyword">def </span><a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#038c3ba15e25488129c3edee0b697942">_GetAndMunge</a>(self, field, path, default, prefix, append, map):
<a name="l00275"></a>00275     <span class="stringliteral">"""Retrieve a value from |field| at |path| or return |default|. If</span>
<a name="l00276"></a>00276 <span class="stringliteral">    |append| is specified, and the item is found, it will be appended to that</span>
<a name="l00277"></a>00277 <span class="stringliteral">    object instead of returned. If |map| is specified, results will be</span>
<a name="l00278"></a>00278 <span class="stringliteral">    remapped through |map| before being returned or appended."""</span>
<a name="l00279"></a>00279     result = _GenericRetrieve(field, default, path)
<a name="l00280"></a>00280     result = _DoRemapping(result, map)
<a name="l00281"></a>00281     result = _AddPrefix(result, prefix)
<a name="l00282"></a>00282     <span class="keywordflow">return</span> _AppendOrReturn(append, result)
<a name="l00283"></a>00283 
<a name="l00284"></a><a class="code" href="../../d7/da2/classgyp_1_1msvs__emulation_1_1_msvs_settings_1_1___get_wrapper.html">00284</a>   <span class="keyword">class </span><a class="code" href="../../d7/da2/classgyp_1_1msvs__emulation_1_1_msvs_settings_1_1___get_wrapper.html">_GetWrapper</a>(object):
<a name="l00285"></a><a class="code" href="../../d7/da2/classgyp_1_1msvs__emulation_1_1_msvs_settings_1_1___get_wrapper.html#c775ee34451fdfa742b318538164070e">00285</a>     <span class="keyword">def </span><a class="code" href="../../d7/da2/classgyp_1_1msvs__emulation_1_1_msvs_settings_1_1___get_wrapper.html#c775ee34451fdfa742b318538164070e">__init__</a>(self, parent, field, base_path, append=None):
<a name="l00286"></a><a class="code" href="../../d7/da2/classgyp_1_1msvs__emulation_1_1_msvs_settings_1_1___get_wrapper.html#457d913bff1ebc8671c1eca1c9d5fc03">00286</a>       self.<a class="code" href="../../d7/da2/classgyp_1_1msvs__emulation_1_1_msvs_settings_1_1___get_wrapper.html#457d913bff1ebc8671c1eca1c9d5fc03">parent</a> = parent
<a name="l00287"></a><a class="code" href="../../d7/da2/classgyp_1_1msvs__emulation_1_1_msvs_settings_1_1___get_wrapper.html#d62af17df5486963eef933792624216d">00287</a>       self.<a class="code" href="../../d7/da2/classgyp_1_1msvs__emulation_1_1_msvs_settings_1_1___get_wrapper.html#d62af17df5486963eef933792624216d">field</a> = field
<a name="l00288"></a><a class="code" href="../../d7/da2/classgyp_1_1msvs__emulation_1_1_msvs_settings_1_1___get_wrapper.html#80ae992797a306309f835d904c520c28">00288</a>       self.<a class="code" href="../../d7/da2/classgyp_1_1msvs__emulation_1_1_msvs_settings_1_1___get_wrapper.html#80ae992797a306309f835d904c520c28">base_path</a> = [base_path]
<a name="l00289"></a><a class="code" href="../../d7/da2/classgyp_1_1msvs__emulation_1_1_msvs_settings_1_1___get_wrapper.html#c0abf82fd1523e3592ce5c160b2f806d">00289</a>       self.<a class="code" href="../../d7/da2/classgyp_1_1msvs__emulation_1_1_msvs_settings_1_1___get_wrapper.html#c0abf82fd1523e3592ce5c160b2f806d">append</a> = append
<a name="l00290"></a><a class="code" href="../../d7/da2/classgyp_1_1msvs__emulation_1_1_msvs_settings_1_1___get_wrapper.html#e844e0019d38360a86bac1474132db3c">00290</a>     <span class="keyword">def </span><a class="code" href="../../d7/da2/classgyp_1_1msvs__emulation_1_1_msvs_settings_1_1___get_wrapper.html#e844e0019d38360a86bac1474132db3c">__call__</a>(self, name, map=None, prefix='', default=None):
<a name="l00291"></a>00291       <span class="keywordflow">return</span> self.<a class="code" href="../../d7/da2/classgyp_1_1msvs__emulation_1_1_msvs_settings_1_1___get_wrapper.html#457d913bff1ebc8671c1eca1c9d5fc03">parent</a>._GetAndMunge(self.<a class="code" href="../../d7/da2/classgyp_1_1msvs__emulation_1_1_msvs_settings_1_1___get_wrapper.html#d62af17df5486963eef933792624216d">field</a>, self.<a class="code" href="../../d7/da2/classgyp_1_1msvs__emulation_1_1_msvs_settings_1_1___get_wrapper.html#80ae992797a306309f835d904c520c28">base_path</a> + [name],
<a name="l00292"></a>00292           default=default, prefix=prefix, append=self.<a class="code" href="../../d7/da2/classgyp_1_1msvs__emulation_1_1_msvs_settings_1_1___get_wrapper.html#c0abf82fd1523e3592ce5c160b2f806d">append</a>, map=map)
<a name="l00293"></a>00293 
<a name="l00294"></a><a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#727eacd31a0e10c816473ff9eaeb82ec">00294</a>   <span class="keyword">def </span><a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#727eacd31a0e10c816473ff9eaeb82ec">GetArch</a>(self, config):
<a name="l00295"></a>00295     <span class="stringliteral">"""Get architecture based on msvs_configuration_platform and</span>
<a name="l00296"></a>00296 <span class="stringliteral">    msvs_target_platform. Returns either 'x86' or 'x64'."""</span>
<a name="l00297"></a>00297     configuration_platform = self.msvs_configuration_platform.get(config, <span class="stringliteral">''</span>)
<a name="l00298"></a>00298     platform = self.msvs_target_platform.get(config, <span class="stringliteral">''</span>)
<a name="l00299"></a>00299     <span class="keywordflow">if</span> <span class="keywordflow">not</span> platform: <span class="comment"># If no specific override, use the configuration's.</span>
<a name="l00300"></a>00300       platform = configuration_platform
<a name="l00301"></a>00301     <span class="comment"># Map from platform to architecture.</span>
<a name="l00302"></a>00302     <span class="keywordflow">return</span> {<span class="stringliteral">'Win32'</span>: <span class="stringliteral">'x86'</span>, <span class="stringliteral">'x64'</span>: <span class="stringliteral">'x64'</span>}.get(platform, <span class="stringliteral">'x86'</span>)
<a name="l00303"></a>00303 
<a name="l00304"></a>00304   <span class="keyword">def </span>_TargetConfig(self, config):
<a name="l00305"></a>00305     <span class="stringliteral">"""Returns the target-specific configuration."""</span>
<a name="l00306"></a>00306     <span class="comment"># There's two levels of architecture/platform specification in VS. The</span>
<a name="l00307"></a>00307     <span class="comment"># first level is globally for the configuration (this is what we consider</span>
<a name="l00308"></a>00308     <span class="comment"># "the" config at the gyp level, which will be something like 'Debug' or</span>
<a name="l00309"></a>00309     <span class="comment"># 'Release_x64'), and a second target-specific configuration, which is an</span>
<a name="l00310"></a>00310     <span class="comment"># override for the global one. |config| is remapped here to take into</span>
<a name="l00311"></a>00311     <span class="comment"># account the local target-specific overrides to the global configuration.</span>
<a name="l00312"></a>00312     arch = self.<a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#727eacd31a0e10c816473ff9eaeb82ec">GetArch</a>(config)
<a name="l00313"></a>00313     <span class="keywordflow">if</span> arch == <span class="stringliteral">'x64'</span> <span class="keywordflow">and</span> <span class="keywordflow">not</span> config.endswith(<span class="stringliteral">'_x64'</span>):
<a name="l00314"></a>00314       config += <span class="stringliteral">'_x64'</span>
<a name="l00315"></a>00315     <span class="keywordflow">if</span> arch == <span class="stringliteral">'x86'</span> <span class="keywordflow">and</span> config.endswith(<span class="stringliteral">'_x64'</span>):
<a name="l00316"></a>00316       config = config.rsplit(<span class="stringliteral">'_'</span>, 1)[0]
<a name="l00317"></a>00317     <span class="keywordflow">return</span> config
<a name="l00318"></a>00318 
<a name="l00319"></a>00319   <span class="keyword">def </span>_Setting(self, path, config,
<a name="l00320"></a>00320               default=<span class="keywordtype">None</span>, prefix=<span class="stringliteral">''</span>, append=<span class="keywordtype">None</span>, map=<span class="keywordtype">None</span>):
<a name="l00321"></a>00321     <span class="stringliteral">"""_GetAndMunge for msvs_settings."""</span>
<a name="l00322"></a>00322     <span class="keywordflow">return</span> self.<a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#038c3ba15e25488129c3edee0b697942">_GetAndMunge</a>(
<a name="l00323"></a>00323         self.msvs_settings[config], path, default, prefix, append, map)
<a name="l00324"></a>00324 
<a name="l00325"></a>00325   <span class="keyword">def </span>_ConfigAttrib(self, path, config,
<a name="l00326"></a>00326                    default=<span class="keywordtype">None</span>, prefix=<span class="stringliteral">''</span>, append=<span class="keywordtype">None</span>, map=<span class="keywordtype">None</span>):
<a name="l00327"></a>00327     <span class="stringliteral">"""_GetAndMunge for msvs_configuration_attributes."""</span>
<a name="l00328"></a>00328     <span class="keywordflow">return</span> self.<a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#038c3ba15e25488129c3edee0b697942">_GetAndMunge</a>(
<a name="l00329"></a>00329         self.msvs_configuration_attributes[config],
<a name="l00330"></a>00330         path, default, prefix, append, map)
<a name="l00331"></a>00331 
<a name="l00332"></a>00332   <span class="keyword">def </span>AdjustIncludeDirs(self, include_dirs, config):
<a name="l00333"></a>00333     <span class="stringliteral">"""Updates include_dirs to expand VS specific paths, and adds the system</span>
<a name="l00334"></a>00334 <span class="stringliteral">    include dirs used for platform SDK and similar."""</span>
<a name="l00335"></a>00335     config = self._TargetConfig(config)
<a name="l00336"></a>00336     includes = include_dirs + self.msvs_system_include_dirs[config]
<a name="l00337"></a>00337     includes.extend(self._Setting(
<a name="l00338"></a>00338       (<span class="stringliteral">'VCCLCompilerTool'</span>, <span class="stringliteral">'AdditionalIncludeDirectories'</span>), config, default=[]))
<a name="l00339"></a>00339     <span class="keywordflow">return</span> [self.<a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#ebdaa9196d84bbc3c2ac3021874ba626">ConvertVSMacros</a>(p, config=config) <span class="keywordflow">for</span> p <span class="keywordflow">in</span> includes]
<a name="l00340"></a>00340 
<a name="l00341"></a>00341   <span class="keyword">def </span>AdjustMidlIncludeDirs(self, midl_include_dirs, config):
<a name="l00342"></a>00342     <span class="stringliteral">"""Updates midl_include_dirs to expand VS specific paths, and adds the</span>
<a name="l00343"></a>00343 <span class="stringliteral">    system include dirs used for platform SDK and similar."""</span>
<a name="l00344"></a>00344     config = self._TargetConfig(config)
<a name="l00345"></a>00345     includes = midl_include_dirs + self.msvs_system_include_dirs[config]
<a name="l00346"></a>00346     includes.extend(self._Setting(
<a name="l00347"></a>00347       (<span class="stringliteral">'VCMIDLTool'</span>, <span class="stringliteral">'AdditionalIncludeDirectories'</span>), config, default=[]))
<a name="l00348"></a>00348     <span class="keywordflow">return</span> [self.<a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#ebdaa9196d84bbc3c2ac3021874ba626">ConvertVSMacros</a>(p, config=config) <span class="keywordflow">for</span> p <span class="keywordflow">in</span> includes]
<a name="l00349"></a>00349 
<a name="l00350"></a>00350   <span class="keyword">def </span>GetComputedDefines(self, config):
<a name="l00351"></a>00351     <span class="stringliteral">"""Returns the set of defines that are injected to the defines list based</span>
<a name="l00352"></a>00352 <span class="stringliteral">    on other VS settings."""</span>
<a name="l00353"></a>00353     config = self._TargetConfig(config)
<a name="l00354"></a>00354     defines = []
<a name="l00355"></a>00355     <span class="keywordflow">if</span> self._ConfigAttrib([<span class="stringliteral">'CharacterSet'</span>], config) == <span class="stringliteral">'1'</span>:
<a name="l00356"></a>00356       defines.extend((<span class="stringliteral">'_UNICODE'</span>, <span class="stringliteral">'UNICODE'</span>))
<a name="l00357"></a>00357     <span class="keywordflow">if</span> self._ConfigAttrib([<span class="stringliteral">'CharacterSet'</span>], config) == <span class="stringliteral">'2'</span>:
<a name="l00358"></a>00358       defines.append(<span class="stringliteral">'_MBCS'</span>)
<a name="l00359"></a>00359     defines.extend(self._Setting(
<a name="l00360"></a>00360         (<span class="stringliteral">'VCCLCompilerTool'</span>, <span class="stringliteral">'PreprocessorDefinitions'</span>), config, default=[]))
<a name="l00361"></a>00361     <span class="keywordflow">return</span> defines
<a name="l00362"></a>00362 
<a name="l00363"></a>00363   <span class="keyword">def </span>GetCompilerPdbName(self, config, expand_special):
<a name="l00364"></a>00364     <span class="stringliteral">"""Get the pdb file name that should be used for compiler invocations, or</span>
<a name="l00365"></a>00365 <span class="stringliteral">    None if there's no explicit name specified."""</span>
<a name="l00366"></a>00366     config = self._TargetConfig(config)
<a name="l00367"></a>00367     pdbname = self._Setting(
<a name="l00368"></a>00368         (<span class="stringliteral">'VCCLCompilerTool'</span>, <span class="stringliteral">'ProgramDataBaseFileName'</span>), config)
<a name="l00369"></a>00369     <span class="keywordflow">if</span> pdbname:
<a name="l00370"></a>00370       pdbname = expand_special(self.<a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#ebdaa9196d84bbc3c2ac3021874ba626">ConvertVSMacros</a>(pdbname))
<a name="l00371"></a>00371     <span class="keywordflow">return</span> pdbname
<a name="l00372"></a>00372 
<a name="l00373"></a>00373   <span class="keyword">def </span>GetMapFileName(self, config, expand_special):
<a name="l00374"></a>00374     <span class="stringliteral">"""Gets the explicitly overriden map file name for a target or returns None</span>
<a name="l00375"></a>00375 <span class="stringliteral">    if it's not set."""</span>
<a name="l00376"></a>00376     config = self._TargetConfig(config)
<a name="l00377"></a>00377     map_file = self._Setting((<span class="stringliteral">'VCLinkerTool'</span>, <span class="stringliteral">'MapFileName'</span>), config)
<a name="l00378"></a>00378     <span class="keywordflow">if</span> map_file:
<a name="l00379"></a>00379       map_file = expand_special(self.<a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#ebdaa9196d84bbc3c2ac3021874ba626">ConvertVSMacros</a>(map_file, config=config))
<a name="l00380"></a>00380     <span class="keywordflow">return</span> map_file
<a name="l00381"></a>00381 
<a name="l00382"></a>00382   <span class="keyword">def </span>GetOutputName(self, config, expand_special):
<a name="l00383"></a>00383     <span class="stringliteral">"""Gets the explicitly overridden output name for a target or returns None</span>
<a name="l00384"></a>00384 <span class="stringliteral">    if it's not overridden."""</span>
<a name="l00385"></a>00385     config = self._TargetConfig(config)
<a name="l00386"></a>00386     type = self.<a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#daf1b66faf18504ec4b5c8c0b7f6763b">spec</a>[<span class="stringliteral">'type'</span>]
<a name="l00387"></a>00387     root = <span class="stringliteral">'VCLibrarianTool'</span> <span class="keywordflow">if</span> type == <span class="stringliteral">'static_library'</span> <span class="keywordflow">else</span> <span class="stringliteral">'VCLinkerTool'</span>
<a name="l00388"></a>00388     <span class="comment"># TODO(scottmg): Handle OutputDirectory without OutputFile.</span>
<a name="l00389"></a>00389     output_file = self._Setting((root, <span class="stringliteral">'OutputFile'</span>), config)
<a name="l00390"></a>00390     <span class="keywordflow">if</span> output_file:
<a name="l00391"></a>00391       output_file = expand_special(self.<a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#ebdaa9196d84bbc3c2ac3021874ba626">ConvertVSMacros</a>(
<a name="l00392"></a>00392           output_file, config=config))
<a name="l00393"></a>00393     <span class="keywordflow">return</span> output_file
<a name="l00394"></a>00394 
<a name="l00395"></a>00395   <span class="keyword">def </span>GetPDBName(self, config, expand_special, default):
<a name="l00396"></a>00396     <span class="stringliteral">"""Gets the explicitly overridden pdb name for a target or returns</span>
<a name="l00397"></a>00397 <span class="stringliteral">    default if it's not overridden, or if no pdb will be generated."""</span>
<a name="l00398"></a>00398     config = self._TargetConfig(config)
<a name="l00399"></a>00399     output_file = self._Setting((<span class="stringliteral">'VCLinkerTool'</span>, <span class="stringliteral">'ProgramDatabaseFile'</span>), config)
<a name="l00400"></a>00400     generate_debug_info = self._Setting(
<a name="l00401"></a>00401         (<span class="stringliteral">'VCLinkerTool'</span>, <span class="stringliteral">'GenerateDebugInformation'</span>), config)
<a name="l00402"></a>00402     <span class="keywordflow">if</span> generate_debug_info == <span class="stringliteral">'true'</span>:
<a name="l00403"></a>00403       <span class="keywordflow">if</span> output_file:
<a name="l00404"></a>00404         <span class="keywordflow">return</span> expand_special(self.<a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#ebdaa9196d84bbc3c2ac3021874ba626">ConvertVSMacros</a>(output_file, config=config))
<a name="l00405"></a>00405       <span class="keywordflow">else</span>:
<a name="l00406"></a>00406         <span class="keywordflow">return</span> default
<a name="l00407"></a>00407     <span class="keywordflow">else</span>:
<a name="l00408"></a>00408       <span class="keywordflow">return</span> <span class="keywordtype">None</span>
<a name="l00409"></a>00409 
<a name="l00410"></a>00410   <span class="keyword">def </span>GetNoImportLibrary(self, config):
<a name="l00411"></a>00411     <span class="stringliteral">"""If NoImportLibrary: true, ninja will not expect the output to include</span>
<a name="l00412"></a>00412 <span class="stringliteral">    an import library."""</span>
<a name="l00413"></a>00413     config = self._TargetConfig(config)
<a name="l00414"></a>00414     noimplib = self._Setting((<span class="stringliteral">'NoImportLibrary'</span>,), config)
<a name="l00415"></a>00415     <span class="keywordflow">return</span> noimplib == <span class="stringliteral">'true'</span>
<a name="l00416"></a>00416 
<a name="l00417"></a>00417   <span class="keyword">def </span>GetAsmflags(self, config):
<a name="l00418"></a>00418     <span class="stringliteral">"""Returns the flags that need to be added to ml invocations."""</span>
<a name="l00419"></a>00419     config = self._TargetConfig(config)
<a name="l00420"></a>00420     asmflags = []
<a name="l00421"></a>00421     safeseh = self._Setting((<span class="stringliteral">'MASM'</span>, <span class="stringliteral">'UseSafeExceptionHandlers'</span>), config)
<a name="l00422"></a>00422     <span class="keywordflow">if</span> safeseh == <span class="stringliteral">'true'</span>:
<a name="l00423"></a>00423       asmflags.append(<span class="stringliteral">'/safeseh'</span>)
<a name="l00424"></a>00424     <span class="keywordflow">return</span> asmflags
<a name="l00425"></a>00425 
<a name="l00426"></a>00426   <span class="keyword">def </span>GetCflags(self, config):
<a name="l00427"></a>00427     <span class="stringliteral">"""Returns the flags that need to be added to .c and .cc compilations."""</span>
<a name="l00428"></a>00428     config = self._TargetConfig(config)
<a name="l00429"></a>00429     cflags = []
<a name="l00430"></a>00430     cflags.extend([<span class="stringliteral">'/wd'</span> + w <span class="keywordflow">for</span> w <span class="keywordflow">in</span> self.msvs_disabled_warnings[config]])
<a name="l00431"></a>00431     cl = self.<a class="code" href="../../d7/da2/classgyp_1_1msvs__emulation_1_1_msvs_settings_1_1___get_wrapper.html">_GetWrapper</a>(self, self.msvs_settings[config],
<a name="l00432"></a>00432                           <span class="stringliteral">'VCCLCompilerTool'</span>, append=cflags)
<a name="l00433"></a>00433     cl(<span class="stringliteral">'Optimization'</span>,
<a name="l00434"></a>00434        map={<span class="stringliteral">'0'</span>: <span class="stringliteral">'d'</span>, <span class="stringliteral">'1'</span>: <span class="stringliteral">'1'</span>, <span class="stringliteral">'2'</span>: <span class="stringliteral">'2'</span>, <span class="stringliteral">'3'</span>: <span class="stringliteral">'x'</span>}, prefix=<span class="stringliteral">'/O'</span>, default=<span class="stringliteral">'2'</span>)
<a name="l00435"></a>00435     cl(<span class="stringliteral">'InlineFunctionExpansion'</span>, prefix=<span class="stringliteral">'/Ob'</span>)
<a name="l00436"></a>00436     cl(<span class="stringliteral">'DisableSpecificWarnings'</span>, prefix=<span class="stringliteral">'/wd'</span>)
<a name="l00437"></a>00437     cl(<span class="stringliteral">'StringPooling'</span>, map={<span class="stringliteral">'true'</span>: <span class="stringliteral">'/GF'</span>})
<a name="l00438"></a>00438     cl(<span class="stringliteral">'EnableFiberSafeOptimizations'</span>, map={<span class="stringliteral">'true'</span>: <span class="stringliteral">'/GT'</span>})
<a name="l00439"></a>00439     cl(<span class="stringliteral">'OmitFramePointers'</span>, map={<span class="stringliteral">'false'</span>: <span class="stringliteral">'-'</span>, <span class="stringliteral">'true'</span>: <span class="stringliteral">''</span>}, prefix=<span class="stringliteral">'/Oy'</span>)
<a name="l00440"></a>00440     cl(<span class="stringliteral">'EnableIntrinsicFunctions'</span>, map={<span class="stringliteral">'false'</span>: <span class="stringliteral">'-'</span>, <span class="stringliteral">'true'</span>: <span class="stringliteral">''</span>}, prefix=<span class="stringliteral">'/Oi'</span>)
<a name="l00441"></a>00441     cl(<span class="stringliteral">'FavorSizeOrSpeed'</span>, map={<span class="stringliteral">'1'</span>: <span class="stringliteral">'t'</span>, <span class="stringliteral">'2'</span>: <span class="stringliteral">'s'</span>}, prefix=<span class="stringliteral">'/O'</span>)
<a name="l00442"></a>00442     cl(<span class="stringliteral">'FloatingPointModel'</span>,
<a name="l00443"></a>00443         map={<span class="stringliteral">'0'</span>: <span class="stringliteral">'precise'</span>, <span class="stringliteral">'1'</span>: <span class="stringliteral">'strict'</span>, <span class="stringliteral">'2'</span>: <span class="stringliteral">'fast'</span>}, prefix=<span class="stringliteral">'/fp:'</span>,
<a name="l00444"></a>00444         default=<span class="stringliteral">'0'</span>)
<a name="l00445"></a>00445     cl(<span class="stringliteral">'WholeProgramOptimization'</span>, map={<span class="stringliteral">'true'</span>: <span class="stringliteral">'/GL'</span>})
<a name="l00446"></a>00446     cl(<span class="stringliteral">'WarningLevel'</span>, prefix=<span class="stringliteral">'/W'</span>)
<a name="l00447"></a>00447     cl(<span class="stringliteral">'WarnAsError'</span>, map={<span class="stringliteral">'true'</span>: <span class="stringliteral">'/WX'</span>})
<a name="l00448"></a>00448     cl(<span class="stringliteral">'CallingConvention'</span>,
<a name="l00449"></a>00449         map={<span class="stringliteral">'0'</span>: <span class="stringliteral">'d'</span>, <span class="stringliteral">'1'</span>: <span class="stringliteral">'</span><span class="stringliteral">r', '</span>2': 'z', '3': 'v'}, prefix='/G')
<a name="l00450"></a>00450     cl(<span class="stringliteral">'DebugInformationFormat'</span>,
<a name="l00451"></a>00451         map={<span class="stringliteral">'1'</span>: <span class="stringliteral">'7'</span>, <span class="stringliteral">'3'</span>: <span class="stringliteral">'i'</span>, <span class="stringliteral">'4'</span>: <span class="stringliteral">'I'</span>}, prefix=<span class="stringliteral">'/Z'</span>)
<a name="l00452"></a>00452     cl(<span class="stringliteral">'RuntimeTypeInfo'</span>, map={<span class="stringliteral">'true'</span>: <span class="stringliteral">'/GR'</span>, <span class="stringliteral">'false'</span>: <span class="stringliteral">'/GR-'</span>})
<a name="l00453"></a>00453     cl(<span class="stringliteral">'EnableFunctionLevelLinking'</span>, map={<span class="stringliteral">'true'</span>: <span class="stringliteral">'/Gy'</span>, <span class="stringliteral">'false'</span>: <span class="stringliteral">'/Gy-'</span>})
<a name="l00454"></a>00454     cl(<span class="stringliteral">'MinimalRebuild'</span>, map={<span class="stringliteral">'true'</span>: <span class="stringliteral">'/Gm'</span>})
<a name="l00455"></a>00455     cl(<span class="stringliteral">'BufferSecurityCheck'</span>, map={<span class="stringliteral">'true'</span>: <span class="stringliteral">'/GS'</span>, <span class="stringliteral">'false'</span>: <span class="stringliteral">'/GS-'</span>})
<a name="l00456"></a>00456     cl(<span class="stringliteral">'BasicRuntimeChecks'</span>, map={<span class="stringliteral">'1'</span>: <span class="stringliteral">'s'</span>, <span class="stringliteral">'2'</span>: <span class="stringliteral">'</span><span class="stringliteral">u', '</span>3': '1'}, prefix='/RTC')
<a name="l00457"></a>00457     cl(<span class="stringliteral">'RuntimeLibrary'</span>,
<a name="l00458"></a>00458         map={<span class="stringliteral">'0'</span>: <span class="stringliteral">'T'</span>, <span class="stringliteral">'1'</span>: <span class="stringliteral">'Td'</span>, <span class="stringliteral">'2'</span>: <span class="stringliteral">'D'</span>, <span class="stringliteral">'3'</span>: <span class="stringliteral">'Dd'</span>}, prefix=<span class="stringliteral">'/M'</span>)
<a name="l00459"></a>00459     cl(<span class="stringliteral">'ExceptionHandling'</span>, map={<span class="stringliteral">'1'</span>: <span class="stringliteral">'sc'</span>,<span class="stringliteral">'2'</span>: <span class="stringliteral">'a'</span>}, prefix=<span class="stringliteral">'/EH'</span>)
<a name="l00460"></a>00460     cl(<span class="stringliteral">'DefaultCharIsUnsigned'</span>, map={<span class="stringliteral">'true'</span>: <span class="stringliteral">'/J'</span>})
<a name="l00461"></a>00461     cl(<span class="stringliteral">'TreatWChar_tAsBuiltInType'</span>,
<a name="l00462"></a>00462         map={<span class="stringliteral">'false'</span>: <span class="stringliteral">'-'</span>, <span class="stringliteral">'true'</span>: <span class="stringliteral">''</span>}, prefix=<span class="stringliteral">'/Zc:wchar_t'</span>)
<a name="l00463"></a>00463     cl(<span class="stringliteral">'EnablePREfast'</span>, map={<span class="stringliteral">'true'</span>: <span class="stringliteral">'/analyze'</span>})
<a name="l00464"></a>00464     cl(<span class="stringliteral">'AdditionalOptions'</span>, prefix=<span class="stringliteral">''</span>)
<a name="l00465"></a>00465     cl(<span class="stringliteral">'EnableEnhancedInstructionSet'</span>,
<a name="l00466"></a>00466         map={<span class="stringliteral">'1'</span>: <span class="stringliteral">'SSE'</span>, <span class="stringliteral">'2'</span>: <span class="stringliteral">'SSE2'</span>, <span class="stringliteral">'3'</span>: <span class="stringliteral">'AVX'</span>, <span class="stringliteral">'4'</span>: <span class="stringliteral">'IA32'</span>, <span class="stringliteral">'5'</span>: <span class="stringliteral">'AVX2'</span>},
<a name="l00467"></a>00467         prefix=<span class="stringliteral">'/arch:'</span>)
<a name="l00468"></a>00468     cflags.extend([<span class="stringliteral">'/FI'</span> + f <span class="keywordflow">for</span> f <span class="keywordflow">in</span> self._Setting(
<a name="l00469"></a>00469         (<span class="stringliteral">'VCCLCompilerTool'</span>, <span class="stringliteral">'ForcedIncludeFiles'</span>), config, default=[])])
<a name="l00470"></a>00470     <span class="keywordflow">if</span> self.<a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#365c5b6a02f70877282b2b7dbf443b0a">vs_version</a>.short_name <span class="keywordflow">in</span> (<span class="stringliteral">'2013'</span>, <span class="stringliteral">'2013e'</span>, <span class="stringliteral">'2015'</span>):
<a name="l00471"></a>00471       <span class="comment"># New flag required in 2013 to maintain previous PDB behavior.</span>
<a name="l00472"></a>00472       cflags.append(<span class="stringliteral">'/FS'</span>)
<a name="l00473"></a>00473     <span class="comment"># ninja handles parallelism by itself, don't have the compiler do it too.</span>
<a name="l00474"></a>00474     cflags = filter(<span class="keyword">lambda</span> x: <span class="keywordflow">not</span> x.startswith(<span class="stringliteral">'/MP'</span>), cflags)
<a name="l00475"></a>00475     <span class="keywordflow">return</span> cflags
<a name="l00476"></a>00476 
<a name="l00477"></a>00477   <span class="keyword">def </span>_GetPchFlags(self, config, extension):
<a name="l00478"></a>00478     <span class="stringliteral">"""Get the flags to be added to the cflags for precompiled header support.</span>
<a name="l00479"></a>00479 <span class="stringliteral">    """</span>
<a name="l00480"></a>00480     config = self._TargetConfig(config)
<a name="l00481"></a>00481     <span class="comment"># The PCH is only built once by a particular source file. Usage of PCH must</span>
<a name="l00482"></a>00482     <span class="comment"># only be for the same language (i.e. C vs. C++), so only include the pch</span>
<a name="l00483"></a>00483     <span class="comment"># flags when the language matches.</span>
<a name="l00484"></a>00484     <span class="keywordflow">if</span> self.msvs_precompiled_header[config]:
<a name="l00485"></a>00485       source_ext = os.path.splitext(self.msvs_precompiled_source[config])[1]
<a name="l00486"></a>00486       <span class="keywordflow">if</span> _LanguageMatchesForPch(source_ext, extension):
<a name="l00487"></a>00487         pch = os.path.split(self.msvs_precompiled_header[config])[1]
<a name="l00488"></a>00488         <span class="keywordflow">return</span> [<span class="stringliteral">'/Yu'</span> + pch, <span class="stringliteral">'/FI'</span> + pch, <span class="stringliteral">'/Fp${pchprefix}.'</span> + pch + <span class="stringliteral">'.pch'</span>]
<a name="l00489"></a>00489     <span class="keywordflow">return</span>  []
<a name="l00490"></a>00490 
<a name="l00491"></a>00491   <span class="keyword">def </span>GetCflagsC(self, config):
<a name="l00492"></a>00492     <span class="stringliteral">"""Returns the flags that need to be added to .c compilations."""</span>
<a name="l00493"></a>00493     config = self._TargetConfig(config)
<a name="l00494"></a>00494     <span class="keywordflow">return</span> self._GetPchFlags(config, <span class="stringliteral">'.c'</span>)
<a name="l00495"></a>00495 
<a name="l00496"></a>00496   <span class="keyword">def </span>GetCflagsCC(self, config):
<a name="l00497"></a>00497     <span class="stringliteral">"""Returns the flags that need to be added to .cc compilations."""</span>
<a name="l00498"></a>00498     config = self._TargetConfig(config)
<a name="l00499"></a>00499     <span class="keywordflow">return</span> [<span class="stringliteral">'/TP'</span>] + self._GetPchFlags(config, <span class="stringliteral">'.cc'</span>)
<a name="l00500"></a>00500 
<a name="l00501"></a>00501   <span class="keyword">def </span>_GetAdditionalLibraryDirectories(self, root, config, gyp_to_build_path):
<a name="l00502"></a>00502     <span class="stringliteral">"""Get and normalize the list of paths in AdditionalLibraryDirectories</span>
<a name="l00503"></a>00503 <span class="stringliteral">    setting."""</span>
<a name="l00504"></a>00504     config = self._TargetConfig(config)
<a name="l00505"></a>00505     libpaths = self._Setting((root, <span class="stringliteral">'AdditionalLibraryDirectories'</span>),
<a name="l00506"></a>00506                              config, default=[])
<a name="l00507"></a>00507     libpaths = [os.path.normpath(
<a name="l00508"></a>00508                     gyp_to_build_path(self.<a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#ebdaa9196d84bbc3c2ac3021874ba626">ConvertVSMacros</a>(p, config=config)))
<a name="l00509"></a>00509                 <span class="keywordflow">for</span> p <span class="keywordflow">in</span> libpaths]
<a name="l00510"></a>00510     <span class="keywordflow">return</span> [<span class="stringliteral">'/LIBPATH:"'</span> + p + <span class="stringliteral">'"'</span> <span class="keywordflow">for</span> p <span class="keywordflow">in</span> libpaths]
<a name="l00511"></a>00511 
<a name="l00512"></a>00512   <span class="keyword">def </span>GetLibFlags(self, config, gyp_to_build_path):
<a name="l00513"></a>00513     <span class="stringliteral">"""Returns the flags that need to be added to lib commands."""</span>
<a name="l00514"></a>00514     config = self._TargetConfig(config)
<a name="l00515"></a>00515     libflags = []
<a name="l00516"></a>00516     lib = self.<a class="code" href="../../d7/da2/classgyp_1_1msvs__emulation_1_1_msvs_settings_1_1___get_wrapper.html">_GetWrapper</a>(self, self.msvs_settings[config],
<a name="l00517"></a>00517                           <span class="stringliteral">'VCLibrarianTool'</span>, append=libflags)
<a name="l00518"></a>00518     libflags.extend(self._GetAdditionalLibraryDirectories(
<a name="l00519"></a>00519         <span class="stringliteral">'VCLibrarianTool'</span>, config, gyp_to_build_path))
<a name="l00520"></a>00520     lib(<span class="stringliteral">'LinkTimeCodeGeneration'</span>, map={<span class="stringliteral">'true'</span>: <span class="stringliteral">'/LTCG'</span>})
<a name="l00521"></a>00521     lib(<span class="stringliteral">'TargetMachine'</span>, map={<span class="stringliteral">'1'</span>: <span class="stringliteral">'X86'</span>, <span class="stringliteral">'17'</span>: <span class="stringliteral">'X64'</span>, <span class="stringliteral">'3'</span>: <span class="stringliteral">'ARM'</span>},
<a name="l00522"></a>00522         prefix=<span class="stringliteral">'/MACHINE:'</span>)
<a name="l00523"></a>00523     lib(<span class="stringliteral">'AdditionalOptions'</span>)
<a name="l00524"></a>00524     <span class="keywordflow">return</span> libflags
<a name="l00525"></a>00525 
<a name="l00526"></a>00526   <span class="keyword">def </span>GetDefFile(self, gyp_to_build_path):
<a name="l00527"></a>00527     <span class="stringliteral">"""Returns the .def file from sources, if any.  Otherwise returns None."""</span>
<a name="l00528"></a>00528     spec = self.<a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#daf1b66faf18504ec4b5c8c0b7f6763b">spec</a>
<a name="l00529"></a>00529     <span class="keywordflow">if</span> spec[<span class="stringliteral">'type'</span>] <span class="keywordflow">in</span> (<span class="stringliteral">'shared_library'</span>, <span class="stringliteral">'loadable_module'</span>, <span class="stringliteral">'executable'</span>):
<a name="l00530"></a>00530       def_files = [s <span class="keywordflow">for</span> s <span class="keywordflow">in</span> spec.get(<span class="stringliteral">'sources'</span>, []) <span class="keywordflow">if</span> s.endswith(<span class="stringliteral">'.def'</span>)]
<a name="l00531"></a>00531       <span class="keywordflow">if</span> len(def_files) == 1:
<a name="l00532"></a>00532         <span class="keywordflow">return</span> gyp_to_build_path(def_files[0])
<a name="l00533"></a>00533       <span class="keywordflow">elif</span> len(def_files) &gt; 1:
<a name="l00534"></a>00534         <span class="keywordflow">raise</span> Exception(<span class="stringliteral">"Multiple .def files"</span>)
<a name="l00535"></a>00535     <span class="keywordflow">return</span> <span class="keywordtype">None</span>
<a name="l00536"></a>00536 
<a name="l00537"></a>00537   <span class="keyword">def </span>_GetDefFileAsLdflags(self, ldflags, gyp_to_build_path):
<a name="l00538"></a>00538     <span class="stringliteral">""".def files get implicitly converted to a ModuleDefinitionFile for the</span>
<a name="l00539"></a>00539 <span class="stringliteral">    linker in the VS generator. Emulate that behaviour here."""</span>
<a name="l00540"></a>00540     def_file = self.GetDefFile(gyp_to_build_path)
<a name="l00541"></a>00541     <span class="keywordflow">if</span> def_file:
<a name="l00542"></a>00542       ldflags.append(<span class="stringliteral">'/DEF:"%s"'</span> % def_file)
<a name="l00543"></a>00543 
<a name="l00544"></a>00544   <span class="keyword">def </span>GetPGDName(self, config, expand_special):
<a name="l00545"></a>00545     <span class="stringliteral">"""Gets the explicitly overridden pgd name for a target or returns None</span>
<a name="l00546"></a>00546 <span class="stringliteral">    if it's not overridden."""</span>
<a name="l00547"></a>00547     config = self._TargetConfig(config)
<a name="l00548"></a>00548     output_file = self._Setting(
<a name="l00549"></a>00549         (<span class="stringliteral">'VCLinkerTool'</span>, <span class="stringliteral">'ProfileGuidedDatabase'</span>), config)
<a name="l00550"></a>00550     <span class="keywordflow">if</span> output_file:
<a name="l00551"></a>00551       output_file = expand_special(self.<a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#ebdaa9196d84bbc3c2ac3021874ba626">ConvertVSMacros</a>(
<a name="l00552"></a>00552           output_file, config=config))
<a name="l00553"></a>00553     <span class="keywordflow">return</span> output_file
<a name="l00554"></a>00554 
<a name="l00555"></a>00555   <span class="keyword">def </span>GetLdflags(self, config, gyp_to_build_path, expand_special,
<a name="l00556"></a>00556                  manifest_base_name, output_name, is_executable, build_dir):
<a name="l00557"></a>00557     <span class="stringliteral">"""Returns the flags that need to be added to link commands, and the</span>
<a name="l00558"></a>00558 <span class="stringliteral">    manifest files."""</span>
<a name="l00559"></a>00559     config = self._TargetConfig(config)
<a name="l00560"></a>00560     ldflags = []
<a name="l00561"></a>00561     ld = self.<a class="code" href="../../d7/da2/classgyp_1_1msvs__emulation_1_1_msvs_settings_1_1___get_wrapper.html">_GetWrapper</a>(self, self.msvs_settings[config],
<a name="l00562"></a>00562                           <span class="stringliteral">'VCLinkerTool'</span>, append=ldflags)
<a name="l00563"></a>00563     self._GetDefFileAsLdflags(ldflags, gyp_to_build_path)
<a name="l00564"></a>00564     ld(<span class="stringliteral">'GenerateDebugInformation'</span>, map={<span class="stringliteral">'true'</span>: <span class="stringliteral">'/DEBUG'</span>})
<a name="l00565"></a>00565     ld(<span class="stringliteral">'TargetMachine'</span>, map={<span class="stringliteral">'1'</span>: <span class="stringliteral">'X86'</span>, <span class="stringliteral">'17'</span>: <span class="stringliteral">'X64'</span>, <span class="stringliteral">'3'</span>: <span class="stringliteral">'ARM'</span>},
<a name="l00566"></a>00566        prefix=<span class="stringliteral">'/MACHINE:'</span>)
<a name="l00567"></a>00567     ldflags.extend(self._GetAdditionalLibraryDirectories(
<a name="l00568"></a>00568         <span class="stringliteral">'VCLinkerTool'</span>, config, gyp_to_build_path))
<a name="l00569"></a>00569     ld(<span class="stringliteral">'DelayLoadDLLs'</span>, prefix=<span class="stringliteral">'/DELAYLOAD:'</span>)
<a name="l00570"></a>00570     ld(<span class="stringliteral">'TreatLinkerWarningAsErrors'</span>, prefix=<span class="stringliteral">'/WX'</span>,
<a name="l00571"></a>00571        map={<span class="stringliteral">'true'</span>: <span class="stringliteral">''</span>, <span class="stringliteral">'false'</span>: <span class="stringliteral">':NO'</span>})
<a name="l00572"></a>00572     out = self.GetOutputName(config, expand_special)
<a name="l00573"></a>00573     <span class="keywordflow">if</span> out:
<a name="l00574"></a>00574       ldflags.append(<span class="stringliteral">'/OUT:'</span> + out)
<a name="l00575"></a>00575     pdb = self.GetPDBName(config, expand_special, output_name + <span class="stringliteral">'.pdb'</span>)
<a name="l00576"></a>00576     <span class="keywordflow">if</span> pdb:
<a name="l00577"></a>00577       ldflags.append(<span class="stringliteral">'/PDB:'</span> + pdb)
<a name="l00578"></a>00578     pgd = self.GetPGDName(config, expand_special)
<a name="l00579"></a>00579     <span class="keywordflow">if</span> pgd:
<a name="l00580"></a>00580       ldflags.append(<span class="stringliteral">'/PGD:'</span> + pgd)
<a name="l00581"></a>00581     map_file = self.GetMapFileName(config, expand_special)
<a name="l00582"></a>00582     ld(<span class="stringliteral">'GenerateMapFile'</span>, map={<span class="stringliteral">'true'</span>: <span class="stringliteral">'/MAP:'</span> + map_file <span class="keywordflow">if</span> map_file
<a name="l00583"></a>00583         <span class="keywordflow">else</span> <span class="stringliteral">'/MAP'</span>})
<a name="l00584"></a>00584     ld(<span class="stringliteral">'MapExports'</span>, map={<span class="stringliteral">'true'</span>: <span class="stringliteral">'/MAPINFO:EXPORTS'</span>})
<a name="l00585"></a>00585     ld(<span class="stringliteral">'AdditionalOptions'</span>, prefix=<span class="stringliteral">''</span>)
<a name="l00586"></a>00586 
<a name="l00587"></a>00587     minimum_required_version = self._Setting(
<a name="l00588"></a>00588         (<span class="stringliteral">'VCLinkerTool'</span>, <span class="stringliteral">'MinimumRequiredVersion'</span>), config, default=<span class="stringliteral">''</span>)
<a name="l00589"></a>00589     <span class="keywordflow">if</span> minimum_required_version:
<a name="l00590"></a>00590       minimum_required_version = <span class="stringliteral">','</span> + minimum_required_version
<a name="l00591"></a>00591     ld(<span class="stringliteral">'SubSystem'</span>,
<a name="l00592"></a>00592        map={<span class="stringliteral">'1'</span>: <span class="stringliteral">'CONSOLE%s'</span> % minimum_required_version,
<a name="l00593"></a>00593             <span class="stringliteral">'2'</span>: <span class="stringliteral">'WINDOWS%s'</span> % minimum_required_version},
<a name="l00594"></a>00594        prefix=<span class="stringliteral">'/SUBSYSTEM:'</span>)
<a name="l00595"></a>00595 
<a name="l00596"></a>00596     ld(<span class="stringliteral">'TerminalServerAware'</span>, map={<span class="stringliteral">'1'</span>: <span class="stringliteral">':NO'</span>, <span class="stringliteral">'2'</span>: <span class="stringliteral">''</span>}, prefix=<span class="stringliteral">'/TSAWARE'</span>)
<a name="l00597"></a>00597     ld(<span class="stringliteral">'LinkIncremental'</span>, map={<span class="stringliteral">'1'</span>: <span class="stringliteral">':NO'</span>, <span class="stringliteral">'2'</span>: <span class="stringliteral">''</span>}, prefix=<span class="stringliteral">'/INCREMENTAL'</span>)
<a name="l00598"></a>00598     ld(<span class="stringliteral">'BaseAddress'</span>, prefix=<span class="stringliteral">'/BASE:'</span>)
<a name="l00599"></a>00599     ld(<span class="stringliteral">'FixedBaseAddress'</span>, map={<span class="stringliteral">'1'</span>: <span class="stringliteral">':NO'</span>, <span class="stringliteral">'2'</span>: <span class="stringliteral">''</span>}, prefix=<span class="stringliteral">'/FIXED'</span>)
<a name="l00600"></a>00600     ld(<span class="stringliteral">'RandomizedBaseAddress'</span>,
<a name="l00601"></a>00601         map={<span class="stringliteral">'1'</span>: <span class="stringliteral">':NO'</span>, <span class="stringliteral">'2'</span>: <span class="stringliteral">''</span>}, prefix=<span class="stringliteral">'/DYNAMICBASE'</span>)
<a name="l00602"></a>00602     ld(<span class="stringliteral">'DataExecutionPrevention'</span>,
<a name="l00603"></a>00603         map={<span class="stringliteral">'1'</span>: <span class="stringliteral">':NO'</span>, <span class="stringliteral">'2'</span>: <span class="stringliteral">''</span>}, prefix=<span class="stringliteral">'/NXCOMPAT'</span>)
<a name="l00604"></a>00604     ld(<span class="stringliteral">'OptimizeReferences'</span>, map={<span class="stringliteral">'1'</span>: <span class="stringliteral">'NOREF'</span>, <span class="stringliteral">'2'</span>: <span class="stringliteral">'REF'</span>}, prefix=<span class="stringliteral">'/OPT:'</span>)
<a name="l00605"></a>00605     ld(<span class="stringliteral">'ForceSymbolReferences'</span>, prefix=<span class="stringliteral">'/INCLUDE:'</span>)
<a name="l00606"></a>00606     ld(<span class="stringliteral">'EnableCOMDATFolding'</span>, map={<span class="stringliteral">'1'</span>: <span class="stringliteral">'NOICF'</span>, <span class="stringliteral">'2'</span>: <span class="stringliteral">'ICF'</span>}, prefix=<span class="stringliteral">'/OPT:'</span>)
<a name="l00607"></a>00607     ld(<span class="stringliteral">'LinkTimeCodeGeneration'</span>,
<a name="l00608"></a>00608         map={<span class="stringliteral">'1'</span>: <span class="stringliteral">''</span>, <span class="stringliteral">'2'</span>: <span class="stringliteral">':PGINSTRUMENT'</span>, <span class="stringliteral">'3'</span>: <span class="stringliteral">':PGOPTIMIZE'</span>,
<a name="l00609"></a>00609              <span class="stringliteral">'4'</span>: <span class="stringliteral">':PGUPDATE'</span>},
<a name="l00610"></a>00610         prefix=<span class="stringliteral">'/LTCG'</span>)
<a name="l00611"></a>00611     ld(<span class="stringliteral">'IgnoreDefaultLibraryNames'</span>, prefix=<span class="stringliteral">'/NODEFAULTLIB:'</span>)
<a name="l00612"></a>00612     ld(<span class="stringliteral">'ResourceOnlyDLL'</span>, map={<span class="stringliteral">'true'</span>: <span class="stringliteral">'/NOENTRY'</span>})
<a name="l00613"></a>00613     ld(<span class="stringliteral">'EntryPointSymbol'</span>, prefix=<span class="stringliteral">'/ENTRY:'</span>)
<a name="l00614"></a>00614     ld(<span class="stringliteral">'Profile'</span>, map={<span class="stringliteral">'true'</span>: <span class="stringliteral">'/PROFILE'</span>})
<a name="l00615"></a>00615     ld(<span class="stringliteral">'LargeAddressAware'</span>,
<a name="l00616"></a>00616         map={<span class="stringliteral">'1'</span>: <span class="stringliteral">':NO'</span>, <span class="stringliteral">'2'</span>: <span class="stringliteral">''</span>}, prefix=<span class="stringliteral">'/LARGEADDRESSAWARE'</span>)
<a name="l00617"></a>00617     <span class="comment"># TODO(scottmg): This should sort of be somewhere else (not really a flag).</span>
<a name="l00618"></a>00618     ld(<span class="stringliteral">'AdditionalDependencies'</span>, prefix=<span class="stringliteral">''</span>)
<a name="l00619"></a>00619 
<a name="l00620"></a>00620     <span class="keywordflow">if</span> self.<a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#727eacd31a0e10c816473ff9eaeb82ec">GetArch</a>(config) == <span class="stringliteral">'x86'</span>:
<a name="l00621"></a>00621       safeseh_default = <span class="stringliteral">'true'</span>
<a name="l00622"></a>00622     <span class="keywordflow">else</span>:
<a name="l00623"></a>00623       safeseh_default = <span class="keywordtype">None</span>
<a name="l00624"></a>00624     ld(<span class="stringliteral">'ImageHasSafeExceptionHandlers'</span>,
<a name="l00625"></a>00625         map={<span class="stringliteral">'false'</span>: <span class="stringliteral">':NO'</span>, <span class="stringliteral">'true'</span>: <span class="stringliteral">''</span>}, prefix=<span class="stringliteral">'/SAFESEH'</span>,
<a name="l00626"></a>00626         default=safeseh_default)
<a name="l00627"></a>00627 
<a name="l00628"></a>00628     <span class="comment"># If the base address is not specifically controlled, DYNAMICBASE should</span>
<a name="l00629"></a>00629     <span class="comment"># be on by default.</span>
<a name="l00630"></a>00630     base_flags = filter(<span class="keyword">lambda</span> x: <span class="stringliteral">'DYNAMICBASE'</span> <span class="keywordflow">in</span> x <span class="keywordflow">or</span> x == <span class="stringliteral">'/FIXED'</span>,
<a name="l00631"></a>00631                         ldflags)
<a name="l00632"></a>00632     <span class="keywordflow">if</span> <span class="keywordflow">not</span> base_flags:
<a name="l00633"></a>00633       ldflags.append(<span class="stringliteral">'/DYNAMICBASE'</span>)
<a name="l00634"></a>00634 
<a name="l00635"></a>00635     <span class="comment"># If the NXCOMPAT flag has not been specified, default to on. Despite the</span>
<a name="l00636"></a>00636     <span class="comment"># documentation that says this only defaults to on when the subsystem is</span>
<a name="l00637"></a>00637     <span class="comment"># Vista or greater (which applies to the linker), the IDE defaults it on</span>
<a name="l00638"></a>00638     <span class="comment"># unless it's explicitly off.</span>
<a name="l00639"></a>00639     <span class="keywordflow">if</span> <span class="keywordflow">not</span> filter(<span class="keyword">lambda</span> x: <span class="stringliteral">'NXCOMPAT'</span> <span class="keywordflow">in</span> x, ldflags):
<a name="l00640"></a>00640       ldflags.append(<span class="stringliteral">'/NXCOMPAT'</span>)
<a name="l00641"></a>00641 
<a name="l00642"></a>00642     have_def_file = filter(<span class="keyword">lambda</span> x: x.startswith(<span class="stringliteral">'/DEF:'</span>), ldflags)
<a name="l00643"></a>00643     manifest_flags, intermediate_manifest, manifest_files = \
<a name="l00644"></a>00644         self._GetLdManifestFlags(config, manifest_base_name, gyp_to_build_path,
<a name="l00645"></a>00645                                  is_executable <span class="keywordflow">and</span> <span class="keywordflow">not</span> have_def_file, build_dir)
<a name="l00646"></a>00646     ldflags.extend(manifest_flags)
<a name="l00647"></a>00647     <span class="keywordflow">return</span> ldflags, intermediate_manifest, manifest_files
<a name="l00648"></a>00648 
<a name="l00649"></a>00649   <span class="keyword">def </span>_GetLdManifestFlags(self, config, name, gyp_to_build_path,
<a name="l00650"></a>00650                           allow_isolation, build_dir):
<a name="l00651"></a>00651     <span class="stringliteral">"""Returns a 3-tuple:</span>
<a name="l00652"></a>00652 <span class="stringliteral">    - the set of flags that need to be added to the link to generate</span>
<a name="l00653"></a>00653 <span class="stringliteral">      a default manifest</span>
<a name="l00654"></a>00654 <span class="stringliteral">    - the intermediate manifest that the linker will generate that should be</span>
<a name="l00655"></a>00655 <span class="stringliteral">      used to assert it doesn't add anything to the merged one.</span>
<a name="l00656"></a>00656 <span class="stringliteral">    - the list of all the manifest files to be merged by the manifest tool and</span>
<a name="l00657"></a>00657 <span class="stringliteral">      included into the link."""</span>
<a name="l00658"></a>00658     generate_manifest = self._Setting((<span class="stringliteral">'VCLinkerTool'</span>, <span class="stringliteral">'GenerateManifest'</span>),
<a name="l00659"></a>00659                                       config,
<a name="l00660"></a>00660                                       default=<span class="stringliteral">'true'</span>)
<a name="l00661"></a>00661     <span class="keywordflow">if</span> generate_manifest != <span class="stringliteral">'true'</span>:
<a name="l00662"></a>00662       <span class="comment"># This means not only that the linker should not generate the intermediate</span>
<a name="l00663"></a>00663       <span class="comment"># manifest but also that the manifest tool should do nothing even when</span>
<a name="l00664"></a>00664       <span class="comment"># additional manifests are specified.</span>
<a name="l00665"></a>00665       <span class="keywordflow">return</span> [<span class="stringliteral">'/MANIFEST:NO'</span>], [], []
<a name="l00666"></a>00666 
<a name="l00667"></a>00667     output_name = name + <span class="stringliteral">'.intermediate.manifest'</span>
<a name="l00668"></a>00668     flags = [
<a name="l00669"></a>00669       <span class="stringliteral">'/MANIFEST'</span>,
<a name="l00670"></a>00670       <span class="stringliteral">'/ManifestFile:'</span> + output_name,
<a name="l00671"></a>00671     ]
<a name="l00672"></a>00672 
<a name="l00673"></a>00673     <span class="comment"># Instead of using the MANIFESTUAC flags, we generate a .manifest to</span>
<a name="l00674"></a>00674     <span class="comment"># include into the list of manifests. This allows us to avoid the need to</span>
<a name="l00675"></a>00675     <span class="comment"># do two passes during linking. The /MANIFEST flag and /ManifestFile are</span>
<a name="l00676"></a>00676     <span class="comment"># still used, and the intermediate manifest is used to assert that the</span>
<a name="l00677"></a>00677     <span class="comment"># final manifest we get from merging all the additional manifest files</span>
<a name="l00678"></a>00678     <span class="comment"># (plus the one we generate here) isn't modified by merging the</span>
<a name="l00679"></a>00679     <span class="comment"># intermediate into it.</span>
<a name="l00680"></a>00680 
<a name="l00681"></a>00681     <span class="comment"># Always NO, because we generate a manifest file that has what we want.</span>
<a name="l00682"></a>00682     flags.append(<span class="stringliteral">'/MANIFESTUAC:NO'</span>)
<a name="l00683"></a>00683 
<a name="l00684"></a>00684     config = self._TargetConfig(config)
<a name="l00685"></a>00685     enable_uac = self._Setting((<span class="stringliteral">'VCLinkerTool'</span>, <span class="stringliteral">'EnableUAC'</span>), config,
<a name="l00686"></a>00686                                default=<span class="stringliteral">'true'</span>)
<a name="l00687"></a>00687     manifest_files = []
<a name="l00688"></a>00688     generated_manifest_outer = \
<a name="l00689"></a>00689 <span class="stringliteral">"&lt;?xml version='1.0' encoding='UTF-8' standalone='yes'?&gt;"</span> \
<a name="l00690"></a>00690 <span class="stringliteral">"&lt;assembly xmlns='urn:schemas-microsoft-com:asm.v1' manifestVersion='1.0'&gt;%s"</span> \
<a name="l00691"></a>00691 <span class="stringliteral">"&lt;/assembly&gt;"</span>
<a name="l00692"></a>00692     <span class="keywordflow">if</span> enable_uac == <span class="stringliteral">'true'</span>:
<a name="l00693"></a>00693       execution_level = self._Setting((<span class="stringliteral">'VCLinkerTool'</span>, <span class="stringliteral">'UACExecutionLevel'</span>),
<a name="l00694"></a>00694                                       config, default=<span class="stringliteral">'0'</span>)
<a name="l00695"></a>00695       execution_level_map = {
<a name="l00696"></a>00696         <span class="stringliteral">'0'</span>: <span class="stringliteral">'asInvoker'</span>,
<a name="l00697"></a>00697         <span class="stringliteral">'1'</span>: <span class="stringliteral">'highestAvailable'</span>,
<a name="l00698"></a>00698         <span class="stringliteral">'2'</span>: <span class="stringliteral">'requireAdministrator'</span>
<a name="l00699"></a>00699       }
<a name="l00700"></a>00700 
<a name="l00701"></a>00701       ui_access = self._Setting((<span class="stringliteral">'VCLinkerTool'</span>, <span class="stringliteral">'UACUIAccess'</span>), config,
<a name="l00702"></a>00702                                 default=<span class="stringliteral">'false'</span>)
<a name="l00703"></a>00703 
<a name="l00704"></a>00704       inner = <span class="stringliteral">'''</span>
<a name="l00705"></a>00705 <span class="stringliteral">&lt;trustInfo xmlns="urn:schemas-microsoft-com:asm.v3"&gt;</span>
<a name="l00706"></a>00706 <span class="stringliteral">  &lt;security&gt;</span>
<a name="l00707"></a>00707 <span class="stringliteral">    &lt;requestedPrivileges&gt;</span>
<a name="l00708"></a>00708 <span class="stringliteral">      &lt;requestedExecutionLevel level='%s' uiAccess='%s' /&gt;</span>
<a name="l00709"></a>00709 <span class="stringliteral">    &lt;/requestedPrivileges&gt;</span>
<a name="l00710"></a>00710 <span class="stringliteral">  &lt;/security&gt;</span>
<a name="l00711"></a>00711 <span class="stringliteral">&lt;/trustInfo&gt;'''</span> % (execution_level_map[execution_level], ui_access)
<a name="l00712"></a>00712     <span class="keywordflow">else</span>:
<a name="l00713"></a>00713       inner = <span class="stringliteral">''</span>
<a name="l00714"></a>00714 
<a name="l00715"></a>00715     generated_manifest_contents = generated_manifest_outer % inner
<a name="l00716"></a>00716     generated_name = name + <span class="stringliteral">'.generated.manifest'</span>
<a name="l00717"></a>00717     <span class="comment"># Need to join with the build_dir here as we're writing it during</span>
<a name="l00718"></a>00718     <span class="comment"># generation time, but we return the un-joined version because the build</span>
<a name="l00719"></a>00719     <span class="comment"># will occur in that directory. We only write the file if the contents</span>
<a name="l00720"></a>00720     <span class="comment"># have changed so that simply regenerating the project files doesn't</span>
<a name="l00721"></a>00721     <span class="comment"># cause a relink.</span>
<a name="l00722"></a>00722     build_dir_generated_name = os.path.join(build_dir, generated_name)
<a name="l00723"></a>00723     gyp.common.EnsureDirExists(build_dir_generated_name)
<a name="l00724"></a>00724     f = gyp.common.WriteOnDiff(build_dir_generated_name)
<a name="l00725"></a>00725     f.write(generated_manifest_contents)
<a name="l00726"></a>00726     f.close()
<a name="l00727"></a>00727     manifest_files = [generated_name]
<a name="l00728"></a>00728 
<a name="l00729"></a>00729     <span class="keywordflow">if</span> allow_isolation:
<a name="l00730"></a>00730       flags.append(<span class="stringliteral">'/ALLOWISOLATION'</span>)
<a name="l00731"></a>00731 
<a name="l00732"></a>00732     manifest_files += self._GetAdditionalManifestFiles(config,
<a name="l00733"></a>00733                                                        gyp_to_build_path)
<a name="l00734"></a>00734     <span class="keywordflow">return</span> flags, output_name, manifest_files
<a name="l00735"></a>00735 
<a name="l00736"></a>00736   <span class="keyword">def </span>_GetAdditionalManifestFiles(self, config, gyp_to_build_path):
<a name="l00737"></a>00737     <span class="stringliteral">"""Gets additional manifest files that are added to the default one</span>
<a name="l00738"></a>00738 <span class="stringliteral">    generated by the linker."""</span>
<a name="l00739"></a>00739     files = self._Setting((<span class="stringliteral">'VCManifestTool'</span>, <span class="stringliteral">'AdditionalManifestFiles'</span>), config,
<a name="l00740"></a>00740                           default=[])
<a name="l00741"></a>00741     <span class="keywordflow">if</span> isinstance(files, str):
<a name="l00742"></a>00742       files = files.split(<span class="stringliteral">';'</span>)
<a name="l00743"></a>00743     <span class="keywordflow">return</span> [os.path.normpath(
<a name="l00744"></a>00744                 gyp_to_build_path(self.<a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#ebdaa9196d84bbc3c2ac3021874ba626">ConvertVSMacros</a>(f, config=config)))
<a name="l00745"></a>00745             <span class="keywordflow">for</span> f <span class="keywordflow">in</span> files]
<a name="l00746"></a>00746 
<a name="l00747"></a>00747   <span class="keyword">def </span>IsUseLibraryDependencyInputs(self, config):
<a name="l00748"></a>00748     <span class="stringliteral">"""Returns whether the target should be linked via Use Library Dependency</span>
<a name="l00749"></a>00749 <span class="stringliteral">    Inputs (using component .objs of a given .lib)."""</span>
<a name="l00750"></a>00750     config = self._TargetConfig(config)
<a name="l00751"></a>00751     uldi = self._Setting((<span class="stringliteral">'VCLinkerTool'</span>, <span class="stringliteral">'UseLibraryDependencyInputs'</span>), config)
<a name="l00752"></a>00752     <span class="keywordflow">return</span> uldi == <span class="stringliteral">'true'</span>
<a name="l00753"></a>00753 
<a name="l00754"></a>00754   <span class="keyword">def </span>IsEmbedManifest(self, config):
<a name="l00755"></a>00755     <span class="stringliteral">"""Returns whether manifest should be linked into binary."""</span>
<a name="l00756"></a>00756     config = self._TargetConfig(config)
<a name="l00757"></a>00757     embed = self._Setting((<span class="stringliteral">'VCManifestTool'</span>, <span class="stringliteral">'EmbedManifest'</span>), config,
<a name="l00758"></a>00758                           default=<span class="stringliteral">'true'</span>)
<a name="l00759"></a>00759     <span class="keywordflow">return</span> embed == <span class="stringliteral">'true'</span>
<a name="l00760"></a>00760 
<a name="l00761"></a>00761   <span class="keyword">def </span>IsLinkIncremental(self, config):
<a name="l00762"></a>00762     <span class="stringliteral">"""Returns whether the target should be linked incrementally."""</span>
<a name="l00763"></a>00763     config = self._TargetConfig(config)
<a name="l00764"></a>00764     link_inc = self._Setting((<span class="stringliteral">'VCLinkerTool'</span>, <span class="stringliteral">'LinkIncremental'</span>), config)
<a name="l00765"></a>00765     <span class="keywordflow">return</span> link_inc != <span class="stringliteral">'1'</span>
<a name="l00766"></a>00766 
<a name="l00767"></a>00767   <span class="keyword">def </span>GetRcflags(self, config, gyp_to_ninja_path):
<a name="l00768"></a>00768     <span class="stringliteral">"""Returns the flags that need to be added to invocations of the resource</span>
<a name="l00769"></a>00769 <span class="stringliteral">    compiler."""</span>
<a name="l00770"></a>00770     config = self._TargetConfig(config)
<a name="l00771"></a>00771     rcflags = []
<a name="l00772"></a>00772     rc = self.<a class="code" href="../../d7/da2/classgyp_1_1msvs__emulation_1_1_msvs_settings_1_1___get_wrapper.html">_GetWrapper</a>(self, self.msvs_settings[config],
<a name="l00773"></a>00773         <span class="stringliteral">'VCResourceCompilerTool'</span>, append=rcflags)
<a name="l00774"></a>00774     rc(<span class="stringliteral">'AdditionalIncludeDirectories'</span>, map=gyp_to_ninja_path, prefix=<span class="stringliteral">'/I'</span>)
<a name="l00775"></a>00775     rcflags.append(<span class="stringliteral">'/I'</span> + gyp_to_ninja_path(<span class="stringliteral">'.'</span>))
<a name="l00776"></a>00776     rc(<span class="stringliteral">'PreprocessorDefinitions'</span>, prefix=<span class="stringliteral">'/d'</span>)
<a name="l00777"></a>00777     <span class="comment"># /l arg must be in hex without leading '0x'</span>
<a name="l00778"></a>00778     rc(<span class="stringliteral">'Culture'</span>, prefix=<span class="stringliteral">'/l'</span>, map=<span class="keyword">lambda</span> x: hex(int(x))[2:])
<a name="l00779"></a>00779     <span class="keywordflow">return</span> rcflags
<a name="l00780"></a>00780 
<a name="l00781"></a>00781   <span class="keyword">def </span>BuildCygwinBashCommandLine(self, args, path_to_base):
<a name="l00782"></a>00782     <span class="stringliteral">"""Build a command line that runs args via cygwin bash. We assume that all</span>
<a name="l00783"></a>00783 <span class="stringliteral">    incoming paths are in Windows normpath'd form, so they need to be</span>
<a name="l00784"></a>00784 <span class="stringliteral">    converted to posix style for the part of the command line that's passed to</span>
<a name="l00785"></a>00785 <span class="stringliteral">    bash. We also have to do some Visual Studio macro emulation here because</span>
<a name="l00786"></a>00786 <span class="stringliteral">    various rules use magic VS names for things. Also note that rules that</span>
<a name="l00787"></a>00787 <span class="stringliteral">    contain ninja variables cannot be fixed here (for example ${source}), so</span>
<a name="l00788"></a>00788 <span class="stringliteral">    the outer generator needs to make sure that the paths that are written out</span>
<a name="l00789"></a>00789 <span class="stringliteral">    are in posix style, if the command line will be used here."""</span>
<a name="l00790"></a>00790     cygwin_dir = os.path.normpath(
<a name="l00791"></a>00791         os.path.join(path_to_base, self.<a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#ed0ff08fbb29dbca99043f5910012c08">msvs_cygwin_dirs</a>[0]))
<a name="l00792"></a>00792     cd = (<span class="stringliteral">'cd %s'</span> % path_to_base).replace(<span class="stringliteral">'\\'</span>, <span class="stringliteral">'/'</span>)
<a name="l00793"></a>00793     args = [a.replace(<span class="stringliteral">'\\'</span>, <span class="stringliteral">'/'</span>).replace(<span class="stringliteral">'"'</span>, <span class="stringliteral">'\\"'</span>) <span class="keywordflow">for</span> a <span class="keywordflow">in</span> args]
<a name="l00794"></a>00794     args = [<span class="stringliteral">"'%s'"</span> % a.replace(<span class="stringliteral">"'"</span>, <span class="stringliteral">"'\\''"</span>) <span class="keywordflow">for</span> a <span class="keywordflow">in</span> args]
<a name="l00795"></a>00795     bash_cmd = <span class="stringliteral">' '</span>.join(args)
<a name="l00796"></a>00796     cmd = (
<a name="l00797"></a>00797         <span class="stringliteral">'call "%s\\setup_env.bat" &amp;&amp; set CYGWIN=nontsec &amp;&amp; '</span> % cygwin_dir +
<a name="l00798"></a>00798         <span class="stringliteral">'bash -c "%s ; %s"'</span> % (cd, bash_cmd))
<a name="l00799"></a>00799     <span class="keywordflow">return</span> cmd
<a name="l00800"></a>00800 
<a name="l00801"></a>00801   <span class="keyword">def </span>IsRuleRunUnderCygwin(self, rule):
<a name="l00802"></a>00802     <span class="stringliteral">"""Determine if an action should be run under cygwin. If the variable is</span>
<a name="l00803"></a>00803 <span class="stringliteral">    unset, or set to 1 we use cygwin."""</span>
<a name="l00804"></a>00804     <span class="keywordflow">return</span> int(rule.get(<span class="stringliteral">'msvs_cygwin_shell'</span>,
<a name="l00805"></a>00805                         self.<a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#daf1b66faf18504ec4b5c8c0b7f6763b">spec</a>.get(<span class="stringliteral">'msvs_cygwin_shell'</span>, 1))) != 0
<a name="l00806"></a>00806 
<a name="l00807"></a>00807   <span class="keyword">def </span>_HasExplicitRuleForExtension(self, spec, extension):
<a name="l00808"></a>00808     <span class="stringliteral">"""Determine if there's an explicit rule for a particular extension."""</span>
<a name="l00809"></a>00809     <span class="keywordflow">for</span> rule <span class="keywordflow">in</span> spec.get(<span class="stringliteral">'rules'</span>, []):
<a name="l00810"></a>00810       <span class="keywordflow">if</span> rule[<span class="stringliteral">'extension'</span>] == extension:
<a name="l00811"></a>00811         <span class="keywordflow">return</span> <span class="keyword">True</span>
<a name="l00812"></a>00812     <span class="keywordflow">return</span> <span class="keyword">False</span>
<a name="l00813"></a>00813 
<a name="l00814"></a>00814   <span class="keyword">def </span>_HasExplicitIdlActions(self, spec):
<a name="l00815"></a>00815     <span class="stringliteral">"""Determine if an action should not run midl for .idl files."""</span>
<a name="l00816"></a>00816     <span class="keywordflow">return</span> any([action.get(<span class="stringliteral">'explicit_idl_action'</span>, 0)
<a name="l00817"></a>00817                 <span class="keywordflow">for</span> action <span class="keywordflow">in</span> spec.get(<span class="stringliteral">'actions'</span>, [])])
<a name="l00818"></a>00818 
<a name="l00819"></a>00819   <span class="keyword">def </span>HasExplicitIdlRulesOrActions(self, spec):
<a name="l00820"></a>00820     <span class="stringliteral">"""Determine if there's an explicit rule or action for idl files. When</span>
<a name="l00821"></a>00821 <span class="stringliteral">    there isn't we need to generate implicit rules to build MIDL .idl files."""</span>
<a name="l00822"></a>00822     <span class="keywordflow">return</span> (self._HasExplicitRuleForExtension(spec, <span class="stringliteral">'idl'</span>) <span class="keywordflow">or</span>
<a name="l00823"></a>00823             self._HasExplicitIdlActions(spec))
<a name="l00824"></a>00824 
<a name="l00825"></a>00825   <span class="keyword">def </span>HasExplicitAsmRules(self, spec):
<a name="l00826"></a>00826     <span class="stringliteral">"""Determine if there's an explicit rule for asm files. When there isn't we</span>
<a name="l00827"></a>00827 <span class="stringliteral">    need to generate implicit rules to assemble .asm files."""</span>
<a name="l00828"></a>00828     <span class="keywordflow">return</span> self._HasExplicitRuleForExtension(spec, <span class="stringliteral">'asm'</span>)
<a name="l00829"></a>00829 
<a name="l00830"></a>00830   <span class="keyword">def </span>GetIdlBuildData(self, source, config):
<a name="l00831"></a>00831     <span class="stringliteral">"""Determine the implicit outputs for an idl file. Returns output</span>
<a name="l00832"></a>00832 <span class="stringliteral">    directory, outputs, and variables and flags that are required."""</span>
<a name="l00833"></a>00833     config = self._TargetConfig(config)
<a name="l00834"></a>00834     midl_get = self.<a class="code" href="../../d7/da2/classgyp_1_1msvs__emulation_1_1_msvs_settings_1_1___get_wrapper.html">_GetWrapper</a>(self, self.msvs_settings[config], <span class="stringliteral">'VCMIDLTool'</span>)
<a name="l00835"></a>00835     <span class="keyword">def </span>midl(name, default=None):
<a name="l00836"></a>00836       <span class="keywordflow">return</span> self.<a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#ebdaa9196d84bbc3c2ac3021874ba626">ConvertVSMacros</a>(midl_get(name, default=default),
<a name="l00837"></a>00837                                   config=config)
<a name="l00838"></a>00838     tlb = midl(<span class="stringliteral">'TypeLibraryName'</span>, default=<span class="stringliteral">'${root}.tlb'</span>)
<a name="l00839"></a>00839     header = midl(<span class="stringliteral">'HeaderFileName'</span>, default=<span class="stringliteral">'${root}.h'</span>)
<a name="l00840"></a>00840     dlldata = midl(<span class="stringliteral">'DLLDataFileName'</span>, default=<span class="stringliteral">'dlldata.c'</span>)
<a name="l00841"></a>00841     iid = midl(<span class="stringliteral">'InterfaceIdentifierFileName'</span>, default=<span class="stringliteral">'${root}_i.c'</span>)
<a name="l00842"></a>00842     proxy = midl(<span class="stringliteral">'ProxyFileName'</span>, default=<span class="stringliteral">'${root}_p.c'</span>)
<a name="l00843"></a>00843     <span class="comment"># Note that .tlb is not included in the outputs as it is not always</span>
<a name="l00844"></a>00844     <span class="comment"># generated depending on the content of the input idl file.</span>
<a name="l00845"></a>00845     outdir = midl(<span class="stringliteral">'OutputDirectory'</span>, default=<span class="stringliteral">''</span>)
<a name="l00846"></a>00846     output = [header, dlldata, iid, proxy]
<a name="l00847"></a>00847     variables = [(<span class="stringliteral">'tlb'</span>, tlb),
<a name="l00848"></a>00848                  (<span class="stringliteral">'h'</span>, header),
<a name="l00849"></a>00849                  (<span class="stringliteral">'dlldata'</span>, dlldata),
<a name="l00850"></a>00850                  (<span class="stringliteral">'iid'</span>, iid),
<a name="l00851"></a>00851                  (<span class="stringliteral">'proxy'</span>, proxy)]
<a name="l00852"></a>00852     <span class="comment"># TODO(scottmg): Are there configuration settings to set these flags?</span>
<a name="l00853"></a>00853     target_platform = <span class="stringliteral">'win32'</span> <span class="keywordflow">if</span> self.<a class="code" href="../../d4/d67/classgyp_1_1msvs__emulation_1_1_msvs_settings.html#727eacd31a0e10c816473ff9eaeb82ec">GetArch</a>(config) == <span class="stringliteral">'x86'</span> <span class="keywordflow">else</span> <span class="stringliteral">'x64'</span>
<a name="l00854"></a>00854     flags = [<span class="stringliteral">'/char'</span>, <span class="stringliteral">'signed'</span>, <span class="stringliteral">'/env'</span>, target_platform, <span class="stringliteral">'/Oicf'</span>]
<a name="l00855"></a>00855     <span class="keywordflow">return</span> outdir, output, variables, flags
<a name="l00856"></a>00856 
<a name="l00857"></a>00857 
<a name="l00858"></a><a class="code" href="../../d1/ddf/namespacegyp_1_1msvs__emulation.html#7f44ca4803c0c0920002499acec6b8cf">00858</a> <span class="keyword">def </span><a class="code" href="../../d1/ddf/namespacegyp_1_1msvs__emulation.html#7f44ca4803c0c0920002499acec6b8cf">_LanguageMatchesForPch</a>(source_ext, pch_source_ext):
<a name="l00859"></a>00859   c_exts = (<span class="stringliteral">'.c'</span>,)
<a name="l00860"></a>00860   cc_exts = (<span class="stringliteral">'.cc'</span>, <span class="stringliteral">'.cxx'</span>, <span class="stringliteral">'.cpp'</span>)
<a name="l00861"></a>00861   <span class="keywordflow">return</span> ((source_ext <span class="keywordflow">in</span> c_exts <span class="keywordflow">and</span> pch_source_ext <span class="keywordflow">in</span> c_exts) <span class="keywordflow">or</span>
<a name="l00862"></a>00862           (source_ext <span class="keywordflow">in</span> cc_exts <span class="keywordflow">and</span> pch_source_ext <span class="keywordflow">in</span> cc_exts))
<a name="l00863"></a>00863 
<a name="l00864"></a>00864 
<a name="l00865"></a><a class="code" href="../../d3/d92/classgyp_1_1msvs__emulation_1_1_precompiled_header.html">00865</a> <span class="keyword">class </span><a class="code" href="../../d3/d92/classgyp_1_1msvs__emulation_1_1_precompiled_header.html">PrecompiledHeader</a>(object):
<a name="l00866"></a>00866   <span class="stringliteral">"""Helper to generate dependencies and build rules to handle generation of</span>
<a name="l00867"></a>00867 <span class="stringliteral">  precompiled headers. Interface matches the GCH handler in xcode_emulation.py.</span>
<a name="l00868"></a>00868 <span class="stringliteral">  """</span>
<a name="l00869"></a><a class="code" href="../../d3/d92/classgyp_1_1msvs__emulation_1_1_precompiled_header.html#c775ee34451fdfa742b318538164070e">00869</a>   <span class="keyword">def </span><a class="code" href="../../d3/d92/classgyp_1_1msvs__emulation_1_1_precompiled_header.html#c775ee34451fdfa742b318538164070e">__init__</a>(
<a name="l00870"></a><a class="code" href="../../d3/d92/classgyp_1_1msvs__emulation_1_1_precompiled_header.html#6cddb5e40c21eadd2ded85bc51f79822">00870</a>       self, settings, config, gyp_to_build_path, gyp_to_unique_output, obj_ext):
<a name="l00871"></a><a class="code" href="../../d3/d92/classgyp_1_1msvs__emulation_1_1_precompiled_header.html#d2256458892609d0533df5d72a7257ad">00871</a>     self.<a class="code" href="../../d3/d92/classgyp_1_1msvs__emulation_1_1_precompiled_header.html#6cddb5e40c21eadd2ded85bc51f79822">settings</a> = settings
<a name="l00872"></a>00872     self.<a class="code" href="../../d3/d92/classgyp_1_1msvs__emulation_1_1_precompiled_header.html#d2256458892609d0533df5d72a7257ad">config</a> = config
<a name="l00873"></a><a class="code" href="../../d3/d92/classgyp_1_1msvs__emulation_1_1_precompiled_header.html#d9fe1db54a2342cc3174cdd2b97c7742">00873</a>     pch_source = self.<a class="code" href="../../d3/d92/classgyp_1_1msvs__emulation_1_1_precompiled_header.html#6cddb5e40c21eadd2ded85bc51f79822">settings</a>.msvs_precompiled_source[self.<a class="code" href="../../d3/d92/classgyp_1_1msvs__emulation_1_1_precompiled_header.html#d2256458892609d0533df5d72a7257ad">config</a>]
<a name="l00874"></a>00874     self.<a class="code" href="../../d3/d92/classgyp_1_1msvs__emulation_1_1_precompiled_header.html#d9fe1db54a2342cc3174cdd2b97c7742">pch_source</a> = gyp_to_build_path(pch_source)
<a name="l00875"></a><a class="code" href="../../d3/d92/classgyp_1_1msvs__emulation_1_1_precompiled_header.html#77ff40077cbc34b8094fb9888f503a55">00875</a>     filename, _ = os.path.splitext(pch_source)
<a name="l00876"></a>00876     self.<a class="code" href="../../d3/d92/classgyp_1_1msvs__emulation_1_1_precompiled_header.html#77ff40077cbc34b8094fb9888f503a55">output_obj</a> = gyp_to_unique_output(filename + obj_ext).lower()
<a name="l00877"></a>00877 
<a name="l00878"></a><a class="code" href="../../d3/d92/classgyp_1_1msvs__emulation_1_1_precompiled_header.html#e42e2331ee6e395744df1546825f5957">00878</a>   <span class="keyword">def </span><a class="code" href="../../d3/d92/classgyp_1_1msvs__emulation_1_1_precompiled_header.html#e42e2331ee6e395744df1546825f5957">_PchHeader</a>(self):
<a name="l00879"></a>00879     <span class="stringliteral">"""Get the header that will appear in an #include line for all source</span>
<a name="l00880"></a>00880 <span class="stringliteral">    files."""</span>
<a name="l00881"></a>00881     <span class="keywordflow">return</span> os.path.split(self.<a class="code" href="../../d3/d92/classgyp_1_1msvs__emulation_1_1_precompiled_header.html#6cddb5e40c21eadd2ded85bc51f79822">settings</a>.msvs_precompiled_header[self.<a class="code" href="../../d3/d92/classgyp_1_1msvs__emulation_1_1_precompiled_header.html#d2256458892609d0533df5d72a7257ad">config</a>])[1]
<a name="l00882"></a>00882 
<a name="l00883"></a><a class="code" href="../../d3/d92/classgyp_1_1msvs__emulation_1_1_precompiled_header.html#a7709d4fe241cac7a80487ad86ca2693">00883</a>   <span class="keyword">def </span><a class="code" href="../../d3/d92/classgyp_1_1msvs__emulation_1_1_precompiled_header.html#a7709d4fe241cac7a80487ad86ca2693">GetObjDependencies</a>(self, sources, objs, arch):
<a name="l00884"></a>00884     <span class="stringliteral">"""Given a list of sources files and the corresponding object files,</span>
<a name="l00885"></a>00885 <span class="stringliteral">    returns a list of the pch files that should be depended upon. The</span>
<a name="l00886"></a>00886 <span class="stringliteral">    additional wrapping in the return value is for interface compatibility</span>
<a name="l00887"></a>00887 <span class="stringliteral">    with make.py on Mac, and xcode_emulation.py."""</span>
<a name="l00888"></a>00888     <span class="keyword">assert</span> arch <span class="keywordflow">is</span> <span class="keywordtype">None</span>
<a name="l00889"></a>00889     <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.<a class="code" href="../../d3/d92/classgyp_1_1msvs__emulation_1_1_precompiled_header.html#e42e2331ee6e395744df1546825f5957">_PchHeader</a>():
<a name="l00890"></a>00890       <span class="keywordflow">return</span> []
<a name="l00891"></a>00891     pch_ext = os.path.splitext(self.<a class="code" href="../../d3/d92/classgyp_1_1msvs__emulation_1_1_precompiled_header.html#d9fe1db54a2342cc3174cdd2b97c7742">pch_source</a>)[1]
<a name="l00892"></a>00892     <span class="keywordflow">for</span> source <span class="keywordflow">in</span> sources:
<a name="l00893"></a>00893       <span class="keywordflow">if</span> _LanguageMatchesForPch(os.path.splitext(source)[1], pch_ext):
<a name="l00894"></a>00894         <span class="keywordflow">return</span> [(<span class="keywordtype">None</span>, <span class="keywordtype">None</span>, self.<a class="code" href="../../d3/d92/classgyp_1_1msvs__emulation_1_1_precompiled_header.html#77ff40077cbc34b8094fb9888f503a55">output_obj</a>)]
<a name="l00895"></a>00895     <span class="keywordflow">return</span> []
<a name="l00896"></a>00896 
<a name="l00897"></a><a class="code" href="../../d3/d92/classgyp_1_1msvs__emulation_1_1_precompiled_header.html#2aa3c15c3979806544c12f9450e76efe">00897</a>   <span class="keyword">def </span><a class="code" href="../../d3/d92/classgyp_1_1msvs__emulation_1_1_precompiled_header.html#2aa3c15c3979806544c12f9450e76efe">GetPchBuildCommands</a>(self, arch):
<a name="l00898"></a>00898     <span class="stringliteral">"""Not used on Windows as there are no additional build steps required</span>
<a name="l00899"></a>00899 <span class="stringliteral">    (instead, existing steps are modified in GetFlagsModifications below)."""</span>
<a name="l00900"></a>00900     <span class="keywordflow">return</span> []
<a name="l00901"></a>00901 
<a name="l00902"></a><a class="code" href="../../d3/d92/classgyp_1_1msvs__emulation_1_1_precompiled_header.html#01cc6b1cb2fc176b8dc9ab74c1c47842">00902</a>   <span class="keyword">def </span><a class="code" href="../../d3/d92/classgyp_1_1msvs__emulation_1_1_precompiled_header.html#01cc6b1cb2fc176b8dc9ab74c1c47842">GetFlagsModifications</a>(self, input, output, implicit, command,
<a name="l00903"></a>00903                             cflags_c, cflags_cc, expand_special):
<a name="l00904"></a>00904     <span class="stringliteral">"""Get the modified cflags and implicit dependencies that should be used</span>
<a name="l00905"></a>00905 <span class="stringliteral">    for the pch compilation step."""</span>
<a name="l00906"></a>00906     <span class="keywordflow">if</span> input == self.<a class="code" href="../../d3/d92/classgyp_1_1msvs__emulation_1_1_precompiled_header.html#d9fe1db54a2342cc3174cdd2b97c7742">pch_source</a>:
<a name="l00907"></a>00907       pch_output = [<span class="stringliteral">'/Yc'</span> + self.<a class="code" href="../../d3/d92/classgyp_1_1msvs__emulation_1_1_precompiled_header.html#e42e2331ee6e395744df1546825f5957">_PchHeader</a>()]
<a name="l00908"></a>00908       <span class="keywordflow">if</span> command == <span class="stringliteral">'cxx'</span>:
<a name="l00909"></a>00909         <span class="keywordflow">return</span> ([(<span class="stringliteral">'cflags_cc'</span>, map(expand_special, cflags_cc + pch_output))],
<a name="l00910"></a>00910                 self.<a class="code" href="../../d3/d92/classgyp_1_1msvs__emulation_1_1_precompiled_header.html#77ff40077cbc34b8094fb9888f503a55">output_obj</a>, [])
<a name="l00911"></a>00911       <span class="keywordflow">elif</span> command == <span class="stringliteral">'cc'</span>:
<a name="l00912"></a>00912         <span class="keywordflow">return</span> ([(<span class="stringliteral">'cflags_c'</span>, map(expand_special, cflags_c + pch_output))],
<a name="l00913"></a>00913                 self.<a class="code" href="../../d3/d92/classgyp_1_1msvs__emulation_1_1_precompiled_header.html#77ff40077cbc34b8094fb9888f503a55">output_obj</a>, [])
<a name="l00914"></a>00914     <span class="keywordflow">return</span> [], output, implicit
<a name="l00915"></a>00915 
<a name="l00916"></a>00916 
<a name="l00917"></a><a class="code" href="../../d1/ddf/namespacegyp_1_1msvs__emulation.html#365c5b6a02f70877282b2b7dbf443b0a">00917</a> vs_version = <span class="keywordtype">None</span>
<a name="l00918"></a><a class="code" href="../../d1/ddf/namespacegyp_1_1msvs__emulation.html#252a72c9c83b4bcd57f767f1410016d7">00918</a> <span class="keyword">def </span><a class="code" href="../../d1/ddf/namespacegyp_1_1msvs__emulation.html#252a72c9c83b4bcd57f767f1410016d7">GetVSVersion</a>(generator_flags):
<a name="l00919"></a>00919   <span class="keyword">global</span> vs_version
<a name="l00920"></a>00920   <span class="keywordflow">if</span> <span class="keywordflow">not</span> vs_version:
<a name="l00921"></a>00921     vs_version = gyp.MSVSVersion.SelectVisualStudioVersion(
<a name="l00922"></a>00922         generator_flags.get(<span class="stringliteral">'msvs_version'</span>, <span class="stringliteral">'auto'</span>),
<a name="l00923"></a>00923         allow_fallback=<span class="keyword">False</span>)
<a name="l00924"></a>00924   <span class="keywordflow">return</span> vs_version
<a name="l00925"></a>00925 
<a name="l00926"></a><a class="code" href="../../d1/ddf/namespacegyp_1_1msvs__emulation.html#b1eb2b42b20a330ee7636aed93b16ddf">00926</a> <span class="keyword">def </span><a class="code" href="../../d1/ddf/namespacegyp_1_1msvs__emulation.html#b1eb2b42b20a330ee7636aed93b16ddf">_GetVsvarsSetupArgs</a>(generator_flags, arch):
<a name="l00927"></a>00927   vs = GetVSVersion(generator_flags)
<a name="l00928"></a>00928   <span class="keywordflow">return</span> vs.SetupScript()
<a name="l00929"></a>00929 
<a name="l00930"></a><a class="code" href="../../d1/ddf/namespacegyp_1_1msvs__emulation.html#2ce50dc3949bee47e69943b5f1d770ce">00930</a> <span class="keyword">def </span><a class="code" href="../../d1/ddf/namespacegyp_1_1msvs__emulation.html#2ce50dc3949bee47e69943b5f1d770ce">ExpandMacros</a>(string, expansions):
<a name="l00931"></a>00931   <span class="stringliteral">"""Expand $(Variable) per expansions dict. See MsvsSettings.GetVSMacroEnv</span>
<a name="l00932"></a>00932 <span class="stringliteral">  for the canonical way to retrieve a suitable dict."""</span>
<a name="l00933"></a>00933   <span class="keywordflow">if</span> <span class="stringliteral">'$'</span> <span class="keywordflow">in</span> string:
<a name="l00934"></a>00934     <span class="keywordflow">for</span> old, new <span class="keywordflow">in</span> expansions.iteritems():
<a name="l00935"></a>00935       <span class="keyword">assert</span> <span class="stringliteral">'$('</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> new, new
<a name="l00936"></a>00936       string = string.replace(old, new)
<a name="l00937"></a>00937   <span class="keywordflow">return</span> string
<a name="l00938"></a>00938 
<a name="l00939"></a><a class="code" href="../../d1/ddf/namespacegyp_1_1msvs__emulation.html#c4f83bfe21909c433d66bfa3edbee926">00939</a> <span class="keyword">def </span><a class="code" href="../../d1/ddf/namespacegyp_1_1msvs__emulation.html#c4f83bfe21909c433d66bfa3edbee926">_ExtractImportantEnvironment</a>(output_of_set):
<a name="l00940"></a>00940   <span class="stringliteral">"""Extracts environment variables required for the toolchain to run from</span>
<a name="l00941"></a>00941 <span class="stringliteral">  a textual dump output by the cmd.exe 'set' command."""</span>
<a name="l00942"></a>00942   envvars_to_save = (
<a name="l00943"></a>00943       <span class="stringliteral">'goma_.*'</span>, <span class="comment"># TODO(scottmg): This is ugly, but needed for goma.</span>
<a name="l00944"></a>00944       <span class="stringliteral">'include'</span>,
<a name="l00945"></a>00945       <span class="stringliteral">'lib'</span>,
<a name="l00946"></a>00946       <span class="stringliteral">'libpath'</span>,
<a name="l00947"></a>00947       <span class="stringliteral">'path'</span>,
<a name="l00948"></a>00948       <span class="stringliteral">'pathext'</span>,
<a name="l00949"></a>00949       <span class="stringliteral">'systemroot'</span>,
<a name="l00950"></a>00950       <span class="stringliteral">'temp'</span>,
<a name="l00951"></a>00951       <span class="stringliteral">'tmp'</span>,
<a name="l00952"></a>00952       )
<a name="l00953"></a>00953   env = {}
<a name="l00954"></a>00954   <span class="keywordflow">for</span> line <span class="keywordflow">in</span> output_of_set.splitlines():
<a name="l00955"></a>00955     <span class="keywordflow">for</span> envvar <span class="keywordflow">in</span> envvars_to_save:
<a name="l00956"></a>00956       <span class="keywordflow">if</span> re.match(envvar + <span class="stringliteral">'='</span>, line.lower()):
<a name="l00957"></a>00957         var, setting = line.split(<span class="stringliteral">'='</span>, 1)
<a name="l00958"></a>00958         <span class="keywordflow">if</span> envvar == <span class="stringliteral">'path'</span>:
<a name="l00959"></a>00959           <span class="comment"># Our own rules (for running gyp-win-tool) and other actions in</span>
<a name="l00960"></a>00960           <span class="comment"># Chromium rely on python being in the path. Add the path to this</span>
<a name="l00961"></a>00961           <span class="comment"># python here so that if it's not in the path when ninja is run</span>
<a name="l00962"></a>00962           <span class="comment"># later, python will still be found.</span>
<a name="l00963"></a>00963           setting = os.path.dirname(sys.executable) + os.pathsep + setting
<a name="l00964"></a>00964         env[var.upper()] = setting
<a name="l00965"></a>00965         <span class="keywordflow">break</span>
<a name="l00966"></a>00966   <span class="keywordflow">for</span> required <span class="keywordflow">in</span> (<span class="stringliteral">'SYSTEMROOT'</span>, <span class="stringliteral">'TEMP'</span>, <span class="stringliteral">'TMP'</span>):
<a name="l00967"></a>00967     <span class="keywordflow">if</span> required <span class="keywordflow">not</span> <span class="keywordflow">in</span> env:
<a name="l00968"></a>00968       <span class="keywordflow">raise</span> Exception(<span class="stringliteral">'Environment variable "%s" '</span>
<a name="l00969"></a>00969                       <span class="stringliteral">'required to be set to valid path'</span> % required)
<a name="l00970"></a>00970   <span class="keywordflow">return</span> env
<a name="l00971"></a>00971 
<a name="l00972"></a><a class="code" href="../../d1/ddf/namespacegyp_1_1msvs__emulation.html#9b1ecaf9ad9f70fc54b972d9c882694a">00972</a> <span class="keyword">def </span><a class="code" href="../../d1/ddf/namespacegyp_1_1msvs__emulation.html#9b1ecaf9ad9f70fc54b972d9c882694a">_FormatAsEnvironmentBlock</a>(envvar_dict):
<a name="l00973"></a>00973   <span class="stringliteral">"""Format as an 'environment block' directly suitable for CreateProcess.</span>
<a name="l00974"></a>00974 <span class="stringliteral">  Briefly this is a list of key=value\0, terminated by an additional \0. See</span>
<a name="l00975"></a>00975 <span class="stringliteral">  CreateProcess documentation for more details."""</span>
<a name="l00976"></a>00976   block = <span class="stringliteral">''</span>
<a name="l00977"></a>00977   nul = <span class="stringliteral">'\0'</span>
<a name="l00978"></a>00978   <span class="keywordflow">for</span> key, value <span class="keywordflow">in</span> envvar_dict.iteritems():
<a name="l00979"></a>00979     block += key + <span class="stringliteral">'='</span> + value + nul
<a name="l00980"></a>00980   block += nul
<a name="l00981"></a>00981   <span class="keywordflow">return</span> block
<a name="l00982"></a>00982 
<a name="l00983"></a><a class="code" href="../../d1/ddf/namespacegyp_1_1msvs__emulation.html#2a3c361595ff527461755096c1a4e4a3">00983</a> <span class="keyword">def </span><a class="code" href="../../d1/ddf/namespacegyp_1_1msvs__emulation.html#2a3c361595ff527461755096c1a4e4a3">_ExtractCLPath</a>(output_of_where):
<a name="l00984"></a>00984   <span class="stringliteral">"""Gets the path to cl.exe based on the output of calling the environment</span>
<a name="l00985"></a>00985 <span class="stringliteral">  setup batch file, followed by the equivalent of `where`."""</span>
<a name="l00986"></a>00986   <span class="comment"># Take the first line, as that's the first found in the PATH.</span>
<a name="l00987"></a>00987   <span class="keywordflow">for</span> line <span class="keywordflow">in</span> output_of_where.strip().splitlines():
<a name="l00988"></a>00988     <span class="keywordflow">if</span> line.startswith(<span class="stringliteral">'LOC:'</span>):
<a name="l00989"></a>00989       <span class="keywordflow">return</span> line[len(<span class="stringliteral">'LOC:'</span>):].strip()
<a name="l00990"></a>00990 
<a name="l00991"></a><a class="code" href="../../d1/ddf/namespacegyp_1_1msvs__emulation.html#091199c619cdcb94a42434158b0a6014">00991</a> <span class="keyword">def </span><a class="code" href="../../d1/ddf/namespacegyp_1_1msvs__emulation.html#091199c619cdcb94a42434158b0a6014">GenerateEnvironmentFiles</a>(toplevel_build_dir, generator_flags,
<a name="l00992"></a>00992                              system_includes, open_out):
<a name="l00993"></a>00993   <span class="stringliteral">"""It's not sufficient to have the absolute path to the compiler, linker,</span>
<a name="l00994"></a>00994 <span class="stringliteral">  etc. on Windows, as those tools rely on .dlls being in the PATH. We also</span>
<a name="l00995"></a>00995 <span class="stringliteral">  need to support both x86 and x64 compilers within the same build (to support</span>
<a name="l00996"></a>00996 <span class="stringliteral">  msvs_target_platform hackery). Different architectures require a different</span>
<a name="l00997"></a>00997 <span class="stringliteral">  compiler binary, and different supporting environment variables (INCLUDE,</span>
<a name="l00998"></a>00998 <span class="stringliteral">  LIB, LIBPATH). So, we extract the environment here, wrap all invocations</span>
<a name="l00999"></a>00999 <span class="stringliteral">  of compiler tools (cl, link, lib, rc, midl, etc.) via win_tool.py which</span>
<a name="l01000"></a>01000 <span class="stringliteral">  sets up the environment, and then we do not prefix the compiler with</span>
<a name="l01001"></a>01001 <span class="stringliteral">  an absolute path, instead preferring something like "cl.exe" in the rule</span>
<a name="l01002"></a>01002 <span class="stringliteral">  which will then run whichever the environment setup has put in the path.</span>
<a name="l01003"></a>01003 <span class="stringliteral">  When the following procedure to generate environment files does not</span>
<a name="l01004"></a>01004 <span class="stringliteral">  meet your requirement (e.g. for custom toolchains), you can pass</span>
<a name="l01005"></a>01005 <span class="stringliteral">  "-G ninja_use_custom_environment_files" to the gyp to suppress file</span>
<a name="l01006"></a>01006 <span class="stringliteral">  generation and use custom environment files prepared by yourself."""</span>
<a name="l01007"></a>01007   archs = (<span class="stringliteral">'x86'</span>, <span class="stringliteral">'x64'</span>)
<a name="l01008"></a>01008   <span class="keywordflow">if</span> generator_flags.get(<span class="stringliteral">'ninja_use_custom_environment_files'</span>, 0):
<a name="l01009"></a>01009     cl_paths = {}
<a name="l01010"></a>01010     <span class="keywordflow">for</span> arch <span class="keywordflow">in</span> archs:
<a name="l01011"></a>01011       cl_paths[arch] = <span class="stringliteral">'cl.exe'</span>
<a name="l01012"></a>01012     <span class="keywordflow">return</span> cl_paths
<a name="l01013"></a>01013   vs = GetVSVersion(generator_flags)
<a name="l01014"></a>01014   cl_paths = {}
<a name="l01015"></a>01015   <span class="keywordflow">for</span> arch <span class="keywordflow">in</span> archs:
<a name="l01016"></a>01016     <span class="comment"># Extract environment variables for subprocesses.</span>
<a name="l01017"></a>01017     args = vs.SetupScript(arch)
<a name="l01018"></a>01018     args.extend((<span class="stringliteral">'&amp;&amp;'</span>, <span class="stringliteral">'set'</span>))
<a name="l01019"></a>01019     popen = subprocess.Popen(
<a name="l01020"></a>01020         args, shell=<span class="keyword">True</span>, stdout=subprocess.PIPE, stderr=subprocess.STDOUT)
<a name="l01021"></a>01021     variables, _ = popen.communicate()
<a name="l01022"></a>01022     env = _ExtractImportantEnvironment(variables)
<a name="l01023"></a>01023 
<a name="l01024"></a>01024     <span class="comment"># Inject system includes from gyp files into INCLUDE.</span>
<a name="l01025"></a>01025     <span class="keywordflow">if</span> system_includes:
<a name="l01026"></a>01026       system_includes = system_includes | OrderedSet(
<a name="l01027"></a>01027                                               env.get(<span class="stringliteral">'INCLUDE'</span>, <span class="stringliteral">''</span>).split(<span class="stringliteral">';'</span>))
<a name="l01028"></a>01028       env[<span class="stringliteral">'INCLUDE'</span>] = <span class="stringliteral">';'</span>.join(system_includes)
<a name="l01029"></a>01029 
<a name="l01030"></a>01030     env_block = _FormatAsEnvironmentBlock(env)
<a name="l01031"></a>01031     f = open_out(os.path.join(toplevel_build_dir, <span class="stringliteral">'environment.'</span> + arch), <span class="stringliteral">'wb'</span>)
<a name="l01032"></a>01032     f.write(env_block)
<a name="l01033"></a>01033     f.close()
<a name="l01034"></a>01034 
<a name="l01035"></a>01035     <span class="comment"># Find cl.exe location for this architecture.</span>
<a name="l01036"></a>01036     args = vs.SetupScript(arch)
<a name="l01037"></a>01037     args.extend((<span class="stringliteral">'&amp;&amp;'</span>,
<a name="l01038"></a>01038       <span class="stringliteral">'for'</span>, <span class="stringliteral">'%i'</span>, <span class="stringliteral">'in'</span>, <span class="stringliteral">'(cl.exe)'</span>, <span class="stringliteral">'do'</span>, <span class="stringliteral">'@echo'</span>, <span class="stringliteral">'LOC:%~$PATH:i'</span>))
<a name="l01039"></a>01039     popen = subprocess.Popen(args, shell=<span class="keyword">True</span>, stdout=subprocess.PIPE)
<a name="l01040"></a>01040     output, _ = popen.communicate()
<a name="l01041"></a>01041     cl_paths[arch] = _ExtractCLPath(output)
<a name="l01042"></a>01042   <span class="keywordflow">return</span> cl_paths
<a name="l01043"></a>01043 
<a name="l01044"></a><a class="code" href="../../d1/ddf/namespacegyp_1_1msvs__emulation.html#81765c16a484d11f8bb295cf0ab33369">01044</a> <span class="keyword">def </span><a class="code" href="../../d1/ddf/namespacegyp_1_1msvs__emulation.html#81765c16a484d11f8bb295cf0ab33369">VerifyMissingSources</a>(sources, build_dir, generator_flags, gyp_to_ninja):
<a name="l01045"></a>01045   <span class="stringliteral">"""Emulate behavior of msvs_error_on_missing_sources present in the msvs</span>
<a name="l01046"></a>01046 <span class="stringliteral">  generator: Check that all regular source files, i.e. not created at run time,</span>
<a name="l01047"></a>01047 <span class="stringliteral">  exist on disk. Missing files cause needless recompilation when building via</span>
<a name="l01048"></a>01048 <span class="stringliteral">  VS, and we want this check to match for people/bots that build using ninja,</span>
<a name="l01049"></a>01049 <span class="stringliteral">  so they're not surprised when the VS build fails."""</span>
<a name="l01050"></a>01050   <span class="keywordflow">if</span> int(generator_flags.get(<span class="stringliteral">'msvs_error_on_missing_sources'</span>, 0)):
<a name="l01051"></a>01051     no_specials = filter(<span class="keyword">lambda</span> x: <span class="stringliteral">'$'</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> x, sources)
<a name="l01052"></a>01052     relative = [os.path.join(build_dir, gyp_to_ninja(s)) <span class="keywordflow">for</span> s <span class="keywordflow">in</span> no_specials]
<a name="l01053"></a>01053     missing = filter(<span class="keyword">lambda</span> x: <span class="keywordflow">not</span> os.path.exists(x), relative)
<a name="l01054"></a>01054     <span class="keywordflow">if</span> missing:
<a name="l01055"></a>01055       <span class="comment"># They'll look like out\Release\..\..\stuff\things.cc, so normalize the</span>
<a name="l01056"></a>01056       <span class="comment"># path for a slightly less crazy looking output.</span>
<a name="l01057"></a>01057       cleaned_up = [os.path.normpath(x) <span class="keywordflow">for</span> x <span class="keywordflow">in</span> missing]
<a name="l01058"></a>01058       <span class="keywordflow">raise</span> Exception(<span class="stringliteral">'Missing input files:\n%s'</span> % <span class="stringliteral">'\n'</span>.join(cleaned_up))
<a name="l01059"></a>01059 
<a name="l01060"></a>01060 <span class="comment"># Sets some values in default_variables, which are required for many</span>
<a name="l01061"></a>01061 <span class="comment"># generators, run on Windows.</span>
<a name="l01062"></a><a class="code" href="../../d1/ddf/namespacegyp_1_1msvs__emulation.html#a70919293f2f9251bd0311d42fdbcdc2">01062</a> <span class="keyword">def </span><a class="code" href="../../d1/ddf/namespacegyp_1_1msvs__emulation.html#a70919293f2f9251bd0311d42fdbcdc2">CalculateCommonVariables</a>(default_variables, params):
<a name="l01063"></a>01063   generator_flags = params.get(<span class="stringliteral">'generator_flags'</span>, {})
<a name="l01064"></a>01064 
<a name="l01065"></a>01065   <span class="comment"># Set a variable so conditions can be based on msvs_version.</span>
<a name="l01066"></a>01066   msvs_version = gyp.msvs_emulation.GetVSVersion(generator_flags)
<a name="l01067"></a>01067   default_variables[<span class="stringliteral">'MSVS_VERSION'</span>] = msvs_version.ShortName()
<a name="l01068"></a>01068 
<a name="l01069"></a>01069   <span class="comment"># To determine processor word size on Windows, in addition to checking</span>
<a name="l01070"></a>01070   <span class="comment"># PROCESSOR_ARCHITECTURE (which reflects the word size of the current</span>
<a name="l01071"></a>01071   <span class="comment"># process), it is also necessary to check PROCESSOR_ARCHITEW6432 (which</span>
<a name="l01072"></a>01072   <span class="comment"># contains the actual word size of the system when running thru WOW64).</span>
<a name="l01073"></a>01073   <span class="keywordflow">if</span> (<span class="stringliteral">'64'</span> <span class="keywordflow">in</span> os.environ.get(<span class="stringliteral">'PROCESSOR_ARCHITECTURE'</span>, <span class="stringliteral">''</span>) <span class="keywordflow">or</span>
<a name="l01074"></a>01074       <span class="stringliteral">'64'</span> <span class="keywordflow">in</span> os.environ.get(<span class="stringliteral">'PROCESSOR_ARCHITEW6432'</span>, <span class="stringliteral">''</span>)):
<a name="l01075"></a>01075     default_variables[<span class="stringliteral">'MSVS_OS_BITS'</span>] = 64
<a name="l01076"></a>01076   <span class="keywordflow">else</span>:
<a name="l01077"></a>01077     default_variables[<span class="stringliteral">'MSVS_OS_BITS'</span>] = 32
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Wed Oct 7 19:26:26 2015 for Emeraldion Lodge (codename Zelda) by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.8 </small></address>
</body>
</html>
