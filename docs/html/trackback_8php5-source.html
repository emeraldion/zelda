<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Emeraldion Lodge (codename Zelda): /Users/delphine/Sviluppo/SVN/emeraldion.it/zelda/helpers/trackback.php Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.5 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="classes.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
<h1>/Users/delphine/Sviluppo/SVN/emeraldion.it/zelda/helpers/trackback.php</h1><a href="trackback_8php5.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00002"></a>00002 
<a name="l00028"></a><a class="code" href="class_trackback.html">00028</a> <span class="keyword">class </span><a class="code" href="class_trackback.html">Trackback</a> {
<a name="l00029"></a><a class="code" href="class_trackback.html#250a30d93aa6aa3a4cf4a42a9cc4468e">00029</a>     var <a class="code" href="class_trackback.html#250a30d93aa6aa3a4cf4a42a9cc4468e">$blog_name</a> = <span class="stringliteral">''</span>; <span class="comment">// Default blog name used throughout the class (ie. BLOGish)</span>
<a name="l00030"></a><a class="code" href="class_trackback.html#bbd0454bb2aaffee0eaa237d6f6a5687">00030</a>     var <a class="code" href="class_trackback.html#bbd0454bb2aaffee0eaa237d6f6a5687">$author</a> = <span class="stringliteral">''</span>; <span class="comment">// Default author name used throughout the class (ie. Ran Aroussi)</span>
<a name="l00031"></a><a class="code" href="class_trackback.html#8a029311502ec9bb40b7a270cbb18d84">00031</a>     var <a class="code" href="class_trackback.html#8a029311502ec9bb40b7a270cbb18d84">$encoding</a> = <span class="stringliteral">''</span>; <span class="comment">// Default encoding used throughout the class (ie. UTF-8)</span>
<a name="l00032"></a><a class="code" href="class_trackback.html#dfc27a4935be3b3455dd01626e145657">00032</a>     var <a class="code" href="class_trackback.html#dfc27a4935be3b3455dd01626e145657">$get_id</a> = <span class="stringliteral">''</span>; <span class="comment">// retrieves and holds $_GET['id'] (if not empty)</span>
<a name="l00033"></a><a class="code" href="class_trackback.html#caab909dc4c083674c3e7b169fd1c8cc">00033</a>     var <a class="code" href="class_trackback.html#caab909dc4c083674c3e7b169fd1c8cc">$post_id</a> = <span class="stringliteral">''</span>; <span class="comment">// retrieves and holds $_POST['id'] (if not empty)</span>
<a name="l00034"></a><a class="code" href="class_trackback.html#da964f343107f6dc8bebb82724eb1582">00034</a>     var <a class="code" href="class_trackback.html#da964f343107f6dc8bebb82724eb1582">$url</a> = <span class="stringliteral">''</span>; <span class="comment">// retrieves and holds $_POST['url'] (if not empty)</span>
<a name="l00035"></a><a class="code" href="class_trackback.html#19c2587f2dafee55a2e6f0c7f1abb2a9">00035</a>     var <a class="code" href="class_trackback.html#19c2587f2dafee55a2e6f0c7f1abb2a9">$title</a> = <span class="stringliteral">''</span>; <span class="comment">// retrieves and holds $_POST['title'] (if not empty)</span>
<a name="l00036"></a><a class="code" href="class_trackback.html#a251ffa5ea3394befbaec19b22de2829">00036</a>     var <a class="code" href="class_trackback.html#a251ffa5ea3394befbaec19b22de2829">$excerpt</a> = <span class="stringliteral">''</span>; <span class="comment">// retrieves and holds $_POST['excerpt'] (if not empty)</span>
<a name="l00045"></a><a class="code" href="class_trackback.html#801a698f3e731de59de4d8a8d2c87211">00045</a> <span class="comment"></span>    function <a class="code" href="class_trackback.html#801a698f3e731de59de4d8a8d2c87211">Trackback</a>(<a class="code" href="class_trackback.html#250a30d93aa6aa3a4cf4a42a9cc4468e">$blog_name</a>, <a class="code" href="class_trackback.html#bbd0454bb2aaffee0eaa237d6f6a5687">$author</a>, <a class="code" href="class_trackback.html#8a029311502ec9bb40b7a270cbb18d84">$encoding</a> = <span class="stringliteral">"UTF-8"</span>)
<a name="l00046"></a>00046     {
<a name="l00047"></a>00047         $this-&gt;blog_name = <a class="code" href="class_trackback.html#250a30d93aa6aa3a4cf4a42a9cc4468e">$blog_name</a>;
<a name="l00048"></a>00048         $this-&gt;<a class="code" href="software__quote__delete_8php5.html#1f57fb40ca30995d36b079ab55826ca2">author</a> = <a class="code" href="class_trackback.html#bbd0454bb2aaffee0eaa237d6f6a5687">$author</a>;
<a name="l00049"></a>00049         $this-&gt;encoding = <a class="code" href="class_trackback.html#8a029311502ec9bb40b7a270cbb18d84">$encoding</a>;
<a name="l00050"></a>00050 
<a name="l00051"></a>00051         <span class="comment">// Gather $_POST information</span>
<a name="l00052"></a>00052         <span class="keywordflow">if</span> (isset($_GET[<span class="stringliteral">'id'</span>])) {
<a name="l00053"></a>00053             $this-&gt;get_id = $_GET[<span class="stringliteral">'id'</span>];
<a name="l00054"></a>00054         }
<a name="l00055"></a>00055         <span class="keywordflow">if</span> (isset($_POST[<span class="stringliteral">'id'</span>])) {
<a name="l00056"></a>00056             $this-&gt;post_id = $_POST[<span class="stringliteral">'id'</span>];
<a name="l00057"></a>00057         }
<a name="l00058"></a>00058         <span class="keywordflow">if</span> (isset($_POST[<span class="stringliteral">'url'</span>])) {
<a name="l00059"></a>00059             $this-&gt;url = $_POST[<span class="stringliteral">'url'</span>];
<a name="l00060"></a>00060         }
<a name="l00061"></a>00061         <span class="keywordflow">if</span> (isset($_POST[<span class="stringliteral">'title'</span>])) {
<a name="l00062"></a>00062             $this-&gt;<a class="code" href="diario__pingback__list_8php5.html#674b3f64b4c48bb2d57fe0b6a57f52c8">title</a> = $_POST[<span class="stringliteral">'title'</span>];
<a name="l00063"></a>00063         }
<a name="l00064"></a>00064         <span class="keywordflow">if</span> (isset($_POST[<span class="stringliteral">'excerpt'</span>])) {
<a name="l00065"></a>00065             $this-&gt;excerpt = $_POST[<span class="stringliteral">'excerpt'</span>];
<a name="l00066"></a>00066         }
<a name="l00067"></a>00067     }
<a name="l00068"></a>00068 
<a name="l00089"></a><a class="code" href="class_trackback.html#f449e2a598280b32aa77756f697307f1">00089</a>     function <a class="code" href="class_trackback.html#f449e2a598280b32aa77756f697307f1">ping</a>($tb, <a class="code" href="class_trackback.html#da964f343107f6dc8bebb82724eb1582">$url</a>, <a class="code" href="class_trackback.html#19c2587f2dafee55a2e6f0c7f1abb2a9">$title</a> = <span class="stringliteral">""</span>, <a class="code" href="class_trackback.html#a251ffa5ea3394befbaec19b22de2829">$excerpt</a> = <span class="stringliteral">""</span>)
<a name="l00090"></a>00090     {
<a name="l00091"></a>00091         $response = <span class="stringliteral">""</span>;
<a name="l00092"></a>00092         $reason = <span class="stringliteral">""</span>;
<a name="l00093"></a>00093         <span class="comment">// Set default values</span>
<a name="l00094"></a>00094         <span class="keywordflow">if</span> (empty(<a class="code" href="class_trackback.html#19c2587f2dafee55a2e6f0c7f1abb2a9">$title</a>)) {
<a name="l00095"></a>00095             <a class="code" href="class_trackback.html#19c2587f2dafee55a2e6f0c7f1abb2a9">$title</a> = <span class="stringliteral">"Trackbacking your entry..."</span>;
<a name="l00096"></a>00096         }
<a name="l00097"></a>00097         <span class="keywordflow">if</span> (empty(<a class="code" href="class_trackback.html#a251ffa5ea3394befbaec19b22de2829">$excerpt</a>)) {
<a name="l00098"></a>00098             <a class="code" href="class_trackback.html#a251ffa5ea3394befbaec19b22de2829">$excerpt</a> = <span class="stringliteral">"I found your entry interesting so I've added a Trackback to it on my weblog :)"</span>;
<a name="l00099"></a>00099         }
<a name="l00100"></a>00100         <span class="comment">// Parse the target</span>
<a name="l00101"></a>00101         $target = parse_url($tb);
<a name="l00102"></a>00102 
<a name="l00103"></a>00103         <span class="keywordflow">if</span> ((isset($target[<span class="stringliteral">"query"</span>])) &amp;&amp; ($target[<span class="stringliteral">"query"</span>] != <span class="stringliteral">""</span>)) {
<a name="l00104"></a>00104             $target[<span class="stringliteral">"query"</span>] = <span class="stringliteral">"?"</span> . $target[<span class="stringliteral">"query"</span>];
<a name="l00105"></a>00105         } <span class="keywordflow">else</span> {
<a name="l00106"></a>00106             $target[<span class="stringliteral">"query"</span>] = <span class="stringliteral">""</span>;
<a name="l00107"></a>00107         }
<a name="l00108"></a>00108 
<a name="l00109"></a>00109         <span class="keywordflow">if</span> ((isset($target[<span class="stringliteral">"port"</span>]) &amp;&amp; !is_numeric($target[<span class="stringliteral">"port"</span>])) || (!isset($target[<span class="stringliteral">"port"</span>]))) {
<a name="l00110"></a>00110             $target[<span class="stringliteral">"port"</span>] = 80;
<a name="l00111"></a>00111         }
<a name="l00112"></a>00112         <span class="comment">// Open the socket</span>
<a name="l00113"></a>00113         $tb_sock = fsockopen($target[<span class="stringliteral">"host"</span>], $target[<span class="stringliteral">"port"</span>]);
<a name="l00114"></a>00114         <span class="comment">// Something didn't work out, return</span>
<a name="l00115"></a>00115         <span class="keywordflow">if</span> (!is_resource($tb_sock)) {
<a name="l00116"></a>00116             <span class="keywordflow">return</span> <span class="stringliteral">'$trackback-&gt;ping: can\'t connect to: '</span> . $tb . <span class="charliteral">'.'</span>;
<a name="l00117"></a>00117             exit;
<a name="l00118"></a>00118         }
<a name="l00119"></a>00119         <span class="comment">// Put together the things we want to send</span>
<a name="l00120"></a>00120         $tb_send = <span class="stringliteral">"url="</span> . rawurlencode(<a class="code" href="class_trackback.html#da964f343107f6dc8bebb82724eb1582">$url</a>) . <span class="stringliteral">"&amp;title="</span> . rawurlencode(<a class="code" href="class_trackback.html#19c2587f2dafee55a2e6f0c7f1abb2a9">$title</a>) . <span class="stringliteral">"&amp;blog_name="</span> . rawurlencode($this-&gt;blog_name) . <span class="stringliteral">"&amp;excerpt="</span> . rawurlencode(<a class="code" href="class_trackback.html#a251ffa5ea3394befbaec19b22de2829">$excerpt</a>);
<a name="l00121"></a>00121         <span class="comment">// Send the trackback</span>
<a name="l00122"></a>00122         fputs($tb_sock, <span class="stringliteral">"POST "</span> . $target[<span class="stringliteral">"path"</span>] . $target[<span class="stringliteral">"query"</span>] . <span class="stringliteral">" HTTP/1.1\r\n"</span>);
<a name="l00123"></a>00123         fputs($tb_sock, <span class="stringliteral">"Host: "</span> . $target[<span class="stringliteral">"host"</span>] . <span class="stringliteral">"\r\n"</span>);
<a name="l00124"></a>00124         fputs($tb_sock, <span class="stringliteral">"Content-type: application/x-www-form-urlencoded\r\n"</span>);
<a name="l00125"></a>00125         fputs($tb_sock, <span class="stringliteral">"Content-length: "</span> . strlen($tb_send) . <span class="stringliteral">"\r\n"</span>);
<a name="l00126"></a>00126         fputs($tb_sock, <span class="stringliteral">"Connection: close\r\n\r\n"</span>);
<a name="l00127"></a>00127         fputs($tb_sock, $tb_send);
<a name="l00128"></a>00128         <span class="comment">// Gather result</span>
<a name="l00129"></a>00129         <span class="keywordflow">while</span> (!feof($tb_sock)) {
<a name="l00130"></a>00130             $response .= fgets($tb_sock, 128);
<a name="l00131"></a>00131         }
<a name="l00132"></a>00132         <span class="comment">// Close socket</span>
<a name="l00133"></a>00133         fclose($tb_sock);
<a name="l00134"></a>00134         <span class="comment">// Did the trackback ping work</span>
<a name="l00135"></a>00135         strpos($response, <span class="stringliteral">'&lt;error&gt;0&lt;/error&gt;'</span>) ? $return = <span class="keyword">true</span> : $return = <span class="keyword">false</span>;
<a name="l00136"></a>00136         <span class="comment">// send result</span>
<a name="l00137"></a>00137         <span class="keywordflow">return</span> $return;
<a name="l00138"></a>00138     }
<a name="l00139"></a>00139 
<a name="l00174"></a><a class="code" href="class_trackback.html#208e46154087171204178bb83a7a349f">00174</a>     function <a class="code" href="class_trackback.html#208e46154087171204178bb83a7a349f">receive</a>($success = <span class="keyword">false</span>, $err_response = <span class="stringliteral">""</span>)
<a name="l00175"></a>00175     {
<a name="l00176"></a>00176         <span class="comment">// Default error response in case of problems...</span>
<a name="l00177"></a>00177         <span class="keywordflow">if</span> (!$success &amp;&amp; empty($err_response)) {
<a name="l00178"></a>00178             $err_response = <span class="stringliteral">"An error occured while tring to log your trackback..."</span>;
<a name="l00179"></a>00179         }
<a name="l00180"></a>00180         <span class="comment">// Start response to trackbacker...</span>
<a name="l00181"></a>00181         $return = <span class="stringliteral">'&lt;?xml version="1.0" encoding="'</span> . $this-&gt;encoding . <span class="stringliteral">'"?&gt;'</span> . <span class="stringliteral">"\n"</span>;
<a name="l00182"></a>00182         $return .= <span class="stringliteral">"&lt;response&gt; \n"</span>;
<a name="l00183"></a>00183         <span class="comment">// Send back response...</span>
<a name="l00184"></a>00184         <span class="keywordflow">if</span> ($success) {
<a name="l00185"></a>00185             <span class="comment">// Trackback received successfully...</span>
<a name="l00186"></a>00186             $return .= <span class="stringliteral">"    &lt;error&gt;0&lt;/error&gt; \n"</span>;
<a name="l00187"></a>00187         } <span class="keywordflow">else</span> {
<a name="l00188"></a>00188             <span class="comment">// Something went wrong...</span>
<a name="l00189"></a>00189             $return .= <span class="stringliteral">"    &lt;error&gt;1&lt;/error&gt; \n"</span>;
<a name="l00190"></a>00190             $return .= <span class="stringliteral">"    &lt;message&gt;"</span> . $this-&gt;<a class="code" href="class_trackback.html#720e3a864768a3149047a0aa187c918b">xml_safe</a>($err_response) . <span class="stringliteral">"&lt;/message&gt;\n"</span>;
<a name="l00191"></a>00191         }
<a name="l00192"></a>00192         <span class="comment">// End response to trackbacker...</span>
<a name="l00193"></a>00193         $return .= <span class="stringliteral">"&lt;/response&gt;"</span>;
<a name="l00194"></a>00194 
<a name="l00195"></a>00195         <span class="keywordflow">return</span> $return;
<a name="l00196"></a>00196     }
<a name="l00197"></a>00197 
<a name="l00229"></a><a class="code" href="class_trackback.html#56900316ebaad37a7fdcbbb8a2539ba8">00229</a>     function <a class="code" href="class_trackback.html#56900316ebaad37a7fdcbbb8a2539ba8">fetch</a>($success = <span class="keyword">false</span>, $response = <span class="stringliteral">""</span>)
<a name="l00230"></a>00230     {
<a name="l00231"></a>00231         <span class="keywordflow">if</span> (!$success &amp;&amp; empty($response)) {
<a name="l00232"></a>00232             $response = <span class="stringliteral">"An error occured while tring to retrieve trackback information..."</span>;
<a name="l00233"></a>00233         }
<a name="l00234"></a>00234         <span class="comment">// Start response to caller</span>
<a name="l00235"></a>00235         $return = <span class="stringliteral">'&lt;?xml version="1.0" encoding="'</span> . $this-&gt;encoding . <span class="stringliteral">'"?&gt;'</span> . <span class="stringliteral">"\n"</span>;
<a name="l00236"></a>00236         $return .= <span class="stringliteral">"&lt;response&gt; \n"</span>;
<a name="l00237"></a>00237         <span class="comment">// Send back response...</span>
<a name="l00238"></a>00238         <span class="keywordflow">if</span> ($success) {
<a name="l00239"></a>00239             <span class="comment">// Trackback retrieved successfully...</span>
<a name="l00240"></a>00240             <span class="comment">// Sending back an RSS (0.91) - trackback information from $response (array)...</span>
<a name="l00241"></a>00241             $return .= <span class="stringliteral">"    &lt;error&gt;0&lt;/error&gt; \n"</span>;
<a name="l00242"></a>00242             $return .= <span class="stringliteral">"    &lt;rss version=\"0.91\"&gt; \n"</span>;
<a name="l00243"></a>00243             $return .= <span class="stringliteral">"    &lt;channel&gt; \n"</span>;
<a name="l00244"></a>00244             $return .= <span class="stringliteral">"      &lt;title&gt;"</span> . $this-&gt;<a class="code" href="class_trackback.html#720e3a864768a3149047a0aa187c918b">xml_safe</a>($response[<span class="stringliteral">'title'</span>]) . <span class="stringliteral">"&lt;/title&gt; \n"</span>;
<a name="l00245"></a>00245             $return .= <span class="stringliteral">"      &lt;link&gt;"</span> . $this-&gt;<a class="code" href="class_trackback.html#720e3a864768a3149047a0aa187c918b">xml_safe</a>($response[<span class="stringliteral">'trackback'</span>]) . <span class="stringliteral">"&lt;/link&gt; \n"</span>;
<a name="l00246"></a>00246             $return .= <span class="stringliteral">"      &lt;description&gt;"</span> . $this-&gt;<a class="code" href="class_trackback.html#720e3a864768a3149047a0aa187c918b">xml_safe</a>($response[<span class="stringliteral">'excerpt'</span>]) . <span class="stringliteral">"&lt;/description&gt; \n"</span>;
<a name="l00247"></a>00247             $return .= <span class="stringliteral">"      &lt;item&gt; \n"</span>;
<a name="l00248"></a>00248             $return .= <span class="stringliteral">"        &lt;title&gt;"</span> . $this-&gt;<a class="code" href="class_trackback.html#720e3a864768a3149047a0aa187c918b">xml_safe</a>($response[<span class="stringliteral">'title'</span>]) . <span class="stringliteral">"&lt;/title&gt; \n"</span>;
<a name="l00249"></a>00249             $return .= <span class="stringliteral">"        &lt;link&gt;"</span> . $this-&gt;<a class="code" href="class_trackback.html#720e3a864768a3149047a0aa187c918b">xml_safe</a>($response[<span class="stringliteral">'permalink'</span>]) . <span class="stringliteral">"&lt;/link&gt; \n"</span>;
<a name="l00250"></a>00250             $return .= <span class="stringliteral">"        &lt;description&gt;"</span> . $this-&gt;<a class="code" href="class_trackback.html#720e3a864768a3149047a0aa187c918b">xml_safe</a>($response[<span class="stringliteral">'excerpt'</span>]) . <span class="stringliteral">"&lt;/description&gt; \n"</span>;
<a name="l00251"></a>00251             $return .= <span class="stringliteral">"      &lt;/item&gt; \n"</span>;
<a name="l00252"></a>00252             $return .= <span class="stringliteral">"    &lt;/channel&gt; \n"</span>;
<a name="l00253"></a>00253             $return .= <span class="stringliteral">"    &lt;/rss&gt; \n"</span>;
<a name="l00254"></a>00254         } <span class="keywordflow">else</span> {
<a name="l00255"></a>00255             <span class="comment">// Something went wrong - provide reason from $response (string)...</span>
<a name="l00256"></a>00256             $return .= <span class="stringliteral">"    &lt;error&gt;1&lt;/error&gt; \n"</span>;
<a name="l00257"></a>00257             $return .= <span class="stringliteral">"    &lt;message&gt;"</span> . $this-&gt;<a class="code" href="class_trackback.html#720e3a864768a3149047a0aa187c918b">xml_safe</a>($response) . <span class="stringliteral">"&lt;/message&gt;\n"</span>;
<a name="l00258"></a>00258         }
<a name="l00259"></a>00259         <span class="comment">// End response to trackbacker</span>
<a name="l00260"></a>00260         $return .= <span class="stringliteral">"&lt;/response&gt;"</span>;
<a name="l00261"></a>00261 
<a name="l00262"></a>00262         <span class="keywordflow">return</span> $return;
<a name="l00263"></a>00263     }
<a name="l00264"></a>00264 
<a name="l00286"></a><a class="code" href="class_trackback.html#4725443501f2859436009e57930801a1">00286</a>     function <a class="code" href="class_trackback.html#4725443501f2859436009e57930801a1">rdf_autodiscover</a>($RFC822_date, <a class="code" href="class_trackback.html#19c2587f2dafee55a2e6f0c7f1abb2a9">$title</a>, <a class="code" href="class_trackback.html#a251ffa5ea3394befbaec19b22de2829">$excerpt</a>, $permalink, $trackback, <a class="code" href="class_trackback.html#bbd0454bb2aaffee0eaa237d6f6a5687">$author</a> = <span class="stringliteral">""</span>)
<a name="l00287"></a>00287     {
<a name="l00288"></a>00288         <span class="keywordflow">if</span> (!<a class="code" href="class_trackback.html#bbd0454bb2aaffee0eaa237d6f6a5687">$author</a>) {
<a name="l00289"></a>00289             <a class="code" href="class_trackback.html#bbd0454bb2aaffee0eaa237d6f6a5687">$author</a> = $this-&gt;<a class="code" href="software__quote__delete_8php5.html#1f57fb40ca30995d36b079ab55826ca2">author</a>;
<a name="l00290"></a>00290         }
<a name="l00291"></a>00291 
<a name="l00292"></a>00292         $return = <span class="stringliteral">"&lt;!-- \n"</span>;
<a name="l00293"></a>00293         $return .= <span class="stringliteral">"&lt;rdf:RDF xmlns:rdf=\"http://www.w3.org/1999/02/22-rdf-syntax-ns#\" \n"</span>;
<a name="l00294"></a>00294         $return .= <span class="stringliteral">"    xmlns:dc=\"http://purl.org/dc/elements/1.1/\" \n"</span>;
<a name="l00295"></a>00295         $return .= <span class="stringliteral">"    xmlns:trackback=\"http://madskills.com/public/xml/rss/module/trackback/\"&gt; \n"</span>;
<a name="l00296"></a>00296         $return .= <span class="stringliteral">"&lt;rdf:Description \n"</span>;
<a name="l00297"></a>00297         $return .= <span class="stringliteral">"    rdf:about=\""</span> . $this-&gt;<a class="code" href="class_trackback.html#720e3a864768a3149047a0aa187c918b">xml_safe</a>($permalink) . <span class="stringliteral">"\" \n"</span>;
<a name="l00298"></a>00298         $return .= <span class="stringliteral">"    dc:identifier=\""</span> . $this-&gt;<a class="code" href="class_trackback.html#720e3a864768a3149047a0aa187c918b">xml_safe</a>($permalink) . <span class="stringliteral">"\" \n"</span>;
<a name="l00299"></a>00299         $return .= <span class="stringliteral">"    trackback:ping=\""</span> . $this-&gt;<a class="code" href="class_trackback.html#720e3a864768a3149047a0aa187c918b">xml_safe</a>($trackback) . <span class="stringliteral">"\" \n"</span>;
<a name="l00300"></a>00300         $return .= <span class="stringliteral">"    dc:title=\""</span> . $this-&gt;<a class="code" href="class_trackback.html#720e3a864768a3149047a0aa187c918b">xml_safe</a>(<a class="code" href="class_trackback.html#19c2587f2dafee55a2e6f0c7f1abb2a9">$title</a>) . <span class="stringliteral">"\" \n"</span>;
<a name="l00301"></a>00301         $return .= <span class="stringliteral">"    dc:subject=\"TrackBack\" \n"</span>;
<a name="l00302"></a>00302         $return .= <span class="stringliteral">"    dc:description=\""</span> . $this-&gt;<a class="code" href="class_trackback.html#720e3a864768a3149047a0aa187c918b">xml_safe</a>($this-&gt;<a class="code" href="class_trackback.html#37fae83de966976d25f50689689a33f1">cut_short</a>(<a class="code" href="class_trackback.html#a251ffa5ea3394befbaec19b22de2829">$excerpt</a>)) . <span class="stringliteral">"\" \n"</span>;
<a name="l00303"></a>00303         $return .= <span class="stringliteral">"    dc:creator=\""</span> . $this-&gt;<a class="code" href="class_trackback.html#720e3a864768a3149047a0aa187c918b">xml_safe</a>(<a class="code" href="class_trackback.html#bbd0454bb2aaffee0eaa237d6f6a5687">$author</a>) . <span class="stringliteral">"\" \n"</span>;
<a name="l00304"></a>00304         $return .= <span class="stringliteral">"    dc:date=\""</span> . $RFC822_date . <span class="stringliteral">"\" /&gt; \n"</span>;
<a name="l00305"></a>00305         $return .= <span class="stringliteral">"&lt;/rdf:RDF&gt; \n"</span>;
<a name="l00306"></a>00306         $return .= <span class="stringliteral">"--&gt;  \n"</span>;
<a name="l00307"></a>00307 
<a name="l00308"></a>00308         <span class="keywordflow">return</span> $return;
<a name="l00309"></a>00309     }
<a name="l00310"></a>00310 
<a name="l00340"></a><a class="code" href="class_trackback.html#0fbff16fc6f7b804a5f7d77ec227499a">00340</a>     function <a class="code" href="class_trackback.html#0fbff16fc6f7b804a5f7d77ec227499a">auto_discovery</a>($text)
<a name="l00341"></a>00341     {
<a name="l00342"></a>00342         <span class="comment">// Get a list of UNIQUE links from text...</span>
<a name="l00343"></a>00343         <span class="comment">// ---------------------------------------</span>
<a name="l00344"></a>00344         <span class="comment">// RegExp to look for (0=&gt;link, 4=&gt;host in 'replace')</span>
<a name="l00345"></a>00345         $reg_exp = <span class="stringliteral">"/(http)+(s)?:(\\/\\/)((\\w|\\.)+)(\\/)?(\\S+)?/i"</span>;
<a name="l00346"></a>00346         <span class="comment">// Make sure each link ends with [sapce]</span>
<a name="l00347"></a>00347         $text = eregi_replace(<span class="stringliteral">"www."</span>, <span class="stringliteral">"http://www."</span>, $text);
<a name="l00348"></a>00348         $text = eregi_replace(<span class="stringliteral">"http://http://"</span>, <span class="stringliteral">"http://"</span>, $text);
<a name="l00349"></a>00349         $text = eregi_replace(<span class="stringliteral">"\""</span>, <span class="stringliteral">" \""</span>, $text);
<a name="l00350"></a>00350         $text = eregi_replace(<span class="stringliteral">"'"</span>, <span class="stringliteral">" '"</span>, $text);
<a name="l00351"></a>00351         $text = eregi_replace(<span class="stringliteral">"&gt;"</span>, <span class="stringliteral">" &gt;"</span>, $text);
<a name="l00352"></a>00352         <span class="comment">// Create an array with unique links</span>
<a name="l00353"></a>00353         $uri_array = array();
<a name="l00354"></a>00354         <span class="keywordflow">if</span> (preg_match_all($reg_exp, strip_tags($text, <span class="stringliteral">"&lt;a&gt;"</span>), $array, PREG_PATTERN_ORDER)) {
<a name="l00355"></a>00355             <span class="keywordflow">foreach</span>($array[0] as $key =&gt; $link) {
<a name="l00356"></a>00356                 <span class="keywordflow">foreach</span>((array(<span class="stringliteral">","</span>, <span class="stringliteral">"."</span>, <span class="stringliteral">":"</span>, <span class="stringliteral">";"</span>)) as $t_key =&gt; $t_value) {
<a name="l00357"></a>00357                     $link = trim($link, $t_value);
<a name="l00358"></a>00358                 }
<a name="l00359"></a>00359                 $uri_array[] = ($link);
<a name="l00360"></a>00360             }
<a name="l00361"></a>00361             $uri_array = array_unique($uri_array);
<a name="l00362"></a>00362         }
<a name="l00363"></a>00363         <span class="comment">// Get the trackback URIs from those links...</span>
<a name="l00364"></a>00364         <span class="comment">// ------------------------------------------</span>
<a name="l00365"></a>00365         <span class="comment">// Loop through the URIs array and extract RDF segments</span>
<a name="l00366"></a>00366         $rdf_array = array(); <span class="comment">// &lt;- holds list of RDF segments</span>
<a name="l00367"></a>00367         <span class="keywordflow">foreach</span>($uri_array as $key =&gt; $link) {
<a name="l00368"></a>00368             <span class="keywordflow">if</span> ($link_content = implode(<span class="stringliteral">""</span>, @file($link))) {
<a name="l00369"></a>00369                 preg_match_all(<span class="stringliteral">'/(&lt;rdf:RDF.*?&lt;\/rdf:RDF&gt;)/sm'</span>, $link_content, $link_rdf, PREG_SET_ORDER);
<a name="l00370"></a>00370                 <span class="keywordflow">for</span> (<a class="code" href="__navbar_8php5.html#83018d9153d17d91fbcf3bc10158d34f">$i</a> = 0; <a class="code" href="__navbar_8php5.html#83018d9153d17d91fbcf3bc10158d34f">$i</a> &lt; count($link_rdf); <a class="code" href="__navbar_8php5.html#83018d9153d17d91fbcf3bc10158d34f">$i</a>++) {
<a name="l00371"></a>00371                     <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">'|dc:identifier="'</span> . preg_quote($link) . <span class="stringliteral">'"|ms'</span>, $link_rdf[<a class="code" href="__navbar_8php5.html#83018d9153d17d91fbcf3bc10158d34f">$i</a>][1])) {
<a name="l00372"></a>00372                         $rdf_array[] = trim($link_rdf[$i][1]);
<a name="l00373"></a>00373                     }
<a name="l00374"></a>00374                 }
<a name="l00375"></a>00375             }
<a name="l00376"></a>00376         }
<a name="l00377"></a>00377         <span class="comment">// Loop through the RDFs array and extract trackback URIs</span>
<a name="l00378"></a>00378         $tb_array = array(); <span class="comment">// &lt;- holds list of trackback URIs</span>
<a name="l00379"></a>00379         <span class="keywordflow">if</span> (!empty($rdf_array)) {
<a name="l00380"></a>00380             <span class="keywordflow">for</span> (<a class="code" href="__navbar_8php5.html#83018d9153d17d91fbcf3bc10158d34f">$i</a> = 0; <a class="code" href="__navbar_8php5.html#83018d9153d17d91fbcf3bc10158d34f">$i</a> &lt; count($rdf_array); <a class="code" href="__navbar_8php5.html#83018d9153d17d91fbcf3bc10158d34f">$i</a>++) {
<a name="l00381"></a>00381                 <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">'/trackback:ping="([^"]+)"/'</span>, $rdf_array[<a class="code" href="__navbar_8php5.html#83018d9153d17d91fbcf3bc10158d34f">$i</a>], $array)) {
<a name="l00382"></a>00382                     $tb_array[] = trim($array[1]);
<a name="l00383"></a>00383                 }
<a name="l00384"></a>00384             }
<a name="l00385"></a>00385         }
<a name="l00386"></a>00386         <span class="comment">// Return Trackbacks</span>
<a name="l00387"></a>00387         <span class="keywordflow">return</span> $tb_array;
<a name="l00388"></a>00388     }
<a name="l00389"></a>00389 
<a name="l00400"></a><a class="code" href="class_trackback.html#e0caa8bf5aec3e9309ad35bc03b212ae">00400</a>     function <a class="code" href="class_trackback.html#e0caa8bf5aec3e9309ad35bc03b212ae">RFC822_from_datetime</a>($datetime)
<a name="l00401"></a>00401     {
<a name="l00402"></a>00402         $timestamp = mktime(
<a name="l00403"></a>00403             substr($datetime, 8, 2), substr($datetime, 10, 2), substr($datetime, 12, 2),
<a name="l00404"></a>00404             substr($datetime, 4, 2), substr($datetime, 6, 2), substr($datetime, 0, 4)
<a name="l00405"></a>00405             );
<a name="l00406"></a>00406         <span class="keywordflow">return</span> date(<span class="stringliteral">"r"</span>, $timestamp);
<a name="l00407"></a>00407     }
<a name="l00408"></a>00408 
<a name="l00415"></a><a class="code" href="class_trackback.html#720e3a864768a3149047a0aa187c918b">00415</a>     function <a class="code" href="class_trackback.html#720e3a864768a3149047a0aa187c918b">xml_safe</a>($string)
<a name="l00416"></a>00416     {
<a name="l00417"></a>00417         <span class="keywordflow">return</span> htmlspecialchars($string, ENT_QUOTES);
<a name="l00418"></a>00418     }
<a name="l00419"></a>00419 
<a name="l00427"></a><a class="code" href="class_trackback.html#37fae83de966976d25f50689689a33f1">00427</a>     function <a class="code" href="class_trackback.html#37fae83de966976d25f50689689a33f1">cut_short</a>($string, $max_length = 255)
<a name="l00428"></a>00428     {
<a name="l00429"></a>00429         <span class="keywordflow">if</span> (strlen($string) &gt; $max_length) {
<a name="l00430"></a>00430             $string = substr($string, 0, $max_length) . <span class="stringliteral">'...'</span>;
<a name="l00431"></a>00431         }
<a name="l00432"></a>00432 
<a name="l00433"></a>00433         <span class="keywordflow">return</span> $string;
<a name="l00434"></a>00434     }
<a name="l00435"></a>00435 }
<a name="l00436"></a>00436 
<a name="l00437"></a><a class="code" href="trackback_8php5.html#518e177aec21433b4ff000935e889178">00437</a> function <a class="code" href="trackback_8php5.html#518e177aec21433b4ff000935e889178">technorati_ping</a>($title, $url, $link)
<a name="l00438"></a>00438 {
<a name="l00518"></a>00518         <span class="keywordflow">if</span> (!is_resource($link))
<a name="l00519"></a>00519         {
<a name="l00520"></a>00520                 $link = mysql_link();
<a name="l00521"></a>00521         }
<a name="l00522"></a>00522 
<a name="l00523"></a>00523         $tb = <span class="stringliteral">"http://rpc.technorati.com/rpc/ping"</span>;
<a name="l00524"></a>00524         $response = <span class="stringliteral">""</span>;
<a name="l00525"></a>00525         $reason = <span class="stringliteral">""</span>;
<a name="l00526"></a>00526         <span class="comment">// Set default values</span>
<a name="l00527"></a>00527         <span class="keywordflow">if</span> (empty($title)) {
<a name="l00528"></a>00528                 $title = <span class="stringliteral">"Emeraldion Lodge"</span>;
<a name="l00529"></a>00529         }
<a name="l00530"></a>00530         $target = parse_url($tb);
<a name="l00531"></a>00531 
<a name="l00532"></a>00532         <span class="keywordflow">if</span> ((isset($target[<span class="stringliteral">"query"</span>])) &amp;&amp; ($target[<span class="stringliteral">"query"</span>] != <span class="stringliteral">""</span>)) {
<a name="l00533"></a>00533                 $target[<span class="stringliteral">"query"</span>] = <span class="stringliteral">"?"</span> . $target[<span class="stringliteral">"query"</span>];
<a name="l00534"></a>00534         } <span class="keywordflow">else</span> {
<a name="l00535"></a>00535                 $target[<span class="stringliteral">"query"</span>] = <span class="stringliteral">""</span>;
<a name="l00536"></a>00536         }
<a name="l00537"></a>00537 
<a name="l00538"></a>00538         <span class="keywordflow">if</span> ((isset($target[<span class="stringliteral">"port"</span>]) &amp;&amp; !is_numeric($target[<span class="stringliteral">"port"</span>])) || (!isset($target[<span class="stringliteral">"port"</span>]))) {
<a name="l00539"></a>00539                 $target[<span class="stringliteral">"port"</span>] = 80;
<a name="l00540"></a>00540         }
<a name="l00541"></a>00541         <span class="comment">// Open the socket</span>
<a name="l00542"></a>00542         $tb_sock = fsockopen($target[<span class="stringliteral">"host"</span>], $target[<span class="stringliteral">"port"</span>]);
<a name="l00543"></a>00543         <span class="comment">// Something didn't work out, return</span>
<a name="l00544"></a>00544         <span class="keywordflow">if</span> (!is_resource($tb_sock)) {
<a name="l00545"></a>00545                 <span class="keywordflow">return</span> <span class="stringliteral">'$trackback-&gt;ping: can\'t connect to: '</span> . $tb . <span class="charliteral">'.'</span>;
<a name="l00546"></a>00546                 exit;
<a name="l00547"></a>00547         }
<a name="l00548"></a>00548         <span class="comment">// Put together the things we want to send</span>
<a name="l00549"></a>00549         $tb_send = <span class="stringliteral">"&lt;"</span> . <span class="stringliteral">'?xml version="1.0"?'</span> . <span class="stringliteral">"&gt;\r\n"</span> .                         
<a name="l00550"></a>00550                                 <span class="stringliteral">"&lt;methodCall&gt;\r\n"</span> .
<a name="l00551"></a>00551                                 <span class="stringliteral">"  &lt;methodName&gt;weblogUpdates.ping&lt;/methodName&gt;\r\n"</span> .
<a name="l00552"></a>00552                                 <span class="stringliteral">"  &lt;params&gt;\r\n"</span> .
<a name="l00553"></a>00553                                 <span class="stringliteral">"    &lt;param&gt;\r\n"</span> .
<a name="l00554"></a>00554                                 <span class="stringliteral">"      &lt;value&gt;$title&lt;/value&gt;\r\n"</span> .
<a name="l00555"></a>00555                                 <span class="stringliteral">"    &lt;/param&gt;\r\n"</span> .
<a name="l00556"></a>00556                                 <span class="stringliteral">"    &lt;param&gt;\r\n"</span> .
<a name="l00557"></a>00557                                 <span class="stringliteral">"      &lt;value&gt;$url&lt;/value&gt;\r\n"</span> .
<a name="l00558"></a>00558                                 <span class="stringliteral">"    &lt;/param&gt;\r\n"</span> .
<a name="l00559"></a>00559                                 <span class="stringliteral">"  &lt;/params&gt;\r\n"</span> .
<a name="l00560"></a>00560                                 <span class="stringliteral">"&lt;/methodCall&gt;"</span>;
<a name="l00561"></a>00561         $tb_headers =   <span class="stringliteral">"POST "</span> . $target[<span class="stringliteral">"path"</span>] . $target[<span class="stringliteral">"query"</span>] . <span class="stringliteral">" HTTP/1.0\r\n"</span> .
<a name="l00562"></a>00562                                         <span class="stringliteral">"User-Agent: EmePavilion/2.1 (Atom 0.3; Emeraldion)\r\n"</span> .
<a name="l00563"></a>00563                                         <span class="stringliteral">"Host: "</span> . $target[<span class="stringliteral">"host"</span>] . <span class="stringliteral">"\r\n"</span> .
<a name="l00564"></a>00564                                         <span class="stringliteral">"Content-type: text/xml\r\n"</span> .
<a name="l00565"></a>00565                                         <span class="stringliteral">"Content-length: "</span> . strlen($tb_send);
<a name="l00566"></a>00566 
<a name="l00567"></a>00567         <span class="comment">// Send the trackback</span>
<a name="l00568"></a>00568         fputs($tb_sock, $tb_headers);
<a name="l00569"></a>00569         fputs($tb_sock, <span class="stringliteral">"\r\n\r\n"</span>);
<a name="l00570"></a>00570         fputs($tb_sock, $tb_send);
<a name="l00571"></a>00571         <span class="comment">// Gather result</span>
<a name="l00572"></a>00572         <span class="keywordflow">while</span> (!feof($tb_sock)) {
<a name="l00573"></a>00573                 $response .= fgets($tb_sock, 128);
<a name="l00574"></a>00574         }
<a name="l00575"></a>00575         <span class="comment">// Close socket</span>
<a name="l00576"></a>00576         fclose($tb_sock);
<a name="l00577"></a>00577 
<a name="l00578"></a>00578         <span class="comment">// Did the trackback ping work</span>
<a name="l00579"></a>00579         strpos($response, <span class="stringliteral">'&lt;fault&gt;'</span>) ? $return = <span class="keyword">false</span> : $return = <span class="keyword">true</span>;
<a name="l00580"></a>00580         
<a name="l00581"></a>00581         $query = <span class="stringliteral">"INSERT INTO `out_trackback` (`target`, `headers`, `send`, `response`) VALUES ('"</span> .
<a name="l00582"></a>00582                 mysql_real_escape_string($tb) . <span class="stringliteral">"', '"</span> .
<a name="l00583"></a>00583                 mysql_real_escape_string($tb_headers) . <span class="stringliteral">"', '"</span> .
<a name="l00584"></a>00584                 mysql_real_escape_string($tb_send) . <span class="stringliteral">"', '"</span> .
<a name="l00585"></a>00585                 mysql_real_escape_string($response) . <span class="stringliteral">"')"</span>;
<a name="l00586"></a>00586         mysql_query($query, $link);
<a name="l00587"></a>00587 
<a name="l00588"></a>00588         <span class="comment">// send result</span>
<a name="l00589"></a>00589         <span class="keywordflow">return</span> $return; 
<a name="l00590"></a>00590 }
<a name="l00591"></a>00591 
<a name="l00592"></a>00592 ?&gt;
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Sun May 4 13:26:41 2008 for Emeraldion Lodge (codename Zelda) by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.5 </small></address>
</body>
</html>
