<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Emeraldion Lodge (codename Zelda): /Users/delphine/Development/SVN/emeraldion.it/zelda/node_modules/gulp-sass/node_modules/node-sass/node_modules/node-gyp/gyp/pylib/gyp/generator/xcode.py Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css">
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.8 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="../../main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="../../files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="../../globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>/Users/delphine/Development/SVN/emeraldion.it/zelda/node_modules/gulp-sass/node_modules/node-sass/node_modules/node-gyp/gyp/pylib/gyp/generator/xcode.py</h1><a href="../../d0/d34/xcode_8py.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a><a class="code" href="../../df/dc2/namespacegyp_1_1generator_1_1xcode.html">00001</a> <span class="comment"># Copyright (c) 2012 Google Inc. All rights reserved.</span>
<a name="l00002"></a>00002 <span class="comment"># Use of this source code is governed by a BSD-style license that can be</span>
<a name="l00003"></a>00003 <span class="comment"># found in the LICENSE file.</span>
<a name="l00004"></a>00004 
<a name="l00005"></a>00005 <span class="keyword">import</span> filecmp
<a name="l00006"></a>00006 <span class="keyword">import</span> gyp.common
<a name="l00007"></a>00007 <span class="keyword">import</span> gyp.xcodeproj_file
<a name="l00008"></a>00008 <span class="keyword">import</span> gyp.xcode_ninja
<a name="l00009"></a>00009 <span class="keyword">import</span> errno
<a name="l00010"></a>00010 <span class="keyword">import</span> os
<a name="l00011"></a>00011 <span class="keyword">import</span> sys
<a name="l00012"></a>00012 <span class="keyword">import</span> posixpath
<a name="l00013"></a>00013 <span class="keyword">import</span> re
<a name="l00014"></a>00014 <span class="keyword">import</span> shutil
<a name="l00015"></a>00015 <span class="keyword">import</span> subprocess
<a name="l00016"></a>00016 <span class="keyword">import</span> tempfile
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 <span class="comment"># Project files generated by this module will use _intermediate_var as a</span>
<a name="l00020"></a>00020 <span class="comment"># custom Xcode setting whose value is a DerivedSources-like directory that's</span>
<a name="l00021"></a>00021 <span class="comment"># project-specific and configuration-specific.  The normal choice,</span>
<a name="l00022"></a>00022 <span class="comment"># DERIVED_FILE_DIR, is target-specific, which is thought to be too restrictive</span>
<a name="l00023"></a>00023 <span class="comment"># as it is likely that multiple targets within a single project file will want</span>
<a name="l00024"></a>00024 <span class="comment"># to access the same set of generated files.  The other option,</span>
<a name="l00025"></a>00025 <span class="comment"># PROJECT_DERIVED_FILE_DIR, is unsuitable because while it is project-specific,</span>
<a name="l00026"></a>00026 <span class="comment"># it is not configuration-specific.  INTERMEDIATE_DIR is defined as</span>
<a name="l00027"></a>00027 <span class="comment"># $(PROJECT_DERIVED_FILE_DIR)/$(CONFIGURATION).</span>
<a name="l00028"></a><a class="code" href="../../df/dc2/namespacegyp_1_1generator_1_1xcode.html#31a4c532d0db93f0c6d22b25ee0c843a">00028</a> _intermediate_var = <span class="stringliteral">'INTERMEDIATE_DIR'</span>
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <span class="comment"># SHARED_INTERMEDIATE_DIR is the same, except that it is shared among all</span>
<a name="l00031"></a>00031 <span class="comment"># targets that share the same BUILT_PRODUCTS_DIR.</span>
<a name="l00032"></a><a class="code" href="../../df/dc2/namespacegyp_1_1generator_1_1xcode.html#ba4eeffb9a671e10e163ed592f31e6a1">00032</a> _shared_intermediate_var = <span class="stringliteral">'SHARED_INTERMEDIATE_DIR'</span>
<a name="l00033"></a>00033 
<a name="l00034"></a><a class="code" href="../../df/dc2/namespacegyp_1_1generator_1_1xcode.html#41f38b581f66c4e8768c297bcbc58c08">00034</a> _library_search_paths_var = <span class="stringliteral">'LIBRARY_SEARCH_PATHS'</span>
<a name="l00035"></a>00035 
<a name="l00036"></a><a class="code" href="../../df/dc2/namespacegyp_1_1generator_1_1xcode.html#723b572dde78d9a873e8b0c7936f0624">00036</a> generator_default_variables = {
<a name="l00037"></a>00037   <span class="stringliteral">'EXECUTABLE_PREFIX'</span>: <span class="stringliteral">''</span>,
<a name="l00038"></a>00038   <span class="stringliteral">'EXECUTABLE_SUFFIX'</span>: <span class="stringliteral">''</span>,
<a name="l00039"></a>00039   <span class="stringliteral">'STATIC_LIB_PREFIX'</span>: <span class="stringliteral">'lib'</span>,
<a name="l00040"></a>00040   <span class="stringliteral">'SHARED_LIB_PREFIX'</span>: <span class="stringliteral">'lib'</span>,
<a name="l00041"></a>00041   <span class="stringliteral">'STATIC_LIB_SUFFIX'</span>: <span class="stringliteral">'.a'</span>,
<a name="l00042"></a>00042   <span class="stringliteral">'SHARED_LIB_SUFFIX'</span>: <span class="stringliteral">'.dylib'</span>,
<a name="l00043"></a>00043   <span class="comment"># INTERMEDIATE_DIR is a place for targets to build up intermediate products.</span>
<a name="l00044"></a>00044   <span class="comment"># It is specific to each build environment.  It is only guaranteed to exist</span>
<a name="l00045"></a>00045   <span class="comment"># and be constant within the context of a project, corresponding to a single</span>
<a name="l00046"></a>00046   <span class="comment"># input file.  Some build environments may allow their intermediate directory</span>
<a name="l00047"></a>00047   <span class="comment"># to be shared on a wider scale, but this is not guaranteed.</span>
<a name="l00048"></a>00048   <span class="stringliteral">'INTERMEDIATE_DIR'</span>: <span class="stringliteral">'$(%s)'</span> % _intermediate_var,
<a name="l00049"></a>00049   <span class="stringliteral">'OS'</span>: <span class="stringliteral">'mac'</span>,
<a name="l00050"></a>00050   <span class="stringliteral">'PRODUCT_DIR'</span>: <span class="stringliteral">'$(BUILT_PRODUCTS_DIR)'</span>,
<a name="l00051"></a>00051   <span class="stringliteral">'LIB_DIR'</span>: <span class="stringliteral">'$(BUILT_PRODUCTS_DIR)'</span>,
<a name="l00052"></a>00052   <span class="stringliteral">'RULE_INPUT_ROOT'</span>: <span class="stringliteral">'$(INPUT_FILE_BASE)'</span>,
<a name="l00053"></a>00053   <span class="stringliteral">'RULE_INPUT_EXT'</span>: <span class="stringliteral">'$(INPUT_FILE_SUFFIX)'</span>,
<a name="l00054"></a>00054   <span class="stringliteral">'RULE_INPUT_NAME'</span>: <span class="stringliteral">'$(INPUT_FILE_NAME)'</span>,
<a name="l00055"></a>00055   <span class="stringliteral">'RULE_INPUT_PATH'</span>: <span class="stringliteral">'$(INPUT_FILE_PATH)'</span>,
<a name="l00056"></a>00056   <span class="stringliteral">'RULE_INPUT_DIRNAME'</span>: <span class="stringliteral">'$(INPUT_FILE_DIRNAME)'</span>,
<a name="l00057"></a>00057   <span class="stringliteral">'SHARED_INTERMEDIATE_DIR'</span>: <span class="stringliteral">'$(%s)'</span> % _shared_intermediate_var,
<a name="l00058"></a>00058   <span class="stringliteral">'CONFIGURATION_NAME'</span>: <span class="stringliteral">'$(CONFIGURATION)'</span>,
<a name="l00059"></a>00059 }
<a name="l00060"></a>00060 
<a name="l00061"></a>00061 <span class="comment"># The Xcode-specific sections that hold paths.</span>
<a name="l00062"></a><a class="code" href="../../df/dc2/namespacegyp_1_1generator_1_1xcode.html#1753481de22edc303822a2b99c378ecf">00062</a> generator_additional_path_sections = [
<a name="l00063"></a>00063   <span class="stringliteral">'mac_bundle_resources'</span>,
<a name="l00064"></a>00064   <span class="stringliteral">'mac_framework_headers'</span>,
<a name="l00065"></a>00065   <span class="stringliteral">'mac_framework_private_headers'</span>,
<a name="l00066"></a>00066   <span class="comment"># 'mac_framework_dirs', input already handles _dirs endings.</span>
<a name="l00067"></a>00067 ]
<a name="l00068"></a>00068 
<a name="l00069"></a>00069 <span class="comment"># The Xcode-specific keys that exist on targets and aren't moved down to</span>
<a name="l00070"></a>00070 <span class="comment"># configurations.</span>
<a name="l00071"></a><a class="code" href="../../df/dc2/namespacegyp_1_1generator_1_1xcode.html#e3f6c5e948c3816610850b3c89f2dee4">00071</a> generator_additional_non_configuration_keys = [
<a name="l00072"></a>00072   <span class="stringliteral">'ios_app_extension'</span>,
<a name="l00073"></a>00073   <span class="stringliteral">'ios_watch_app'</span>,
<a name="l00074"></a>00074   <span class="stringliteral">'ios_watchkit_extension'</span>,
<a name="l00075"></a>00075   <span class="stringliteral">'mac_bundle'</span>,
<a name="l00076"></a>00076   <span class="stringliteral">'mac_bundle_resources'</span>,
<a name="l00077"></a>00077   <span class="stringliteral">'mac_framework_headers'</span>,
<a name="l00078"></a>00078   <span class="stringliteral">'mac_framework_private_headers'</span>,
<a name="l00079"></a>00079   <span class="stringliteral">'mac_xctest_bundle'</span>,
<a name="l00080"></a>00080   <span class="stringliteral">'xcode_create_dependents_test_runner'</span>,
<a name="l00081"></a>00081 ]
<a name="l00082"></a>00082 
<a name="l00083"></a>00083 <span class="comment"># We want to let any rules apply to files that are resources also.</span>
<a name="l00084"></a><a class="code" href="../../df/dc2/namespacegyp_1_1generator_1_1xcode.html#e251ca3560612ed2140aea36d2b236fc">00084</a> generator_extra_sources_for_rules = [
<a name="l00085"></a>00085   <span class="stringliteral">'mac_bundle_resources'</span>,
<a name="l00086"></a>00086   <span class="stringliteral">'mac_framework_headers'</span>,
<a name="l00087"></a>00087   <span class="stringliteral">'mac_framework_private_headers'</span>,
<a name="l00088"></a>00088 ]
<a name="l00089"></a>00089 
<a name="l00090"></a>00090 <span class="comment"># Xcode's standard set of library directories, which don't need to be duplicated</span>
<a name="l00091"></a>00091 <span class="comment"># in LIBRARY_SEARCH_PATHS. This list is not exhaustive, but that's okay.</span>
<a name="l00092"></a><a class="code" href="../../df/dc2/namespacegyp_1_1generator_1_1xcode.html#ece1bc14c69e45ff79451e25034d18f6">00092</a> xcode_standard_library_dirs = frozenset([
<a name="l00093"></a>00093   <span class="stringliteral">'$(SDKROOT)/usr/lib'</span>,
<a name="l00094"></a>00094   <span class="stringliteral">'$(SDKROOT)/usr/local/lib'</span>,
<a name="l00095"></a>00095 ])
<a name="l00096"></a>00096 
<a name="l00097"></a><a class="code" href="../../df/dc2/namespacegyp_1_1generator_1_1xcode.html#4e8a7b706cea65b22dbb6d5ea70e5655">00097</a> <span class="keyword">def </span><a class="code" href="../../df/dc2/namespacegyp_1_1generator_1_1xcode.html#4e8a7b706cea65b22dbb6d5ea70e5655">CreateXCConfigurationList</a>(configuration_names):
<a name="l00098"></a>00098   xccl = gyp.xcodeproj_file.XCConfigurationList({<span class="stringliteral">'buildConfigurations'</span>: []})
<a name="l00099"></a>00099   <span class="keywordflow">if</span> len(configuration_names) == 0:
<a name="l00100"></a>00100     configuration_names = [<span class="stringliteral">'Default'</span>]
<a name="l00101"></a>00101   <span class="keywordflow">for</span> configuration_name <span class="keywordflow">in</span> configuration_names:
<a name="l00102"></a>00102     xcbc = gyp.xcodeproj_file.XCBuildConfiguration({
<a name="l00103"></a>00103         <span class="stringliteral">'name'</span>: configuration_name})
<a name="l00104"></a>00104     xccl.AppendProperty(<span class="stringliteral">'buildConfigurations'</span>, xcbc)
<a name="l00105"></a>00105   xccl.SetProperty(<span class="stringliteral">'defaultConfigurationName'</span>, configuration_names[0])
<a name="l00106"></a>00106   <span class="keywordflow">return</span> xccl
<a name="l00107"></a>00107 
<a name="l00108"></a>00108 
<a name="l00109"></a><a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html">00109</a> <span class="keyword">class </span><a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html">XcodeProject</a>(object):
<a name="l00110"></a><a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#c775ee34451fdfa742b318538164070e">00110</a>   <span class="keyword">def </span><a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#c775ee34451fdfa742b318538164070e">__init__</a>(self, gyp_path, path, build_file_dict):
<a name="l00111"></a><a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#31927e603e26724586fab27188c38633">00111</a>     self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#31927e603e26724586fab27188c38633">gyp_path</a> = gyp_path
<a name="l00112"></a><a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#a28dc103258589d9cb421197fe2de90b">00112</a>     self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#a28dc103258589d9cb421197fe2de90b">path</a> = path
<a name="l00113"></a><a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#3cda4e9d60a1bb5c721d972f6031a96d">00113</a>     self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#3cda4e9d60a1bb5c721d972f6031a96d">project</a> = gyp.xcodeproj_file.PBXProject(path=path)
<a name="l00114"></a>00114     projectDirPath = gyp.common.RelativePath(
<a name="l00115"></a>00115                          os.path.dirname(os.path.abspath(self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#31927e603e26724586fab27188c38633">gyp_path</a>)),
<a name="l00116"></a>00116                          os.path.dirname(path) <span class="keywordflow">or</span> <span class="stringliteral">'.'</span>)
<a name="l00117"></a>00117     self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#3cda4e9d60a1bb5c721d972f6031a96d">project</a>.SetProperty(<span class="stringliteral">'projectDirPath'</span>, projectDirPath)
<a name="l00118"></a><a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#75147cff7442b790c2b43374febac34b">00118</a>     self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#75147cff7442b790c2b43374febac34b">project_file</a> = \
<a name="l00119"></a>00119         gyp.xcodeproj_file.XCProjectFile({<span class="stringliteral">'rootObject'</span>: self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#3cda4e9d60a1bb5c721d972f6031a96d">project</a>})
<a name="l00120"></a><a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#9763d4363855ff714d86ff0e7178fcca">00120</a>     self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#9763d4363855ff714d86ff0e7178fcca">build_file_dict</a> = build_file_dict
<a name="l00121"></a>00121 
<a name="l00122"></a>00122     <span class="comment"># TODO(mark): add destructor that cleans up self.path if created_dir is</span>
<a name="l00123"></a>00123     <span class="comment"># True and things didn't complete successfully.  Or do something even</span>
<a name="l00124"></a>00124     <span class="comment"># better with "try"?</span>
<a name="l00125"></a><a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#c985c41e4746caf11c0ecd1db995ea6f">00125</a>     self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#c985c41e4746caf11c0ecd1db995ea6f">created_dir</a> = <span class="keyword">False</span>
<a name="l00126"></a>00126     <span class="keywordflow">try</span>:
<a name="l00127"></a>00127       os.makedirs(self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#a28dc103258589d9cb421197fe2de90b">path</a>)
<a name="l00128"></a>00128       self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#c985c41e4746caf11c0ecd1db995ea6f">created_dir</a> = <span class="keyword">True</span>
<a name="l00129"></a>00129     <span class="keywordflow">except</span> OSError, e:
<a name="l00130"></a>00130       <span class="keywordflow">if</span> e.errno != errno.EEXIST:
<a name="l00131"></a>00131         <span class="keywordflow">raise</span>
<a name="l00132"></a>00132 
<a name="l00133"></a><a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#48cc163c11922b9ab556e6c343abf093">00133</a>   <span class="keyword">def </span><a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#48cc163c11922b9ab556e6c343abf093">Finalize1</a>(self, xcode_targets, serialize_all_tests):
<a name="l00134"></a>00134     <span class="comment"># Collect a list of all of the build configuration names used by the</span>
<a name="l00135"></a>00135     <span class="comment"># various targets in the file.  It is very heavily advised to keep each</span>
<a name="l00136"></a>00136     <span class="comment"># target in an entire project (even across multiple project files) using</span>
<a name="l00137"></a>00137     <span class="comment"># the same set of configuration names.</span>
<a name="l00138"></a>00138     configurations = []
<a name="l00139"></a>00139     <span class="keywordflow">for</span> xct <span class="keywordflow">in</span> self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#3cda4e9d60a1bb5c721d972f6031a96d">project</a>.GetProperty(<span class="stringliteral">'targets'</span>):
<a name="l00140"></a>00140       xccl = xct.GetProperty(<span class="stringliteral">'buildConfigurationList'</span>)
<a name="l00141"></a>00141       xcbcs = xccl.GetProperty(<span class="stringliteral">'buildConfigurations'</span>)
<a name="l00142"></a>00142       <span class="keywordflow">for</span> xcbc <span class="keywordflow">in</span> xcbcs:
<a name="l00143"></a>00143         name = xcbc.GetProperty(<span class="stringliteral">'name'</span>)
<a name="l00144"></a>00144         <span class="keywordflow">if</span> name <span class="keywordflow">not</span> <span class="keywordflow">in</span> configurations:
<a name="l00145"></a>00145           configurations.append(name)
<a name="l00146"></a>00146 
<a name="l00147"></a>00147     <span class="comment"># Replace the XCConfigurationList attached to the PBXProject object with</span>
<a name="l00148"></a>00148     <span class="comment"># a new one specifying all of the configuration names used by the various</span>
<a name="l00149"></a>00149     <span class="comment"># targets.</span>
<a name="l00150"></a>00150     <span class="keywordflow">try</span>:
<a name="l00151"></a>00151       xccl = CreateXCConfigurationList(configurations)
<a name="l00152"></a>00152       self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#3cda4e9d60a1bb5c721d972f6031a96d">project</a>.SetProperty(<span class="stringliteral">'buildConfigurationList'</span>, xccl)
<a name="l00153"></a>00153     <span class="keywordflow">except</span>:
<a name="l00154"></a>00154       sys.stderr.write(<span class="stringliteral">"Problem with gyp file %s\n"</span> % self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#31927e603e26724586fab27188c38633">gyp_path</a>)
<a name="l00155"></a>00155       <span class="keywordflow">raise</span>
<a name="l00156"></a>00156 
<a name="l00157"></a>00157     <span class="comment"># The need for this setting is explained above where _intermediate_var is</span>
<a name="l00158"></a>00158     <span class="comment"># defined.  The comments below about wanting to avoid project-wide build</span>
<a name="l00159"></a>00159     <span class="comment"># settings apply here too, but this needs to be set on a project-wide basis</span>
<a name="l00160"></a>00160     <span class="comment"># so that files relative to the _intermediate_var setting can be displayed</span>
<a name="l00161"></a>00161     <span class="comment"># properly in the Xcode UI.</span>
<a name="l00162"></a>00162     <span class="comment">#</span>
<a name="l00163"></a>00163     <span class="comment"># Note that for configuration-relative files such as anything relative to</span>
<a name="l00164"></a>00164     <span class="comment"># _intermediate_var, for the purposes of UI tree view display, Xcode will</span>
<a name="l00165"></a>00165     <span class="comment"># only resolve the configuration name once, when the project file is</span>
<a name="l00166"></a>00166     <span class="comment"># opened.  If the active build configuration is changed, the project file</span>
<a name="l00167"></a>00167     <span class="comment"># must be closed and reopened if it is desired for the tree view to update.</span>
<a name="l00168"></a>00168     <span class="comment"># This is filed as Apple radar 6588391.</span>
<a name="l00169"></a>00169     xccl.SetBuildSetting(_intermediate_var,
<a name="l00170"></a>00170                          <span class="stringliteral">'$(PROJECT_DERIVED_FILE_DIR)/$(CONFIGURATION)'</span>)
<a name="l00171"></a>00171     xccl.SetBuildSetting(_shared_intermediate_var,
<a name="l00172"></a>00172                          <span class="stringliteral">'$(SYMROOT)/DerivedSources/$(CONFIGURATION)'</span>)
<a name="l00173"></a>00173 
<a name="l00174"></a>00174     <span class="comment"># Set user-specified project-wide build settings and config files.  This</span>
<a name="l00175"></a>00175     <span class="comment"># is intended to be used very sparingly.  Really, almost everything should</span>
<a name="l00176"></a>00176     <span class="comment"># go into target-specific build settings sections.  The project-wide</span>
<a name="l00177"></a>00177     <span class="comment"># settings are only intended to be used in cases where Xcode attempts to</span>
<a name="l00178"></a>00178     <span class="comment"># resolve variable references in a project context as opposed to a target</span>
<a name="l00179"></a>00179     <span class="comment"># context, such as when resolving sourceTree references while building up</span>
<a name="l00180"></a>00180     <span class="comment"># the tree tree view for UI display.</span>
<a name="l00181"></a>00181     <span class="comment"># Any values set globally are applied to all configurations, then any</span>
<a name="l00182"></a>00182     <span class="comment"># per-configuration values are applied.</span>
<a name="l00183"></a>00183     <span class="keywordflow">for</span> xck, xcv <span class="keywordflow">in</span> self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#9763d4363855ff714d86ff0e7178fcca">build_file_dict</a>.get(<span class="stringliteral">'xcode_settings'</span>, {}).iteritems():
<a name="l00184"></a>00184       xccl.SetBuildSetting(xck, xcv)
<a name="l00185"></a>00185     <span class="keywordflow">if</span> <span class="stringliteral">'xcode_config_file'</span> <span class="keywordflow">in</span> self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#9763d4363855ff714d86ff0e7178fcca">build_file_dict</a>:
<a name="l00186"></a>00186       config_ref = self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#3cda4e9d60a1bb5c721d972f6031a96d">project</a>.AddOrGetFileInRootGroup(
<a name="l00187"></a>00187           self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#9763d4363855ff714d86ff0e7178fcca">build_file_dict</a>[<span class="stringliteral">'xcode_config_file'</span>])
<a name="l00188"></a>00188       xccl.SetBaseConfiguration(config_ref)
<a name="l00189"></a>00189     build_file_configurations = self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#9763d4363855ff714d86ff0e7178fcca">build_file_dict</a>.get(<span class="stringliteral">'configurations'</span>, {})
<a name="l00190"></a>00190     <span class="keywordflow">if</span> build_file_configurations:
<a name="l00191"></a>00191       <span class="keywordflow">for</span> config_name <span class="keywordflow">in</span> configurations:
<a name="l00192"></a>00192         build_file_configuration_named = \
<a name="l00193"></a>00193             build_file_configurations.get(config_name, {})
<a name="l00194"></a>00194         <span class="keywordflow">if</span> build_file_configuration_named:
<a name="l00195"></a>00195           xcc = xccl.ConfigurationNamed(config_name)
<a name="l00196"></a>00196           <span class="keywordflow">for</span> xck, xcv <span class="keywordflow">in</span> build_file_configuration_named.get(<span class="stringliteral">'xcode_settings'</span>,
<a name="l00197"></a>00197                                                              {}).iteritems():
<a name="l00198"></a>00198             xcc.SetBuildSetting(xck, xcv)
<a name="l00199"></a>00199           <span class="keywordflow">if</span> <span class="stringliteral">'xcode_config_file'</span> <span class="keywordflow">in</span> build_file_configuration_named:
<a name="l00200"></a>00200             config_ref = self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#3cda4e9d60a1bb5c721d972f6031a96d">project</a>.AddOrGetFileInRootGroup(
<a name="l00201"></a>00201                 build_file_configurations[config_name][<span class="stringliteral">'xcode_config_file'</span>])
<a name="l00202"></a>00202             xcc.SetBaseConfiguration(config_ref)
<a name="l00203"></a>00203 
<a name="l00204"></a>00204     <span class="comment"># Sort the targets based on how they appeared in the input.</span>
<a name="l00205"></a>00205     <span class="comment"># TODO(mark): Like a lot of other things here, this assumes internal</span>
<a name="l00206"></a>00206     <span class="comment"># knowledge of PBXProject - in this case, of its "targets" property.</span>
<a name="l00207"></a>00207 
<a name="l00208"></a>00208     <span class="comment"># ordinary_targets are ordinary targets that are already in the project</span>
<a name="l00209"></a>00209     <span class="comment"># file. run_test_targets are the targets that run unittests and should be</span>
<a name="l00210"></a>00210     <span class="comment"># used for the Run All Tests target.  support_targets are the action/rule</span>
<a name="l00211"></a>00211     <span class="comment"># targets used by GYP file targets, just kept for the assert check.</span>
<a name="l00212"></a>00212     ordinary_targets = []
<a name="l00213"></a>00213     run_test_targets = []
<a name="l00214"></a>00214     support_targets = []
<a name="l00215"></a>00215 
<a name="l00216"></a>00216     <span class="comment"># targets is full list of targets in the project.</span>
<a name="l00217"></a>00217     targets = []
<a name="l00218"></a>00218 
<a name="l00219"></a>00219     <span class="comment"># does the it define it's own "all"?</span>
<a name="l00220"></a>00220     has_custom_all = <span class="keyword">False</span>
<a name="l00221"></a>00221 
<a name="l00222"></a>00222     <span class="comment"># targets_for_all is the list of ordinary_targets that should be listed</span>
<a name="l00223"></a>00223     <span class="comment"># in this project's "All" target.  It includes each non_runtest_target</span>
<a name="l00224"></a>00224     <span class="comment"># that does not have suppress_wildcard set.</span>
<a name="l00225"></a>00225     targets_for_all = []
<a name="l00226"></a>00226 
<a name="l00227"></a>00227     <span class="keywordflow">for</span> target <span class="keywordflow">in</span> self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#9763d4363855ff714d86ff0e7178fcca">build_file_dict</a>[<span class="stringliteral">'targets'</span>]:
<a name="l00228"></a>00228       target_name = target[<span class="stringliteral">'target_name'</span>]
<a name="l00229"></a>00229       toolset = target[<span class="stringliteral">'toolset'</span>]
<a name="l00230"></a>00230       qualified_target = gyp.common.QualifiedTarget(self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#31927e603e26724586fab27188c38633">gyp_path</a>, target_name,
<a name="l00231"></a>00231                                                     toolset)
<a name="l00232"></a>00232       xcode_target = xcode_targets[qualified_target]
<a name="l00233"></a>00233       <span class="comment"># Make sure that the target being added to the sorted list is already in</span>
<a name="l00234"></a>00234       <span class="comment"># the unsorted list.</span>
<a name="l00235"></a>00235       <span class="keyword">assert</span> xcode_target <span class="keywordflow">in</span> self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#3cda4e9d60a1bb5c721d972f6031a96d">project</a>._properties[<span class="stringliteral">'targets'</span>]
<a name="l00236"></a>00236       targets.append(xcode_target)
<a name="l00237"></a>00237       ordinary_targets.append(xcode_target)
<a name="l00238"></a>00238       <span class="keywordflow">if</span> xcode_target.support_target:
<a name="l00239"></a>00239         support_targets.append(xcode_target.support_target)
<a name="l00240"></a>00240         targets.append(xcode_target.support_target)
<a name="l00241"></a>00241 
<a name="l00242"></a>00242       <span class="keywordflow">if</span> <span class="keywordflow">not</span> int(target.get(<span class="stringliteral">'suppress_wildcard'</span>, <span class="keyword">False</span>)):
<a name="l00243"></a>00243         targets_for_all.append(xcode_target)
<a name="l00244"></a>00244 
<a name="l00245"></a>00245       <span class="keywordflow">if</span> target_name.lower() == <span class="stringliteral">'all'</span>:
<a name="l00246"></a>00246         has_custom_all = <span class="keyword">True</span>;
<a name="l00247"></a>00247 
<a name="l00248"></a>00248       <span class="comment"># If this target has a 'run_as' attribute, add its target to the</span>
<a name="l00249"></a>00249       <span class="comment"># targets, and add it to the test targets.</span>
<a name="l00250"></a>00250       <span class="keywordflow">if</span> target.get(<span class="stringliteral">'run_as'</span>):
<a name="l00251"></a>00251         <span class="comment"># Make a target to run something.  It should have one</span>
<a name="l00252"></a>00252         <span class="comment"># dependency, the parent xcode target.</span>
<a name="l00253"></a>00253         xccl = CreateXCConfigurationList(configurations)
<a name="l00254"></a>00254         run_target = gyp.xcodeproj_file.PBXAggregateTarget({
<a name="l00255"></a>00255               <span class="stringliteral">'name'</span>:                   <span class="stringliteral">'Run '</span> + target_name,
<a name="l00256"></a>00256               <span class="stringliteral">'productName'</span>:            xcode_target.GetProperty(<span class="stringliteral">'productName'</span>),
<a name="l00257"></a>00257               <span class="stringliteral">'buildConfigurationList'</span>: xccl,
<a name="l00258"></a>00258             },
<a name="l00259"></a>00259             parent=self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#3cda4e9d60a1bb5c721d972f6031a96d">project</a>)
<a name="l00260"></a>00260         run_target.AddDependency(xcode_target)
<a name="l00261"></a>00261 
<a name="l00262"></a>00262         command = target[<span class="stringliteral">'run_as'</span>]
<a name="l00263"></a>00263         script = <span class="stringliteral">''</span>
<a name="l00264"></a>00264         <span class="keywordflow">if</span> command.get(<span class="stringliteral">'working_directory'</span>):
<a name="l00265"></a>00265           script = script + <span class="stringliteral">'cd "%s"\n'</span> % \
<a name="l00266"></a>00266                    gyp.xcodeproj_file.ConvertVariablesToShellSyntax(
<a name="l00267"></a>00267                        command.get(<span class="stringliteral">'working_directory'</span>))
<a name="l00268"></a>00268 
<a name="l00269"></a>00269         <span class="keywordflow">if</span> command.get(<span class="stringliteral">'environment'</span>):
<a name="l00270"></a>00270           script = script + <span class="stringliteral">"\n"</span>.join(
<a name="l00271"></a>00271             [<span class="stringliteral">'export %s="%s"'</span> %
<a name="l00272"></a>00272              (key, gyp.xcodeproj_file.ConvertVariablesToShellSyntax(val))
<a name="l00273"></a>00273              <span class="keywordflow">for</span> (key, val) <span class="keywordflow">in</span> command.get(<span class="stringliteral">'environment'</span>).iteritems()]) + <span class="stringliteral">"\n"</span>
<a name="l00274"></a>00274 
<a name="l00275"></a>00275         <span class="comment"># Some test end up using sockets, files on disk, etc. and can get</span>
<a name="l00276"></a>00276         <span class="comment"># confused if more then one test runs at a time.  The generator</span>
<a name="l00277"></a>00277         <span class="comment"># flag 'xcode_serialize_all_test_runs' controls the forcing of all</span>
<a name="l00278"></a>00278         <span class="comment"># tests serially.  It defaults to True.  To get serial runs this</span>
<a name="l00279"></a>00279         <span class="comment"># little bit of python does the same as the linux flock utility to</span>
<a name="l00280"></a>00280         <span class="comment"># make sure only one runs at a time.</span>
<a name="l00281"></a>00281         command_prefix = <span class="stringliteral">''</span>
<a name="l00282"></a>00282         <span class="keywordflow">if</span> serialize_all_tests:
<a name="l00283"></a>00283           command_prefix = \
<a name="l00284"></a>00284 <span class="stringliteral">"""python -c "import fcntl, subprocess, sys</span>
<a name="l00285"></a>00285 <span class="stringliteral">file = open('$TMPDIR/GYP_serialize_test_runs', 'a')</span>
<a name="l00286"></a>00286 <span class="stringliteral">fcntl.flock(file.fileno(), fcntl.LOCK_EX)</span>
<a name="l00287"></a>00287 <span class="stringliteral">sys.exit(subprocess.call(sys.argv[1:]))" """</span>
<a name="l00288"></a>00288 
<a name="l00289"></a>00289         <span class="comment"># If we were unable to exec for some reason, we want to exit</span>
<a name="l00290"></a>00290         <span class="comment"># with an error, and fixup variable references to be shell</span>
<a name="l00291"></a>00291         <span class="comment"># syntax instead of xcode syntax.</span>
<a name="l00292"></a>00292         script = script + <span class="stringliteral">'exec '</span> + command_prefix + <span class="stringliteral">'%s\nexit 1\n'</span> % \
<a name="l00293"></a>00293                  gyp.xcodeproj_file.ConvertVariablesToShellSyntax(
<a name="l00294"></a>00294                      gyp.common.EncodePOSIXShellList(command.get(<span class="stringliteral">'action'</span>)))
<a name="l00295"></a>00295 
<a name="l00296"></a>00296         ssbp = gyp.xcodeproj_file.PBXShellScriptBuildPhase({
<a name="l00297"></a>00297               <span class="stringliteral">'shellScript'</span>:      script,
<a name="l00298"></a>00298               <span class="stringliteral">'showEnvVarsInLog'</span>: 0,
<a name="l00299"></a>00299             })
<a name="l00300"></a>00300         run_target.AppendProperty(<span class="stringliteral">'buildPhases'</span>, ssbp)
<a name="l00301"></a>00301 
<a name="l00302"></a>00302         <span class="comment"># Add the run target to the project file.</span>
<a name="l00303"></a>00303         targets.append(run_target)
<a name="l00304"></a>00304         run_test_targets.append(run_target)
<a name="l00305"></a>00305         xcode_target.test_runner = run_target
<a name="l00306"></a>00306 
<a name="l00307"></a>00307 
<a name="l00308"></a>00308     <span class="comment"># Make sure that the list of targets being replaced is the same length as</span>
<a name="l00309"></a>00309     <span class="comment"># the one replacing it, but allow for the added test runner targets.</span>
<a name="l00310"></a>00310     <span class="keyword">assert</span> len(self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#3cda4e9d60a1bb5c721d972f6031a96d">project</a>._properties[<span class="stringliteral">'targets'</span>]) == \
<a name="l00311"></a>00311       len(ordinary_targets) + len(support_targets)
<a name="l00312"></a>00312 
<a name="l00313"></a>00313     self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#3cda4e9d60a1bb5c721d972f6031a96d">project</a>._properties[<span class="stringliteral">'targets'</span>] = targets
<a name="l00314"></a>00314 
<a name="l00315"></a>00315     <span class="comment"># Get rid of unnecessary levels of depth in groups like the Source group.</span>
<a name="l00316"></a>00316     self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#3cda4e9d60a1bb5c721d972f6031a96d">project</a>.RootGroupsTakeOverOnlyChildren(<span class="keyword">True</span>)
<a name="l00317"></a>00317 
<a name="l00318"></a>00318     <span class="comment"># Sort the groups nicely.  Do this after sorting the targets, because the</span>
<a name="l00319"></a>00319     <span class="comment"># Products group is sorted based on the order of the targets.</span>
<a name="l00320"></a>00320     self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#3cda4e9d60a1bb5c721d972f6031a96d">project</a>.SortGroups()
<a name="l00321"></a>00321 
<a name="l00322"></a>00322     <span class="comment"># Create an "All" target if there's more than one target in this project</span>
<a name="l00323"></a>00323     <span class="comment"># file and the project didn't define its own "All" target.  Put a generated</span>
<a name="l00324"></a>00324     <span class="comment"># "All" target first so that people opening up the project for the first</span>
<a name="l00325"></a>00325     <span class="comment"># time will build everything by default.</span>
<a name="l00326"></a>00326     <span class="keywordflow">if</span> len(targets_for_all) &gt; 1 <span class="keywordflow">and</span> <span class="keywordflow">not</span> has_custom_all:
<a name="l00327"></a>00327       xccl = CreateXCConfigurationList(configurations)
<a name="l00328"></a>00328       all_target = gyp.xcodeproj_file.PBXAggregateTarget(
<a name="l00329"></a>00329           {
<a name="l00330"></a>00330             <span class="stringliteral">'buildConfigurationList'</span>: xccl,
<a name="l00331"></a>00331             <span class="stringliteral">'name'</span>:                   <span class="stringliteral">'All'</span>,
<a name="l00332"></a>00332           },
<a name="l00333"></a>00333           parent=self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#3cda4e9d60a1bb5c721d972f6031a96d">project</a>)
<a name="l00334"></a>00334 
<a name="l00335"></a>00335       <span class="keywordflow">for</span> target <span class="keywordflow">in</span> targets_for_all:
<a name="l00336"></a>00336         all_target.AddDependency(target)
<a name="l00337"></a>00337 
<a name="l00338"></a>00338       <span class="comment"># TODO(mark): This is evil because it relies on internal knowledge of</span>
<a name="l00339"></a>00339       <span class="comment"># PBXProject._properties.  It's important to get the "All" target first,</span>
<a name="l00340"></a>00340       <span class="comment"># though.</span>
<a name="l00341"></a>00341       self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#3cda4e9d60a1bb5c721d972f6031a96d">project</a>._properties[<span class="stringliteral">'targets'</span>].insert(0, all_target)
<a name="l00342"></a>00342 
<a name="l00343"></a>00343     <span class="comment"># The same, but for run_test_targets.</span>
<a name="l00344"></a>00344     <span class="keywordflow">if</span> len(run_test_targets) &gt; 1:
<a name="l00345"></a>00345       xccl = CreateXCConfigurationList(configurations)
<a name="l00346"></a>00346       run_all_tests_target = gyp.xcodeproj_file.PBXAggregateTarget(
<a name="l00347"></a>00347           {
<a name="l00348"></a>00348             <span class="stringliteral">'buildConfigurationList'</span>: xccl,
<a name="l00349"></a>00349             <span class="stringliteral">'name'</span>:                   <span class="stringliteral">'Run All Tests'</span>,
<a name="l00350"></a>00350           },
<a name="l00351"></a>00351           parent=self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#3cda4e9d60a1bb5c721d972f6031a96d">project</a>)
<a name="l00352"></a>00352       <span class="keywordflow">for</span> run_test_target <span class="keywordflow">in</span> run_test_targets:
<a name="l00353"></a>00353         run_all_tests_target.AddDependency(run_test_target)
<a name="l00354"></a>00354 
<a name="l00355"></a>00355       <span class="comment"># Insert after the "All" target, which must exist if there is more than</span>
<a name="l00356"></a>00356       <span class="comment"># one run_test_target.</span>
<a name="l00357"></a>00357       self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#3cda4e9d60a1bb5c721d972f6031a96d">project</a>._properties[<span class="stringliteral">'targets'</span>].insert(1, run_all_tests_target)
<a name="l00358"></a>00358 
<a name="l00359"></a><a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#16a124e39f62e4b5fdc893c9fc85104d">00359</a>   <span class="keyword">def </span><a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#16a124e39f62e4b5fdc893c9fc85104d">Finalize2</a>(self, xcode_targets, xcode_target_to_target_dict):
<a name="l00360"></a>00360     <span class="comment"># Finalize2 needs to happen in a separate step because the process of</span>
<a name="l00361"></a>00361     <span class="comment"># updating references to other projects depends on the ordering of targets</span>
<a name="l00362"></a>00362     <span class="comment"># within remote project files.  Finalize1 is responsible for sorting duty,</span>
<a name="l00363"></a>00363     <span class="comment"># and once all project files are sorted, Finalize2 can come in and update</span>
<a name="l00364"></a>00364     <span class="comment"># these references.</span>
<a name="l00365"></a>00365 
<a name="l00366"></a>00366     <span class="comment"># To support making a "test runner" target that will run all the tests</span>
<a name="l00367"></a>00367     <span class="comment"># that are direct dependents of any given target, we look for</span>
<a name="l00368"></a>00368     <span class="comment"># xcode_create_dependents_test_runner being set on an Aggregate target,</span>
<a name="l00369"></a>00369     <span class="comment"># and generate a second target that will run the tests runners found under</span>
<a name="l00370"></a>00370     <span class="comment"># the marked target.</span>
<a name="l00371"></a>00371     <span class="keywordflow">for</span> bf_tgt <span class="keywordflow">in</span> self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#9763d4363855ff714d86ff0e7178fcca">build_file_dict</a>[<span class="stringliteral">'targets'</span>]:
<a name="l00372"></a>00372       <span class="keywordflow">if</span> int(bf_tgt.get(<span class="stringliteral">'xcode_create_dependents_test_runner'</span>, 0)):
<a name="l00373"></a>00373         tgt_name = bf_tgt[<span class="stringliteral">'target_name'</span>]
<a name="l00374"></a>00374         toolset = bf_tgt[<span class="stringliteral">'toolset'</span>]
<a name="l00375"></a>00375         qualified_target = gyp.common.QualifiedTarget(self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#31927e603e26724586fab27188c38633">gyp_path</a>,
<a name="l00376"></a>00376                                                       tgt_name, toolset)
<a name="l00377"></a>00377         xcode_target = xcode_targets[qualified_target]
<a name="l00378"></a>00378         <span class="keywordflow">if</span> isinstance(xcode_target, gyp.xcodeproj_file.PBXAggregateTarget):
<a name="l00379"></a>00379           <span class="comment"># Collect all the run test targets.</span>
<a name="l00380"></a>00380           all_run_tests = []
<a name="l00381"></a>00381           pbxtds = xcode_target.GetProperty(<span class="stringliteral">'dependencies'</span>)
<a name="l00382"></a>00382           <span class="keywordflow">for</span> pbxtd <span class="keywordflow">in</span> pbxtds:
<a name="l00383"></a>00383             pbxcip = pbxtd.GetProperty(<span class="stringliteral">'targetProxy'</span>)
<a name="l00384"></a>00384             dependency_xct = pbxcip.GetProperty(<span class="stringliteral">'remoteGlobalIDString'</span>)
<a name="l00385"></a>00385             <span class="keywordflow">if</span> hasattr(dependency_xct, <span class="stringliteral">'test_runner'</span>):
<a name="l00386"></a>00386               all_run_tests.append(dependency_xct.test_runner)
<a name="l00387"></a>00387 
<a name="l00388"></a>00388           <span class="comment"># Directly depend on all the runners as they depend on the target</span>
<a name="l00389"></a>00389           <span class="comment"># that builds them.</span>
<a name="l00390"></a>00390           <span class="keywordflow">if</span> len(all_run_tests) &gt; 0:
<a name="l00391"></a>00391             run_all_target = gyp.xcodeproj_file.PBXAggregateTarget({
<a name="l00392"></a>00392                   <span class="stringliteral">'name'</span>:        <span class="stringliteral">'Run %s Tests'</span> % tgt_name,
<a name="l00393"></a>00393                   <span class="stringliteral">'productName'</span>: tgt_name,
<a name="l00394"></a>00394                 },
<a name="l00395"></a>00395                 parent=self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#3cda4e9d60a1bb5c721d972f6031a96d">project</a>)
<a name="l00396"></a>00396             <span class="keywordflow">for</span> run_test_target <span class="keywordflow">in</span> all_run_tests:
<a name="l00397"></a>00397               run_all_target.AddDependency(run_test_target)
<a name="l00398"></a>00398 
<a name="l00399"></a>00399             <span class="comment"># Insert the test runner after the related target.</span>
<a name="l00400"></a>00400             idx = self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#3cda4e9d60a1bb5c721d972f6031a96d">project</a>._properties[<span class="stringliteral">'targets'</span>].index(xcode_target)
<a name="l00401"></a>00401             self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#3cda4e9d60a1bb5c721d972f6031a96d">project</a>._properties[<span class="stringliteral">'targets'</span>].insert(idx + 1, run_all_target)
<a name="l00402"></a>00402 
<a name="l00403"></a>00403     <span class="comment"># Update all references to other projects, to make sure that the lists of</span>
<a name="l00404"></a>00404     <span class="comment"># remote products are complete.  Otherwise, Xcode will fill them in when</span>
<a name="l00405"></a>00405     <span class="comment"># it opens the project file, which will result in unnecessary diffs.</span>
<a name="l00406"></a>00406     <span class="comment"># TODO(mark): This is evil because it relies on internal knowledge of</span>
<a name="l00407"></a>00407     <span class="comment"># PBXProject._other_pbxprojects.</span>
<a name="l00408"></a>00408     <span class="keywordflow">for</span> other_pbxproject <span class="keywordflow">in</span> self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#3cda4e9d60a1bb5c721d972f6031a96d">project</a>._other_pbxprojects.keys():
<a name="l00409"></a>00409       self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#3cda4e9d60a1bb5c721d972f6031a96d">project</a>.AddOrGetProjectReference(other_pbxproject)
<a name="l00410"></a>00410 
<a name="l00411"></a>00411     self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#3cda4e9d60a1bb5c721d972f6031a96d">project</a>.SortRemoteProductReferences()
<a name="l00412"></a>00412 
<a name="l00413"></a>00413     <span class="comment"># Give everything an ID.</span>
<a name="l00414"></a>00414     self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#75147cff7442b790c2b43374febac34b">project_file</a>.ComputeIDs()
<a name="l00415"></a>00415 
<a name="l00416"></a>00416     <span class="comment"># Make sure that no two objects in the project file have the same ID.  If</span>
<a name="l00417"></a>00417     <span class="comment"># multiple objects wind up with the same ID, upon loading the file, Xcode</span>
<a name="l00418"></a>00418     <span class="comment"># will only recognize one object (the last one in the file?) and the</span>
<a name="l00419"></a>00419     <span class="comment"># results are unpredictable.</span>
<a name="l00420"></a>00420     self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#75147cff7442b790c2b43374febac34b">project_file</a>.EnsureNoIDCollisions()
<a name="l00421"></a>00421 
<a name="l00422"></a><a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#fe042a271bd4d82d7c52a0a87e60f60a">00422</a>   <span class="keyword">def </span><a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#fe042a271bd4d82d7c52a0a87e60f60a">Write</a>(self):
<a name="l00423"></a>00423     <span class="comment"># Write the project file to a temporary location first.  Xcode watches for</span>
<a name="l00424"></a>00424     <span class="comment"># changes to the project file and presents a UI sheet offering to reload</span>
<a name="l00425"></a>00425     <span class="comment"># the project when it does change.  However, in some cases, especially when</span>
<a name="l00426"></a>00426     <span class="comment"># multiple projects are open or when Xcode is busy, things don't work so</span>
<a name="l00427"></a>00427     <span class="comment"># seamlessly.  Sometimes, Xcode is able to detect that a project file has</span>
<a name="l00428"></a>00428     <span class="comment"># changed but can't unload it because something else is referencing it.</span>
<a name="l00429"></a>00429     <span class="comment"># To mitigate this problem, and to avoid even having Xcode present the UI</span>
<a name="l00430"></a>00430     <span class="comment"># sheet when an open project is rewritten for inconsequential changes, the</span>
<a name="l00431"></a>00431     <span class="comment"># project file is written to a temporary file in the xcodeproj directory</span>
<a name="l00432"></a>00432     <span class="comment"># first.  The new temporary file is then compared to the existing project</span>
<a name="l00433"></a>00433     <span class="comment"># file, if any.  If they differ, the new file replaces the old; otherwise,</span>
<a name="l00434"></a>00434     <span class="comment"># the new project file is simply deleted.  Xcode properly detects a file</span>
<a name="l00435"></a>00435     <span class="comment"># being renamed over an open project file as a change and so it remains</span>
<a name="l00436"></a>00436     <span class="comment"># able to present the "project file changed" sheet under this system.</span>
<a name="l00437"></a>00437     <span class="comment"># Writing to a temporary file first also avoids the possible problem of</span>
<a name="l00438"></a>00438     <span class="comment"># Xcode rereading an incomplete project file.</span>
<a name="l00439"></a>00439     (output_fd, new_pbxproj_path) = \
<a name="l00440"></a>00440         tempfile.mkstemp(suffix=<span class="stringliteral">'.tmp'</span>, prefix=<span class="stringliteral">'project.pbxproj.gyp.'</span>,
<a name="l00441"></a>00441                          dir=self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#a28dc103258589d9cb421197fe2de90b">path</a>)
<a name="l00442"></a>00442 
<a name="l00443"></a>00443     <span class="keywordflow">try</span>:
<a name="l00444"></a>00444       output_file = os.fdopen(output_fd, <span class="stringliteral">'wb'</span>)
<a name="l00445"></a>00445 
<a name="l00446"></a>00446       self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#75147cff7442b790c2b43374febac34b">project_file</a>.Print(output_file)
<a name="l00447"></a>00447       output_file.close()
<a name="l00448"></a>00448 
<a name="l00449"></a>00449       pbxproj_path = os.path.join(self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#a28dc103258589d9cb421197fe2de90b">path</a>, <span class="stringliteral">'project.pbxproj'</span>)
<a name="l00450"></a>00450 
<a name="l00451"></a>00451       same = <span class="keyword">False</span>
<a name="l00452"></a>00452       <span class="keywordflow">try</span>:
<a name="l00453"></a>00453         same = filecmp.cmp(pbxproj_path, new_pbxproj_path, <span class="keyword">False</span>)
<a name="l00454"></a>00454       <span class="keywordflow">except</span> OSError, e:
<a name="l00455"></a>00455         <span class="keywordflow">if</span> e.errno != errno.ENOENT:
<a name="l00456"></a>00456           <span class="keywordflow">raise</span>
<a name="l00457"></a>00457 
<a name="l00458"></a>00458       <span class="keywordflow">if</span> same:
<a name="l00459"></a>00459         <span class="comment"># The new file is identical to the old one, just get rid of the new</span>
<a name="l00460"></a>00460         <span class="comment"># one.</span>
<a name="l00461"></a>00461         os.unlink(new_pbxproj_path)
<a name="l00462"></a>00462       <span class="keywordflow">else</span>:
<a name="l00463"></a>00463         <span class="comment"># The new file is different from the old one, or there is no old one.</span>
<a name="l00464"></a>00464         <span class="comment"># Rename the new file to the permanent name.</span>
<a name="l00465"></a>00465         <span class="comment">#</span>
<a name="l00466"></a>00466         <span class="comment"># tempfile.mkstemp uses an overly restrictive mode, resulting in a</span>
<a name="l00467"></a>00467         <span class="comment"># file that can only be read by the owner, regardless of the umask.</span>
<a name="l00468"></a>00468         <span class="comment"># There's no reason to not respect the umask here, which means that</span>
<a name="l00469"></a>00469         <span class="comment"># an extra hoop is required to fetch it and reset the new file's mode.</span>
<a name="l00470"></a>00470         <span class="comment">#</span>
<a name="l00471"></a>00471         <span class="comment"># No way to get the umask without setting a new one?  Set a safe one</span>
<a name="l00472"></a>00472         <span class="comment"># and then set it back to the old value.</span>
<a name="l00473"></a>00473         umask = os.umask(077)
<a name="l00474"></a>00474         os.umask(umask)
<a name="l00475"></a>00475 
<a name="l00476"></a>00476         os.chmod(new_pbxproj_path, 0666 &amp; ~umask)
<a name="l00477"></a>00477         os.rename(new_pbxproj_path, pbxproj_path)
<a name="l00478"></a>00478 
<a name="l00479"></a>00479     <span class="keywordflow">except</span> Exception:
<a name="l00480"></a>00480       <span class="comment"># Don't leave turds behind.  In fact, if this code was responsible for</span>
<a name="l00481"></a>00481       <span class="comment"># creating the xcodeproj directory, get rid of that too.</span>
<a name="l00482"></a>00482       os.unlink(new_pbxproj_path)
<a name="l00483"></a>00483       <span class="keywordflow">if</span> self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#c985c41e4746caf11c0ecd1db995ea6f">created_dir</a>:
<a name="l00484"></a>00484         shutil.rmtree(self.<a class="code" href="../../d8/d91/classgyp_1_1generator_1_1xcode_1_1_xcode_project.html#a28dc103258589d9cb421197fe2de90b">path</a>, <span class="keyword">True</span>)
<a name="l00485"></a>00485       <span class="keywordflow">raise</span>
<a name="l00486"></a>00486 
<a name="l00487"></a>00487 
<a name="l00488"></a><a class="code" href="../../df/dc2/namespacegyp_1_1generator_1_1xcode.html#eb78e1d28205a73834b5d360545f8d3d">00488</a> <span class="keyword">def </span><a class="code" href="../../df/dc2/namespacegyp_1_1generator_1_1xcode.html#eb78e1d28205a73834b5d360545f8d3d">AddSourceToTarget</a>(source, type, pbxp, xct):
<a name="l00489"></a>00489   <span class="comment"># TODO(mark): Perhaps source_extensions and library_extensions can be made a</span>
<a name="l00490"></a>00490   <span class="comment"># little bit fancier.</span>
<a name="l00491"></a>00491   source_extensions = [<span class="stringliteral">'c'</span>, <span class="stringliteral">'cc'</span>, <span class="stringliteral">'cpp'</span>, <span class="stringliteral">'cxx'</span>, <span class="stringliteral">'m'</span>, <span class="stringliteral">'mm'</span>, <span class="stringliteral">'s'</span>, <span class="stringliteral">'swift'</span>]
<a name="l00492"></a>00492 
<a name="l00493"></a>00493   <span class="comment"># .o is conceptually more of a "source" than a "library," but Xcode thinks</span>
<a name="l00494"></a>00494   <span class="comment"># of "sources" as things to compile and "libraries" (or "frameworks") as</span>
<a name="l00495"></a>00495   <span class="comment"># things to link with. Adding an object file to an Xcode target's frameworks</span>
<a name="l00496"></a>00496   <span class="comment"># phase works properly.</span>
<a name="l00497"></a>00497   library_extensions = [<span class="stringliteral">'a'</span>, <span class="stringliteral">'dylib'</span>, <span class="stringliteral">'framework'</span>, <span class="stringliteral">'o'</span>]
<a name="l00498"></a>00498 
<a name="l00499"></a>00499   basename = posixpath.basename(source)
<a name="l00500"></a>00500   (root, ext) = posixpath.splitext(basename)
<a name="l00501"></a>00501   <span class="keywordflow">if</span> ext:
<a name="l00502"></a>00502     ext = ext[1:].lower()
<a name="l00503"></a>00503 
<a name="l00504"></a>00504   <span class="keywordflow">if</span> ext <span class="keywordflow">in</span> source_extensions <span class="keywordflow">and</span> type != <span class="stringliteral">'none'</span>:
<a name="l00505"></a>00505     xct.SourcesPhase().AddFile(source)
<a name="l00506"></a>00506   <span class="keywordflow">elif</span> ext <span class="keywordflow">in</span> library_extensions <span class="keywordflow">and</span> type != <span class="stringliteral">'none'</span>:
<a name="l00507"></a>00507     xct.FrameworksPhase().AddFile(source)
<a name="l00508"></a>00508   <span class="keywordflow">else</span>:
<a name="l00509"></a>00509     <span class="comment"># Files that aren't added to a sources or frameworks build phase can still</span>
<a name="l00510"></a>00510     <span class="comment"># go into the project file, just not as part of a build phase.</span>
<a name="l00511"></a>00511     pbxp.AddOrGetFileInRootGroup(source)
<a name="l00512"></a>00512 
<a name="l00513"></a>00513 
<a name="l00514"></a><a class="code" href="../../df/dc2/namespacegyp_1_1generator_1_1xcode.html#e42c70d680c514d98578de239a3be4fa">00514</a> <span class="keyword">def </span><a class="code" href="../../df/dc2/namespacegyp_1_1generator_1_1xcode.html#e42c70d680c514d98578de239a3be4fa">AddResourceToTarget</a>(resource, pbxp, xct):
<a name="l00515"></a>00515   <span class="comment"># TODO(mark): Combine with AddSourceToTarget above?  Or just inline this call</span>
<a name="l00516"></a>00516   <span class="comment"># where it's used.</span>
<a name="l00517"></a>00517   xct.ResourcesPhase().AddFile(resource)
<a name="l00518"></a>00518 
<a name="l00519"></a>00519 
<a name="l00520"></a><a class="code" href="../../df/dc2/namespacegyp_1_1generator_1_1xcode.html#6f61dc7353bd22ef0d79744037cfaa38">00520</a> <span class="keyword">def </span><a class="code" href="../../df/dc2/namespacegyp_1_1generator_1_1xcode.html#6f61dc7353bd22ef0d79744037cfaa38">AddHeaderToTarget</a>(header, pbxp, xct, is_public):
<a name="l00521"></a>00521   <span class="comment"># TODO(mark): Combine with AddSourceToTarget above?  Or just inline this call</span>
<a name="l00522"></a>00522   <span class="comment"># where it's used.</span>
<a name="l00523"></a>00523   settings = <span class="stringliteral">'{ATTRIBUTES = (%s, ); }'</span> % (<span class="stringliteral">'Private'</span>, <span class="stringliteral">'Public'</span>)[is_public]
<a name="l00524"></a>00524   xct.HeadersPhase().AddFile(header, settings)
<a name="l00525"></a>00525 
<a name="l00526"></a>00526 
<a name="l00527"></a><a class="code" href="../../df/dc2/namespacegyp_1_1generator_1_1xcode.html#746186563307e140095a6f5811f3fed9">00527</a> _xcode_variable_re = re.compile(<span class="stringliteral">r'(\$\((.*?)\))'</span>)
<a name="l00528"></a><a class="code" href="../../df/dc2/namespacegyp_1_1generator_1_1xcode.html#775878505288e5f00a1a5769f30177d2">00528</a> <span class="keyword">def </span><a class="code" href="../../df/dc2/namespacegyp_1_1generator_1_1xcode.html#775878505288e5f00a1a5769f30177d2">ExpandXcodeVariables</a>(string, expansions):
<a name="l00529"></a>00529   <span class="stringliteral">"""Expands Xcode-style $(VARIABLES) in string per the expansions dict.</span>
<a name="l00530"></a>00530 <span class="stringliteral"></span>
<a name="l00531"></a>00531 <span class="stringliteral">  In some rare cases, it is appropriate to expand Xcode variables when a</span>
<a name="l00532"></a>00532 <span class="stringliteral">  project file is generated.  For any substring $(VAR) in string, if VAR is a</span>
<a name="l00533"></a>00533 <span class="stringliteral">  key in the expansions dict, $(VAR) will be replaced with expansions[VAR].</span>
<a name="l00534"></a>00534 <span class="stringliteral">  Any $(VAR) substring in string for which VAR is not a key in the expansions</span>
<a name="l00535"></a>00535 <span class="stringliteral">  dict will remain in the returned string.</span>
<a name="l00536"></a>00536 <span class="stringliteral">  """</span>
<a name="l00537"></a>00537 
<a name="l00538"></a>00538   matches = _xcode_variable_re.findall(string)
<a name="l00539"></a>00539   <span class="keywordflow">if</span> matches == <span class="keywordtype">None</span>:
<a name="l00540"></a>00540     <span class="keywordflow">return</span> string
<a name="l00541"></a>00541 
<a name="l00542"></a>00542   matches.reverse()
<a name="l00543"></a>00543   <span class="keywordflow">for</span> match <span class="keywordflow">in</span> matches:
<a name="l00544"></a>00544     (to_replace, variable) = match
<a name="l00545"></a>00545     <span class="keywordflow">if</span> <span class="keywordflow">not</span> variable <span class="keywordflow">in</span> expansions:
<a name="l00546"></a>00546       <span class="keywordflow">continue</span>
<a name="l00547"></a>00547 
<a name="l00548"></a>00548     replacement = expansions[variable]
<a name="l00549"></a>00549     string = re.sub(re.escape(to_replace), replacement, string)
<a name="l00550"></a>00550 
<a name="l00551"></a>00551   <span class="keywordflow">return</span> string
<a name="l00552"></a>00552 
<a name="l00553"></a>00553 
<a name="l00554"></a>00554 _xcode_define_re = re.compile(<span class="stringliteral">r'([\\\"\' ])'</span>)
<a name="l00555"></a>00555 <span class="keyword">def </span>EscapeXcodeDefine(s):
<a name="l00556"></a>00556   <span class="stringliteral">"""We must escape the defines that we give to XCode so that it knows not to</span>
<a name="l00557"></a>00557 <span class="stringliteral">     split on spaces and to respect backslash and quote literals. However, we</span>
<a name="l00558"></a>00558 <span class="stringliteral">     must not quote the define, or Xcode will incorrectly intepret variables</span>
<a name="l00559"></a>00559 <span class="stringliteral">     especially $(inherited)."""</span>
<a name="l00560"></a>00560   <span class="keywordflow">return</span> re.sub(_xcode_define_re, <span class="stringliteral">r'\\\1'</span>, s)
<a name="l00561"></a>00561 
<a name="l00562"></a>00562 
<a name="l00563"></a>00563 <span class="keyword">def </span><a class="code" href="../../dc/d8b/namespacegyp_1_1generator_1_1ninja.html#49c52cae33fdd065ed50b31aacd5dcff">PerformBuild</a>(data, configurations, params):
<a name="l00564"></a>00564   options = params[<span class="stringliteral">'options'</span>]
<a name="l00565"></a>00565 
<a name="l00566"></a>00566   <span class="keywordflow">for</span> build_file, build_file_dict <span class="keywordflow">in</span> data.iteritems():
<a name="l00567"></a>00567     (build_file_root, build_file_ext) = os.path.splitext(build_file)
<a name="l00568"></a>00568     <span class="keywordflow">if</span> build_file_ext != <span class="stringliteral">'.gyp'</span>:
<a name="l00569"></a>00569       <span class="keywordflow">continue</span>
<a name="l00570"></a>00570     xcodeproj_path = build_file_root + options.suffix + <span class="stringliteral">'.xcodeproj'</span>
<a name="l00571"></a>00571     <span class="keywordflow">if</span> options.generator_output:
<a name="l00572"></a>00572       xcodeproj_path = os.path.join(options.generator_output, xcodeproj_path)
<a name="l00573"></a>00573 
<a name="l00574"></a>00574   <span class="keywordflow">for</span> config <span class="keywordflow">in</span> configurations:
<a name="l00575"></a>00575     arguments = [<span class="stringliteral">'xcodebuild'</span>, <span class="stringliteral">'-project'</span>, xcodeproj_path]
<a name="l00576"></a>00576     arguments += [<span class="stringliteral">'-configuration'</span>, config]
<a name="l00577"></a>00577     <span class="keywordflow">print</span> <span class="stringliteral">"Building [%s]: %s"</span> % (config, arguments)
<a name="l00578"></a>00578     subprocess.check_call(arguments)
<a name="l00579"></a>00579 
<a name="l00580"></a>00580 
<a name="l00581"></a>00581 <span class="keyword">def </span><a class="code" href="../../dc/d8b/namespacegyp_1_1generator_1_1ninja.html#61c708adaeb9359fa611b958ad172064">GenerateOutput</a>(target_list, target_dicts, data, params):
<a name="l00582"></a>00582   <span class="comment"># Optionally configure each spec to use ninja as the external builder.</span>
<a name="l00583"></a>00583   ninja_wrapper = params.get(<span class="stringliteral">'flavor'</span>) == <span class="stringliteral">'ninja'</span>
<a name="l00584"></a>00584   <span class="keywordflow">if</span> ninja_wrapper:
<a name="l00585"></a>00585     (target_list, target_dicts, data) = \
<a name="l00586"></a>00586         gyp.xcode_ninja.CreateWrapper(target_list, target_dicts, data, params)
<a name="l00587"></a>00587 
<a name="l00588"></a>00588   options = params[<span class="stringliteral">'options'</span>]
<a name="l00589"></a>00589   generator_flags = params.get(<span class="stringliteral">'generator_flags'</span>, {})
<a name="l00590"></a>00590   parallel_builds = generator_flags.get(<span class="stringliteral">'xcode_parallel_builds'</span>, <span class="keyword">True</span>)
<a name="l00591"></a>00591   serialize_all_tests = \
<a name="l00592"></a>00592       generator_flags.get(<span class="stringliteral">'xcode_serialize_all_test_runs'</span>, <span class="keyword">True</span>)
<a name="l00593"></a>00593   skip_excluded_files = \
<a name="l00594"></a>00594       <span class="keywordflow">not</span> generator_flags.get(<span class="stringliteral">'xcode_list_excluded_files'</span>, <span class="keyword">True</span>)
<a name="l00595"></a>00595   xcode_projects = {}
<a name="l00596"></a>00596   <span class="keywordflow">for</span> build_file, build_file_dict <span class="keywordflow">in</span> data.iteritems():
<a name="l00597"></a>00597     (build_file_root, build_file_ext) = os.path.splitext(build_file)
<a name="l00598"></a>00598     <span class="keywordflow">if</span> build_file_ext != <span class="stringliteral">'.gyp'</span>:
<a name="l00599"></a>00599       <span class="keywordflow">continue</span>
<a name="l00600"></a>00600     xcodeproj_path = build_file_root + options.suffix + <span class="stringliteral">'.xcodeproj'</span>
<a name="l00601"></a>00601     <span class="keywordflow">if</span> options.generator_output:
<a name="l00602"></a>00602       xcodeproj_path = os.path.join(options.generator_output, xcodeproj_path)
<a name="l00603"></a>00603     xcp = XcodeProject(build_file, xcodeproj_path, build_file_dict)
<a name="l00604"></a>00604     xcode_projects[build_file] = xcp
<a name="l00605"></a>00605     pbxp = xcp.project
<a name="l00606"></a>00606 
<a name="l00607"></a>00607     <span class="keywordflow">if</span> parallel_builds:
<a name="l00608"></a>00608       pbxp.SetProperty(<span class="stringliteral">'attributes'</span>,
<a name="l00609"></a>00609                        {<span class="stringliteral">'BuildIndependentTargetsInParallel'</span>: <span class="stringliteral">'YES'</span>})
<a name="l00610"></a>00610 
<a name="l00611"></a>00611     <span class="comment"># Add gyp/gypi files to project</span>
<a name="l00612"></a>00612     <span class="keywordflow">if</span> <span class="keywordflow">not</span> generator_flags.get(<span class="stringliteral">'standalone'</span>):
<a name="l00613"></a>00613       main_group = pbxp.GetProperty(<span class="stringliteral">'mainGroup'</span>)
<a name="l00614"></a>00614       build_group = gyp.xcodeproj_file.PBXGroup({<span class="stringliteral">'name'</span>: <span class="stringliteral">'Build'</span>})
<a name="l00615"></a>00615       main_group.AppendChild(build_group)
<a name="l00616"></a>00616       <span class="keywordflow">for</span> included_file <span class="keywordflow">in</span> build_file_dict[<span class="stringliteral">'included_files'</span>]:
<a name="l00617"></a>00617         build_group.AddOrGetFileByPath(included_file, <span class="keyword">False</span>)
<a name="l00618"></a>00618 
<a name="l00619"></a>00619   xcode_targets = {}
<a name="l00620"></a>00620   xcode_target_to_target_dict = {}
<a name="l00621"></a>00621   <span class="keywordflow">for</span> qualified_target <span class="keywordflow">in</span> target_list:
<a name="l00622"></a>00622     [build_file, target_name, toolset] = \
<a name="l00623"></a>00623         gyp.common.ParseQualifiedTarget(qualified_target)
<a name="l00624"></a>00624 
<a name="l00625"></a>00625     spec = target_dicts[qualified_target]
<a name="l00626"></a>00626     <span class="keywordflow">if</span> spec[<span class="stringliteral">'toolset'</span>] != <span class="stringliteral">'target'</span>:
<a name="l00627"></a>00627       <span class="keywordflow">raise</span> Exception(
<a name="l00628"></a>00628           <span class="stringliteral">'Multiple toolsets not supported in xcode build (target %s)'</span> %
<a name="l00629"></a>00629           qualified_target)
<a name="l00630"></a>00630     configuration_names = [spec[<span class="stringliteral">'default_configuration'</span>]]
<a name="l00631"></a>00631     <span class="keywordflow">for</span> configuration_name <span class="keywordflow">in</span> sorted(spec[<span class="stringliteral">'configurations'</span>].keys()):
<a name="l00632"></a>00632       <span class="keywordflow">if</span> configuration_name <span class="keywordflow">not</span> <span class="keywordflow">in</span> configuration_names:
<a name="l00633"></a>00633         configuration_names.append(configuration_name)
<a name="l00634"></a>00634     xcp = xcode_projects[build_file]
<a name="l00635"></a>00635     pbxp = xcp.project
<a name="l00636"></a>00636 
<a name="l00637"></a>00637     <span class="comment"># Set up the configurations for the target according to the list of names</span>
<a name="l00638"></a>00638     <span class="comment"># supplied.</span>
<a name="l00639"></a>00639     xccl = CreateXCConfigurationList(configuration_names)
<a name="l00640"></a>00640 
<a name="l00641"></a>00641     <span class="comment"># Create an XCTarget subclass object for the target. The type with</span>
<a name="l00642"></a>00642     <span class="comment"># "+bundle" appended will be used if the target has "mac_bundle" set.</span>
<a name="l00643"></a>00643     <span class="comment"># loadable_modules not in a mac_bundle are mapped to</span>
<a name="l00644"></a>00644     <span class="comment"># com.googlecode.gyp.xcode.bundle, a pseudo-type that xcode.py interprets</span>
<a name="l00645"></a>00645     <span class="comment"># to create a single-file mh_bundle.</span>
<a name="l00646"></a>00646     _types = {
<a name="l00647"></a>00647       <span class="stringliteral">'executable'</span>:                  <span class="stringliteral">'com.apple.product-type.tool'</span>,
<a name="l00648"></a>00648       <span class="stringliteral">'loadable_module'</span>:             <span class="stringliteral">'com.googlecode.gyp.xcode.bundle'</span>,
<a name="l00649"></a>00649       <span class="stringliteral">'shared_library'</span>:              <span class="stringliteral">'com.apple.product-type.library.dynamic'</span>,
<a name="l00650"></a>00650       <span class="stringliteral">'static_library'</span>:              <span class="stringliteral">'com.apple.product-type.library.static'</span>,
<a name="l00651"></a>00651       <span class="stringliteral">'executable+bundle'</span>:           <span class="stringliteral">'com.apple.product-type.application'</span>,
<a name="l00652"></a>00652       <span class="stringliteral">'loadable_module+bundle'</span>:      <span class="stringliteral">'com.apple.product-type.bundle'</span>,
<a name="l00653"></a>00653       <span class="stringliteral">'loadable_module+xctest'</span>:      <span class="stringliteral">'com.apple.product-type.bundle.unit-test'</span>,
<a name="l00654"></a>00654       <span class="stringliteral">'shared_library+bundle'</span>:       <span class="stringliteral">'com.apple.product-type.framework'</span>,
<a name="l00655"></a>00655       <span class="stringliteral">'executable+extension+bundle'</span>: <span class="stringliteral">'com.apple.product-type.app-extension'</span>,
<a name="l00656"></a>00656       <span class="stringliteral">'executable+watch+extension+bundle'</span>:
<a name="l00657"></a>00657           <span class="stringliteral">'com.apple.product-type.watchkit-extension'</span>,
<a name="l00658"></a>00658       <span class="stringliteral">'executable+watch+bundle'</span>: <span class="stringliteral">'com.apple.product-type.application.watchapp'</span>,
<a name="l00659"></a>00659     }
<a name="l00660"></a>00660 
<a name="l00661"></a>00661     target_properties = {
<a name="l00662"></a>00662       <span class="stringliteral">'buildConfigurationList'</span>: xccl,
<a name="l00663"></a>00663       <span class="stringliteral">'name'</span>:                   target_name,
<a name="l00664"></a>00664     }
<a name="l00665"></a>00665 
<a name="l00666"></a>00666     type = spec[<span class="stringliteral">'type'</span>]
<a name="l00667"></a>00667     is_xctest = int(spec.get(<span class="stringliteral">'mac_xctest_bundle'</span>, 0))
<a name="l00668"></a>00668     is_bundle = int(spec.get(<span class="stringliteral">'mac_bundle'</span>, 0)) <span class="keywordflow">or</span> is_xctest
<a name="l00669"></a>00669     is_app_extension = int(spec.get(<span class="stringliteral">'ios_app_extension'</span>, 0))
<a name="l00670"></a>00670     is_watchkit_extension = int(spec.get(<span class="stringliteral">'ios_watchkit_extension'</span>, 0))
<a name="l00671"></a>00671     is_watch_app = int(spec.get(<span class="stringliteral">'ios_watch_app'</span>, 0))
<a name="l00672"></a>00672     <span class="keywordflow">if</span> type != <span class="stringliteral">'none'</span>:
<a name="l00673"></a>00673       type_bundle_key = type
<a name="l00674"></a>00674       <span class="keywordflow">if</span> is_xctest:
<a name="l00675"></a>00675         type_bundle_key += <span class="stringliteral">'+xctest'</span>
<a name="l00676"></a>00676         <span class="keyword">assert</span> type == <span class="stringliteral">'loadable_module'</span>, (
<a name="l00677"></a>00677             <span class="stringliteral">'mac_xctest_bundle targets must have type loadable_module '</span>
<a name="l00678"></a>00678             <span class="stringliteral">'(target %s)'</span> % target_name)
<a name="l00679"></a>00679       <span class="keywordflow">elif</span> is_app_extension:
<a name="l00680"></a>00680         <span class="keyword">assert</span> is_bundle, (<span class="stringliteral">'ios_app_extension flag requires mac_bundle '</span>
<a name="l00681"></a>00681             <span class="stringliteral">'(target %s)'</span> % target_name)
<a name="l00682"></a>00682         type_bundle_key += <span class="stringliteral">'+extension+bundle'</span>
<a name="l00683"></a>00683       <span class="keywordflow">elif</span> is_watchkit_extension:
<a name="l00684"></a>00684         <span class="keyword">assert</span> is_bundle, (<span class="stringliteral">'ios_watchkit_extension flag requires mac_bundle '</span>
<a name="l00685"></a>00685             <span class="stringliteral">'(target %s)'</span> % target_name)
<a name="l00686"></a>00686         type_bundle_key += <span class="stringliteral">'+watch+extension+bundle'</span>
<a name="l00687"></a>00687       <span class="keywordflow">elif</span> is_watch_app:
<a name="l00688"></a>00688         <span class="keyword">assert</span> is_bundle, (<span class="stringliteral">'ios_watch_app flag requires mac_bundle '</span>
<a name="l00689"></a>00689             <span class="stringliteral">'(target %s)'</span> % target_name)
<a name="l00690"></a>00690         type_bundle_key += <span class="stringliteral">'+watch+bundle'</span>
<a name="l00691"></a>00691       <span class="keywordflow">elif</span> is_bundle:
<a name="l00692"></a>00692         type_bundle_key += <span class="stringliteral">'+bundle'</span>
<a name="l00693"></a>00693 
<a name="l00694"></a>00694       xctarget_type = gyp.xcodeproj_file.PBXNativeTarget
<a name="l00695"></a>00695       <span class="keywordflow">try</span>:
<a name="l00696"></a>00696         target_properties[<span class="stringliteral">'productType'</span>] = _types[type_bundle_key]
<a name="l00697"></a>00697       <span class="keywordflow">except</span> KeyError, e:
<a name="l00698"></a>00698         gyp.common.ExceptionAppend(e, <span class="stringliteral">"-- unknown product type while "</span>
<a name="l00699"></a>00699                                    <span class="stringliteral">"writing target %s"</span> % target_name)
<a name="l00700"></a>00700         <span class="keywordflow">raise</span>
<a name="l00701"></a>00701     <span class="keywordflow">else</span>:
<a name="l00702"></a>00702       xctarget_type = gyp.xcodeproj_file.PBXAggregateTarget
<a name="l00703"></a>00703       <span class="keyword">assert</span> <span class="keywordflow">not</span> is_bundle, (
<a name="l00704"></a>00704           <span class="stringliteral">'mac_bundle targets cannot have type none (target "%s")'</span> %
<a name="l00705"></a>00705           target_name)
<a name="l00706"></a>00706       <span class="keyword">assert</span> <span class="keywordflow">not</span> is_xctest, (
<a name="l00707"></a>00707           <span class="stringliteral">'mac_xctest_bundle targets cannot have type none (target "%s")'</span> %
<a name="l00708"></a>00708           target_name)
<a name="l00709"></a>00709 
<a name="l00710"></a>00710     target_product_name = spec.get(<span class="stringliteral">'product_name'</span>)
<a name="l00711"></a>00711     <span class="keywordflow">if</span> target_product_name <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:
<a name="l00712"></a>00712       target_properties[<span class="stringliteral">'productName'</span>] = target_product_name
<a name="l00713"></a>00713 
<a name="l00714"></a>00714     xct = xctarget_type(target_properties, parent=pbxp,
<a name="l00715"></a>00715                         force_outdir=spec.get(<span class="stringliteral">'product_dir'</span>),
<a name="l00716"></a>00716                         force_prefix=spec.get(<span class="stringliteral">'product_prefix'</span>),
<a name="l00717"></a>00717                         force_extension=spec.get(<span class="stringliteral">'product_extension'</span>))
<a name="l00718"></a>00718     pbxp.AppendProperty(<span class="stringliteral">'targets'</span>, xct)
<a name="l00719"></a>00719     xcode_targets[qualified_target] = xct
<a name="l00720"></a>00720     xcode_target_to_target_dict[xct] = spec
<a name="l00721"></a>00721 
<a name="l00722"></a>00722     spec_actions = spec.get(<span class="stringliteral">'actions'</span>, [])
<a name="l00723"></a>00723     spec_rules = spec.get(<span class="stringliteral">'rules'</span>, [])
<a name="l00724"></a>00724 
<a name="l00725"></a>00725     <span class="comment"># Xcode has some "issues" with checking dependencies for the "Compile</span>
<a name="l00726"></a>00726     <span class="comment"># sources" step with any source files/headers generated by actions/rules.</span>
<a name="l00727"></a>00727     <span class="comment"># To work around this, if a target is building anything directly (not</span>
<a name="l00728"></a>00728     <span class="comment"># type "none"), then a second target is used to run the GYP actions/rules</span>
<a name="l00729"></a>00729     <span class="comment"># and is made a dependency of this target.  This way the work is done</span>
<a name="l00730"></a>00730     <span class="comment"># before the dependency checks for what should be recompiled.</span>
<a name="l00731"></a>00731     support_xct = <span class="keywordtype">None</span>
<a name="l00732"></a>00732     <span class="comment"># The Xcode "issues" don't affect xcode-ninja builds, since the dependency</span>
<a name="l00733"></a>00733     <span class="comment"># logic all happens in ninja.  Don't bother creating the extra targets in</span>
<a name="l00734"></a>00734     <span class="comment"># that case.</span>
<a name="l00735"></a>00735     <span class="keywordflow">if</span> type != <span class="stringliteral">'none'</span> <span class="keywordflow">and</span> (spec_actions <span class="keywordflow">or</span> spec_rules) <span class="keywordflow">and</span> <span class="keywordflow">not</span> ninja_wrapper:
<a name="l00736"></a>00736       support_xccl = CreateXCConfigurationList(configuration_names);
<a name="l00737"></a>00737       support_target_suffix = generator_flags.get(
<a name="l00738"></a>00738           <span class="stringliteral">'support_target_suffix'</span>, <span class="stringliteral">' Support'</span>)
<a name="l00739"></a>00739       support_target_properties = {
<a name="l00740"></a>00740         <span class="stringliteral">'buildConfigurationList'</span>: support_xccl,
<a name="l00741"></a>00741         <span class="stringliteral">'name'</span>:                   target_name + support_target_suffix,
<a name="l00742"></a>00742       }
<a name="l00743"></a>00743       <span class="keywordflow">if</span> target_product_name:
<a name="l00744"></a>00744         support_target_properties[<span class="stringliteral">'productName'</span>] = \
<a name="l00745"></a>00745             target_product_name + <span class="stringliteral">' Support'</span>
<a name="l00746"></a>00746       support_xct = \
<a name="l00747"></a>00747           gyp.xcodeproj_file.PBXAggregateTarget(support_target_properties,
<a name="l00748"></a>00748                                                 parent=pbxp)
<a name="l00749"></a>00749       pbxp.AppendProperty(<span class="stringliteral">'targets'</span>, support_xct)
<a name="l00750"></a>00750       xct.AddDependency(support_xct)
<a name="l00751"></a>00751     <span class="comment"># Hang the support target off the main target so it can be tested/found</span>
<a name="l00752"></a>00752     <span class="comment"># by the generator during Finalize.</span>
<a name="l00753"></a>00753     xct.support_target = support_xct
<a name="l00754"></a>00754 
<a name="l00755"></a>00755     prebuild_index = 0
<a name="l00756"></a>00756 
<a name="l00757"></a>00757     <span class="comment"># Add custom shell script phases for "actions" sections.</span>
<a name="l00758"></a>00758     <span class="keywordflow">for</span> action <span class="keywordflow">in</span> spec_actions:
<a name="l00759"></a>00759       <span class="comment"># There's no need to write anything into the script to ensure that the</span>
<a name="l00760"></a>00760       <span class="comment"># output directories already exist, because Xcode will look at the</span>
<a name="l00761"></a>00761       <span class="comment"># declared outputs and automatically ensure that they exist for us.</span>
<a name="l00762"></a>00762 
<a name="l00763"></a>00763       <span class="comment"># Do we have a message to print when this action runs?</span>
<a name="l00764"></a>00764       message = action.get(<span class="stringliteral">'message'</span>)
<a name="l00765"></a>00765       <span class="keywordflow">if</span> message:
<a name="l00766"></a>00766         message = <span class="stringliteral">'echo note: '</span> + gyp.common.EncodePOSIXShellArgument(message)
<a name="l00767"></a>00767       <span class="keywordflow">else</span>:
<a name="l00768"></a>00768         message = <span class="stringliteral">''</span>
<a name="l00769"></a>00769 
<a name="l00770"></a>00770       <span class="comment"># Turn the list into a string that can be passed to a shell.</span>
<a name="l00771"></a>00771       action_string = gyp.common.EncodePOSIXShellList(action[<span class="stringliteral">'action'</span>])
<a name="l00772"></a>00772 
<a name="l00773"></a>00773       <span class="comment"># Convert Xcode-type variable references to sh-compatible environment</span>
<a name="l00774"></a>00774       <span class="comment"># variable references.</span>
<a name="l00775"></a>00775       message_sh = gyp.xcodeproj_file.ConvertVariablesToShellSyntax(message)
<a name="l00776"></a>00776       action_string_sh = gyp.xcodeproj_file.ConvertVariablesToShellSyntax(
<a name="l00777"></a>00777         action_string)
<a name="l00778"></a>00778 
<a name="l00779"></a>00779       script = <span class="stringliteral">''</span>
<a name="l00780"></a>00780       <span class="comment"># Include the optional message</span>
<a name="l00781"></a>00781       <span class="keywordflow">if</span> message_sh:
<a name="l00782"></a>00782         script += message_sh + <span class="stringliteral">'\n'</span>
<a name="l00783"></a>00783       <span class="comment"># Be sure the script runs in exec, and that if exec fails, the script</span>
<a name="l00784"></a>00784       <span class="comment"># exits signalling an error.</span>
<a name="l00785"></a>00785       script += <span class="stringliteral">'exec '</span> + action_string_sh + <span class="stringliteral">'\nexit 1\n'</span>
<a name="l00786"></a>00786       ssbp = gyp.xcodeproj_file.PBXShellScriptBuildPhase({
<a name="l00787"></a>00787             <span class="stringliteral">'inputPaths'</span>: action[<span class="stringliteral">'inputs'</span>],
<a name="l00788"></a>00788             <span class="stringliteral">'name'</span>: <span class="stringliteral">'Action "'</span> + action[<span class="stringliteral">'action_name'</span>] + <span class="stringliteral">'"'</span>,
<a name="l00789"></a>00789             <span class="stringliteral">'outputPaths'</span>: action[<span class="stringliteral">'outputs'</span>],
<a name="l00790"></a>00790             <span class="stringliteral">'shellScript'</span>: script,
<a name="l00791"></a>00791             <span class="stringliteral">'showEnvVarsInLog'</span>: 0,
<a name="l00792"></a>00792           })
<a name="l00793"></a>00793 
<a name="l00794"></a>00794       <span class="keywordflow">if</span> support_xct:
<a name="l00795"></a>00795         support_xct.AppendProperty(<span class="stringliteral">'buildPhases'</span>, ssbp)
<a name="l00796"></a>00796       <span class="keywordflow">else</span>:
<a name="l00797"></a>00797         <span class="comment"># TODO(mark): this assumes too much knowledge of the internals of</span>
<a name="l00798"></a>00798         <span class="comment"># xcodeproj_file; some of these smarts should move into xcodeproj_file</span>
<a name="l00799"></a>00799         <span class="comment"># itself.</span>
<a name="l00800"></a>00800         xct._properties[<span class="stringliteral">'buildPhases'</span>].insert(prebuild_index, ssbp)
<a name="l00801"></a>00801         prebuild_index = prebuild_index + 1
<a name="l00802"></a>00802 
<a name="l00803"></a>00803       <span class="comment"># TODO(mark): Should verify that at most one of these is specified.</span>
<a name="l00804"></a>00804       <span class="keywordflow">if</span> int(action.get(<span class="stringliteral">'process_outputs_as_sources'</span>, <span class="keyword">False</span>)):
<a name="l00805"></a>00805         <span class="keywordflow">for</span> output <span class="keywordflow">in</span> action[<span class="stringliteral">'outputs'</span>]:
<a name="l00806"></a>00806           AddSourceToTarget(output, type, pbxp, xct)
<a name="l00807"></a>00807 
<a name="l00808"></a>00808       <span class="keywordflow">if</span> int(action.get(<span class="stringliteral">'process_outputs_as_mac_bundle_resources'</span>, <span class="keyword">False</span>)):
<a name="l00809"></a>00809         <span class="keywordflow">for</span> output <span class="keywordflow">in</span> action[<span class="stringliteral">'outputs'</span>]:
<a name="l00810"></a>00810           AddResourceToTarget(output, pbxp, xct)
<a name="l00811"></a>00811 
<a name="l00812"></a>00812     <span class="comment"># tgt_mac_bundle_resources holds the list of bundle resources so</span>
<a name="l00813"></a>00813     <span class="comment"># the rule processing can check against it.</span>
<a name="l00814"></a>00814     <span class="keywordflow">if</span> is_bundle:
<a name="l00815"></a>00815       tgt_mac_bundle_resources = spec.get(<span class="stringliteral">'mac_bundle_resources'</span>, [])
<a name="l00816"></a>00816     <span class="keywordflow">else</span>:
<a name="l00817"></a>00817       tgt_mac_bundle_resources = []
<a name="l00818"></a>00818 
<a name="l00819"></a>00819     <span class="comment"># Add custom shell script phases driving "make" for "rules" sections.</span>
<a name="l00820"></a>00820     <span class="comment">#</span>
<a name="l00821"></a>00821     <span class="comment"># Xcode's built-in rule support is almost powerful enough to use directly,</span>
<a name="l00822"></a>00822     <span class="comment"># but there are a few significant deficiencies that render them unusable.</span>
<a name="l00823"></a>00823     <span class="comment"># There are workarounds for some of its inadequacies, but in aggregate,</span>
<a name="l00824"></a>00824     <span class="comment"># the workarounds added complexity to the generator, and some workarounds</span>
<a name="l00825"></a>00825     <span class="comment"># actually require input files to be crafted more carefully than I'd like.</span>
<a name="l00826"></a>00826     <span class="comment"># Consequently, until Xcode rules are made more capable, "rules" input</span>
<a name="l00827"></a>00827     <span class="comment"># sections will be handled in Xcode output by shell script build phases</span>
<a name="l00828"></a>00828     <span class="comment"># performed prior to the compilation phase.</span>
<a name="l00829"></a>00829     <span class="comment">#</span>
<a name="l00830"></a>00830     <span class="comment"># The following problems with Xcode rules were found.  The numbers are</span>
<a name="l00831"></a>00831     <span class="comment"># Apple radar IDs.  I hope that these shortcomings are addressed, I really</span>
<a name="l00832"></a>00832     <span class="comment"># liked having the rules handled directly in Xcode during the period that</span>
<a name="l00833"></a>00833     <span class="comment"># I was prototyping this.</span>
<a name="l00834"></a>00834     <span class="comment">#</span>
<a name="l00835"></a>00835     <span class="comment"># 6588600 Xcode compiles custom script rule outputs too soon, compilation</span>
<a name="l00836"></a>00836     <span class="comment">#         fails.  This occurs when rule outputs from distinct inputs are</span>
<a name="l00837"></a>00837     <span class="comment">#         interdependent.  The only workaround is to put rules and their</span>
<a name="l00838"></a>00838     <span class="comment">#         inputs in a separate target from the one that compiles the rule</span>
<a name="l00839"></a>00839     <span class="comment">#         outputs.  This requires input file cooperation and it means that</span>
<a name="l00840"></a>00840     <span class="comment">#         process_outputs_as_sources is unusable.</span>
<a name="l00841"></a>00841     <span class="comment"># 6584932 Need to declare that custom rule outputs should be excluded from</span>
<a name="l00842"></a>00842     <span class="comment">#         compilation.  A possible workaround is to lie to Xcode about a</span>
<a name="l00843"></a>00843     <span class="comment">#         rule's output, giving it a dummy file it doesn't know how to</span>
<a name="l00844"></a>00844     <span class="comment">#         compile.  The rule action script would need to touch the dummy.</span>
<a name="l00845"></a>00845     <span class="comment"># 6584839 I need a way to declare additional inputs to a custom rule.</span>
<a name="l00846"></a>00846     <span class="comment">#         A possible workaround is a shell script phase prior to</span>
<a name="l00847"></a>00847     <span class="comment">#         compilation that touches a rule's primary input files if any</span>
<a name="l00848"></a>00848     <span class="comment">#         would-be additional inputs are newer than the output.  Modifying</span>
<a name="l00849"></a>00849     <span class="comment">#         the source tree - even just modification times - feels dirty.</span>
<a name="l00850"></a>00850     <span class="comment"># 6564240 Xcode "custom script" build rules always dump all environment</span>
<a name="l00851"></a>00851     <span class="comment">#         variables.  This is a low-prioroty problem and is not a</span>
<a name="l00852"></a>00852     <span class="comment">#         show-stopper.</span>
<a name="l00853"></a>00853     rules_by_ext = {}
<a name="l00854"></a>00854     <span class="keywordflow">for</span> rule <span class="keywordflow">in</span> spec_rules:
<a name="l00855"></a>00855       rules_by_ext[rule[<span class="stringliteral">'extension'</span>]] = rule
<a name="l00856"></a>00856 
<a name="l00857"></a>00857       <span class="comment"># First, some definitions:</span>
<a name="l00858"></a>00858       <span class="comment">#</span>
<a name="l00859"></a>00859       <span class="comment"># A "rule source" is a file that was listed in a target's "sources"</span>
<a name="l00860"></a>00860       <span class="comment"># list and will have a rule applied to it on the basis of matching the</span>
<a name="l00861"></a>00861       <span class="comment"># rule's "extensions" attribute.  Rule sources are direct inputs to</span>
<a name="l00862"></a>00862       <span class="comment"># rules.</span>
<a name="l00863"></a>00863       <span class="comment">#</span>
<a name="l00864"></a>00864       <span class="comment"># Rule definitions may specify additional inputs in their "inputs"</span>
<a name="l00865"></a>00865       <span class="comment"># attribute.  These additional inputs are used for dependency tracking</span>
<a name="l00866"></a>00866       <span class="comment"># purposes.</span>
<a name="l00867"></a>00867       <span class="comment">#</span>
<a name="l00868"></a>00868       <span class="comment"># A "concrete output" is a rule output with input-dependent variables</span>
<a name="l00869"></a>00869       <span class="comment"># resolved.  For example, given a rule with:</span>
<a name="l00870"></a>00870       <span class="comment">#   'extension': 'ext', 'outputs': ['$(INPUT_FILE_BASE).cc'],</span>
<a name="l00871"></a>00871       <span class="comment"># if the target's "sources" list contained "one.ext" and "two.ext",</span>
<a name="l00872"></a>00872       <span class="comment"># the "concrete output" for rule input "two.ext" would be "two.cc".  If</span>
<a name="l00873"></a>00873       <span class="comment"># a rule specifies multiple outputs, each input file that the rule is</span>
<a name="l00874"></a>00874       <span class="comment"># applied to will have the same number of concrete outputs.</span>
<a name="l00875"></a>00875       <span class="comment">#</span>
<a name="l00876"></a>00876       <span class="comment"># If any concrete outputs are outdated or missing relative to their</span>
<a name="l00877"></a>00877       <span class="comment"># corresponding rule_source or to any specified additional input, the</span>
<a name="l00878"></a>00878       <span class="comment"># rule action must be performed to generate the concrete outputs.</span>
<a name="l00879"></a>00879 
<a name="l00880"></a>00880       <span class="comment"># concrete_outputs_by_rule_source will have an item at the same index</span>
<a name="l00881"></a>00881       <span class="comment"># as the rule['rule_sources'] that it corresponds to.  Each item is a</span>
<a name="l00882"></a>00882       <span class="comment"># list of all of the concrete outputs for the rule_source.</span>
<a name="l00883"></a>00883       concrete_outputs_by_rule_source = []
<a name="l00884"></a>00884 
<a name="l00885"></a>00885       <span class="comment"># concrete_outputs_all is a flat list of all concrete outputs that this</span>
<a name="l00886"></a>00886       <span class="comment"># rule is able to produce, given the known set of input files</span>
<a name="l00887"></a>00887       <span class="comment"># (rule_sources) that apply to it.</span>
<a name="l00888"></a>00888       concrete_outputs_all = []
<a name="l00889"></a>00889 
<a name="l00890"></a>00890       <span class="comment"># messages &amp; actions are keyed by the same indices as rule['rule_sources']</span>
<a name="l00891"></a>00891       <span class="comment"># and concrete_outputs_by_rule_source.  They contain the message and</span>
<a name="l00892"></a>00892       <span class="comment"># action to perform after resolving input-dependent variables.  The</span>
<a name="l00893"></a>00893       <span class="comment"># message is optional, in which case None is stored for each rule source.</span>
<a name="l00894"></a>00894       messages = []
<a name="l00895"></a>00895       actions = []
<a name="l00896"></a>00896 
<a name="l00897"></a>00897       <span class="keywordflow">for</span> rule_source <span class="keywordflow">in</span> rule.get(<span class="stringliteral">'rule_sources'</span>, []):
<a name="l00898"></a>00898         rule_source_dirname, rule_source_basename = \
<a name="l00899"></a>00899             posixpath.split(rule_source)
<a name="l00900"></a>00900         (rule_source_root, rule_source_ext) = \
<a name="l00901"></a>00901             posixpath.splitext(rule_source_basename)
<a name="l00902"></a>00902 
<a name="l00903"></a>00903         <span class="comment"># These are the same variable names that Xcode uses for its own native</span>
<a name="l00904"></a>00904         <span class="comment"># rule support.  Because Xcode's rule engine is not being used, they</span>
<a name="l00905"></a>00905         <span class="comment"># need to be expanded as they are written to the makefile.</span>
<a name="l00906"></a>00906         rule_input_dict = {
<a name="l00907"></a>00907           <span class="stringliteral">'INPUT_FILE_BASE'</span>:   rule_source_root,
<a name="l00908"></a>00908           <span class="stringliteral">'INPUT_FILE_SUFFIX'</span>: rule_source_ext,
<a name="l00909"></a>00909           <span class="stringliteral">'INPUT_FILE_NAME'</span>:   rule_source_basename,
<a name="l00910"></a>00910           <span class="stringliteral">'INPUT_FILE_PATH'</span>:   rule_source,
<a name="l00911"></a>00911           <span class="stringliteral">'INPUT_FILE_DIRNAME'</span>: rule_source_dirname,
<a name="l00912"></a>00912         }
<a name="l00913"></a>00913 
<a name="l00914"></a>00914         concrete_outputs_for_this_rule_source = []
<a name="l00915"></a>00915         <span class="keywordflow">for</span> output <span class="keywordflow">in</span> rule.get(<span class="stringliteral">'outputs'</span>, []):
<a name="l00916"></a>00916           <span class="comment"># Fortunately, Xcode and make both use $(VAR) format for their</span>
<a name="l00917"></a>00917           <span class="comment"># variables, so the expansion is the only transformation necessary.</span>
<a name="l00918"></a>00918           <span class="comment"># Any remaning $(VAR)-type variables in the string can be given</span>
<a name="l00919"></a>00919           <span class="comment"># directly to make, which will pick up the correct settings from</span>
<a name="l00920"></a>00920           <span class="comment"># what Xcode puts into the environment.</span>
<a name="l00921"></a>00921           concrete_output = ExpandXcodeVariables(output, rule_input_dict)
<a name="l00922"></a>00922           concrete_outputs_for_this_rule_source.append(concrete_output)
<a name="l00923"></a>00923 
<a name="l00924"></a>00924           <span class="comment"># Add all concrete outputs to the project.</span>
<a name="l00925"></a>00925           pbxp.AddOrGetFileInRootGroup(concrete_output)
<a name="l00926"></a>00926 
<a name="l00927"></a>00927         concrete_outputs_by_rule_source.append( \
<a name="l00928"></a>00928             concrete_outputs_for_this_rule_source)
<a name="l00929"></a>00929         concrete_outputs_all.extend(concrete_outputs_for_this_rule_source)
<a name="l00930"></a>00930 
<a name="l00931"></a>00931         <span class="comment"># TODO(mark): Should verify that at most one of these is specified.</span>
<a name="l00932"></a>00932         <span class="keywordflow">if</span> int(rule.get(<span class="stringliteral">'process_outputs_as_sources'</span>, <span class="keyword">False</span>)):
<a name="l00933"></a>00933           <span class="keywordflow">for</span> output <span class="keywordflow">in</span> concrete_outputs_for_this_rule_source:
<a name="l00934"></a>00934             AddSourceToTarget(output, type, pbxp, xct)
<a name="l00935"></a>00935 
<a name="l00936"></a>00936         <span class="comment"># If the file came from the mac_bundle_resources list or if the rule</span>
<a name="l00937"></a>00937         <span class="comment"># is marked to process outputs as bundle resource, do so.</span>
<a name="l00938"></a>00938         was_mac_bundle_resource = rule_source <span class="keywordflow">in</span> tgt_mac_bundle_resources
<a name="l00939"></a>00939         <span class="keywordflow">if</span> was_mac_bundle_resource <span class="keywordflow">or</span> \
<a name="l00940"></a>00940             int(rule.get(<span class="stringliteral">'process_outputs_as_mac_bundle_resources'</span>, <span class="keyword">False</span>)):
<a name="l00941"></a>00941           <span class="keywordflow">for</span> output <span class="keywordflow">in</span> concrete_outputs_for_this_rule_source:
<a name="l00942"></a>00942             AddResourceToTarget(output, pbxp, xct)
<a name="l00943"></a>00943 
<a name="l00944"></a>00944         <span class="comment"># Do we have a message to print when this rule runs?</span>
<a name="l00945"></a>00945         message = rule.get(<span class="stringliteral">'message'</span>)
<a name="l00946"></a>00946         <span class="keywordflow">if</span> message:
<a name="l00947"></a>00947           message = gyp.common.EncodePOSIXShellArgument(message)
<a name="l00948"></a>00948           message = ExpandXcodeVariables(message, rule_input_dict)
<a name="l00949"></a>00949         messages.append(message)
<a name="l00950"></a>00950 
<a name="l00951"></a>00951         <span class="comment"># Turn the list into a string that can be passed to a shell.</span>
<a name="l00952"></a>00952         action_string = gyp.common.EncodePOSIXShellList(rule[<span class="stringliteral">'action'</span>])
<a name="l00953"></a>00953 
<a name="l00954"></a>00954         action = ExpandXcodeVariables(action_string, rule_input_dict)
<a name="l00955"></a>00955         actions.append(action)
<a name="l00956"></a>00956 
<a name="l00957"></a>00957       <span class="keywordflow">if</span> len(concrete_outputs_all) &gt; 0:
<a name="l00958"></a>00958         <span class="comment"># TODO(mark): There's a possibilty for collision here.  Consider</span>
<a name="l00959"></a>00959         <span class="comment"># target "t" rule "A_r" and target "t_A" rule "r".</span>
<a name="l00960"></a>00960         makefile_name = <span class="stringliteral">'%s.make'</span> % re.sub(
<a name="l00961"></a>00961             <span class="stringliteral">'[^a-zA-Z0-9_]'</span>, <span class="stringliteral">'_'</span> , <span class="stringliteral">'%s_%s'</span> % (target_name, rule[<span class="stringliteral">'rule_name'</span>]))
<a name="l00962"></a>00962         makefile_path = os.path.join(xcode_projects[build_file].path,
<a name="l00963"></a>00963                                      makefile_name)
<a name="l00964"></a>00964         <span class="comment"># TODO(mark): try/close?  Write to a temporary file and swap it only</span>
<a name="l00965"></a>00965         <span class="comment"># if it's got changes?</span>
<a name="l00966"></a>00966         makefile = open(makefile_path, <span class="stringliteral">'wb'</span>)
<a name="l00967"></a>00967 
<a name="l00968"></a>00968         <span class="comment"># make will build the first target in the makefile by default.  By</span>
<a name="l00969"></a>00969         <span class="comment"># convention, it's called "all".  List all (or at least one)</span>
<a name="l00970"></a>00970         <span class="comment"># concrete output for each rule source as a prerequisite of the "all"</span>
<a name="l00971"></a>00971         <span class="comment"># target.</span>
<a name="l00972"></a>00972         makefile.write(<span class="stringliteral">'all: \\\n'</span>)
<a name="l00973"></a>00973         <span class="keywordflow">for</span> concrete_output_index <span class="keywordflow">in</span> \
<a name="l00974"></a>00974             xrange(0, len(concrete_outputs_by_rule_source)):
<a name="l00975"></a>00975           <span class="comment"># Only list the first (index [0]) concrete output of each input</span>
<a name="l00976"></a>00976           <span class="comment"># in the "all" target.  Otherwise, a parallel make (-j &gt; 1) would</span>
<a name="l00977"></a>00977           <span class="comment"># attempt to process each input multiple times simultaneously.</span>
<a name="l00978"></a>00978           <span class="comment"># Otherwise, "all" could just contain the entire list of</span>
<a name="l00979"></a>00979           <span class="comment"># concrete_outputs_all.</span>
<a name="l00980"></a>00980           concrete_output = \
<a name="l00981"></a>00981               concrete_outputs_by_rule_source[concrete_output_index][0]
<a name="l00982"></a>00982           <span class="keywordflow">if</span> concrete_output_index == len(concrete_outputs_by_rule_source) - 1:
<a name="l00983"></a>00983             eol = <span class="stringliteral">''</span>
<a name="l00984"></a>00984           <span class="keywordflow">else</span>:
<a name="l00985"></a>00985             eol = <span class="stringliteral">' \\'</span>
<a name="l00986"></a>00986           makefile.write(<span class="stringliteral">'    %s%s\n'</span> % (concrete_output, eol))
<a name="l00987"></a>00987 
<a name="l00988"></a>00988         <span class="keywordflow">for</span> (rule_source, concrete_outputs, message, action) <span class="keywordflow">in</span> \
<a name="l00989"></a>00989             zip(rule[<span class="stringliteral">'rule_sources'</span>], concrete_outputs_by_rule_source,
<a name="l00990"></a>00990                 messages, actions):
<a name="l00991"></a>00991           makefile.write(<span class="stringliteral">'\n'</span>)
<a name="l00992"></a>00992 
<a name="l00993"></a>00993           <span class="comment"># Add a rule that declares it can build each concrete output of a</span>
<a name="l00994"></a>00994           <span class="comment"># rule source.  Collect the names of the directories that are</span>
<a name="l00995"></a>00995           <span class="comment"># required.</span>
<a name="l00996"></a>00996           concrete_output_dirs = []
<a name="l00997"></a>00997           <span class="keywordflow">for</span> concrete_output_index <span class="keywordflow">in</span> xrange(0, len(concrete_outputs)):
<a name="l00998"></a>00998             concrete_output = concrete_outputs[concrete_output_index]
<a name="l00999"></a>00999             <span class="keywordflow">if</span> concrete_output_index == 0:
<a name="l01000"></a>01000               bol = <span class="stringliteral">''</span>
<a name="l01001"></a>01001             <span class="keywordflow">else</span>:
<a name="l01002"></a>01002               bol = <span class="stringliteral">'    '</span>
<a name="l01003"></a>01003             makefile.write(<span class="stringliteral">'%s%s \\\n'</span> % (bol, concrete_output))
<a name="l01004"></a>01004 
<a name="l01005"></a>01005             concrete_output_dir = posixpath.dirname(concrete_output)
<a name="l01006"></a>01006             <span class="keywordflow">if</span> (concrete_output_dir <span class="keywordflow">and</span>
<a name="l01007"></a>01007                 concrete_output_dir <span class="keywordflow">not</span> <span class="keywordflow">in</span> concrete_output_dirs):
<a name="l01008"></a>01008               concrete_output_dirs.append(concrete_output_dir)
<a name="l01009"></a>01009 
<a name="l01010"></a>01010           makefile.write(<span class="stringliteral">'    : \\\n'</span>)
<a name="l01011"></a>01011 
<a name="l01012"></a>01012           <span class="comment"># The prerequisites for this rule are the rule source itself and</span>
<a name="l01013"></a>01013           <span class="comment"># the set of additional rule inputs, if any.</span>
<a name="l01014"></a>01014           prerequisites = [rule_source]
<a name="l01015"></a>01015           prerequisites.extend(rule.get(<span class="stringliteral">'inputs'</span>, []))
<a name="l01016"></a>01016           <span class="keywordflow">for</span> prerequisite_index <span class="keywordflow">in</span> xrange(0, len(prerequisites)):
<a name="l01017"></a>01017             prerequisite = prerequisites[prerequisite_index]
<a name="l01018"></a>01018             <span class="keywordflow">if</span> prerequisite_index == len(prerequisites) - 1:
<a name="l01019"></a>01019               eol = <span class="stringliteral">''</span>
<a name="l01020"></a>01020             <span class="keywordflow">else</span>:
<a name="l01021"></a>01021               eol = <span class="stringliteral">' \\'</span>
<a name="l01022"></a>01022             makefile.write(<span class="stringliteral">'    %s%s\n'</span> % (prerequisite, eol))
<a name="l01023"></a>01023 
<a name="l01024"></a>01024           <span class="comment"># Make sure that output directories exist before executing the rule</span>
<a name="l01025"></a>01025           <span class="comment"># action.</span>
<a name="l01026"></a>01026           <span class="keywordflow">if</span> len(concrete_output_dirs) &gt; 0:
<a name="l01027"></a>01027             makefile.write(<span class="stringliteral">'\t@mkdir -p "%s"\n'</span> %
<a name="l01028"></a>01028                            <span class="stringliteral">'" "'</span>.join(concrete_output_dirs))
<a name="l01029"></a>01029 
<a name="l01030"></a>01030           <span class="comment"># The rule message and action have already had the necessary variable</span>
<a name="l01031"></a>01031           <span class="comment"># substitutions performed.</span>
<a name="l01032"></a>01032           <span class="keywordflow">if</span> message:
<a name="l01033"></a>01033             <span class="comment"># Mark it with note: so Xcode picks it up in build output.</span>
<a name="l01034"></a>01034             makefile.write(<span class="stringliteral">'\t@echo note: %s\n'</span> % message)
<a name="l01035"></a>01035           makefile.write(<span class="stringliteral">'\t%s\n'</span> % action)
<a name="l01036"></a>01036 
<a name="l01037"></a>01037         makefile.close()
<a name="l01038"></a>01038 
<a name="l01039"></a>01039         <span class="comment"># It might be nice to ensure that needed output directories exist</span>
<a name="l01040"></a>01040         <span class="comment"># here rather than in each target in the Makefile, but that wouldn't</span>
<a name="l01041"></a>01041         <span class="comment"># work if there ever was a concrete output that had an input-dependent</span>
<a name="l01042"></a>01042         <span class="comment"># variable anywhere other than in the leaf position.</span>
<a name="l01043"></a>01043 
<a name="l01044"></a>01044         <span class="comment"># Don't declare any inputPaths or outputPaths.  If they're present,</span>
<a name="l01045"></a>01045         <span class="comment"># Xcode will provide a slight optimization by only running the script</span>
<a name="l01046"></a>01046         <span class="comment"># phase if any output is missing or outdated relative to any input.</span>
<a name="l01047"></a>01047         <span class="comment"># Unfortunately, it will also assume that all outputs are touched by</span>
<a name="l01048"></a>01048         <span class="comment"># the script, and if the outputs serve as files in a compilation</span>
<a name="l01049"></a>01049         <span class="comment"># phase, they will be unconditionally rebuilt.  Since make might not</span>
<a name="l01050"></a>01050         <span class="comment"># rebuild everything that could be declared here as an output, this</span>
<a name="l01051"></a>01051         <span class="comment"># extra compilation activity is unnecessary.  With inputPaths and</span>
<a name="l01052"></a>01052         <span class="comment"># outputPaths not supplied, make will always be called, but it knows</span>
<a name="l01053"></a>01053         <span class="comment"># enough to not do anything when everything is up-to-date.</span>
<a name="l01054"></a>01054 
<a name="l01055"></a>01055         <span class="comment"># To help speed things up, pass -j COUNT to make so it does some work</span>
<a name="l01056"></a>01056         <span class="comment"># in parallel.  Don't use ncpus because Xcode will build ncpus targets</span>
<a name="l01057"></a>01057         <span class="comment"># in parallel and if each target happens to have a rules step, there</span>
<a name="l01058"></a>01058         <span class="comment"># would be ncpus^2 things going.  With a machine that has 2 quad-core</span>
<a name="l01059"></a>01059         <span class="comment"># Xeons, a build can quickly run out of processes based on</span>
<a name="l01060"></a>01060         <span class="comment"># scheduling/other tasks, and randomly failing builds are no good.</span>
<a name="l01061"></a>01061         script = \
<a name="l01062"></a>01062 <span class="stringliteral">"""JOB_COUNT="$(/usr/sbin/sysctl -n hw.ncpu)"</span>
<a name="l01063"></a>01063 <span class="stringliteral">if [ "${JOB_COUNT}" -gt 4 ]; then</span>
<a name="l01064"></a>01064 <span class="stringliteral">  JOB_COUNT=4</span>
<a name="l01065"></a>01065 <span class="stringliteral">fi</span>
<a name="l01066"></a>01066 <span class="stringliteral">exec xcrun make -f "${PROJECT_FILE_PATH}/%s" -j "${JOB_COUNT}"</span>
<a name="l01067"></a>01067 <span class="stringliteral">exit 1</span>
<a name="l01068"></a>01068 <span class="stringliteral">"""</span> % makefile_name
<a name="l01069"></a>01069         ssbp = gyp.xcodeproj_file.PBXShellScriptBuildPhase({
<a name="l01070"></a>01070               <span class="stringliteral">'name'</span>: <span class="stringliteral">'Rule "'</span> + rule[<span class="stringliteral">'rule_name'</span>] + <span class="stringliteral">'"'</span>,
<a name="l01071"></a>01071               <span class="stringliteral">'shellScript'</span>: script,
<a name="l01072"></a>01072               <span class="stringliteral">'showEnvVarsInLog'</span>: 0,
<a name="l01073"></a>01073             })
<a name="l01074"></a>01074 
<a name="l01075"></a>01075         <span class="keywordflow">if</span> support_xct:
<a name="l01076"></a>01076           support_xct.AppendProperty(<span class="stringliteral">'buildPhases'</span>, ssbp)
<a name="l01077"></a>01077         <span class="keywordflow">else</span>:
<a name="l01078"></a>01078           <span class="comment"># TODO(mark): this assumes too much knowledge of the internals of</span>
<a name="l01079"></a>01079           <span class="comment"># xcodeproj_file; some of these smarts should move into xcodeproj_file</span>
<a name="l01080"></a>01080           <span class="comment"># itself.</span>
<a name="l01081"></a>01081           xct._properties[<span class="stringliteral">'buildPhases'</span>].insert(prebuild_index, ssbp)
<a name="l01082"></a>01082           prebuild_index = prebuild_index + 1
<a name="l01083"></a>01083 
<a name="l01084"></a>01084       <span class="comment"># Extra rule inputs also go into the project file.  Concrete outputs were</span>
<a name="l01085"></a>01085       <span class="comment"># already added when they were computed.</span>
<a name="l01086"></a>01086       groups = [<span class="stringliteral">'inputs'</span>, <span class="stringliteral">'inputs_excluded'</span>]
<a name="l01087"></a>01087       <span class="keywordflow">if</span> skip_excluded_files:
<a name="l01088"></a>01088         groups = [x <span class="keywordflow">for</span> x <span class="keywordflow">in</span> groups <span class="keywordflow">if</span> <span class="keywordflow">not</span> x.endswith(<span class="stringliteral">'_excluded'</span>)]
<a name="l01089"></a>01089       <span class="keywordflow">for</span> group <span class="keywordflow">in</span> groups:
<a name="l01090"></a>01090         <span class="keywordflow">for</span> item <span class="keywordflow">in</span> rule.get(group, []):
<a name="l01091"></a>01091           pbxp.AddOrGetFileInRootGroup(item)
<a name="l01092"></a>01092 
<a name="l01093"></a>01093     <span class="comment"># Add "sources".</span>
<a name="l01094"></a>01094     <span class="keywordflow">for</span> source <span class="keywordflow">in</span> spec.get(<span class="stringliteral">'sources'</span>, []):
<a name="l01095"></a>01095       (source_root, source_extension) = posixpath.splitext(source)
<a name="l01096"></a>01096       <span class="keywordflow">if</span> source_extension[1:] <span class="keywordflow">not</span> <span class="keywordflow">in</span> rules_by_ext:
<a name="l01097"></a>01097         <span class="comment"># AddSourceToTarget will add the file to a root group if it's not</span>
<a name="l01098"></a>01098         <span class="comment"># already there.</span>
<a name="l01099"></a>01099         AddSourceToTarget(source, type, pbxp, xct)
<a name="l01100"></a>01100       <span class="keywordflow">else</span>:
<a name="l01101"></a>01101         pbxp.AddOrGetFileInRootGroup(source)
<a name="l01102"></a>01102 
<a name="l01103"></a>01103     <span class="comment"># Add "mac_bundle_resources" and "mac_framework_private_headers" if</span>
<a name="l01104"></a>01104     <span class="comment"># it's a bundle of any type.</span>
<a name="l01105"></a>01105     <span class="keywordflow">if</span> is_bundle:
<a name="l01106"></a>01106       <span class="keywordflow">for</span> resource <span class="keywordflow">in</span> tgt_mac_bundle_resources:
<a name="l01107"></a>01107         (resource_root, resource_extension) = posixpath.splitext(resource)
<a name="l01108"></a>01108         <span class="keywordflow">if</span> resource_extension[1:] <span class="keywordflow">not</span> <span class="keywordflow">in</span> rules_by_ext:
<a name="l01109"></a>01109           AddResourceToTarget(resource, pbxp, xct)
<a name="l01110"></a>01110         <span class="keywordflow">else</span>:
<a name="l01111"></a>01111           pbxp.AddOrGetFileInRootGroup(resource)
<a name="l01112"></a>01112 
<a name="l01113"></a>01113       <span class="keywordflow">for</span> header <span class="keywordflow">in</span> spec.get(<span class="stringliteral">'mac_framework_private_headers'</span>, []):
<a name="l01114"></a>01114         AddHeaderToTarget(header, pbxp, xct, <span class="keyword">False</span>)
<a name="l01115"></a>01115 
<a name="l01116"></a>01116     <span class="comment"># Add "mac_framework_headers". These can be valid for both frameworks</span>
<a name="l01117"></a>01117     <span class="comment"># and static libraries.</span>
<a name="l01118"></a>01118     <span class="keywordflow">if</span> is_bundle <span class="keywordflow">or</span> type == <span class="stringliteral">'static_library'</span>:
<a name="l01119"></a>01119       <span class="keywordflow">for</span> header <span class="keywordflow">in</span> spec.get(<span class="stringliteral">'mac_framework_headers'</span>, []):
<a name="l01120"></a>01120         AddHeaderToTarget(header, pbxp, xct, <span class="keyword">True</span>)
<a name="l01121"></a>01121 
<a name="l01122"></a>01122     <span class="comment"># Add "copies".</span>
<a name="l01123"></a>01123     pbxcp_dict = {}
<a name="l01124"></a>01124     <span class="keywordflow">for</span> copy_group <span class="keywordflow">in</span> spec.get(<span class="stringliteral">'copies'</span>, []):
<a name="l01125"></a>01125       dest = copy_group[<span class="stringliteral">'destination'</span>]
<a name="l01126"></a>01126       <span class="keywordflow">if</span> dest[0] <span class="keywordflow">not</span> <span class="keywordflow">in</span> (<span class="stringliteral">'/'</span>, <span class="stringliteral">'$'</span>):
<a name="l01127"></a>01127         <span class="comment"># Relative paths are relative to $(SRCROOT).</span>
<a name="l01128"></a>01128         dest = <span class="stringliteral">'$(SRCROOT)/'</span> + dest
<a name="l01129"></a>01129 
<a name="l01130"></a>01130       code_sign = int(copy_group.get(<span class="stringliteral">'xcode_code_sign'</span>, 0))
<a name="l01131"></a>01131       settings = (<span class="keywordtype">None</span>, <span class="stringliteral">'{ATTRIBUTES = (CodeSignOnCopy, ); }'</span>)[code_sign];
<a name="l01132"></a>01132 
<a name="l01133"></a>01133       <span class="comment"># Coalesce multiple "copies" sections in the same target with the same</span>
<a name="l01134"></a>01134       <span class="comment"># "destination" property into the same PBXCopyFilesBuildPhase, otherwise</span>
<a name="l01135"></a>01135       <span class="comment"># they'll wind up with ID collisions.</span>
<a name="l01136"></a>01136       pbxcp = pbxcp_dict.get(dest, <span class="keywordtype">None</span>)
<a name="l01137"></a>01137       <span class="keywordflow">if</span> pbxcp <span class="keywordflow">is</span> <span class="keywordtype">None</span>:
<a name="l01138"></a>01138         pbxcp = gyp.xcodeproj_file.PBXCopyFilesBuildPhase({
<a name="l01139"></a>01139               <span class="stringliteral">'name'</span>: <span class="stringliteral">'Copy to '</span> + copy_group[<span class="stringliteral">'destination'</span>]
<a name="l01140"></a>01140             },
<a name="l01141"></a>01141             parent=xct)
<a name="l01142"></a>01142         pbxcp.SetDestination(dest)
<a name="l01143"></a>01143 
<a name="l01144"></a>01144         <span class="comment"># TODO(mark): The usual comment about this knowing too much about</span>
<a name="l01145"></a>01145         <span class="comment"># gyp.xcodeproj_file internals applies.</span>
<a name="l01146"></a>01146         xct._properties[<span class="stringliteral">'buildPhases'</span>].insert(prebuild_index, pbxcp)
<a name="l01147"></a>01147 
<a name="l01148"></a>01148         pbxcp_dict[dest] = pbxcp
<a name="l01149"></a>01149 
<a name="l01150"></a>01150       <span class="keywordflow">for</span> file <span class="keywordflow">in</span> copy_group[<span class="stringliteral">'files'</span>]:
<a name="l01151"></a>01151         pbxcp.AddFile(file, settings)
<a name="l01152"></a>01152 
<a name="l01153"></a>01153     <span class="comment"># Excluded files can also go into the project file.</span>
<a name="l01154"></a>01154     <span class="keywordflow">if</span> <span class="keywordflow">not</span> skip_excluded_files:
<a name="l01155"></a>01155       <span class="keywordflow">for</span> key <span class="keywordflow">in</span> [<span class="stringliteral">'sources'</span>, <span class="stringliteral">'mac_bundle_resources'</span>, <span class="stringliteral">'mac_framework_headers'</span>,
<a name="l01156"></a>01156                   <span class="stringliteral">'mac_framework_private_headers'</span>]:
<a name="l01157"></a>01157         excluded_key = key + <span class="stringliteral">'_excluded'</span>
<a name="l01158"></a>01158         <span class="keywordflow">for</span> item <span class="keywordflow">in</span> spec.get(excluded_key, []):
<a name="l01159"></a>01159           pbxp.AddOrGetFileInRootGroup(item)
<a name="l01160"></a>01160 
<a name="l01161"></a>01161     <span class="comment"># So can "inputs" and "outputs" sections of "actions" groups.</span>
<a name="l01162"></a>01162     groups = [<span class="stringliteral">'inputs'</span>, <span class="stringliteral">'inputs_excluded'</span>, <span class="stringliteral">'outputs'</span>, <span class="stringliteral">'outputs_excluded'</span>]
<a name="l01163"></a>01163     <span class="keywordflow">if</span> skip_excluded_files:
<a name="l01164"></a>01164       groups = [x <span class="keywordflow">for</span> x <span class="keywordflow">in</span> groups <span class="keywordflow">if</span> <span class="keywordflow">not</span> x.endswith(<span class="stringliteral">'_excluded'</span>)]
<a name="l01165"></a>01165     <span class="keywordflow">for</span> action <span class="keywordflow">in</span> spec.get(<span class="stringliteral">'actions'</span>, []):
<a name="l01166"></a>01166       <span class="keywordflow">for</span> group <span class="keywordflow">in</span> groups:
<a name="l01167"></a>01167         <span class="keywordflow">for</span> item <span class="keywordflow">in</span> action.get(group, []):
<a name="l01168"></a>01168           <span class="comment"># Exclude anything in BUILT_PRODUCTS_DIR.  They're products, not</span>
<a name="l01169"></a>01169           <span class="comment"># sources.</span>
<a name="l01170"></a>01170           <span class="keywordflow">if</span> <span class="keywordflow">not</span> item.startswith(<span class="stringliteral">'$(BUILT_PRODUCTS_DIR)/'</span>):
<a name="l01171"></a>01171             pbxp.AddOrGetFileInRootGroup(item)
<a name="l01172"></a>01172 
<a name="l01173"></a>01173     <span class="keywordflow">for</span> postbuild <span class="keywordflow">in</span> spec.get(<span class="stringliteral">'postbuilds'</span>, []):
<a name="l01174"></a>01174       action_string_sh = gyp.common.EncodePOSIXShellList(postbuild[<span class="stringliteral">'action'</span>])
<a name="l01175"></a>01175       script = <span class="stringliteral">'exec '</span> + action_string_sh + <span class="stringliteral">'\nexit 1\n'</span>
<a name="l01176"></a>01176 
<a name="l01177"></a>01177       <span class="comment"># Make the postbuild step depend on the output of ld or ar from this</span>
<a name="l01178"></a>01178       <span class="comment"># target. Apparently putting the script step after the link step isn't</span>
<a name="l01179"></a>01179       <span class="comment"># sufficient to ensure proper ordering in all cases. With an input</span>
<a name="l01180"></a>01180       <span class="comment"># declared but no outputs, the script step should run every time, as</span>
<a name="l01181"></a>01181       <span class="comment"># desired.</span>
<a name="l01182"></a>01182       ssbp = gyp.xcodeproj_file.PBXShellScriptBuildPhase({
<a name="l01183"></a>01183             <span class="stringliteral">'inputPaths'</span>: [<span class="stringliteral">'$(BUILT_PRODUCTS_DIR)/$(EXECUTABLE_PATH)'</span>],
<a name="l01184"></a>01184             <span class="stringliteral">'name'</span>: <span class="stringliteral">'Postbuild "'</span> + postbuild[<span class="stringliteral">'postbuild_name'</span>] + <span class="stringliteral">'"'</span>,
<a name="l01185"></a>01185             <span class="stringliteral">'shellScript'</span>: script,
<a name="l01186"></a>01186             <span class="stringliteral">'showEnvVarsInLog'</span>: 0,
<a name="l01187"></a>01187           })
<a name="l01188"></a>01188       xct.AppendProperty(<span class="stringliteral">'buildPhases'</span>, ssbp)
<a name="l01189"></a>01189 
<a name="l01190"></a>01190     <span class="comment"># Add dependencies before libraries, because adding a dependency may imply</span>
<a name="l01191"></a>01191     <span class="comment"># adding a library.  It's preferable to keep dependencies listed first</span>
<a name="l01192"></a>01192     <span class="comment"># during a link phase so that they can override symbols that would</span>
<a name="l01193"></a>01193     <span class="comment"># otherwise be provided by libraries, which will usually include system</span>
<a name="l01194"></a>01194     <span class="comment"># libraries.  On some systems, ld is finicky and even requires the</span>
<a name="l01195"></a>01195     <span class="comment"># libraries to be ordered in such a way that unresolved symbols in</span>
<a name="l01196"></a>01196     <span class="comment"># earlier-listed libraries may only be resolved by later-listed libraries.</span>
<a name="l01197"></a>01197     <span class="comment"># The Mac linker doesn't work that way, but other platforms do, and so</span>
<a name="l01198"></a>01198     <span class="comment"># their linker invocations need to be constructed in this way.  There's</span>
<a name="l01199"></a>01199     <span class="comment"># no compelling reason for Xcode's linker invocations to differ.</span>
<a name="l01200"></a>01200 
<a name="l01201"></a>01201     <span class="keywordflow">if</span> <span class="stringliteral">'dependencies'</span> <span class="keywordflow">in</span> spec:
<a name="l01202"></a>01202       <span class="keywordflow">for</span> dependency <span class="keywordflow">in</span> spec[<span class="stringliteral">'dependencies'</span>]:
<a name="l01203"></a>01203         xct.AddDependency(xcode_targets[dependency])
<a name="l01204"></a>01204         <span class="comment"># The support project also gets the dependencies (in case they are</span>
<a name="l01205"></a>01205         <span class="comment"># needed for the actions/rules to work).</span>
<a name="l01206"></a>01206         <span class="keywordflow">if</span> support_xct:
<a name="l01207"></a>01207           support_xct.AddDependency(xcode_targets[dependency])
<a name="l01208"></a>01208 
<a name="l01209"></a>01209     <span class="keywordflow">if</span> <span class="stringliteral">'libraries'</span> <span class="keywordflow">in</span> spec:
<a name="l01210"></a>01210       <span class="keywordflow">for</span> library <span class="keywordflow">in</span> spec[<span class="stringliteral">'libraries'</span>]:
<a name="l01211"></a>01211         xct.FrameworksPhase().AddFile(library)
<a name="l01212"></a>01212         <span class="comment"># Add the library's directory to LIBRARY_SEARCH_PATHS if necessary.</span>
<a name="l01213"></a>01213         <span class="comment"># I wish Xcode handled this automatically.</span>
<a name="l01214"></a>01214         library_dir = posixpath.dirname(library)
<a name="l01215"></a>01215         <span class="keywordflow">if</span> library_dir <span class="keywordflow">not</span> <span class="keywordflow">in</span> xcode_standard_library_dirs <span class="keywordflow">and</span> (
<a name="l01216"></a>01216             <span class="keywordflow">not</span> xct.HasBuildSetting(_library_search_paths_var) <span class="keywordflow">or</span>
<a name="l01217"></a>01217             library_dir <span class="keywordflow">not</span> <span class="keywordflow">in</span> xct.GetBuildSetting(_library_search_paths_var)):
<a name="l01218"></a>01218           xct.AppendBuildSetting(_library_search_paths_var, library_dir)
<a name="l01219"></a>01219 
<a name="l01220"></a>01220     <span class="keywordflow">for</span> configuration_name <span class="keywordflow">in</span> configuration_names:
<a name="l01221"></a>01221       configuration = spec[<span class="stringliteral">'configurations'</span>][configuration_name]
<a name="l01222"></a>01222       xcbc = xct.ConfigurationNamed(configuration_name)
<a name="l01223"></a>01223       <span class="keywordflow">for</span> include_dir <span class="keywordflow">in</span> configuration.get(<span class="stringliteral">'mac_framework_dirs'</span>, []):
<a name="l01224"></a>01224         xcbc.AppendBuildSetting(<span class="stringliteral">'FRAMEWORK_SEARCH_PATHS'</span>, include_dir)
<a name="l01225"></a>01225       <span class="keywordflow">for</span> include_dir <span class="keywordflow">in</span> configuration.get(<span class="stringliteral">'include_dirs'</span>, []):
<a name="l01226"></a>01226         xcbc.AppendBuildSetting(<span class="stringliteral">'HEADER_SEARCH_PATHS'</span>, include_dir)
<a name="l01227"></a>01227       <span class="keywordflow">for</span> library_dir <span class="keywordflow">in</span> configuration.get(<span class="stringliteral">'library_dirs'</span>, []):
<a name="l01228"></a>01228         <span class="keywordflow">if</span> library_dir <span class="keywordflow">not</span> <span class="keywordflow">in</span> xcode_standard_library_dirs <span class="keywordflow">and</span> (
<a name="l01229"></a>01229             <span class="keywordflow">not</span> xcbc.HasBuildSetting(_library_search_paths_var) <span class="keywordflow">or</span>
<a name="l01230"></a>01230             library_dir <span class="keywordflow">not</span> <span class="keywordflow">in</span> xcbc.GetBuildSetting(_library_search_paths_var)):
<a name="l01231"></a>01231           xcbc.AppendBuildSetting(_library_search_paths_var, library_dir)
<a name="l01232"></a>01232 
<a name="l01233"></a>01233       <span class="keywordflow">if</span> <span class="stringliteral">'defines'</span> <span class="keywordflow">in</span> configuration:
<a name="l01234"></a>01234         <span class="keywordflow">for</span> define <span class="keywordflow">in</span> configuration[<span class="stringliteral">'defines'</span>]:
<a name="l01235"></a>01235           set_define = EscapeXcodeDefine(define)
<a name="l01236"></a>01236           xcbc.AppendBuildSetting(<span class="stringliteral">'GCC_PREPROCESSOR_DEFINITIONS'</span>, set_define)
<a name="l01237"></a>01237       <span class="keywordflow">if</span> <span class="stringliteral">'xcode_settings'</span> <span class="keywordflow">in</span> configuration:
<a name="l01238"></a>01238         <span class="keywordflow">for</span> xck, xcv <span class="keywordflow">in</span> configuration[<span class="stringliteral">'xcode_settings'</span>].iteritems():
<a name="l01239"></a>01239           xcbc.SetBuildSetting(xck, xcv)
<a name="l01240"></a>01240       <span class="keywordflow">if</span> <span class="stringliteral">'xcode_config_file'</span> <span class="keywordflow">in</span> configuration:
<a name="l01241"></a>01241         config_ref = pbxp.AddOrGetFileInRootGroup(
<a name="l01242"></a>01242             configuration[<span class="stringliteral">'xcode_config_file'</span>])
<a name="l01243"></a>01243         xcbc.SetBaseConfiguration(config_ref)
<a name="l01244"></a>01244 
<a name="l01245"></a>01245   build_files = []
<a name="l01246"></a>01246   <span class="keywordflow">for</span> build_file, build_file_dict <span class="keywordflow">in</span> data.iteritems():
<a name="l01247"></a>01247     <span class="keywordflow">if</span> build_file.endswith(<span class="stringliteral">'.gyp'</span>):
<a name="l01248"></a>01248       build_files.append(build_file)
<a name="l01249"></a>01249 
<a name="l01250"></a>01250   <span class="keywordflow">for</span> build_file <span class="keywordflow">in</span> build_files:
<a name="l01251"></a>01251     xcode_projects[build_file].Finalize1(xcode_targets, serialize_all_tests)
<a name="l01252"></a>01252 
<a name="l01253"></a>01253   <span class="keywordflow">for</span> build_file <span class="keywordflow">in</span> build_files:
<a name="l01254"></a>01254     xcode_projects[build_file].Finalize2(xcode_targets,
<a name="l01255"></a>01255                                          xcode_target_to_target_dict)
<a name="l01256"></a>01256 
<a name="l01257"></a>01257   <span class="keywordflow">for</span> build_file <span class="keywordflow">in</span> build_files:
<a name="l01258"></a>01258     xcode_projects[build_file].Write()
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Wed Oct 7 19:26:26 2015 for Emeraldion Lodge (codename Zelda) by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.8 </small></address>
</body>
</html>
