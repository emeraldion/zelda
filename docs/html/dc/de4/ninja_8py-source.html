<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Emeraldion Lodge (codename Zelda): /Users/delphine/Development/SVN/emeraldion.it/zelda/node_modules/gulp-sass/node_modules/node-sass/node_modules/node-gyp/gyp/pylib/gyp/generator/ninja.py Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css">
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.8 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="../../main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="../../files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="../../globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>/Users/delphine/Development/SVN/emeraldion.it/zelda/node_modules/gulp-sass/node_modules/node-sass/node_modules/node-gyp/gyp/pylib/gyp/generator/ninja.py</h1><a href="../../de/db6/ninja_8py.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a><a class="code" href="../../dc/d8b/namespacegyp_1_1generator_1_1ninja.html">00001</a> <span class="comment"># Copyright (c) 2013 Google Inc. All rights reserved.</span>
<a name="l00002"></a>00002 <span class="comment"># Use of this source code is governed by a BSD-style license that can be</span>
<a name="l00003"></a>00003 <span class="comment"># found in the LICENSE file.</span>
<a name="l00004"></a>00004 
<a name="l00005"></a>00005 <span class="keyword">import</span> collections
<a name="l00006"></a>00006 <span class="keyword">import</span> copy
<a name="l00007"></a>00007 <span class="keyword">import</span> hashlib
<a name="l00008"></a>00008 <span class="keyword">import</span> json
<a name="l00009"></a>00009 <span class="keyword">import</span> multiprocessing
<a name="l00010"></a>00010 <span class="keyword">import</span> os.path
<a name="l00011"></a>00011 <span class="keyword">import</span> re
<a name="l00012"></a>00012 <span class="keyword">import</span> signal
<a name="l00013"></a>00013 <span class="keyword">import</span> subprocess
<a name="l00014"></a>00014 <span class="keyword">import</span> sys
<a name="l00015"></a>00015 <span class="keyword">import</span> gyp
<a name="l00016"></a>00016 <span class="keyword">import</span> gyp.common
<a name="l00017"></a>00017 <span class="keyword">from</span> gyp.common <span class="keyword">import</span> OrderedSet
<a name="l00018"></a>00018 <span class="keyword">import</span> gyp.msvs_emulation
<a name="l00019"></a>00019 <span class="keyword">import</span> gyp.MSVSUtil <span class="keyword">as</span> MSVSUtil
<a name="l00020"></a>00020 <span class="keyword">import</span> gyp.xcode_emulation
<a name="l00021"></a>00021 <span class="keyword">from</span> cStringIO <span class="keyword">import</span> StringIO
<a name="l00022"></a>00022 
<a name="l00023"></a>00023 <span class="keyword">from</span> gyp.common <span class="keyword">import</span> GetEnvironFallback
<a name="l00024"></a>00024 <span class="keyword">import</span> gyp.ninja_syntax <span class="keyword">as</span> ninja_syntax
<a name="l00025"></a>00025 
<a name="l00026"></a><a class="code" href="../../dc/d8b/namespacegyp_1_1generator_1_1ninja.html#723b572dde78d9a873e8b0c7936f0624">00026</a> generator_default_variables = {
<a name="l00027"></a>00027   <span class="stringliteral">'EXECUTABLE_PREFIX'</span>: <span class="stringliteral">''</span>,
<a name="l00028"></a>00028   <span class="stringliteral">'EXECUTABLE_SUFFIX'</span>: <span class="stringliteral">''</span>,
<a name="l00029"></a>00029   <span class="stringliteral">'STATIC_LIB_PREFIX'</span>: <span class="stringliteral">'lib'</span>,
<a name="l00030"></a>00030   <span class="stringliteral">'STATIC_LIB_SUFFIX'</span>: <span class="stringliteral">'.a'</span>,
<a name="l00031"></a>00031   <span class="stringliteral">'SHARED_LIB_PREFIX'</span>: <span class="stringliteral">'lib'</span>,
<a name="l00032"></a>00032 
<a name="l00033"></a>00033   <span class="comment"># Gyp expects the following variables to be expandable by the build</span>
<a name="l00034"></a>00034   <span class="comment"># system to the appropriate locations.  Ninja prefers paths to be</span>
<a name="l00035"></a>00035   <span class="comment"># known at gyp time.  To resolve this, introduce special</span>
<a name="l00036"></a>00036   <span class="comment"># variables starting with $! and $| (which begin with a $ so gyp knows it</span>
<a name="l00037"></a>00037   <span class="comment"># should be treated specially, but is otherwise an invalid</span>
<a name="l00038"></a>00038   <span class="comment"># ninja/shell variable) that are passed to gyp here but expanded</span>
<a name="l00039"></a>00039   <span class="comment"># before writing out into the target .ninja files; see</span>
<a name="l00040"></a>00040   <span class="comment"># ExpandSpecial.</span>
<a name="l00041"></a>00041   <span class="comment"># $! is used for variables that represent a path and that can only appear at</span>
<a name="l00042"></a>00042   <span class="comment"># the start of a string, while $| is used for variables that can appear</span>
<a name="l00043"></a>00043   <span class="comment"># anywhere in a string.</span>
<a name="l00044"></a>00044   <span class="stringliteral">'INTERMEDIATE_DIR'</span>: <span class="stringliteral">'$!INTERMEDIATE_DIR'</span>,
<a name="l00045"></a>00045   <span class="stringliteral">'SHARED_INTERMEDIATE_DIR'</span>: <span class="stringliteral">'$!PRODUCT_DIR/gen'</span>,
<a name="l00046"></a>00046   <span class="stringliteral">'PRODUCT_DIR'</span>: <span class="stringliteral">'$!PRODUCT_DIR'</span>,
<a name="l00047"></a>00047   <span class="stringliteral">'CONFIGURATION_NAME'</span>: <span class="stringliteral">'$|CONFIGURATION_NAME'</span>,
<a name="l00048"></a>00048 
<a name="l00049"></a>00049   <span class="comment"># Special variables that may be used by gyp 'rule' targets.</span>
<a name="l00050"></a>00050   <span class="comment"># We generate definitions for these variables on the fly when processing a</span>
<a name="l00051"></a>00051   <span class="comment"># rule.</span>
<a name="l00052"></a>00052   <span class="stringliteral">'RULE_INPUT_ROOT'</span>: <span class="stringliteral">'${root}'</span>,
<a name="l00053"></a>00053   <span class="stringliteral">'RULE_INPUT_DIRNAME'</span>: <span class="stringliteral">'${dirname}'</span>,
<a name="l00054"></a>00054   <span class="stringliteral">'RULE_INPUT_PATH'</span>: <span class="stringliteral">'${source}'</span>,
<a name="l00055"></a>00055   <span class="stringliteral">'RULE_INPUT_EXT'</span>: <span class="stringliteral">'${ext}'</span>,
<a name="l00056"></a>00056   <span class="stringliteral">'RULE_INPUT_NAME'</span>: <span class="stringliteral">'${name}'</span>,
<a name="l00057"></a>00057 }
<a name="l00058"></a>00058 
<a name="l00059"></a>00059 <span class="comment"># Placates pylint.</span>
<a name="l00060"></a><a class="code" href="../../dc/d8b/namespacegyp_1_1generator_1_1ninja.html#e3f6c5e948c3816610850b3c89f2dee4">00060</a> generator_additional_non_configuration_keys = []
<a name="l00061"></a><a class="code" href="../../dc/d8b/namespacegyp_1_1generator_1_1ninja.html#1753481de22edc303822a2b99c378ecf">00061</a> generator_additional_path_sections = []
<a name="l00062"></a><a class="code" href="../../dc/d8b/namespacegyp_1_1generator_1_1ninja.html#e251ca3560612ed2140aea36d2b236fc">00062</a> generator_extra_sources_for_rules = []
<a name="l00063"></a><a class="code" href="../../dc/d8b/namespacegyp_1_1generator_1_1ninja.html#1f2968cb1008020af59e51e6bc806679">00063</a> generator_filelist_paths = <span class="keywordtype">None</span>
<a name="l00064"></a>00064 
<a name="l00065"></a><a class="code" href="../../dc/d8b/namespacegyp_1_1generator_1_1ninja.html#d41dd7fe05f6491ddf1b30d4a9f44d16">00065</a> generator_supports_multiple_toolsets = gyp.common.CrossCompileRequested()
<a name="l00066"></a>00066 
<a name="l00067"></a><a class="code" href="../../dc/d8b/namespacegyp_1_1generator_1_1ninja.html#6ddb129b52498001fcb622bdfd508b35">00067</a> <span class="keyword">def </span><a class="code" href="../../dc/d8b/namespacegyp_1_1generator_1_1ninja.html#6ddb129b52498001fcb622bdfd508b35">StripPrefix</a>(arg, prefix):
<a name="l00068"></a>00068   <span class="keywordflow">if</span> arg.startswith(prefix):
<a name="l00069"></a>00069     <span class="keywordflow">return</span> arg[len(prefix):]
<a name="l00070"></a>00070   <span class="keywordflow">return</span> arg
<a name="l00071"></a>00071 
<a name="l00072"></a>00072 
<a name="l00073"></a><a class="code" href="../../dc/d8b/namespacegyp_1_1generator_1_1ninja.html#f8d310c129bc69701c742bc27542db8c">00073</a> <span class="keyword">def </span><a class="code" href="../../dc/d8b/namespacegyp_1_1generator_1_1ninja.html#f8d310c129bc69701c742bc27542db8c">QuoteShellArgument</a>(arg, flavor):
<a name="l00074"></a>00074   <span class="stringliteral">"""Quote a string such that it will be interpreted as a single argument</span>
<a name="l00075"></a>00075 <span class="stringliteral">  by the shell."""</span>
<a name="l00076"></a>00076   <span class="comment"># Rather than attempting to enumerate the bad shell characters, just</span>
<a name="l00077"></a>00077   <span class="comment"># whitelist common OK ones and quote anything else.</span>
<a name="l00078"></a>00078   <span class="keywordflow">if</span> re.match(<span class="stringliteral">r'^[a-zA-Z0-9_=.\\/-]+$'</span>, arg):
<a name="l00079"></a>00079     <span class="keywordflow">return</span> arg  <span class="comment"># No quoting necessary.</span>
<a name="l00080"></a>00080   <span class="keywordflow">if</span> flavor == <span class="stringliteral">'win'</span>:
<a name="l00081"></a>00081     <span class="keywordflow">return</span> gyp.msvs_emulation.QuoteForRspFile(arg)
<a name="l00082"></a>00082   <span class="keywordflow">return</span> <span class="stringliteral">"'"</span> + arg.replace(<span class="stringliteral">"'"</span>, <span class="stringliteral">"'"</span> + <span class="stringliteral">'"\'"'</span> + <span class="stringliteral">"'"</span>)  + <span class="stringliteral">"'"</span>
<a name="l00083"></a>00083 
<a name="l00084"></a>00084 
<a name="l00085"></a><a class="code" href="../../dc/d8b/namespacegyp_1_1generator_1_1ninja.html#38e82f243098f7aeedc5f22f400866ed">00085</a> <span class="keyword">def </span><a class="code" href="../../dc/d8b/namespacegyp_1_1generator_1_1ninja.html#38e82f243098f7aeedc5f22f400866ed">Define</a>(d, flavor):
<a name="l00086"></a>00086   <span class="stringliteral">"""Takes a preprocessor define and returns a -D parameter that's ninja- and</span>
<a name="l00087"></a>00087 <span class="stringliteral">  shell-escaped."""</span>
<a name="l00088"></a>00088   <span class="keywordflow">if</span> flavor == <span class="stringliteral">'win'</span>:
<a name="l00089"></a>00089     <span class="comment"># cl.exe replaces literal # characters with = in preprocesor definitions for</span>
<a name="l00090"></a>00090     <span class="comment"># some reason. Octal-encode to work around that.</span>
<a name="l00091"></a>00091     d = d.replace(<span class="stringliteral">'#'</span>, <span class="stringliteral">'\\%03o'</span> % ord(<span class="stringliteral">'#'</span>))
<a name="l00092"></a>00092   <span class="keywordflow">return</span> QuoteShellArgument(ninja_syntax.escape(<span class="stringliteral">'-D'</span> + d), flavor)
<a name="l00093"></a>00093 
<a name="l00094"></a>00094 
<a name="l00095"></a><a class="code" href="../../dc/d8b/namespacegyp_1_1generator_1_1ninja.html#9149903099522d9a7211ceb874c492eb">00095</a> <span class="keyword">def </span><a class="code" href="../../dc/d8b/namespacegyp_1_1generator_1_1ninja.html#9149903099522d9a7211ceb874c492eb">AddArch</a>(output, arch):
<a name="l00096"></a>00096   <span class="stringliteral">"""Adds an arch string to an output path."""</span>
<a name="l00097"></a>00097   output, extension = os.path.splitext(output)
<a name="l00098"></a>00098   <span class="keywordflow">return</span> <span class="stringliteral">'%s.%s%s'</span> % (output, arch, extension)
<a name="l00099"></a>00099 
<a name="l00100"></a>00100 
<a name="l00101"></a><a class="code" href="../../d7/d27/classgyp_1_1generator_1_1ninja_1_1_target.html">00101</a> <span class="keyword">class </span><a class="code" href="../../d7/d27/classgyp_1_1generator_1_1ninja_1_1_target.html">Target</a>(object):
<a name="l00102"></a>00102   <span class="stringliteral">"""Target represents the paths used within a single gyp target.</span>
<a name="l00103"></a>00103 <span class="stringliteral"></span>
<a name="l00104"></a>00104 <span class="stringliteral">  Conceptually, building a single target A is a series of steps:</span>
<a name="l00105"></a>00105 <span class="stringliteral"></span>
<a name="l00106"></a>00106 <span class="stringliteral">  1) actions/rules/copies  generates source/resources/etc.</span>
<a name="l00107"></a>00107 <span class="stringliteral">  2) compiles              generates .o files</span>
<a name="l00108"></a>00108 <span class="stringliteral">  3) link                  generates a binary (library/executable)</span>
<a name="l00109"></a>00109 <span class="stringliteral">  4) bundle                merges the above in a mac bundle</span>
<a name="l00110"></a>00110 <span class="stringliteral"></span>
<a name="l00111"></a>00111 <span class="stringliteral">  (Any of these steps can be optional.)</span>
<a name="l00112"></a>00112 <span class="stringliteral"></span>
<a name="l00113"></a>00113 <span class="stringliteral">  From a build ordering perspective, a dependent target B could just</span>
<a name="l00114"></a>00114 <span class="stringliteral">  depend on the last output of this series of steps.</span>
<a name="l00115"></a>00115 <span class="stringliteral"></span>
<a name="l00116"></a>00116 <span class="stringliteral">  But some dependent commands sometimes need to reach inside the box.</span>
<a name="l00117"></a>00117 <span class="stringliteral">  For example, when linking B it needs to get the path to the static</span>
<a name="l00118"></a>00118 <span class="stringliteral">  library generated by A.</span>
<a name="l00119"></a>00119 <span class="stringliteral"></span>
<a name="l00120"></a>00120 <span class="stringliteral">  This object stores those paths.  To keep things simple, member</span>
<a name="l00121"></a>00121 <span class="stringliteral">  variables only store concrete paths to single files, while methods</span>
<a name="l00122"></a>00122 <span class="stringliteral">  compute derived values like "the last output of the target".</span>
<a name="l00123"></a>00123 <span class="stringliteral">  """</span>
<a name="l00124"></a><a class="code" href="../../d7/d27/classgyp_1_1generator_1_1ninja_1_1_target.html#c775ee34451fdfa742b318538164070e">00124</a>   <span class="keyword">def </span><a class="code" href="../../d7/d27/classgyp_1_1generator_1_1ninja_1_1_target.html#c775ee34451fdfa742b318538164070e">__init__</a>(self, type):
<a name="l00125"></a>00125     <span class="comment"># Gyp type ("static_library", etc.) of this target.</span>
<a name="l00126"></a><a class="code" href="../../d7/d27/classgyp_1_1generator_1_1ninja_1_1_target.html#7aead736a07eaf25623ad7bfa1f0ee2d">00126</a>     self.<a class="code" href="../../d7/d27/classgyp_1_1generator_1_1ninja_1_1_target.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> = type
<a name="l00127"></a>00127     <span class="comment"># File representing whether any input dependencies necessary for</span>
<a name="l00128"></a>00128     <span class="comment"># dependent actions have completed.</span>
<a name="l00129"></a><a class="code" href="../../d7/d27/classgyp_1_1generator_1_1ninja_1_1_target.html#967d55e16f679085859be50010e8b0ad">00129</a>     self.<a class="code" href="../../d7/d27/classgyp_1_1generator_1_1ninja_1_1_target.html#967d55e16f679085859be50010e8b0ad">preaction_stamp</a> = <span class="keywordtype">None</span>
<a name="l00130"></a>00130     <span class="comment"># File representing whether any input dependencies necessary for</span>
<a name="l00131"></a>00131     <span class="comment"># dependent compiles have completed.</span>
<a name="l00132"></a><a class="code" href="../../d7/d27/classgyp_1_1generator_1_1ninja_1_1_target.html#8c32ad733f9ceea6b7d27d1499ac6ad9">00132</a>     self.<a class="code" href="../../d7/d27/classgyp_1_1generator_1_1ninja_1_1_target.html#8c32ad733f9ceea6b7d27d1499ac6ad9">precompile_stamp</a> = <span class="keywordtype">None</span>
<a name="l00133"></a>00133     <span class="comment"># File representing the completion of actions/rules/copies, if any.</span>
<a name="l00134"></a><a class="code" href="../../d7/d27/classgyp_1_1generator_1_1ninja_1_1_target.html#9836d4441f69429f68b5332bd5ff0351">00134</a>     self.<a class="code" href="../../d7/d27/classgyp_1_1generator_1_1ninja_1_1_target.html#9836d4441f69429f68b5332bd5ff0351">actions_stamp</a> = <span class="keywordtype">None</span>
<a name="l00135"></a>00135     <span class="comment"># Path to the output of the link step, if any.</span>
<a name="l00136"></a><a class="code" href="../../d7/d27/classgyp_1_1generator_1_1ninja_1_1_target.html#e3589d2893bbb25770cc75b020746508">00136</a>     self.<a class="code" href="../../d7/d27/classgyp_1_1generator_1_1ninja_1_1_target.html#e3589d2893bbb25770cc75b020746508">binary</a> = <span class="keywordtype">None</span>
<a name="l00137"></a>00137     <span class="comment"># Path to the file representing the completion of building the bundle,</span>
<a name="l00138"></a>00138     <span class="comment"># if any.</span>
<a name="l00139"></a><a class="code" href="../../d7/d27/classgyp_1_1generator_1_1ninja_1_1_target.html#a45c85b913b301570dfbec1bf1a0a4b5">00139</a>     self.<a class="code" href="../../d7/d27/classgyp_1_1generator_1_1ninja_1_1_target.html#a45c85b913b301570dfbec1bf1a0a4b5">bundle</a> = <span class="keywordtype">None</span>
<a name="l00140"></a>00140     <span class="comment"># On Windows, incremental linking requires linking against all the .objs</span>
<a name="l00141"></a>00141     <span class="comment"># that compose a .lib (rather than the .lib itself). That list is stored</span>
<a name="l00142"></a>00142     <span class="comment"># here.</span>
<a name="l00143"></a><a class="code" href="../../d7/d27/classgyp_1_1generator_1_1ninja_1_1_target.html#c3d8ee83528cbc61861aa12f909474ca">00143</a>     self.<a class="code" href="../../d7/d27/classgyp_1_1generator_1_1ninja_1_1_target.html#c3d8ee83528cbc61861aa12f909474ca">component_objs</a> = <span class="keywordtype">None</span>
<a name="l00144"></a>00144     <span class="comment"># Windows only. The import .lib is the output of a build step, but</span>
<a name="l00145"></a>00145     <span class="comment"># because dependents only link against the lib (not both the lib and the</span>
<a name="l00146"></a>00146     <span class="comment"># dll) we keep track of the import library here.</span>
<a name="l00147"></a><a class="code" href="../../d7/d27/classgyp_1_1generator_1_1ninja_1_1_target.html#fdeb889ffaf92940df48421b5e670ab6">00147</a>     self.<a class="code" href="../../d7/d27/classgyp_1_1generator_1_1ninja_1_1_target.html#fdeb889ffaf92940df48421b5e670ab6">import_lib</a> = <span class="keywordtype">None</span>
<a name="l00148"></a>00148 
<a name="l00149"></a><a class="code" href="../../d7/d27/classgyp_1_1generator_1_1ninja_1_1_target.html#afc47f8360cc512a96886c69f5442805">00149</a>   <span class="keyword">def </span><a class="code" href="../../d7/d27/classgyp_1_1generator_1_1ninja_1_1_target.html#afc47f8360cc512a96886c69f5442805">Linkable</a>(self):
<a name="l00150"></a>00150     <span class="stringliteral">"""Return true if this is a target that can be linked against."""</span>
<a name="l00151"></a>00151     <span class="keywordflow">return</span> self.<a class="code" href="../../d7/d27/classgyp_1_1generator_1_1ninja_1_1_target.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> <span class="keywordflow">in</span> (<span class="stringliteral">'static_library'</span>, <span class="stringliteral">'shared_library'</span>)
<a name="l00152"></a>00152 
<a name="l00153"></a><a class="code" href="../../d7/d27/classgyp_1_1generator_1_1ninja_1_1_target.html#5c7a8f4b85a2da815de5373088ee9c56">00153</a>   <span class="keyword">def </span><a class="code" href="../../d7/d27/classgyp_1_1generator_1_1ninja_1_1_target.html#5c7a8f4b85a2da815de5373088ee9c56">UsesToc</a>(self, flavor):
<a name="l00154"></a>00154     <span class="stringliteral">"""Return true if the target should produce a restat rule based on a TOC</span>
<a name="l00155"></a>00155 <span class="stringliteral">    file."""</span>
<a name="l00156"></a>00156     <span class="comment"># For bundles, the .TOC should be produced for the binary, not for</span>
<a name="l00157"></a>00157     <span class="comment"># FinalOutput(). But the naive approach would put the TOC file into the</span>
<a name="l00158"></a>00158     <span class="comment"># bundle, so don't do this for bundles for now.</span>
<a name="l00159"></a>00159     <span class="keywordflow">if</span> flavor == <span class="stringliteral">'win'</span> <span class="keywordflow">or</span> self.<a class="code" href="../../d7/d27/classgyp_1_1generator_1_1ninja_1_1_target.html#a45c85b913b301570dfbec1bf1a0a4b5">bundle</a>:
<a name="l00160"></a>00160       <span class="keywordflow">return</span> <span class="keyword">False</span>
<a name="l00161"></a>00161     <span class="keywordflow">return</span> self.<a class="code" href="../../d7/d27/classgyp_1_1generator_1_1ninja_1_1_target.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> <span class="keywordflow">in</span> (<span class="stringliteral">'shared_library'</span>, <span class="stringliteral">'loadable_module'</span>)
<a name="l00162"></a>00162 
<a name="l00163"></a><a class="code" href="../../d7/d27/classgyp_1_1generator_1_1ninja_1_1_target.html#6a14e72a07b6c82bac7933603795dec9">00163</a>   <span class="keyword">def </span><a class="code" href="../../d7/d27/classgyp_1_1generator_1_1ninja_1_1_target.html#6a14e72a07b6c82bac7933603795dec9">PreActionInput</a>(self, flavor):
<a name="l00164"></a>00164     <span class="stringliteral">"""Return the path, if any, that should be used as a dependency of</span>
<a name="l00165"></a>00165 <span class="stringliteral">    any dependent action step."""</span>
<a name="l00166"></a>00166     <span class="keywordflow">if</span> self.<a class="code" href="../../d7/d27/classgyp_1_1generator_1_1ninja_1_1_target.html#5c7a8f4b85a2da815de5373088ee9c56">UsesToc</a>(flavor):
<a name="l00167"></a>00167       <span class="keywordflow">return</span> self.<a class="code" href="../../d7/d27/classgyp_1_1generator_1_1ninja_1_1_target.html#d35a234c4f1200b10e923d7b32eb7379">FinalOutput</a>() + <span class="stringliteral">'.TOC'</span>
<a name="l00168"></a>00168     <span class="keywordflow">return</span> self.<a class="code" href="../../d7/d27/classgyp_1_1generator_1_1ninja_1_1_target.html#d35a234c4f1200b10e923d7b32eb7379">FinalOutput</a>() <span class="keywordflow">or</span> self.<a class="code" href="../../d7/d27/classgyp_1_1generator_1_1ninja_1_1_target.html#967d55e16f679085859be50010e8b0ad">preaction_stamp</a>
<a name="l00169"></a>00169 
<a name="l00170"></a><a class="code" href="../../d7/d27/classgyp_1_1generator_1_1ninja_1_1_target.html#78fd6ab79d0bff4990555e64a3bbbd28">00170</a>   <span class="keyword">def </span><a class="code" href="../../d7/d27/classgyp_1_1generator_1_1ninja_1_1_target.html#78fd6ab79d0bff4990555e64a3bbbd28">PreCompileInput</a>(self):
<a name="l00171"></a>00171     <span class="stringliteral">"""Return the path, if any, that should be used as a dependency of</span>
<a name="l00172"></a>00172 <span class="stringliteral">    any dependent compile step."""</span>
<a name="l00173"></a>00173     <span class="keywordflow">return</span> self.<a class="code" href="../../d7/d27/classgyp_1_1generator_1_1ninja_1_1_target.html#9836d4441f69429f68b5332bd5ff0351">actions_stamp</a> <span class="keywordflow">or</span> self.<a class="code" href="../../d7/d27/classgyp_1_1generator_1_1ninja_1_1_target.html#8c32ad733f9ceea6b7d27d1499ac6ad9">precompile_stamp</a>
<a name="l00174"></a>00174 
<a name="l00175"></a><a class="code" href="../../d7/d27/classgyp_1_1generator_1_1ninja_1_1_target.html#d35a234c4f1200b10e923d7b32eb7379">00175</a>   <span class="keyword">def </span><a class="code" href="../../d7/d27/classgyp_1_1generator_1_1ninja_1_1_target.html#d35a234c4f1200b10e923d7b32eb7379">FinalOutput</a>(self):
<a name="l00176"></a>00176     <span class="stringliteral">"""Return the last output of the target, which depends on all prior</span>
<a name="l00177"></a>00177 <span class="stringliteral">    steps."""</span>
<a name="l00178"></a>00178     <span class="keywordflow">return</span> self.<a class="code" href="../../d7/d27/classgyp_1_1generator_1_1ninja_1_1_target.html#a45c85b913b301570dfbec1bf1a0a4b5">bundle</a> <span class="keywordflow">or</span> self.<a class="code" href="../../d7/d27/classgyp_1_1generator_1_1ninja_1_1_target.html#e3589d2893bbb25770cc75b020746508">binary</a> <span class="keywordflow">or</span> self.<a class="code" href="../../d7/d27/classgyp_1_1generator_1_1ninja_1_1_target.html#9836d4441f69429f68b5332bd5ff0351">actions_stamp</a>
<a name="l00179"></a>00179 
<a name="l00180"></a>00180 
<a name="l00181"></a>00181 <span class="comment"># A small discourse on paths as used within the Ninja build:</span>
<a name="l00182"></a>00182 <span class="comment"># All files we produce (both at gyp and at build time) appear in the</span>
<a name="l00183"></a>00183 <span class="comment"># build directory (e.g. out/Debug).</span>
<a name="l00184"></a>00184 <span class="comment">#</span>
<a name="l00185"></a>00185 <span class="comment"># Paths within a given .gyp file are always relative to the directory</span>
<a name="l00186"></a>00186 <span class="comment"># containing the .gyp file.  Call these "gyp paths".  This includes</span>
<a name="l00187"></a>00187 <span class="comment"># sources as well as the starting directory a given gyp rule/action</span>
<a name="l00188"></a>00188 <span class="comment"># expects to be run from.  We call the path from the source root to</span>
<a name="l00189"></a>00189 <span class="comment"># the gyp file the "base directory" within the per-.gyp-file</span>
<a name="l00190"></a>00190 <span class="comment"># NinjaWriter code.</span>
<a name="l00191"></a>00191 <span class="comment">#</span>
<a name="l00192"></a>00192 <span class="comment"># All paths as written into the .ninja files are relative to the build</span>
<a name="l00193"></a>00193 <span class="comment"># directory.  Call these paths "ninja paths".</span>
<a name="l00194"></a>00194 <span class="comment">#</span>
<a name="l00195"></a>00195 <span class="comment"># We translate between these two notions of paths with two helper</span>
<a name="l00196"></a>00196 <span class="comment"># functions:</span>
<a name="l00197"></a>00197 <span class="comment">#</span>
<a name="l00198"></a>00198 <span class="comment"># - GypPathToNinja translates a gyp path (i.e. relative to the .gyp file)</span>
<a name="l00199"></a>00199 <span class="comment">#   into the equivalent ninja path.</span>
<a name="l00200"></a>00200 <span class="comment">#</span>
<a name="l00201"></a>00201 <span class="comment"># - GypPathToUniqueOutput translates a gyp path into a ninja path to write</span>
<a name="l00202"></a>00202 <span class="comment">#   an output file; the result can be namespaced such that it is unique</span>
<a name="l00203"></a>00203 <span class="comment">#   to the input file name as well as the output target name.</span>
<a name="l00204"></a>00204 
<a name="l00205"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html">00205</a> <span class="keyword">class </span><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html">NinjaWriter</a>(object):
<a name="l00206"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#c775ee34451fdfa742b318538164070e">00206</a>   <span class="keyword">def </span><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#c775ee34451fdfa742b318538164070e">__init__</a>(self, hash_for_rules, target_outputs, base_dir, build_dir,
<a name="l00207"></a>00207                output_file, toplevel_build, output_file_name, flavor,
<a name="l00208"></a>00208                toplevel_dir=<span class="keywordtype">None</span>):
<a name="l00209"></a>00209     <span class="stringliteral">"""</span>
<a name="l00210"></a>00210 <span class="stringliteral">    base_dir: path from source root to directory containing this gyp file,</span>
<a name="l00211"></a>00211 <span class="stringliteral">              by gyp semantics, all input paths are relative to this</span>
<a name="l00212"></a>00212 <span class="stringliteral">    build_dir: path from source root to build output</span>
<a name="l00213"></a>00213 <span class="stringliteral">    toplevel_dir: path to the toplevel directory</span>
<a name="l00214"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#e3a650ea7c881164767e0369cb34b02e">00214</a> <span class="stringliteral">    """</span>
<a name="l00215"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#459cc34c149ee1fd281ba6c024ca2ce9">00215</a> 
<a name="l00216"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#8ef3db3a5273b76c536881adb1ddeb63">00216</a>     self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#e3a650ea7c881164767e0369cb34b02e">hash_for_rules</a> = hash_for_rules
<a name="l00217"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#f62ac26cf3748a56c08441e6fe6fced6">00217</a>     self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#459cc34c149ee1fd281ba6c024ca2ce9">target_outputs</a> = target_outputs
<a name="l00218"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb01ca7812bd411b26f759814e304a4c">00218</a>     self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#8ef3db3a5273b76c536881adb1ddeb63">base_dir</a> = base_dir
<a name="l00219"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#9968ef52a3e29a0d1fbcdb727c7dd318">00219</a>     self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#f62ac26cf3748a56c08441e6fe6fced6">build_dir</a> = build_dir
<a name="l00220"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#6c4a8447bc01e535c1d553686755a801">00220</a>     self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb01ca7812bd411b26f759814e304a4c">ninja</a> = ninja_syntax.Writer(output_file)
<a name="l00221"></a>00221     self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#9968ef52a3e29a0d1fbcdb727c7dd318">toplevel_build</a> = toplevel_build
<a name="l00222"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">00222</a>     self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#6c4a8447bc01e535c1d553686755a801">output_file_name</a> = output_file_name
<a name="l00223"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#d453fd01340f10261a7525e604aba57d">00223</a> 
<a name="l00224"></a>00224     self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> = flavor
<a name="l00225"></a>00225     self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#d453fd01340f10261a7525e604aba57d">abs_build_dir</a> = <span class="keywordtype">None</span>
<a name="l00226"></a>00226     <span class="keywordflow">if</span> toplevel_dir <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:
<a name="l00227"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#22730c3bc6462078334e2d5bb4e30f3b">00227</a>       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#d453fd01340f10261a7525e604aba57d">abs_build_dir</a> = os.path.abspath(os.path.join(toplevel_dir,
<a name="l00228"></a>00228                                                         build_dir))
<a name="l00229"></a>00229     self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#22730c3bc6462078334e2d5bb4e30f3b">obj_ext</a> = <span class="stringliteral">'.obj'</span> <span class="keywordflow">if</span> flavor == <span class="stringliteral">'win'</span> <span class="keywordflow">else</span> <span class="stringliteral">'.o'</span>
<a name="l00230"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#786bcf61d8c4d249c4d42c2db95e2d2d">00230</a>     <span class="keywordflow">if</span> flavor == <span class="stringliteral">'win'</span>:
<a name="l00231"></a>00231       <span class="comment"># See docstring of msvs_emulation.GenerateEnvironmentFiles().</span>
<a name="l00232"></a>00232       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#786bcf61d8c4d249c4d42c2db95e2d2d">win_env</a> = {}
<a name="l00233"></a>00233       <span class="keywordflow">for</span> arch <span class="keywordflow">in</span> (<span class="stringliteral">'x86'</span>, <span class="stringliteral">'x64'</span>):
<a name="l00234"></a>00234         self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#786bcf61d8c4d249c4d42c2db95e2d2d">win_env</a>[arch] = <span class="stringliteral">'environment.'</span> + arch
<a name="l00235"></a>00235 
<a name="l00236"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#8ded59d104c76d6be39fa117857b506a">00236</a>     <span class="comment"># Relative path from build output dir to base dir.</span>
<a name="l00237"></a>00237     build_to_top = gyp.common.InvertRelativePath(build_dir, toplevel_dir)
<a name="l00238"></a>00238     self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#8ded59d104c76d6be39fa117857b506a">build_to_base</a> = os.path.join(build_to_top, base_dir)
<a name="l00239"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#f58e3265fc7bfc95156adcf21ffc7220">00239</a>     <span class="comment"># Relative path from base dir to build dir.</span>
<a name="l00240"></a>00240     base_to_top = gyp.common.InvertRelativePath(base_dir, toplevel_dir)
<a name="l00241"></a>00241     self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#f58e3265fc7bfc95156adcf21ffc7220">base_to_build</a> = os.path.join(base_to_top, build_dir)
<a name="l00242"></a>00242 
<a name="l00243"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#eca47f2b3a42089c33330749acfd861a">00243</a>   <span class="keyword">def </span><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#eca47f2b3a42089c33330749acfd861a">ExpandSpecial</a>(self, path, product_dir=None):
<a name="l00244"></a>00244     <span class="stringliteral">"""Expand specials like $!PRODUCT_DIR in |path|.</span>
<a name="l00245"></a>00245 <span class="stringliteral"></span>
<a name="l00246"></a>00246 <span class="stringliteral">    If |product_dir| is None, assumes the cwd is already the product</span>
<a name="l00247"></a>00247 <span class="stringliteral">    dir.  Otherwise, |product_dir| is the relative path to the product</span>
<a name="l00248"></a>00248 <span class="stringliteral">    dir.</span>
<a name="l00249"></a>00249 <span class="stringliteral">    """</span>
<a name="l00250"></a>00250 
<a name="l00251"></a>00251     PRODUCT_DIR = <span class="stringliteral">'$!PRODUCT_DIR'</span>
<a name="l00252"></a>00252     <span class="keywordflow">if</span> PRODUCT_DIR <span class="keywordflow">in</span> path:
<a name="l00253"></a>00253       <span class="keywordflow">if</span> product_dir:
<a name="l00254"></a>00254         path = path.replace(PRODUCT_DIR, product_dir)
<a name="l00255"></a>00255       <span class="keywordflow">else</span>:
<a name="l00256"></a>00256         path = path.replace(PRODUCT_DIR + <span class="stringliteral">'/'</span>, <span class="stringliteral">''</span>)
<a name="l00257"></a>00257         path = path.replace(PRODUCT_DIR + <span class="stringliteral">'\\'</span>, <span class="stringliteral">''</span>)
<a name="l00258"></a>00258         path = path.replace(PRODUCT_DIR, <span class="stringliteral">'.'</span>)
<a name="l00259"></a>00259 
<a name="l00260"></a>00260     INTERMEDIATE_DIR = <span class="stringliteral">'$!INTERMEDIATE_DIR'</span>
<a name="l00261"></a>00261     <span class="keywordflow">if</span> INTERMEDIATE_DIR <span class="keywordflow">in</span> path:
<a name="l00262"></a>00262       int_dir = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#1a32eebd8c4ae6c6c2eb0db303f1952b">GypPathToUniqueOutput</a>(<span class="stringliteral">'gen'</span>)
<a name="l00263"></a>00263       <span class="comment"># GypPathToUniqueOutput generates a path relative to the product dir,</span>
<a name="l00264"></a>00264       <span class="comment"># so insert product_dir in front if it is provided.</span>
<a name="l00265"></a>00265       path = path.replace(INTERMEDIATE_DIR,
<a name="l00266"></a>00266                           os.path.join(product_dir <span class="keywordflow">or</span> <span class="stringliteral">''</span>, int_dir))
<a name="l00267"></a>00267 
<a name="l00268"></a>00268     CONFIGURATION_NAME = <span class="stringliteral">'$|CONFIGURATION_NAME'</span>
<a name="l00269"></a>00269     path = path.replace(CONFIGURATION_NAME, self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#72c8aa1d973690508a559237475202c6">config_name</a>)
<a name="l00270"></a>00270 
<a name="l00271"></a>00271     <span class="keywordflow">return</span> path
<a name="l00272"></a>00272 
<a name="l00273"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#7381adae5ca6d27078da99f41f353a8d">00273</a>   <span class="keyword">def </span><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#7381adae5ca6d27078da99f41f353a8d">ExpandRuleVariables</a>(self, path, root, dirname, source, ext, name):
<a name="l00274"></a>00274     <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'win'</span>:
<a name="l00275"></a>00275       path = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#05976cc272fa4d277ce291f093ca63be">msvs_settings</a>.ConvertVSMacros(
<a name="l00276"></a>00276           path, config=self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#72c8aa1d973690508a559237475202c6">config_name</a>)
<a name="l00277"></a>00277     path = path.replace(generator_default_variables[<span class="stringliteral">'RULE_INPUT_ROOT'</span>], root)
<a name="l00278"></a>00278     path = path.replace(generator_default_variables[<span class="stringliteral">'RULE_INPUT_DIRNAME'</span>],
<a name="l00279"></a>00279                         dirname)
<a name="l00280"></a>00280     path = path.replace(generator_default_variables[<span class="stringliteral">'RULE_INPUT_PATH'</span>], source)
<a name="l00281"></a>00281     path = path.replace(generator_default_variables[<span class="stringliteral">'RULE_INPUT_EXT'</span>], ext)
<a name="l00282"></a>00282     path = path.replace(generator_default_variables[<span class="stringliteral">'RULE_INPUT_NAME'</span>], name)
<a name="l00283"></a>00283     <span class="keywordflow">return</span> path
<a name="l00284"></a>00284 
<a name="l00285"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#3770e8a9cc0f198dbc8344cbf6347c22">00285</a>   <span class="keyword">def </span><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#3770e8a9cc0f198dbc8344cbf6347c22">GypPathToNinja</a>(self, path, env=None):
<a name="l00286"></a>00286     <span class="stringliteral">"""Translate a gyp path to a ninja path, optionally expanding environment</span>
<a name="l00287"></a>00287 <span class="stringliteral">    variable references in |path| with |env|.</span>
<a name="l00288"></a>00288 <span class="stringliteral"></span>
<a name="l00289"></a>00289 <span class="stringliteral">    See the above discourse on path conversions."""</span>
<a name="l00290"></a>00290     <span class="keywordflow">if</span> env:
<a name="l00291"></a>00291       <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'mac'</span>:
<a name="l00292"></a>00292         path = gyp.xcode_emulation.ExpandEnvVars(path, env)
<a name="l00293"></a>00293       <span class="keywordflow">elif</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'win'</span>:
<a name="l00294"></a>00294         path = gyp.msvs_emulation.ExpandMacros(path, env)
<a name="l00295"></a>00295     <span class="keywordflow">if</span> path.startswith(<span class="stringliteral">'$!'</span>):
<a name="l00296"></a>00296       expanded = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#eca47f2b3a42089c33330749acfd861a">ExpandSpecial</a>(path)
<a name="l00297"></a>00297       <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'win'</span>:
<a name="l00298"></a>00298         expanded = os.path.normpath(expanded)
<a name="l00299"></a>00299       <span class="keywordflow">return</span> expanded
<a name="l00300"></a>00300     <span class="keywordflow">if</span> <span class="stringliteral">'$|'</span> <span class="keywordflow">in</span> path:
<a name="l00301"></a>00301       path = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#eca47f2b3a42089c33330749acfd861a">ExpandSpecial</a>(path)
<a name="l00302"></a>00302     <span class="keyword">assert</span> <span class="stringliteral">'$'</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> path, path
<a name="l00303"></a>00303     <span class="keywordflow">return</span> os.path.normpath(os.path.join(self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#8ded59d104c76d6be39fa117857b506a">build_to_base</a>, path))
<a name="l00304"></a>00304 
<a name="l00305"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#1a32eebd8c4ae6c6c2eb0db303f1952b">00305</a>   <span class="keyword">def </span><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#1a32eebd8c4ae6c6c2eb0db303f1952b">GypPathToUniqueOutput</a>(self, path, qualified=True):
<a name="l00306"></a>00306     <span class="stringliteral">"""Translate a gyp path to a ninja path for writing output.</span>
<a name="l00307"></a>00307 <span class="stringliteral"></span>
<a name="l00308"></a>00308 <span class="stringliteral">    If qualified is True, qualify the resulting filename with the name</span>
<a name="l00309"></a>00309 <span class="stringliteral">    of the target.  This is necessary when e.g. compiling the same</span>
<a name="l00310"></a>00310 <span class="stringliteral">    path twice for two separate output targets.</span>
<a name="l00311"></a>00311 <span class="stringliteral"></span>
<a name="l00312"></a>00312 <span class="stringliteral">    See the above discourse on path conversions."""</span>
<a name="l00313"></a>00313 
<a name="l00314"></a>00314     path = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#eca47f2b3a42089c33330749acfd861a">ExpandSpecial</a>(path)
<a name="l00315"></a>00315     <span class="keyword">assert</span> <span class="keywordflow">not</span> path.startswith(<span class="stringliteral">'$'</span>), path
<a name="l00316"></a>00316 
<a name="l00317"></a>00317     <span class="comment"># Translate the path following this scheme:</span>
<a name="l00318"></a>00318     <span class="comment">#   Input: foo/bar.gyp, target targ, references baz/out.o</span>
<a name="l00319"></a>00319     <span class="comment">#   Output: obj/foo/baz/targ.out.o (if qualified)</span>
<a name="l00320"></a>00320     <span class="comment">#           obj/foo/baz/out.o (otherwise)</span>
<a name="l00321"></a>00321     <span class="comment">#     (and obj.host instead of obj for cross-compiles)</span>
<a name="l00322"></a>00322     <span class="comment">#</span>
<a name="l00323"></a>00323     <span class="comment"># Why this scheme and not some other one?</span>
<a name="l00324"></a>00324     <span class="comment"># 1) for a given input, you can compute all derived outputs by matching</span>
<a name="l00325"></a>00325     <span class="comment">#    its path, even if the input is brought via a gyp file with '..'.</span>
<a name="l00326"></a>00326     <span class="comment"># 2) simple files like libraries and stamps have a simple filename.</span>
<a name="l00327"></a>00327 
<a name="l00328"></a>00328     obj = <span class="stringliteral">'obj'</span>
<a name="l00329"></a>00329     <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">toolset</a> != <span class="stringliteral">'target'</span>:
<a name="l00330"></a>00330       obj += <span class="stringliteral">'.'</span> + self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">toolset</a>
<a name="l00331"></a>00331 
<a name="l00332"></a>00332     path_dir, path_basename = os.path.split(path)
<a name="l00333"></a>00333     <span class="keyword">assert</span> <span class="keywordflow">not</span> os.path.isabs(path_dir), (
<a name="l00334"></a>00334         <span class="stringliteral">"'%s' can not be absolute path (see crbug.com/462153)."</span> % path_dir)
<a name="l00335"></a>00335 
<a name="l00336"></a>00336     <span class="keywordflow">if</span> qualified:
<a name="l00337"></a>00337       path_basename = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#b74e6bf80237ddc4109968cedc58c151">name</a> + <span class="stringliteral">'.'</span> + path_basename
<a name="l00338"></a>00338     <span class="keywordflow">return</span> os.path.normpath(os.path.join(obj, self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#8ef3db3a5273b76c536881adb1ddeb63">base_dir</a>, path_dir,
<a name="l00339"></a>00339                                          path_basename))
<a name="l00340"></a>00340 
<a name="l00341"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#3d0b3c5135128d164f44e7c6a0b7289a">00341</a>   <span class="keyword">def </span><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#3d0b3c5135128d164f44e7c6a0b7289a">WriteCollapsedDependencies</a>(self, name, targets, order_only=None):
<a name="l00342"></a>00342     <span class="stringliteral">"""Given a list of targets, return a path for a single file</span>
<a name="l00343"></a>00343 <span class="stringliteral">    representing the result of building all the targets or None.</span>
<a name="l00344"></a>00344 <span class="stringliteral"></span>
<a name="l00345"></a>00345 <span class="stringliteral">    Uses a stamp file if necessary."""</span>
<a name="l00346"></a>00346 
<a name="l00347"></a>00347     <span class="keyword">assert</span> targets == filter(<span class="keywordtype">None</span>, targets), targets
<a name="l00348"></a>00348     <span class="keywordflow">if</span> len(targets) == 0:
<a name="l00349"></a>00349       <span class="keyword">assert</span> <span class="keywordflow">not</span> order_only
<a name="l00350"></a>00350       <span class="keywordflow">return</span> <span class="keywordtype">None</span>
<a name="l00351"></a>00351     <span class="keywordflow">if</span> len(targets) &gt; 1 <span class="keywordflow">or</span> order_only:
<a name="l00352"></a>00352       stamp = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#1a32eebd8c4ae6c6c2eb0db303f1952b">GypPathToUniqueOutput</a>(name + <span class="stringliteral">'.stamp'</span>)
<a name="l00353"></a>00353       targets = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb01ca7812bd411b26f759814e304a4c">ninja</a>.build(stamp, <span class="stringliteral">'stamp'</span>, targets, order_only=order_only)
<a name="l00354"></a>00354       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb01ca7812bd411b26f759814e304a4c">ninja</a>.newline()
<a name="l00355"></a>00355     <span class="keywordflow">return</span> targets[0]
<a name="l00356"></a>00356 
<a name="l00357"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#a2a9c775962bc029e1f03a859c1b89a8">00357</a>   <span class="keyword">def </span><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#a2a9c775962bc029e1f03a859c1b89a8">_SubninjaNameForArch</a>(self, arch):
<a name="l00358"></a>00358     output_file_base = os.path.splitext(self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#6c4a8447bc01e535c1d553686755a801">output_file_name</a>)[0]
<a name="l00359"></a>00359     <span class="keywordflow">return</span> <span class="stringliteral">'%s.%s.ninja'</span> % (output_file_base, arch)
<a name="l00360"></a>00360 
<a name="l00361"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#a92b72c9c288364d5385aeab060c9563">00361</a>   <span class="keyword">def </span><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#a92b72c9c288364d5385aeab060c9563">WriteSpec</a>(self, spec, config_name, generator_flags):
<a name="l00362"></a>00362     <span class="stringliteral">"""The main entry point for NinjaWriter: write the build rules for a spec.</span>
<a name="l00363"></a>00363 <span class="stringliteral"></span>
<a name="l00364"></a>00364 <span class="stringliteral">    Returns a Target object, which represents the output paths for this spec.</span>
<a name="l00365"></a>00365 <span class="stringliteral">    Returns None if there are no outputs (e.g. a settings-only 'none' type</span>
<a name="l00366"></a>00366 <span class="stringliteral">    target)."""</span>
<a name="l00367"></a>00367 
<a name="l00368"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#72c8aa1d973690508a559237475202c6">00368</a>     self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#72c8aa1d973690508a559237475202c6">config_name</a> = config_name
<a name="l00369"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#b74e6bf80237ddc4109968cedc58c151">00369</a>     self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#b74e6bf80237ddc4109968cedc58c151">name</a> = spec[<span class="stringliteral">'target_name'</span>]
<a name="l00370"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">00370</a>     self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">toolset</a> = spec[<span class="stringliteral">'toolset'</span>]
<a name="l00371"></a>00371     config = spec[<span class="stringliteral">'configurations'</span>][config_name]
<a name="l00372"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#5d2c023108742a1ce78ba9823c06ea35">00372</a>     self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a> = Target(spec[<span class="stringliteral">'type'</span>])
<a name="l00373"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#33917fd9cc5a5320b45b7f9db0754069">00373</a>     self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#33917fd9cc5a5320b45b7f9db0754069">is_standalone_static_library</a> = bool(
<a name="l00374"></a>00374         spec.get(<span class="stringliteral">'standalone_static_library'</span>, 0))
<a name="l00375"></a>00375     <span class="comment"># Track if this target contains any C++ files, to decide if gcc or g++</span>
<a name="l00376"></a>00376     <span class="comment"># should be used for linking.</span>
<a name="l00377"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#644859abf0c3b91bdab0013d21e12095">00377</a>     self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#644859abf0c3b91bdab0013d21e12095">uses_cpp</a> = <span class="keyword">False</span>
<a name="l00378"></a>00378 
<a name="l00379"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#e9044354be1c8bc6f5f25fc45ec6f5df">00379</a>     self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#e9044354be1c8bc6f5f25fc45ec6f5df">is_mac_bundle</a> = gyp.xcode_emulation.IsMacBundle(self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a>, spec)
<a name="l00380"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#82fdd7ef33787844f2f47ec02555786b">00380</a>     self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a> = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#05976cc272fa4d277ce291f093ca63be">msvs_settings</a> = <span class="keywordtype">None</span>
<a name="l00381"></a>00381     <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'mac'</span>:
<a name="l00382"></a>00382       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a> = gyp.xcode_emulation.XcodeSettings(spec)
<a name="l00383"></a>00383     <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'win'</span>:
<a name="l00384"></a>00384       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#05976cc272fa4d277ce291f093ca63be">msvs_settings</a> = gyp.msvs_emulation.MsvsSettings(spec,
<a name="l00385"></a>00385                                                            generator_flags)
<a name="l00386"></a>00386       arch = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#05976cc272fa4d277ce291f093ca63be">msvs_settings</a>.GetArch(config_name)
<a name="l00387"></a>00387       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb01ca7812bd411b26f759814e304a4c">ninja</a>.variable(<span class="stringliteral">'arch'</span>, self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#786bcf61d8c4d249c4d42c2db95e2d2d">win_env</a>[arch])
<a name="l00388"></a>00388       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb01ca7812bd411b26f759814e304a4c">ninja</a>.variable(<span class="stringliteral">'cc'</span>, <span class="stringliteral">'$cl_'</span> + arch)
<a name="l00389"></a>00389       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb01ca7812bd411b26f759814e304a4c">ninja</a>.variable(<span class="stringliteral">'cxx'</span>, <span class="stringliteral">'$cl_'</span> + arch)
<a name="l00390"></a>00390       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb01ca7812bd411b26f759814e304a4c">ninja</a>.variable(<span class="stringliteral">'cc_host'</span>, <span class="stringliteral">'$cl_'</span> + arch)
<a name="l00391"></a>00391       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb01ca7812bd411b26f759814e304a4c">ninja</a>.variable(<span class="stringliteral">'cxx_host'</span>, <span class="stringliteral">'$cl_'</span> + arch)
<a name="l00392"></a>00392       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb01ca7812bd411b26f759814e304a4c">ninja</a>.variable(<span class="stringliteral">'asm'</span>, <span class="stringliteral">'$ml_'</span> + arch)
<a name="l00393"></a>00393 
<a name="l00394"></a>00394     <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'mac'</span>:
<a name="l00395"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#7d813c7e211464aaa8638f46ca90c924">00395</a>       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#7d813c7e211464aaa8638f46ca90c924">archs</a> = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>.GetActiveArchs(config_name)
<a name="l00396"></a>00396       <span class="keywordflow">if</span> len(self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#7d813c7e211464aaa8638f46ca90c924">archs</a>) &gt; 1:
<a name="l00397"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#10945e7b0105fb01395cbbbb07156eb9">00397</a>         self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#10945e7b0105fb01395cbbbb07156eb9">arch_subninjas</a> = dict(
<a name="l00398"></a>00398             (arch, ninja_syntax.Writer(
<a name="l00399"></a>00399                 OpenOutput(os.path.join(self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#9968ef52a3e29a0d1fbcdb727c7dd318">toplevel_build</a>,
<a name="l00400"></a>00400                                         self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#a2a9c775962bc029e1f03a859c1b89a8">_SubninjaNameForArch</a>(arch)),
<a name="l00401"></a>00401                            <span class="stringliteral">'w'</span>)))
<a name="l00402"></a>00402             <span class="keywordflow">for</span> arch <span class="keywordflow">in</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#7d813c7e211464aaa8638f46ca90c924">archs</a>)
<a name="l00403"></a>00403 
<a name="l00404"></a>00404     <span class="comment"># Compute predepends for all rules.</span>
<a name="l00405"></a>00405     <span class="comment"># actions_depends is the dependencies this target depends on before running</span>
<a name="l00406"></a>00406     <span class="comment"># any of its action/rule/copy steps.</span>
<a name="l00407"></a>00407     <span class="comment"># compile_depends is the dependencies this target depends on before running</span>
<a name="l00408"></a>00408     <span class="comment"># any of its compile steps.</span>
<a name="l00409"></a>00409     actions_depends = []
<a name="l00410"></a>00410     compile_depends = []
<a name="l00411"></a>00411     <span class="comment"># TODO(evan): it is rather confusing which things are lists and which</span>
<a name="l00412"></a>00412     <span class="comment"># are strings.  Fix these.</span>
<a name="l00413"></a>00413     <span class="keywordflow">if</span> <span class="stringliteral">'dependencies'</span> <span class="keywordflow">in</span> spec:
<a name="l00414"></a>00414       <span class="keywordflow">for</span> dep <span class="keywordflow">in</span> spec[<span class="stringliteral">'dependencies'</span>]:
<a name="l00415"></a>00415         <span class="keywordflow">if</span> dep <span class="keywordflow">in</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#459cc34c149ee1fd281ba6c024ca2ce9">target_outputs</a>:
<a name="l00416"></a>00416           target = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#459cc34c149ee1fd281ba6c024ca2ce9">target_outputs</a>[dep]
<a name="l00417"></a>00417           actions_depends.append(target.PreActionInput(self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a>))
<a name="l00418"></a>00418           compile_depends.append(target.PreCompileInput())
<a name="l00419"></a>00419       actions_depends = filter(<span class="keywordtype">None</span>, actions_depends)
<a name="l00420"></a>00420       compile_depends = filter(<span class="keywordtype">None</span>, compile_depends)
<a name="l00421"></a>00421       actions_depends = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#3d0b3c5135128d164f44e7c6a0b7289a">WriteCollapsedDependencies</a>(<span class="stringliteral">'actions_depends'</span>,
<a name="l00422"></a>00422                                                         actions_depends)
<a name="l00423"></a>00423       compile_depends = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#3d0b3c5135128d164f44e7c6a0b7289a">WriteCollapsedDependencies</a>(<span class="stringliteral">'compile_depends'</span>,
<a name="l00424"></a>00424                                                         compile_depends)
<a name="l00425"></a>00425       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>.preaction_stamp = actions_depends
<a name="l00426"></a>00426       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>.precompile_stamp = compile_depends
<a name="l00427"></a>00427 
<a name="l00428"></a>00428     <span class="comment"># Write out actions, rules, and copies.  These must happen before we</span>
<a name="l00429"></a>00429     <span class="comment"># compile any sources, so compute a list of predependencies for sources</span>
<a name="l00430"></a>00430     <span class="comment"># while we do it.</span>
<a name="l00431"></a>00431     extra_sources = []
<a name="l00432"></a>00432     mac_bundle_depends = []
<a name="l00433"></a>00433     self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>.actions_stamp = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#1057153efa1d2b561773a016f4da82a6">WriteActionsRulesCopies</a>(
<a name="l00434"></a>00434         spec, extra_sources, actions_depends, mac_bundle_depends)
<a name="l00435"></a>00435 
<a name="l00436"></a>00436     <span class="comment"># If we have actions/rules/copies, we depend directly on those, but</span>
<a name="l00437"></a>00437     <span class="comment"># otherwise we depend on dependent target's actions/rules/copies etc.</span>
<a name="l00438"></a>00438     <span class="comment"># We never need to explicitly depend on previous target's link steps,</span>
<a name="l00439"></a>00439     <span class="comment"># because no compile ever depends on them.</span>
<a name="l00440"></a>00440     compile_depends_stamp = (self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>.actions_stamp <span class="keywordflow">or</span> compile_depends)
<a name="l00441"></a>00441 
<a name="l00442"></a>00442     <span class="comment"># Write out the compilation steps, if any.</span>
<a name="l00443"></a>00443     link_deps = []
<a name="l00444"></a>00444     sources = extra_sources + spec.get(<span class="stringliteral">'sources'</span>, [])
<a name="l00445"></a>00445     <span class="keywordflow">if</span> sources:
<a name="l00446"></a>00446       <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'mac'</span> <span class="keywordflow">and</span> len(self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#7d813c7e211464aaa8638f46ca90c924">archs</a>) &gt; 1:
<a name="l00447"></a>00447         <span class="comment"># Write subninja file containing compile and link commands scoped to</span>
<a name="l00448"></a>00448         <span class="comment"># a single arch if a fat binary is being built.</span>
<a name="l00449"></a>00449         <span class="keywordflow">for</span> arch <span class="keywordflow">in</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#7d813c7e211464aaa8638f46ca90c924">archs</a>:
<a name="l00450"></a>00450           self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb01ca7812bd411b26f759814e304a4c">ninja</a>.subninja(self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#a2a9c775962bc029e1f03a859c1b89a8">_SubninjaNameForArch</a>(arch))
<a name="l00451"></a>00451 
<a name="l00452"></a>00452       pch = <span class="keywordtype">None</span>
<a name="l00453"></a>00453       <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'win'</span>:
<a name="l00454"></a>00454         gyp.msvs_emulation.VerifyMissingSources(
<a name="l00455"></a>00455             sources, self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#d453fd01340f10261a7525e604aba57d">abs_build_dir</a>, generator_flags, self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#3770e8a9cc0f198dbc8344cbf6347c22">GypPathToNinja</a>)
<a name="l00456"></a>00456         pch = gyp.msvs_emulation.PrecompiledHeader(
<a name="l00457"></a>00457             self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#05976cc272fa4d277ce291f093ca63be">msvs_settings</a>, config_name, self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#3770e8a9cc0f198dbc8344cbf6347c22">GypPathToNinja</a>,
<a name="l00458"></a>00458             self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#1a32eebd8c4ae6c6c2eb0db303f1952b">GypPathToUniqueOutput</a>, self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#22730c3bc6462078334e2d5bb4e30f3b">obj_ext</a>)
<a name="l00459"></a>00459       <span class="keywordflow">else</span>:
<a name="l00460"></a>00460         pch = gyp.xcode_emulation.MacPrefixHeader(
<a name="l00461"></a>00461             self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>, self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#3770e8a9cc0f198dbc8344cbf6347c22">GypPathToNinja</a>,
<a name="l00462"></a>00462             <span class="keyword">lambda</span> path, lang: self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#1a32eebd8c4ae6c6c2eb0db303f1952b">GypPathToUniqueOutput</a>(path + <span class="stringliteral">'-'</span> + lang))
<a name="l00463"></a>00463       link_deps = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#7c3bf79a4bd2f19944fc222c6bcfffc0">WriteSources</a>(
<a name="l00464"></a>00464           self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb01ca7812bd411b26f759814e304a4c">ninja</a>, config_name, config, sources, compile_depends_stamp, pch,
<a name="l00465"></a>00465           spec)
<a name="l00466"></a>00466       <span class="comment"># Some actions/rules output 'sources' that are already object files.</span>
<a name="l00467"></a>00467       obj_outputs = [f <span class="keywordflow">for</span> f <span class="keywordflow">in</span> sources <span class="keywordflow">if</span> f.endswith(self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#22730c3bc6462078334e2d5bb4e30f3b">obj_ext</a>)]
<a name="l00468"></a>00468       <span class="keywordflow">if</span> obj_outputs:
<a name="l00469"></a>00469         <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> != <span class="stringliteral">'mac'</span> <span class="keywordflow">or</span> len(self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#7d813c7e211464aaa8638f46ca90c924">archs</a>) == 1:
<a name="l00470"></a>00470           link_deps += [self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#3770e8a9cc0f198dbc8344cbf6347c22">GypPathToNinja</a>(o) <span class="keywordflow">for</span> o <span class="keywordflow">in</span> obj_outputs]
<a name="l00471"></a>00471         <span class="keywordflow">else</span>:
<a name="l00472"></a>00472           <span class="keywordflow">print</span> <span class="stringliteral">"Warning: Actions/rules writing object files don't work with "</span> \
<a name="l00473"></a>00473                 <span class="stringliteral">"multiarch targets, dropping. (target %s)"</span> % spec[<span class="stringliteral">'target_name'</span>]
<a name="l00474"></a>00474     <span class="keywordflow">elif</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'mac'</span> <span class="keywordflow">and</span> len(self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#7d813c7e211464aaa8638f46ca90c924">archs</a>) &gt; 1:
<a name="l00475"></a>00475       link_deps = collections.defaultdict(list)
<a name="l00476"></a>00476 
<a name="l00477"></a>00477 
<a name="l00478"></a>00478     <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'win'</span> <span class="keywordflow">and</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>.type == <span class="stringliteral">'static_library'</span>:
<a name="l00479"></a>00479       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>.component_objs = link_deps
<a name="l00480"></a>00480 
<a name="l00481"></a>00481     <span class="comment"># Write out a link step, if needed.</span>
<a name="l00482"></a>00482     output = <span class="keywordtype">None</span>
<a name="l00483"></a>00483     is_empty_bundle = <span class="keywordflow">not</span> link_deps <span class="keywordflow">and</span> <span class="keywordflow">not</span> mac_bundle_depends
<a name="l00484"></a>00484     <span class="keywordflow">if</span> link_deps <span class="keywordflow">or</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>.actions_stamp <span class="keywordflow">or</span> actions_depends:
<a name="l00485"></a>00485       output = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#203d0a7515c00ce74d55f93e632eedfe">WriteTarget</a>(spec, config_name, config, link_deps,
<a name="l00486"></a>00486                                 self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>.actions_stamp <span class="keywordflow">or</span> actions_depends)
<a name="l00487"></a>00487       <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#e9044354be1c8bc6f5f25fc45ec6f5df">is_mac_bundle</a>:
<a name="l00488"></a>00488         mac_bundle_depends.append(output)
<a name="l00489"></a>00489 
<a name="l00490"></a>00490     <span class="comment"># Bundle all of the above together, if needed.</span>
<a name="l00491"></a>00491     <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#e9044354be1c8bc6f5f25fc45ec6f5df">is_mac_bundle</a>:
<a name="l00492"></a>00492       output = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#8db967f4e290bea92df40a4fc361bbf8">WriteMacBundle</a>(spec, mac_bundle_depends, is_empty_bundle)
<a name="l00493"></a>00493 
<a name="l00494"></a>00494     <span class="keywordflow">if</span> <span class="keywordflow">not</span> output:
<a name="l00495"></a>00495       <span class="keywordflow">return</span> <span class="keywordtype">None</span>
<a name="l00496"></a>00496 
<a name="l00497"></a>00497     <span class="keyword">assert</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>.FinalOutput(), output
<a name="l00498"></a>00498     <span class="keywordflow">return</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>
<a name="l00499"></a>00499 
<a name="l00500"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#46d771aa4501025371ea0da0139368de">00500</a>   <span class="keyword">def </span><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#46d771aa4501025371ea0da0139368de">_WinIdlRule</a>(self, source, prebuild, outputs):
<a name="l00501"></a>00501     <span class="stringliteral">"""Handle the implicit VS .idl rule for one source file. Fills |outputs|</span>
<a name="l00502"></a>00502 <span class="stringliteral">    with files that are generated."""</span>
<a name="l00503"></a>00503     outdir, output, vars, flags = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#05976cc272fa4d277ce291f093ca63be">msvs_settings</a>.GetIdlBuildData(
<a name="l00504"></a>00504         source, self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#72c8aa1d973690508a559237475202c6">config_name</a>)
<a name="l00505"></a>00505     outdir = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#3770e8a9cc0f198dbc8344cbf6347c22">GypPathToNinja</a>(outdir)
<a name="l00506"></a>00506     <span class="keyword">def </span>fix_path(path, rel=None):
<a name="l00507"></a>00507       path = os.path.join(outdir, path)
<a name="l00508"></a>00508       dirname, basename = os.path.split(source)
<a name="l00509"></a>00509       root, ext = os.path.splitext(basename)
<a name="l00510"></a>00510       path = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#7381adae5ca6d27078da99f41f353a8d">ExpandRuleVariables</a>(
<a name="l00511"></a>00511           path, root, dirname, source, ext, basename)
<a name="l00512"></a>00512       <span class="keywordflow">if</span> rel:
<a name="l00513"></a>00513         path = os.path.relpath(path, rel)
<a name="l00514"></a>00514       <span class="keywordflow">return</span> path
<a name="l00515"></a>00515     vars = [(name, fix_path(value, outdir)) <span class="keywordflow">for</span> name, value <span class="keywordflow">in</span> vars]
<a name="l00516"></a>00516     output = [fix_path(p) <span class="keywordflow">for</span> p <span class="keywordflow">in</span> output]
<a name="l00517"></a>00517     vars.append((<span class="stringliteral">'outdir'</span>, outdir))
<a name="l00518"></a>00518     vars.append((<span class="stringliteral">'idlflags'</span>, flags))
<a name="l00519"></a>00519     input = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#3770e8a9cc0f198dbc8344cbf6347c22">GypPathToNinja</a>(source)
<a name="l00520"></a>00520     self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb01ca7812bd411b26f759814e304a4c">ninja</a>.build(output, <span class="stringliteral">'idl'</span>, input,
<a name="l00521"></a>00521         variables=vars, order_only=prebuild)
<a name="l00522"></a>00522     outputs.extend(output)
<a name="l00523"></a>00523 
<a name="l00524"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#7b222b85905ced4a2de473e0217ff14a">00524</a>   <span class="keyword">def </span><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#7b222b85905ced4a2de473e0217ff14a">WriteWinIdlFiles</a>(self, spec, prebuild):
<a name="l00525"></a>00525     <span class="stringliteral">"""Writes rules to match MSVS's implicit idl handling."""</span>
<a name="l00526"></a>00526     <span class="keyword">assert</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'win'</span>
<a name="l00527"></a>00527     <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#05976cc272fa4d277ce291f093ca63be">msvs_settings</a>.HasExplicitIdlRulesOrActions(spec):
<a name="l00528"></a>00528       <span class="keywordflow">return</span> []
<a name="l00529"></a>00529     outputs = []
<a name="l00530"></a>00530     <span class="keywordflow">for</span> source <span class="keywordflow">in</span> filter(<span class="keyword">lambda</span> x: x.endswith(<span class="stringliteral">'.idl'</span>), spec[<span class="stringliteral">'sources'</span>]):
<a name="l00531"></a>00531       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#46d771aa4501025371ea0da0139368de">_WinIdlRule</a>(source, prebuild, outputs)
<a name="l00532"></a>00532     <span class="keywordflow">return</span> outputs
<a name="l00533"></a>00533 
<a name="l00534"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#1057153efa1d2b561773a016f4da82a6">00534</a>   <span class="keyword">def </span><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#1057153efa1d2b561773a016f4da82a6">WriteActionsRulesCopies</a>(self, spec, extra_sources, prebuild,
<a name="l00535"></a>00535                               mac_bundle_depends):
<a name="l00536"></a>00536     <span class="stringliteral">"""Write out the Actions, Rules, and Copies steps.  Return a path</span>
<a name="l00537"></a>00537 <span class="stringliteral">    representing the outputs of these steps."""</span>
<a name="l00538"></a>00538     outputs = []
<a name="l00539"></a>00539     <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#e9044354be1c8bc6f5f25fc45ec6f5df">is_mac_bundle</a>:
<a name="l00540"></a>00540       mac_bundle_resources = spec.get(<span class="stringliteral">'mac_bundle_resources'</span>, [])[:]
<a name="l00541"></a>00541     <span class="keywordflow">else</span>:
<a name="l00542"></a>00542       mac_bundle_resources = []
<a name="l00543"></a>00543     extra_mac_bundle_resources = []
<a name="l00544"></a>00544 
<a name="l00545"></a>00545     <span class="keywordflow">if</span> <span class="stringliteral">'actions'</span> <span class="keywordflow">in</span> spec:
<a name="l00546"></a>00546       outputs += self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#fc4b663ae8e353dfc043e4be9150bdc2">WriteActions</a>(spec[<span class="stringliteral">'actions'</span>], extra_sources, prebuild,
<a name="l00547"></a>00547                                    extra_mac_bundle_resources)
<a name="l00548"></a>00548     <span class="keywordflow">if</span> <span class="stringliteral">'rules'</span> <span class="keywordflow">in</span> spec:
<a name="l00549"></a>00549       outputs += self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#64a7ef6362ff4c4b9191e0761d97b247">WriteRules</a>(spec[<span class="stringliteral">'rules'</span>], extra_sources, prebuild,
<a name="l00550"></a>00550                                  mac_bundle_resources,
<a name="l00551"></a>00551                                  extra_mac_bundle_resources)
<a name="l00552"></a>00552     <span class="keywordflow">if</span> <span class="stringliteral">'copies'</span> <span class="keywordflow">in</span> spec:
<a name="l00553"></a>00553       outputs += self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb7218d4227c7eb14ab546b33c2e7cb8">WriteCopies</a>(spec[<span class="stringliteral">'copies'</span>], prebuild, mac_bundle_depends)
<a name="l00554"></a>00554 
<a name="l00555"></a>00555     <span class="keywordflow">if</span> <span class="stringliteral">'sources'</span> <span class="keywordflow">in</span> spec <span class="keywordflow">and</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'win'</span>:
<a name="l00556"></a>00556       outputs += self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#7b222b85905ced4a2de473e0217ff14a">WriteWinIdlFiles</a>(spec, prebuild)
<a name="l00557"></a>00557 
<a name="l00558"></a>00558     stamp = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#3d0b3c5135128d164f44e7c6a0b7289a">WriteCollapsedDependencies</a>(<span class="stringliteral">'actions_rules_copies'</span>, outputs)
<a name="l00559"></a>00559 
<a name="l00560"></a>00560     <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#e9044354be1c8bc6f5f25fc45ec6f5df">is_mac_bundle</a>:
<a name="l00561"></a>00561       xcassets = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#9b758bfad28d2aa805d521b0adb55533">WriteMacBundleResources</a>(
<a name="l00562"></a>00562           extra_mac_bundle_resources + mac_bundle_resources, mac_bundle_depends)
<a name="l00563"></a>00563       partial_info_plist = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#3f33073be91af48208c7d0f4be935b8f">WriteMacXCassets</a>(xcassets, mac_bundle_depends)
<a name="l00564"></a>00564       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#efdf9de404554421cf997b6b1d0c44fc">WriteMacInfoPlist</a>(partial_info_plist, mac_bundle_depends)
<a name="l00565"></a>00565 
<a name="l00566"></a>00566     <span class="keywordflow">return</span> stamp
<a name="l00567"></a>00567 
<a name="l00568"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#524b0cd39426379e59611ac899cd9955">00568</a>   <span class="keyword">def </span><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#524b0cd39426379e59611ac899cd9955">GenerateDescription</a>(self, verb, message, fallback):
<a name="l00569"></a>00569     <span class="stringliteral">"""Generate and return a description of a build step.</span>
<a name="l00570"></a>00570 <span class="stringliteral"></span>
<a name="l00571"></a>00571 <span class="stringliteral">    |verb| is the short summary, e.g. ACTION or RULE.</span>
<a name="l00572"></a>00572 <span class="stringliteral">    |message| is a hand-written description, or None if not available.</span>
<a name="l00573"></a>00573 <span class="stringliteral">    |fallback| is the gyp-level name of the step, usable as a fallback.</span>
<a name="l00574"></a>00574 <span class="stringliteral">    """</span>
<a name="l00575"></a>00575     <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">toolset</a> != <span class="stringliteral">'target'</span>:
<a name="l00576"></a>00576       verb += <span class="stringliteral">'(%s)'</span> % self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">toolset</a>
<a name="l00577"></a>00577     <span class="keywordflow">if</span> message:
<a name="l00578"></a>00578       <span class="keywordflow">return</span> <span class="stringliteral">'%s %s'</span> % (verb, self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#eca47f2b3a42089c33330749acfd861a">ExpandSpecial</a>(message))
<a name="l00579"></a>00579     <span class="keywordflow">else</span>:
<a name="l00580"></a>00580       <span class="keywordflow">return</span> <span class="stringliteral">'%s %s: %s'</span> % (verb, self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#b74e6bf80237ddc4109968cedc58c151">name</a>, fallback)
<a name="l00581"></a>00581 
<a name="l00582"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#fc4b663ae8e353dfc043e4be9150bdc2">00582</a>   <span class="keyword">def </span><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#fc4b663ae8e353dfc043e4be9150bdc2">WriteActions</a>(self, actions, extra_sources, prebuild,
<a name="l00583"></a>00583                    extra_mac_bundle_resources):
<a name="l00584"></a>00584     <span class="comment"># Actions cd into the base directory.</span>
<a name="l00585"></a>00585     env = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#e915b7f19b39ed5ef63ee70b7b5eb298">GetToolchainEnv</a>()
<a name="l00586"></a>00586     all_outputs = []
<a name="l00587"></a>00587     <span class="keywordflow">for</span> action <span class="keywordflow">in</span> actions:
<a name="l00588"></a>00588       <span class="comment"># First write out a rule for the action.</span>
<a name="l00589"></a>00589       name = <span class="stringliteral">'%s_%s'</span> % (action[<span class="stringliteral">'action_name'</span>], self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#e3a650ea7c881164767e0369cb34b02e">hash_for_rules</a>)
<a name="l00590"></a>00590       description = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#524b0cd39426379e59611ac899cd9955">GenerateDescription</a>(<span class="stringliteral">'ACTION'</span>,
<a name="l00591"></a>00591                                              action.get(<span class="stringliteral">'message'</span>, <span class="keywordtype">None</span>),
<a name="l00592"></a>00592                                              name)
<a name="l00593"></a>00593       is_cygwin = (self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#05976cc272fa4d277ce291f093ca63be">msvs_settings</a>.IsRuleRunUnderCygwin(action)
<a name="l00594"></a>00594                    <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'win'</span> <span class="keywordflow">else</span> <span class="keyword">False</span>)
<a name="l00595"></a>00595       args = action[<span class="stringliteral">'action'</span>]
<a name="l00596"></a>00596       depfile = action.get(<span class="stringliteral">'depfile'</span>, <span class="keywordtype">None</span>)
<a name="l00597"></a>00597       <span class="keywordflow">if</span> depfile:
<a name="l00598"></a>00598         depfile = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#eca47f2b3a42089c33330749acfd861a">ExpandSpecial</a>(depfile, self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#f58e3265fc7bfc95156adcf21ffc7220">base_to_build</a>)
<a name="l00599"></a>00599       pool = <span class="stringliteral">'console'</span> <span class="keywordflow">if</span> int(action.get(<span class="stringliteral">'ninja_use_console'</span>, 0)) <span class="keywordflow">else</span> <span class="keywordtype">None</span>
<a name="l00600"></a>00600       rule_name, _ = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#77fe4ecde866f09e6655f71a91596b48">WriteNewNinjaRule</a>(name, args, description,
<a name="l00601"></a>00601                                             is_cygwin, env, pool,
<a name="l00602"></a>00602                                             depfile=depfile)
<a name="l00603"></a>00603 
<a name="l00604"></a>00604       inputs = [self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#3770e8a9cc0f198dbc8344cbf6347c22">GypPathToNinja</a>(i, env) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> action[<span class="stringliteral">'inputs'</span>]]
<a name="l00605"></a>00605       <span class="keywordflow">if</span> int(action.get(<span class="stringliteral">'process_outputs_as_sources'</span>, <span class="keyword">False</span>)):
<a name="l00606"></a>00606         extra_sources += action[<span class="stringliteral">'outputs'</span>]
<a name="l00607"></a>00607       <span class="keywordflow">if</span> int(action.get(<span class="stringliteral">'process_outputs_as_mac_bundle_resources'</span>, <span class="keyword">False</span>)):
<a name="l00608"></a>00608         extra_mac_bundle_resources += action[<span class="stringliteral">'outputs'</span>]
<a name="l00609"></a>00609       outputs = [self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#3770e8a9cc0f198dbc8344cbf6347c22">GypPathToNinja</a>(o, env) <span class="keywordflow">for</span> o <span class="keywordflow">in</span> action[<span class="stringliteral">'outputs'</span>]]
<a name="l00610"></a>00610 
<a name="l00611"></a>00611       <span class="comment"># Then write out an edge using the rule.</span>
<a name="l00612"></a>00612       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb01ca7812bd411b26f759814e304a4c">ninja</a>.build(outputs, rule_name, inputs,
<a name="l00613"></a>00613                        order_only=prebuild)
<a name="l00614"></a>00614       all_outputs += outputs
<a name="l00615"></a>00615 
<a name="l00616"></a>00616       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb01ca7812bd411b26f759814e304a4c">ninja</a>.newline()
<a name="l00617"></a>00617 
<a name="l00618"></a>00618     <span class="keywordflow">return</span> all_outputs
<a name="l00619"></a>00619 
<a name="l00620"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#64a7ef6362ff4c4b9191e0761d97b247">00620</a>   <span class="keyword">def </span><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#64a7ef6362ff4c4b9191e0761d97b247">WriteRules</a>(self, rules, extra_sources, prebuild,
<a name="l00621"></a>00621                  mac_bundle_resources, extra_mac_bundle_resources):
<a name="l00622"></a>00622     env = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#e915b7f19b39ed5ef63ee70b7b5eb298">GetToolchainEnv</a>()
<a name="l00623"></a>00623     all_outputs = []
<a name="l00624"></a>00624     <span class="keywordflow">for</span> rule <span class="keywordflow">in</span> rules:
<a name="l00625"></a>00625       <span class="comment"># Skip a rule with no action and no inputs.</span>
<a name="l00626"></a>00626       <span class="keywordflow">if</span> <span class="stringliteral">'action'</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> rule <span class="keywordflow">and</span> <span class="keywordflow">not</span> rule.get(<span class="stringliteral">'rule_sources'</span>, []):
<a name="l00627"></a>00627         <span class="keywordflow">continue</span>
<a name="l00628"></a>00628 
<a name="l00629"></a>00629       <span class="comment"># First write out a rule for the rule action.</span>
<a name="l00630"></a>00630       name = <span class="stringliteral">'%s_%s'</span> % (rule[<span class="stringliteral">'rule_name'</span>], self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#e3a650ea7c881164767e0369cb34b02e">hash_for_rules</a>)
<a name="l00631"></a>00631 
<a name="l00632"></a>00632       args = rule[<span class="stringliteral">'action'</span>]
<a name="l00633"></a>00633       description = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#524b0cd39426379e59611ac899cd9955">GenerateDescription</a>(
<a name="l00634"></a>00634           <span class="stringliteral">'RULE'</span>,
<a name="l00635"></a>00635           rule.get(<span class="stringliteral">'message'</span>, <span class="keywordtype">None</span>),
<a name="l00636"></a>00636           (<span class="stringliteral">'%s '</span> + generator_default_variables[<span class="stringliteral">'RULE_INPUT_PATH'</span>]) % name)
<a name="l00637"></a>00637       is_cygwin = (self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#05976cc272fa4d277ce291f093ca63be">msvs_settings</a>.IsRuleRunUnderCygwin(rule)
<a name="l00638"></a>00638                    <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'win'</span> <span class="keywordflow">else</span> <span class="keyword">False</span>)
<a name="l00639"></a>00639       pool = <span class="stringliteral">'console'</span> <span class="keywordflow">if</span> int(rule.get(<span class="stringliteral">'ninja_use_console'</span>, 0)) <span class="keywordflow">else</span> <span class="keywordtype">None</span>
<a name="l00640"></a>00640       rule_name, args = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#77fe4ecde866f09e6655f71a91596b48">WriteNewNinjaRule</a>(
<a name="l00641"></a>00641           name, args, description, is_cygwin, env, pool)
<a name="l00642"></a>00642 
<a name="l00643"></a>00643       <span class="comment"># TODO: if the command references the outputs directly, we should</span>
<a name="l00644"></a>00644       <span class="comment"># simplify it to just use $out.</span>
<a name="l00645"></a>00645 
<a name="l00646"></a>00646       <span class="comment"># Rules can potentially make use of some special variables which</span>
<a name="l00647"></a>00647       <span class="comment"># must vary per source file.</span>
<a name="l00648"></a>00648       <span class="comment"># Compute the list of variables we'll need to provide.</span>
<a name="l00649"></a>00649       special_locals = (<span class="stringliteral">'source'</span>, <span class="stringliteral">'root'</span>, <span class="stringliteral">'dirname'</span>, <span class="stringliteral">'ext'</span>, <span class="stringliteral">'name'</span>)
<a name="l00650"></a>00650       needed_variables = set([<span class="stringliteral">'source'</span>])
<a name="l00651"></a>00651       <span class="keywordflow">for</span> argument <span class="keywordflow">in</span> args:
<a name="l00652"></a>00652         <span class="keywordflow">for</span> var <span class="keywordflow">in</span> special_locals:
<a name="l00653"></a>00653           <span class="keywordflow">if</span> <span class="stringliteral">'${%s}'</span> % var <span class="keywordflow">in</span> argument:
<a name="l00654"></a>00654             needed_variables.add(var)
<a name="l00655"></a>00655 
<a name="l00656"></a>00656       <span class="keyword">def </span>cygwin_munge(path):
<a name="l00657"></a>00657         <span class="comment"># pylint: disable=cell-var-from-loop</span>
<a name="l00658"></a>00658         <span class="keywordflow">if</span> is_cygwin:
<a name="l00659"></a>00659           <span class="keywordflow">return</span> path.replace(<span class="stringliteral">'\\'</span>, <span class="stringliteral">'/'</span>)
<a name="l00660"></a>00660         <span class="keywordflow">return</span> path
<a name="l00661"></a>00661 
<a name="l00662"></a>00662       inputs = [self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#3770e8a9cc0f198dbc8344cbf6347c22">GypPathToNinja</a>(i, env) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> rule.get(<span class="stringliteral">'inputs'</span>, [])]
<a name="l00663"></a>00663 
<a name="l00664"></a>00664       <span class="comment"># If there are n source files matching the rule, and m additional rule</span>
<a name="l00665"></a>00665       <span class="comment"># inputs, then adding 'inputs' to each build edge written below will</span>
<a name="l00666"></a>00666       <span class="comment"># write m * n inputs. Collapsing reduces this to m + n.</span>
<a name="l00667"></a>00667       sources = rule.get(<span class="stringliteral">'rule_sources'</span>, [])
<a name="l00668"></a>00668       num_inputs = len(inputs)
<a name="l00669"></a>00669       <span class="keywordflow">if</span> prebuild:
<a name="l00670"></a>00670         num_inputs += 1
<a name="l00671"></a>00671       <span class="keywordflow">if</span> num_inputs &gt; 2 <span class="keywordflow">and</span> len(sources) &gt; 2:
<a name="l00672"></a>00672         inputs = [self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#3d0b3c5135128d164f44e7c6a0b7289a">WriteCollapsedDependencies</a>(
<a name="l00673"></a>00673           rule[<span class="stringliteral">'rule_name'</span>], inputs, order_only=prebuild)]
<a name="l00674"></a>00674         prebuild = []
<a name="l00675"></a>00675 
<a name="l00676"></a>00676       <span class="comment"># For each source file, write an edge that generates all the outputs.</span>
<a name="l00677"></a>00677       <span class="keywordflow">for</span> source <span class="keywordflow">in</span> sources:
<a name="l00678"></a>00678         source = os.path.normpath(source)
<a name="l00679"></a>00679         dirname, basename = os.path.split(source)
<a name="l00680"></a>00680         root, ext = os.path.splitext(basename)
<a name="l00681"></a>00681 
<a name="l00682"></a>00682         <span class="comment"># Gather the list of inputs and outputs, expanding $vars if possible.</span>
<a name="l00683"></a>00683         outputs = [self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#7381adae5ca6d27078da99f41f353a8d">ExpandRuleVariables</a>(o, root, dirname,
<a name="l00684"></a>00684                                             source, ext, basename)
<a name="l00685"></a>00685                    <span class="keywordflow">for</span> o <span class="keywordflow">in</span> rule[<span class="stringliteral">'outputs'</span>]]
<a name="l00686"></a>00686 
<a name="l00687"></a>00687         <span class="keywordflow">if</span> int(rule.get(<span class="stringliteral">'process_outputs_as_sources'</span>, <span class="keyword">False</span>)):
<a name="l00688"></a>00688           extra_sources += outputs
<a name="l00689"></a>00689 
<a name="l00690"></a>00690         was_mac_bundle_resource = source <span class="keywordflow">in</span> mac_bundle_resources
<a name="l00691"></a>00691         <span class="keywordflow">if</span> was_mac_bundle_resource <span class="keywordflow">or</span> \
<a name="l00692"></a>00692             int(rule.get(<span class="stringliteral">'process_outputs_as_mac_bundle_resources'</span>, <span class="keyword">False</span>)):
<a name="l00693"></a>00693           extra_mac_bundle_resources += outputs
<a name="l00694"></a>00694           <span class="comment"># Note: This is n_resources * n_outputs_in_rule.  Put to-be-removed</span>
<a name="l00695"></a>00695           <span class="comment"># items in a set and remove them all in a single pass if this becomes</span>
<a name="l00696"></a>00696           <span class="comment"># a performance issue.</span>
<a name="l00697"></a>00697           <span class="keywordflow">if</span> was_mac_bundle_resource:
<a name="l00698"></a>00698             mac_bundle_resources.remove(source)
<a name="l00699"></a>00699 
<a name="l00700"></a>00700         extra_bindings = []
<a name="l00701"></a>00701         <span class="keywordflow">for</span> var <span class="keywordflow">in</span> needed_variables:
<a name="l00702"></a>00702           <span class="keywordflow">if</span> var == <span class="stringliteral">'root'</span>:
<a name="l00703"></a>00703             extra_bindings.append((<span class="stringliteral">'root'</span>, cygwin_munge(root)))
<a name="l00704"></a>00704           <span class="keywordflow">elif</span> var == <span class="stringliteral">'dirname'</span>:
<a name="l00705"></a>00705             <span class="comment"># '$dirname' is a parameter to the rule action, which means</span>
<a name="l00706"></a>00706             <span class="comment"># it shouldn't be converted to a Ninja path.  But we don't</span>
<a name="l00707"></a>00707             <span class="comment"># want $!PRODUCT_DIR in there either.</span>
<a name="l00708"></a>00708             dirname_expanded = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#eca47f2b3a42089c33330749acfd861a">ExpandSpecial</a>(dirname, self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#f58e3265fc7bfc95156adcf21ffc7220">base_to_build</a>)
<a name="l00709"></a>00709             extra_bindings.append((<span class="stringliteral">'dirname'</span>, cygwin_munge(dirname_expanded)))
<a name="l00710"></a>00710           <span class="keywordflow">elif</span> var == <span class="stringliteral">'source'</span>:
<a name="l00711"></a>00711             <span class="comment"># '$source' is a parameter to the rule action, which means</span>
<a name="l00712"></a>00712             <span class="comment"># it shouldn't be converted to a Ninja path.  But we don't</span>
<a name="l00713"></a>00713             <span class="comment"># want $!PRODUCT_DIR in there either.</span>
<a name="l00714"></a>00714             source_expanded = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#eca47f2b3a42089c33330749acfd861a">ExpandSpecial</a>(source, self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#f58e3265fc7bfc95156adcf21ffc7220">base_to_build</a>)
<a name="l00715"></a>00715             extra_bindings.append((<span class="stringliteral">'source'</span>, cygwin_munge(source_expanded)))
<a name="l00716"></a>00716           <span class="keywordflow">elif</span> var == <span class="stringliteral">'ext'</span>:
<a name="l00717"></a>00717             extra_bindings.append((<span class="stringliteral">'ext'</span>, ext))
<a name="l00718"></a>00718           <span class="keywordflow">elif</span> var == <span class="stringliteral">'name'</span>:
<a name="l00719"></a>00719             extra_bindings.append((<span class="stringliteral">'name'</span>, cygwin_munge(basename)))
<a name="l00720"></a>00720           <span class="keywordflow">else</span>:
<a name="l00721"></a>00721             <span class="keyword">assert</span> var == <span class="keywordtype">None</span>, repr(var)
<a name="l00722"></a>00722 
<a name="l00723"></a>00723         outputs = [self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#3770e8a9cc0f198dbc8344cbf6347c22">GypPathToNinja</a>(o, env) <span class="keywordflow">for</span> o <span class="keywordflow">in</span> outputs]
<a name="l00724"></a>00724         <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'win'</span>:
<a name="l00725"></a>00725           <span class="comment"># WriteNewNinjaRule uses unique_name for creating an rsp file on win.</span>
<a name="l00726"></a>00726           extra_bindings.append((<span class="stringliteral">'unique_name'</span>,
<a name="l00727"></a>00727               hashlib.md5(outputs[0]).hexdigest()))
<a name="l00728"></a>00728         self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb01ca7812bd411b26f759814e304a4c">ninja</a>.build(outputs, rule_name, self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#3770e8a9cc0f198dbc8344cbf6347c22">GypPathToNinja</a>(source),
<a name="l00729"></a>00729                          implicit=inputs,
<a name="l00730"></a>00730                          order_only=prebuild,
<a name="l00731"></a>00731                          variables=extra_bindings)
<a name="l00732"></a>00732 
<a name="l00733"></a>00733         all_outputs.extend(outputs)
<a name="l00734"></a>00734 
<a name="l00735"></a>00735     <span class="keywordflow">return</span> all_outputs
<a name="l00736"></a>00736 
<a name="l00737"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb7218d4227c7eb14ab546b33c2e7cb8">00737</a>   <span class="keyword">def </span><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb7218d4227c7eb14ab546b33c2e7cb8">WriteCopies</a>(self, copies, prebuild, mac_bundle_depends):
<a name="l00738"></a>00738     outputs = []
<a name="l00739"></a>00739     env = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#e915b7f19b39ed5ef63ee70b7b5eb298">GetToolchainEnv</a>()
<a name="l00740"></a>00740     <span class="keywordflow">for</span> copy <span class="keywordflow">in</span> copies:
<a name="l00741"></a>00741       <span class="keywordflow">for</span> path <span class="keywordflow">in</span> copy[<span class="stringliteral">'files'</span>]:
<a name="l00742"></a>00742         <span class="comment"># Normalize the path so trailing slashes don't confuse us.</span>
<a name="l00743"></a>00743         path = os.path.normpath(path)
<a name="l00744"></a>00744         basename = os.path.split(path)[1]
<a name="l00745"></a>00745         src = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#3770e8a9cc0f198dbc8344cbf6347c22">GypPathToNinja</a>(path, env)
<a name="l00746"></a>00746         dst = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#3770e8a9cc0f198dbc8344cbf6347c22">GypPathToNinja</a>(os.path.join(copy[<span class="stringliteral">'destination'</span>], basename),
<a name="l00747"></a>00747                                   env)
<a name="l00748"></a>00748         outputs += self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb01ca7812bd411b26f759814e304a4c">ninja</a>.build(dst, <span class="stringliteral">'copy'</span>, src, order_only=prebuild)
<a name="l00749"></a>00749         <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#e9044354be1c8bc6f5f25fc45ec6f5df">is_mac_bundle</a>:
<a name="l00750"></a>00750           <span class="comment"># gyp has mac_bundle_resources to copy things into a bundle's</span>
<a name="l00751"></a>00751           <span class="comment"># Resources folder, but there's no built-in way to copy files to other</span>
<a name="l00752"></a>00752           <span class="comment"># places in the bundle. Hence, some targets use copies for this. Check</span>
<a name="l00753"></a>00753           <span class="comment"># if this file is copied into the current bundle, and if so add it to</span>
<a name="l00754"></a>00754           <span class="comment"># the bundle depends so that dependent targets get rebuilt if the copy</span>
<a name="l00755"></a>00755           <span class="comment"># input changes.</span>
<a name="l00756"></a>00756           <span class="keywordflow">if</span> dst.startswith(self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>.GetBundleContentsFolderPath()):
<a name="l00757"></a>00757             mac_bundle_depends.append(dst)
<a name="l00758"></a>00758 
<a name="l00759"></a>00759     <span class="keywordflow">return</span> outputs
<a name="l00760"></a>00760 
<a name="l00761"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#9b758bfad28d2aa805d521b0adb55533">00761</a>   <span class="keyword">def </span><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#9b758bfad28d2aa805d521b0adb55533">WriteMacBundleResources</a>(self, resources, bundle_depends):
<a name="l00762"></a>00762     <span class="stringliteral">"""Writes ninja edges for 'mac_bundle_resources'."""</span>
<a name="l00763"></a>00763     xcassets = []
<a name="l00764"></a>00764     <span class="keywordflow">for</span> output, res <span class="keywordflow">in</span> gyp.xcode_emulation.GetMacBundleResources(
<a name="l00765"></a>00765         generator_default_variables[<span class="stringliteral">'PRODUCT_DIR'</span>],
<a name="l00766"></a>00766         self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>, map(self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#3770e8a9cc0f198dbc8344cbf6347c22">GypPathToNinja</a>, resources)):
<a name="l00767"></a>00767       output = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#eca47f2b3a42089c33330749acfd861a">ExpandSpecial</a>(output)
<a name="l00768"></a>00768       <span class="keywordflow">if</span> os.path.splitext(output)[-1] != <span class="stringliteral">'.xcassets'</span>:
<a name="l00769"></a>00769         isBinary = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>.IsBinaryOutputFormat(self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#72c8aa1d973690508a559237475202c6">config_name</a>)
<a name="l00770"></a>00770         self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb01ca7812bd411b26f759814e304a4c">ninja</a>.build(output, <span class="stringliteral">'mac_tool'</span>, res,
<a name="l00771"></a>00771                          variables=[(<span class="stringliteral">'mactool_cmd'</span>, <span class="stringliteral">'copy-bundle-resource'</span>), \
<a name="l00772"></a>00772                                     (<span class="stringliteral">'binary'</span>, isBinary)])
<a name="l00773"></a>00773         bundle_depends.append(output)
<a name="l00774"></a>00774       <span class="keywordflow">else</span>:
<a name="l00775"></a>00775         xcassets.append(res)
<a name="l00776"></a>00776     <span class="keywordflow">return</span> xcassets
<a name="l00777"></a>00777 
<a name="l00778"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#3f33073be91af48208c7d0f4be935b8f">00778</a>   <span class="keyword">def </span><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#3f33073be91af48208c7d0f4be935b8f">WriteMacXCassets</a>(self, xcassets, bundle_depends):
<a name="l00779"></a>00779     <span class="stringliteral">"""Writes ninja edges for 'mac_bundle_resources' .xcassets files.</span>
<a name="l00780"></a>00780 <span class="stringliteral"></span>
<a name="l00781"></a>00781 <span class="stringliteral">    This add an invocation of 'actool' via the 'mac_tool.py' helper script.</span>
<a name="l00782"></a>00782 <span class="stringliteral">    It assumes that the assets catalogs define at least one imageset and</span>
<a name="l00783"></a>00783 <span class="stringliteral">    thus an Assets.car file will be generated in the application resources</span>
<a name="l00784"></a>00784 <span class="stringliteral">    directory. If this is not the case, then the build will probably be done</span>
<a name="l00785"></a>00785 <span class="stringliteral">    at each invocation of ninja."""</span>
<a name="l00786"></a>00786     <span class="keywordflow">if</span> <span class="keywordflow">not</span> xcassets:
<a name="l00787"></a>00787       <span class="keywordflow">return</span>
<a name="l00788"></a>00788 
<a name="l00789"></a>00789     extra_arguments = {}
<a name="l00790"></a>00790     settings_to_arg = {
<a name="l00791"></a>00791         <span class="stringliteral">'XCASSETS_APP_ICON'</span>: <span class="stringliteral">'app-icon'</span>,
<a name="l00792"></a>00792         <span class="stringliteral">'XCASSETS_LAUNCH_IMAGE'</span>: <span class="stringliteral">'launch-image'</span>,
<a name="l00793"></a>00793     }
<a name="l00794"></a>00794     settings = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>.xcode_settings[self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#72c8aa1d973690508a559237475202c6">config_name</a>]
<a name="l00795"></a>00795     <span class="keywordflow">for</span> settings_key, arg_name <span class="keywordflow">in</span> settings_to_arg.iteritems():
<a name="l00796"></a>00796       value = settings.get(settings_key)
<a name="l00797"></a>00797       <span class="keywordflow">if</span> value:
<a name="l00798"></a>00798         extra_arguments[arg_name] = value
<a name="l00799"></a>00799 
<a name="l00800"></a>00800     partial_info_plist = <span class="keywordtype">None</span>
<a name="l00801"></a>00801     <span class="keywordflow">if</span> extra_arguments:
<a name="l00802"></a>00802       partial_info_plist = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#1a32eebd8c4ae6c6c2eb0db303f1952b">GypPathToUniqueOutput</a>(
<a name="l00803"></a>00803           <span class="stringliteral">'assetcatalog_generated_info.plist'</span>)
<a name="l00804"></a>00804       extra_arguments[<span class="stringliteral">'output-partial-info-plist'</span>] = partial_info_plist
<a name="l00805"></a>00805 
<a name="l00806"></a>00806     outputs = []
<a name="l00807"></a>00807     outputs.append(
<a name="l00808"></a>00808         os.path.join(
<a name="l00809"></a>00809             self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>.GetBundleResourceFolder(),
<a name="l00810"></a>00810             <span class="stringliteral">'Assets.car'</span>))
<a name="l00811"></a>00811     <span class="keywordflow">if</span> partial_info_plist:
<a name="l00812"></a>00812       outputs.append(partial_info_plist)
<a name="l00813"></a>00813 
<a name="l00814"></a>00814     keys = QuoteShellArgument(json.dumps(extra_arguments), self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a>)
<a name="l00815"></a>00815     extra_env = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>.GetPerTargetSettings()
<a name="l00816"></a>00816     env = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#1e807b9147c1af2adaa10b07e93b51a4">GetSortedXcodeEnv</a>(additional_settings=extra_env)
<a name="l00817"></a>00817     env = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#5c80e468c41533421d0e2d31a6a7e556">ComputeExportEnvString</a>(env)
<a name="l00818"></a>00818 
<a name="l00819"></a>00819     bundle_depends.extend(self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb01ca7812bd411b26f759814e304a4c">ninja</a>.build(
<a name="l00820"></a>00820         outputs, <span class="stringliteral">'compile_xcassets'</span>, xcassets,
<a name="l00821"></a>00821         variables=[(<span class="stringliteral">'env'</span>, env), (<span class="stringliteral">'keys'</span>, keys)]))
<a name="l00822"></a>00822     <span class="keywordflow">return</span> partial_info_plist
<a name="l00823"></a>00823 
<a name="l00824"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#efdf9de404554421cf997b6b1d0c44fc">00824</a>   <span class="keyword">def </span><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#efdf9de404554421cf997b6b1d0c44fc">WriteMacInfoPlist</a>(self, partial_info_plist, bundle_depends):
<a name="l00825"></a>00825     <span class="stringliteral">"""Write build rules for bundle Info.plist files."""</span>
<a name="l00826"></a>00826     info_plist, out, defines, extra_env = gyp.xcode_emulation.GetMacInfoPlist(
<a name="l00827"></a>00827         generator_default_variables[<span class="stringliteral">'PRODUCT_DIR'</span>],
<a name="l00828"></a>00828         self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>, self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#3770e8a9cc0f198dbc8344cbf6347c22">GypPathToNinja</a>)
<a name="l00829"></a>00829     <span class="keywordflow">if</span> <span class="keywordflow">not</span> info_plist:
<a name="l00830"></a>00830       <span class="keywordflow">return</span>
<a name="l00831"></a>00831     out = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#eca47f2b3a42089c33330749acfd861a">ExpandSpecial</a>(out)
<a name="l00832"></a>00832     <span class="keywordflow">if</span> defines:
<a name="l00833"></a>00833       <span class="comment"># Create an intermediate file to store preprocessed results.</span>
<a name="l00834"></a>00834       intermediate_plist = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#1a32eebd8c4ae6c6c2eb0db303f1952b">GypPathToUniqueOutput</a>(
<a name="l00835"></a>00835           os.path.basename(info_plist))
<a name="l00836"></a>00836       defines = <span class="stringliteral">' '</span>.join([Define(d, self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a>) <span class="keywordflow">for</span> d <span class="keywordflow">in</span> defines])
<a name="l00837"></a>00837       info_plist = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb01ca7812bd411b26f759814e304a4c">ninja</a>.build(
<a name="l00838"></a>00838           intermediate_plist, <span class="stringliteral">'preprocess_infoplist'</span>, info_plist,
<a name="l00839"></a>00839           variables=[(<span class="stringliteral">'defines'</span>,defines)])
<a name="l00840"></a>00840 
<a name="l00841"></a>00841     env = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#1e807b9147c1af2adaa10b07e93b51a4">GetSortedXcodeEnv</a>(additional_settings=extra_env)
<a name="l00842"></a>00842     env = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#5c80e468c41533421d0e2d31a6a7e556">ComputeExportEnvString</a>(env)
<a name="l00843"></a>00843 
<a name="l00844"></a>00844     <span class="keywordflow">if</span> partial_info_plist:
<a name="l00845"></a>00845       intermediate_plist = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#1a32eebd8c4ae6c6c2eb0db303f1952b">GypPathToUniqueOutput</a>(<span class="stringliteral">'merged_info.plist'</span>)
<a name="l00846"></a>00846       info_plist = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb01ca7812bd411b26f759814e304a4c">ninja</a>.build(
<a name="l00847"></a>00847           intermediate_plist, <span class="stringliteral">'merge_infoplist'</span>,
<a name="l00848"></a>00848           [partial_info_plist, info_plist])
<a name="l00849"></a>00849 
<a name="l00850"></a>00850     keys = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>.GetExtraPlistItems(self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#72c8aa1d973690508a559237475202c6">config_name</a>)
<a name="l00851"></a>00851     keys = QuoteShellArgument(json.dumps(keys), self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a>)
<a name="l00852"></a>00852     isBinary = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>.IsBinaryOutputFormat(self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#72c8aa1d973690508a559237475202c6">config_name</a>)
<a name="l00853"></a>00853     self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb01ca7812bd411b26f759814e304a4c">ninja</a>.build(out, <span class="stringliteral">'copy_infoplist'</span>, info_plist,
<a name="l00854"></a>00854                      variables=[(<span class="stringliteral">'env'</span>, env), (<span class="stringliteral">'keys'</span>, keys),
<a name="l00855"></a>00855                                 (<span class="stringliteral">'binary'</span>, isBinary)])
<a name="l00856"></a>00856     bundle_depends.append(out)
<a name="l00857"></a>00857 
<a name="l00858"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#7c3bf79a4bd2f19944fc222c6bcfffc0">00858</a>   <span class="keyword">def </span><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#7c3bf79a4bd2f19944fc222c6bcfffc0">WriteSources</a>(self, ninja_file, config_name, config, sources, predepends,
<a name="l00859"></a>00859                    precompiled_header, spec):
<a name="l00860"></a>00860     <span class="stringliteral">"""Write build rules to compile all of |sources|."""</span>
<a name="l00861"></a>00861     <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">toolset</a> == <span class="stringliteral">'host'</span>:
<a name="l00862"></a>00862       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb01ca7812bd411b26f759814e304a4c">ninja</a>.variable(<span class="stringliteral">'ar'</span>, <span class="stringliteral">'$ar_host'</span>)
<a name="l00863"></a>00863       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb01ca7812bd411b26f759814e304a4c">ninja</a>.variable(<span class="stringliteral">'cc'</span>, <span class="stringliteral">'$cc_host'</span>)
<a name="l00864"></a>00864       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb01ca7812bd411b26f759814e304a4c">ninja</a>.variable(<span class="stringliteral">'cxx'</span>, <span class="stringliteral">'$cxx_host'</span>)
<a name="l00865"></a>00865       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb01ca7812bd411b26f759814e304a4c">ninja</a>.variable(<span class="stringliteral">'ld'</span>, <span class="stringliteral">'$ld_host'</span>)
<a name="l00866"></a>00866       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb01ca7812bd411b26f759814e304a4c">ninja</a>.variable(<span class="stringliteral">'ldxx'</span>, <span class="stringliteral">'$ldxx_host'</span>)
<a name="l00867"></a>00867       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb01ca7812bd411b26f759814e304a4c">ninja</a>.variable(<span class="stringliteral">'nm'</span>, <span class="stringliteral">'$nm_host'</span>)
<a name="l00868"></a>00868       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb01ca7812bd411b26f759814e304a4c">ninja</a>.variable(<span class="stringliteral">'readelf'</span>, <span class="stringliteral">'$readelf_host'</span>)
<a name="l00869"></a>00869 
<a name="l00870"></a>00870     <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> != <span class="stringliteral">'mac'</span> <span class="keywordflow">or</span> len(self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#7d813c7e211464aaa8638f46ca90c924">archs</a>) == 1:
<a name="l00871"></a>00871       <span class="keywordflow">return</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#7407b55355ce59eb313861590932df06">WriteSourcesForArch</a>(
<a name="l00872"></a>00872           self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb01ca7812bd411b26f759814e304a4c">ninja</a>, config_name, config, sources, predepends,
<a name="l00873"></a>00873           precompiled_header, spec)
<a name="l00874"></a>00874     <span class="keywordflow">else</span>:
<a name="l00875"></a>00875       <span class="keywordflow">return</span> dict((arch, self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#7407b55355ce59eb313861590932df06">WriteSourcesForArch</a>(
<a name="l00876"></a>00876             self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#10945e7b0105fb01395cbbbb07156eb9">arch_subninjas</a>[arch], config_name, config, sources, predepends,
<a name="l00877"></a>00877             precompiled_header, spec, arch=arch))
<a name="l00878"></a>00878           <span class="keywordflow">for</span> arch <span class="keywordflow">in</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#7d813c7e211464aaa8638f46ca90c924">archs</a>)
<a name="l00879"></a>00879 
<a name="l00880"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#7407b55355ce59eb313861590932df06">00880</a>   <span class="keyword">def </span><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#7407b55355ce59eb313861590932df06">WriteSourcesForArch</a>(self, ninja_file, config_name, config, sources,
<a name="l00881"></a>00881                           predepends, precompiled_header, spec, arch=<span class="keywordtype">None</span>):
<a name="l00882"></a>00882     <span class="stringliteral">"""Write build rules to compile all of |sources|."""</span>
<a name="l00883"></a>00883 
<a name="l00884"></a>00884     extra_defines = []
<a name="l00885"></a>00885     <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'mac'</span>:
<a name="l00886"></a>00886       cflags = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>.GetCflags(config_name, arch=arch)
<a name="l00887"></a>00887       cflags_c = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>.GetCflagsC(config_name)
<a name="l00888"></a>00888       cflags_cc = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>.GetCflagsCC(config_name)
<a name="l00889"></a>00889       cflags_objc = [<span class="stringliteral">'$cflags_c'</span>] + \
<a name="l00890"></a>00890                     self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>.GetCflagsObjC(config_name)
<a name="l00891"></a>00891       cflags_objcc = [<span class="stringliteral">'$cflags_cc'</span>] + \
<a name="l00892"></a>00892                      self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>.GetCflagsObjCC(config_name)
<a name="l00893"></a>00893     <span class="keywordflow">elif</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'win'</span>:
<a name="l00894"></a>00894       asmflags = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#05976cc272fa4d277ce291f093ca63be">msvs_settings</a>.GetAsmflags(config_name)
<a name="l00895"></a>00895       cflags = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#05976cc272fa4d277ce291f093ca63be">msvs_settings</a>.GetCflags(config_name)
<a name="l00896"></a>00896       cflags_c = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#05976cc272fa4d277ce291f093ca63be">msvs_settings</a>.GetCflagsC(config_name)
<a name="l00897"></a>00897       cflags_cc = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#05976cc272fa4d277ce291f093ca63be">msvs_settings</a>.GetCflagsCC(config_name)
<a name="l00898"></a>00898       extra_defines = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#05976cc272fa4d277ce291f093ca63be">msvs_settings</a>.GetComputedDefines(config_name)
<a name="l00899"></a>00899       <span class="comment"># See comment at cc_command for why there's two .pdb files.</span>
<a name="l00900"></a>00900       pdbpath_c = pdbpath_cc = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#05976cc272fa4d277ce291f093ca63be">msvs_settings</a>.GetCompilerPdbName(
<a name="l00901"></a>00901           config_name, self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#eca47f2b3a42089c33330749acfd861a">ExpandSpecial</a>)
<a name="l00902"></a>00902       <span class="keywordflow">if</span> <span class="keywordflow">not</span> pdbpath_c:
<a name="l00903"></a>00903         obj = <span class="stringliteral">'obj'</span>
<a name="l00904"></a>00904         <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">toolset</a> != <span class="stringliteral">'target'</span>:
<a name="l00905"></a>00905           obj += <span class="stringliteral">'.'</span> + self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">toolset</a>
<a name="l00906"></a>00906         pdbpath = os.path.normpath(os.path.join(obj, self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#8ef3db3a5273b76c536881adb1ddeb63">base_dir</a>, self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#b74e6bf80237ddc4109968cedc58c151">name</a>))
<a name="l00907"></a>00907         pdbpath_c = pdbpath + <span class="stringliteral">'.c.pdb'</span>
<a name="l00908"></a>00908         pdbpath_cc = pdbpath + <span class="stringliteral">'.cc.pdb'</span>
<a name="l00909"></a>00909       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#dbfa62b2ae38fae55f305dc092883b7c">WriteVariableList</a>(ninja_file, <span class="stringliteral">'pdbname_c'</span>, [pdbpath_c])
<a name="l00910"></a>00910       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#dbfa62b2ae38fae55f305dc092883b7c">WriteVariableList</a>(ninja_file, <span class="stringliteral">'pdbname_cc'</span>, [pdbpath_cc])
<a name="l00911"></a>00911       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#dbfa62b2ae38fae55f305dc092883b7c">WriteVariableList</a>(ninja_file, <span class="stringliteral">'pchprefix'</span>, [self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#b74e6bf80237ddc4109968cedc58c151">name</a>])
<a name="l00912"></a>00912     <span class="keywordflow">else</span>:
<a name="l00913"></a>00913       cflags = config.get(<span class="stringliteral">'cflags'</span>, [])
<a name="l00914"></a>00914       cflags_c = config.get(<span class="stringliteral">'cflags_c'</span>, [])
<a name="l00915"></a>00915       cflags_cc = config.get(<span class="stringliteral">'cflags_cc'</span>, [])
<a name="l00916"></a>00916 
<a name="l00917"></a>00917     <span class="comment"># Respect environment variables related to build, but target-specific</span>
<a name="l00918"></a>00918     <span class="comment"># flags can still override them.</span>
<a name="l00919"></a>00919     <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">toolset</a> == <span class="stringliteral">'target'</span>:
<a name="l00920"></a>00920       cflags_c = (os.environ.get(<span class="stringliteral">'CPPFLAGS'</span>, <span class="stringliteral">''</span>).split() +
<a name="l00921"></a>00921                   os.environ.get(<span class="stringliteral">'CFLAGS'</span>, <span class="stringliteral">''</span>).split() + cflags_c)
<a name="l00922"></a>00922       cflags_cc = (os.environ.get(<span class="stringliteral">'CPPFLAGS'</span>, <span class="stringliteral">''</span>).split() +
<a name="l00923"></a>00923                    os.environ.get(<span class="stringliteral">'CXXFLAGS'</span>, <span class="stringliteral">''</span>).split() + cflags_cc)
<a name="l00924"></a>00924 
<a name="l00925"></a>00925     defines = config.get(<span class="stringliteral">'defines'</span>, []) + extra_defines
<a name="l00926"></a>00926     self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#dbfa62b2ae38fae55f305dc092883b7c">WriteVariableList</a>(ninja_file, <span class="stringliteral">'defines'</span>,
<a name="l00927"></a>00927                            [Define(d, self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a>) <span class="keywordflow">for</span> d <span class="keywordflow">in</span> defines])
<a name="l00928"></a>00928     <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'win'</span>:
<a name="l00929"></a>00929       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#dbfa62b2ae38fae55f305dc092883b7c">WriteVariableList</a>(ninja_file, <span class="stringliteral">'asmflags'</span>,
<a name="l00930"></a>00930                              map(self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#eca47f2b3a42089c33330749acfd861a">ExpandSpecial</a>, asmflags))
<a name="l00931"></a>00931       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#dbfa62b2ae38fae55f305dc092883b7c">WriteVariableList</a>(ninja_file, <span class="stringliteral">'rcflags'</span>,
<a name="l00932"></a>00932           [QuoteShellArgument(self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#eca47f2b3a42089c33330749acfd861a">ExpandSpecial</a>(f), self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a>)
<a name="l00933"></a>00933            <span class="keywordflow">for</span> f <span class="keywordflow">in</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#05976cc272fa4d277ce291f093ca63be">msvs_settings</a>.GetRcflags(config_name,
<a name="l00934"></a>00934                                                   self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#3770e8a9cc0f198dbc8344cbf6347c22">GypPathToNinja</a>)])
<a name="l00935"></a>00935 
<a name="l00936"></a>00936     include_dirs = config.get(<span class="stringliteral">'include_dirs'</span>, [])
<a name="l00937"></a>00937 
<a name="l00938"></a>00938     env = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#e915b7f19b39ed5ef63ee70b7b5eb298">GetToolchainEnv</a>()
<a name="l00939"></a>00939     <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'win'</span>:
<a name="l00940"></a>00940       include_dirs = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#05976cc272fa4d277ce291f093ca63be">msvs_settings</a>.AdjustIncludeDirs(include_dirs,
<a name="l00941"></a>00941                                                           config_name)
<a name="l00942"></a>00942     self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#dbfa62b2ae38fae55f305dc092883b7c">WriteVariableList</a>(ninja_file, <span class="stringliteral">'includes'</span>,
<a name="l00943"></a>00943         [QuoteShellArgument(<span class="stringliteral">'-I'</span> + self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#3770e8a9cc0f198dbc8344cbf6347c22">GypPathToNinja</a>(i, env), self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a>)
<a name="l00944"></a>00944          <span class="keywordflow">for</span> i <span class="keywordflow">in</span> include_dirs])
<a name="l00945"></a>00945 
<a name="l00946"></a>00946     <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'win'</span>:
<a name="l00947"></a>00947       midl_include_dirs = config.get(<span class="stringliteral">'midl_include_dirs'</span>, [])
<a name="l00948"></a>00948       midl_include_dirs = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#05976cc272fa4d277ce291f093ca63be">msvs_settings</a>.AdjustMidlIncludeDirs(
<a name="l00949"></a>00949           midl_include_dirs, config_name)
<a name="l00950"></a>00950       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#dbfa62b2ae38fae55f305dc092883b7c">WriteVariableList</a>(ninja_file, <span class="stringliteral">'midl_includes'</span>,
<a name="l00951"></a>00951           [QuoteShellArgument(<span class="stringliteral">'-I'</span> + self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#3770e8a9cc0f198dbc8344cbf6347c22">GypPathToNinja</a>(i, env), self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a>)
<a name="l00952"></a>00952            <span class="keywordflow">for</span> i <span class="keywordflow">in</span> midl_include_dirs])
<a name="l00953"></a>00953 
<a name="l00954"></a>00954     pch_commands = precompiled_header.GetPchBuildCommands(arch)
<a name="l00955"></a>00955     <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'mac'</span>:
<a name="l00956"></a>00956       <span class="comment"># Most targets use no precompiled headers, so only write these if needed.</span>
<a name="l00957"></a>00957       <span class="keywordflow">for</span> ext, var <span class="keywordflow">in</span> [(<span class="stringliteral">'c'</span>, <span class="stringliteral">'cflags_pch_c'</span>), (<span class="stringliteral">'cc'</span>, <span class="stringliteral">'cflags_pch_cc'</span>),
<a name="l00958"></a>00958                        (<span class="stringliteral">'m'</span>, <span class="stringliteral">'cflags_pch_objc'</span>), (<span class="stringliteral">'mm'</span>, <span class="stringliteral">'cflags_pch_objcc'</span>)]:
<a name="l00959"></a>00959         include = precompiled_header.GetInclude(ext, arch)
<a name="l00960"></a>00960         <span class="keywordflow">if</span> include: ninja_file.variable(var, include)
<a name="l00961"></a>00961 
<a name="l00962"></a>00962     arflags = config.get(<span class="stringliteral">'arflags'</span>, [])
<a name="l00963"></a>00963 
<a name="l00964"></a>00964     self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#dbfa62b2ae38fae55f305dc092883b7c">WriteVariableList</a>(ninja_file, <span class="stringliteral">'cflags'</span>,
<a name="l00965"></a>00965                            map(self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#eca47f2b3a42089c33330749acfd861a">ExpandSpecial</a>, cflags))
<a name="l00966"></a>00966     self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#dbfa62b2ae38fae55f305dc092883b7c">WriteVariableList</a>(ninja_file, <span class="stringliteral">'cflags_c'</span>,
<a name="l00967"></a>00967                            map(self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#eca47f2b3a42089c33330749acfd861a">ExpandSpecial</a>, cflags_c))
<a name="l00968"></a>00968     self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#dbfa62b2ae38fae55f305dc092883b7c">WriteVariableList</a>(ninja_file, <span class="stringliteral">'cflags_cc'</span>,
<a name="l00969"></a>00969                            map(self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#eca47f2b3a42089c33330749acfd861a">ExpandSpecial</a>, cflags_cc))
<a name="l00970"></a>00970     <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'mac'</span>:
<a name="l00971"></a>00971       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#dbfa62b2ae38fae55f305dc092883b7c">WriteVariableList</a>(ninja_file, <span class="stringliteral">'cflags_objc'</span>,
<a name="l00972"></a>00972                              map(self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#eca47f2b3a42089c33330749acfd861a">ExpandSpecial</a>, cflags_objc))
<a name="l00973"></a>00973       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#dbfa62b2ae38fae55f305dc092883b7c">WriteVariableList</a>(ninja_file, <span class="stringliteral">'cflags_objcc'</span>,
<a name="l00974"></a>00974                              map(self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#eca47f2b3a42089c33330749acfd861a">ExpandSpecial</a>, cflags_objcc))
<a name="l00975"></a>00975     self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#dbfa62b2ae38fae55f305dc092883b7c">WriteVariableList</a>(ninja_file, <span class="stringliteral">'arflags'</span>,
<a name="l00976"></a>00976                            map(self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#eca47f2b3a42089c33330749acfd861a">ExpandSpecial</a>, arflags))
<a name="l00977"></a>00977     ninja_file.newline()
<a name="l00978"></a>00978     outputs = []
<a name="l00979"></a>00979     has_rc_source = <span class="keyword">False</span>
<a name="l00980"></a>00980     <span class="keywordflow">for</span> source <span class="keywordflow">in</span> sources:
<a name="l00981"></a>00981       filename, ext = os.path.splitext(source)
<a name="l00982"></a>00982       ext = ext[1:]
<a name="l00983"></a>00983       obj_ext = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#22730c3bc6462078334e2d5bb4e30f3b">obj_ext</a>
<a name="l00984"></a>00984       <span class="keywordflow">if</span> ext <span class="keywordflow">in</span> (<span class="stringliteral">'cc'</span>, <span class="stringliteral">'cpp'</span>, <span class="stringliteral">'cxx'</span>):
<a name="l00985"></a>00985         command = <span class="stringliteral">'cxx'</span>
<a name="l00986"></a>00986         self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#644859abf0c3b91bdab0013d21e12095">uses_cpp</a> = <span class="keyword">True</span>
<a name="l00987"></a>00987       <span class="keywordflow">elif</span> ext == <span class="stringliteral">'c'</span> <span class="keywordflow">or</span> (ext == <span class="stringliteral">'S'</span> <span class="keywordflow">and</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> != <span class="stringliteral">'win'</span>):
<a name="l00988"></a>00988         command = <span class="stringliteral">'cc'</span>
<a name="l00989"></a>00989       <span class="keywordflow">elif</span> ext == <span class="stringliteral">'s'</span> <span class="keywordflow">and</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> != <span class="stringliteral">'win'</span>:  <span class="comment"># Doesn't generate .o.d files.</span>
<a name="l00990"></a>00990         command = <span class="stringliteral">'cc_s'</span>
<a name="l00991"></a>00991       <span class="keywordflow">elif</span> (self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'win'</span> <span class="keywordflow">and</span> ext == <span class="stringliteral">'asm'</span> <span class="keywordflow">and</span>
<a name="l00992"></a>00992             <span class="keywordflow">not</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#05976cc272fa4d277ce291f093ca63be">msvs_settings</a>.HasExplicitAsmRules(spec)):
<a name="l00993"></a>00993         command = <span class="stringliteral">'asm'</span>
<a name="l00994"></a>00994         <span class="comment"># Add the _asm suffix as msvs is capable of handling .cc and</span>
<a name="l00995"></a>00995         <span class="comment"># .asm files of the same name without collision.</span>
<a name="l00996"></a>00996         obj_ext = <span class="stringliteral">'_asm.obj'</span>
<a name="l00997"></a>00997       <span class="keywordflow">elif</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'mac'</span> <span class="keywordflow">and</span> ext == <span class="stringliteral">'m'</span>:
<a name="l00998"></a>00998         command = <span class="stringliteral">'objc'</span>
<a name="l00999"></a>00999       <span class="keywordflow">elif</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'mac'</span> <span class="keywordflow">and</span> ext == <span class="stringliteral">'mm'</span>:
<a name="l01000"></a>01000         command = <span class="stringliteral">'objcxx'</span>
<a name="l01001"></a>01001         self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#644859abf0c3b91bdab0013d21e12095">uses_cpp</a> = <span class="keyword">True</span>
<a name="l01002"></a>01002       <span class="keywordflow">elif</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'win'</span> <span class="keywordflow">and</span> ext == <span class="stringliteral">'rc'</span>:
<a name="l01003"></a>01003         command = <span class="stringliteral">'rc'</span>
<a name="l01004"></a>01004         obj_ext = <span class="stringliteral">'.res'</span>
<a name="l01005"></a>01005         has_rc_source = <span class="keyword">True</span>
<a name="l01006"></a>01006       <span class="keywordflow">else</span>:
<a name="l01007"></a>01007         <span class="comment"># Ignore unhandled extensions.</span>
<a name="l01008"></a>01008         <span class="keywordflow">continue</span>
<a name="l01009"></a>01009       input = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#3770e8a9cc0f198dbc8344cbf6347c22">GypPathToNinja</a>(source)
<a name="l01010"></a>01010       output = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#1a32eebd8c4ae6c6c2eb0db303f1952b">GypPathToUniqueOutput</a>(filename + obj_ext)
<a name="l01011"></a>01011       <span class="keywordflow">if</span> arch <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:
<a name="l01012"></a>01012         output = AddArch(output, arch)
<a name="l01013"></a>01013       implicit = precompiled_header.GetObjDependencies([input], [output], arch)
<a name="l01014"></a>01014       variables = []
<a name="l01015"></a>01015       <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'win'</span>:
<a name="l01016"></a>01016         variables, output, implicit = precompiled_header.GetFlagsModifications(
<a name="l01017"></a>01017             input, output, implicit, command, cflags_c, cflags_cc,
<a name="l01018"></a>01018             self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#eca47f2b3a42089c33330749acfd861a">ExpandSpecial</a>)
<a name="l01019"></a>01019       ninja_file.build(output, command, input,
<a name="l01020"></a>01020                        implicit=[gch <span class="keywordflow">for</span> _, _, gch <span class="keywordflow">in</span> implicit],
<a name="l01021"></a>01021                        order_only=predepends, variables=variables)
<a name="l01022"></a>01022       outputs.append(output)
<a name="l01023"></a>01023 
<a name="l01024"></a>01024     <span class="keywordflow">if</span> has_rc_source:
<a name="l01025"></a>01025       resource_include_dirs = config.get(<span class="stringliteral">'resource_include_dirs'</span>, include_dirs)
<a name="l01026"></a>01026       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#dbfa62b2ae38fae55f305dc092883b7c">WriteVariableList</a>(ninja_file, <span class="stringliteral">'resource_includes'</span>,
<a name="l01027"></a>01027           [QuoteShellArgument(<span class="stringliteral">'-I'</span> + self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#3770e8a9cc0f198dbc8344cbf6347c22">GypPathToNinja</a>(i, env), self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a>)
<a name="l01028"></a>01028            <span class="keywordflow">for</span> i <span class="keywordflow">in</span> resource_include_dirs])
<a name="l01029"></a>01029 
<a name="l01030"></a>01030     self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#e2943d5fd61220e2d1e6792614de8d16">WritePchTargets</a>(ninja_file, pch_commands)
<a name="l01031"></a>01031 
<a name="l01032"></a>01032     ninja_file.newline()
<a name="l01033"></a>01033     <span class="keywordflow">return</span> outputs
<a name="l01034"></a>01034 
<a name="l01035"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#e2943d5fd61220e2d1e6792614de8d16">01035</a>   <span class="keyword">def </span><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#e2943d5fd61220e2d1e6792614de8d16">WritePchTargets</a>(self, ninja_file, pch_commands):
<a name="l01036"></a>01036     <span class="stringliteral">"""Writes ninja rules to compile prefix headers."""</span>
<a name="l01037"></a>01037     <span class="keywordflow">if</span> <span class="keywordflow">not</span> pch_commands:
<a name="l01038"></a>01038       <span class="keywordflow">return</span>
<a name="l01039"></a>01039 
<a name="l01040"></a>01040     <span class="keywordflow">for</span> gch, lang_flag, lang, input <span class="keywordflow">in</span> pch_commands:
<a name="l01041"></a>01041       var_name = {
<a name="l01042"></a>01042         <span class="stringliteral">'c'</span>: <span class="stringliteral">'cflags_pch_c'</span>,
<a name="l01043"></a>01043         <span class="stringliteral">'cc'</span>: <span class="stringliteral">'cflags_pch_cc'</span>,
<a name="l01044"></a>01044         <span class="stringliteral">'m'</span>: <span class="stringliteral">'cflags_pch_objc'</span>,
<a name="l01045"></a>01045         <span class="stringliteral">'mm'</span>: <span class="stringliteral">'cflags_pch_objcc'</span>,
<a name="l01046"></a>01046       }[lang]
<a name="l01047"></a>01047 
<a name="l01048"></a>01048       map = { <span class="stringliteral">'c'</span>: <span class="stringliteral">'cc'</span>, <span class="stringliteral">'cc'</span>: <span class="stringliteral">'cxx'</span>, <span class="stringliteral">'m'</span>: <span class="stringliteral">'objc'</span>, <span class="stringliteral">'mm'</span>: <span class="stringliteral">'objcxx'</span>, }
<a name="l01049"></a>01049       cmd = map.get(lang)
<a name="l01050"></a>01050       ninja_file.build(gch, cmd, input, variables=[(var_name, lang_flag)])
<a name="l01051"></a>01051 
<a name="l01052"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#6faaabf605361cd78d97b1e27fcdb0bd">01052</a>   <span class="keyword">def </span><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#6faaabf605361cd78d97b1e27fcdb0bd">WriteLink</a>(self, spec, config_name, config, link_deps):
<a name="l01053"></a>01053     <span class="stringliteral">"""Write out a link step. Fills out target.binary. """</span>
<a name="l01054"></a>01054     <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> != <span class="stringliteral">'mac'</span> <span class="keywordflow">or</span> len(self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#7d813c7e211464aaa8638f46ca90c924">archs</a>) == 1:
<a name="l01055"></a>01055       <span class="keywordflow">return</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#17866acafc6f01ac56e287ef80234f6a">WriteLinkForArch</a>(
<a name="l01056"></a>01056           self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb01ca7812bd411b26f759814e304a4c">ninja</a>, spec, config_name, config, link_deps)
<a name="l01057"></a>01057     <span class="keywordflow">else</span>:
<a name="l01058"></a>01058       output = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#097c9e2913bffe213c7a56b1b1508997">ComputeOutput</a>(spec)
<a name="l01059"></a>01059       inputs = [self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#17866acafc6f01ac56e287ef80234f6a">WriteLinkForArch</a>(self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#10945e7b0105fb01395cbbbb07156eb9">arch_subninjas</a>[arch], spec,
<a name="l01060"></a>01060                                       config_name, config, link_deps[arch],
<a name="l01061"></a>01061                                       arch=arch)
<a name="l01062"></a>01062                 <span class="keywordflow">for</span> arch <span class="keywordflow">in</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#7d813c7e211464aaa8638f46ca90c924">archs</a>]
<a name="l01063"></a>01063       extra_bindings = []
<a name="l01064"></a>01064       build_output = output
<a name="l01065"></a>01065       <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#e9044354be1c8bc6f5f25fc45ec6f5df">is_mac_bundle</a>:
<a name="l01066"></a>01066         self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#8557f69b395aa2350fc3adab4a53f548">AppendPostbuildVariable</a>(extra_bindings, spec, output, output)
<a name="l01067"></a>01067 
<a name="l01068"></a>01068       <span class="comment"># TODO(yyanagisawa): more work needed to fix:</span>
<a name="l01069"></a>01069       <span class="comment"># https://code.google.com/p/gyp/issues/detail?id=411</span>
<a name="l01070"></a>01070       <span class="keywordflow">if</span> (spec[<span class="stringliteral">'type'</span>] <span class="keywordflow">in</span> (<span class="stringliteral">'shared_library'</span>, <span class="stringliteral">'loadable_module'</span>) <span class="keywordflow">and</span>
<a name="l01071"></a>01071           <span class="keywordflow">not</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#e9044354be1c8bc6f5f25fc45ec6f5df">is_mac_bundle</a>):
<a name="l01072"></a>01072         extra_bindings.append((<span class="stringliteral">'lib'</span>, output))
<a name="l01073"></a>01073         self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb01ca7812bd411b26f759814e304a4c">ninja</a>.build([output, output + <span class="stringliteral">'.TOC'</span>], <span class="stringliteral">'solipo'</span>, inputs,
<a name="l01074"></a>01074             variables=extra_bindings)
<a name="l01075"></a>01075       <span class="keywordflow">else</span>:
<a name="l01076"></a>01076         self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb01ca7812bd411b26f759814e304a4c">ninja</a>.build(build_output, <span class="stringliteral">'lipo'</span>, inputs, variables=extra_bindings)
<a name="l01077"></a>01077       <span class="keywordflow">return</span> output
<a name="l01078"></a>01078 
<a name="l01079"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#17866acafc6f01ac56e287ef80234f6a">01079</a>   <span class="keyword">def </span><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#17866acafc6f01ac56e287ef80234f6a">WriteLinkForArch</a>(self, ninja_file, spec, config_name, config,
<a name="l01080"></a>01080                        link_deps, arch=<span class="keywordtype">None</span>):
<a name="l01081"></a>01081     <span class="stringliteral">"""Write out a link step. Fills out target.binary. """</span>
<a name="l01082"></a>01082     command = {
<a name="l01083"></a>01083       <span class="stringliteral">'executable'</span>:      <span class="stringliteral">'link'</span>,
<a name="l01084"></a>01084       <span class="stringliteral">'loadable_module'</span>: <span class="stringliteral">'solink_module'</span>,
<a name="l01085"></a>01085       <span class="stringliteral">'shared_library'</span>:  <span class="stringliteral">'solink'</span>,
<a name="l01086"></a>01086     }[spec[<span class="stringliteral">'type'</span>]]
<a name="l01087"></a>01087     command_suffix = <span class="stringliteral">''</span>
<a name="l01088"></a>01088 
<a name="l01089"></a>01089     implicit_deps = set()
<a name="l01090"></a>01090     solibs = set()
<a name="l01091"></a>01091 
<a name="l01092"></a>01092     <span class="keywordflow">if</span> <span class="stringliteral">'dependencies'</span> <span class="keywordflow">in</span> spec:
<a name="l01093"></a>01093       <span class="comment"># Two kinds of dependencies:</span>
<a name="l01094"></a>01094       <span class="comment"># - Linkable dependencies (like a .a or a .so): add them to the link line.</span>
<a name="l01095"></a>01095       <span class="comment"># - Non-linkable dependencies (like a rule that generates a file</span>
<a name="l01096"></a>01096       <span class="comment">#   and writes a stamp file): add them to implicit_deps</span>
<a name="l01097"></a>01097       extra_link_deps = set()
<a name="l01098"></a>01098       <span class="keywordflow">for</span> dep <span class="keywordflow">in</span> spec[<span class="stringliteral">'dependencies'</span>]:
<a name="l01099"></a>01099         target = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#459cc34c149ee1fd281ba6c024ca2ce9">target_outputs</a>.get(dep)
<a name="l01100"></a>01100         <span class="keywordflow">if</span> <span class="keywordflow">not</span> target:
<a name="l01101"></a>01101           <span class="keywordflow">continue</span>
<a name="l01102"></a>01102         linkable = target.Linkable()
<a name="l01103"></a>01103         <span class="keywordflow">if</span> linkable:
<a name="l01104"></a>01104           new_deps = []
<a name="l01105"></a>01105           <span class="keywordflow">if</span> (self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'win'</span> <span class="keywordflow">and</span>
<a name="l01106"></a>01106               target.component_objs <span class="keywordflow">and</span>
<a name="l01107"></a>01107               self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#05976cc272fa4d277ce291f093ca63be">msvs_settings</a>.IsUseLibraryDependencyInputs(config_name)):
<a name="l01108"></a>01108             new_deps = target.component_objs
<a name="l01109"></a>01109           <span class="keywordflow">elif</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'win'</span> <span class="keywordflow">and</span> target.import_lib:
<a name="l01110"></a>01110             new_deps = [target.import_lib]
<a name="l01111"></a>01111           <span class="keywordflow">elif</span> target.UsesToc(self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a>):
<a name="l01112"></a>01112             solibs.add(target.binary)
<a name="l01113"></a>01113             implicit_deps.add(target.binary + <span class="stringliteral">'.TOC'</span>)
<a name="l01114"></a>01114           <span class="keywordflow">else</span>:
<a name="l01115"></a>01115             new_deps = [target.binary]
<a name="l01116"></a>01116           <span class="keywordflow">for</span> new_dep <span class="keywordflow">in</span> new_deps:
<a name="l01117"></a>01117             <span class="keywordflow">if</span> new_dep <span class="keywordflow">not</span> <span class="keywordflow">in</span> extra_link_deps:
<a name="l01118"></a>01118               extra_link_deps.add(new_dep)
<a name="l01119"></a>01119               link_deps.append(new_dep)
<a name="l01120"></a>01120 
<a name="l01121"></a>01121         final_output = target.FinalOutput()
<a name="l01122"></a>01122         <span class="keywordflow">if</span> <span class="keywordflow">not</span> linkable <span class="keywordflow">or</span> final_output != target.binary:
<a name="l01123"></a>01123           implicit_deps.add(final_output)
<a name="l01124"></a>01124 
<a name="l01125"></a>01125     extra_bindings = []
<a name="l01126"></a>01126     <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#644859abf0c3b91bdab0013d21e12095">uses_cpp</a> <span class="keywordflow">and</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> != <span class="stringliteral">'win'</span>:
<a name="l01127"></a>01127       extra_bindings.append((<span class="stringliteral">'ld'</span>, <span class="stringliteral">'$ldxx'</span>))
<a name="l01128"></a>01128 
<a name="l01129"></a>01129     output = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#097c9e2913bffe213c7a56b1b1508997">ComputeOutput</a>(spec, arch)
<a name="l01130"></a>01130     <span class="keywordflow">if</span> arch <span class="keywordflow">is</span> <span class="keywordtype">None</span> <span class="keywordflow">and</span> <span class="keywordflow">not</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#e9044354be1c8bc6f5f25fc45ec6f5df">is_mac_bundle</a>:
<a name="l01131"></a>01131       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#8557f69b395aa2350fc3adab4a53f548">AppendPostbuildVariable</a>(extra_bindings, spec, output, output)
<a name="l01132"></a>01132 
<a name="l01133"></a>01133     is_executable = spec[<span class="stringliteral">'type'</span>] == <span class="stringliteral">'executable'</span>
<a name="l01134"></a>01134     <span class="comment"># The ldflags config key is not used on mac or win. On those platforms</span>
<a name="l01135"></a>01135     <span class="comment"># linker flags are set via xcode_settings and msvs_settings, respectively.</span>
<a name="l01136"></a>01136     env_ldflags = os.environ.get(<span class="stringliteral">'LDFLAGS'</span>, <span class="stringliteral">''</span>).split()
<a name="l01137"></a>01137     <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'mac'</span>:
<a name="l01138"></a>01138       ldflags = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>.GetLdflags(config_name,
<a name="l01139"></a>01139           self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#eca47f2b3a42089c33330749acfd861a">ExpandSpecial</a>(generator_default_variables[<span class="stringliteral">'PRODUCT_DIR'</span>]),
<a name="l01140"></a>01140           self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#3770e8a9cc0f198dbc8344cbf6347c22">GypPathToNinja</a>, arch)
<a name="l01141"></a>01141       ldflags = env_ldflags + ldflags
<a name="l01142"></a>01142     <span class="keywordflow">elif</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'win'</span>:
<a name="l01143"></a>01143       manifest_base_name = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#1a32eebd8c4ae6c6c2eb0db303f1952b">GypPathToUniqueOutput</a>(
<a name="l01144"></a>01144           self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#8d27eba1b7eef06cada06481b523ba94">ComputeOutputFileName</a>(spec))
<a name="l01145"></a>01145       ldflags, intermediate_manifest, manifest_files = \
<a name="l01146"></a>01146           self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#05976cc272fa4d277ce291f093ca63be">msvs_settings</a>.GetLdflags(config_name, self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#3770e8a9cc0f198dbc8344cbf6347c22">GypPathToNinja</a>,
<a name="l01147"></a>01147                                         self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#eca47f2b3a42089c33330749acfd861a">ExpandSpecial</a>, manifest_base_name,
<a name="l01148"></a>01148                                         output, is_executable,
<a name="l01149"></a>01149                                         self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#9968ef52a3e29a0d1fbcdb727c7dd318">toplevel_build</a>)
<a name="l01150"></a>01150       ldflags = env_ldflags + ldflags
<a name="l01151"></a>01151       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#dbfa62b2ae38fae55f305dc092883b7c">WriteVariableList</a>(ninja_file, <span class="stringliteral">'manifests'</span>, manifest_files)
<a name="l01152"></a>01152       implicit_deps = implicit_deps.union(manifest_files)
<a name="l01153"></a>01153       <span class="keywordflow">if</span> intermediate_manifest:
<a name="l01154"></a>01154         self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#dbfa62b2ae38fae55f305dc092883b7c">WriteVariableList</a>(
<a name="l01155"></a>01155             ninja_file, <span class="stringliteral">'intermediatemanifest'</span>, [intermediate_manifest])
<a name="l01156"></a>01156       command_suffix = _GetWinLinkRuleNameSuffix(
<a name="l01157"></a>01157           self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#05976cc272fa4d277ce291f093ca63be">msvs_settings</a>.IsEmbedManifest(config_name))
<a name="l01158"></a>01158       def_file = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#05976cc272fa4d277ce291f093ca63be">msvs_settings</a>.GetDefFile(self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#3770e8a9cc0f198dbc8344cbf6347c22">GypPathToNinja</a>)
<a name="l01159"></a>01159       <span class="keywordflow">if</span> def_file:
<a name="l01160"></a>01160         implicit_deps.add(def_file)
<a name="l01161"></a>01161     <span class="keywordflow">else</span>:
<a name="l01162"></a>01162       <span class="comment"># Respect environment variables related to build, but target-specific</span>
<a name="l01163"></a>01163       <span class="comment"># flags can still override them.</span>
<a name="l01164"></a>01164       ldflags = env_ldflags + config.get(<span class="stringliteral">'ldflags'</span>, [])
<a name="l01165"></a>01165       <span class="keywordflow">if</span> is_executable <span class="keywordflow">and</span> len(solibs):
<a name="l01166"></a>01166         rpath = <span class="stringliteral">'lib/'</span>
<a name="l01167"></a>01167         <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">toolset</a> != <span class="stringliteral">'target'</span>:
<a name="l01168"></a>01168           rpath += self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">toolset</a>
<a name="l01169"></a>01169         ldflags.append(<span class="stringliteral">r'-Wl,-rpath=\$$ORIGIN/%s'</span> % rpath)
<a name="l01170"></a>01170         ldflags.append(<span class="stringliteral">'-Wl,-rpath-link=%s'</span> % rpath)
<a name="l01171"></a>01171     self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#dbfa62b2ae38fae55f305dc092883b7c">WriteVariableList</a>(ninja_file, <span class="stringliteral">'ldflags'</span>,
<a name="l01172"></a>01172                            gyp.common.uniquer(map(self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#eca47f2b3a42089c33330749acfd861a">ExpandSpecial</a>, ldflags)))
<a name="l01173"></a>01173 
<a name="l01174"></a>01174     library_dirs = config.get(<span class="stringliteral">'library_dirs'</span>, [])
<a name="l01175"></a>01175     <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'win'</span>:
<a name="l01176"></a>01176       library_dirs = [self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#05976cc272fa4d277ce291f093ca63be">msvs_settings</a>.ConvertVSMacros(l, config_name)
<a name="l01177"></a>01177                       <span class="keywordflow">for</span> l <span class="keywordflow">in</span> library_dirs]
<a name="l01178"></a>01178       library_dirs = [<span class="stringliteral">'/LIBPATH:'</span> + QuoteShellArgument(self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#3770e8a9cc0f198dbc8344cbf6347c22">GypPathToNinja</a>(l),
<a name="l01179"></a>01179                                                        self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a>)
<a name="l01180"></a>01180                       <span class="keywordflow">for</span> l <span class="keywordflow">in</span> library_dirs]
<a name="l01181"></a>01181     <span class="keywordflow">else</span>:
<a name="l01182"></a>01182       library_dirs = [QuoteShellArgument(<span class="stringliteral">'-L'</span> + self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#3770e8a9cc0f198dbc8344cbf6347c22">GypPathToNinja</a>(l),
<a name="l01183"></a>01183                                          self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a>)
<a name="l01184"></a>01184                       <span class="keywordflow">for</span> l <span class="keywordflow">in</span> library_dirs]
<a name="l01185"></a>01185 
<a name="l01186"></a>01186     libraries = gyp.common.uniquer(map(self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#eca47f2b3a42089c33330749acfd861a">ExpandSpecial</a>,
<a name="l01187"></a>01187                                        spec.get(<span class="stringliteral">'libraries'</span>, [])))
<a name="l01188"></a>01188     <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'mac'</span>:
<a name="l01189"></a>01189       libraries = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>.AdjustLibraries(libraries, config_name)
<a name="l01190"></a>01190     <span class="keywordflow">elif</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'win'</span>:
<a name="l01191"></a>01191       libraries = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#05976cc272fa4d277ce291f093ca63be">msvs_settings</a>.AdjustLibraries(libraries)
<a name="l01192"></a>01192 
<a name="l01193"></a>01193     self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#dbfa62b2ae38fae55f305dc092883b7c">WriteVariableList</a>(ninja_file, <span class="stringliteral">'libs'</span>, library_dirs + libraries)
<a name="l01194"></a>01194 
<a name="l01195"></a>01195     linked_binary = output
<a name="l01196"></a>01196 
<a name="l01197"></a>01197     <span class="keywordflow">if</span> command <span class="keywordflow">in</span> (<span class="stringliteral">'solink'</span>, <span class="stringliteral">'solink_module'</span>):
<a name="l01198"></a>01198       extra_bindings.append((<span class="stringliteral">'soname'</span>, os.path.split(output)[1]))
<a name="l01199"></a>01199       extra_bindings.append((<span class="stringliteral">'lib'</span>,
<a name="l01200"></a>01200                             gyp.common.EncodePOSIXShellArgument(output)))
<a name="l01201"></a>01201       <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> != <span class="stringliteral">'win'</span>:
<a name="l01202"></a>01202         link_file_list = output
<a name="l01203"></a>01203         <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#e9044354be1c8bc6f5f25fc45ec6f5df">is_mac_bundle</a>:
<a name="l01204"></a>01204           <span class="comment"># 'Dependency Framework.framework/Versions/A/Dependency Framework' -&gt;</span>
<a name="l01205"></a>01205           <span class="comment"># 'Dependency Framework.framework.rsp'</span>
<a name="l01206"></a>01206           link_file_list = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>.GetWrapperName()
<a name="l01207"></a>01207         <span class="keywordflow">if</span> arch:
<a name="l01208"></a>01208           link_file_list += <span class="stringliteral">'.'</span> + arch
<a name="l01209"></a>01209         link_file_list += <span class="stringliteral">'.rsp'</span>
<a name="l01210"></a>01210         <span class="comment"># If an rspfile contains spaces, ninja surrounds the filename with</span>
<a name="l01211"></a>01211         <span class="comment"># quotes around it and then passes it to open(), creating a file with</span>
<a name="l01212"></a>01212         <span class="comment"># quotes in its name (and when looking for the rsp file, the name</span>
<a name="l01213"></a>01213         <span class="comment"># makes it through bash which strips the quotes) :-/</span>
<a name="l01214"></a>01214         link_file_list = link_file_list.replace(<span class="stringliteral">' '</span>, <span class="stringliteral">'_'</span>)
<a name="l01215"></a>01215         extra_bindings.append(
<a name="l01216"></a>01216           (<span class="stringliteral">'link_file_list'</span>,
<a name="l01217"></a>01217             gyp.common.EncodePOSIXShellArgument(link_file_list)))
<a name="l01218"></a>01218       <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'win'</span>:
<a name="l01219"></a>01219         extra_bindings.append((<span class="stringliteral">'binary'</span>, output))
<a name="l01220"></a>01220         <span class="keywordflow">if</span> (<span class="stringliteral">'/NOENTRY'</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> ldflags <span class="keywordflow">and</span>
<a name="l01221"></a>01221             <span class="keywordflow">not</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#05976cc272fa4d277ce291f093ca63be">msvs_settings</a>.GetNoImportLibrary(config_name)):
<a name="l01222"></a>01222           self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>.import_lib = output + <span class="stringliteral">'.lib'</span>
<a name="l01223"></a>01223           extra_bindings.append((<span class="stringliteral">'implibflag'</span>,
<a name="l01224"></a>01224                                  <span class="stringliteral">'/IMPLIB:%s'</span> % self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>.import_lib))
<a name="l01225"></a>01225           pdbname = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#05976cc272fa4d277ce291f093ca63be">msvs_settings</a>.GetPDBName(
<a name="l01226"></a>01226               config_name, self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#eca47f2b3a42089c33330749acfd861a">ExpandSpecial</a>, output + <span class="stringliteral">'.pdb'</span>)
<a name="l01227"></a>01227           output = [output, self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>.import_lib]
<a name="l01228"></a>01228           <span class="keywordflow">if</span> pdbname:
<a name="l01229"></a>01229             output.append(pdbname)
<a name="l01230"></a>01230       <span class="keywordflow">elif</span> <span class="keywordflow">not</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#e9044354be1c8bc6f5f25fc45ec6f5df">is_mac_bundle</a>:
<a name="l01231"></a>01231         output = [output, output + <span class="stringliteral">'.TOC'</span>]
<a name="l01232"></a>01232       <span class="keywordflow">else</span>:
<a name="l01233"></a>01233         command = command + <span class="stringliteral">'_notoc'</span>
<a name="l01234"></a>01234     <span class="keywordflow">elif</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'win'</span>:
<a name="l01235"></a>01235       extra_bindings.append((<span class="stringliteral">'binary'</span>, output))
<a name="l01236"></a>01236       pdbname = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#05976cc272fa4d277ce291f093ca63be">msvs_settings</a>.GetPDBName(
<a name="l01237"></a>01237           config_name, self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#eca47f2b3a42089c33330749acfd861a">ExpandSpecial</a>, output + <span class="stringliteral">'.pdb'</span>)
<a name="l01238"></a>01238       <span class="keywordflow">if</span> pdbname:
<a name="l01239"></a>01239         output = [output, pdbname]
<a name="l01240"></a>01240 
<a name="l01241"></a>01241 
<a name="l01242"></a>01242     <span class="keywordflow">if</span> len(solibs):
<a name="l01243"></a>01243       extra_bindings.append((<span class="stringliteral">'solibs'</span>, gyp.common.EncodePOSIXShellList(solibs)))
<a name="l01244"></a>01244 
<a name="l01245"></a>01245     ninja_file.build(output, command + command_suffix, link_deps,
<a name="l01246"></a>01246                      implicit=list(implicit_deps),
<a name="l01247"></a>01247                      variables=extra_bindings)
<a name="l01248"></a>01248     <span class="keywordflow">return</span> linked_binary
<a name="l01249"></a>01249 
<a name="l01250"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#203d0a7515c00ce74d55f93e632eedfe">01250</a>   <span class="keyword">def </span><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#203d0a7515c00ce74d55f93e632eedfe">WriteTarget</a>(self, spec, config_name, config, link_deps, compile_deps):
<a name="l01251"></a>01251     extra_link_deps = any(self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#459cc34c149ee1fd281ba6c024ca2ce9">target_outputs</a>.get(dep).Linkable()
<a name="l01252"></a>01252                           <span class="keywordflow">for</span> dep <span class="keywordflow">in</span> spec.get(<span class="stringliteral">'dependencies'</span>, [])
<a name="l01253"></a>01253                           <span class="keywordflow">if</span> dep <span class="keywordflow">in</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#459cc34c149ee1fd281ba6c024ca2ce9">target_outputs</a>)
<a name="l01254"></a>01254     <span class="keywordflow">if</span> spec[<span class="stringliteral">'type'</span>] == <span class="stringliteral">'none'</span> <span class="keywordflow">or</span> (<span class="keywordflow">not</span> link_deps <span class="keywordflow">and</span> <span class="keywordflow">not</span> extra_link_deps):
<a name="l01255"></a>01255       <span class="comment"># TODO(evan): don't call this function for 'none' target types, as</span>
<a name="l01256"></a>01256       <span class="comment"># it doesn't do anything, and we fake out a 'binary' with a stamp file.</span>
<a name="l01257"></a>01257       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>.binary = compile_deps
<a name="l01258"></a>01258       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>.type = <span class="stringliteral">'none'</span>
<a name="l01259"></a>01259     <span class="keywordflow">elif</span> spec[<span class="stringliteral">'type'</span>] == <span class="stringliteral">'static_library'</span>:
<a name="l01260"></a>01260       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>.binary = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#097c9e2913bffe213c7a56b1b1508997">ComputeOutput</a>(spec)
<a name="l01261"></a>01261       <span class="keywordflow">if</span> (self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> <span class="keywordflow">not</span> <span class="keywordflow">in</span> (<span class="stringliteral">'mac'</span>, <span class="stringliteral">'openbsd'</span>, <span class="stringliteral">'win'</span>) <span class="keywordflow">and</span> <span class="keywordflow">not</span>
<a name="l01262"></a>01262           self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#33917fd9cc5a5320b45b7f9db0754069">is_standalone_static_library</a>):
<a name="l01263"></a>01263         self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb01ca7812bd411b26f759814e304a4c">ninja</a>.build(self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>.binary, <span class="stringliteral">'alink_thin'</span>, link_deps,
<a name="l01264"></a>01264                          order_only=compile_deps)
<a name="l01265"></a>01265       <span class="keywordflow">else</span>:
<a name="l01266"></a>01266         variables = []
<a name="l01267"></a>01267         <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>:
<a name="l01268"></a>01268           libtool_flags = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>.GetLibtoolflags(config_name)
<a name="l01269"></a>01269           <span class="keywordflow">if</span> libtool_flags:
<a name="l01270"></a>01270             variables.append((<span class="stringliteral">'libtool_flags'</span>, libtool_flags))
<a name="l01271"></a>01271         <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#05976cc272fa4d277ce291f093ca63be">msvs_settings</a>:
<a name="l01272"></a>01272           libflags = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#05976cc272fa4d277ce291f093ca63be">msvs_settings</a>.GetLibFlags(config_name,
<a name="l01273"></a>01273                                                     self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#3770e8a9cc0f198dbc8344cbf6347c22">GypPathToNinja</a>)
<a name="l01274"></a>01274           variables.append((<span class="stringliteral">'libflags'</span>, libflags))
<a name="l01275"></a>01275 
<a name="l01276"></a>01276         <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> != <span class="stringliteral">'mac'</span> <span class="keywordflow">or</span> len(self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#7d813c7e211464aaa8638f46ca90c924">archs</a>) == 1:
<a name="l01277"></a>01277           self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#8557f69b395aa2350fc3adab4a53f548">AppendPostbuildVariable</a>(variables, spec,
<a name="l01278"></a>01278                                        self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>.binary, self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>.binary)
<a name="l01279"></a>01279           self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb01ca7812bd411b26f759814e304a4c">ninja</a>.build(self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>.binary, <span class="stringliteral">'alink'</span>, link_deps,
<a name="l01280"></a>01280                            order_only=compile_deps, variables=variables)
<a name="l01281"></a>01281         <span class="keywordflow">else</span>:
<a name="l01282"></a>01282           inputs = []
<a name="l01283"></a>01283           <span class="keywordflow">for</span> arch <span class="keywordflow">in</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#7d813c7e211464aaa8638f46ca90c924">archs</a>:
<a name="l01284"></a>01284             output = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#097c9e2913bffe213c7a56b1b1508997">ComputeOutput</a>(spec, arch)
<a name="l01285"></a>01285             self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#10945e7b0105fb01395cbbbb07156eb9">arch_subninjas</a>[arch].build(output, <span class="stringliteral">'alink'</span>, link_deps[arch],
<a name="l01286"></a>01286                                             order_only=compile_deps,
<a name="l01287"></a>01287                                             variables=variables)
<a name="l01288"></a>01288             inputs.append(output)
<a name="l01289"></a>01289           <span class="comment"># TODO: It's not clear if libtool_flags should be passed to the alink</span>
<a name="l01290"></a>01290           <span class="comment"># call that combines single-arch .a files into a fat .a file.</span>
<a name="l01291"></a>01291           self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#8557f69b395aa2350fc3adab4a53f548">AppendPostbuildVariable</a>(variables, spec,
<a name="l01292"></a>01292                                        self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>.binary, self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>.binary)
<a name="l01293"></a>01293           self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb01ca7812bd411b26f759814e304a4c">ninja</a>.build(self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>.binary, <span class="stringliteral">'alink'</span>, inputs,
<a name="l01294"></a>01294                            <span class="comment"># FIXME: test proving order_only=compile_deps isn't</span>
<a name="l01295"></a>01295                            <span class="comment"># needed.</span>
<a name="l01296"></a>01296                            variables=variables)
<a name="l01297"></a>01297     <span class="keywordflow">else</span>:
<a name="l01298"></a>01298       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>.binary = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#6faaabf605361cd78d97b1e27fcdb0bd">WriteLink</a>(spec, config_name, config, link_deps)
<a name="l01299"></a>01299     <span class="keywordflow">return</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>.binary
<a name="l01300"></a>01300 
<a name="l01301"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#8db967f4e290bea92df40a4fc361bbf8">01301</a>   <span class="keyword">def </span><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#8db967f4e290bea92df40a4fc361bbf8">WriteMacBundle</a>(self, spec, mac_bundle_depends, is_empty):
<a name="l01302"></a>01302     <span class="keyword">assert</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#e9044354be1c8bc6f5f25fc45ec6f5df">is_mac_bundle</a>
<a name="l01303"></a>01303     package_framework = spec[<span class="stringliteral">'type'</span>] <span class="keywordflow">in</span> (<span class="stringliteral">'shared_library'</span>, <span class="stringliteral">'loadable_module'</span>)
<a name="l01304"></a>01304     output = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#5696affe1fc78b209b96f47f93e7abb4">ComputeMacBundleOutput</a>()
<a name="l01305"></a>01305     <span class="keywordflow">if</span> is_empty:
<a name="l01306"></a>01306       output += <span class="stringliteral">'.stamp'</span>
<a name="l01307"></a>01307     variables = []
<a name="l01308"></a>01308     self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#8557f69b395aa2350fc3adab4a53f548">AppendPostbuildVariable</a>(variables, spec, output, self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>.binary,
<a name="l01309"></a>01309                                  is_command_start=<span class="keywordflow">not</span> package_framework)
<a name="l01310"></a>01310     <span class="keywordflow">if</span> package_framework <span class="keywordflow">and</span> <span class="keywordflow">not</span> is_empty:
<a name="l01311"></a>01311       variables.append((<span class="stringliteral">'version'</span>, self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>.GetFrameworkVersion()))
<a name="l01312"></a>01312       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb01ca7812bd411b26f759814e304a4c">ninja</a>.build(output, <span class="stringliteral">'package_framework'</span>, mac_bundle_depends,
<a name="l01313"></a>01313                        variables=variables)
<a name="l01314"></a>01314     <span class="keywordflow">else</span>:
<a name="l01315"></a>01315       self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb01ca7812bd411b26f759814e304a4c">ninja</a>.build(output, <span class="stringliteral">'stamp'</span>, mac_bundle_depends,
<a name="l01316"></a>01316                        variables=variables)
<a name="l01317"></a>01317     self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>.bundle = output
<a name="l01318"></a>01318     <span class="keywordflow">return</span> output
<a name="l01319"></a>01319 
<a name="l01320"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#e915b7f19b39ed5ef63ee70b7b5eb298">01320</a>   <span class="keyword">def </span><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#e915b7f19b39ed5ef63ee70b7b5eb298">GetToolchainEnv</a>(self, additional_settings=None):
<a name="l01321"></a>01321     <span class="stringliteral">"""Returns the variables toolchain would set for build steps."""</span>
<a name="l01322"></a>01322     env = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#1e807b9147c1af2adaa10b07e93b51a4">GetSortedXcodeEnv</a>(additional_settings=additional_settings)
<a name="l01323"></a>01323     <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'win'</span>:
<a name="l01324"></a>01324       env = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#3c85d938f659740bdc88af008ec5bc50">GetMsvsToolchainEnv</a>(
<a name="l01325"></a>01325           additional_settings=additional_settings)
<a name="l01326"></a>01326     <span class="keywordflow">return</span> env
<a name="l01327"></a>01327 
<a name="l01328"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#3c85d938f659740bdc88af008ec5bc50">01328</a>   <span class="keyword">def </span><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#3c85d938f659740bdc88af008ec5bc50">GetMsvsToolchainEnv</a>(self, additional_settings=None):
<a name="l01329"></a>01329     <span class="stringliteral">"""Returns the variables Visual Studio would set for build steps."""</span>
<a name="l01330"></a>01330     <span class="keywordflow">return</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#05976cc272fa4d277ce291f093ca63be">msvs_settings</a>.GetVSMacroEnv(<span class="stringliteral">'$!PRODUCT_DIR'</span>,
<a name="l01331"></a>01331                                              config=self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#72c8aa1d973690508a559237475202c6">config_name</a>)
<a name="l01332"></a>01332 
<a name="l01333"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#1e807b9147c1af2adaa10b07e93b51a4">01333</a>   <span class="keyword">def </span><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#1e807b9147c1af2adaa10b07e93b51a4">GetSortedXcodeEnv</a>(self, additional_settings=None):
<a name="l01334"></a>01334     <span class="stringliteral">"""Returns the variables Xcode would set for build steps."""</span>
<a name="l01335"></a>01335     <span class="keyword">assert</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#d453fd01340f10261a7525e604aba57d">abs_build_dir</a>
<a name="l01336"></a>01336     abs_build_dir = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#d453fd01340f10261a7525e604aba57d">abs_build_dir</a>
<a name="l01337"></a>01337     <span class="keywordflow">return</span> gyp.xcode_emulation.GetSortedXcodeEnv(
<a name="l01338"></a>01338         self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>, abs_build_dir,
<a name="l01339"></a>01339         os.path.join(abs_build_dir, self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#8ded59d104c76d6be39fa117857b506a">build_to_base</a>), self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#72c8aa1d973690508a559237475202c6">config_name</a>,
<a name="l01340"></a>01340         additional_settings)
<a name="l01341"></a>01341 
<a name="l01342"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#b16a12808d09d8e1714e7d9aca9f4819">01342</a>   <span class="keyword">def </span><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#b16a12808d09d8e1714e7d9aca9f4819">GetSortedXcodePostbuildEnv</a>(self):
<a name="l01343"></a>01343     <span class="stringliteral">"""Returns the variables Xcode would set for postbuild steps."""</span>
<a name="l01344"></a>01344     postbuild_settings = {}
<a name="l01345"></a>01345     <span class="comment"># CHROMIUM_STRIP_SAVE_FILE is a chromium-specific hack.</span>
<a name="l01346"></a>01346     <span class="comment"># TODO(thakis): It would be nice to have some general mechanism instead.</span>
<a name="l01347"></a>01347     strip_save_file = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>.GetPerTargetSetting(
<a name="l01348"></a>01348         <span class="stringliteral">'CHROMIUM_STRIP_SAVE_FILE'</span>)
<a name="l01349"></a>01349     <span class="keywordflow">if</span> strip_save_file:
<a name="l01350"></a>01350       postbuild_settings[<span class="stringliteral">'CHROMIUM_STRIP_SAVE_FILE'</span>] = strip_save_file
<a name="l01351"></a>01351     <span class="keywordflow">return</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#1e807b9147c1af2adaa10b07e93b51a4">GetSortedXcodeEnv</a>(additional_settings=postbuild_settings)
<a name="l01352"></a>01352 
<a name="l01353"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#8557f69b395aa2350fc3adab4a53f548">01353</a>   <span class="keyword">def </span><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#8557f69b395aa2350fc3adab4a53f548">AppendPostbuildVariable</a>(self, variables, spec, output, binary,
<a name="l01354"></a>01354                               is_command_start=<span class="keyword">False</span>):
<a name="l01355"></a>01355     <span class="stringliteral">"""Adds a 'postbuild' variable if there is a postbuild for |output|."""</span>
<a name="l01356"></a>01356     postbuild = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#2ccb177b64e5d0fe9ece66778590db97">GetPostbuildCommand</a>(spec, output, binary, is_command_start)
<a name="l01357"></a>01357     <span class="keywordflow">if</span> postbuild:
<a name="l01358"></a>01358       variables.append((<span class="stringliteral">'postbuilds'</span>, postbuild))
<a name="l01359"></a>01359 
<a name="l01360"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#2ccb177b64e5d0fe9ece66778590db97">01360</a>   <span class="keyword">def </span><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#2ccb177b64e5d0fe9ece66778590db97">GetPostbuildCommand</a>(self, spec, output, output_binary, is_command_start):
<a name="l01361"></a>01361     <span class="stringliteral">"""Returns a shell command that runs all the postbuilds, and removes</span>
<a name="l01362"></a>01362 <span class="stringliteral">    |output| if any of them fails. If |is_command_start| is False, then the</span>
<a name="l01363"></a>01363 <span class="stringliteral">    returned string will start with ' &amp;&amp; '."""</span>
<a name="l01364"></a>01364     <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a> <span class="keywordflow">or</span> spec[<span class="stringliteral">'type'</span>] == <span class="stringliteral">'none'</span> <span class="keywordflow">or</span> <span class="keywordflow">not</span> output:
<a name="l01365"></a>01365       <span class="keywordflow">return</span> <span class="stringliteral">''</span>
<a name="l01366"></a>01366     output = QuoteShellArgument(output, self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a>)
<a name="l01367"></a>01367     postbuilds = gyp.xcode_emulation.GetSpecPostbuildCommands(spec, quiet=<span class="keyword">True</span>)
<a name="l01368"></a>01368     <span class="keywordflow">if</span> output_binary <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:
<a name="l01369"></a>01369       postbuilds = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>.AddImplicitPostbuilds(
<a name="l01370"></a>01370           self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#72c8aa1d973690508a559237475202c6">config_name</a>,
<a name="l01371"></a>01371           os.path.normpath(os.path.join(self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#f58e3265fc7bfc95156adcf21ffc7220">base_to_build</a>, output)),
<a name="l01372"></a>01372           QuoteShellArgument(
<a name="l01373"></a>01373               os.path.normpath(os.path.join(self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#f58e3265fc7bfc95156adcf21ffc7220">base_to_build</a>, output_binary)),
<a name="l01374"></a>01374               self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a>),
<a name="l01375"></a>01375           postbuilds, quiet=<span class="keyword">True</span>)
<a name="l01376"></a>01376 
<a name="l01377"></a>01377     <span class="keywordflow">if</span> <span class="keywordflow">not</span> postbuilds:
<a name="l01378"></a>01378       <span class="keywordflow">return</span> <span class="stringliteral">''</span>
<a name="l01379"></a>01379     <span class="comment"># Postbuilds expect to be run in the gyp file's directory, so insert an</span>
<a name="l01380"></a>01380     <span class="comment"># implicit postbuild to cd to there.</span>
<a name="l01381"></a>01381     postbuilds.insert(0, gyp.common.EncodePOSIXShellList(
<a name="l01382"></a>01382         [<span class="stringliteral">'cd'</span>, self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#8ded59d104c76d6be39fa117857b506a">build_to_base</a>]))
<a name="l01383"></a>01383     env = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#5c80e468c41533421d0e2d31a6a7e556">ComputeExportEnvString</a>(self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#b16a12808d09d8e1714e7d9aca9f4819">GetSortedXcodePostbuildEnv</a>())
<a name="l01384"></a>01384     <span class="comment"># G will be non-null if any postbuild fails. Run all postbuilds in a</span>
<a name="l01385"></a>01385     <span class="comment"># subshell.</span>
<a name="l01386"></a>01386     commands = env + <span class="stringliteral">' ('</span> + \
<a name="l01387"></a>01387         <span class="stringliteral">' &amp;&amp; '</span>.join([ninja_syntax.escape(command) <span class="keywordflow">for</span> command <span class="keywordflow">in</span> postbuilds])
<a name="l01388"></a>01388     command_string = (commands + <span class="stringliteral">'); G=$$?; '</span>
<a name="l01389"></a>01389                       <span class="comment"># Remove the final output if any postbuild failed.</span>
<a name="l01390"></a>01390                       <span class="stringliteral">'((exit $$G) || rm -rf %s) '</span> % output + <span class="stringliteral">'&amp;&amp; exit $$G)'</span>)
<a name="l01391"></a>01391     <span class="keywordflow">if</span> is_command_start:
<a name="l01392"></a>01392       <span class="keywordflow">return</span> <span class="stringliteral">'('</span> + command_string + <span class="stringliteral">' &amp;&amp; '</span>
<a name="l01393"></a>01393     <span class="keywordflow">else</span>:
<a name="l01394"></a>01394       <span class="keywordflow">return</span> <span class="stringliteral">'$ &amp;&amp; ('</span> + command_string
<a name="l01395"></a>01395 
<a name="l01396"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#5c80e468c41533421d0e2d31a6a7e556">01396</a>   <span class="keyword">def </span><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#5c80e468c41533421d0e2d31a6a7e556">ComputeExportEnvString</a>(self, env):
<a name="l01397"></a>01397     <span class="stringliteral">"""Given an environment, returns a string looking like</span>
<a name="l01398"></a>01398 <span class="stringliteral">        'export FOO=foo; export BAR="${FOO} bar;'</span>
<a name="l01399"></a>01399 <span class="stringliteral">    that exports |env| to the shell."""</span>
<a name="l01400"></a>01400     export_str = []
<a name="l01401"></a>01401     <span class="keywordflow">for</span> k, v <span class="keywordflow">in</span> env:
<a name="l01402"></a>01402       export_str.append(<span class="stringliteral">'export %s=%s;'</span> %
<a name="l01403"></a>01403           (k, ninja_syntax.escape(gyp.common.EncodePOSIXShellArgument(v))))
<a name="l01404"></a>01404     <span class="keywordflow">return</span> <span class="stringliteral">' '</span>.join(export_str)
<a name="l01405"></a>01405 
<a name="l01406"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#5696affe1fc78b209b96f47f93e7abb4">01406</a>   <span class="keyword">def </span><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#5696affe1fc78b209b96f47f93e7abb4">ComputeMacBundleOutput</a>(self):
<a name="l01407"></a>01407     <span class="stringliteral">"""Return the 'output' (full output path) to a bundle output directory."""</span>
<a name="l01408"></a>01408     <span class="keyword">assert</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#e9044354be1c8bc6f5f25fc45ec6f5df">is_mac_bundle</a>
<a name="l01409"></a>01409     path = generator_default_variables[<span class="stringliteral">'PRODUCT_DIR'</span>]
<a name="l01410"></a>01410     <span class="keywordflow">return</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#eca47f2b3a42089c33330749acfd861a">ExpandSpecial</a>(
<a name="l01411"></a>01411         os.path.join(path, self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>.GetWrapperName()))
<a name="l01412"></a>01412 
<a name="l01413"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#8d27eba1b7eef06cada06481b523ba94">01413</a>   <span class="keyword">def </span><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#8d27eba1b7eef06cada06481b523ba94">ComputeOutputFileName</a>(self, spec, type=None):
<a name="l01414"></a>01414     <span class="stringliteral">"""Compute the filename of the final output for the current target."""</span>
<a name="l01415"></a>01415     <span class="keywordflow">if</span> <span class="keywordflow">not</span> type:
<a name="l01416"></a>01416       type = spec[<span class="stringliteral">'type'</span>]
<a name="l01417"></a>01417 
<a name="l01418"></a>01418     default_variables = copy.copy(generator_default_variables)
<a name="l01419"></a>01419     CalculateVariables(default_variables, {<span class="stringliteral">'flavor'</span>: self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a>})
<a name="l01420"></a>01420 
<a name="l01421"></a>01421     <span class="comment"># Compute filename prefix: the product prefix, or a default for</span>
<a name="l01422"></a>01422     <span class="comment"># the product type.</span>
<a name="l01423"></a>01423     DEFAULT_PREFIX = {
<a name="l01424"></a>01424       <span class="stringliteral">'loadable_module'</span>: default_variables[<span class="stringliteral">'SHARED_LIB_PREFIX'</span>],
<a name="l01425"></a>01425       <span class="stringliteral">'shared_library'</span>: default_variables[<span class="stringliteral">'SHARED_LIB_PREFIX'</span>],
<a name="l01426"></a>01426       <span class="stringliteral">'static_library'</span>: default_variables[<span class="stringliteral">'STATIC_LIB_PREFIX'</span>],
<a name="l01427"></a>01427       <span class="stringliteral">'executable'</span>: default_variables[<span class="stringliteral">'EXECUTABLE_PREFIX'</span>],
<a name="l01428"></a>01428       }
<a name="l01429"></a>01429     prefix = spec.get(<span class="stringliteral">'product_prefix'</span>, DEFAULT_PREFIX.get(type, <span class="stringliteral">''</span>))
<a name="l01430"></a>01430 
<a name="l01431"></a>01431     <span class="comment"># Compute filename extension: the product extension, or a default</span>
<a name="l01432"></a>01432     <span class="comment"># for the product type.</span>
<a name="l01433"></a>01433     DEFAULT_EXTENSION = {
<a name="l01434"></a>01434         <span class="stringliteral">'loadable_module'</span>: default_variables[<span class="stringliteral">'SHARED_LIB_SUFFIX'</span>],
<a name="l01435"></a>01435         <span class="stringliteral">'shared_library'</span>: default_variables[<span class="stringliteral">'SHARED_LIB_SUFFIX'</span>],
<a name="l01436"></a>01436         <span class="stringliteral">'static_library'</span>: default_variables[<span class="stringliteral">'STATIC_LIB_SUFFIX'</span>],
<a name="l01437"></a>01437         <span class="stringliteral">'executable'</span>: default_variables[<span class="stringliteral">'EXECUTABLE_SUFFIX'</span>],
<a name="l01438"></a>01438       }
<a name="l01439"></a>01439     extension = spec.get(<span class="stringliteral">'product_extension'</span>)
<a name="l01440"></a>01440     <span class="keywordflow">if</span> extension:
<a name="l01441"></a>01441       extension = <span class="stringliteral">'.'</span> + extension
<a name="l01442"></a>01442     <span class="keywordflow">else</span>:
<a name="l01443"></a>01443       extension = DEFAULT_EXTENSION.get(type, <span class="stringliteral">''</span>)
<a name="l01444"></a>01444 
<a name="l01445"></a>01445     <span class="keywordflow">if</span> <span class="stringliteral">'product_name'</span> <span class="keywordflow">in</span> spec:
<a name="l01446"></a>01446       <span class="comment"># If we were given an explicit name, use that.</span>
<a name="l01447"></a>01447       target = spec[<span class="stringliteral">'product_name'</span>]
<a name="l01448"></a>01448     <span class="keywordflow">else</span>:
<a name="l01449"></a>01449       <span class="comment"># Otherwise, derive a name from the target name.</span>
<a name="l01450"></a>01450       target = spec[<span class="stringliteral">'target_name'</span>]
<a name="l01451"></a>01451       <span class="keywordflow">if</span> prefix == <span class="stringliteral">'lib'</span>:
<a name="l01452"></a>01452         <span class="comment"># Snip out an extra 'lib' from libs if appropriate.</span>
<a name="l01453"></a>01453         target = StripPrefix(target, <span class="stringliteral">'lib'</span>)
<a name="l01454"></a>01454 
<a name="l01455"></a>01455     <span class="keywordflow">if</span> type <span class="keywordflow">in</span> (<span class="stringliteral">'static_library'</span>, <span class="stringliteral">'loadable_module'</span>, <span class="stringliteral">'shared_library'</span>,
<a name="l01456"></a>01456                         <span class="stringliteral">'executable'</span>):
<a name="l01457"></a>01457       <span class="keywordflow">return</span> <span class="stringliteral">'%s%s%s'</span> % (prefix, target, extension)
<a name="l01458"></a>01458     <span class="keywordflow">elif</span> type == <span class="stringliteral">'none'</span>:
<a name="l01459"></a>01459       <span class="keywordflow">return</span> <span class="stringliteral">'%s.stamp'</span> % target
<a name="l01460"></a>01460     <span class="keywordflow">else</span>:
<a name="l01461"></a>01461       <span class="keywordflow">raise</span> Exception(<span class="stringliteral">'Unhandled output type %s'</span> % type)
<a name="l01462"></a>01462 
<a name="l01463"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#097c9e2913bffe213c7a56b1b1508997">01463</a>   <span class="keyword">def </span><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#097c9e2913bffe213c7a56b1b1508997">ComputeOutput</a>(self, spec, arch=None):
<a name="l01464"></a>01464     <span class="stringliteral">"""Compute the path for the final output of the spec."""</span>
<a name="l01465"></a>01465     type = spec[<span class="stringliteral">'type'</span>]
<a name="l01466"></a>01466 
<a name="l01467"></a>01467     <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'win'</span>:
<a name="l01468"></a>01468       override = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#05976cc272fa4d277ce291f093ca63be">msvs_settings</a>.GetOutputName(self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#72c8aa1d973690508a559237475202c6">config_name</a>,
<a name="l01469"></a>01469                                                   self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#eca47f2b3a42089c33330749acfd861a">ExpandSpecial</a>)
<a name="l01470"></a>01470       <span class="keywordflow">if</span> override:
<a name="l01471"></a>01471         <span class="keywordflow">return</span> override
<a name="l01472"></a>01472 
<a name="l01473"></a>01473     <span class="keywordflow">if</span> arch <span class="keywordflow">is</span> <span class="keywordtype">None</span> <span class="keywordflow">and</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'mac'</span> <span class="keywordflow">and</span> type <span class="keywordflow">in</span> (
<a name="l01474"></a>01474         <span class="stringliteral">'static_library'</span>, <span class="stringliteral">'executable'</span>, <span class="stringliteral">'shared_library'</span>, <span class="stringliteral">'loadable_module'</span>):
<a name="l01475"></a>01475       filename = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>.GetExecutablePath()
<a name="l01476"></a>01476     <span class="keywordflow">else</span>:
<a name="l01477"></a>01477       filename = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#8d27eba1b7eef06cada06481b523ba94">ComputeOutputFileName</a>(spec, type)
<a name="l01478"></a>01478 
<a name="l01479"></a>01479     <span class="keywordflow">if</span> arch <span class="keywordflow">is</span> <span class="keywordtype">None</span> <span class="keywordflow">and</span> <span class="stringliteral">'product_dir'</span> <span class="keywordflow">in</span> spec:
<a name="l01480"></a>01480       path = os.path.join(spec[<span class="stringliteral">'product_dir'</span>], filename)
<a name="l01481"></a>01481       <span class="keywordflow">return</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#eca47f2b3a42089c33330749acfd861a">ExpandSpecial</a>(path)
<a name="l01482"></a>01482 
<a name="l01483"></a>01483     <span class="comment"># Some products go into the output root, libraries go into shared library</span>
<a name="l01484"></a>01484     <span class="comment"># dir, and everything else goes into the normal place.</span>
<a name="l01485"></a>01485     type_in_output_root = [<span class="stringliteral">'executable'</span>, <span class="stringliteral">'loadable_module'</span>]
<a name="l01486"></a>01486     <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'mac'</span> <span class="keywordflow">and</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">toolset</a> == <span class="stringliteral">'target'</span>:
<a name="l01487"></a>01487       type_in_output_root += [<span class="stringliteral">'shared_library'</span>, <span class="stringliteral">'static_library'</span>]
<a name="l01488"></a>01488     <span class="keywordflow">elif</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'win'</span> <span class="keywordflow">and</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">toolset</a> == <span class="stringliteral">'target'</span>:
<a name="l01489"></a>01489       type_in_output_root += [<span class="stringliteral">'shared_library'</span>]
<a name="l01490"></a>01490 
<a name="l01491"></a>01491     <span class="keywordflow">if</span> arch <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:
<a name="l01492"></a>01492       <span class="comment"># Make sure partial executables don't end up in a bundle or the regular</span>
<a name="l01493"></a>01493       <span class="comment"># output directory.</span>
<a name="l01494"></a>01494       archdir = <span class="stringliteral">'arch'</span>
<a name="l01495"></a>01495       <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">toolset</a> != <span class="stringliteral">'target'</span>:
<a name="l01496"></a>01496         archdir = os.path.join(<span class="stringliteral">'arch'</span>, <span class="stringliteral">'%s'</span> % self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">toolset</a>)
<a name="l01497"></a>01497       <span class="keywordflow">return</span> os.path.join(archdir, AddArch(filename, arch))
<a name="l01498"></a>01498     <span class="keywordflow">elif</span> type <span class="keywordflow">in</span> type_in_output_root <span class="keywordflow">or</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#33917fd9cc5a5320b45b7f9db0754069">is_standalone_static_library</a>:
<a name="l01499"></a>01499       <span class="keywordflow">return</span> filename
<a name="l01500"></a>01500     <span class="keywordflow">elif</span> type == <span class="stringliteral">'shared_library'</span>:
<a name="l01501"></a>01501       libdir = <span class="stringliteral">'lib'</span>
<a name="l01502"></a>01502       <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">toolset</a> != <span class="stringliteral">'target'</span>:
<a name="l01503"></a>01503         libdir = os.path.join(<span class="stringliteral">'lib'</span>, <span class="stringliteral">'%s'</span> % self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">toolset</a>)
<a name="l01504"></a>01504       <span class="keywordflow">return</span> os.path.join(libdir, filename)
<a name="l01505"></a>01505     <span class="keywordflow">else</span>:
<a name="l01506"></a>01506       <span class="keywordflow">return</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#1a32eebd8c4ae6c6c2eb0db303f1952b">GypPathToUniqueOutput</a>(filename, qualified=<span class="keyword">False</span>)
<a name="l01507"></a>01507 
<a name="l01508"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#dbfa62b2ae38fae55f305dc092883b7c">01508</a>   <span class="keyword">def </span><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#dbfa62b2ae38fae55f305dc092883b7c">WriteVariableList</a>(self, ninja_file, var, values):
<a name="l01509"></a>01509     <span class="keyword">assert</span> <span class="keywordflow">not</span> isinstance(values, str)
<a name="l01510"></a>01510     <span class="keywordflow">if</span> values <span class="keywordflow">is</span> <span class="keywordtype">None</span>:
<a name="l01511"></a>01511       values = []
<a name="l01512"></a>01512     ninja_file.variable(var, <span class="stringliteral">' '</span>.join(values))
<a name="l01513"></a>01513 
<a name="l01514"></a><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#77fe4ecde866f09e6655f71a91596b48">01514</a>   <span class="keyword">def </span><a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#77fe4ecde866f09e6655f71a91596b48">WriteNewNinjaRule</a>(self, name, args, description, is_cygwin, env, pool,
<a name="l01515"></a>01515                         depfile=<span class="keywordtype">None</span>):
<a name="l01516"></a>01516     <span class="stringliteral">"""Write out a new ninja "rule" statement for a given command.</span>
<a name="l01517"></a>01517 <span class="stringliteral"></span>
<a name="l01518"></a>01518 <span class="stringliteral">    Returns the name of the new rule, and a copy of |args| with variables</span>
<a name="l01519"></a>01519 <span class="stringliteral">    expanded."""</span>
<a name="l01520"></a>01520 
<a name="l01521"></a>01521     <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'win'</span>:
<a name="l01522"></a>01522       args = [self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#05976cc272fa4d277ce291f093ca63be">msvs_settings</a>.ConvertVSMacros(
<a name="l01523"></a>01523                   arg, self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#f58e3265fc7bfc95156adcf21ffc7220">base_to_build</a>, config=self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#72c8aa1d973690508a559237475202c6">config_name</a>)
<a name="l01524"></a>01524               <span class="keywordflow">for</span> arg <span class="keywordflow">in</span> args]
<a name="l01525"></a>01525       description = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#05976cc272fa4d277ce291f093ca63be">msvs_settings</a>.ConvertVSMacros(
<a name="l01526"></a>01526           description, config=self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#72c8aa1d973690508a559237475202c6">config_name</a>)
<a name="l01527"></a>01527     <span class="keywordflow">elif</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'mac'</span>:
<a name="l01528"></a>01528       <span class="comment"># |env| is an empty list on non-mac.</span>
<a name="l01529"></a>01529       args = [gyp.xcode_emulation.ExpandEnvVars(arg, env) <span class="keywordflow">for</span> arg <span class="keywordflow">in</span> args]
<a name="l01530"></a>01530       description = gyp.xcode_emulation.ExpandEnvVars(description, env)
<a name="l01531"></a>01531 
<a name="l01532"></a>01532     <span class="comment"># TODO: we shouldn't need to qualify names; we do it because</span>
<a name="l01533"></a>01533     <span class="comment"># currently the ninja rule namespace is global, but it really</span>
<a name="l01534"></a>01534     <span class="comment"># should be scoped to the subninja.</span>
<a name="l01535"></a>01535     rule_name = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#b74e6bf80237ddc4109968cedc58c151">name</a>
<a name="l01536"></a>01536     <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">toolset</a> == <span class="stringliteral">'target'</span>:
<a name="l01537"></a>01537       rule_name += <span class="stringliteral">'.'</span> + self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">toolset</a>
<a name="l01538"></a>01538     rule_name += <span class="stringliteral">'.'</span> + name
<a name="l01539"></a>01539     rule_name = re.sub(<span class="stringliteral">'[^a-zA-Z0-9_]'</span>, <span class="stringliteral">'_'</span>, rule_name)
<a name="l01540"></a>01540 
<a name="l01541"></a>01541     <span class="comment"># Remove variable references, but not if they refer to the magic rule</span>
<a name="l01542"></a>01542     <span class="comment"># variables.  This is not quite right, as it also protects these for</span>
<a name="l01543"></a>01543     <span class="comment"># actions, not just for rules where they are valid. Good enough.</span>
<a name="l01544"></a>01544     protect = [ <span class="stringliteral">'${root}'</span>, <span class="stringliteral">'${dirname}'</span>, <span class="stringliteral">'${source}'</span>, <span class="stringliteral">'${ext}'</span>, <span class="stringliteral">'${name}'</span> ]
<a name="l01545"></a>01545     protect = <span class="stringliteral">'(?!'</span> + <span class="stringliteral">'|'</span>.join(map(re.escape, protect)) + <span class="stringliteral">')'</span>
<a name="l01546"></a>01546     description = re.sub(protect + <span class="stringliteral">r'\$'</span>, <span class="stringliteral">'_'</span>, description)
<a name="l01547"></a>01547 
<a name="l01548"></a>01548     <span class="comment"># gyp dictates that commands are run from the base directory.</span>
<a name="l01549"></a>01549     <span class="comment"># cd into the directory before running, and adjust paths in</span>
<a name="l01550"></a>01550     <span class="comment"># the arguments to point to the proper locations.</span>
<a name="l01551"></a>01551     rspfile = <span class="keywordtype">None</span>
<a name="l01552"></a>01552     rspfile_content = <span class="keywordtype">None</span>
<a name="l01553"></a>01553     args = [self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#eca47f2b3a42089c33330749acfd861a">ExpandSpecial</a>(arg, self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#f58e3265fc7bfc95156adcf21ffc7220">base_to_build</a>) <span class="keywordflow">for</span> arg <span class="keywordflow">in</span> args]
<a name="l01554"></a>01554     <span class="keywordflow">if</span> self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'win'</span>:
<a name="l01555"></a>01555       rspfile = rule_name + <span class="stringliteral">'.$unique_name.rsp'</span>
<a name="l01556"></a>01556       <span class="comment"># The cygwin case handles this inside the bash sub-shell.</span>
<a name="l01557"></a>01557       run_in = <span class="stringliteral">''</span> <span class="keywordflow">if</span> is_cygwin <span class="keywordflow">else</span> <span class="stringliteral">' '</span> + self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#8ded59d104c76d6be39fa117857b506a">build_to_base</a>
<a name="l01558"></a>01558       <span class="keywordflow">if</span> is_cygwin:
<a name="l01559"></a>01559         rspfile_content = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#05976cc272fa4d277ce291f093ca63be">msvs_settings</a>.BuildCygwinBashCommandLine(
<a name="l01560"></a>01560             args, self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#8ded59d104c76d6be39fa117857b506a">build_to_base</a>)
<a name="l01561"></a>01561       <span class="keywordflow">else</span>:
<a name="l01562"></a>01562         rspfile_content = gyp.msvs_emulation.EncodeRspFileList(args)
<a name="l01563"></a>01563       command = (<span class="stringliteral">'%s gyp-win-tool action-wrapper $arch '</span> % sys.executable +
<a name="l01564"></a>01564                  rspfile + run_in)
<a name="l01565"></a>01565     <span class="keywordflow">else</span>:
<a name="l01566"></a>01566       env = self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#5c80e468c41533421d0e2d31a6a7e556">ComputeExportEnvString</a>(env)
<a name="l01567"></a>01567       command = gyp.common.EncodePOSIXShellList(args)
<a name="l01568"></a>01568       command = <span class="stringliteral">'cd %s; '</span> % self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#8ded59d104c76d6be39fa117857b506a">build_to_base</a> + env + command
<a name="l01569"></a>01569 
<a name="l01570"></a>01570     <span class="comment"># GYP rules/actions express being no-ops by not touching their outputs.</span>
<a name="l01571"></a>01571     <span class="comment"># Avoid executing downstream dependencies in this case by specifying</span>
<a name="l01572"></a>01572     <span class="comment"># restat=1 to ninja.</span>
<a name="l01573"></a>01573     self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb01ca7812bd411b26f759814e304a4c">ninja</a>.rule(rule_name, command, description, depfile=depfile,
<a name="l01574"></a>01574                     restat=<span class="keyword">True</span>, pool=pool,
<a name="l01575"></a>01575                     rspfile=rspfile, rspfile_content=rspfile_content)
<a name="l01576"></a>01576     self.<a class="code" href="../../db/d1c/classgyp_1_1generator_1_1ninja_1_1_ninja_writer.html#cb01ca7812bd411b26f759814e304a4c">ninja</a>.newline()
<a name="l01577"></a>01577 
<a name="l01578"></a>01578     <span class="keywordflow">return</span> rule_name, args
<a name="l01579"></a>01579 
<a name="l01580"></a>01580 
<a name="l01581"></a><a class="code" href="../../dc/d8b/namespacegyp_1_1generator_1_1ninja.html#8ec296cd80ea0b9b4c4e8e466b1f3bfb">01581</a> <span class="keyword">def </span><a class="code" href="../../dc/d8b/namespacegyp_1_1generator_1_1ninja.html#8ec296cd80ea0b9b4c4e8e466b1f3bfb">CalculateVariables</a>(default_variables, params):
<a name="l01582"></a>01582   <span class="stringliteral">"""Calculate additional variables for use in the build (called by gyp)."""</span>
<a name="l01583"></a>01583   <span class="keyword">global</span> generator_additional_non_configuration_keys
<a name="l01584"></a>01584   <span class="keyword">global</span> generator_additional_path_sections
<a name="l01585"></a>01585   flavor = gyp.common.GetFlavor(params)
<a name="l01586"></a>01586   <span class="keywordflow">if</span> flavor == <span class="stringliteral">'mac'</span>:
<a name="l01587"></a>01587     default_variables.setdefault(<span class="stringliteral">'OS'</span>, <span class="stringliteral">'mac'</span>)
<a name="l01588"></a>01588     default_variables.setdefault(<span class="stringliteral">'SHARED_LIB_SUFFIX'</span>, <span class="stringliteral">'.dylib'</span>)
<a name="l01589"></a>01589     default_variables.setdefault(<span class="stringliteral">'SHARED_LIB_DIR'</span>,
<a name="l01590"></a>01590                                  generator_default_variables[<span class="stringliteral">'PRODUCT_DIR'</span>])
<a name="l01591"></a>01591     default_variables.setdefault(<span class="stringliteral">'LIB_DIR'</span>,
<a name="l01592"></a>01592                                  generator_default_variables[<span class="stringliteral">'PRODUCT_DIR'</span>])
<a name="l01593"></a>01593 
<a name="l01594"></a>01594     <span class="comment"># Copy additional generator configuration data from Xcode, which is shared</span>
<a name="l01595"></a>01595     <span class="comment"># by the Mac Ninja generator.</span>
<a name="l01596"></a>01596     <span class="keyword">import</span> gyp.generator.xcode <span class="keyword">as</span> xcode_generator
<a name="l01597"></a>01597     generator_additional_non_configuration_keys = getattr(xcode_generator,
<a name="l01598"></a>01598         <span class="stringliteral">'generator_additional_non_configuration_keys'</span>, [])
<a name="l01599"></a>01599     generator_additional_path_sections = getattr(xcode_generator,
<a name="l01600"></a>01600         <span class="stringliteral">'generator_additional_path_sections'</span>, [])
<a name="l01601"></a>01601     <span class="keyword">global</span> generator_extra_sources_for_rules
<a name="l01602"></a>01602     generator_extra_sources_for_rules = getattr(xcode_generator,
<a name="l01603"></a>01603         <span class="stringliteral">'generator_extra_sources_for_rules'</span>, [])
<a name="l01604"></a>01604   <span class="keywordflow">elif</span> flavor == <span class="stringliteral">'win'</span>:
<a name="l01605"></a>01605     exts = gyp.MSVSUtil.TARGET_TYPE_EXT
<a name="l01606"></a>01606     default_variables.setdefault(<span class="stringliteral">'OS'</span>, <span class="stringliteral">'win'</span>)
<a name="l01607"></a>01607     default_variables[<span class="stringliteral">'EXECUTABLE_SUFFIX'</span>] = <span class="stringliteral">'.'</span> + exts[<span class="stringliteral">'executable'</span>]
<a name="l01608"></a>01608     default_variables[<span class="stringliteral">'STATIC_LIB_PREFIX'</span>] = <span class="stringliteral">''</span>
<a name="l01609"></a>01609     default_variables[<span class="stringliteral">'STATIC_LIB_SUFFIX'</span>] = <span class="stringliteral">'.'</span> + exts[<span class="stringliteral">'static_library'</span>]
<a name="l01610"></a>01610     default_variables[<span class="stringliteral">'SHARED_LIB_PREFIX'</span>] = <span class="stringliteral">''</span>
<a name="l01611"></a>01611     default_variables[<span class="stringliteral">'SHARED_LIB_SUFFIX'</span>] = <span class="stringliteral">'.'</span> + exts[<span class="stringliteral">'shared_library'</span>]
<a name="l01612"></a>01612 
<a name="l01613"></a>01613     <span class="comment"># Copy additional generator configuration data from VS, which is shared</span>
<a name="l01614"></a>01614     <span class="comment"># by the Windows Ninja generator.</span>
<a name="l01615"></a>01615     <span class="keyword">import</span> gyp.generator.msvs <span class="keyword">as</span> msvs_generator
<a name="l01616"></a>01616     generator_additional_non_configuration_keys = getattr(msvs_generator,
<a name="l01617"></a>01617         <span class="stringliteral">'generator_additional_non_configuration_keys'</span>, [])
<a name="l01618"></a>01618     generator_additional_path_sections = getattr(msvs_generator,
<a name="l01619"></a>01619         <span class="stringliteral">'generator_additional_path_sections'</span>, [])
<a name="l01620"></a>01620 
<a name="l01621"></a>01621     gyp.msvs_emulation.CalculateCommonVariables(default_variables, params)
<a name="l01622"></a>01622   <span class="keywordflow">else</span>:
<a name="l01623"></a>01623     operating_system = flavor
<a name="l01624"></a>01624     <span class="keywordflow">if</span> flavor == <span class="stringliteral">'android'</span>:
<a name="l01625"></a>01625       operating_system = <span class="stringliteral">'linux'</span>  <span class="comment"># Keep this legacy behavior for now.</span>
<a name="l01626"></a>01626     default_variables.setdefault(<span class="stringliteral">'OS'</span>, operating_system)
<a name="l01627"></a>01627     default_variables.setdefault(<span class="stringliteral">'SHARED_LIB_SUFFIX'</span>, <span class="stringliteral">'.so'</span>)
<a name="l01628"></a>01628     default_variables.setdefault(<span class="stringliteral">'SHARED_LIB_DIR'</span>,
<a name="l01629"></a>01629                                  os.path.join(<span class="stringliteral">'$!PRODUCT_DIR'</span>, <span class="stringliteral">'lib'</span>))
<a name="l01630"></a>01630     default_variables.setdefault(<span class="stringliteral">'LIB_DIR'</span>,
<a name="l01631"></a>01631                                  os.path.join(<span class="stringliteral">'$!PRODUCT_DIR'</span>, <span class="stringliteral">'obj'</span>))
<a name="l01632"></a>01632 
<a name="l01633"></a><a class="code" href="../../dc/d8b/namespacegyp_1_1generator_1_1ninja.html#fa1f529343d8a0cd2cdb9665a86ee067">01633</a> <span class="keyword">def </span><a class="code" href="../../dc/d8b/namespacegyp_1_1generator_1_1ninja.html#fa1f529343d8a0cd2cdb9665a86ee067">ComputeOutputDir</a>(params):
<a name="l01634"></a>01634   <span class="stringliteral">"""Returns the path from the toplevel_dir to the build output directory."""</span>
<a name="l01635"></a>01635   <span class="comment"># generator_dir: relative path from pwd to where make puts build files.</span>
<a name="l01636"></a>01636   <span class="comment"># Makes migrating from make to ninja easier, ninja doesn't put anything here.</span>
<a name="l01637"></a>01637   generator_dir = os.path.relpath(params[<span class="stringliteral">'options'</span>].generator_output <span class="keywordflow">or</span> <span class="stringliteral">'.'</span>)
<a name="l01638"></a>01638 
<a name="l01639"></a>01639   <span class="comment"># output_dir: relative path from generator_dir to the build directory.</span>
<a name="l01640"></a>01640   output_dir = params.get(<span class="stringliteral">'generator_flags'</span>, {}).get(<span class="stringliteral">'output_dir'</span>, <span class="stringliteral">'out'</span>)
<a name="l01641"></a>01641 
<a name="l01642"></a>01642   <span class="comment"># Relative path from source root to our output files.  e.g. "out"</span>
<a name="l01643"></a>01643   <span class="keywordflow">return</span> os.path.normpath(os.path.join(generator_dir, output_dir))
<a name="l01644"></a>01644 
<a name="l01645"></a>01645 
<a name="l01646"></a><a class="code" href="../../dc/d8b/namespacegyp_1_1generator_1_1ninja.html#f23d993a3b413034fbe0b2a65be80408">01646</a> <span class="keyword">def </span><a class="code" href="../../dc/d8b/namespacegyp_1_1generator_1_1ninja.html#f23d993a3b413034fbe0b2a65be80408">CalculateGeneratorInputInfo</a>(params):
<a name="l01647"></a>01647   <span class="stringliteral">"""Called by __init__ to initialize generator values based on params."""</span>
<a name="l01648"></a>01648   <span class="comment"># E.g. "out/gypfiles"</span>
<a name="l01649"></a>01649   toplevel = params[<span class="stringliteral">'options'</span>].toplevel_dir
<a name="l01650"></a>01650   qualified_out_dir = os.path.normpath(os.path.join(
<a name="l01651"></a>01651       toplevel, ComputeOutputDir(params), <span class="stringliteral">'gypfiles'</span>))
<a name="l01652"></a>01652 
<a name="l01653"></a>01653   <span class="keyword">global</span> generator_filelist_paths
<a name="l01654"></a>01654   generator_filelist_paths = {
<a name="l01655"></a>01655       <span class="stringliteral">'toplevel'</span>: toplevel,
<a name="l01656"></a>01656       <span class="stringliteral">'qualified_out_dir'</span>: qualified_out_dir,
<a name="l01657"></a>01657   }
<a name="l01658"></a>01658 
<a name="l01659"></a>01659 
<a name="l01660"></a><a class="code" href="../../dc/d8b/namespacegyp_1_1generator_1_1ninja.html#af939a56bb51db55e4cdd8e5b3a42d11">01660</a> <span class="keyword">def </span><a class="code" href="../../dc/d8b/namespacegyp_1_1generator_1_1ninja.html#af939a56bb51db55e4cdd8e5b3a42d11">OpenOutput</a>(path, mode='w'):
<a name="l01661"></a>01661   <span class="stringliteral">"""Open |path| for writing, creating directories if necessary."""</span>
<a name="l01662"></a>01662   gyp.common.EnsureDirExists(path)
<a name="l01663"></a>01663   <span class="keywordflow">return</span> open(path, mode)
<a name="l01664"></a>01664 
<a name="l01665"></a>01665 
<a name="l01666"></a><a class="code" href="../../dc/d8b/namespacegyp_1_1generator_1_1ninja.html#f38ae2a59d7f23b71c4611662fb92696">01666</a> <span class="keyword">def </span><a class="code" href="../../dc/d8b/namespacegyp_1_1generator_1_1ninja.html#f38ae2a59d7f23b71c4611662fb92696">CommandWithWrapper</a>(cmd, wrappers, prog):
<a name="l01667"></a>01667   wrapper = wrappers.get(cmd, <span class="stringliteral">''</span>)
<a name="l01668"></a>01668   <span class="keywordflow">if</span> wrapper:
<a name="l01669"></a>01669     <span class="keywordflow">return</span> wrapper + <span class="stringliteral">' '</span> + prog
<a name="l01670"></a>01670   <span class="keywordflow">return</span> prog
<a name="l01671"></a>01671 
<a name="l01672"></a>01672 
<a name="l01673"></a><a class="code" href="../../dc/d8b/namespacegyp_1_1generator_1_1ninja.html#277f7d83b47810d9d672ddcb09a71c02">01673</a> <span class="keyword">def </span><a class="code" href="../../dc/d8b/namespacegyp_1_1generator_1_1ninja.html#277f7d83b47810d9d672ddcb09a71c02">GetDefaultConcurrentLinks</a>():
<a name="l01674"></a>01674   <span class="stringliteral">"""Returns a best-guess for a number of concurrent links."""</span>
<a name="l01675"></a>01675   pool_size = int(os.getenv(<span class="stringliteral">'GYP_LINK_CONCURRENCY'</span>, 0))
<a name="l01676"></a>01676   <span class="keywordflow">if</span> pool_size:
<a name="l01677"></a>01677     <span class="keywordflow">return</span> pool_size
<a name="l01678"></a>01678 
<a name="l01679"></a>01679   <span class="keywordflow">if</span> sys.platform <span class="keywordflow">in</span> (<span class="stringliteral">'win32'</span>, <span class="stringliteral">'cygwin'</span>):
<a name="l01680"></a>01680     <span class="keyword">import</span> ctypes
<a name="l01681"></a>01681 
<a name="l01682"></a>01682     <span class="keyword">class </span>MEMORYSTATUSEX(ctypes.Structure):
<a name="l01683"></a>01683       _fields_ = [
<a name="l01684"></a>01684         (<span class="stringliteral">"dwLength"</span>, ctypes.c_ulong),
<a name="l01685"></a>01685         (<span class="stringliteral">"dwMemoryLoad"</span>, ctypes.c_ulong),
<a name="l01686"></a>01686         (<span class="stringliteral">"ullTotalPhys"</span>, ctypes.c_ulonglong),
<a name="l01687"></a>01687         (<span class="stringliteral">"ullAvailPhys"</span>, ctypes.c_ulonglong),
<a name="l01688"></a>01688         (<span class="stringliteral">"ullTotalPageFile"</span>, ctypes.c_ulonglong),
<a name="l01689"></a>01689         (<span class="stringliteral">"ullAvailPageFile"</span>, ctypes.c_ulonglong),
<a name="l01690"></a>01690         (<span class="stringliteral">"ullTotalVirtual"</span>, ctypes.c_ulonglong),
<a name="l01691"></a>01691         (<span class="stringliteral">"ullAvailVirtual"</span>, ctypes.c_ulonglong),
<a name="l01692"></a>01692         (<span class="stringliteral">"sullAvailExtendedVirtual"</span>, ctypes.c_ulonglong),
<a name="l01693"></a>01693       ]
<a name="l01694"></a>01694 
<a name="l01695"></a>01695     stat = MEMORYSTATUSEX()
<a name="l01696"></a>01696     stat.dwLength = ctypes.sizeof(stat)
<a name="l01697"></a>01697     ctypes.windll.kernel32.GlobalMemoryStatusEx(ctypes.byref(stat))
<a name="l01698"></a>01698 
<a name="l01699"></a>01699     mem_limit = max(1, stat.ullTotalPhys / (4 * (2 ** 30)))  <span class="comment"># total / 4GB</span>
<a name="l01700"></a>01700     hard_cap = max(1, int(os.getenv(<span class="stringliteral">'GYP_LINK_CONCURRENCY_MAX'</span>, 2**32)))
<a name="l01701"></a>01701     <span class="keywordflow">return</span> min(mem_limit, hard_cap)
<a name="l01702"></a>01702   <span class="keywordflow">elif</span> sys.platform.startswith(<span class="stringliteral">'linux'</span>):
<a name="l01703"></a>01703     <span class="keywordflow">if</span> os.path.exists(<span class="stringliteral">"/proc/meminfo"</span>):
<a name="l01704"></a>01704       with open(<span class="stringliteral">"/proc/meminfo"</span>) <span class="keyword">as</span> meminfo:
<a name="l01705"></a>01705         memtotal_re = re.compile(<span class="stringliteral">r'^MemTotal:\s*(\d*)\s*kB'</span>)
<a name="l01706"></a>01706         <span class="keywordflow">for</span> line <span class="keywordflow">in</span> meminfo:
<a name="l01707"></a>01707           match = memtotal_re.match(line)
<a name="l01708"></a>01708           <span class="keywordflow">if</span> <span class="keywordflow">not</span> match:
<a name="l01709"></a>01709             <span class="keywordflow">continue</span>
<a name="l01710"></a>01710           <span class="comment"># Allow 8Gb per link on Linux because Gold is quite memory hungry</span>
<a name="l01711"></a>01711           <span class="keywordflow">return</span> max(1, int(match.group(1)) / (8 * (2 ** 20)))
<a name="l01712"></a>01712     <span class="keywordflow">return</span> 1
<a name="l01713"></a>01713   <span class="keywordflow">elif</span> sys.platform == <span class="stringliteral">'darwin'</span>:
<a name="l01714"></a>01714     <span class="keywordflow">try</span>:
<a name="l01715"></a>01715       avail_bytes = int(subprocess.check_output([<span class="stringliteral">'sysctl'</span>, <span class="stringliteral">'-n'</span>, <span class="stringliteral">'hw.memsize'</span>]))
<a name="l01716"></a>01716       <span class="comment"># A static library debug build of Chromium's unit_tests takes ~2.7GB, so</span>
<a name="l01717"></a>01717       <span class="comment"># 4GB per ld process allows for some more bloat.</span>
<a name="l01718"></a>01718       <span class="keywordflow">return</span> max(1, avail_bytes / (4 * (2 ** 30)))  <span class="comment"># total / 4GB</span>
<a name="l01719"></a>01719     <span class="keywordflow">except</span>:
<a name="l01720"></a>01720       <span class="keywordflow">return</span> 1
<a name="l01721"></a>01721   <span class="keywordflow">else</span>:
<a name="l01722"></a>01722     <span class="comment"># TODO(scottmg): Implement this for other platforms.</span>
<a name="l01723"></a>01723     <span class="keywordflow">return</span> 1
<a name="l01724"></a>01724 
<a name="l01725"></a>01725 
<a name="l01726"></a><a class="code" href="../../dc/d8b/namespacegyp_1_1generator_1_1ninja.html#b87aba4db20886d51c50a7b85ca595a6">01726</a> <span class="keyword">def </span><a class="code" href="../../dc/d8b/namespacegyp_1_1generator_1_1ninja.html#b87aba4db20886d51c50a7b85ca595a6">_GetWinLinkRuleNameSuffix</a>(embed_manifest):
<a name="l01727"></a>01727   <span class="stringliteral">"""Returns the suffix used to select an appropriate linking rule depending on</span>
<a name="l01728"></a>01728 <span class="stringliteral">  whether the manifest embedding is enabled."""</span>
<a name="l01729"></a>01729   <span class="keywordflow">return</span> <span class="stringliteral">'_embed'</span> <span class="keywordflow">if</span> embed_manifest <span class="keywordflow">else</span> <span class="stringliteral">''</span>
<a name="l01730"></a>01730 
<a name="l01731"></a>01731 
<a name="l01732"></a><a class="code" href="../../dc/d8b/namespacegyp_1_1generator_1_1ninja.html#fbeedb92cd1c4d316c919b1ad8a96968">01732</a> <span class="keyword">def </span><a class="code" href="../../dc/d8b/namespacegyp_1_1generator_1_1ninja.html#fbeedb92cd1c4d316c919b1ad8a96968">_AddWinLinkRules</a>(master_ninja, embed_manifest):
<a name="l01733"></a>01733   <span class="stringliteral">"""Adds link rules for Windows platform to |master_ninja|."""</span>
<a name="l01734"></a>01734   <span class="keyword">def </span>FullLinkCommand(ldcmd, out, binary_type):
<a name="l01735"></a>01735     resource_name = {
<a name="l01736"></a>01736       <span class="stringliteral">'exe'</span>: <span class="stringliteral">'1'</span>,
<a name="l01737"></a>01737       <span class="stringliteral">'dll'</span>: <span class="stringliteral">'2'</span>,
<a name="l01738"></a>01738     }[binary_type]
<a name="l01739"></a>01739     <span class="keywordflow">return</span> <span class="stringliteral">'%(python)s gyp-win-tool link-with-manifests $arch %(embed)s '</span> \
<a name="l01740"></a>01740            <span class="stringliteral">'%(out)s "%(ldcmd)s" %(resname)s $mt $rc "$intermediatemanifest" '</span> \
<a name="l01741"></a>01741            <span class="stringliteral">'$manifests'</span> % {
<a name="l01742"></a>01742                <span class="stringliteral">'python'</span>: sys.executable,
<a name="l01743"></a>01743                <span class="stringliteral">'out'</span>: out,
<a name="l01744"></a>01744                <span class="stringliteral">'ldcmd'</span>: ldcmd,
<a name="l01745"></a>01745                <span class="stringliteral">'resname'</span>: resource_name,
<a name="l01746"></a>01746                <span class="stringliteral">'embed'</span>: embed_manifest }
<a name="l01747"></a>01747   rule_name_suffix = _GetWinLinkRuleNameSuffix(embed_manifest)
<a name="l01748"></a>01748   use_separate_mspdbsrv = (
<a name="l01749"></a>01749       int(os.environ.get(<span class="stringliteral">'GYP_USE_SEPARATE_MSPDBSRV'</span>, <span class="stringliteral">'0'</span>)) != 0)
<a name="l01750"></a>01750   dlldesc = <span class="stringliteral">'LINK%s(DLL) $binary'</span> % rule_name_suffix.upper()
<a name="l01751"></a>01751   dllcmd = (<span class="stringliteral">'%s gyp-win-tool link-wrapper $arch %s '</span>
<a name="l01752"></a>01752             <span class="stringliteral">'$ld /nologo $implibflag /DLL /OUT:$binary '</span>
<a name="l01753"></a>01753             <span class="stringliteral">'@$binary.rsp'</span> % (sys.executable, use_separate_mspdbsrv))
<a name="l01754"></a>01754   dllcmd = FullLinkCommand(dllcmd, <span class="stringliteral">'$binary'</span>, <span class="stringliteral">'dll'</span>)
<a name="l01755"></a>01755   master_ninja.rule(<span class="stringliteral">'solink'</span> + rule_name_suffix,
<a name="l01756"></a>01756                     description=dlldesc, command=dllcmd,
<a name="l01757"></a>01757                     rspfile=<span class="stringliteral">'$binary.rsp'</span>,
<a name="l01758"></a>01758                     rspfile_content=<span class="stringliteral">'$libs $in_newline $ldflags'</span>,
<a name="l01759"></a>01759                     restat=<span class="keyword">True</span>,
<a name="l01760"></a>01760                     pool=<span class="stringliteral">'link_pool'</span>)
<a name="l01761"></a>01761   master_ninja.rule(<span class="stringliteral">'solink_module'</span> + rule_name_suffix,
<a name="l01762"></a>01762                     description=dlldesc, command=dllcmd,
<a name="l01763"></a>01763                     rspfile=<span class="stringliteral">'$binary.rsp'</span>,
<a name="l01764"></a>01764                     rspfile_content=<span class="stringliteral">'$libs $in_newline $ldflags'</span>,
<a name="l01765"></a>01765                     restat=<span class="keyword">True</span>,
<a name="l01766"></a>01766                     pool=<span class="stringliteral">'link_pool'</span>)
<a name="l01767"></a>01767   <span class="comment"># Note that ldflags goes at the end so that it has the option of</span>
<a name="l01768"></a>01768   <span class="comment"># overriding default settings earlier in the command line.</span>
<a name="l01769"></a>01769   exe_cmd = (<span class="stringliteral">'%s gyp-win-tool link-wrapper $arch %s '</span>
<a name="l01770"></a>01770              <span class="stringliteral">'$ld /nologo /OUT:$binary @$binary.rsp'</span> %
<a name="l01771"></a>01771               (sys.executable, use_separate_mspdbsrv))
<a name="l01772"></a>01772   exe_cmd = FullLinkCommand(exe_cmd, <span class="stringliteral">'$binary'</span>, <span class="stringliteral">'exe'</span>)
<a name="l01773"></a>01773   master_ninja.rule(<span class="stringliteral">'link'</span> + rule_name_suffix,
<a name="l01774"></a>01774                     description=<span class="stringliteral">'LINK%s $binary'</span> % rule_name_suffix.upper(),
<a name="l01775"></a>01775                     command=exe_cmd,
<a name="l01776"></a>01776                     rspfile=<span class="stringliteral">'$binary.rsp'</span>,
<a name="l01777"></a>01777                     rspfile_content=<span class="stringliteral">'$in_newline $libs $ldflags'</span>,
<a name="l01778"></a>01778                     pool=<span class="stringliteral">'link_pool'</span>)
<a name="l01779"></a>01779 
<a name="l01780"></a>01780 
<a name="l01781"></a><a class="code" href="../../dc/d8b/namespacegyp_1_1generator_1_1ninja.html#b23e4c468c1115aae24dbeebcdab967c">01781</a> <span class="keyword">def </span><a class="code" href="../../dc/d8b/namespacegyp_1_1generator_1_1ninja.html#b23e4c468c1115aae24dbeebcdab967c">GenerateOutputForConfig</a>(target_list, target_dicts, data, params,
<a name="l01782"></a>01782                             config_name):
<a name="l01783"></a>01783   options = params[<span class="stringliteral">'options'</span>]
<a name="l01784"></a>01784   flavor = gyp.common.GetFlavor(params)
<a name="l01785"></a>01785   generator_flags = params.get(<span class="stringliteral">'generator_flags'</span>, {})
<a name="l01786"></a>01786 
<a name="l01787"></a>01787   <span class="comment"># build_dir: relative path from source root to our output files.</span>
<a name="l01788"></a>01788   <span class="comment"># e.g. "out/Debug"</span>
<a name="l01789"></a>01789   build_dir = os.path.normpath(
<a name="l01790"></a>01790       os.path.join(ComputeOutputDir(params), config_name))
<a name="l01791"></a>01791 
<a name="l01792"></a>01792   toplevel_build = os.path.join(options.toplevel_dir, build_dir)
<a name="l01793"></a>01793 
<a name="l01794"></a>01794   master_ninja_file = OpenOutput(os.path.join(toplevel_build, <span class="stringliteral">'build.ninja'</span>))
<a name="l01795"></a>01795   master_ninja = ninja_syntax.Writer(master_ninja_file, width=120)
<a name="l01796"></a>01796 
<a name="l01797"></a>01797   <span class="comment"># Put build-time support tools in out/{config_name}.</span>
<a name="l01798"></a>01798   gyp.common.CopyTool(flavor, toplevel_build)
<a name="l01799"></a>01799 
<a name="l01800"></a>01800   <span class="comment"># Grab make settings for CC/CXX.</span>
<a name="l01801"></a>01801   <span class="comment"># The rules are</span>
<a name="l01802"></a>01802   <span class="comment"># - The priority from low to high is gcc/g++, the 'make_global_settings' in</span>
<a name="l01803"></a>01803   <span class="comment">#   gyp, the environment variable.</span>
<a name="l01804"></a>01804   <span class="comment"># - If there is no 'make_global_settings' for CC.host/CXX.host or</span>
<a name="l01805"></a>01805   <span class="comment">#   'CC_host'/'CXX_host' enviroment variable, cc_host/cxx_host should be set</span>
<a name="l01806"></a>01806   <span class="comment">#   to cc/cxx.</span>
<a name="l01807"></a>01807   <span class="keywordflow">if</span> flavor == <span class="stringliteral">'win'</span>:
<a name="l01808"></a>01808     ar = <span class="stringliteral">'lib.exe'</span>
<a name="l01809"></a>01809     <span class="comment"># cc and cxx must be set to the correct architecture by overriding with one</span>
<a name="l01810"></a>01810     <span class="comment"># of cl_x86 or cl_x64 below.</span>
<a name="l01811"></a>01811     cc = <span class="stringliteral">'UNSET'</span>
<a name="l01812"></a>01812     cxx = <span class="stringliteral">'UNSET'</span>
<a name="l01813"></a>01813     ld = <span class="stringliteral">'link.exe'</span>
<a name="l01814"></a>01814     ld_host = <span class="stringliteral">'$ld'</span>
<a name="l01815"></a>01815   <span class="keywordflow">else</span>:
<a name="l01816"></a>01816     ar = <span class="stringliteral">'ar'</span>
<a name="l01817"></a>01817     cc = <span class="stringliteral">'cc'</span>
<a name="l01818"></a>01818     cxx = <span class="stringliteral">'c++'</span>
<a name="l01819"></a>01819     ld = <span class="stringliteral">'$cc'</span>
<a name="l01820"></a>01820     ldxx = <span class="stringliteral">'$cxx'</span>
<a name="l01821"></a>01821     ld_host = <span class="stringliteral">'$cc_host'</span>
<a name="l01822"></a>01822     ldxx_host = <span class="stringliteral">'$cxx_host'</span>
<a name="l01823"></a>01823 
<a name="l01824"></a>01824   ar_host = <span class="stringliteral">'ar'</span>
<a name="l01825"></a>01825   cc_host = <span class="keywordtype">None</span>
<a name="l01826"></a>01826   cxx_host = <span class="keywordtype">None</span>
<a name="l01827"></a>01827   cc_host_global_setting = <span class="keywordtype">None</span>
<a name="l01828"></a>01828   cxx_host_global_setting = <span class="keywordtype">None</span>
<a name="l01829"></a>01829   clang_cl = <span class="keywordtype">None</span>
<a name="l01830"></a>01830   nm = <span class="stringliteral">'nm'</span>
<a name="l01831"></a>01831   nm_host = <span class="stringliteral">'nm'</span>
<a name="l01832"></a>01832   readelf = <span class="stringliteral">'readelf'</span>
<a name="l01833"></a>01833   readelf_host = <span class="stringliteral">'readelf'</span>
<a name="l01834"></a>01834 
<a name="l01835"></a>01835   build_file, _, _ = gyp.common.ParseQualifiedTarget(target_list[0])
<a name="l01836"></a>01836   make_global_settings = data[build_file].get(<span class="stringliteral">'make_global_settings'</span>, [])
<a name="l01837"></a>01837   build_to_root = gyp.common.InvertRelativePath(build_dir,
<a name="l01838"></a>01838                                                 options.toplevel_dir)
<a name="l01839"></a>01839   wrappers = {}
<a name="l01840"></a>01840   <span class="keywordflow">for</span> key, value <span class="keywordflow">in</span> make_global_settings:
<a name="l01841"></a>01841     <span class="keywordflow">if</span> key == <span class="stringliteral">'AR'</span>:
<a name="l01842"></a>01842       ar = os.path.join(build_to_root, value)
<a name="l01843"></a>01843     <span class="keywordflow">if</span> key == <span class="stringliteral">'AR.host'</span>:
<a name="l01844"></a>01844       ar_host = os.path.join(build_to_root, value)
<a name="l01845"></a>01845     <span class="keywordflow">if</span> key == <span class="stringliteral">'CC'</span>:
<a name="l01846"></a>01846       cc = os.path.join(build_to_root, value)
<a name="l01847"></a>01847       <span class="keywordflow">if</span> cc.endswith(<span class="stringliteral">'clang-cl'</span>):
<a name="l01848"></a>01848         clang_cl = cc
<a name="l01849"></a>01849     <span class="keywordflow">if</span> key == <span class="stringliteral">'CXX'</span>:
<a name="l01850"></a>01850       cxx = os.path.join(build_to_root, value)
<a name="l01851"></a>01851     <span class="keywordflow">if</span> key == <span class="stringliteral">'CC.host'</span>:
<a name="l01852"></a>01852       cc_host = os.path.join(build_to_root, value)
<a name="l01853"></a>01853       cc_host_global_setting = value
<a name="l01854"></a>01854     <span class="keywordflow">if</span> key == <span class="stringliteral">'CXX.host'</span>:
<a name="l01855"></a>01855       cxx_host = os.path.join(build_to_root, value)
<a name="l01856"></a>01856       cxx_host_global_setting = value
<a name="l01857"></a>01857     <span class="keywordflow">if</span> key == <span class="stringliteral">'LD'</span>:
<a name="l01858"></a>01858       ld = os.path.join(build_to_root, value)
<a name="l01859"></a>01859     <span class="keywordflow">if</span> key == <span class="stringliteral">'LD.host'</span>:
<a name="l01860"></a>01860       ld_host = os.path.join(build_to_root, value)
<a name="l01861"></a>01861     <span class="keywordflow">if</span> key == <span class="stringliteral">'NM'</span>:
<a name="l01862"></a>01862       nm = os.path.join(build_to_root, value)
<a name="l01863"></a>01863     <span class="keywordflow">if</span> key == <span class="stringliteral">'NM.host'</span>:
<a name="l01864"></a>01864       nm_host = os.path.join(build_to_root, value)
<a name="l01865"></a>01865     <span class="keywordflow">if</span> key == <span class="stringliteral">'READELF'</span>:
<a name="l01866"></a>01866       readelf = os.path.join(build_to_root, value)
<a name="l01867"></a>01867     <span class="keywordflow">if</span> key == <span class="stringliteral">'READELF.host'</span>:
<a name="l01868"></a>01868       readelf_host = os.path.join(build_to_root, value)
<a name="l01869"></a>01869     <span class="keywordflow">if</span> key.endswith(<span class="stringliteral">'_wrapper'</span>):
<a name="l01870"></a>01870       wrappers[key[:-len(<span class="stringliteral">'_wrapper'</span>)]] = os.path.join(build_to_root, value)
<a name="l01871"></a>01871 
<a name="l01872"></a>01872   <span class="comment"># Support wrappers from environment variables too.</span>
<a name="l01873"></a>01873   <span class="keywordflow">for</span> key, value <span class="keywordflow">in</span> os.environ.iteritems():
<a name="l01874"></a>01874     <span class="keywordflow">if</span> key.lower().endswith(<span class="stringliteral">'_wrapper'</span>):
<a name="l01875"></a>01875       key_prefix = key[:-len(<span class="stringliteral">'_wrapper'</span>)]
<a name="l01876"></a>01876       key_prefix = re.sub(<span class="stringliteral">r'\.HOST$'</span>, <span class="stringliteral">'.host'</span>, key_prefix)
<a name="l01877"></a>01877       wrappers[key_prefix] = os.path.join(build_to_root, value)
<a name="l01878"></a>01878 
<a name="l01879"></a>01879   <span class="keywordflow">if</span> flavor == <span class="stringliteral">'win'</span>:
<a name="l01880"></a>01880     configs = [target_dicts[qualified_target][<span class="stringliteral">'configurations'</span>][config_name]
<a name="l01881"></a>01881                <span class="keywordflow">for</span> qualified_target <span class="keywordflow">in</span> target_list]
<a name="l01882"></a>01882     shared_system_includes = <span class="keywordtype">None</span>
<a name="l01883"></a>01883     <span class="keywordflow">if</span> <span class="keywordflow">not</span> generator_flags.get(<span class="stringliteral">'ninja_use_custom_environment_files'</span>, 0):
<a name="l01884"></a>01884       shared_system_includes = \
<a name="l01885"></a>01885           gyp.msvs_emulation.ExtractSharedMSVSSystemIncludes(
<a name="l01886"></a>01886               configs, generator_flags)
<a name="l01887"></a>01887     cl_paths = gyp.msvs_emulation.GenerateEnvironmentFiles(
<a name="l01888"></a>01888         toplevel_build, generator_flags, shared_system_includes, OpenOutput)
<a name="l01889"></a>01889     <span class="keywordflow">for</span> arch, path <span class="keywordflow">in</span> cl_paths.iteritems():
<a name="l01890"></a>01890       <span class="keywordflow">if</span> clang_cl:
<a name="l01891"></a>01891         <span class="comment"># If we have selected clang-cl, use that instead.</span>
<a name="l01892"></a>01892         path = clang_cl
<a name="l01893"></a>01893       command = CommandWithWrapper(<span class="stringliteral">'CC'</span>, wrappers,
<a name="l01894"></a>01894           QuoteShellArgument(path, <span class="stringliteral">'win'</span>))
<a name="l01895"></a>01895       <span class="keywordflow">if</span> clang_cl:
<a name="l01896"></a>01896         <span class="comment"># Use clang-cl to cross-compile for x86 or x86_64.</span>
<a name="l01897"></a>01897         command += (<span class="stringliteral">' -m32'</span> <span class="keywordflow">if</span> arch == <span class="stringliteral">'x86'</span> <span class="keywordflow">else</span> <span class="stringliteral">' -m64'</span>)
<a name="l01898"></a>01898       master_ninja.variable(<span class="stringliteral">'cl_'</span> + arch, command)
<a name="l01899"></a>01899 
<a name="l01900"></a>01900   cc = GetEnvironFallback([<span class="stringliteral">'CC_target'</span>, <span class="stringliteral">'CC'</span>], cc)
<a name="l01901"></a>01901   master_ninja.variable(<span class="stringliteral">'cc'</span>, CommandWithWrapper(<span class="stringliteral">'CC'</span>, wrappers, cc))
<a name="l01902"></a>01902   cxx = GetEnvironFallback([<span class="stringliteral">'CXX_target'</span>, <span class="stringliteral">'CXX'</span>], cxx)
<a name="l01903"></a>01903   master_ninja.variable(<span class="stringliteral">'cxx'</span>, CommandWithWrapper(<span class="stringliteral">'CXX'</span>, wrappers, cxx))
<a name="l01904"></a>01904 
<a name="l01905"></a>01905   <span class="keywordflow">if</span> flavor == <span class="stringliteral">'win'</span>:
<a name="l01906"></a>01906     master_ninja.variable(<span class="stringliteral">'ld'</span>, ld)
<a name="l01907"></a>01907     master_ninja.variable(<span class="stringliteral">'idl'</span>, <span class="stringliteral">'midl.exe'</span>)
<a name="l01908"></a>01908     master_ninja.variable(<span class="stringliteral">'ar'</span>, ar)
<a name="l01909"></a>01909     master_ninja.variable(<span class="stringliteral">'rc'</span>, <span class="stringliteral">'rc.exe'</span>)
<a name="l01910"></a>01910     master_ninja.variable(<span class="stringliteral">'ml_x86'</span>, <span class="stringliteral">'ml.exe'</span>)
<a name="l01911"></a>01911     master_ninja.variable(<span class="stringliteral">'ml_x64'</span>, <span class="stringliteral">'ml64.exe'</span>)
<a name="l01912"></a>01912     master_ninja.variable(<span class="stringliteral">'mt'</span>, <span class="stringliteral">'mt.exe'</span>)
<a name="l01913"></a>01913   <span class="keywordflow">else</span>:
<a name="l01914"></a>01914     master_ninja.variable(<span class="stringliteral">'ld'</span>, CommandWithWrapper(<span class="stringliteral">'LINK'</span>, wrappers, ld))
<a name="l01915"></a>01915     master_ninja.variable(<span class="stringliteral">'ldxx'</span>, CommandWithWrapper(<span class="stringliteral">'LINK'</span>, wrappers, ldxx))
<a name="l01916"></a>01916     master_ninja.variable(<span class="stringliteral">'ar'</span>, GetEnvironFallback([<span class="stringliteral">'AR_target'</span>, <span class="stringliteral">'AR'</span>], ar))
<a name="l01917"></a>01917     <span class="keywordflow">if</span> flavor != <span class="stringliteral">'mac'</span>:
<a name="l01918"></a>01918       <span class="comment"># Mac does not use readelf/nm for .TOC generation, so avoiding polluting</span>
<a name="l01919"></a>01919       <span class="comment"># the master ninja with extra unused variables.</span>
<a name="l01920"></a>01920       master_ninja.variable(
<a name="l01921"></a>01921           <span class="stringliteral">'nm'</span>, GetEnvironFallback([<span class="stringliteral">'NM_target'</span>, <span class="stringliteral">'NM'</span>], nm))
<a name="l01922"></a>01922       master_ninja.variable(
<a name="l01923"></a>01923           <span class="stringliteral">'readelf'</span>, GetEnvironFallback([<span class="stringliteral">'READELF_target'</span>, <span class="stringliteral">'READELF'</span>], readelf))
<a name="l01924"></a>01924 
<a name="l01925"></a>01925   <span class="keywordflow">if</span> generator_supports_multiple_toolsets:
<a name="l01926"></a>01926     <span class="keywordflow">if</span> <span class="keywordflow">not</span> cc_host:
<a name="l01927"></a>01927       cc_host = cc
<a name="l01928"></a>01928     <span class="keywordflow">if</span> <span class="keywordflow">not</span> cxx_host:
<a name="l01929"></a>01929       cxx_host = cxx
<a name="l01930"></a>01930 
<a name="l01931"></a>01931     master_ninja.variable(<span class="stringliteral">'ar_host'</span>, GetEnvironFallback([<span class="stringliteral">'AR_host'</span>], ar_host))
<a name="l01932"></a>01932     master_ninja.variable(<span class="stringliteral">'nm_host'</span>, GetEnvironFallback([<span class="stringliteral">'NM_host'</span>], nm_host))
<a name="l01933"></a>01933     master_ninja.variable(<span class="stringliteral">'readelf_host'</span>,
<a name="l01934"></a>01934                           GetEnvironFallback([<span class="stringliteral">'READELF_host'</span>], readelf_host))
<a name="l01935"></a>01935     cc_host = GetEnvironFallback([<span class="stringliteral">'CC_host'</span>], cc_host)
<a name="l01936"></a>01936     cxx_host = GetEnvironFallback([<span class="stringliteral">'CXX_host'</span>], cxx_host)
<a name="l01937"></a>01937 
<a name="l01938"></a>01938     <span class="comment"># The environment variable could be used in 'make_global_settings', like</span>
<a name="l01939"></a>01939     <span class="comment"># ['CC.host', '$(CC)'] or ['CXX.host', '$(CXX)'], transform them here.</span>
<a name="l01940"></a>01940     <span class="keywordflow">if</span> <span class="stringliteral">'$(CC)'</span> <span class="keywordflow">in</span> cc_host <span class="keywordflow">and</span> cc_host_global_setting:
<a name="l01941"></a>01941       cc_host = cc_host_global_setting.replace(<span class="stringliteral">'$(CC)'</span>, cc)
<a name="l01942"></a>01942     <span class="keywordflow">if</span> <span class="stringliteral">'$(CXX)'</span> <span class="keywordflow">in</span> cxx_host <span class="keywordflow">and</span> cxx_host_global_setting:
<a name="l01943"></a>01943       cxx_host = cxx_host_global_setting.replace(<span class="stringliteral">'$(CXX)'</span>, cxx)
<a name="l01944"></a>01944     master_ninja.variable(<span class="stringliteral">'cc_host'</span>,
<a name="l01945"></a>01945                           CommandWithWrapper(<span class="stringliteral">'CC.host'</span>, wrappers, cc_host))
<a name="l01946"></a>01946     master_ninja.variable(<span class="stringliteral">'cxx_host'</span>,
<a name="l01947"></a>01947                           CommandWithWrapper(<span class="stringliteral">'CXX.host'</span>, wrappers, cxx_host))
<a name="l01948"></a>01948     <span class="keywordflow">if</span> flavor == <span class="stringliteral">'win'</span>:
<a name="l01949"></a>01949       master_ninja.variable(<span class="stringliteral">'ld_host'</span>, ld_host)
<a name="l01950"></a>01950     <span class="keywordflow">else</span>:
<a name="l01951"></a>01951       master_ninja.variable(<span class="stringliteral">'ld_host'</span>, CommandWithWrapper(
<a name="l01952"></a>01952           <span class="stringliteral">'LINK'</span>, wrappers, ld_host))
<a name="l01953"></a>01953       master_ninja.variable(<span class="stringliteral">'ldxx_host'</span>, CommandWithWrapper(
<a name="l01954"></a>01954           <span class="stringliteral">'LINK'</span>, wrappers, ldxx_host))
<a name="l01955"></a>01955 
<a name="l01956"></a>01956   master_ninja.newline()
<a name="l01957"></a>01957 
<a name="l01958"></a>01958   master_ninja.pool(<span class="stringliteral">'link_pool'</span>, depth=GetDefaultConcurrentLinks())
<a name="l01959"></a>01959   master_ninja.newline()
<a name="l01960"></a>01960 
<a name="l01961"></a>01961   deps = <span class="stringliteral">'msvc'</span> <span class="keywordflow">if</span> flavor == <span class="stringliteral">'win'</span> <span class="keywordflow">else</span> <span class="stringliteral">'gcc'</span>
<a name="l01962"></a>01962 
<a name="l01963"></a>01963   <span class="keywordflow">if</span> flavor != <span class="stringliteral">'win'</span>:
<a name="l01964"></a>01964     master_ninja.rule(
<a name="l01965"></a>01965       <span class="stringliteral">'cc'</span>,
<a name="l01966"></a>01966       description=<span class="stringliteral">'CC $out'</span>,
<a name="l01967"></a>01967       command=(<span class="stringliteral">'$cc -MMD -MF $out.d $defines $includes $cflags $cflags_c '</span>
<a name="l01968"></a>01968               <span class="stringliteral">'$cflags_pch_c -c $in -o $out'</span>),
<a name="l01969"></a>01969       depfile=<span class="stringliteral">'$out.d'</span>,
<a name="l01970"></a>01970       deps=deps)
<a name="l01971"></a>01971     master_ninja.rule(
<a name="l01972"></a>01972       <span class="stringliteral">'cc_s'</span>,
<a name="l01973"></a>01973       description=<span class="stringliteral">'CC $out'</span>,
<a name="l01974"></a>01974       command=(<span class="stringliteral">'$cc $defines $includes $cflags $cflags_c '</span>
<a name="l01975"></a>01975               <span class="stringliteral">'$cflags_pch_c -c $in -o $out'</span>))
<a name="l01976"></a>01976     master_ninja.rule(
<a name="l01977"></a>01977       <span class="stringliteral">'cxx'</span>,
<a name="l01978"></a>01978       description=<span class="stringliteral">'CXX $out'</span>,
<a name="l01979"></a>01979       command=(<span class="stringliteral">'$cxx -MMD -MF $out.d $defines $includes $cflags $cflags_cc '</span>
<a name="l01980"></a>01980               <span class="stringliteral">'$cflags_pch_cc -c $in -o $out'</span>),
<a name="l01981"></a>01981       depfile=<span class="stringliteral">'$out.d'</span>,
<a name="l01982"></a>01982       deps=deps)
<a name="l01983"></a>01983   <span class="keywordflow">else</span>:
<a name="l01984"></a>01984     <span class="comment"># TODO(scottmg) Separate pdb names is a test to see if it works around</span>
<a name="l01985"></a>01985     <span class="comment"># http://crbug.com/142362. It seems there's a race between the creation of</span>
<a name="l01986"></a>01986     <span class="comment"># the .pdb by the precompiled header step for .cc and the compilation of</span>
<a name="l01987"></a>01987     <span class="comment"># .c files. This should be handled by mspdbsrv, but rarely errors out with</span>
<a name="l01988"></a>01988     <span class="comment">#   c1xx : fatal error C1033: cannot open program database</span>
<a name="l01989"></a>01989     <span class="comment"># By making the rules target separate pdb files this might be avoided.</span>
<a name="l01990"></a>01990     cc_command = (<span class="stringliteral">'ninja -t msvc -e $arch '</span> +
<a name="l01991"></a>01991                   <span class="stringliteral">'-- '</span>
<a name="l01992"></a>01992                   <span class="stringliteral">'$cc /nologo /showIncludes /FC '</span>
<a name="l01993"></a>01993                   <span class="stringliteral">'@$out.rsp /c $in /Fo$out /Fd$pdbname_c '</span>)
<a name="l01994"></a>01994     cxx_command = (<span class="stringliteral">'ninja -t msvc -e $arch '</span> +
<a name="l01995"></a>01995                    <span class="stringliteral">'-- '</span>
<a name="l01996"></a>01996                    <span class="stringliteral">'$cxx /nologo /showIncludes /FC '</span>
<a name="l01997"></a>01997                    <span class="stringliteral">'@$out.rsp /c $in /Fo$out /Fd$pdbname_cc '</span>)
<a name="l01998"></a>01998     master_ninja.rule(
<a name="l01999"></a>01999       <span class="stringliteral">'cc'</span>,
<a name="l02000"></a>02000       description=<span class="stringliteral">'CC $out'</span>,
<a name="l02001"></a>02001       command=cc_command,
<a name="l02002"></a>02002       rspfile=<span class="stringliteral">'$out.rsp'</span>,
<a name="l02003"></a>02003       rspfile_content=<span class="stringliteral">'$defines $includes $cflags $cflags_c'</span>,
<a name="l02004"></a>02004       deps=deps)
<a name="l02005"></a>02005     master_ninja.rule(
<a name="l02006"></a>02006       <span class="stringliteral">'cxx'</span>,
<a name="l02007"></a>02007       description=<span class="stringliteral">'CXX $out'</span>,
<a name="l02008"></a>02008       command=cxx_command,
<a name="l02009"></a>02009       rspfile=<span class="stringliteral">'$out.rsp'</span>,
<a name="l02010"></a>02010       rspfile_content=<span class="stringliteral">'$defines $includes $cflags $cflags_cc'</span>,
<a name="l02011"></a>02011       deps=deps)
<a name="l02012"></a>02012     master_ninja.rule(
<a name="l02013"></a>02013       <span class="stringliteral">'idl'</span>,
<a name="l02014"></a>02014       description=<span class="stringliteral">'IDL $in'</span>,
<a name="l02015"></a>02015       command=(<span class="stringliteral">'%s gyp-win-tool midl-wrapper $arch $outdir '</span>
<a name="l02016"></a>02016                <span class="stringliteral">'$tlb $h $dlldata $iid $proxy $in '</span>
<a name="l02017"></a>02017                <span class="stringliteral">'$midl_includes $idlflags'</span> % sys.executable))
<a name="l02018"></a>02018     master_ninja.rule(
<a name="l02019"></a>02019       <span class="stringliteral">'rc'</span>,
<a name="l02020"></a>02020       description=<span class="stringliteral">'RC $in'</span>,
<a name="l02021"></a>02021       <span class="comment"># Note: $in must be last otherwise rc.exe complains.</span>
<a name="l02022"></a>02022       command=(<span class="stringliteral">'%s gyp-win-tool rc-wrapper '</span>
<a name="l02023"></a>02023                <span class="stringliteral">'$arch $rc $defines $resource_includes $rcflags /fo$out $in'</span> %
<a name="l02024"></a>02024                sys.executable))
<a name="l02025"></a>02025     master_ninja.rule(
<a name="l02026"></a>02026       <span class="stringliteral">'asm'</span>,
<a name="l02027"></a>02027       description=<span class="stringliteral">'ASM $out'</span>,
<a name="l02028"></a>02028       command=(<span class="stringliteral">'%s gyp-win-tool asm-wrapper '</span>
<a name="l02029"></a>02029                <span class="stringliteral">'$arch $asm $defines $includes $asmflags /c /Fo $out $in'</span> %
<a name="l02030"></a>02030                sys.executable))
<a name="l02031"></a>02031 
<a name="l02032"></a>02032   <span class="keywordflow">if</span> flavor != <span class="stringliteral">'mac'</span> <span class="keywordflow">and</span> flavor != <span class="stringliteral">'win'</span>:
<a name="l02033"></a>02033     master_ninja.rule(
<a name="l02034"></a>02034       <span class="stringliteral">'alink'</span>,
<a name="l02035"></a>02035       description=<span class="stringliteral">'AR $out'</span>,
<a name="l02036"></a>02036       command=<span class="stringliteral">'rm -f $out &amp;&amp; $ar rcs $arflags $out $in'</span>)
<a name="l02037"></a>02037     master_ninja.rule(
<a name="l02038"></a>02038       <span class="stringliteral">'alink_thin'</span>,
<a name="l02039"></a>02039       description=<span class="stringliteral">'AR $out'</span>,
<a name="l02040"></a>02040       command=<span class="stringliteral">'rm -f $out &amp;&amp; $ar rcsT $arflags $out $in'</span>)
<a name="l02041"></a>02041 
<a name="l02042"></a>02042     <span class="comment"># This allows targets that only need to depend on $lib's API to declare an</span>
<a name="l02043"></a>02043     <span class="comment"># order-only dependency on $lib.TOC and avoid relinking such downstream</span>
<a name="l02044"></a>02044     <span class="comment"># dependencies when $lib changes only in non-public ways.</span>
<a name="l02045"></a>02045     <span class="comment"># The resulting string leaves an uninterpolated %{suffix} which</span>
<a name="l02046"></a>02046     <span class="comment"># is used in the final substitution below.</span>
<a name="l02047"></a>02047     mtime_preserving_solink_base = (
<a name="l02048"></a>02048         <span class="stringliteral">'if [ ! -e $lib -o ! -e $lib.TOC ]; then '</span>
<a name="l02049"></a>02049         <span class="stringliteral">'%(solink)s &amp;&amp; %(extract_toc)s &gt; $lib.TOC; else '</span>
<a name="l02050"></a>02050         <span class="stringliteral">'%(solink)s &amp;&amp; %(extract_toc)s &gt; $lib.tmp &amp;&amp; '</span>
<a name="l02051"></a>02051         <span class="stringliteral">'if ! cmp -s $lib.tmp $lib.TOC; then mv $lib.tmp $lib.TOC ; '</span>
<a name="l02052"></a>02052         <span class="stringliteral">'fi; fi'</span>
<a name="l02053"></a>02053         % { <span class="stringliteral">'solink'</span>:
<a name="l02054"></a>02054               <span class="stringliteral">'$ld -shared $ldflags -o $lib -Wl,-soname=$soname %(suffix)s'</span>,
<a name="l02055"></a>02055             <span class="stringliteral">'extract_toc'</span>:
<a name="l02056"></a>02056               (<span class="stringliteral">'{ $readelf -d $lib | grep SONAME ; '</span>
<a name="l02057"></a>02057                <span class="stringliteral">'$nm -gD -f p $lib | cut -f1-2 -d\' \'; }'</span>)})
<a name="l02058"></a>02058 
<a name="l02059"></a>02059     master_ninja.rule(
<a name="l02060"></a>02060       <span class="stringliteral">'solink'</span>,
<a name="l02061"></a>02061       description=<span class="stringliteral">'SOLINK $lib'</span>,
<a name="l02062"></a>02062       restat=<span class="keyword">True</span>,
<a name="l02063"></a>02063       command=mtime_preserving_solink_base % {<span class="stringliteral">'suffix'</span>: <span class="stringliteral">'@$link_file_list'</span>},
<a name="l02064"></a>02064       rspfile=<span class="stringliteral">'$link_file_list'</span>,
<a name="l02065"></a>02065       rspfile_content=
<a name="l02066"></a>02066           <span class="stringliteral">'-Wl,--whole-archive $in $solibs -Wl,--no-whole-archive $libs'</span>,
<a name="l02067"></a>02067       pool=<span class="stringliteral">'link_pool'</span>)
<a name="l02068"></a>02068     master_ninja.rule(
<a name="l02069"></a>02069       <span class="stringliteral">'solink_module'</span>,
<a name="l02070"></a>02070       description=<span class="stringliteral">'SOLINK(module) $lib'</span>,
<a name="l02071"></a>02071       restat=<span class="keyword">True</span>,
<a name="l02072"></a>02072       command=mtime_preserving_solink_base % {<span class="stringliteral">'suffix'</span>: <span class="stringliteral">'@$link_file_list'</span>},
<a name="l02073"></a>02073       rspfile=<span class="stringliteral">'$link_file_list'</span>,
<a name="l02074"></a>02074       rspfile_content=<span class="stringliteral">'-Wl,--start-group $in -Wl,--end-group $solibs $libs'</span>,
<a name="l02075"></a>02075       pool=<span class="stringliteral">'link_pool'</span>)
<a name="l02076"></a>02076     master_ninja.rule(
<a name="l02077"></a>02077       <span class="stringliteral">'link'</span>,
<a name="l02078"></a>02078       description=<span class="stringliteral">'LINK $out'</span>,
<a name="l02079"></a>02079       command=(<span class="stringliteral">'$ld $ldflags -o $out '</span>
<a name="l02080"></a>02080                <span class="stringliteral">'-Wl,--start-group $in -Wl,--end-group $solibs $libs'</span>),
<a name="l02081"></a>02081       pool=<span class="stringliteral">'link_pool'</span>)
<a name="l02082"></a>02082   <span class="keywordflow">elif</span> flavor == <span class="stringliteral">'win'</span>:
<a name="l02083"></a>02083     master_ninja.rule(
<a name="l02084"></a>02084         <span class="stringliteral">'alink'</span>,
<a name="l02085"></a>02085         description=<span class="stringliteral">'LIB $out'</span>,
<a name="l02086"></a>02086         command=(<span class="stringliteral">'%s gyp-win-tool link-wrapper $arch False '</span>
<a name="l02087"></a>02087                  <span class="stringliteral">'$ar /nologo /ignore:4221 /OUT:$out @$out.rsp'</span> %
<a name="l02088"></a>02088                  sys.executable),
<a name="l02089"></a>02089         rspfile=<span class="stringliteral">'$out.rsp'</span>,
<a name="l02090"></a>02090         rspfile_content=<span class="stringliteral">'$in_newline $libflags'</span>)
<a name="l02091"></a>02091     _AddWinLinkRules(master_ninja, embed_manifest=<span class="keyword">True</span>)
<a name="l02092"></a>02092     _AddWinLinkRules(master_ninja, embed_manifest=<span class="keyword">False</span>)
<a name="l02093"></a>02093   <span class="keywordflow">else</span>:
<a name="l02094"></a>02094     master_ninja.rule(
<a name="l02095"></a>02095       <span class="stringliteral">'objc'</span>,
<a name="l02096"></a>02096       description=<span class="stringliteral">'OBJC $out'</span>,
<a name="l02097"></a>02097       command=(<span class="stringliteral">'$cc -MMD -MF $out.d $defines $includes $cflags $cflags_objc '</span>
<a name="l02098"></a>02098                <span class="stringliteral">'$cflags_pch_objc -c $in -o $out'</span>),
<a name="l02099"></a>02099       depfile=<span class="stringliteral">'$out.d'</span>,
<a name="l02100"></a>02100       deps=deps)
<a name="l02101"></a>02101     master_ninja.rule(
<a name="l02102"></a>02102       <span class="stringliteral">'objcxx'</span>,
<a name="l02103"></a>02103       description=<span class="stringliteral">'OBJCXX $out'</span>,
<a name="l02104"></a>02104       command=(<span class="stringliteral">'$cxx -MMD -MF $out.d $defines $includes $cflags $cflags_objcc '</span>
<a name="l02105"></a>02105                <span class="stringliteral">'$cflags_pch_objcc -c $in -o $out'</span>),
<a name="l02106"></a>02106       depfile=<span class="stringliteral">'$out.d'</span>,
<a name="l02107"></a>02107       deps=deps)
<a name="l02108"></a>02108     master_ninja.rule(
<a name="l02109"></a>02109       <span class="stringliteral">'alink'</span>,
<a name="l02110"></a>02110       description=<span class="stringliteral">'LIBTOOL-STATIC $out, POSTBUILDS'</span>,
<a name="l02111"></a>02111       command=<span class="stringliteral">'rm -f $out &amp;&amp; '</span>
<a name="l02112"></a>02112               <span class="stringliteral">'./gyp-mac-tool filter-libtool libtool $libtool_flags '</span>
<a name="l02113"></a>02113               <span class="stringliteral">'-static -o $out $in'</span>
<a name="l02114"></a>02114               <span class="stringliteral">'$postbuilds'</span>)
<a name="l02115"></a>02115     master_ninja.rule(
<a name="l02116"></a>02116       <span class="stringliteral">'lipo'</span>,
<a name="l02117"></a>02117       description=<span class="stringliteral">'LIPO $out, POSTBUILDS'</span>,
<a name="l02118"></a>02118       command=<span class="stringliteral">'rm -f $out &amp;&amp; lipo -create $in -output $out$postbuilds'</span>)
<a name="l02119"></a>02119     master_ninja.rule(
<a name="l02120"></a>02120       <span class="stringliteral">'solipo'</span>,
<a name="l02121"></a>02121       description=<span class="stringliteral">'SOLIPO $out, POSTBUILDS'</span>,
<a name="l02122"></a>02122       command=(
<a name="l02123"></a>02123           <span class="stringliteral">'rm -f $lib $lib.TOC &amp;&amp; lipo -create $in -output $lib$postbuilds &amp;&amp;'</span>
<a name="l02124"></a>02124           <span class="stringliteral">'%(extract_toc)s &gt; $lib.TOC'</span>
<a name="l02125"></a>02125           % { <span class="stringliteral">'extract_toc'</span>:
<a name="l02126"></a>02126                 <span class="stringliteral">'{ otool -l $lib | grep LC_ID_DYLIB -A 5; '</span>
<a name="l02127"></a>02127                 <span class="stringliteral">'nm -gP $lib | cut -f1-2 -d\' \' | grep -v U$$; true; }'</span>}))
<a name="l02128"></a>02128 
<a name="l02129"></a>02129 
<a name="l02130"></a>02130     <span class="comment"># Record the public interface of $lib in $lib.TOC. See the corresponding</span>
<a name="l02131"></a>02131     <span class="comment"># comment in the posix section above for details.</span>
<a name="l02132"></a>02132     solink_base = <span class="stringliteral">'$ld %(type)s $ldflags -o $lib %(suffix)s'</span>
<a name="l02133"></a>02133     mtime_preserving_solink_base = (
<a name="l02134"></a>02134         <span class="stringliteral">'if [ ! -e $lib -o ! -e $lib.TOC ] || '</span>
<a name="l02135"></a>02135              <span class="comment"># Always force dependent targets to relink if this library</span>
<a name="l02136"></a>02136              <span class="comment"># reexports something. Handling this correctly would require</span>
<a name="l02137"></a>02137              <span class="comment"># recursive TOC dumping but this is rare in practice, so punt.</span>
<a name="l02138"></a>02138              <span class="stringliteral">'otool -l $lib | grep -q LC_REEXPORT_DYLIB ; then '</span>
<a name="l02139"></a>02139           <span class="stringliteral">'%(solink)s &amp;&amp; %(extract_toc)s &gt; $lib.TOC; '</span>
<a name="l02140"></a>02140         <span class="stringliteral">'else '</span>
<a name="l02141"></a>02141           <span class="stringliteral">'%(solink)s &amp;&amp; %(extract_toc)s &gt; $lib.tmp &amp;&amp; '</span>
<a name="l02142"></a>02142           <span class="stringliteral">'if ! cmp -s $lib.tmp $lib.TOC; then '</span>
<a name="l02143"></a>02143             <span class="stringliteral">'mv $lib.tmp $lib.TOC ; '</span>
<a name="l02144"></a>02144           <span class="stringliteral">'fi; '</span>
<a name="l02145"></a>02145         <span class="stringliteral">'fi'</span>
<a name="l02146"></a>02146         % { <span class="stringliteral">'solink'</span>: solink_base,
<a name="l02147"></a>02147             <span class="stringliteral">'extract_toc'</span>:
<a name="l02148"></a>02148               <span class="stringliteral">'{ otool -l $lib | grep LC_ID_DYLIB -A 5; '</span>
<a name="l02149"></a>02149               <span class="stringliteral">'nm -gP $lib | cut -f1-2 -d\' \' | grep -v U$$; true; }'</span>})
<a name="l02150"></a>02150 
<a name="l02151"></a>02151 
<a name="l02152"></a>02152     solink_suffix = <span class="stringliteral">'@$link_file_list$postbuilds'</span>
<a name="l02153"></a>02153     master_ninja.rule(
<a name="l02154"></a>02154       <span class="stringliteral">'solink'</span>,
<a name="l02155"></a>02155       description=<span class="stringliteral">'SOLINK $lib, POSTBUILDS'</span>,
<a name="l02156"></a>02156       restat=<span class="keyword">True</span>,
<a name="l02157"></a>02157       command=mtime_preserving_solink_base % {<span class="stringliteral">'suffix'</span>: solink_suffix,
<a name="l02158"></a>02158                                               <span class="stringliteral">'type'</span>: <span class="stringliteral">'-shared'</span>},
<a name="l02159"></a>02159       rspfile=<span class="stringliteral">'$link_file_list'</span>,
<a name="l02160"></a>02160       rspfile_content=<span class="stringliteral">'$in $solibs $libs'</span>,
<a name="l02161"></a>02161       pool=<span class="stringliteral">'link_pool'</span>)
<a name="l02162"></a>02162     master_ninja.rule(
<a name="l02163"></a>02163       <span class="stringliteral">'solink_notoc'</span>,
<a name="l02164"></a>02164       description=<span class="stringliteral">'SOLINK $lib, POSTBUILDS'</span>,
<a name="l02165"></a>02165       restat=<span class="keyword">True</span>,
<a name="l02166"></a>02166       command=solink_base % {<span class="stringliteral">'suffix'</span>:solink_suffix, <span class="stringliteral">'type'</span>: <span class="stringliteral">'-shared'</span>},
<a name="l02167"></a>02167       rspfile=<span class="stringliteral">'$link_file_list'</span>,
<a name="l02168"></a>02168       rspfile_content=<span class="stringliteral">'$in $solibs $libs'</span>,
<a name="l02169"></a>02169       pool=<span class="stringliteral">'link_pool'</span>)
<a name="l02170"></a>02170 
<a name="l02171"></a>02171     master_ninja.rule(
<a name="l02172"></a>02172       <span class="stringliteral">'solink_module'</span>,
<a name="l02173"></a>02173       description=<span class="stringliteral">'SOLINK(module) $lib, POSTBUILDS'</span>,
<a name="l02174"></a>02174       restat=<span class="keyword">True</span>,
<a name="l02175"></a>02175       command=mtime_preserving_solink_base % {<span class="stringliteral">'suffix'</span>: solink_suffix,
<a name="l02176"></a>02176                                               <span class="stringliteral">'type'</span>: <span class="stringliteral">'-bundle'</span>},
<a name="l02177"></a>02177       rspfile=<span class="stringliteral">'$link_file_list'</span>,
<a name="l02178"></a>02178       rspfile_content=<span class="stringliteral">'$in $solibs $libs'</span>,
<a name="l02179"></a>02179       pool=<span class="stringliteral">'link_pool'</span>)
<a name="l02180"></a>02180     master_ninja.rule(
<a name="l02181"></a>02181       <span class="stringliteral">'solink_module_notoc'</span>,
<a name="l02182"></a>02182       description=<span class="stringliteral">'SOLINK(module) $lib, POSTBUILDS'</span>,
<a name="l02183"></a>02183       restat=<span class="keyword">True</span>,
<a name="l02184"></a>02184       command=solink_base % {<span class="stringliteral">'suffix'</span>: solink_suffix, <span class="stringliteral">'type'</span>: <span class="stringliteral">'-bundle'</span>},
<a name="l02185"></a>02185       rspfile=<span class="stringliteral">'$link_file_list'</span>,
<a name="l02186"></a>02186       rspfile_content=<span class="stringliteral">'$in $solibs $libs'</span>,
<a name="l02187"></a>02187       pool=<span class="stringliteral">'link_pool'</span>)
<a name="l02188"></a>02188 
<a name="l02189"></a>02189     master_ninja.rule(
<a name="l02190"></a>02190       <span class="stringliteral">'link'</span>,
<a name="l02191"></a>02191       description=<span class="stringliteral">'LINK $out, POSTBUILDS'</span>,
<a name="l02192"></a>02192       command=(<span class="stringliteral">'$ld $ldflags -o $out '</span>
<a name="l02193"></a>02193                <span class="stringliteral">'$in $solibs $libs$postbuilds'</span>),
<a name="l02194"></a>02194       pool=<span class="stringliteral">'link_pool'</span>)
<a name="l02195"></a>02195     master_ninja.rule(
<a name="l02196"></a>02196       <span class="stringliteral">'preprocess_infoplist'</span>,
<a name="l02197"></a>02197       description=<span class="stringliteral">'PREPROCESS INFOPLIST $out'</span>,
<a name="l02198"></a>02198       command=(<span class="stringliteral">'$cc -E -P -Wno-trigraphs -x c $defines $in -o $out &amp;&amp; '</span>
<a name="l02199"></a>02199                <span class="stringliteral">'plutil -convert xml1 $out $out'</span>))
<a name="l02200"></a>02200     master_ninja.rule(
<a name="l02201"></a>02201       <span class="stringliteral">'copy_infoplist'</span>,
<a name="l02202"></a>02202       description=<span class="stringliteral">'COPY INFOPLIST $in'</span>,
<a name="l02203"></a>02203       command=<span class="stringliteral">'$env ./gyp-mac-tool copy-info-plist $in $out $binary $keys'</span>)
<a name="l02204"></a>02204     master_ninja.rule(
<a name="l02205"></a>02205       <span class="stringliteral">'merge_infoplist'</span>,
<a name="l02206"></a>02206       description=<span class="stringliteral">'MERGE INFOPLISTS $in'</span>,
<a name="l02207"></a>02207       command=<span class="stringliteral">'$env ./gyp-mac-tool merge-info-plist $out $in'</span>)
<a name="l02208"></a>02208     master_ninja.rule(
<a name="l02209"></a>02209       <span class="stringliteral">'compile_xcassets'</span>,
<a name="l02210"></a>02210       description=<span class="stringliteral">'COMPILE XCASSETS $in'</span>,
<a name="l02211"></a>02211       command=<span class="stringliteral">'$env ./gyp-mac-tool compile-xcassets $keys $in'</span>)
<a name="l02212"></a>02212     master_ninja.rule(
<a name="l02213"></a>02213       <span class="stringliteral">'mac_tool'</span>,
<a name="l02214"></a>02214       description=<span class="stringliteral">'MACTOOL $mactool_cmd $in'</span>,
<a name="l02215"></a>02215       command=<span class="stringliteral">'$env ./gyp-mac-tool $mactool_cmd $in $out $binary'</span>)
<a name="l02216"></a>02216     master_ninja.rule(
<a name="l02217"></a>02217       <span class="stringliteral">'package_framework'</span>,
<a name="l02218"></a>02218       description=<span class="stringliteral">'PACKAGE FRAMEWORK $out, POSTBUILDS'</span>,
<a name="l02219"></a>02219       command=<span class="stringliteral">'./gyp-mac-tool package-framework $out $version$postbuilds '</span>
<a name="l02220"></a>02220               <span class="stringliteral">'&amp;&amp; touch $out'</span>)
<a name="l02221"></a>02221   <span class="keywordflow">if</span> flavor == <span class="stringliteral">'win'</span>:
<a name="l02222"></a>02222     master_ninja.rule(
<a name="l02223"></a>02223       <span class="stringliteral">'stamp'</span>,
<a name="l02224"></a>02224       description=<span class="stringliteral">'STAMP $out'</span>,
<a name="l02225"></a>02225       command=<span class="stringliteral">'%s gyp-win-tool stamp $out'</span> % sys.executable)
<a name="l02226"></a>02226     master_ninja.rule(
<a name="l02227"></a>02227       <span class="stringliteral">'copy'</span>,
<a name="l02228"></a>02228       description=<span class="stringliteral">'COPY $in $out'</span>,
<a name="l02229"></a>02229       command=<span class="stringliteral">'%s gyp-win-tool recursive-mirror $in $out'</span> % sys.executable)
<a name="l02230"></a>02230   <span class="keywordflow">else</span>:
<a name="l02231"></a>02231     master_ninja.rule(
<a name="l02232"></a>02232       <span class="stringliteral">'stamp'</span>,
<a name="l02233"></a>02233       description=<span class="stringliteral">'STAMP $out'</span>,
<a name="l02234"></a>02234       command=<span class="stringliteral">'${postbuilds}touch $out'</span>)
<a name="l02235"></a>02235     master_ninja.rule(
<a name="l02236"></a>02236       <span class="stringliteral">'copy'</span>,
<a name="l02237"></a>02237       description=<span class="stringliteral">'COPY $in $out'</span>,
<a name="l02238"></a>02238       command=<span class="stringliteral">'rm -rf $out &amp;&amp; cp -af $in $out'</span>)
<a name="l02239"></a>02239   master_ninja.newline()
<a name="l02240"></a>02240 
<a name="l02241"></a>02241   all_targets = set()
<a name="l02242"></a>02242   <span class="keywordflow">for</span> build_file <span class="keywordflow">in</span> params[<span class="stringliteral">'build_files'</span>]:
<a name="l02243"></a>02243     <span class="keywordflow">for</span> target <span class="keywordflow">in</span> gyp.common.AllTargets(target_list,
<a name="l02244"></a>02244                                         target_dicts,
<a name="l02245"></a>02245                                         os.path.normpath(build_file)):
<a name="l02246"></a>02246       all_targets.add(target)
<a name="l02247"></a>02247   all_outputs = set()
<a name="l02248"></a>02248 
<a name="l02249"></a>02249   <span class="comment"># target_outputs is a map from qualified target name to a Target object.</span>
<a name="l02250"></a>02250   target_outputs = {}
<a name="l02251"></a>02251   <span class="comment"># target_short_names is a map from target short name to a list of Target</span>
<a name="l02252"></a>02252   <span class="comment"># objects.</span>
<a name="l02253"></a>02253   target_short_names = {}
<a name="l02254"></a>02254 
<a name="l02255"></a>02255   <span class="comment"># short name of targets that were skipped because they didn't contain anything</span>
<a name="l02256"></a>02256   <span class="comment"># interesting.</span>
<a name="l02257"></a>02257   <span class="comment"># NOTE: there may be overlap between this an non_empty_target_names.</span>
<a name="l02258"></a>02258   empty_target_names = set()
<a name="l02259"></a>02259 
<a name="l02260"></a>02260   <span class="comment"># Set of non-empty short target names.</span>
<a name="l02261"></a>02261   <span class="comment"># NOTE: there may be overlap between this an empty_target_names.</span>
<a name="l02262"></a>02262   non_empty_target_names = set()
<a name="l02263"></a>02263 
<a name="l02264"></a>02264   <span class="keywordflow">for</span> qualified_target <span class="keywordflow">in</span> target_list:
<a name="l02265"></a>02265     <span class="comment"># qualified_target is like: third_party/icu/icu.gyp:icui18n#target</span>
<a name="l02266"></a>02266     build_file, name, toolset = \
<a name="l02267"></a>02267         gyp.common.ParseQualifiedTarget(qualified_target)
<a name="l02268"></a>02268 
<a name="l02269"></a>02269     this_make_global_settings = data[build_file].get(<span class="stringliteral">'make_global_settings'</span>, [])
<a name="l02270"></a>02270     <span class="keyword">assert</span> make_global_settings == this_make_global_settings, (
<a name="l02271"></a>02271         <span class="stringliteral">"make_global_settings needs to be the same for all targets. %s vs. %s"</span> %
<a name="l02272"></a>02272         (this_make_global_settings, make_global_settings))
<a name="l02273"></a>02273 
<a name="l02274"></a>02274     spec = target_dicts[qualified_target]
<a name="l02275"></a>02275     <span class="keywordflow">if</span> flavor == <span class="stringliteral">'mac'</span>:
<a name="l02276"></a>02276       gyp.xcode_emulation.MergeGlobalXcodeSettingsToSpec(data[build_file], spec)
<a name="l02277"></a>02277 
<a name="l02278"></a>02278     build_file = gyp.common.RelativePath(build_file, options.toplevel_dir)
<a name="l02279"></a>02279 
<a name="l02280"></a>02280     qualified_target_for_hash = gyp.common.QualifiedTarget(build_file, name,
<a name="l02281"></a>02281                                                            toolset)
<a name="l02282"></a>02282     hash_for_rules = hashlib.md5(qualified_target_for_hash).hexdigest()
<a name="l02283"></a>02283 
<a name="l02284"></a>02284     base_path = os.path.dirname(build_file)
<a name="l02285"></a>02285     obj = <span class="stringliteral">'obj'</span>
<a name="l02286"></a>02286     <span class="keywordflow">if</span> toolset != <span class="stringliteral">'target'</span>:
<a name="l02287"></a>02287       obj += <span class="stringliteral">'.'</span> + toolset
<a name="l02288"></a>02288     output_file = os.path.join(obj, base_path, name + <span class="stringliteral">'.ninja'</span>)
<a name="l02289"></a>02289 
<a name="l02290"></a>02290     ninja_output = StringIO()
<a name="l02291"></a>02291     writer = NinjaWriter(hash_for_rules, target_outputs, base_path, build_dir,
<a name="l02292"></a>02292                          ninja_output,
<a name="l02293"></a>02293                          toplevel_build, output_file,
<a name="l02294"></a>02294                          flavor, toplevel_dir=options.toplevel_dir)
<a name="l02295"></a>02295 
<a name="l02296"></a>02296     target = writer.WriteSpec(spec, config_name, generator_flags)
<a name="l02297"></a>02297 
<a name="l02298"></a>02298     <span class="keywordflow">if</span> ninja_output.tell() &gt; 0:
<a name="l02299"></a>02299       <span class="comment"># Only create files for ninja files that actually have contents.</span>
<a name="l02300"></a>02300       with OpenOutput(os.path.join(toplevel_build, output_file)) <span class="keyword">as</span> ninja_file:
<a name="l02301"></a>02301         ninja_file.write(ninja_output.getvalue())
<a name="l02302"></a>02302       ninja_output.close()
<a name="l02303"></a>02303       master_ninja.subninja(output_file)
<a name="l02304"></a>02304 
<a name="l02305"></a>02305     <span class="keywordflow">if</span> target:
<a name="l02306"></a>02306       <span class="keywordflow">if</span> name != target.FinalOutput() <span class="keywordflow">and</span> spec[<span class="stringliteral">'toolset'</span>] == <span class="stringliteral">'target'</span>:
<a name="l02307"></a>02307         target_short_names.setdefault(name, []).append(target)
<a name="l02308"></a>02308       target_outputs[qualified_target] = target
<a name="l02309"></a>02309       <span class="keywordflow">if</span> qualified_target <span class="keywordflow">in</span> all_targets:
<a name="l02310"></a>02310         all_outputs.add(target.FinalOutput())
<a name="l02311"></a>02311       non_empty_target_names.add(name)
<a name="l02312"></a>02312     <span class="keywordflow">else</span>:
<a name="l02313"></a>02313       empty_target_names.add(name)
<a name="l02314"></a>02314 
<a name="l02315"></a>02315   <span class="keywordflow">if</span> target_short_names:
<a name="l02316"></a>02316     <span class="comment"># Write a short name to build this target.  This benefits both the</span>
<a name="l02317"></a>02317     <span class="comment"># "build chrome" case as well as the gyp tests, which expect to be</span>
<a name="l02318"></a>02318     <span class="comment"># able to run actions and build libraries by their short name.</span>
<a name="l02319"></a>02319     master_ninja.newline()
<a name="l02320"></a>02320     master_ninja.comment(<span class="stringliteral">'Short names for targets.'</span>)
<a name="l02321"></a>02321     <span class="keywordflow">for</span> short_name <span class="keywordflow">in</span> target_short_names:
<a name="l02322"></a>02322       master_ninja.build(short_name, <span class="stringliteral">'phony'</span>, [x.FinalOutput() <span class="keywordflow">for</span> x <span class="keywordflow">in</span>
<a name="l02323"></a>02323                                                target_short_names[short_name]])
<a name="l02324"></a>02324 
<a name="l02325"></a>02325   <span class="comment"># Write phony targets for any empty targets that weren't written yet. As</span>
<a name="l02326"></a>02326   <span class="comment"># short names are  not necessarily unique only do this for short names that</span>
<a name="l02327"></a>02327   <span class="comment"># haven't already been output for another target.</span>
<a name="l02328"></a>02328   empty_target_names = empty_target_names - non_empty_target_names
<a name="l02329"></a>02329   <span class="keywordflow">if</span> empty_target_names:
<a name="l02330"></a>02330     master_ninja.newline()
<a name="l02331"></a>02331     master_ninja.comment(<span class="stringliteral">'Empty targets (output for completeness).'</span>)
<a name="l02332"></a>02332     <span class="keywordflow">for</span> name <span class="keywordflow">in</span> sorted(empty_target_names):
<a name="l02333"></a>02333       master_ninja.build(name, <span class="stringliteral">'phony'</span>)
<a name="l02334"></a>02334 
<a name="l02335"></a>02335   <span class="keywordflow">if</span> all_outputs:
<a name="l02336"></a>02336     master_ninja.newline()
<a name="l02337"></a>02337     master_ninja.build(<span class="stringliteral">'all'</span>, <span class="stringliteral">'phony'</span>, list(all_outputs))
<a name="l02338"></a>02338     master_ninja.default(generator_flags.get(<span class="stringliteral">'default_target'</span>, <span class="stringliteral">'all'</span>))
<a name="l02339"></a>02339 
<a name="l02340"></a>02340   master_ninja_file.close()
<a name="l02341"></a>02341 
<a name="l02342"></a>02342 
<a name="l02343"></a><a class="code" href="../../dc/d8b/namespacegyp_1_1generator_1_1ninja.html#49c52cae33fdd065ed50b31aacd5dcff">02343</a> <span class="keyword">def </span><a class="code" href="../../dc/d8b/namespacegyp_1_1generator_1_1ninja.html#49c52cae33fdd065ed50b31aacd5dcff">PerformBuild</a>(data, configurations, params):
<a name="l02344"></a>02344   options = params[<span class="stringliteral">'options'</span>]
<a name="l02345"></a>02345   <span class="keywordflow">for</span> config <span class="keywordflow">in</span> configurations:
<a name="l02346"></a>02346     builddir = os.path.join(options.toplevel_dir, <span class="stringliteral">'out'</span>, config)
<a name="l02347"></a>02347     arguments = [<span class="stringliteral">'ninja'</span>, <span class="stringliteral">'-C'</span>, builddir]
<a name="l02348"></a>02348     <span class="keywordflow">print</span> <span class="stringliteral">'Building [%s]: %s'</span> % (config, arguments)
<a name="l02349"></a>02349     subprocess.check_call(arguments)
<a name="l02350"></a>02350 
<a name="l02351"></a>02351 
<a name="l02352"></a><a class="code" href="../../dc/d8b/namespacegyp_1_1generator_1_1ninja.html#64eedce22f479173745b5a9134219dfd">02352</a> <span class="keyword">def </span><a class="code" href="../../dc/d8b/namespacegyp_1_1generator_1_1ninja.html#64eedce22f479173745b5a9134219dfd">CallGenerateOutputForConfig</a>(arglist):
<a name="l02353"></a>02353   <span class="comment"># Ignore the interrupt signal so that the parent process catches it and</span>
<a name="l02354"></a>02354   <span class="comment"># kills all multiprocessing children.</span>
<a name="l02355"></a>02355   signal.signal(signal.SIGINT, signal.SIG_IGN)
<a name="l02356"></a>02356 
<a name="l02357"></a>02357   (target_list, target_dicts, data, params, config_name) = arglist
<a name="l02358"></a>02358   GenerateOutputForConfig(target_list, target_dicts, data, params, config_name)
<a name="l02359"></a>02359 
<a name="l02360"></a>02360 
<a name="l02361"></a><a class="code" href="../../dc/d8b/namespacegyp_1_1generator_1_1ninja.html#61c708adaeb9359fa611b958ad172064">02361</a> <span class="keyword">def </span><a class="code" href="../../dc/d8b/namespacegyp_1_1generator_1_1ninja.html#61c708adaeb9359fa611b958ad172064">GenerateOutput</a>(target_list, target_dicts, data, params):
<a name="l02362"></a>02362   <span class="comment"># Update target_dicts for iOS device builds.</span>
<a name="l02363"></a>02363   target_dicts = gyp.xcode_emulation.CloneConfigurationForDeviceAndEmulator(
<a name="l02364"></a>02364       target_dicts)
<a name="l02365"></a>02365 
<a name="l02366"></a>02366   user_config = params.get(<span class="stringliteral">'generator_flags'</span>, {}).get(<span class="stringliteral">'config'</span>, <span class="keywordtype">None</span>)
<a name="l02367"></a>02367   <span class="keywordflow">if</span> gyp.common.GetFlavor(params) == <span class="stringliteral">'win'</span>:
<a name="l02368"></a>02368     target_list, target_dicts = MSVSUtil.ShardTargets(target_list, target_dicts)
<a name="l02369"></a>02369     target_list, target_dicts = MSVSUtil.InsertLargePdbShims(
<a name="l02370"></a>02370         target_list, target_dicts, generator_default_variables)
<a name="l02371"></a>02371 
<a name="l02372"></a>02372   <span class="keywordflow">if</span> user_config:
<a name="l02373"></a>02373     GenerateOutputForConfig(target_list, target_dicts, data, params,
<a name="l02374"></a>02374                             user_config)
<a name="l02375"></a>02375   <span class="keywordflow">else</span>:
<a name="l02376"></a>02376     config_names = target_dicts[target_list[0]][<span class="stringliteral">'configurations'</span>].keys()
<a name="l02377"></a>02377     <span class="keywordflow">if</span> params[<span class="stringliteral">'parallel'</span>]:
<a name="l02378"></a>02378       <span class="keywordflow">try</span>:
<a name="l02379"></a>02379         pool = multiprocessing.Pool(len(config_names))
<a name="l02380"></a>02380         arglists = []
<a name="l02381"></a>02381         <span class="keywordflow">for</span> config_name <span class="keywordflow">in</span> config_names:
<a name="l02382"></a>02382           arglists.append(
<a name="l02383"></a>02383               (target_list, target_dicts, data, params, config_name))
<a name="l02384"></a>02384         pool.map(CallGenerateOutputForConfig, arglists)
<a name="l02385"></a>02385       <span class="keywordflow">except</span> KeyboardInterrupt, e:
<a name="l02386"></a>02386         pool.terminate()
<a name="l02387"></a>02387         <span class="keywordflow">raise</span> e
<a name="l02388"></a>02388     <span class="keywordflow">else</span>:
<a name="l02389"></a>02389       <span class="keywordflow">for</span> config_name <span class="keywordflow">in</span> config_names:
<a name="l02390"></a>02390         GenerateOutputForConfig(target_list, target_dicts, data, params,
<a name="l02391"></a>02391                                 config_name)
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Wed Oct 7 19:26:26 2015 for Emeraldion Lodge (codename Zelda) by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.8 </small></address>
</body>
</html>
