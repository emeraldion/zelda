<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Emeraldion Lodge (codename Zelda): /Users/delphine/Sviluppo/SVN/emeraldion.it/zelda/helpers/MURatingsParser.php Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.5 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="classes.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
<h1>/Users/delphine/Sviluppo/SVN/emeraldion.it/zelda/helpers/MURatingsParser.php</h1><a href="_m_u_ratings_parser_8php.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00007"></a><a class="code" href="class_m_u_ratings_parser.html">00007</a> <span class="keyword">class </span><a class="code" href="class_m_u_ratings_parser.html">MURatingsParser</a> {
<a name="l00008"></a>00008 
<a name="l00009"></a><a class="code" href="class_m_u_ratings_parser.html#de61fd9b2b49cf5ab5495c0a9b5a693a">00009</a>         var <a class="code" href="class_m_u_ratings_parser.html#de61fd9b2b49cf5ab5495c0a9b5a693a">$parser</a>;
<a name="l00010"></a><a class="code" href="class_m_u_ratings_parser.html#a269c0011d4bac0119f6424149ad48f3">00010</a>         var <a class="code" href="class_m_u_ratings_parser.html#a269c0011d4bac0119f6424149ad48f3">$file</a>;
<a name="l00011"></a><a class="code" href="class_m_u_ratings_parser.html#dcce83e3c1e51d0ed7b45e5b6a1f9d14">00011</a>         var <a class="code" href="class_m_u_ratings_parser.html#dcce83e3c1e51d0ed7b45e5b6a1f9d14">$isWithinItem</a>;
<a name="l00012"></a><a class="code" href="class_m_u_ratings_parser.html#5bb19f4f1139faadf680b04638e17b99">00012</a>         var <a class="code" href="class_m_u_ratings_parser.html#5bb19f4f1139faadf680b04638e17b99">$currentItem</a>;
<a name="l00013"></a><a class="code" href="class_m_u_ratings_parser.html#0739529a350dde957e00b927d1e439e1">00013</a>         var <a class="code" href="class_m_u_ratings_parser.html#0739529a350dde957e00b927d1e439e1">$currentTag</a>;
<a name="l00014"></a><a class="code" href="class_m_u_ratings_parser.html#05357414e1e36f5268cf0db145139071">00014</a>         var <a class="code" href="class_m_u_ratings_parser.html#05357414e1e36f5268cf0db145139071">$items</a>;
<a name="l00015"></a>00015         
<a name="l00016"></a><a class="code" href="class_m_u_ratings_parser.html#7c93880c983550d0a4e99f6c3fa3755d">00016</a>         function <a class="code" href="class_m_u_ratings_parser.html#7c93880c983550d0a4e99f6c3fa3755d">MURatingsParser</a>($inFile = null) {
<a name="l00017"></a>00017                 $this-&gt;parser = null;
<a name="l00018"></a>00018                 $this-&gt;file = $inFile;
<a name="l00019"></a>00019                 $this-&gt;isWithinItem = <span class="keyword">false</span>;
<a name="l00020"></a>00020                 $this-&gt;currentItem = array();
<a name="l00021"></a>00021                 $this-&gt;items = array();
<a name="l00022"></a>00022         }
<a name="l00023"></a>00023         
<a name="l00024"></a><a class="code" href="class_m_u_ratings_parser.html#665c7eff95b99a9d0d20290282896404">00024</a>         function <a class="code" href="class_m_u_ratings_parser.html#665c7eff95b99a9d0d20290282896404">parseFile</a>($persist = <span class="keyword">false</span>) {
<a name="l00025"></a>00025                 <span class="keywordflow">if</span> (empty($this-&gt;parser)) {
<a name="l00026"></a>00026                         error_log(<span class="stringliteral">"No parser, so allocating new xml parser"</span>);
<a name="l00027"></a>00027                         $this-&gt;parser = xml_parser_create();
<a name="l00028"></a>00028                         xml_set_object($this-&gt;parser, $this);
<a name="l00029"></a>00029                         xml_set_element_handler($this-&gt;parser, <span class="stringliteral">"startHandler"</span>, <span class="stringliteral">"endHandler"</span>);
<a name="l00030"></a>00030                         xml_set_character_data_handler($this-&gt;parser, <span class="stringliteral">"cdataHandler"</span>);
<a name="l00031"></a>00031                 }
<a name="l00032"></a>00032                 
<a name="l00033"></a>00033                 <span class="keywordflow">if</span> (!empty($this-&gt;file)) {
<a name="l00034"></a>00034                         <span class="comment">// process &amp; parse</span>
<a name="l00035"></a>00035                         $fp = fopen($this-&gt;file, <span class="charliteral">'r'</span>);
<a name="l00036"></a>00036                         <span class="keywordflow">if</span> ($fp) { <span class="comment">// could read the file successfully</span>
<a name="l00037"></a>00037                                 <span class="keywordflow">while</span> ($data = fread($fp, 4096)) {
<a name="l00038"></a>00038                                         xml_parse($this-&gt;parser, $data, feof($fp)) 
<a name="l00039"></a>00039                                                 or 
<a name="l00040"></a>00040                                         error_log(sprintf(      <span class="stringliteral">"Error in parsing XML: %s at line %d"</span>, 
<a name="l00041"></a>00041                                                                                 xml_error_string(xml_get_error_code($this-&gt;parser)),
<a name="l00042"></a>00042                                                                                 xml_get_current_line_number($this-&gt;parser)));
<a name="l00043"></a>00043                                 }
<a name="l00044"></a>00044                                 fclose($fp);
<a name="l00045"></a>00045                         } <span class="keywordflow">else</span> {
<a name="l00046"></a>00046                                 error_log(<span class="stringliteral">"Could not read file (name: {$this-&gt;file})."</span>);
<a name="l00047"></a>00047                         }
<a name="l00048"></a>00048                 } <span class="keywordflow">else</span> {
<a name="l00049"></a>00049                         error_log(<span class="stringliteral">"Could not parse. No file specified."</span>);
<a name="l00050"></a>00050                 }
<a name="l00051"></a>00051                 
<a name="l00052"></a>00052                 <span class="keywordflow">if</span> (!$persist) {
<a name="l00053"></a>00053                         xml_parser_free($this-&gt;parser);
<a name="l00054"></a>00054                 }
<a name="l00055"></a>00055                 
<a name="l00056"></a>00056         }
<a name="l00057"></a>00057         
<a name="l00058"></a><a class="code" href="class_m_u_ratings_parser.html#8604be9dc7bcba45be3ddb7ca936da85">00058</a>         function <a class="code" href="class_m_u_ratings_parser.html#8604be9dc7bcba45be3ddb7ca936da85">startHandler</a>(<a class="code" href="class_m_u_ratings_parser.html#de61fd9b2b49cf5ab5495c0a9b5a693a">$parser</a>, $tagName, $attrs) {
<a name="l00059"></a>00059                 <span class="keywordflow">if</span> ($this-&gt;isWithinItem) {
<a name="l00060"></a>00060                         $this-&gt;currentTag = $tagName;
<a name="l00061"></a>00061                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($tagName == <span class="stringliteral">"ITEM"</span>) {
<a name="l00062"></a>00062                         $this-&gt;isWithinItem = <span class="keyword">true</span>;
<a name="l00063"></a>00063                 }
<a name="l00064"></a>00064         }
<a name="l00065"></a>00065         
<a name="l00066"></a><a class="code" href="class_m_u_ratings_parser.html#1bc750c56ddacfbade6e49689b5077b8">00066</a>         function <a class="code" href="class_m_u_ratings_parser.html#1bc750c56ddacfbade6e49689b5077b8">endHandler</a>(<a class="code" href="class_m_u_ratings_parser.html#de61fd9b2b49cf5ab5495c0a9b5a693a">$parser</a>, $tagName)  {
<a name="l00067"></a>00067                 <span class="keywordflow">if</span> ($tagName == <span class="stringliteral">"ITEM"</span>) {
<a name="l00068"></a>00068                         $this-&gt;items[] = $this-&gt;currentItem; <span class="comment">// could be $this-&gt;items[$this-&gt;currentItem['title']] = $this-&gt;currentItem to use titles as keys</span>
<a name="l00069"></a>00069                         $this-&gt;currentItem = array();
<a name="l00070"></a>00070                         $this-&gt;currentTag = <span class="stringliteral">''</span>;
<a name="l00071"></a>00071                         $this-&gt;isWithinItem = <span class="keyword">false</span>;
<a name="l00072"></a>00072                 }
<a name="l00073"></a>00073         }
<a name="l00074"></a>00074         
<a name="l00075"></a><a class="code" href="class_m_u_ratings_parser.html#f32ae2443bc083ada7772ed1678a7912">00075</a>         function <a class="code" href="class_m_u_ratings_parser.html#f32ae2443bc083ada7772ed1678a7912">cdataHandler</a>(<a class="code" href="class_m_u_ratings_parser.html#de61fd9b2b49cf5ab5495c0a9b5a693a">$parser</a>, $cdata) {
<a name="l00076"></a>00076                 <span class="keywordflow">if</span> ($this-&gt;isWithinItem) {
<a name="l00077"></a>00077                         $trimmedData = trim($cdata);
<a name="l00078"></a>00078                         <span class="keywordflow">if</span> (!empty($trimmedData) &amp;&amp; isset($this-&gt;currentTag) &amp;&amp; !empty($this-&gt;currentTag)) {
<a name="l00079"></a>00079                                 <span class="keywordflow">if</span> (!isset($this-&gt;currentItem[strtolower($this-&gt;currentTag)]))
<a name="l00080"></a>00080                                 {
<a name="l00081"></a>00081                                         $this-&gt;currentItem[strtolower($this-&gt;currentTag)] = <span class="stringliteral">""</span>;
<a name="l00082"></a>00082                                 }
<a name="l00083"></a>00083                                 $this-&gt;currentItem[strtolower($this-&gt;currentTag)] .= $trimmedData;
<a name="l00084"></a>00084                         }
<a name="l00085"></a>00085                 }
<a name="l00086"></a>00086         }
<a name="l00087"></a>00087         
<a name="l00088"></a><a class="code" href="class_m_u_ratings_parser.html#2dc68b2a053461cba82f2693e8eb14c9">00088</a>         function <a class="code" href="class_m_u_ratings_parser.html#2dc68b2a053461cba82f2693e8eb14c9">release</a>() {
<a name="l00089"></a>00089                 xml_parser_free($this-&gt;parser);
<a name="l00090"></a>00090                 unset($this);
<a name="l00091"></a>00091         }
<a name="l00092"></a>00092         
<a name="l00093"></a><a class="code" href="class_m_u_ratings_parser.html#bac72ce2acec3a5edc81157d74c15893">00093</a>         function <a class="code" href="class_m_u_ratings_parser.html#bac72ce2acec3a5edc81157d74c15893">hasItems</a>() {
<a name="l00094"></a>00094                 <span class="keywordflow">return</span> (count($this-&gt;items) &gt; 0);
<a name="l00095"></a>00095         }
<a name="l00096"></a>00096 
<a name="l00097"></a>00097                 <span class="comment">// this method should be overloaded to produce the desired content</span>
<a name="l00098"></a><a class="code" href="class_m_u_ratings_parser.html#1529a9223ed7dc7c3c999fcae93b35a8">00098</a>         function <a class="code" href="class_m_u_ratings_parser.html#1529a9223ed7dc7c3c999fcae93b35a8">formatRating</a>(&amp;$item) {
<a name="l00099"></a>00099                 <span class="comment">// do the work of actually producing (HTML) representation of a rating</span>
<a name="l00100"></a>00100         }
<a name="l00101"></a>00101         
<a name="l00102"></a><a class="code" href="class_m_u_ratings_parser.html#2bb4a4bec4acdae3919b35ae9d5bc0f6">00102</a>         function <a class="code" href="class_m_u_ratings_parser.html#2bb4a4bec4acdae3919b35ae9d5bc0f6">ratingForTitle</a>($title) {
<a name="l00103"></a>00103                 $lambda_form = <span class="stringliteral">"return (strtolower(\$elt['title']) === strtolower('$title'));"</span>;
<a name="l00104"></a>00104                 <span class="keywordflow">return</span> reset(array_filter($this-&gt;items, create_function(<span class="stringliteral">'$elt'</span>, $lambda_form)));
<a name="l00105"></a>00105         }
<a name="l00106"></a>00106         
<a name="l00107"></a><a class="code" href="class_m_u_ratings_parser.html#ac574cb8d1850ab82245ced54d33f0aa">00107</a>         function <a class="code" href="class_m_u_ratings_parser.html#ac574cb8d1850ab82245ced54d33f0aa">ratingsList</a>($withTitles = <span class="keyword">true</span>) {
<a name="l00108"></a>00108                 $results = array();
<a name="l00109"></a>00109                 <span class="keywordflow">foreach</span>($this-&gt;items as <a class="code" href="__navbar_8php.html#83018d9153d17d91fbcf3bc10158d34f">$i</a>) {
<a name="l00110"></a>00110                         <span class="keywordflow">if</span> ($withTitles) {
<a name="l00111"></a>00111                                 $results[$i[<span class="stringliteral">'title'</span>]] = $i; <span class="comment">//['description'];</span>
<a name="l00112"></a>00112                         } <span class="keywordflow">else</span> {
<a name="l00113"></a>00113                                 $results[] = $i; <span class="comment">//['description'];</span>
<a name="l00114"></a>00114                         }
<a name="l00115"></a>00115                 }
<a name="l00116"></a>00116                 <span class="keywordflow">return</span> $results;
<a name="l00117"></a>00117         }
<a name="l00118"></a>00118         
<a name="l00119"></a><a class="code" href="class_m_u_ratings_parser.html#df2366d5f603f0c7bb5b0becb7703b7b">00119</a>         function <a class="code" href="class_m_u_ratings_parser.html#df2366d5f603f0c7bb5b0becb7703b7b">ratingsValues</a>($withTitles = <span class="keyword">true</span>) {
<a name="l00120"></a>00120                 $results = array();
<a name="l00121"></a>00121                 <span class="keywordflow">foreach</span>($this-&gt;items as <a class="code" href="__navbar_8php.html#83018d9153d17d91fbcf3bc10158d34f">$i</a>) {
<a name="l00122"></a>00122                         <span class="keywordflow">if</span> ($withTitles) {
<a name="l00123"></a>00123                                 $results[$i[<span class="stringliteral">'title'</span>]] = $i[<span class="stringliteral">'description'</span>];
<a name="l00124"></a>00124                         } <span class="keywordflow">else</span> {
<a name="l00125"></a>00125                                 $results[] = $i[<span class="stringliteral">'description'</span>];
<a name="l00126"></a>00126                         }
<a name="l00127"></a>00127                 }
<a name="l00128"></a>00128                 <span class="keywordflow">return</span> $results;
<a name="l00129"></a>00129         }
<a name="l00130"></a>00130         
<a name="l00131"></a><a class="code" href="class_m_u_ratings_parser.html#0c16c71f4f12cde1592d6332d0649b55">00131</a>         function <a class="code" href="class_m_u_ratings_parser.html#0c16c71f4f12cde1592d6332d0649b55">writeRatingOutput</a>($title) {
<a name="l00132"></a>00132                 $output = <span class="stringliteral">''</span>;
<a name="l00133"></a>00133                 $theItem = $this-&gt;<a class="code" href="class_m_u_ratings_parser.html#2bb4a4bec4acdae3919b35ae9d5bc0f6">ratingForTitle</a>($title);
<a name="l00134"></a>00134                 <span class="keywordflow">if</span> (empty($theItem)) {
<a name="l00135"></a>00135                         error_log(<span class="stringliteral">"Could not get information for title [$title]"</span>);
<a name="l00136"></a>00136                 } <span class="keywordflow">else</span> {
<a name="l00137"></a>00137                         $rating = $theItem[<span class="stringliteral">'description'</span>];
<a name="l00138"></a>00138                         $formattedRating = number_format($rating, 1);
<a name="l00139"></a>00139                         $roundedRating = round(($rating * 2), 0) / 2;
<a name="l00140"></a>00140                         <a class="code" href="__macupdate_8php.html#8f86a082e29bfc1c2312ef82a6a7104f">$stars</a> = <span class="stringliteral">"http://www.macupdate.com/images/"</span> . (($roundedRating &gt;= 1) ? <span class="stringliteral">"stars{$roundedRating}.gif"</span> : <span class="stringliteral">"stars0.gif"</span>);
<a name="l00141"></a>00141                         $output = <span class="stringliteral">"&lt;div style='width: 125px; font-family: Geneva, Helvetica, sans-serif; border: dotted 1px #cccccc;'&gt;\n"</span>;
<a name="l00142"></a>00142                         $output .= <span class="stringliteral">"&lt;div&gt;&lt;a href='{$theItem['link']}'&gt;&lt;img alt='$roundedRating stars' src='$stars' border='0'&gt;&lt;/a&gt; &lt;span style='font-size: 8pt;'&gt;($formattedRating)&lt;/span&gt;&lt;/div&gt;\n"</span>;
<a name="l00143"></a>00143                         $output .= <span class="stringliteral">"&lt;div style='text-align: center;'&gt;&lt;a href='{$theItem['link']}' style='text-decoration: none; font-weight: bold; font-size: 10pt; color: black;'&gt;MacUpdate&lt;/a&gt;&lt;/div&gt;\n"</span>;
<a name="l00144"></a>00144                         $output .= <span class="stringliteral">"&lt;/div&gt;\n\n"</span>;
<a name="l00145"></a>00145                 }               
<a name="l00146"></a>00146                 <span class="keywordflow">return</span> $output;
<a name="l00147"></a>00147         }
<a name="l00148"></a>00148         
<a name="l00149"></a><a class="code" href="class_m_u_ratings_parser.html#f241a0002c8c9fe92fb924f955df0196">00149</a>         function <a class="code" href="class_m_u_ratings_parser.html#f241a0002c8c9fe92fb924f955df0196">debug</a>() {
<a name="l00150"></a>00150                 $out = <span class="stringliteral">"&lt;table&gt;"</span>;
<a name="l00151"></a>00151                 $out .= <span class="stringliteral">"&lt;tr&gt;&lt;td&gt;(key)&lt;/td&gt;&lt;td&gt;title&lt;/td&gt;&lt;td&gt;descr&lt;/td&gt;&lt;td&gt;link&lt;/td&gt;&lt;td&gt;pubdate&lt;/td&gt;&lt;/tr&gt;\n"</span>;
<a name="l00152"></a>00152                 <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="class_m_u_ratings_parser.html#bac72ce2acec3a5edc81157d74c15893">hasItems</a>()) {
<a name="l00153"></a>00153                         <span class="keywordflow">foreach</span>($this-&gt;items as $k =&gt; $item) {
<a name="l00154"></a>00154                                 $out .= <span class="stringliteral">"&lt;tr&gt;&lt;td&gt;$k&lt;/td&gt;&lt;td&gt;{$item['title']}&lt;/td&gt;&lt;td&gt;{$item['description']}&lt;/td&gt;&lt;td&gt;{$item['link']}&lt;/td&gt;&lt;td&gt;{$item['pubdate']}&lt;/td&gt;&lt;/tr&gt;\n"</span>;
<a name="l00155"></a>00155                         }
<a name="l00156"></a>00156                 } <span class="keywordflow">else</span> {
<a name="l00157"></a>00157                         $out .= <span class="stringliteral">"&lt;tr&gt;&lt;td colspan='5'&gt;There are no items&lt;/td&gt;&lt;/tr&gt;"</span>;
<a name="l00158"></a>00158                 }
<a name="l00159"></a>00159                 $out .= <span class="stringliteral">"&lt;/table&gt;"</span>;
<a name="l00160"></a>00160                 
<a name="l00161"></a>00161                 <span class="keywordflow">return</span> $out;
<a name="l00162"></a>00162         }
<a name="l00163"></a>00163 
<a name="l00164"></a>00164 }
<a name="l00165"></a>00165 
<a name="l00166"></a>00166 ?&gt;
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Mon May 5 23:47:20 2008 for Emeraldion Lodge (codename Zelda) by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.5 </small></address>
</body>
</html>
