<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Emeraldion Lodge (codename Zelda): /Users/delphine/Development/SVN/emeraldion.it/zelda/node_modules/gulp-sass/node_modules/node-sass/node_modules/node-gyp/gyp/pylib/gyp/generator/make.py Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css">
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.8 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="../../main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="../../files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="../../globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>/Users/delphine/Development/SVN/emeraldion.it/zelda/node_modules/gulp-sass/node_modules/node-sass/node_modules/node-gyp/gyp/pylib/gyp/generator/make.py</h1><a href="../../d3/de4/make_8py.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html">00001</a> <span class="comment"># Copyright (c) 2013 Google Inc. All rights reserved.</span>
<a name="l00002"></a>00002 <span class="comment"># Use of this source code is governed by a BSD-style license that can be</span>
<a name="l00003"></a>00003 <span class="comment"># found in the LICENSE file.</span>
<a name="l00004"></a>00004 
<a name="l00005"></a>00005 <span class="comment"># Notes:</span>
<a name="l00006"></a>00006 <span class="comment">#</span>
<a name="l00007"></a>00007 <span class="comment"># This is all roughly based on the Makefile system used by the Linux</span>
<a name="l00008"></a>00008 <span class="comment"># kernel, but is a non-recursive make -- we put the entire dependency</span>
<a name="l00009"></a>00009 <span class="comment"># graph in front of make and let it figure it out.</span>
<a name="l00010"></a>00010 <span class="comment">#</span>
<a name="l00011"></a>00011 <span class="comment"># The code below generates a separate .mk file for each target, but</span>
<a name="l00012"></a>00012 <span class="comment"># all are sourced by the top-level Makefile.  This means that all</span>
<a name="l00013"></a>00013 <span class="comment"># variables in .mk-files clobber one another.  Be careful to use :=</span>
<a name="l00014"></a>00014 <span class="comment"># where appropriate for immediate evaluation, and similarly to watch</span>
<a name="l00015"></a>00015 <span class="comment"># that you're not relying on a variable value to last beween different</span>
<a name="l00016"></a>00016 <span class="comment"># .mk files.</span>
<a name="l00017"></a>00017 <span class="comment">#</span>
<a name="l00018"></a>00018 <span class="comment"># TODOs:</span>
<a name="l00019"></a>00019 <span class="comment">#</span>
<a name="l00020"></a>00020 <span class="comment"># Global settings and utility functions are currently stuffed in the</span>
<a name="l00021"></a>00021 <span class="comment"># toplevel Makefile.  It may make sense to generate some .mk files on</span>
<a name="l00022"></a>00022 <span class="comment"># the side to keep the the files readable.</span>
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 <span class="keyword">import</span> os
<a name="l00025"></a>00025 <span class="keyword">import</span> re
<a name="l00026"></a>00026 <span class="keyword">import</span> sys
<a name="l00027"></a>00027 <span class="keyword">import</span> subprocess
<a name="l00028"></a>00028 <span class="keyword">import</span> gyp
<a name="l00029"></a>00029 <span class="keyword">import</span> gyp.common
<a name="l00030"></a>00030 <span class="keyword">import</span> gyp.xcode_emulation
<a name="l00031"></a>00031 <span class="keyword">from</span> gyp.common <span class="keyword">import</span> GetEnvironFallback
<a name="l00032"></a>00032 <span class="keyword">from</span> gyp.common <span class="keyword">import</span> GypError
<a name="l00033"></a>00033 
<a name="l00034"></a><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#723b572dde78d9a873e8b0c7936f0624">00034</a> generator_default_variables = {
<a name="l00035"></a>00035   <span class="stringliteral">'EXECUTABLE_PREFIX'</span>: <span class="stringliteral">''</span>,
<a name="l00036"></a>00036   <span class="stringliteral">'EXECUTABLE_SUFFIX'</span>: <span class="stringliteral">''</span>,
<a name="l00037"></a>00037   <span class="stringliteral">'STATIC_LIB_PREFIX'</span>: <span class="stringliteral">'lib'</span>,
<a name="l00038"></a>00038   <span class="stringliteral">'SHARED_LIB_PREFIX'</span>: <span class="stringliteral">'lib'</span>,
<a name="l00039"></a>00039   <span class="stringliteral">'STATIC_LIB_SUFFIX'</span>: <span class="stringliteral">'.a'</span>,
<a name="l00040"></a>00040   <span class="stringliteral">'INTERMEDIATE_DIR'</span>: <span class="stringliteral">'$(obj).$(TOOLSET)/$(TARGET)/geni'</span>,
<a name="l00041"></a>00041   <span class="stringliteral">'SHARED_INTERMEDIATE_DIR'</span>: <span class="stringliteral">'$(obj)/gen'</span>,
<a name="l00042"></a>00042   <span class="stringliteral">'PRODUCT_DIR'</span>: <span class="stringliteral">'$(builddir)'</span>,
<a name="l00043"></a>00043   <span class="stringliteral">'RULE_INPUT_ROOT'</span>: <span class="stringliteral">'%(INPUT_ROOT)s'</span>,  <span class="comment"># This gets expanded by Python.</span>
<a name="l00044"></a>00044   <span class="stringliteral">'RULE_INPUT_DIRNAME'</span>: <span class="stringliteral">'%(INPUT_DIRNAME)s'</span>,  <span class="comment"># This gets expanded by Python.</span>
<a name="l00045"></a>00045   <span class="stringliteral">'RULE_INPUT_PATH'</span>: <span class="stringliteral">'$(abspath $&lt;)'</span>,
<a name="l00046"></a>00046   <span class="stringliteral">'RULE_INPUT_EXT'</span>: <span class="stringliteral">'$(suffix $&lt;)'</span>,
<a name="l00047"></a>00047   <span class="stringliteral">'RULE_INPUT_NAME'</span>: <span class="stringliteral">'$(notdir $&lt;)'</span>,
<a name="l00048"></a>00048   <span class="stringliteral">'CONFIGURATION_NAME'</span>: <span class="stringliteral">'$(BUILDTYPE)'</span>,
<a name="l00049"></a>00049 }
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 <span class="comment"># Make supports multiple toolsets</span>
<a name="l00052"></a><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#2a27e7ea491d98a767cd9e3dc28eeb83">00052</a> generator_supports_multiple_toolsets = <span class="keyword">True</span>
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 <span class="comment"># Request sorted dependencies in the order from dependents to dependencies.</span>
<a name="l00055"></a><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#c8168eedd792156024be41b025807818">00055</a> generator_wants_sorted_dependencies = <span class="keyword">False</span>
<a name="l00056"></a>00056 
<a name="l00057"></a>00057 <span class="comment"># Placates pylint.</span>
<a name="l00058"></a><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#e3f6c5e948c3816610850b3c89f2dee4">00058</a> generator_additional_non_configuration_keys = []
<a name="l00059"></a><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#1753481de22edc303822a2b99c378ecf">00059</a> generator_additional_path_sections = []
<a name="l00060"></a><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#e251ca3560612ed2140aea36d2b236fc">00060</a> generator_extra_sources_for_rules = []
<a name="l00061"></a><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#1f2968cb1008020af59e51e6bc806679">00061</a> generator_filelist_paths = <span class="keywordtype">None</span>
<a name="l00062"></a>00062 
<a name="l00063"></a>00063 
<a name="l00064"></a><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#d955de067fa5f8d3a006ac169f6609ef">00064</a> <span class="keyword">def </span><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#d955de067fa5f8d3a006ac169f6609ef">CalculateVariables</a>(default_variables, params):
<a name="l00065"></a>00065   <span class="stringliteral">"""Calculate additional variables for use in the build (called by gyp)."""</span>
<a name="l00066"></a>00066   flavor = gyp.common.GetFlavor(params)
<a name="l00067"></a>00067   <span class="keywordflow">if</span> flavor == <span class="stringliteral">'mac'</span>:
<a name="l00068"></a>00068     default_variables.setdefault(<span class="stringliteral">'OS'</span>, <span class="stringliteral">'mac'</span>)
<a name="l00069"></a>00069     default_variables.setdefault(<span class="stringliteral">'SHARED_LIB_SUFFIX'</span>, <span class="stringliteral">'.dylib'</span>)
<a name="l00070"></a>00070     default_variables.setdefault(<span class="stringliteral">'SHARED_LIB_DIR'</span>,
<a name="l00071"></a>00071                                  generator_default_variables[<span class="stringliteral">'PRODUCT_DIR'</span>])
<a name="l00072"></a>00072     default_variables.setdefault(<span class="stringliteral">'LIB_DIR'</span>,
<a name="l00073"></a>00073                                  generator_default_variables[<span class="stringliteral">'PRODUCT_DIR'</span>])
<a name="l00074"></a>00074 
<a name="l00075"></a>00075     <span class="comment"># Copy additional generator configuration data from Xcode, which is shared</span>
<a name="l00076"></a>00076     <span class="comment"># by the Mac Make generator.</span>
<a name="l00077"></a>00077     <span class="keyword">import</span> gyp.generator.xcode <span class="keyword">as</span> xcode_generator
<a name="l00078"></a>00078     <span class="keyword">global</span> generator_additional_non_configuration_keys
<a name="l00079"></a>00079     generator_additional_non_configuration_keys = getattr(xcode_generator,
<a name="l00080"></a>00080         <span class="stringliteral">'generator_additional_non_configuration_keys'</span>, [])
<a name="l00081"></a>00081     <span class="keyword">global</span> generator_additional_path_sections
<a name="l00082"></a>00082     generator_additional_path_sections = getattr(xcode_generator,
<a name="l00083"></a>00083         <span class="stringliteral">'generator_additional_path_sections'</span>, [])
<a name="l00084"></a>00084     <span class="keyword">global</span> generator_extra_sources_for_rules
<a name="l00085"></a>00085     generator_extra_sources_for_rules = getattr(xcode_generator,
<a name="l00086"></a>00086         <span class="stringliteral">'generator_extra_sources_for_rules'</span>, [])
<a name="l00087"></a>00087     COMPILABLE_EXTENSIONS.update({<span class="stringliteral">'.m'</span>: <span class="stringliteral">'objc'</span>, <span class="stringliteral">'.mm'</span> : <span class="stringliteral">'objcxx'</span>})
<a name="l00088"></a>00088   <span class="keywordflow">else</span>:
<a name="l00089"></a>00089     operating_system = flavor
<a name="l00090"></a>00090     <span class="keywordflow">if</span> flavor == <span class="stringliteral">'android'</span>:
<a name="l00091"></a>00091       operating_system = <span class="stringliteral">'linux'</span>  <span class="comment"># Keep this legacy behavior for now.</span>
<a name="l00092"></a>00092     default_variables.setdefault(<span class="stringliteral">'OS'</span>, operating_system)
<a name="l00093"></a>00093     default_variables.setdefault(<span class="stringliteral">'SHARED_LIB_SUFFIX'</span>, <span class="stringliteral">'.so'</span>)
<a name="l00094"></a>00094     default_variables.setdefault(<span class="stringliteral">'SHARED_LIB_DIR'</span>,<span class="stringliteral">'$(builddir)/lib.$(TOOLSET)'</span>)
<a name="l00095"></a>00095     default_variables.setdefault(<span class="stringliteral">'LIB_DIR'</span>, <span class="stringliteral">'$(obj).$(TOOLSET)'</span>)
<a name="l00096"></a>00096 
<a name="l00097"></a>00097 
<a name="l00098"></a><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#6b2b0e6c86990d487b612530a282a88f">00098</a> <span class="keyword">def </span><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#6b2b0e6c86990d487b612530a282a88f">CalculateGeneratorInputInfo</a>(params):
<a name="l00099"></a>00099   <span class="stringliteral">"""Calculate the generator specific info that gets fed to input (called by</span>
<a name="l00100"></a>00100 <span class="stringliteral">  gyp)."""</span>
<a name="l00101"></a>00101   generator_flags = params.get(<span class="stringliteral">'generator_flags'</span>, {})
<a name="l00102"></a>00102   android_ndk_version = generator_flags.get(<span class="stringliteral">'android_ndk_version'</span>, <span class="keywordtype">None</span>)
<a name="l00103"></a>00103   <span class="comment"># Android NDK requires a strict link order.</span>
<a name="l00104"></a>00104   <span class="keywordflow">if</span> android_ndk_version:
<a name="l00105"></a>00105     <span class="keyword">global</span> generator_wants_sorted_dependencies
<a name="l00106"></a>00106     generator_wants_sorted_dependencies = <span class="keyword">True</span>
<a name="l00107"></a>00107 
<a name="l00108"></a>00108   output_dir = params[<span class="stringliteral">'options'</span>].generator_output <span class="keywordflow">or</span> \
<a name="l00109"></a>00109                params[<span class="stringliteral">'options'</span>].toplevel_dir
<a name="l00110"></a>00110   builddir_name = generator_flags.get(<span class="stringliteral">'output_dir'</span>, <span class="stringliteral">'out'</span>)
<a name="l00111"></a>00111   qualified_out_dir = os.path.normpath(os.path.join(
<a name="l00112"></a>00112     output_dir, builddir_name, <span class="stringliteral">'gypfiles'</span>))
<a name="l00113"></a>00113 
<a name="l00114"></a>00114   <span class="keyword">global</span> generator_filelist_paths
<a name="l00115"></a>00115   generator_filelist_paths = {
<a name="l00116"></a>00116     <span class="stringliteral">'toplevel'</span>: params[<span class="stringliteral">'options'</span>].toplevel_dir,
<a name="l00117"></a>00117     <span class="stringliteral">'qualified_out_dir'</span>: qualified_out_dir,
<a name="l00118"></a>00118   }
<a name="l00119"></a>00119 
<a name="l00120"></a>00120 
<a name="l00121"></a>00121 <span class="comment"># The .d checking code below uses these functions:</span>
<a name="l00122"></a>00122 <span class="comment"># wildcard, sort, foreach, shell, wordlist</span>
<a name="l00123"></a>00123 <span class="comment"># wildcard can handle spaces, the rest can't.</span>
<a name="l00124"></a>00124 <span class="comment"># Since I could find no way to make foreach work with spaces in filenames</span>
<a name="l00125"></a>00125 <span class="comment"># correctly, the .d files have spaces replaced with another character. The .d</span>
<a name="l00126"></a>00126 <span class="comment"># file for</span>
<a name="l00127"></a>00127 <span class="comment">#     Chromium\ Framework.framework/foo</span>
<a name="l00128"></a>00128 <span class="comment"># is for example</span>
<a name="l00129"></a>00129 <span class="comment">#     out/Release/.deps/out/Release/Chromium?Framework.framework/foo</span>
<a name="l00130"></a>00130 <span class="comment"># This is the replacement character.</span>
<a name="l00131"></a><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#82b4dca7c9c964370ff1abf959f02f4e">00131</a> SPACE_REPLACEMENT = <span class="stringliteral">'?'</span>
<a name="l00132"></a>00132 
<a name="l00133"></a>00133 
<a name="l00134"></a><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#9f7a3e0bcd19259577ae1aea02688557">00134</a> LINK_COMMANDS_LINUX = <span class="stringliteral">"""\</span>
<a name="l00135"></a>00135 <span class="stringliteral">quiet_cmd_alink = AR($(TOOLSET)) $@</span>
<a name="l00136"></a>00136 <span class="stringliteral">cmd_alink = rm -f $@ &amp;&amp; $(AR.$(TOOLSET)) crs $@ $(filter %.o,$^)</span>
<a name="l00137"></a>00137 <span class="stringliteral"></span>
<a name="l00138"></a>00138 <span class="stringliteral">quiet_cmd_alink_thin = AR($(TOOLSET)) $@</span>
<a name="l00139"></a>00139 <span class="stringliteral">cmd_alink_thin = rm -f $@ &amp;&amp; $(AR.$(TOOLSET)) crsT $@ $(filter %.o,$^)</span>
<a name="l00140"></a>00140 <span class="stringliteral"></span>
<a name="l00141"></a>00141 <span class="stringliteral"># Due to circular dependencies between libraries :(, we wrap the</span>
<a name="l00142"></a>00142 <span class="stringliteral"># special "figure out circular dependencies" flags around the entire</span>
<a name="l00143"></a>00143 <span class="stringliteral"># input list during linking.</span>
<a name="l00144"></a>00144 <span class="stringliteral">quiet_cmd_link = LINK($(TOOLSET)) $@</span>
<a name="l00145"></a>00145 <span class="stringliteral">cmd_link = $(LINK.$(TOOLSET)) $(GYP_LDFLAGS) $(LDFLAGS.$(TOOLSET)) -o $@ -Wl,--start-group $(LD_INPUTS) -Wl,--end-group $(LIBS)</span>
<a name="l00146"></a>00146 <span class="stringliteral"></span>
<a name="l00147"></a>00147 <span class="stringliteral"># We support two kinds of shared objects (.so):</span>
<a name="l00148"></a>00148 <span class="stringliteral"># 1) shared_library, which is just bundling together many dependent libraries</span>
<a name="l00149"></a>00149 <span class="stringliteral"># into a link line.</span>
<a name="l00150"></a>00150 <span class="stringliteral"># 2) loadable_module, which is generating a module intended for dlopen().</span>
<a name="l00151"></a>00151 <span class="stringliteral">#</span>
<a name="l00152"></a>00152 <span class="stringliteral"># They differ only slightly:</span>
<a name="l00153"></a>00153 <span class="stringliteral"># In the former case, we want to package all dependent code into the .so.</span>
<a name="l00154"></a>00154 <span class="stringliteral"># In the latter case, we want to package just the API exposed by the</span>
<a name="l00155"></a>00155 <span class="stringliteral"># outermost module.</span>
<a name="l00156"></a>00156 <span class="stringliteral"># This means shared_library uses --whole-archive, while loadable_module doesn't.</span>
<a name="l00157"></a>00157 <span class="stringliteral"># (Note that --whole-archive is incompatible with the --start-group used in</span>
<a name="l00158"></a>00158 <span class="stringliteral"># normal linking.)</span>
<a name="l00159"></a>00159 <span class="stringliteral"></span>
<a name="l00160"></a>00160 <span class="stringliteral"># Other shared-object link notes:</span>
<a name="l00161"></a>00161 <span class="stringliteral"># - Set SONAME to the library filename so our binaries don't reference</span>
<a name="l00162"></a>00162 <span class="stringliteral"># the local, absolute paths used on the link command-line.</span>
<a name="l00163"></a>00163 <span class="stringliteral">quiet_cmd_solink = SOLINK($(TOOLSET)) $@</span>
<a name="l00164"></a>00164 <span class="stringliteral">cmd_solink = $(LINK.$(TOOLSET)) -shared $(GYP_LDFLAGS) $(LDFLAGS.$(TOOLSET)) -Wl,-soname=$(@F) -o $@ -Wl,--whole-archive $(LD_INPUTS) -Wl,--no-whole-archive $(LIBS)</span>
<a name="l00165"></a>00165 <span class="stringliteral"></span>
<a name="l00166"></a>00166 <span class="stringliteral">quiet_cmd_solink_module = SOLINK_MODULE($(TOOLSET)) $@</span>
<a name="l00167"></a>00167 <span class="stringliteral">cmd_solink_module = $(LINK.$(TOOLSET)) -shared $(GYP_LDFLAGS) $(LDFLAGS.$(TOOLSET)) -Wl,-soname=$(@F) -o $@ -Wl,--start-group $(filter-out FORCE_DO_CMD, $^) -Wl,--end-group $(LIBS)</span>
<a name="l00168"></a>00168 <span class="stringliteral">"""</span>
<a name="l00169"></a>00169 
<a name="l00170"></a><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#869489663bed8122b0240a57dca3afb9">00170</a> LINK_COMMANDS_MAC = <span class="stringliteral">"""\</span>
<a name="l00171"></a>00171 <span class="stringliteral">quiet_cmd_alink = LIBTOOL-STATIC $@</span>
<a name="l00172"></a>00172 <span class="stringliteral">cmd_alink = rm -f $@ &amp;&amp; ./gyp-mac-tool filter-libtool libtool $(GYP_LIBTOOLFLAGS) -static -o $@ $(filter %.o,$^)</span>
<a name="l00173"></a>00173 <span class="stringliteral"></span>
<a name="l00174"></a>00174 <span class="stringliteral">quiet_cmd_link = LINK($(TOOLSET)) $@</span>
<a name="l00175"></a>00175 <span class="stringliteral">cmd_link = $(LINK.$(TOOLSET)) $(GYP_LDFLAGS) $(LDFLAGS.$(TOOLSET)) -o "$@" $(LD_INPUTS) $(LIBS)</span>
<a name="l00176"></a>00176 <span class="stringliteral"></span>
<a name="l00177"></a>00177 <span class="stringliteral">quiet_cmd_solink = SOLINK($(TOOLSET)) $@</span>
<a name="l00178"></a>00178 <span class="stringliteral">cmd_solink = $(LINK.$(TOOLSET)) -shared $(GYP_LDFLAGS) $(LDFLAGS.$(TOOLSET)) -o "$@" $(LD_INPUTS) $(LIBS)</span>
<a name="l00179"></a>00179 <span class="stringliteral"></span>
<a name="l00180"></a>00180 <span class="stringliteral">quiet_cmd_solink_module = SOLINK_MODULE($(TOOLSET)) $@</span>
<a name="l00181"></a>00181 <span class="stringliteral">cmd_solink_module = $(LINK.$(TOOLSET)) -bundle $(GYP_LDFLAGS) $(LDFLAGS.$(TOOLSET)) -o $@ $(filter-out FORCE_DO_CMD, $^) $(LIBS)</span>
<a name="l00182"></a>00182 <span class="stringliteral">"""</span>
<a name="l00183"></a>00183 
<a name="l00184"></a><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#84ab0c1e49c53e732beafa867506f1da">00184</a> LINK_COMMANDS_ANDROID = <span class="stringliteral">"""\</span>
<a name="l00185"></a>00185 <span class="stringliteral">quiet_cmd_alink = AR($(TOOLSET)) $@</span>
<a name="l00186"></a>00186 <span class="stringliteral">cmd_alink = rm -f $@ &amp;&amp; $(AR.$(TOOLSET)) crs $@ $(filter %.o,$^)</span>
<a name="l00187"></a>00187 <span class="stringliteral"></span>
<a name="l00188"></a>00188 <span class="stringliteral">quiet_cmd_alink_thin = AR($(TOOLSET)) $@</span>
<a name="l00189"></a>00189 <span class="stringliteral">cmd_alink_thin = rm -f $@ &amp;&amp; $(AR.$(TOOLSET)) crsT $@ $(filter %.o,$^)</span>
<a name="l00190"></a>00190 <span class="stringliteral"></span>
<a name="l00191"></a>00191 <span class="stringliteral"># Due to circular dependencies between libraries :(, we wrap the</span>
<a name="l00192"></a>00192 <span class="stringliteral"># special "figure out circular dependencies" flags around the entire</span>
<a name="l00193"></a>00193 <span class="stringliteral"># input list during linking.</span>
<a name="l00194"></a>00194 <span class="stringliteral">quiet_cmd_link = LINK($(TOOLSET)) $@</span>
<a name="l00195"></a>00195 <span class="stringliteral">quiet_cmd_link_host = LINK($(TOOLSET)) $@</span>
<a name="l00196"></a>00196 <span class="stringliteral">cmd_link = $(LINK.$(TOOLSET)) $(GYP_LDFLAGS) $(LDFLAGS.$(TOOLSET)) -o $@ -Wl,--start-group $(LD_INPUTS) -Wl,--end-group $(LIBS)</span>
<a name="l00197"></a>00197 <span class="stringliteral">cmd_link_host = $(LINK.$(TOOLSET)) $(GYP_LDFLAGS) $(LDFLAGS.$(TOOLSET)) -o $@ $(LD_INPUTS) $(LIBS)</span>
<a name="l00198"></a>00198 <span class="stringliteral"></span>
<a name="l00199"></a>00199 <span class="stringliteral"># Other shared-object link notes:</span>
<a name="l00200"></a>00200 <span class="stringliteral"># - Set SONAME to the library filename so our binaries don't reference</span>
<a name="l00201"></a>00201 <span class="stringliteral"># the local, absolute paths used on the link command-line.</span>
<a name="l00202"></a>00202 <span class="stringliteral">quiet_cmd_solink = SOLINK($(TOOLSET)) $@</span>
<a name="l00203"></a>00203 <span class="stringliteral">cmd_solink = $(LINK.$(TOOLSET)) -shared $(GYP_LDFLAGS) $(LDFLAGS.$(TOOLSET)) -Wl,-soname=$(@F) -o $@ -Wl,--whole-archive $(LD_INPUTS) -Wl,--no-whole-archive $(LIBS)</span>
<a name="l00204"></a>00204 <span class="stringliteral"></span>
<a name="l00205"></a>00205 <span class="stringliteral">quiet_cmd_solink_module = SOLINK_MODULE($(TOOLSET)) $@</span>
<a name="l00206"></a>00206 <span class="stringliteral">cmd_solink_module = $(LINK.$(TOOLSET)) -shared $(GYP_LDFLAGS) $(LDFLAGS.$(TOOLSET)) -Wl,-soname=$(@F) -o $@ -Wl,--start-group $(filter-out FORCE_DO_CMD, $^) -Wl,--end-group $(LIBS)</span>
<a name="l00207"></a>00207 <span class="stringliteral">quiet_cmd_solink_module_host = SOLINK_MODULE($(TOOLSET)) $@</span>
<a name="l00208"></a>00208 <span class="stringliteral">cmd_solink_module_host = $(LINK.$(TOOLSET)) -shared $(GYP_LDFLAGS) $(LDFLAGS.$(TOOLSET)) -Wl,-soname=$(@F) -o $@ $(filter-out FORCE_DO_CMD, $^) $(LIBS)</span>
<a name="l00209"></a>00209 <span class="stringliteral">"""</span>
<a name="l00210"></a>00210 
<a name="l00211"></a>00211 
<a name="l00212"></a><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#59c34b2947d34e1bfaccba4b99a9f423">00212</a> LINK_COMMANDS_AIX = <span class="stringliteral">"""\</span>
<a name="l00213"></a>00213 <span class="stringliteral">quiet_cmd_alink = AR($(TOOLSET)) $@</span>
<a name="l00214"></a>00214 <span class="stringliteral">cmd_alink = rm -f $@ &amp;&amp; $(AR.$(TOOLSET)) crs $@ $(filter %.o,$^)</span>
<a name="l00215"></a>00215 <span class="stringliteral"></span>
<a name="l00216"></a>00216 <span class="stringliteral">quiet_cmd_alink_thin = AR($(TOOLSET)) $@</span>
<a name="l00217"></a>00217 <span class="stringliteral">cmd_alink_thin = rm -f $@ &amp;&amp; $(AR.$(TOOLSET)) crs $@ $(filter %.o,$^)</span>
<a name="l00218"></a>00218 <span class="stringliteral"></span>
<a name="l00219"></a>00219 <span class="stringliteral">quiet_cmd_link = LINK($(TOOLSET)) $@</span>
<a name="l00220"></a>00220 <span class="stringliteral">cmd_link = $(LINK.$(TOOLSET)) $(GYP_LDFLAGS) $(LDFLAGS.$(TOOLSET)) -o $@ $(LD_INPUTS) $(LIBS)</span>
<a name="l00221"></a>00221 <span class="stringliteral"></span>
<a name="l00222"></a>00222 <span class="stringliteral">quiet_cmd_solink = SOLINK($(TOOLSET)) $@</span>
<a name="l00223"></a>00223 <span class="stringliteral">cmd_solink = $(LINK.$(TOOLSET)) -shared $(GYP_LDFLAGS) $(LDFLAGS.$(TOOLSET)) -o $@ $(LD_INPUTS) $(LIBS)</span>
<a name="l00224"></a>00224 <span class="stringliteral"></span>
<a name="l00225"></a>00225 <span class="stringliteral">quiet_cmd_solink_module = SOLINK_MODULE($(TOOLSET)) $@</span>
<a name="l00226"></a>00226 <span class="stringliteral">cmd_solink_module = $(LINK.$(TOOLSET)) -shared $(GYP_LDFLAGS) $(LDFLAGS.$(TOOLSET)) -o $@ $(filter-out FORCE_DO_CMD, $^) $(LIBS)</span>
<a name="l00227"></a>00227 <span class="stringliteral">"""</span>
<a name="l00228"></a>00228 
<a name="l00229"></a>00229 
<a name="l00230"></a>00230 <span class="comment"># Header of toplevel Makefile.</span>
<a name="l00231"></a>00231 <span class="comment"># This should go into the build tree, but it's easier to keep it here for now.</span>
<a name="l00232"></a><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#fbd7bfd538cc0cd2dee9b1940711dba9">00232</a> SHARED_HEADER = (<span class="stringliteral">"""\</span>
<a name="l00233"></a>00233 <span class="stringliteral"># We borrow heavily from the kernel build setup, though we are simpler since</span>
<a name="l00234"></a>00234 <span class="stringliteral"># we don't have Kconfig tweaking settings on us.</span>
<a name="l00235"></a>00235 <span class="stringliteral"></span>
<a name="l00236"></a>00236 <span class="stringliteral"># The implicit make rules have it looking for RCS files, among other things.</span>
<a name="l00237"></a>00237 <span class="stringliteral"># We instead explicitly write all the rules we care about.</span>
<a name="l00238"></a>00238 <span class="stringliteral"># It's even quicker (saves ~200ms) to pass -r on the command line.</span>
<a name="l00239"></a>00239 <span class="stringliteral">MAKEFLAGS=-r</span>
<a name="l00240"></a>00240 <span class="stringliteral"></span>
<a name="l00241"></a>00241 <span class="stringliteral"># The source directory tree.</span>
<a name="l00242"></a>00242 <span class="stringliteral">srcdir := %(srcdir)s</span>
<a name="l00243"></a>00243 <span class="stringliteral">abs_srcdir := $(abspath $(srcdir))</span>
<a name="l00244"></a>00244 <span class="stringliteral"></span>
<a name="l00245"></a>00245 <span class="stringliteral"># The name of the builddir.</span>
<a name="l00246"></a>00246 <span class="stringliteral">builddir_name ?= %(builddir)s</span>
<a name="l00247"></a>00247 <span class="stringliteral"></span>
<a name="l00248"></a>00248 <span class="stringliteral"># The V=1 flag on command line makes us verbosely print command lines.</span>
<a name="l00249"></a>00249 <span class="stringliteral">ifdef V</span>
<a name="l00250"></a>00250 <span class="stringliteral">  quiet=</span>
<a name="l00251"></a>00251 <span class="stringliteral">else</span>
<a name="l00252"></a>00252 <span class="stringliteral">  quiet=quiet_</span>
<a name="l00253"></a>00253 <span class="stringliteral">endif</span>
<a name="l00254"></a>00254 <span class="stringliteral"></span>
<a name="l00255"></a>00255 <span class="stringliteral"># Specify BUILDTYPE=Release on the command line for a release build.</span>
<a name="l00256"></a>00256 <span class="stringliteral">BUILDTYPE ?= %(default_configuration)s</span>
<a name="l00257"></a>00257 <span class="stringliteral"></span>
<a name="l00258"></a>00258 <span class="stringliteral"># Directory all our build output goes into.</span>
<a name="l00259"></a>00259 <span class="stringliteral"># Note that this must be two directories beneath src/ for unit tests to pass,</span>
<a name="l00260"></a>00260 <span class="stringliteral"># as they reach into the src/ directory for data with relative paths.</span>
<a name="l00261"></a>00261 <span class="stringliteral">builddir ?= $(builddir_name)/$(BUILDTYPE)</span>
<a name="l00262"></a>00262 <span class="stringliteral">abs_builddir := $(abspath $(builddir))</span>
<a name="l00263"></a>00263 <span class="stringliteral">depsdir := $(builddir)/.deps</span>
<a name="l00264"></a>00264 <span class="stringliteral"></span>
<a name="l00265"></a>00265 <span class="stringliteral"># Object output directory.</span>
<a name="l00266"></a>00266 <span class="stringliteral">obj := $(builddir)/obj</span>
<a name="l00267"></a>00267 <span class="stringliteral">abs_obj := $(abspath $(obj))</span>
<a name="l00268"></a>00268 <span class="stringliteral"></span>
<a name="l00269"></a>00269 <span class="stringliteral"># We build up a list of every single one of the targets so we can slurp in the</span>
<a name="l00270"></a>00270 <span class="stringliteral"># generated dependency rule Makefiles in one pass.</span>
<a name="l00271"></a>00271 <span class="stringliteral">all_deps :=</span>
<a name="l00272"></a>00272 <span class="stringliteral"></span>
<a name="l00273"></a>00273 <span class="stringliteral">%(make_global_settings)s</span>
<a name="l00274"></a>00274 <span class="stringliteral"></span>
<a name="l00275"></a>00275 <span class="stringliteral">CC.target ?= %(CC.target)s</span>
<a name="l00276"></a>00276 <span class="stringliteral">CFLAGS.target ?= $(CFLAGS)</span>
<a name="l00277"></a>00277 <span class="stringliteral">CXX.target ?= %(CXX.target)s</span>
<a name="l00278"></a>00278 <span class="stringliteral">CXXFLAGS.target ?= $(CXXFLAGS)</span>
<a name="l00279"></a>00279 <span class="stringliteral">LINK.target ?= %(LINK.target)s</span>
<a name="l00280"></a>00280 <span class="stringliteral">LDFLAGS.target ?= $(LDFLAGS)</span>
<a name="l00281"></a>00281 <span class="stringliteral">AR.target ?= $(AR)</span>
<a name="l00282"></a>00282 <span class="stringliteral"></span>
<a name="l00283"></a>00283 <span class="stringliteral"># C++ apps need to be linked with g++.</span>
<a name="l00284"></a>00284 <span class="stringliteral">LINK ?= $(CXX.target)</span>
<a name="l00285"></a>00285 <span class="stringliteral"></span>
<a name="l00286"></a>00286 <span class="stringliteral"># TODO(evan): move all cross-compilation logic to gyp-time so we don't need</span>
<a name="l00287"></a>00287 <span class="stringliteral"># to replicate this environment fallback in make as well.</span>
<a name="l00288"></a>00288 <span class="stringliteral">CC.host ?= %(CC.host)s</span>
<a name="l00289"></a>00289 <span class="stringliteral">CFLAGS.host ?=</span>
<a name="l00290"></a>00290 <span class="stringliteral">CXX.host ?= %(CXX.host)s</span>
<a name="l00291"></a>00291 <span class="stringliteral">CXXFLAGS.host ?=</span>
<a name="l00292"></a>00292 <span class="stringliteral">LINK.host ?= %(LINK.host)s</span>
<a name="l00293"></a>00293 <span class="stringliteral">LDFLAGS.host ?=</span>
<a name="l00294"></a>00294 <span class="stringliteral">AR.host ?= %(AR.host)s</span>
<a name="l00295"></a>00295 <span class="stringliteral"></span>
<a name="l00296"></a>00296 <span class="stringliteral"># Define a dir function that can handle spaces.</span>
<a name="l00297"></a>00297 <span class="stringliteral"># http://www.gnu.org/software/make/manual/make.html#Syntax-of-Functions</span>
<a name="l00298"></a>00298 <span class="stringliteral"># "leading spaces cannot appear in the text of the first argument as written.</span>
<a name="l00299"></a>00299 <span class="stringliteral"># These characters can be put into the argument value by variable substitution."</span>
<a name="l00300"></a>00300 <span class="stringliteral">empty :=</span>
<a name="l00301"></a>00301 <span class="stringliteral">space := $(empty) $(empty)</span>
<a name="l00302"></a>00302 <span class="stringliteral"></span>
<a name="l00303"></a>00303 <span class="stringliteral"># http://stackoverflow.com/questions/1189781/using-make-dir-or-notdir-on-a-path-with-spaces</span>
<a name="l00304"></a>00304 <span class="stringliteral">replace_spaces = $(subst $(space),"""</span> + SPACE_REPLACEMENT + <span class="stringliteral">""",$1)</span>
<a name="l00305"></a>00305 <span class="stringliteral">unreplace_spaces = $(subst """</span> + SPACE_REPLACEMENT + <span class="stringliteral">""",$(space),$1)</span>
<a name="l00306"></a>00306 <span class="stringliteral">dirx = $(call unreplace_spaces,$(dir $(call replace_spaces,$1)))</span>
<a name="l00307"></a>00307 <span class="stringliteral"></span>
<a name="l00308"></a>00308 <span class="stringliteral"># Flags to make gcc output dependency info.  Note that you need to be</span>
<a name="l00309"></a>00309 <span class="stringliteral"># careful here to use the flags that ccache and distcc can understand.</span>
<a name="l00310"></a>00310 <span class="stringliteral"># We write to a dep file on the side first and then rename at the end</span>
<a name="l00311"></a>00311 <span class="stringliteral"># so we can't end up with a broken dep file.</span>
<a name="l00312"></a>00312 <span class="stringliteral">depfile = $(depsdir)/$(call replace_spaces,$@).d</span>
<a name="l00313"></a>00313 <span class="stringliteral">DEPFLAGS = -MMD -MF $(depfile).raw</span>
<a name="l00314"></a>00314 <span class="stringliteral"></span>
<a name="l00315"></a>00315 <span class="stringliteral"># We have to fixup the deps output in a few ways.</span>
<a name="l00316"></a>00316 <span class="stringliteral"># (1) the file output should mention the proper .o file.</span>
<a name="l00317"></a>00317 <span class="stringliteral"># ccache or distcc lose the path to the target, so we convert a rule of</span>
<a name="l00318"></a>00318 <span class="stringliteral"># the form:</span>
<a name="l00319"></a>00319 <span class="stringliteral">#   foobar.o: DEP1 DEP2</span>
<a name="l00320"></a>00320 <span class="stringliteral"># into</span>
<a name="l00321"></a>00321 <span class="stringliteral">#   path/to/foobar.o: DEP1 DEP2</span>
<a name="l00322"></a>00322 <span class="stringliteral"># (2) we want missing files not to cause us to fail to build.</span>
<a name="l00323"></a>00323 <span class="stringliteral"># We want to rewrite</span>
<a name="l00324"></a>00324 <span class="stringliteral">#   foobar.o: DEP1 DEP2 \\</span>
<a name="l00325"></a>00325 <span class="stringliteral">#               DEP3</span>
<a name="l00326"></a>00326 <span class="stringliteral"># to</span>
<a name="l00327"></a>00327 <span class="stringliteral">#   DEP1:</span>
<a name="l00328"></a>00328 <span class="stringliteral">#   DEP2:</span>
<a name="l00329"></a>00329 <span class="stringliteral">#   DEP3:</span>
<a name="l00330"></a>00330 <span class="stringliteral"># so if the files are missing, they're just considered phony rules.</span>
<a name="l00331"></a>00331 <span class="stringliteral"># We have to do some pretty insane escaping to get those backslashes</span>
<a name="l00332"></a>00332 <span class="stringliteral"># and dollar signs past make, the shell, and sed at the same time.</span>
<a name="l00333"></a>00333 <span class="stringliteral"># Doesn't work with spaces, but that's fine: .d files have spaces in</span>
<a name="l00334"></a>00334 <span class="stringliteral"># their names replaced with other characters."""</span>
<a name="l00335"></a>00335 <span class="stringliteral">r"""</span>
<a name="l00336"></a>00336 <span class="stringliteral">define fixup_dep</span>
<a name="l00337"></a>00337 <span class="stringliteral"># The depfile may not exist if the input file didn't have any #includes.</span>
<a name="l00338"></a>00338 <span class="stringliteral">touch $(depfile).raw</span>
<a name="l00339"></a>00339 <span class="stringliteral"># Fixup path as in (1).</span>
<a name="l00340"></a>00340 <span class="stringliteral">sed -e "s|^$(notdir $@)|$@|" $(depfile).raw &gt;&gt; $(depfile)</span>
<a name="l00341"></a>00341 <span class="stringliteral"># Add extra rules as in (2).</span>
<a name="l00342"></a>00342 <span class="stringliteral"># We remove slashes and replace spaces with new lines;</span>
<a name="l00343"></a>00343 <span class="stringliteral"># remove blank lines;</span>
<a name="l00344"></a>00344 <span class="stringliteral"># delete the first line and append a colon to the remaining lines.</span>
<a name="l00345"></a>00345 <span class="stringliteral">sed -e 's|\\||' -e 'y| |\n|' $(depfile).raw |\</span>
<a name="l00346"></a>00346 <span class="stringliteral">  grep -v '^$$'                             |\</span>
<a name="l00347"></a>00347 <span class="stringliteral">  sed -e 1d -e 's|$$|:|'                     \</span>
<a name="l00348"></a>00348 <span class="stringliteral">    &gt;&gt; $(depfile)</span>
<a name="l00349"></a>00349 <span class="stringliteral">rm $(depfile).raw</span>
<a name="l00350"></a>00350 <span class="stringliteral">endef</span>
<a name="l00351"></a>00351 <span class="stringliteral">"""</span>
<a name="l00352"></a>00352 <span class="stringliteral">"""</span>
<a name="l00353"></a>00353 <span class="stringliteral"># Command definitions:</span>
<a name="l00354"></a>00354 <span class="stringliteral"># - cmd_foo is the actual command to run;</span>
<a name="l00355"></a>00355 <span class="stringliteral"># - quiet_cmd_foo is the brief-output summary of the command.</span>
<a name="l00356"></a>00356 <span class="stringliteral"></span>
<a name="l00357"></a>00357 <span class="stringliteral">quiet_cmd_cc = CC($(TOOLSET)) $@</span>
<a name="l00358"></a>00358 <span class="stringliteral">cmd_cc = $(CC.$(TOOLSET)) $(GYP_CFLAGS) $(DEPFLAGS) $(CFLAGS.$(TOOLSET)) -c -o $@ $&lt;</span>
<a name="l00359"></a>00359 <span class="stringliteral"></span>
<a name="l00360"></a>00360 <span class="stringliteral">quiet_cmd_cxx = CXX($(TOOLSET)) $@</span>
<a name="l00361"></a>00361 <span class="stringliteral">cmd_cxx = $(CXX.$(TOOLSET)) $(GYP_CXXFLAGS) $(DEPFLAGS) $(CXXFLAGS.$(TOOLSET)) -c -o $@ $&lt;</span>
<a name="l00362"></a>00362 <span class="stringliteral">%(extra_commands)s</span>
<a name="l00363"></a>00363 <span class="stringliteral">quiet_cmd_touch = TOUCH $@</span>
<a name="l00364"></a>00364 <span class="stringliteral">cmd_touch = touch $@</span>
<a name="l00365"></a>00365 <span class="stringliteral"></span>
<a name="l00366"></a>00366 <span class="stringliteral">quiet_cmd_copy = COPY $@</span>
<a name="l00367"></a>00367 <span class="stringliteral"># send stderr to /dev/null to ignore messages when linking directories.</span>
<a name="l00368"></a>00368 <span class="stringliteral">cmd_copy = rm -rf "$@" &amp;&amp; cp -af "$&lt;" "$@"</span>
<a name="l00369"></a>00369 <span class="stringliteral"></span>
<a name="l00370"></a>00370 <span class="stringliteral">%(link_commands)s</span>
<a name="l00371"></a>00371 <span class="stringliteral">"""</span>
<a name="l00372"></a>00372 
<a name="l00373"></a>00373 <span class="stringliteral">r"""</span>
<a name="l00374"></a>00374 <span class="stringliteral"># Define an escape_quotes function to escape single quotes.</span>
<a name="l00375"></a>00375 <span class="stringliteral"># This allows us to handle quotes properly as long as we always use</span>
<a name="l00376"></a>00376 <span class="stringliteral"># use single quotes and escape_quotes.</span>
<a name="l00377"></a>00377 <span class="stringliteral">escape_quotes = $(subst ','\'',$(1))</span>
<a name="l00378"></a>00378 <span class="stringliteral"># This comment is here just to include a ' to unconfuse syntax highlighting.</span>
<a name="l00379"></a>00379 <span class="stringliteral"># Define an escape_vars function to escape '$' variable syntax.</span>
<a name="l00380"></a>00380 <span class="stringliteral"># This allows us to read/write command lines with shell variables (e.g.</span>
<a name="l00381"></a>00381 <span class="stringliteral"># $LD_LIBRARY_PATH), without triggering make substitution.</span>
<a name="l00382"></a>00382 <span class="stringliteral">escape_vars = $(subst $$,$$$$,$(1))</span>
<a name="l00383"></a>00383 <span class="stringliteral"># Helper that expands to a shell command to echo a string exactly as it is in</span>
<a name="l00384"></a>00384 <span class="stringliteral"># make. This uses printf instead of echo because printf's behaviour with respect</span>
<a name="l00385"></a>00385 <span class="stringliteral"># to escape sequences is more portable than echo's across different shells</span>
<a name="l00386"></a>00386 <span class="stringliteral"># (e.g., dash, bash).</span>
<a name="l00387"></a>00387 <span class="stringliteral">exact_echo = printf '%%s\n' '$(call escape_quotes,$(1))'</span>
<a name="l00388"></a>00388 <span class="stringliteral">"""</span>
<a name="l00389"></a>00389 <span class="stringliteral">"""</span>
<a name="l00390"></a>00390 <span class="stringliteral"># Helper to compare the command we're about to run against the command</span>
<a name="l00391"></a>00391 <span class="stringliteral"># we logged the last time we ran the command.  Produces an empty</span>
<a name="l00392"></a>00392 <span class="stringliteral"># string (false) when the commands match.</span>
<a name="l00393"></a>00393 <span class="stringliteral"># Tricky point: Make has no string-equality test function.</span>
<a name="l00394"></a>00394 <span class="stringliteral"># The kernel uses the following, but it seems like it would have false</span>
<a name="l00395"></a>00395 <span class="stringliteral"># positives, where one string reordered its arguments.</span>
<a name="l00396"></a>00396 <span class="stringliteral">#   arg_check = $(strip $(filter-out $(cmd_$(1)), $(cmd_$@)) \\</span>
<a name="l00397"></a>00397 <span class="stringliteral">#                       $(filter-out $(cmd_$@), $(cmd_$(1))))</span>
<a name="l00398"></a>00398 <span class="stringliteral"># We instead substitute each for the empty string into the other, and</span>
<a name="l00399"></a>00399 <span class="stringliteral"># say they're equal if both substitutions produce the empty string.</span>
<a name="l00400"></a>00400 <span class="stringliteral"># .d files contain """</span> + SPACE_REPLACEMENT + \
<a name="l00401"></a>00401                    <span class="stringliteral">""" instead of spaces, take that into account.</span>
<a name="l00402"></a>00402 <span class="stringliteral">command_changed = $(or $(subst $(cmd_$(1)),,$(cmd_$(call replace_spaces,$@))),\\</span>
<a name="l00403"></a>00403 <span class="stringliteral">                       $(subst $(cmd_$(call replace_spaces,$@)),,$(cmd_$(1))))</span>
<a name="l00404"></a>00404 <span class="stringliteral"></span>
<a name="l00405"></a>00405 <span class="stringliteral"># Helper that is non-empty when a prerequisite changes.</span>
<a name="l00406"></a>00406 <span class="stringliteral"># Normally make does this implicitly, but we force rules to always run</span>
<a name="l00407"></a>00407 <span class="stringliteral"># so we can check their command lines.</span>
<a name="l00408"></a>00408 <span class="stringliteral">#   $? -- new prerequisites</span>
<a name="l00409"></a>00409 <span class="stringliteral">#   $| -- order-only dependencies</span>
<a name="l00410"></a>00410 <span class="stringliteral">prereq_changed = $(filter-out FORCE_DO_CMD,$(filter-out $|,$?))</span>
<a name="l00411"></a>00411 <span class="stringliteral"></span>
<a name="l00412"></a>00412 <span class="stringliteral"># Helper that executes all postbuilds until one fails.</span>
<a name="l00413"></a>00413 <span class="stringliteral">define do_postbuilds</span>
<a name="l00414"></a>00414 <span class="stringliteral">  @E=0;\\</span>
<a name="l00415"></a>00415 <span class="stringliteral">  for p in $(POSTBUILDS); do\\</span>
<a name="l00416"></a>00416 <span class="stringliteral">    eval $$p;\\</span>
<a name="l00417"></a>00417 <span class="stringliteral">    E=$$?;\\</span>
<a name="l00418"></a>00418 <span class="stringliteral">    if [ $$E -ne 0 ]; then\\</span>
<a name="l00419"></a>00419 <span class="stringliteral">      break;\\</span>
<a name="l00420"></a>00420 <span class="stringliteral">    fi;\\</span>
<a name="l00421"></a>00421 <span class="stringliteral">  done;\\</span>
<a name="l00422"></a>00422 <span class="stringliteral">  if [ $$E -ne 0 ]; then\\</span>
<a name="l00423"></a>00423 <span class="stringliteral">    rm -rf "$@";\\</span>
<a name="l00424"></a>00424 <span class="stringliteral">    exit $$E;\\</span>
<a name="l00425"></a>00425 <span class="stringliteral">  fi</span>
<a name="l00426"></a>00426 <span class="stringliteral">endef</span>
<a name="l00427"></a>00427 <span class="stringliteral"></span>
<a name="l00428"></a>00428 <span class="stringliteral"># do_cmd: run a command via the above cmd_foo names, if necessary.</span>
<a name="l00429"></a>00429 <span class="stringliteral"># Should always run for a given target to handle command-line changes.</span>
<a name="l00430"></a>00430 <span class="stringliteral"># Second argument, if non-zero, makes it do asm/C/C++ dependency munging.</span>
<a name="l00431"></a>00431 <span class="stringliteral"># Third argument, if non-zero, makes it do POSTBUILDS processing.</span>
<a name="l00432"></a>00432 <span class="stringliteral"># Note: We intentionally do NOT call dirx for depfile, since it contains """</span> + \
<a name="l00433"></a>00433                                                      SPACE_REPLACEMENT + <span class="stringliteral">""" for</span>
<a name="l00434"></a>00434 <span class="stringliteral"># spaces already and dirx strips the """</span> + SPACE_REPLACEMENT + \
<a name="l00435"></a>00435                                      <span class="stringliteral">""" characters.</span>
<a name="l00436"></a>00436 <span class="stringliteral">define do_cmd</span>
<a name="l00437"></a>00437 <span class="stringliteral">$(if $(or $(command_changed),$(prereq_changed)),</span>
<a name="l00438"></a>00438 <span class="stringliteral">  @$(call exact_echo,  $($(quiet)cmd_$(1)))</span>
<a name="l00439"></a>00439 <span class="stringliteral">  @mkdir -p "$(call dirx,$@)" "$(dir $(depfile))"</span>
<a name="l00440"></a>00440 <span class="stringliteral">  $(if $(findstring flock,$(word %(flock_index)d,$(cmd_$1))),</span>
<a name="l00441"></a>00441 <span class="stringliteral">    @$(cmd_$(1))</span>
<a name="l00442"></a>00442 <span class="stringliteral">    @echo "  $(quiet_cmd_$(1)): Finished",</span>
<a name="l00443"></a>00443 <span class="stringliteral">    @$(cmd_$(1))</span>
<a name="l00444"></a>00444 <span class="stringliteral">  )</span>
<a name="l00445"></a>00445 <span class="stringliteral">  @$(call exact_echo,$(call escape_vars,cmd_$(call replace_spaces,$@) := $(cmd_$(1)))) &gt; $(depfile)</span>
<a name="l00446"></a>00446 <span class="stringliteral">  @$(if $(2),$(fixup_dep))</span>
<a name="l00447"></a>00447 <span class="stringliteral">  $(if $(and $(3), $(POSTBUILDS)),</span>
<a name="l00448"></a>00448 <span class="stringliteral">    $(call do_postbuilds)</span>
<a name="l00449"></a>00449 <span class="stringliteral">  )</span>
<a name="l00450"></a>00450 <span class="stringliteral">)</span>
<a name="l00451"></a>00451 <span class="stringliteral">endef</span>
<a name="l00452"></a>00452 <span class="stringliteral"></span>
<a name="l00453"></a>00453 <span class="stringliteral"># Declare the "%(default_target)s" target first so it is the default,</span>
<a name="l00454"></a>00454 <span class="stringliteral"># even though we don't have the deps yet.</span>
<a name="l00455"></a>00455 <span class="stringliteral">.PHONY: %(default_target)s</span>
<a name="l00456"></a>00456 <span class="stringliteral">%(default_target)s:</span>
<a name="l00457"></a>00457 <span class="stringliteral"></span>
<a name="l00458"></a>00458 <span class="stringliteral"># make looks for ways to re-generate included makefiles, but in our case, we</span>
<a name="l00459"></a>00459 <span class="stringliteral"># don't have a direct way. Explicitly telling make that it has nothing to do</span>
<a name="l00460"></a>00460 <span class="stringliteral"># for them makes it go faster.</span>
<a name="l00461"></a>00461 <span class="stringliteral">%%.d: ;</span>
<a name="l00462"></a>00462 <span class="stringliteral"></span>
<a name="l00463"></a>00463 <span class="stringliteral"># Use FORCE_DO_CMD to force a target to run.  Should be coupled with</span>
<a name="l00464"></a>00464 <span class="stringliteral"># do_cmd.</span>
<a name="l00465"></a>00465 <span class="stringliteral">.PHONY: FORCE_DO_CMD</span>
<a name="l00466"></a>00466 <span class="stringliteral">FORCE_DO_CMD:</span>
<a name="l00467"></a>00467 <span class="stringliteral"></span>
<a name="l00468"></a>00468 <span class="stringliteral">"""</span>)
<a name="l00469"></a>00469 
<a name="l00470"></a><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#ed006bae216bd2718c9a662fd265f49f">00470</a> SHARED_HEADER_MAC_COMMANDS = <span class="stringliteral">"""</span>
<a name="l00471"></a>00471 <span class="stringliteral">quiet_cmd_objc = CXX($(TOOLSET)) $@</span>
<a name="l00472"></a>00472 <span class="stringliteral">cmd_objc = $(CC.$(TOOLSET)) $(GYP_OBJCFLAGS) $(DEPFLAGS) -c -o $@ $&lt;</span>
<a name="l00473"></a>00473 <span class="stringliteral"></span>
<a name="l00474"></a>00474 <span class="stringliteral">quiet_cmd_objcxx = CXX($(TOOLSET)) $@</span>
<a name="l00475"></a>00475 <span class="stringliteral">cmd_objcxx = $(CXX.$(TOOLSET)) $(GYP_OBJCXXFLAGS) $(DEPFLAGS) -c -o $@ $&lt;</span>
<a name="l00476"></a>00476 <span class="stringliteral"></span>
<a name="l00477"></a>00477 <span class="stringliteral"># Commands for precompiled header files.</span>
<a name="l00478"></a>00478 <span class="stringliteral">quiet_cmd_pch_c = CXX($(TOOLSET)) $@</span>
<a name="l00479"></a>00479 <span class="stringliteral">cmd_pch_c = $(CC.$(TOOLSET)) $(GYP_PCH_CFLAGS) $(DEPFLAGS) $(CXXFLAGS.$(TOOLSET)) -c -o $@ $&lt;</span>
<a name="l00480"></a>00480 <span class="stringliteral">quiet_cmd_pch_cc = CXX($(TOOLSET)) $@</span>
<a name="l00481"></a>00481 <span class="stringliteral">cmd_pch_cc = $(CC.$(TOOLSET)) $(GYP_PCH_CXXFLAGS) $(DEPFLAGS) $(CXXFLAGS.$(TOOLSET)) -c -o $@ $&lt;</span>
<a name="l00482"></a>00482 <span class="stringliteral">quiet_cmd_pch_m = CXX($(TOOLSET)) $@</span>
<a name="l00483"></a>00483 <span class="stringliteral">cmd_pch_m = $(CC.$(TOOLSET)) $(GYP_PCH_OBJCFLAGS) $(DEPFLAGS) -c -o $@ $&lt;</span>
<a name="l00484"></a>00484 <span class="stringliteral">quiet_cmd_pch_mm = CXX($(TOOLSET)) $@</span>
<a name="l00485"></a>00485 <span class="stringliteral">cmd_pch_mm = $(CC.$(TOOLSET)) $(GYP_PCH_OBJCXXFLAGS) $(DEPFLAGS) -c -o $@ $&lt;</span>
<a name="l00486"></a>00486 <span class="stringliteral"></span>
<a name="l00487"></a>00487 <span class="stringliteral"># gyp-mac-tool is written next to the root Makefile by gyp.</span>
<a name="l00488"></a>00488 <span class="stringliteral"># Use $(4) for the command, since $(2) and $(3) are used as flag by do_cmd</span>
<a name="l00489"></a>00489 <span class="stringliteral"># already.</span>
<a name="l00490"></a>00490 <span class="stringliteral">quiet_cmd_mac_tool = MACTOOL $(4) $&lt;</span>
<a name="l00491"></a>00491 <span class="stringliteral">cmd_mac_tool = ./gyp-mac-tool $(4) $&lt; "$@"</span>
<a name="l00492"></a>00492 <span class="stringliteral"></span>
<a name="l00493"></a>00493 <span class="stringliteral">quiet_cmd_mac_package_framework = PACKAGE FRAMEWORK $@</span>
<a name="l00494"></a>00494 <span class="stringliteral">cmd_mac_package_framework = ./gyp-mac-tool package-framework "$@" $(4)</span>
<a name="l00495"></a>00495 <span class="stringliteral"></span>
<a name="l00496"></a>00496 <span class="stringliteral">quiet_cmd_infoplist = INFOPLIST $@</span>
<a name="l00497"></a>00497 <span class="stringliteral">cmd_infoplist = $(CC.$(TOOLSET)) -E -P -Wno-trigraphs -x c $(INFOPLIST_DEFINES) "$&lt;" -o "$@"</span>
<a name="l00498"></a>00498 <span class="stringliteral">"""</span>
<a name="l00499"></a>00499 
<a name="l00500"></a>00500 
<a name="l00501"></a><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#592bf415f33b298e5f3f49ee42c03e57">00501</a> <span class="keyword">def </span><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#592bf415f33b298e5f3f49ee42c03e57">WriteRootHeaderSuffixRules</a>(writer):
<a name="l00502"></a>00502   extensions = sorted(COMPILABLE_EXTENSIONS.keys(), key=str.lower)
<a name="l00503"></a>00503 
<a name="l00504"></a>00504   writer.write(<span class="stringliteral">'# Suffix rules, putting all outputs into $(obj).\n'</span>)
<a name="l00505"></a>00505   <span class="keywordflow">for</span> ext <span class="keywordflow">in</span> extensions:
<a name="l00506"></a>00506     writer.write(<span class="stringliteral">'$(obj).$(TOOLSET)/%%.o: $(srcdir)/%%%s FORCE_DO_CMD\n'</span> % ext)
<a name="l00507"></a>00507     writer.write(<span class="stringliteral">'\t@$(call do_cmd,%s,1)\n'</span> % COMPILABLE_EXTENSIONS[ext])
<a name="l00508"></a>00508 
<a name="l00509"></a>00509   writer.write(<span class="stringliteral">'\n# Try building from generated source, too.\n'</span>)
<a name="l00510"></a>00510   <span class="keywordflow">for</span> ext <span class="keywordflow">in</span> extensions:
<a name="l00511"></a>00511     writer.write(
<a name="l00512"></a>00512         <span class="stringliteral">'$(obj).$(TOOLSET)/%%.o: $(obj).$(TOOLSET)/%%%s FORCE_DO_CMD\n'</span> % ext)
<a name="l00513"></a>00513     writer.write(<span class="stringliteral">'\t@$(call do_cmd,%s,1)\n'</span> % COMPILABLE_EXTENSIONS[ext])
<a name="l00514"></a>00514   writer.write(<span class="stringliteral">'\n'</span>)
<a name="l00515"></a>00515   <span class="keywordflow">for</span> ext <span class="keywordflow">in</span> extensions:
<a name="l00516"></a>00516     writer.write(<span class="stringliteral">'$(obj).$(TOOLSET)/%%.o: $(obj)/%%%s FORCE_DO_CMD\n'</span> % ext)
<a name="l00517"></a>00517     writer.write(<span class="stringliteral">'\t@$(call do_cmd,%s,1)\n'</span> % COMPILABLE_EXTENSIONS[ext])
<a name="l00518"></a>00518   writer.write(<span class="stringliteral">'\n'</span>)
<a name="l00519"></a>00519 
<a name="l00520"></a>00520 
<a name="l00521"></a><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#a0bf445238f7ae46a64058cc594b7bfe">00521</a> SHARED_HEADER_SUFFIX_RULES_COMMENT1 = (<span class="stringliteral">"""\</span>
<a name="l00522"></a>00522 <span class="stringliteral"># Suffix rules, putting all outputs into $(obj).</span>
<a name="l00523"></a>00523 <span class="stringliteral">"""</span>)
<a name="l00524"></a>00524 
<a name="l00525"></a>00525 
<a name="l00526"></a><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#2cf3b7892bdf399b4a017dc7d4dd6aac">00526</a> SHARED_HEADER_SUFFIX_RULES_COMMENT2 = (<span class="stringliteral">"""\</span>
<a name="l00527"></a>00527 <span class="stringliteral"># Try building from generated source, too.</span>
<a name="l00528"></a>00528 <span class="stringliteral">"""</span>)
<a name="l00529"></a>00529 
<a name="l00530"></a>00530 
<a name="l00531"></a><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#cd09ba70ed062ec72d4a921d643ff530">00531</a> SHARED_FOOTER = <span class="stringliteral">"""\</span>
<a name="l00532"></a>00532 <span class="stringliteral"># "all" is a concatenation of the "all" targets from all the included</span>
<a name="l00533"></a>00533 <span class="stringliteral"># sub-makefiles. This is just here to clarify.</span>
<a name="l00534"></a>00534 <span class="stringliteral">all:</span>
<a name="l00535"></a>00535 <span class="stringliteral"></span>
<a name="l00536"></a>00536 <span class="stringliteral"># Add in dependency-tracking rules.  $(all_deps) is the list of every single</span>
<a name="l00537"></a>00537 <span class="stringliteral"># target in our tree. Only consider the ones with .d (dependency) info:</span>
<a name="l00538"></a>00538 <span class="stringliteral">d_files := $(wildcard $(foreach f,$(all_deps),$(depsdir)/$(f).d))</span>
<a name="l00539"></a>00539 <span class="stringliteral">ifneq ($(d_files),)</span>
<a name="l00540"></a>00540 <span class="stringliteral">  include $(d_files)</span>
<a name="l00541"></a>00541 <span class="stringliteral">endif</span>
<a name="l00542"></a>00542 <span class="stringliteral">"""</span>
<a name="l00543"></a>00543 
<a name="l00544"></a><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#688c0e4d79df7681ef54007cc15cb567">00544</a> header = <span class="stringliteral">"""\</span>
<a name="l00545"></a>00545 <span class="stringliteral"># This file is generated by gyp; do not edit.</span>
<a name="l00546"></a>00546 <span class="stringliteral"></span>
<a name="l00547"></a>00547 <span class="stringliteral">"""</span>
<a name="l00548"></a>00548 
<a name="l00549"></a>00549 <span class="comment"># Maps every compilable file extension to the do_cmd that compiles it.</span>
<a name="l00550"></a><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#382cf7dd2b13d945290bcf1bfeb4fd22">00550</a> COMPILABLE_EXTENSIONS = {
<a name="l00551"></a>00551   <span class="stringliteral">'.c'</span>: <span class="stringliteral">'cc'</span>,
<a name="l00552"></a>00552   <span class="stringliteral">'.cc'</span>: <span class="stringliteral">'cxx'</span>,
<a name="l00553"></a>00553   <span class="stringliteral">'.cpp'</span>: <span class="stringliteral">'cxx'</span>,
<a name="l00554"></a>00554   <span class="stringliteral">'.cxx'</span>: <span class="stringliteral">'cxx'</span>,
<a name="l00555"></a>00555   <span class="stringliteral">'.s'</span>: <span class="stringliteral">'cc'</span>,
<a name="l00556"></a>00556   <span class="stringliteral">'.S'</span>: <span class="stringliteral">'cc'</span>,
<a name="l00557"></a>00557 }
<a name="l00558"></a>00558 
<a name="l00559"></a><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#45b3964d9d14549f6e796752b87ea305">00559</a> <span class="keyword">def </span><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#45b3964d9d14549f6e796752b87ea305">Compilable</a>(filename):
<a name="l00560"></a>00560   <span class="stringliteral">"""Return true if the file is compilable (should be in OBJS)."""</span>
<a name="l00561"></a>00561   <span class="keywordflow">for</span> res <span class="keywordflow">in</span> (filename.endswith(e) <span class="keywordflow">for</span> e <span class="keywordflow">in</span> COMPILABLE_EXTENSIONS):
<a name="l00562"></a>00562     <span class="keywordflow">if</span> res:
<a name="l00563"></a>00563       <span class="keywordflow">return</span> <span class="keyword">True</span>
<a name="l00564"></a>00564   <span class="keywordflow">return</span> <span class="keyword">False</span>
<a name="l00565"></a>00565 
<a name="l00566"></a>00566 
<a name="l00567"></a><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#41530681cb982d5e1f16e86a849765d5">00567</a> <span class="keyword">def </span><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#41530681cb982d5e1f16e86a849765d5">Linkable</a>(filename):
<a name="l00568"></a>00568   <span class="stringliteral">"""Return true if the file is linkable (should be on the link line)."""</span>
<a name="l00569"></a>00569   <span class="keywordflow">return</span> filename.endswith(<span class="stringliteral">'.o'</span>)
<a name="l00570"></a>00570 
<a name="l00571"></a>00571 
<a name="l00572"></a><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#7a5637b71c2285ecdcb7faa3b54533b4">00572</a> <span class="keyword">def </span><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#7a5637b71c2285ecdcb7faa3b54533b4">Target</a>(filename):
<a name="l00573"></a>00573   <span class="stringliteral">"""Translate a compilable filename to its .o target."""</span>
<a name="l00574"></a>00574   <span class="keywordflow">return</span> os.path.splitext(filename)[0] + <span class="stringliteral">'.o'</span>
<a name="l00575"></a>00575 
<a name="l00576"></a>00576 
<a name="l00577"></a><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#c512e5208c88f067c95810a782f74ba9">00577</a> <span class="keyword">def </span><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#c512e5208c88f067c95810a782f74ba9">EscapeShellArgument</a>(s):
<a name="l00578"></a>00578   <span class="stringliteral">"""Quotes an argument so that it will be interpreted literally by a POSIX</span>
<a name="l00579"></a>00579 <span class="stringliteral">     shell. Taken from</span>
<a name="l00580"></a>00580 <span class="stringliteral">     http://stackoverflow.com/questions/35817/whats-the-best-way-to-escape-ossystem-calls-in-python</span>
<a name="l00581"></a>00581 <span class="stringliteral">     """</span>
<a name="l00582"></a>00582   <span class="keywordflow">return</span> <span class="stringliteral">"'"</span> + s.replace(<span class="stringliteral">"'"</span>, <span class="stringliteral">"'\\''"</span>) + <span class="stringliteral">"'"</span>
<a name="l00583"></a>00583 
<a name="l00584"></a>00584 
<a name="l00585"></a><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#b4fb67202385c441eef61fc4c489cd83">00585</a> <span class="keyword">def </span><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#b4fb67202385c441eef61fc4c489cd83">EscapeMakeVariableExpansion</a>(s):
<a name="l00586"></a>00586   <span class="stringliteral">"""Make has its own variable expansion syntax using $. We must escape it for</span>
<a name="l00587"></a>00587 <span class="stringliteral">     string to be interpreted literally."""</span>
<a name="l00588"></a>00588   <span class="keywordflow">return</span> s.replace(<span class="stringliteral">'$'</span>, <span class="stringliteral">'$$'</span>)
<a name="l00589"></a>00589 
<a name="l00590"></a>00590 
<a name="l00591"></a><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#dddf8e59601349044f11301c68179f02">00591</a> <span class="keyword">def </span><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#dddf8e59601349044f11301c68179f02">EscapeCppDefine</a>(s):
<a name="l00592"></a>00592   <span class="stringliteral">"""Escapes a CPP define so that it will reach the compiler unaltered."""</span>
<a name="l00593"></a>00593   s = EscapeShellArgument(s)
<a name="l00594"></a>00594   s = EscapeMakeVariableExpansion(s)
<a name="l00595"></a>00595   <span class="comment"># '#' characters must be escaped even embedded in a string, else Make will</span>
<a name="l00596"></a>00596   <span class="comment"># treat it as the start of a comment.</span>
<a name="l00597"></a>00597   <span class="keywordflow">return</span> s.replace(<span class="stringliteral">'#'</span>, <span class="stringliteral">r'\#'</span>)
<a name="l00598"></a>00598 
<a name="l00599"></a>00599 
<a name="l00600"></a><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#f2f096b5246fe7b8af40e1ce7256ac5e">00600</a> <span class="keyword">def </span><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#f2f096b5246fe7b8af40e1ce7256ac5e">QuoteIfNecessary</a>(string):
<a name="l00601"></a>00601   <span class="stringliteral">"""TODO: Should this ideally be replaced with one or more of the above</span>
<a name="l00602"></a>00602 <span class="stringliteral">     functions?"""</span>
<a name="l00603"></a>00603   <span class="keywordflow">if</span> <span class="stringliteral">'"'</span> <span class="keywordflow">in</span> string:
<a name="l00604"></a>00604     string = <span class="stringliteral">'"'</span> + string.replace(<span class="stringliteral">'"'</span>, <span class="stringliteral">'\\"'</span>) + <span class="stringliteral">'"'</span>
<a name="l00605"></a>00605   <span class="keywordflow">return</span> string
<a name="l00606"></a>00606 
<a name="l00607"></a>00607 
<a name="l00608"></a><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#c584c6bcb33e375ceb321611875e6cc6">00608</a> <span class="keyword">def </span><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#c584c6bcb33e375ceb321611875e6cc6">StringToMakefileVariable</a>(string):
<a name="l00609"></a>00609   <span class="stringliteral">"""Convert a string to a value that is acceptable as a make variable name."""</span>
<a name="l00610"></a>00610   <span class="keywordflow">return</span> re.sub(<span class="stringliteral">'[^a-zA-Z0-9_]'</span>, <span class="stringliteral">'_'</span>, string)
<a name="l00611"></a>00611 
<a name="l00612"></a>00612 
<a name="l00613"></a><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#938d29a2e714857da8cc9380b4bdc7bc">00613</a> srcdir_prefix = <span class="stringliteral">''</span>
<a name="l00614"></a><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#96e297821439c3df24b657d0d283f4ca">00614</a> <span class="keyword">def </span><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#96e297821439c3df24b657d0d283f4ca">Sourceify</a>(path):
<a name="l00615"></a>00615   <span class="stringliteral">"""Convert a path to its source directory form."""</span>
<a name="l00616"></a>00616   <span class="keywordflow">if</span> <span class="stringliteral">'$('</span> <span class="keywordflow">in</span> path:
<a name="l00617"></a>00617     <span class="keywordflow">return</span> path
<a name="l00618"></a>00618   <span class="keywordflow">if</span> os.path.isabs(path):
<a name="l00619"></a>00619     <span class="keywordflow">return</span> path
<a name="l00620"></a>00620   <span class="keywordflow">return</span> srcdir_prefix + path
<a name="l00621"></a>00621 
<a name="l00622"></a>00622 
<a name="l00623"></a><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#275ae6aa3ced50798175b11c077526b0">00623</a> <span class="keyword">def </span><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#275ae6aa3ced50798175b11c077526b0">QuoteSpaces</a>(s, quote=r'\ '):
<a name="l00624"></a>00624   <span class="keywordflow">return</span> s.replace(<span class="stringliteral">' '</span>, quote)
<a name="l00625"></a>00625 
<a name="l00626"></a>00626 
<a name="l00627"></a>00627 <span class="comment"># TODO: Avoid code duplication with _ValidateSourcesForMSVSProject in msvs.py.</span>
<a name="l00628"></a><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#80344059f01433895ade5c062eb6ea4a">00628</a> <span class="keyword">def </span><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#80344059f01433895ade5c062eb6ea4a">_ValidateSourcesForOSX</a>(spec, all_sources):
<a name="l00629"></a>00629   <span class="stringliteral">"""Makes sure if duplicate basenames are not specified in the source list.</span>
<a name="l00630"></a>00630 <span class="stringliteral"></span>
<a name="l00631"></a>00631 <span class="stringliteral">  Arguments:</span>
<a name="l00632"></a>00632 <span class="stringliteral">    spec: The target dictionary containing the properties of the target.</span>
<a name="l00633"></a>00633 <span class="stringliteral">  """</span>
<a name="l00634"></a>00634   <span class="keywordflow">if</span> spec.get(<span class="stringliteral">'type'</span>, <span class="keywordtype">None</span>) != <span class="stringliteral">'static_library'</span>:
<a name="l00635"></a>00635     <span class="keywordflow">return</span>
<a name="l00636"></a>00636 
<a name="l00637"></a>00637   basenames = {}
<a name="l00638"></a>00638   <span class="keywordflow">for</span> source <span class="keywordflow">in</span> all_sources:
<a name="l00639"></a>00639     name, ext = os.path.splitext(source)
<a name="l00640"></a>00640     is_compiled_file = ext <span class="keywordflow">in</span> [
<a name="l00641"></a>00641         <span class="stringliteral">'.c'</span>, <span class="stringliteral">'.cc'</span>, <span class="stringliteral">'.cpp'</span>, <span class="stringliteral">'.cxx'</span>, <span class="stringliteral">'.m'</span>, <span class="stringliteral">'.mm'</span>, <span class="stringliteral">'.s'</span>, <span class="stringliteral">'.S'</span>]
<a name="l00642"></a>00642     <span class="keywordflow">if</span> <span class="keywordflow">not</span> is_compiled_file:
<a name="l00643"></a>00643       <span class="keywordflow">continue</span>
<a name="l00644"></a>00644     basename = os.path.basename(name)  <span class="comment"># Don't include extension.</span>
<a name="l00645"></a>00645     basenames.setdefault(basename, []).append(source)
<a name="l00646"></a>00646 
<a name="l00647"></a>00647   error = <span class="stringliteral">''</span>
<a name="l00648"></a>00648   <span class="keywordflow">for</span> basename, files <span class="keywordflow">in</span> basenames.iteritems():
<a name="l00649"></a>00649     <span class="keywordflow">if</span> len(files) &gt; 1:
<a name="l00650"></a>00650       error += <span class="stringliteral">'  %s: %s\n'</span> % (basename, <span class="stringliteral">' '</span>.join(files))
<a name="l00651"></a>00651 
<a name="l00652"></a>00652   <span class="keywordflow">if</span> error:
<a name="l00653"></a>00653     <span class="keywordflow">print</span>(<span class="stringliteral">'static library %s has several files with the same basename:\n'</span> %
<a name="l00654"></a>00654           spec[<span class="stringliteral">'target_name'</span>] + error + <span class="stringliteral">'libtool on OS X will generate'</span> +
<a name="l00655"></a>00655           <span class="stringliteral">' warnings for them.'</span>)
<a name="l00656"></a>00656     <span class="keywordflow">raise</span> GypError(<span class="stringliteral">'Duplicate basenames in sources section, see list above'</span>)
<a name="l00657"></a>00657 
<a name="l00658"></a>00658 
<a name="l00659"></a>00659 <span class="comment"># Map from qualified target to path to output.</span>
<a name="l00660"></a><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#af448ba5ff3b5d281fb4c4cd7c7eef16">00660</a> target_outputs = {}
<a name="l00661"></a>00661 <span class="comment"># Map from qualified target to any linkable output.  A subset</span>
<a name="l00662"></a>00662 <span class="comment"># of target_outputs.  E.g. when mybinary depends on liba, we want to</span>
<a name="l00663"></a>00663 <span class="comment"># include liba in the linker line; when otherbinary depends on</span>
<a name="l00664"></a>00664 <span class="comment"># mybinary, we just want to build mybinary first.</span>
<a name="l00665"></a><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#75b7056342503a647a743d951689e636">00665</a> target_link_deps = {}
<a name="l00666"></a>00666 
<a name="l00667"></a>00667 
<a name="l00668"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html">00668</a> <span class="keyword">class </span><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html">MakefileWriter</a>(object):
<a name="l00669"></a>00669   <span class="stringliteral">"""MakefileWriter packages up the writing of one target-specific foobar.mk.</span>
<a name="l00670"></a>00670 <span class="stringliteral"></span>
<a name="l00671"></a>00671 <span class="stringliteral">  Its only real entry point is Write(), and is mostly used for namespacing.</span>
<a name="l00672"></a>00672 <span class="stringliteral">  """</span>
<a name="l00673"></a>00673 
<a name="l00674"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#c775ee34451fdfa742b318538164070e">00674</a>   <span class="keyword">def </span><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#c775ee34451fdfa742b318538164070e">__init__</a>(self, generator_flags, flavor):
<a name="l00675"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#6a8fa6b697919e51946ad2d25286dbb7">00675</a>     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#6a8fa6b697919e51946ad2d25286dbb7">generator_flags</a> = generator_flags
<a name="l00676"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">00676</a>     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> = flavor
<a name="l00677"></a>00677 
<a name="l00678"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#0c941d4c3d82af64536f8e5a64e1843e">00678</a>     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#0c941d4c3d82af64536f8e5a64e1843e">suffix_rules_srcdir</a> = {}
<a name="l00679"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#5098382582883ade48f137ff0bde51b5">00679</a>     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#5098382582883ade48f137ff0bde51b5">suffix_rules_objdir1</a> = {}
<a name="l00680"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#7b7b21f749735ad76ecaf4e3725325a9">00680</a>     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#7b7b21f749735ad76ecaf4e3725325a9">suffix_rules_objdir2</a> = {}
<a name="l00681"></a>00681 
<a name="l00682"></a>00682     <span class="comment"># Generate suffix rules for all compilable extensions.</span>
<a name="l00683"></a>00683     <span class="keywordflow">for</span> ext <span class="keywordflow">in</span> COMPILABLE_EXTENSIONS.keys():
<a name="l00684"></a>00684       <span class="comment"># Suffix rules for source folder.</span>
<a name="l00685"></a>00685       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#0c941d4c3d82af64536f8e5a64e1843e">suffix_rules_srcdir</a>.update({ext: (<span class="stringliteral">"""\</span>
<a name="l00686"></a>00686 <span class="stringliteral">$(obj).$(TOOLSET)/$(TARGET)/%%.o: $(srcdir)/%%%s FORCE_DO_CMD</span>
<a name="l00687"></a>00687 <span class="stringliteral">        @$(call do_cmd,%s,1)</span>
<a name="l00688"></a>00688 <span class="stringliteral">"""</span> % (ext, COMPILABLE_EXTENSIONS[ext]))})
<a name="l00689"></a>00689 
<a name="l00690"></a>00690       <span class="comment"># Suffix rules for generated source files.</span>
<a name="l00691"></a>00691       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#5098382582883ade48f137ff0bde51b5">suffix_rules_objdir1</a>.update({ext: (<span class="stringliteral">"""\</span>
<a name="l00692"></a>00692 <span class="stringliteral">$(obj).$(TOOLSET)/$(TARGET)/%%.o: $(obj).$(TOOLSET)/%%%s FORCE_DO_CMD</span>
<a name="l00693"></a>00693 <span class="stringliteral">        @$(call do_cmd,%s,1)</span>
<a name="l00694"></a>00694 <span class="stringliteral">"""</span> % (ext, COMPILABLE_EXTENSIONS[ext]))})
<a name="l00695"></a>00695       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#7b7b21f749735ad76ecaf4e3725325a9">suffix_rules_objdir2</a>.update({ext: (<span class="stringliteral">"""\</span>
<a name="l00696"></a>00696 <span class="stringliteral">$(obj).$(TOOLSET)/$(TARGET)/%%.o: $(obj)/%%%s FORCE_DO_CMD</span>
<a name="l00697"></a>00697 <span class="stringliteral">        @$(call do_cmd,%s,1)</span>
<a name="l00698"></a>00698 <span class="stringliteral">"""</span> % (ext, COMPILABLE_EXTENSIONS[ext]))})
<a name="l00699"></a>00699 
<a name="l00700"></a>00700 
<a name="l00701"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#fe042a271bd4d82d7c52a0a87e60f60a">00701</a>   <span class="keyword">def </span><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#fe042a271bd4d82d7c52a0a87e60f60a">Write</a>(self, qualified_target, base_path, output_filename, spec, configs,
<a name="l00702"></a>00702             part_of_all):
<a name="l00703"></a>00703     <span class="stringliteral">"""The main entry point: writes a .mk file for a single target.</span>
<a name="l00704"></a>00704 <span class="stringliteral"></span>
<a name="l00705"></a>00705 <span class="stringliteral">    Arguments:</span>
<a name="l00706"></a>00706 <span class="stringliteral">      qualified_target: target we're generating</span>
<a name="l00707"></a>00707 <span class="stringliteral">      base_path: path relative to source root we're building in, used to resolve</span>
<a name="l00708"></a>00708 <span class="stringliteral">                 target-relative paths</span>
<a name="l00709"></a>00709 <span class="stringliteral">      output_filename: output .mk file name to write</span>
<a name="l00710"></a>00710 <span class="stringliteral">      spec, configs: gyp info</span>
<a name="l00711"></a>00711 <span class="stringliteral">      part_of_all: flag indicating this target is part of 'all'</span>
<a name="l00712"></a>00712 <span class="stringliteral">    """</span>
<a name="l00713"></a>00713     gyp.common.EnsureDirExists(output_filename)
<a name="l00714"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#883a1b899b644be7fc6d704c1d8e0c04">00714</a> 
<a name="l00715"></a>00715     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#883a1b899b644be7fc6d704c1d8e0c04">fp</a> = open(output_filename, <span class="stringliteral">'w'</span>)
<a name="l00716"></a>00716 
<a name="l00717"></a>00717     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#883a1b899b644be7fc6d704c1d8e0c04">fp</a>.write(header)
<a name="l00718"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#073ea158f37820e141c05902aceb2889">00718</a> 
<a name="l00719"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#a28dc103258589d9cb421197fe2de90b">00719</a>     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#073ea158f37820e141c05902aceb2889">qualified_target</a> = qualified_target
<a name="l00720"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#5d2c023108742a1ce78ba9823c06ea35">00720</a>     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#a28dc103258589d9cb421197fe2de90b">path</a> = base_path
<a name="l00721"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">00721</a>     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a> = spec[<span class="stringliteral">'target_name'</span>]
<a name="l00722"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">00722</a>     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> = spec[<span class="stringliteral">'type'</span>]
<a name="l00723"></a>00723     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">toolset</a> = spec[<span class="stringliteral">'toolset'</span>]
<a name="l00724"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#e9044354be1c8bc6f5f25fc45ec6f5df">00724</a> 
<a name="l00725"></a>00725     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#e9044354be1c8bc6f5f25fc45ec6f5df">is_mac_bundle</a> = gyp.xcode_emulation.IsMacBundle(self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a>, spec)
<a name="l00726"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#82fdd7ef33787844f2f47ec02555786b">00726</a>     <span class="keywordflow">if</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'mac'</span>:
<a name="l00727"></a>00727       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a> = gyp.xcode_emulation.XcodeSettings(spec)
<a name="l00728"></a>00728     <span class="keywordflow">else</span>:
<a name="l00729"></a>00729       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a> = <span class="keywordtype">None</span>
<a name="l00730"></a>00730 
<a name="l00731"></a>00731     deps, link_deps = self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d5018dacf3e72356c231736611d30af0">ComputeDeps</a>(spec)
<a name="l00732"></a>00732 
<a name="l00733"></a>00733     <span class="comment"># Some of the generation below can add extra output, sources, or</span>
<a name="l00734"></a>00734     <span class="comment"># link dependencies.  All of the out params of the functions that</span>
<a name="l00735"></a>00735     <span class="comment"># follow use names like extra_foo.</span>
<a name="l00736"></a>00736     extra_outputs = []
<a name="l00737"></a>00737     extra_sources = []
<a name="l00738"></a>00738     extra_link_deps = []
<a name="l00739"></a>00739     extra_mac_bundle_resources = []
<a name="l00740"></a>00740     mac_bundle_deps = []
<a name="l00741"></a>00741 
<a name="l00742"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d288825273ed7192429ab0474fb2d4a0">00742</a>     <span class="keywordflow">if</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#e9044354be1c8bc6f5f25fc45ec6f5df">is_mac_bundle</a>:
<a name="l00743"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#9fac3d232e8876b6835d052a93b30bd0">00743</a>       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d288825273ed7192429ab0474fb2d4a0">output</a> = self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#5696affe1fc78b209b96f47f93e7abb4">ComputeMacBundleOutput</a>(spec)
<a name="l00744"></a>00744       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#9fac3d232e8876b6835d052a93b30bd0">output_binary</a> = self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#092f47342a074b398b6d5c684501690e">ComputeMacBundleBinaryOutput</a>(spec)
<a name="l00745"></a>00745     <span class="keywordflow">else</span>:
<a name="l00746"></a>00746       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d288825273ed7192429ab0474fb2d4a0">output</a> = self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#9fac3d232e8876b6835d052a93b30bd0">output_binary</a> = self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#097c9e2913bffe213c7a56b1b1508997">ComputeOutput</a>(spec)
<a name="l00747"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#33917fd9cc5a5320b45b7f9db0754069">00747</a> 
<a name="l00748"></a>00748     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#33917fd9cc5a5320b45b7f9db0754069">is_standalone_static_library</a> = bool(
<a name="l00749"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#1985b310632a1a5c5aa3a5e312938987">00749</a>         spec.get(<span class="stringliteral">'standalone_static_library'</span>, 0))
<a name="l00750"></a>00750     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#1985b310632a1a5c5aa3a5e312938987">_INSTALLABLE_TARGETS</a> = (<span class="stringliteral">'executable'</span>, <span class="stringliteral">'loadable_module'</span>,
<a name="l00751"></a>00751                                  <span class="stringliteral">'shared_library'</span>)
<a name="l00752"></a>00752     <span class="keywordflow">if</span> (self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#33917fd9cc5a5320b45b7f9db0754069">is_standalone_static_library</a> <span class="keywordflow">or</span>
<a name="l00753"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#e67d6c6e342775a03bd935d100b5b8fa">00753</a>         self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> <span class="keywordflow">in</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#1985b310632a1a5c5aa3a5e312938987">_INSTALLABLE_TARGETS</a>):
<a name="l00754"></a>00754       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#e67d6c6e342775a03bd935d100b5b8fa">alias</a> = os.path.basename(self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d288825273ed7192429ab0474fb2d4a0">output</a>)
<a name="l00755"></a>00755       install_path = self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d308655bbaac8e8cf75347b4ec62577e">_InstallableTargetInstallPath</a>()
<a name="l00756"></a>00756     <span class="keywordflow">else</span>:
<a name="l00757"></a>00757       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#e67d6c6e342775a03bd935d100b5b8fa">alias</a> = self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d288825273ed7192429ab0474fb2d4a0">output</a>
<a name="l00758"></a>00758       install_path = self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d288825273ed7192429ab0474fb2d4a0">output</a>
<a name="l00759"></a>00759 
<a name="l00760"></a>00760     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">"TOOLSET := "</span> + self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">toolset</a>)
<a name="l00761"></a>00761     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">"TARGET := "</span> + self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>)
<a name="l00762"></a>00762 
<a name="l00763"></a>00763     <span class="comment"># Actions must come first, since they can generate more OBJs for use below.</span>
<a name="l00764"></a>00764     <span class="keywordflow">if</span> <span class="stringliteral">'actions'</span> <span class="keywordflow">in</span> spec:
<a name="l00765"></a>00765       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#fc4b663ae8e353dfc043e4be9150bdc2">WriteActions</a>(spec[<span class="stringliteral">'actions'</span>], extra_sources, extra_outputs,
<a name="l00766"></a>00766                         extra_mac_bundle_resources, part_of_all)
<a name="l00767"></a>00767 
<a name="l00768"></a>00768     <span class="comment"># Rules must be early like actions.</span>
<a name="l00769"></a>00769     <span class="keywordflow">if</span> <span class="stringliteral">'rules'</span> <span class="keywordflow">in</span> spec:
<a name="l00770"></a>00770       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#64a7ef6362ff4c4b9191e0761d97b247">WriteRules</a>(spec[<span class="stringliteral">'rules'</span>], extra_sources, extra_outputs,
<a name="l00771"></a>00771                       extra_mac_bundle_resources, part_of_all)
<a name="l00772"></a>00772 
<a name="l00773"></a>00773     <span class="keywordflow">if</span> <span class="stringliteral">'copies'</span> <span class="keywordflow">in</span> spec:
<a name="l00774"></a>00774       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#cb7218d4227c7eb14ab546b33c2e7cb8">WriteCopies</a>(spec[<span class="stringliteral">'copies'</span>], extra_outputs, part_of_all)
<a name="l00775"></a>00775 
<a name="l00776"></a>00776     <span class="comment"># Bundle resources.</span>
<a name="l00777"></a>00777     <span class="keywordflow">if</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#e9044354be1c8bc6f5f25fc45ec6f5df">is_mac_bundle</a>:
<a name="l00778"></a>00778       all_mac_bundle_resources = (
<a name="l00779"></a>00779           spec.get(<span class="stringliteral">'mac_bundle_resources'</span>, []) + extra_mac_bundle_resources)
<a name="l00780"></a>00780       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#9b758bfad28d2aa805d521b0adb55533">WriteMacBundleResources</a>(all_mac_bundle_resources, mac_bundle_deps)
<a name="l00781"></a>00781       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#efdf9de404554421cf997b6b1d0c44fc">WriteMacInfoPlist</a>(mac_bundle_deps)
<a name="l00782"></a>00782 
<a name="l00783"></a>00783     <span class="comment"># Sources.</span>
<a name="l00784"></a>00784     all_sources = spec.get(<span class="stringliteral">'sources'</span>, []) + extra_sources
<a name="l00785"></a>00785     <span class="keywordflow">if</span> all_sources:
<a name="l00786"></a>00786       <span class="keywordflow">if</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'mac'</span>:
<a name="l00787"></a>00787         <span class="comment"># libtool on OS X generates warnings for duplicate basenames in the same</span>
<a name="l00788"></a>00788         <span class="comment"># target.</span>
<a name="l00789"></a>00789         _ValidateSourcesForOSX(spec, all_sources)
<a name="l00790"></a>00790       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#7c3bf79a4bd2f19944fc222c6bcfffc0">WriteSources</a>(
<a name="l00791"></a>00791           configs, deps, all_sources, extra_outputs,
<a name="l00792"></a>00792           extra_link_deps, part_of_all,
<a name="l00793"></a>00793           gyp.xcode_emulation.MacPrefixHeader(
<a name="l00794"></a>00794               self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>, <span class="keyword">lambda</span> p: Sourceify(self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#486b5604f4bc6403b8378c81db254cae">Absolutify</a>(p)),
<a name="l00795"></a>00795               self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#a5a2c7aa87a8a9889f33ddf2b3ead3c4">Pchify</a>))
<a name="l00796"></a>00796       sources = filter(Compilable, all_sources)
<a name="l00797"></a>00797       <span class="keywordflow">if</span> sources:
<a name="l00798"></a>00798         self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(SHARED_HEADER_SUFFIX_RULES_COMMENT1)
<a name="l00799"></a>00799         extensions = set([os.path.splitext(s)[1] <span class="keywordflow">for</span> s <span class="keywordflow">in</span> sources])
<a name="l00800"></a>00800         <span class="keywordflow">for</span> ext <span class="keywordflow">in</span> extensions:
<a name="l00801"></a>00801           <span class="keywordflow">if</span> ext <span class="keywordflow">in</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#0c941d4c3d82af64536f8e5a64e1843e">suffix_rules_srcdir</a>:
<a name="l00802"></a>00802             self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#0c941d4c3d82af64536f8e5a64e1843e">suffix_rules_srcdir</a>[ext])
<a name="l00803"></a>00803         self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(SHARED_HEADER_SUFFIX_RULES_COMMENT2)
<a name="l00804"></a>00804         <span class="keywordflow">for</span> ext <span class="keywordflow">in</span> extensions:
<a name="l00805"></a>00805           <span class="keywordflow">if</span> ext <span class="keywordflow">in</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#5098382582883ade48f137ff0bde51b5">suffix_rules_objdir1</a>:
<a name="l00806"></a>00806             self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#5098382582883ade48f137ff0bde51b5">suffix_rules_objdir1</a>[ext])
<a name="l00807"></a>00807         <span class="keywordflow">for</span> ext <span class="keywordflow">in</span> extensions:
<a name="l00808"></a>00808           <span class="keywordflow">if</span> ext <span class="keywordflow">in</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#7b7b21f749735ad76ecaf4e3725325a9">suffix_rules_objdir2</a>:
<a name="l00809"></a>00809             self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#7b7b21f749735ad76ecaf4e3725325a9">suffix_rules_objdir2</a>[ext])
<a name="l00810"></a>00810         self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'# End of this set of suffix rules'</span>)
<a name="l00811"></a>00811 
<a name="l00812"></a>00812         <span class="comment"># Add dependency from bundle to bundle binary.</span>
<a name="l00813"></a>00813         <span class="keywordflow">if</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#e9044354be1c8bc6f5f25fc45ec6f5df">is_mac_bundle</a>:
<a name="l00814"></a>00814           mac_bundle_deps.append(self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#9fac3d232e8876b6835d052a93b30bd0">output_binary</a>)
<a name="l00815"></a>00815 
<a name="l00816"></a>00816     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#203d0a7515c00ce74d55f93e632eedfe">WriteTarget</a>(spec, configs, deps, extra_link_deps + link_deps,
<a name="l00817"></a>00817                      mac_bundle_deps, extra_outputs, part_of_all)
<a name="l00818"></a>00818 
<a name="l00819"></a>00819     <span class="comment"># Update global list of target outputs, used in dependency tracking.</span>
<a name="l00820"></a>00820     target_outputs[qualified_target] = install_path
<a name="l00821"></a>00821 
<a name="l00822"></a>00822     <span class="comment"># Update global list of link dependencies.</span>
<a name="l00823"></a>00823     <span class="keywordflow">if</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> <span class="keywordflow">in</span> (<span class="stringliteral">'static_library'</span>, <span class="stringliteral">'shared_library'</span>):
<a name="l00824"></a>00824       target_link_deps[qualified_target] = self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#9fac3d232e8876b6835d052a93b30bd0">output_binary</a>
<a name="l00825"></a>00825 
<a name="l00826"></a>00826     <span class="comment"># Currently any versions have the same effect, but in future the behavior</span>
<a name="l00827"></a>00827     <span class="comment"># could be different.</span>
<a name="l00828"></a>00828     <span class="keywordflow">if</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#6a8fa6b697919e51946ad2d25286dbb7">generator_flags</a>.get(<span class="stringliteral">'android_ndk_version'</span>, <span class="keywordtype">None</span>):
<a name="l00829"></a>00829       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#b7fd02bec95eb01dcda47aae3ea6797f">WriteAndroidNdkModuleRule</a>(self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>, all_sources, link_deps)
<a name="l00830"></a>00830 
<a name="l00831"></a>00831     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#883a1b899b644be7fc6d704c1d8e0c04">fp</a>.close()
<a name="l00832"></a>00832 
<a name="l00833"></a>00833 
<a name="l00834"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#e9f54d4b92c75ca7252a9a5fbce3e827">00834</a>   <span class="keyword">def </span><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#e9f54d4b92c75ca7252a9a5fbce3e827">WriteSubMake</a>(self, output_filename, makefile_path, targets, build_dir):
<a name="l00835"></a>00835     <span class="stringliteral">"""Write a "sub-project" Makefile.</span>
<a name="l00836"></a>00836 <span class="stringliteral"></span>
<a name="l00837"></a>00837 <span class="stringliteral">    This is a small, wrapper Makefile that calls the top-level Makefile to build</span>
<a name="l00838"></a>00838 <span class="stringliteral">    the targets from a single gyp file (i.e. a sub-project).</span>
<a name="l00839"></a>00839 <span class="stringliteral"></span>
<a name="l00840"></a>00840 <span class="stringliteral">    Arguments:</span>
<a name="l00841"></a>00841 <span class="stringliteral">      output_filename: sub-project Makefile name to write</span>
<a name="l00842"></a>00842 <span class="stringliteral">      makefile_path: path to the top-level Makefile</span>
<a name="l00843"></a>00843 <span class="stringliteral">      targets: list of "all" targets for this sub-project</span>
<a name="l00844"></a>00844 <span class="stringliteral">      build_dir: build output directory, relative to the sub-project</span>
<a name="l00845"></a>00845 <span class="stringliteral">    """</span>
<a name="l00846"></a>00846     gyp.common.EnsureDirExists(output_filename)
<a name="l00847"></a>00847     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#883a1b899b644be7fc6d704c1d8e0c04">fp</a> = open(output_filename, <span class="stringliteral">'w'</span>)
<a name="l00848"></a>00848     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#883a1b899b644be7fc6d704c1d8e0c04">fp</a>.write(header)
<a name="l00849"></a>00849     <span class="comment"># For consistency with other builders, put sub-project build output in the</span>
<a name="l00850"></a>00850     <span class="comment"># sub-project dir (see test/subdirectory/gyptest-subdir-all.py).</span>
<a name="l00851"></a>00851     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'export builddir_name ?= %s'</span> %
<a name="l00852"></a>00852                  os.path.join(os.path.dirname(output_filename), build_dir))
<a name="l00853"></a>00853     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'.PHONY: all'</span>)
<a name="l00854"></a>00854     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'all:'</span>)
<a name="l00855"></a>00855     <span class="keywordflow">if</span> makefile_path:
<a name="l00856"></a>00856       makefile_path = <span class="stringliteral">' -C '</span> + makefile_path
<a name="l00857"></a>00857     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'\t$(MAKE)%s %s'</span> % (makefile_path, <span class="stringliteral">' '</span>.join(targets)))
<a name="l00858"></a>00858     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#883a1b899b644be7fc6d704c1d8e0c04">fp</a>.close()
<a name="l00859"></a>00859 
<a name="l00860"></a>00860 
<a name="l00861"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#fc4b663ae8e353dfc043e4be9150bdc2">00861</a>   <span class="keyword">def </span><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#fc4b663ae8e353dfc043e4be9150bdc2">WriteActions</a>(self, actions, extra_sources, extra_outputs,
<a name="l00862"></a>00862                    extra_mac_bundle_resources, part_of_all):
<a name="l00863"></a>00863     <span class="stringliteral">"""Write Makefile code for any 'actions' from the gyp input.</span>
<a name="l00864"></a>00864 <span class="stringliteral"></span>
<a name="l00865"></a>00865 <span class="stringliteral">    extra_sources: a list that will be filled in with newly generated source</span>
<a name="l00866"></a>00866 <span class="stringliteral">                   files, if any</span>
<a name="l00867"></a>00867 <span class="stringliteral">    extra_outputs: a list that will be filled in with any outputs of these</span>
<a name="l00868"></a>00868 <span class="stringliteral">                   actions (used to make other pieces dependent on these</span>
<a name="l00869"></a>00869 <span class="stringliteral">                   actions)</span>
<a name="l00870"></a>00870 <span class="stringliteral">    part_of_all: flag indicating this target is part of 'all'</span>
<a name="l00871"></a>00871 <span class="stringliteral">    """</span>
<a name="l00872"></a>00872     env = self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#1e807b9147c1af2adaa10b07e93b51a4">GetSortedXcodeEnv</a>()
<a name="l00873"></a>00873     <span class="keywordflow">for</span> action <span class="keywordflow">in</span> actions:
<a name="l00874"></a>00874       name = StringToMakefileVariable(<span class="stringliteral">'%s_%s'</span> % (self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#073ea158f37820e141c05902aceb2889">qualified_target</a>,
<a name="l00875"></a>00875                                                  action[<span class="stringliteral">'action_name'</span>]))
<a name="l00876"></a>00876       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'### Rules for action "%s":'</span> % action[<span class="stringliteral">'action_name'</span>])
<a name="l00877"></a>00877       inputs = action[<span class="stringliteral">'inputs'</span>]
<a name="l00878"></a>00878       outputs = action[<span class="stringliteral">'outputs'</span>]
<a name="l00879"></a>00879 
<a name="l00880"></a>00880       <span class="comment"># Build up a list of outputs.</span>
<a name="l00881"></a>00881       <span class="comment"># Collect the output dirs we'll need.</span>
<a name="l00882"></a>00882       dirs = set()
<a name="l00883"></a>00883       <span class="keywordflow">for</span> out <span class="keywordflow">in</span> outputs:
<a name="l00884"></a>00884         dir = os.path.split(out)[0]
<a name="l00885"></a>00885         <span class="keywordflow">if</span> dir:
<a name="l00886"></a>00886           dirs.add(dir)
<a name="l00887"></a>00887       <span class="keywordflow">if</span> int(action.get(<span class="stringliteral">'process_outputs_as_sources'</span>, <span class="keyword">False</span>)):
<a name="l00888"></a>00888         extra_sources += outputs
<a name="l00889"></a>00889       <span class="keywordflow">if</span> int(action.get(<span class="stringliteral">'process_outputs_as_mac_bundle_resources'</span>, <span class="keyword">False</span>)):
<a name="l00890"></a>00890         extra_mac_bundle_resources += outputs
<a name="l00891"></a>00891 
<a name="l00892"></a>00892       <span class="comment"># Write the actual command.</span>
<a name="l00893"></a>00893       action_commands = action[<span class="stringliteral">'action'</span>]
<a name="l00894"></a>00894       <span class="keywordflow">if</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'mac'</span>:
<a name="l00895"></a>00895         action_commands = [gyp.xcode_emulation.ExpandEnvVars(command, env)
<a name="l00896"></a>00896                           <span class="keywordflow">for</span> command <span class="keywordflow">in</span> action_commands]
<a name="l00897"></a>00897       command = gyp.common.EncodePOSIXShellList(action_commands)
<a name="l00898"></a>00898       <span class="keywordflow">if</span> <span class="stringliteral">'message'</span> <span class="keywordflow">in</span> action:
<a name="l00899"></a>00899         self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'quiet_cmd_%s = ACTION %s $@'</span> % (name, action[<span class="stringliteral">'message'</span>]))
<a name="l00900"></a>00900       <span class="keywordflow">else</span>:
<a name="l00901"></a>00901         self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'quiet_cmd_%s = ACTION %s $@'</span> % (name, name))
<a name="l00902"></a>00902       <span class="keywordflow">if</span> len(dirs) &gt; 0:
<a name="l00903"></a>00903         command = <span class="stringliteral">'mkdir -p %s'</span> % <span class="stringliteral">' '</span>.join(dirs) + <span class="stringliteral">'; '</span> + command
<a name="l00904"></a>00904 
<a name="l00905"></a>00905       cd_action = <span class="stringliteral">'cd %s; '</span> % Sourceify(self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#a28dc103258589d9cb421197fe2de90b">path</a> <span class="keywordflow">or</span> <span class="stringliteral">'.'</span>)
<a name="l00906"></a>00906 
<a name="l00907"></a>00907       <span class="comment"># command and cd_action get written to a toplevel variable called</span>
<a name="l00908"></a>00908       <span class="comment"># cmd_foo. Toplevel variables can't handle things that change per</span>
<a name="l00909"></a>00909       <span class="comment"># makefile like $(TARGET), so hardcode the target.</span>
<a name="l00910"></a>00910       command = command.replace(<span class="stringliteral">'$(TARGET)'</span>, self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>)
<a name="l00911"></a>00911       cd_action = cd_action.replace(<span class="stringliteral">'$(TARGET)'</span>, self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>)
<a name="l00912"></a>00912 
<a name="l00913"></a>00913       <span class="comment"># Set LD_LIBRARY_PATH in case the action runs an executable from this</span>
<a name="l00914"></a>00914       <span class="comment"># build which links to shared libs from this build.</span>
<a name="l00915"></a>00915       <span class="comment"># actions run on the host, so they should in theory only use host</span>
<a name="l00916"></a>00916       <span class="comment"># libraries, but until everything is made cross-compile safe, also use</span>
<a name="l00917"></a>00917       <span class="comment"># target libraries.</span>
<a name="l00918"></a>00918       <span class="comment"># TODO(piman): when everything is cross-compile safe, remove lib.target</span>
<a name="l00919"></a>00919       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'cmd_%s = LD_LIBRARY_PATH=$(builddir)/lib.host:'</span>
<a name="l00920"></a>00920                    <span class="stringliteral">'$(builddir)/lib.target:$$LD_LIBRARY_PATH; '</span>
<a name="l00921"></a>00921                    <span class="stringliteral">'export LD_LIBRARY_PATH; '</span>
<a name="l00922"></a>00922                    <span class="stringliteral">'%s%s'</span>
<a name="l00923"></a>00923                    % (name, cd_action, command))
<a name="l00924"></a>00924       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>()
<a name="l00925"></a>00925       outputs = map(self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#486b5604f4bc6403b8378c81db254cae">Absolutify</a>, outputs)
<a name="l00926"></a>00926       <span class="comment"># The makefile rules are all relative to the top dir, but the gyp actions</span>
<a name="l00927"></a>00927       <span class="comment"># are defined relative to their containing dir.  This replaces the obj</span>
<a name="l00928"></a>00928       <span class="comment"># variable for the action rule with an absolute version so that the output</span>
<a name="l00929"></a>00929       <span class="comment"># goes in the right place.</span>
<a name="l00930"></a>00930       <span class="comment"># Only write the 'obj' and 'builddir' rules for the "primary" output (:1);</span>
<a name="l00931"></a>00931       <span class="comment"># it's superfluous for the "extra outputs", and this avoids accidentally</span>
<a name="l00932"></a>00932       <span class="comment"># writing duplicate dummy rules for those outputs.</span>
<a name="l00933"></a>00933       <span class="comment"># Same for environment.</span>
<a name="l00934"></a>00934       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">"%s: obj := $(abs_obj)"</span> % QuoteSpaces(outputs[0]))
<a name="l00935"></a>00935       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">"%s: builddir := $(abs_builddir)"</span> % QuoteSpaces(outputs[0]))
<a name="l00936"></a>00936       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#59ac35713dfadc41287f7e81fc662db6">WriteSortedXcodeEnv</a>(outputs[0], self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#1e807b9147c1af2adaa10b07e93b51a4">GetSortedXcodeEnv</a>())
<a name="l00937"></a>00937 
<a name="l00938"></a>00938       <span class="keywordflow">for</span> input <span class="keywordflow">in</span> inputs:
<a name="l00939"></a>00939         <span class="keyword">assert</span> <span class="stringliteral">' '</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> input, (
<a name="l00940"></a>00940             <span class="stringliteral">"Spaces in action input filenames not supported (%s)"</span>  % input)
<a name="l00941"></a>00941       <span class="keywordflow">for</span> output <span class="keywordflow">in</span> outputs:
<a name="l00942"></a>00942         <span class="keyword">assert</span> <span class="stringliteral">' '</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> output, (
<a name="l00943"></a>00943             <span class="stringliteral">"Spaces in action output filenames not supported (%s)"</span>  % output)
<a name="l00944"></a>00944 
<a name="l00945"></a>00945       <span class="comment"># See the comment in WriteCopies about expanding env vars.</span>
<a name="l00946"></a>00946       outputs = [gyp.xcode_emulation.ExpandEnvVars(o, env) <span class="keywordflow">for</span> o <span class="keywordflow">in</span> outputs]
<a name="l00947"></a>00947       inputs = [gyp.xcode_emulation.ExpandEnvVars(i, env) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> inputs]
<a name="l00948"></a>00948 
<a name="l00949"></a>00949       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#2e909e33b1c662b05d5b2e5cfcb67d52">WriteDoCmd</a>(outputs, map(Sourceify, map(self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#486b5604f4bc6403b8378c81db254cae">Absolutify</a>, inputs)),
<a name="l00950"></a>00950                       part_of_all=part_of_all, command=name)
<a name="l00951"></a>00951 
<a name="l00952"></a>00952       <span class="comment"># Stuff the outputs in a variable so we can refer to them later.</span>
<a name="l00953"></a>00953       outputs_variable = <span class="stringliteral">'action_%s_outputs'</span> % name
<a name="l00954"></a>00954       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'%s := %s'</span> % (outputs_variable, <span class="stringliteral">' '</span>.join(outputs)))
<a name="l00955"></a>00955       extra_outputs.append(<span class="stringliteral">'$(%s)'</span> % outputs_variable)
<a name="l00956"></a>00956       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>()
<a name="l00957"></a>00957 
<a name="l00958"></a>00958     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>()
<a name="l00959"></a>00959 
<a name="l00960"></a>00960 
<a name="l00961"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#64a7ef6362ff4c4b9191e0761d97b247">00961</a>   <span class="keyword">def </span><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#64a7ef6362ff4c4b9191e0761d97b247">WriteRules</a>(self, rules, extra_sources, extra_outputs,
<a name="l00962"></a>00962                  extra_mac_bundle_resources, part_of_all):
<a name="l00963"></a>00963     <span class="stringliteral">"""Write Makefile code for any 'rules' from the gyp input.</span>
<a name="l00964"></a>00964 <span class="stringliteral"></span>
<a name="l00965"></a>00965 <span class="stringliteral">    extra_sources: a list that will be filled in with newly generated source</span>
<a name="l00966"></a>00966 <span class="stringliteral">                   files, if any</span>
<a name="l00967"></a>00967 <span class="stringliteral">    extra_outputs: a list that will be filled in with any outputs of these</span>
<a name="l00968"></a>00968 <span class="stringliteral">                   rules (used to make other pieces dependent on these rules)</span>
<a name="l00969"></a>00969 <span class="stringliteral">    part_of_all: flag indicating this target is part of 'all'</span>
<a name="l00970"></a>00970 <span class="stringliteral">    """</span>
<a name="l00971"></a>00971     env = self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#1e807b9147c1af2adaa10b07e93b51a4">GetSortedXcodeEnv</a>()
<a name="l00972"></a>00972     <span class="keywordflow">for</span> rule <span class="keywordflow">in</span> rules:
<a name="l00973"></a>00973       name = StringToMakefileVariable(<span class="stringliteral">'%s_%s'</span> % (self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#073ea158f37820e141c05902aceb2889">qualified_target</a>,
<a name="l00974"></a>00974                                                  rule[<span class="stringliteral">'rule_name'</span>]))
<a name="l00975"></a>00975       count = 0
<a name="l00976"></a>00976       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'### Generated for rule %s:'</span> % name)
<a name="l00977"></a>00977 
<a name="l00978"></a>00978       all_outputs = []
<a name="l00979"></a>00979 
<a name="l00980"></a>00980       <span class="keywordflow">for</span> rule_source <span class="keywordflow">in</span> rule.get(<span class="stringliteral">'rule_sources'</span>, []):
<a name="l00981"></a>00981         dirs = set()
<a name="l00982"></a>00982         (rule_source_dirname, rule_source_basename) = os.path.split(rule_source)
<a name="l00983"></a>00983         (rule_source_root, rule_source_ext) = \
<a name="l00984"></a>00984             os.path.splitext(rule_source_basename)
<a name="l00985"></a>00985 
<a name="l00986"></a>00986         outputs = [self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#88c6708e9588f546826f6886970f724d">ExpandInputRoot</a>(out, rule_source_root,
<a name="l00987"></a>00987                                         rule_source_dirname)
<a name="l00988"></a>00988                    <span class="keywordflow">for</span> out <span class="keywordflow">in</span> rule[<span class="stringliteral">'outputs'</span>]]
<a name="l00989"></a>00989 
<a name="l00990"></a>00990         <span class="keywordflow">for</span> out <span class="keywordflow">in</span> outputs:
<a name="l00991"></a>00991           dir = os.path.dirname(out)
<a name="l00992"></a>00992           <span class="keywordflow">if</span> dir:
<a name="l00993"></a>00993             dirs.add(dir)
<a name="l00994"></a>00994         <span class="keywordflow">if</span> int(rule.get(<span class="stringliteral">'process_outputs_as_sources'</span>, <span class="keyword">False</span>)):
<a name="l00995"></a>00995           extra_sources += outputs
<a name="l00996"></a>00996         <span class="keywordflow">if</span> int(rule.get(<span class="stringliteral">'process_outputs_as_mac_bundle_resources'</span>, <span class="keyword">False</span>)):
<a name="l00997"></a>00997           extra_mac_bundle_resources += outputs
<a name="l00998"></a>00998         inputs = map(Sourceify, map(self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#486b5604f4bc6403b8378c81db254cae">Absolutify</a>, [rule_source] +
<a name="l00999"></a>00999                                     rule.get(<span class="stringliteral">'inputs'</span>, [])))
<a name="l01000"></a>01000         actions = [<span class="stringliteral">'$(call do_cmd,%s_%d)'</span> % (name, count)]
<a name="l01001"></a>01001 
<a name="l01002"></a>01002         <span class="keywordflow">if</span> name == <span class="stringliteral">'resources_grit'</span>:
<a name="l01003"></a>01003           <span class="comment"># HACK: This is ugly.  Grit intentionally doesn't touch the</span>
<a name="l01004"></a>01004           <span class="comment"># timestamp of its output file when the file doesn't change,</span>
<a name="l01005"></a>01005           <span class="comment"># which is fine in hash-based dependency systems like scons</span>
<a name="l01006"></a>01006           <span class="comment"># and forge, but not kosher in the make world.  After some</span>
<a name="l01007"></a>01007           <span class="comment"># discussion, hacking around it here seems like the least</span>
<a name="l01008"></a>01008           <span class="comment"># amount of pain.</span>
<a name="l01009"></a>01009           actions += [<span class="stringliteral">'@touch --no-create $@'</span>]
<a name="l01010"></a>01010 
<a name="l01011"></a>01011         <span class="comment"># See the comment in WriteCopies about expanding env vars.</span>
<a name="l01012"></a>01012         outputs = [gyp.xcode_emulation.ExpandEnvVars(o, env) <span class="keywordflow">for</span> o <span class="keywordflow">in</span> outputs]
<a name="l01013"></a>01013         inputs = [gyp.xcode_emulation.ExpandEnvVars(i, env) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> inputs]
<a name="l01014"></a>01014 
<a name="l01015"></a>01015         outputs = map(self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#486b5604f4bc6403b8378c81db254cae">Absolutify</a>, outputs)
<a name="l01016"></a>01016         all_outputs += outputs
<a name="l01017"></a>01017         <span class="comment"># Only write the 'obj' and 'builddir' rules for the "primary" output</span>
<a name="l01018"></a>01018         <span class="comment"># (:1); it's superfluous for the "extra outputs", and this avoids</span>
<a name="l01019"></a>01019         <span class="comment"># accidentally writing duplicate dummy rules for those outputs.</span>
<a name="l01020"></a>01020         self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'%s: obj := $(abs_obj)'</span> % outputs[0])
<a name="l01021"></a>01021         self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'%s: builddir := $(abs_builddir)'</span> % outputs[0])
<a name="l01022"></a>01022         self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d263804a57c217978e3a1d034c1cc320">WriteMakeRule</a>(outputs, inputs + [<span class="stringliteral">'FORCE_DO_CMD'</span>], actions)
<a name="l01023"></a>01023         <span class="comment"># Spaces in rule filenames are not supported, but rule variables have</span>
<a name="l01024"></a>01024         <span class="comment"># spaces in them (e.g. RULE_INPUT_PATH expands to '$(abspath $&lt;)').</span>
<a name="l01025"></a>01025         <span class="comment"># The spaces within the variables are valid, so remove the variables</span>
<a name="l01026"></a>01026         <span class="comment"># before checking.</span>
<a name="l01027"></a>01027         variables_with_spaces = re.compile(<span class="stringliteral">r'\$\([^ ]* \$&lt;\)'</span>)
<a name="l01028"></a>01028         <span class="keywordflow">for</span> output <span class="keywordflow">in</span> outputs:
<a name="l01029"></a>01029           output = re.sub(variables_with_spaces, <span class="stringliteral">''</span>, output)
<a name="l01030"></a>01030           <span class="keyword">assert</span> <span class="stringliteral">' '</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> output, (
<a name="l01031"></a>01031               <span class="stringliteral">"Spaces in rule filenames not yet supported (%s)"</span>  % output)
<a name="l01032"></a>01032         self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'all_deps += %s'</span> % <span class="stringliteral">' '</span>.join(outputs))
<a name="l01033"></a>01033 
<a name="l01034"></a>01034         action = [self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#88c6708e9588f546826f6886970f724d">ExpandInputRoot</a>(ac, rule_source_root,
<a name="l01035"></a>01035                                        rule_source_dirname)
<a name="l01036"></a>01036                   <span class="keywordflow">for</span> ac <span class="keywordflow">in</span> rule[<span class="stringliteral">'action'</span>]]
<a name="l01037"></a>01037         mkdirs = <span class="stringliteral">''</span>
<a name="l01038"></a>01038         <span class="keywordflow">if</span> len(dirs) &gt; 0:
<a name="l01039"></a>01039           mkdirs = <span class="stringliteral">'mkdir -p %s; '</span> % <span class="stringliteral">' '</span>.join(dirs)
<a name="l01040"></a>01040         cd_action = <span class="stringliteral">'cd %s; '</span> % Sourceify(self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#a28dc103258589d9cb421197fe2de90b">path</a> <span class="keywordflow">or</span> <span class="stringliteral">'.'</span>)
<a name="l01041"></a>01041 
<a name="l01042"></a>01042         <span class="comment"># action, cd_action, and mkdirs get written to a toplevel variable</span>
<a name="l01043"></a>01043         <span class="comment"># called cmd_foo. Toplevel variables can't handle things that change</span>
<a name="l01044"></a>01044         <span class="comment"># per makefile like $(TARGET), so hardcode the target.</span>
<a name="l01045"></a>01045         <span class="keywordflow">if</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'mac'</span>:
<a name="l01046"></a>01046           action = [gyp.xcode_emulation.ExpandEnvVars(command, env)
<a name="l01047"></a>01047                     <span class="keywordflow">for</span> command <span class="keywordflow">in</span> action]
<a name="l01048"></a>01048         action = gyp.common.EncodePOSIXShellList(action)
<a name="l01049"></a>01049         action = action.replace(<span class="stringliteral">'$(TARGET)'</span>, self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>)
<a name="l01050"></a>01050         cd_action = cd_action.replace(<span class="stringliteral">'$(TARGET)'</span>, self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>)
<a name="l01051"></a>01051         mkdirs = mkdirs.replace(<span class="stringliteral">'$(TARGET)'</span>, self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>)
<a name="l01052"></a>01052 
<a name="l01053"></a>01053         <span class="comment"># Set LD_LIBRARY_PATH in case the rule runs an executable from this</span>
<a name="l01054"></a>01054         <span class="comment"># build which links to shared libs from this build.</span>
<a name="l01055"></a>01055         <span class="comment"># rules run on the host, so they should in theory only use host</span>
<a name="l01056"></a>01056         <span class="comment"># libraries, but until everything is made cross-compile safe, also use</span>
<a name="l01057"></a>01057         <span class="comment"># target libraries.</span>
<a name="l01058"></a>01058         <span class="comment"># TODO(piman): when everything is cross-compile safe, remove lib.target</span>
<a name="l01059"></a>01059         self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(
<a name="l01060"></a>01060             <span class="stringliteral">"cmd_%(name)s_%(count)d = LD_LIBRARY_PATH="</span>
<a name="l01061"></a>01061               <span class="stringliteral">"$(builddir)/lib.host:$(builddir)/lib.target:$$LD_LIBRARY_PATH; "</span>
<a name="l01062"></a>01062               <span class="stringliteral">"export LD_LIBRARY_PATH; "</span>
<a name="l01063"></a>01063               <span class="stringliteral">"%(cd_action)s%(mkdirs)s%(action)s"</span> % {
<a name="l01064"></a>01064           <span class="stringliteral">'action'</span>: action,
<a name="l01065"></a>01065           <span class="stringliteral">'cd_action'</span>: cd_action,
<a name="l01066"></a>01066           <span class="stringliteral">'count'</span>: count,
<a name="l01067"></a>01067           <span class="stringliteral">'mkdirs'</span>: mkdirs,
<a name="l01068"></a>01068           <span class="stringliteral">'name'</span>: name,
<a name="l01069"></a>01069         })
<a name="l01070"></a>01070         self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(
<a name="l01071"></a>01071             <span class="stringliteral">'quiet_cmd_%(name)s_%(count)d = RULE %(name)s_%(count)d $@'</span> % {
<a name="l01072"></a>01072           <span class="stringliteral">'count'</span>: count,
<a name="l01073"></a>01073           <span class="stringliteral">'name'</span>: name,
<a name="l01074"></a>01074         })
<a name="l01075"></a>01075         self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>()
<a name="l01076"></a>01076         count += 1
<a name="l01077"></a>01077 
<a name="l01078"></a>01078       outputs_variable = <span class="stringliteral">'rule_%s_outputs'</span> % name
<a name="l01079"></a>01079       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#93de12c6d9b1aa90c3f3a8b0bfc1fffa">WriteList</a>(all_outputs, outputs_variable)
<a name="l01080"></a>01080       extra_outputs.append(<span class="stringliteral">'$(%s)'</span> % outputs_variable)
<a name="l01081"></a>01081 
<a name="l01082"></a>01082       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'### Finished generating for rule: %s'</span> % name)
<a name="l01083"></a>01083       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>()
<a name="l01084"></a>01084     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'### Finished generating for all rules'</span>)
<a name="l01085"></a>01085     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">''</span>)
<a name="l01086"></a>01086 
<a name="l01087"></a>01087 
<a name="l01088"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#cb7218d4227c7eb14ab546b33c2e7cb8">01088</a>   <span class="keyword">def </span><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#cb7218d4227c7eb14ab546b33c2e7cb8">WriteCopies</a>(self, copies, extra_outputs, part_of_all):
<a name="l01089"></a>01089     <span class="stringliteral">"""Write Makefile code for any 'copies' from the gyp input.</span>
<a name="l01090"></a>01090 <span class="stringliteral"></span>
<a name="l01091"></a>01091 <span class="stringliteral">    extra_outputs: a list that will be filled in with any outputs of this action</span>
<a name="l01092"></a>01092 <span class="stringliteral">                   (used to make other pieces dependent on this action)</span>
<a name="l01093"></a>01093 <span class="stringliteral">    part_of_all: flag indicating this target is part of 'all'</span>
<a name="l01094"></a>01094 <span class="stringliteral">    """</span>
<a name="l01095"></a>01095     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'### Generated for copy rule.'</span>)
<a name="l01096"></a>01096 
<a name="l01097"></a>01097     variable = StringToMakefileVariable(self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#073ea158f37820e141c05902aceb2889">qualified_target</a> + <span class="stringliteral">'_copies'</span>)
<a name="l01098"></a>01098     outputs = []
<a name="l01099"></a>01099     <span class="keywordflow">for</span> copy <span class="keywordflow">in</span> copies:
<a name="l01100"></a>01100       <span class="keywordflow">for</span> path <span class="keywordflow">in</span> copy[<span class="stringliteral">'files'</span>]:
<a name="l01101"></a>01101         <span class="comment"># Absolutify() may call normpath, and will strip trailing slashes.</span>
<a name="l01102"></a>01102         path = Sourceify(self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#486b5604f4bc6403b8378c81db254cae">Absolutify</a>(path))
<a name="l01103"></a>01103         filename = os.path.split(path)[1]
<a name="l01104"></a>01104         output = Sourceify(self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#486b5604f4bc6403b8378c81db254cae">Absolutify</a>(os.path.join(copy[<span class="stringliteral">'destination'</span>],
<a name="l01105"></a>01105                                                         filename)))
<a name="l01106"></a>01106 
<a name="l01107"></a>01107         <span class="comment"># If the output path has variables in it, which happens in practice for</span>
<a name="l01108"></a>01108         <span class="comment"># 'copies', writing the environment as target-local doesn't work,</span>
<a name="l01109"></a>01109         <span class="comment"># because the variables are already needed for the target name.</span>
<a name="l01110"></a>01110         <span class="comment"># Copying the environment variables into global make variables doesn't</span>
<a name="l01111"></a>01111         <span class="comment"># work either, because then the .d files will potentially contain spaces</span>
<a name="l01112"></a>01112         <span class="comment"># after variable expansion, and .d file handling cannot handle spaces.</span>
<a name="l01113"></a>01113         <span class="comment"># As a workaround, manually expand variables at gyp time. Since 'copies'</span>
<a name="l01114"></a>01114         <span class="comment"># can't run scripts, there's no need to write the env then.</span>
<a name="l01115"></a>01115         <span class="comment"># WriteDoCmd() will escape spaces for .d files.</span>
<a name="l01116"></a>01116         env = self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#1e807b9147c1af2adaa10b07e93b51a4">GetSortedXcodeEnv</a>()
<a name="l01117"></a>01117         output = gyp.xcode_emulation.ExpandEnvVars(output, env)
<a name="l01118"></a>01118         path = gyp.xcode_emulation.ExpandEnvVars(path, env)
<a name="l01119"></a>01119         self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#2e909e33b1c662b05d5b2e5cfcb67d52">WriteDoCmd</a>([output], [path], <span class="stringliteral">'copy'</span>, part_of_all)
<a name="l01120"></a>01120         outputs.append(output)
<a name="l01121"></a>01121     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'%s = %s'</span> % (variable, <span class="stringliteral">' '</span>.join(map(QuoteSpaces, outputs))))
<a name="l01122"></a>01122     extra_outputs.append(<span class="stringliteral">'$(%s)'</span> % variable)
<a name="l01123"></a>01123     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>()
<a name="l01124"></a>01124 
<a name="l01125"></a>01125 
<a name="l01126"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#9b758bfad28d2aa805d521b0adb55533">01126</a>   <span class="keyword">def </span><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#9b758bfad28d2aa805d521b0adb55533">WriteMacBundleResources</a>(self, resources, bundle_deps):
<a name="l01127"></a>01127     <span class="stringliteral">"""Writes Makefile code for 'mac_bundle_resources'."""</span>
<a name="l01128"></a>01128     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'### Generated for mac_bundle_resources'</span>)
<a name="l01129"></a>01129 
<a name="l01130"></a>01130     <span class="keywordflow">for</span> output, res <span class="keywordflow">in</span> gyp.xcode_emulation.GetMacBundleResources(
<a name="l01131"></a>01131         generator_default_variables[<span class="stringliteral">'PRODUCT_DIR'</span>], self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>,
<a name="l01132"></a>01132         map(Sourceify, map(self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#486b5604f4bc6403b8378c81db254cae">Absolutify</a>, resources))):
<a name="l01133"></a>01133       _, ext = os.path.splitext(output)
<a name="l01134"></a>01134       <span class="keywordflow">if</span> ext != <span class="stringliteral">'.xcassets'</span>:
<a name="l01135"></a>01135         <span class="comment"># Make does not supports '.xcassets' emulation.</span>
<a name="l01136"></a>01136         self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#2e909e33b1c662b05d5b2e5cfcb67d52">WriteDoCmd</a>([output], [res], <span class="stringliteral">'mac_tool,,,copy-bundle-resource'</span>,
<a name="l01137"></a>01137                         part_of_all=<span class="keyword">True</span>)
<a name="l01138"></a>01138         bundle_deps.append(output)
<a name="l01139"></a>01139 
<a name="l01140"></a>01140 
<a name="l01141"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#efdf9de404554421cf997b6b1d0c44fc">01141</a>   <span class="keyword">def </span><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#efdf9de404554421cf997b6b1d0c44fc">WriteMacInfoPlist</a>(self, bundle_deps):
<a name="l01142"></a>01142     <span class="stringliteral">"""Write Makefile code for bundle Info.plist files."""</span>
<a name="l01143"></a>01143     info_plist, out, defines, extra_env = gyp.xcode_emulation.GetMacInfoPlist(
<a name="l01144"></a>01144         generator_default_variables[<span class="stringliteral">'PRODUCT_DIR'</span>], self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>,
<a name="l01145"></a>01145         <span class="keyword">lambda</span> p: Sourceify(self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#486b5604f4bc6403b8378c81db254cae">Absolutify</a>(p)))
<a name="l01146"></a>01146     <span class="keywordflow">if</span> <span class="keywordflow">not</span> info_plist:
<a name="l01147"></a>01147       <span class="keywordflow">return</span>
<a name="l01148"></a>01148     <span class="keywordflow">if</span> defines:
<a name="l01149"></a>01149       <span class="comment"># Create an intermediate file to store preprocessed results.</span>
<a name="l01150"></a>01150       intermediate_plist = (<span class="stringliteral">'$(obj).$(TOOLSET)/$(TARGET)/'</span> +
<a name="l01151"></a>01151           os.path.basename(info_plist))
<a name="l01152"></a>01152       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#93de12c6d9b1aa90c3f3a8b0bfc1fffa">WriteList</a>(defines, intermediate_plist + <span class="stringliteral">': INFOPLIST_DEFINES'</span>, <span class="stringliteral">'-D'</span>,
<a name="l01153"></a>01153           quoter=EscapeCppDefine)
<a name="l01154"></a>01154       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d263804a57c217978e3a1d034c1cc320">WriteMakeRule</a>([intermediate_plist], [info_plist],
<a name="l01155"></a>01155           [<span class="stringliteral">'$(call do_cmd,infoplist)'</span>,
<a name="l01156"></a>01156            <span class="comment"># "Convert" the plist so that any weird whitespace changes from the</span>
<a name="l01157"></a>01157            <span class="comment"># preprocessor do not affect the XML parser in mac_tool.</span>
<a name="l01158"></a>01158            <span class="stringliteral">'@plutil -convert xml1 $@ $@'</span>])
<a name="l01159"></a>01159       info_plist = intermediate_plist
<a name="l01160"></a>01160     <span class="comment"># plists can contain envvars and substitute them into the file.</span>
<a name="l01161"></a>01161     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#59ac35713dfadc41287f7e81fc662db6">WriteSortedXcodeEnv</a>(
<a name="l01162"></a>01162         out, self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#1e807b9147c1af2adaa10b07e93b51a4">GetSortedXcodeEnv</a>(additional_settings=extra_env))
<a name="l01163"></a>01163     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#2e909e33b1c662b05d5b2e5cfcb67d52">WriteDoCmd</a>([out], [info_plist], <span class="stringliteral">'mac_tool,,,copy-info-plist'</span>,
<a name="l01164"></a>01164                     part_of_all=<span class="keyword">True</span>)
<a name="l01165"></a>01165     bundle_deps.append(out)
<a name="l01166"></a>01166 
<a name="l01167"></a>01167 
<a name="l01168"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#7c3bf79a4bd2f19944fc222c6bcfffc0">01168</a>   <span class="keyword">def </span><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#7c3bf79a4bd2f19944fc222c6bcfffc0">WriteSources</a>(self, configs, deps, sources,
<a name="l01169"></a>01169                    extra_outputs, extra_link_deps,
<a name="l01170"></a>01170                    part_of_all, precompiled_header):
<a name="l01171"></a>01171     <span class="stringliteral">"""Write Makefile code for any 'sources' from the gyp input.</span>
<a name="l01172"></a>01172 <span class="stringliteral">    These are source files necessary to build the current target.</span>
<a name="l01173"></a>01173 <span class="stringliteral"></span>
<a name="l01174"></a>01174 <span class="stringliteral">    configs, deps, sources: input from gyp.</span>
<a name="l01175"></a>01175 <span class="stringliteral">    extra_outputs: a list of extra outputs this action should be dependent on;</span>
<a name="l01176"></a>01176 <span class="stringliteral">                   used to serialize action/rules before compilation</span>
<a name="l01177"></a>01177 <span class="stringliteral">    extra_link_deps: a list that will be filled in with any outputs of</span>
<a name="l01178"></a>01178 <span class="stringliteral">                     compilation (to be used in link lines)</span>
<a name="l01179"></a>01179 <span class="stringliteral">    part_of_all: flag indicating this target is part of 'all'</span>
<a name="l01180"></a>01180 <span class="stringliteral">    """</span>
<a name="l01181"></a>01181 
<a name="l01182"></a>01182     <span class="comment"># Write configuration-specific variables for CFLAGS, etc.</span>
<a name="l01183"></a>01183     <span class="keywordflow">for</span> configname <span class="keywordflow">in</span> sorted(configs.keys()):
<a name="l01184"></a>01184       config = configs[configname]
<a name="l01185"></a>01185       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#93de12c6d9b1aa90c3f3a8b0bfc1fffa">WriteList</a>(config.get(<span class="stringliteral">'defines'</span>), <span class="stringliteral">'DEFS_%s'</span> % configname, prefix=<span class="stringliteral">'-D'</span>,
<a name="l01186"></a>01186           quoter=EscapeCppDefine)
<a name="l01187"></a>01187 
<a name="l01188"></a>01188       <span class="keywordflow">if</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'mac'</span>:
<a name="l01189"></a>01189         cflags = self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>.GetCflags(configname)
<a name="l01190"></a>01190         cflags_c = self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>.GetCflagsC(configname)
<a name="l01191"></a>01191         cflags_cc = self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>.GetCflagsCC(configname)
<a name="l01192"></a>01192         cflags_objc = self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>.GetCflagsObjC(configname)
<a name="l01193"></a>01193         cflags_objcc = self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>.GetCflagsObjCC(configname)
<a name="l01194"></a>01194       <span class="keywordflow">else</span>:
<a name="l01195"></a>01195         cflags = config.get(<span class="stringliteral">'cflags'</span>)
<a name="l01196"></a>01196         cflags_c = config.get(<span class="stringliteral">'cflags_c'</span>)
<a name="l01197"></a>01197         cflags_cc = config.get(<span class="stringliteral">'cflags_cc'</span>)
<a name="l01198"></a>01198 
<a name="l01199"></a>01199       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">"# Flags passed to all source files."</span>);
<a name="l01200"></a>01200       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#93de12c6d9b1aa90c3f3a8b0bfc1fffa">WriteList</a>(cflags, <span class="stringliteral">'CFLAGS_%s'</span> % configname)
<a name="l01201"></a>01201       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">"# Flags passed to only C files."</span>);
<a name="l01202"></a>01202       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#93de12c6d9b1aa90c3f3a8b0bfc1fffa">WriteList</a>(cflags_c, <span class="stringliteral">'CFLAGS_C_%s'</span> % configname)
<a name="l01203"></a>01203       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">"# Flags passed to only C++ files."</span>);
<a name="l01204"></a>01204       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#93de12c6d9b1aa90c3f3a8b0bfc1fffa">WriteList</a>(cflags_cc, <span class="stringliteral">'CFLAGS_CC_%s'</span> % configname)
<a name="l01205"></a>01205       <span class="keywordflow">if</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'mac'</span>:
<a name="l01206"></a>01206         self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">"# Flags passed to only ObjC files."</span>);
<a name="l01207"></a>01207         self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#93de12c6d9b1aa90c3f3a8b0bfc1fffa">WriteList</a>(cflags_objc, <span class="stringliteral">'CFLAGS_OBJC_%s'</span> % configname)
<a name="l01208"></a>01208         self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">"# Flags passed to only ObjC++ files."</span>);
<a name="l01209"></a>01209         self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#93de12c6d9b1aa90c3f3a8b0bfc1fffa">WriteList</a>(cflags_objcc, <span class="stringliteral">'CFLAGS_OBJCC_%s'</span> % configname)
<a name="l01210"></a>01210       includes = config.get(<span class="stringliteral">'include_dirs'</span>)
<a name="l01211"></a>01211       <span class="keywordflow">if</span> includes:
<a name="l01212"></a>01212         includes = map(Sourceify, map(self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#486b5604f4bc6403b8378c81db254cae">Absolutify</a>, includes))
<a name="l01213"></a>01213       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#93de12c6d9b1aa90c3f3a8b0bfc1fffa">WriteList</a>(includes, <span class="stringliteral">'INCS_%s'</span> % configname, prefix=<span class="stringliteral">'-I'</span>)
<a name="l01214"></a>01214 
<a name="l01215"></a>01215     compilable = filter(Compilable, sources)
<a name="l01216"></a>01216     objs = map(self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#5cdfe11e7d56d367238d8ff795d686bf">Objectify</a>, map(self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#486b5604f4bc6403b8378c81db254cae">Absolutify</a>, map(Target, compilable)))
<a name="l01217"></a>01217     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#93de12c6d9b1aa90c3f3a8b0bfc1fffa">WriteList</a>(objs, <span class="stringliteral">'OBJS'</span>)
<a name="l01218"></a>01218 
<a name="l01219"></a>01219     <span class="keywordflow">for</span> obj <span class="keywordflow">in</span> objs:
<a name="l01220"></a>01220       <span class="keyword">assert</span> <span class="stringliteral">' '</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> obj, (
<a name="l01221"></a>01221           <span class="stringliteral">"Spaces in object filenames not supported (%s)"</span>  % obj)
<a name="l01222"></a>01222     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'# Add to the list of files we specially track '</span>
<a name="l01223"></a>01223                  <span class="stringliteral">'dependencies for.'</span>)
<a name="l01224"></a>01224     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'all_deps += $(OBJS)'</span>)
<a name="l01225"></a>01225     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>()
<a name="l01226"></a>01226 
<a name="l01227"></a>01227     <span class="comment"># Make sure our dependencies are built first.</span>
<a name="l01228"></a>01228     <span class="keywordflow">if</span> deps:
<a name="l01229"></a>01229       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d263804a57c217978e3a1d034c1cc320">WriteMakeRule</a>([<span class="stringliteral">'$(OBJS)'</span>], deps,
<a name="l01230"></a>01230                          comment = <span class="stringliteral">'Make sure our dependencies are built '</span>
<a name="l01231"></a>01231                                    <span class="stringliteral">'before any of us.'</span>,
<a name="l01232"></a>01232                          order_only = <span class="keyword">True</span>)
<a name="l01233"></a>01233 
<a name="l01234"></a>01234     <span class="comment"># Make sure the actions and rules run first.</span>
<a name="l01235"></a>01235     <span class="comment"># If they generate any extra headers etc., the per-.o file dep tracking</span>
<a name="l01236"></a>01236     <span class="comment"># will catch the proper rebuilds, so order only is still ok here.</span>
<a name="l01237"></a>01237     <span class="keywordflow">if</span> extra_outputs:
<a name="l01238"></a>01238       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d263804a57c217978e3a1d034c1cc320">WriteMakeRule</a>([<span class="stringliteral">'$(OBJS)'</span>], extra_outputs,
<a name="l01239"></a>01239                          comment = <span class="stringliteral">'Make sure our actions/rules run '</span>
<a name="l01240"></a>01240                                    <span class="stringliteral">'before any of us.'</span>,
<a name="l01241"></a>01241                          order_only = <span class="keyword">True</span>)
<a name="l01242"></a>01242 
<a name="l01243"></a>01243     pchdeps = precompiled_header.GetObjDependencies(compilable, objs )
<a name="l01244"></a>01244     <span class="keywordflow">if</span> pchdeps:
<a name="l01245"></a>01245       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'# Dependencies from obj files to their precompiled headers'</span>)
<a name="l01246"></a>01246       <span class="keywordflow">for</span> source, obj, gch <span class="keywordflow">in</span> pchdeps:
<a name="l01247"></a>01247         self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'%s: %s'</span> % (obj, gch))
<a name="l01248"></a>01248       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'# End precompiled header dependencies'</span>)
<a name="l01249"></a>01249 
<a name="l01250"></a>01250     <span class="keywordflow">if</span> objs:
<a name="l01251"></a>01251       extra_link_deps.append(<span class="stringliteral">'$(OBJS)'</span>)
<a name="l01252"></a>01252       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">"""\</span>
<a name="l01253"></a>01253 <span class="stringliteral"># CFLAGS et al overrides must be target-local.</span>
<a name="l01254"></a>01254 <span class="stringliteral"># See "Target-specific Variable Values" in the GNU Make manual."""</span>)
<a name="l01255"></a>01255       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">"$(OBJS): TOOLSET := $(TOOLSET)"</span>)
<a name="l01256"></a>01256       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">"$(OBJS): GYP_CFLAGS := "</span>
<a name="l01257"></a>01257                    <span class="stringliteral">"$(DEFS_$(BUILDTYPE)) "</span>
<a name="l01258"></a>01258                    <span class="stringliteral">"$(INCS_$(BUILDTYPE)) "</span>
<a name="l01259"></a>01259                    <span class="stringliteral">"%s "</span> % precompiled_header.GetInclude(<span class="stringliteral">'c'</span>) +
<a name="l01260"></a>01260                    <span class="stringliteral">"$(CFLAGS_$(BUILDTYPE)) "</span>
<a name="l01261"></a>01261                    <span class="stringliteral">"$(CFLAGS_C_$(BUILDTYPE))"</span>)
<a name="l01262"></a>01262       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">"$(OBJS): GYP_CXXFLAGS := "</span>
<a name="l01263"></a>01263                    <span class="stringliteral">"$(DEFS_$(BUILDTYPE)) "</span>
<a name="l01264"></a>01264                    <span class="stringliteral">"$(INCS_$(BUILDTYPE)) "</span>
<a name="l01265"></a>01265                    <span class="stringliteral">"%s "</span> % precompiled_header.GetInclude(<span class="stringliteral">'cc'</span>) +
<a name="l01266"></a>01266                    <span class="stringliteral">"$(CFLAGS_$(BUILDTYPE)) "</span>
<a name="l01267"></a>01267                    <span class="stringliteral">"$(CFLAGS_CC_$(BUILDTYPE))"</span>)
<a name="l01268"></a>01268       <span class="keywordflow">if</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'mac'</span>:
<a name="l01269"></a>01269         self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">"$(OBJS): GYP_OBJCFLAGS := "</span>
<a name="l01270"></a>01270                      <span class="stringliteral">"$(DEFS_$(BUILDTYPE)) "</span>
<a name="l01271"></a>01271                      <span class="stringliteral">"$(INCS_$(BUILDTYPE)) "</span>
<a name="l01272"></a>01272                      <span class="stringliteral">"%s "</span> % precompiled_header.GetInclude(<span class="stringliteral">'m'</span>) +
<a name="l01273"></a>01273                      <span class="stringliteral">"$(CFLAGS_$(BUILDTYPE)) "</span>
<a name="l01274"></a>01274                      <span class="stringliteral">"$(CFLAGS_C_$(BUILDTYPE)) "</span>
<a name="l01275"></a>01275                      <span class="stringliteral">"$(CFLAGS_OBJC_$(BUILDTYPE))"</span>)
<a name="l01276"></a>01276         self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">"$(OBJS): GYP_OBJCXXFLAGS := "</span>
<a name="l01277"></a>01277                      <span class="stringliteral">"$(DEFS_$(BUILDTYPE)) "</span>
<a name="l01278"></a>01278                      <span class="stringliteral">"$(INCS_$(BUILDTYPE)) "</span>
<a name="l01279"></a>01279                      <span class="stringliteral">"%s "</span> % precompiled_header.GetInclude(<span class="stringliteral">'mm'</span>) +
<a name="l01280"></a>01280                      <span class="stringliteral">"$(CFLAGS_$(BUILDTYPE)) "</span>
<a name="l01281"></a>01281                      <span class="stringliteral">"$(CFLAGS_CC_$(BUILDTYPE)) "</span>
<a name="l01282"></a>01282                      <span class="stringliteral">"$(CFLAGS_OBJCC_$(BUILDTYPE))"</span>)
<a name="l01283"></a>01283 
<a name="l01284"></a>01284     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#e2943d5fd61220e2d1e6792614de8d16">WritePchTargets</a>(precompiled_header.GetPchBuildCommands())
<a name="l01285"></a>01285 
<a name="l01286"></a>01286     <span class="comment"># If there are any object files in our input file list, link them into our</span>
<a name="l01287"></a>01287     <span class="comment"># output.</span>
<a name="l01288"></a>01288     extra_link_deps += filter(Linkable, sources)
<a name="l01289"></a>01289 
<a name="l01290"></a>01290     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>()
<a name="l01291"></a>01291 
<a name="l01292"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#e2943d5fd61220e2d1e6792614de8d16">01292</a>   <span class="keyword">def </span><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#e2943d5fd61220e2d1e6792614de8d16">WritePchTargets</a>(self, pch_commands):
<a name="l01293"></a>01293     <span class="stringliteral">"""Writes make rules to compile prefix headers."""</span>
<a name="l01294"></a>01294     <span class="keywordflow">if</span> <span class="keywordflow">not</span> pch_commands:
<a name="l01295"></a>01295       <span class="keywordflow">return</span>
<a name="l01296"></a>01296 
<a name="l01297"></a>01297     <span class="keywordflow">for</span> gch, lang_flag, lang, input <span class="keywordflow">in</span> pch_commands:
<a name="l01298"></a>01298       extra_flags = {
<a name="l01299"></a>01299         <span class="stringliteral">'c'</span>: <span class="stringliteral">'$(CFLAGS_C_$(BUILDTYPE))'</span>,
<a name="l01300"></a>01300         <span class="stringliteral">'cc'</span>: <span class="stringliteral">'$(CFLAGS_CC_$(BUILDTYPE))'</span>,
<a name="l01301"></a>01301         <span class="stringliteral">'m'</span>: <span class="stringliteral">'$(CFLAGS_C_$(BUILDTYPE)) $(CFLAGS_OBJC_$(BUILDTYPE))'</span>,
<a name="l01302"></a>01302         <span class="stringliteral">'mm'</span>: <span class="stringliteral">'$(CFLAGS_CC_$(BUILDTYPE)) $(CFLAGS_OBJCC_$(BUILDTYPE))'</span>,
<a name="l01303"></a>01303       }[lang]
<a name="l01304"></a>01304       var_name = {
<a name="l01305"></a>01305         <span class="stringliteral">'c'</span>: <span class="stringliteral">'GYP_PCH_CFLAGS'</span>,
<a name="l01306"></a>01306         <span class="stringliteral">'cc'</span>: <span class="stringliteral">'GYP_PCH_CXXFLAGS'</span>,
<a name="l01307"></a>01307         <span class="stringliteral">'m'</span>: <span class="stringliteral">'GYP_PCH_OBJCFLAGS'</span>,
<a name="l01308"></a>01308         <span class="stringliteral">'mm'</span>: <span class="stringliteral">'GYP_PCH_OBJCXXFLAGS'</span>,
<a name="l01309"></a>01309       }[lang]
<a name="l01310"></a>01310       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">"%s: %s := %s "</span> % (gch, var_name, lang_flag) +
<a name="l01311"></a>01311                    <span class="stringliteral">"$(DEFS_$(BUILDTYPE)) "</span>
<a name="l01312"></a>01312                    <span class="stringliteral">"$(INCS_$(BUILDTYPE)) "</span>
<a name="l01313"></a>01313                    <span class="stringliteral">"$(CFLAGS_$(BUILDTYPE)) "</span> +
<a name="l01314"></a>01314                    extra_flags)
<a name="l01315"></a>01315 
<a name="l01316"></a>01316       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'%s: %s FORCE_DO_CMD'</span> % (gch, input))
<a name="l01317"></a>01317       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'\t@$(call do_cmd,pch_%s,1)'</span> % lang)
<a name="l01318"></a>01318       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">''</span>)
<a name="l01319"></a>01319       <span class="keyword">assert</span> <span class="stringliteral">' '</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> gch, (
<a name="l01320"></a>01320           <span class="stringliteral">"Spaces in gch filenames not supported (%s)"</span>  % gch)
<a name="l01321"></a>01321       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'all_deps += %s'</span> % gch)
<a name="l01322"></a>01322       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">''</span>)
<a name="l01323"></a>01323 
<a name="l01324"></a>01324 
<a name="l01325"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#467201aad2a9154c6557a43e0f6080b1">01325</a>   <span class="keyword">def </span><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#467201aad2a9154c6557a43e0f6080b1">ComputeOutputBasename</a>(self, spec):
<a name="l01326"></a>01326     <span class="stringliteral">"""Return the 'output basename' of a gyp spec.</span>
<a name="l01327"></a>01327 <span class="stringliteral"></span>
<a name="l01328"></a>01328 <span class="stringliteral">    E.g., the loadable module 'foobar' in directory 'baz' will produce</span>
<a name="l01329"></a>01329 <span class="stringliteral">      'libfoobar.so'</span>
<a name="l01330"></a>01330 <span class="stringliteral">    """</span>
<a name="l01331"></a>01331     <span class="keyword">assert</span> <span class="keywordflow">not</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#e9044354be1c8bc6f5f25fc45ec6f5df">is_mac_bundle</a>
<a name="l01332"></a>01332 
<a name="l01333"></a>01333     <span class="keywordflow">if</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'mac'</span> <span class="keywordflow">and</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> <span class="keywordflow">in</span> (
<a name="l01334"></a>01334         <span class="stringliteral">'static_library'</span>, <span class="stringliteral">'executable'</span>, <span class="stringliteral">'shared_library'</span>, <span class="stringliteral">'loadable_module'</span>):
<a name="l01335"></a>01335       <span class="keywordflow">return</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>.GetExecutablePath()
<a name="l01336"></a>01336 
<a name="l01337"></a>01337     target = spec[<span class="stringliteral">'target_name'</span>]
<a name="l01338"></a>01338     target_prefix = <span class="stringliteral">''</span>
<a name="l01339"></a>01339     target_ext = <span class="stringliteral">''</span>
<a name="l01340"></a>01340     <span class="keywordflow">if</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> == <span class="stringliteral">'static_library'</span>:
<a name="l01341"></a>01341       <span class="keywordflow">if</span> target[:3] == <span class="stringliteral">'lib'</span>:
<a name="l01342"></a>01342         target = target[3:]
<a name="l01343"></a>01343       target_prefix = <span class="stringliteral">'lib'</span>
<a name="l01344"></a>01344       target_ext = <span class="stringliteral">'.a'</span>
<a name="l01345"></a>01345     <span class="keywordflow">elif</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> <span class="keywordflow">in</span> (<span class="stringliteral">'loadable_module'</span>, <span class="stringliteral">'shared_library'</span>):
<a name="l01346"></a>01346       <span class="keywordflow">if</span> target[:3] == <span class="stringliteral">'lib'</span>:
<a name="l01347"></a>01347         target = target[3:]
<a name="l01348"></a>01348       target_prefix = <span class="stringliteral">'lib'</span>
<a name="l01349"></a>01349       target_ext = <span class="stringliteral">'.so'</span>
<a name="l01350"></a>01350     <span class="keywordflow">elif</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> == <span class="stringliteral">'none'</span>:
<a name="l01351"></a>01351       target = <span class="stringliteral">'%s.stamp'</span> % target
<a name="l01352"></a>01352     <span class="keywordflow">elif</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> != <span class="stringliteral">'executable'</span>:
<a name="l01353"></a>01353       <span class="keywordflow">print</span> (<span class="stringliteral">"ERROR: What output file should be generated?"</span>,
<a name="l01354"></a>01354              <span class="stringliteral">"type"</span>, self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a>, <span class="stringliteral">"target"</span>, target)
<a name="l01355"></a>01355 
<a name="l01356"></a>01356     target_prefix = spec.get(<span class="stringliteral">'product_prefix'</span>, target_prefix)
<a name="l01357"></a>01357     target = spec.get(<span class="stringliteral">'product_name'</span>, target)
<a name="l01358"></a>01358     product_ext = spec.get(<span class="stringliteral">'product_extension'</span>)
<a name="l01359"></a>01359     <span class="keywordflow">if</span> product_ext:
<a name="l01360"></a>01360       target_ext = <span class="stringliteral">'.'</span> + product_ext
<a name="l01361"></a>01361 
<a name="l01362"></a>01362     <span class="keywordflow">return</span> target_prefix + target + target_ext
<a name="l01363"></a>01363 
<a name="l01364"></a>01364 
<a name="l01365"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#6ef76211848804563b020cfc8b72fb8d">01365</a>   <span class="keyword">def </span><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#6ef76211848804563b020cfc8b72fb8d">_InstallImmediately</a>(self):
<a name="l01366"></a>01366     <span class="keywordflow">return</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">toolset</a> == <span class="stringliteral">'target'</span> <span class="keywordflow">and</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'mac'</span> <span class="keywordflow">and</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> <span class="keywordflow">in</span> (
<a name="l01367"></a>01367           <span class="stringliteral">'static_library'</span>, <span class="stringliteral">'executable'</span>, <span class="stringliteral">'shared_library'</span>, <span class="stringliteral">'loadable_module'</span>)
<a name="l01368"></a>01368 
<a name="l01369"></a>01369 
<a name="l01370"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#097c9e2913bffe213c7a56b1b1508997">01370</a>   <span class="keyword">def </span><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#097c9e2913bffe213c7a56b1b1508997">ComputeOutput</a>(self, spec):
<a name="l01371"></a>01371     <span class="stringliteral">"""Return the 'output' (full output path) of a gyp spec.</span>
<a name="l01372"></a>01372 <span class="stringliteral"></span>
<a name="l01373"></a>01373 <span class="stringliteral">    E.g., the loadable module 'foobar' in directory 'baz' will produce</span>
<a name="l01374"></a>01374 <span class="stringliteral">      '$(obj)/baz/libfoobar.so'</span>
<a name="l01375"></a>01375 <span class="stringliteral">    """</span>
<a name="l01376"></a>01376     <span class="keyword">assert</span> <span class="keywordflow">not</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#e9044354be1c8bc6f5f25fc45ec6f5df">is_mac_bundle</a>
<a name="l01377"></a>01377 
<a name="l01378"></a>01378     path = os.path.join(<span class="stringliteral">'$(obj).'</span> + self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">toolset</a>, self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#a28dc103258589d9cb421197fe2de90b">path</a>)
<a name="l01379"></a>01379     <span class="keywordflow">if</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> == <span class="stringliteral">'executable'</span> <span class="keywordflow">or</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#6ef76211848804563b020cfc8b72fb8d">_InstallImmediately</a>():
<a name="l01380"></a>01380       path = <span class="stringliteral">'$(builddir)'</span>
<a name="l01381"></a>01381     path = spec.get(<span class="stringliteral">'product_dir'</span>, path)
<a name="l01382"></a>01382     <span class="keywordflow">return</span> os.path.join(path, self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#467201aad2a9154c6557a43e0f6080b1">ComputeOutputBasename</a>(spec))
<a name="l01383"></a>01383 
<a name="l01384"></a>01384 
<a name="l01385"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#5696affe1fc78b209b96f47f93e7abb4">01385</a>   <span class="keyword">def </span><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#5696affe1fc78b209b96f47f93e7abb4">ComputeMacBundleOutput</a>(self, spec):
<a name="l01386"></a>01386     <span class="stringliteral">"""Return the 'output' (full output path) to a bundle output directory."""</span>
<a name="l01387"></a>01387     <span class="keyword">assert</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#e9044354be1c8bc6f5f25fc45ec6f5df">is_mac_bundle</a>
<a name="l01388"></a>01388     path = generator_default_variables[<span class="stringliteral">'PRODUCT_DIR'</span>]
<a name="l01389"></a>01389     <span class="keywordflow">return</span> os.path.join(path, self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>.GetWrapperName())
<a name="l01390"></a>01390 
<a name="l01391"></a>01391 
<a name="l01392"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#092f47342a074b398b6d5c684501690e">01392</a>   <span class="keyword">def </span><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#092f47342a074b398b6d5c684501690e">ComputeMacBundleBinaryOutput</a>(self, spec):
<a name="l01393"></a>01393     <span class="stringliteral">"""Return the 'output' (full output path) to the binary in a bundle."""</span>
<a name="l01394"></a>01394     path = generator_default_variables[<span class="stringliteral">'PRODUCT_DIR'</span>]
<a name="l01395"></a>01395     <span class="keywordflow">return</span> os.path.join(path, self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>.GetExecutablePath())
<a name="l01396"></a>01396 
<a name="l01397"></a>01397 
<a name="l01398"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d5018dacf3e72356c231736611d30af0">01398</a>   <span class="keyword">def </span><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d5018dacf3e72356c231736611d30af0">ComputeDeps</a>(self, spec):
<a name="l01399"></a>01399     <span class="stringliteral">"""Compute the dependencies of a gyp spec.</span>
<a name="l01400"></a>01400 <span class="stringliteral"></span>
<a name="l01401"></a>01401 <span class="stringliteral">    Returns a tuple (deps, link_deps), where each is a list of</span>
<a name="l01402"></a>01402 <span class="stringliteral">    filenames that will need to be put in front of make for either</span>
<a name="l01403"></a>01403 <span class="stringliteral">    building (deps) or linking (link_deps).</span>
<a name="l01404"></a>01404 <span class="stringliteral">    """</span>
<a name="l01405"></a>01405     deps = []
<a name="l01406"></a>01406     link_deps = []
<a name="l01407"></a>01407     <span class="keywordflow">if</span> <span class="stringliteral">'dependencies'</span> <span class="keywordflow">in</span> spec:
<a name="l01408"></a>01408       deps.extend([target_outputs[dep] <span class="keywordflow">for</span> dep <span class="keywordflow">in</span> spec[<span class="stringliteral">'dependencies'</span>]
<a name="l01409"></a>01409                    <span class="keywordflow">if</span> target_outputs[dep]])
<a name="l01410"></a>01410       <span class="keywordflow">for</span> dep <span class="keywordflow">in</span> spec[<span class="stringliteral">'dependencies'</span>]:
<a name="l01411"></a>01411         <span class="keywordflow">if</span> dep <span class="keywordflow">in</span> target_link_deps:
<a name="l01412"></a>01412           link_deps.append(target_link_deps[dep])
<a name="l01413"></a>01413       deps.extend(link_deps)
<a name="l01414"></a>01414       <span class="comment"># TODO: It seems we need to transitively link in libraries (e.g. -lfoo)?</span>
<a name="l01415"></a>01415       <span class="comment"># This hack makes it work:</span>
<a name="l01416"></a>01416       <span class="comment"># link_deps.extend(spec.get('libraries', []))</span>
<a name="l01417"></a>01417     <span class="keywordflow">return</span> (gyp.common.uniquer(deps), gyp.common.uniquer(link_deps))
<a name="l01418"></a>01418 
<a name="l01419"></a>01419 
<a name="l01420"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#c724c6ed3de1c3504c09448340a228bc">01420</a>   <span class="keyword">def </span><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#c724c6ed3de1c3504c09448340a228bc">WriteDependencyOnExtraOutputs</a>(self, target, extra_outputs):
<a name="l01421"></a>01421     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d263804a57c217978e3a1d034c1cc320">WriteMakeRule</a>([self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#9fac3d232e8876b6835d052a93b30bd0">output_binary</a>], extra_outputs,
<a name="l01422"></a>01422                        comment = <span class="stringliteral">'Build our special outputs first.'</span>,
<a name="l01423"></a>01423                        order_only = <span class="keyword">True</span>)
<a name="l01424"></a>01424 
<a name="l01425"></a>01425 
<a name="l01426"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#203d0a7515c00ce74d55f93e632eedfe">01426</a>   <span class="keyword">def </span><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#203d0a7515c00ce74d55f93e632eedfe">WriteTarget</a>(self, spec, configs, deps, link_deps, bundle_deps,
<a name="l01427"></a>01427                   extra_outputs, part_of_all):
<a name="l01428"></a>01428     <span class="stringliteral">"""Write Makefile code to produce the final target of the gyp spec.</span>
<a name="l01429"></a>01429 <span class="stringliteral"></span>
<a name="l01430"></a>01430 <span class="stringliteral">    spec, configs: input from gyp.</span>
<a name="l01431"></a>01431 <span class="stringliteral">    deps, link_deps: dependency lists; see ComputeDeps()</span>
<a name="l01432"></a>01432 <span class="stringliteral">    extra_outputs: any extra outputs that our target should depend on</span>
<a name="l01433"></a>01433 <span class="stringliteral">    part_of_all: flag indicating this target is part of 'all'</span>
<a name="l01434"></a>01434 <span class="stringliteral">    """</span>
<a name="l01435"></a>01435 
<a name="l01436"></a>01436     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'### Rules for final target.'</span>)
<a name="l01437"></a>01437 
<a name="l01438"></a>01438     <span class="keywordflow">if</span> extra_outputs:
<a name="l01439"></a>01439       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#c724c6ed3de1c3504c09448340a228bc">WriteDependencyOnExtraOutputs</a>(self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#9fac3d232e8876b6835d052a93b30bd0">output_binary</a>, extra_outputs)
<a name="l01440"></a>01440       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d263804a57c217978e3a1d034c1cc320">WriteMakeRule</a>(extra_outputs, deps,
<a name="l01441"></a>01441                          comment=(<span class="stringliteral">'Preserve order dependency of '</span>
<a name="l01442"></a>01442                                   <span class="stringliteral">'special output on deps.'</span>),
<a name="l01443"></a>01443                          order_only = <span class="keyword">True</span>)
<a name="l01444"></a>01444 
<a name="l01445"></a>01445     target_postbuilds = {}
<a name="l01446"></a>01446     <span class="keywordflow">if</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> != <span class="stringliteral">'none'</span>:
<a name="l01447"></a>01447       <span class="keywordflow">for</span> configname <span class="keywordflow">in</span> sorted(configs.keys()):
<a name="l01448"></a>01448         config = configs[configname]
<a name="l01449"></a>01449         <span class="keywordflow">if</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'mac'</span>:
<a name="l01450"></a>01450           ldflags = self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>.GetLdflags(configname,
<a name="l01451"></a>01451               generator_default_variables[<span class="stringliteral">'PRODUCT_DIR'</span>],
<a name="l01452"></a>01452               <span class="keyword">lambda</span> p: Sourceify(self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#486b5604f4bc6403b8378c81db254cae">Absolutify</a>(p)))
<a name="l01453"></a>01453 
<a name="l01454"></a>01454           <span class="comment"># TARGET_POSTBUILDS_$(BUILDTYPE) is added to postbuilds later on.</span>
<a name="l01455"></a>01455           gyp_to_build = gyp.common.InvertRelativePath(self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#a28dc103258589d9cb421197fe2de90b">path</a>)
<a name="l01456"></a>01456           target_postbuild = self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>.AddImplicitPostbuilds(
<a name="l01457"></a>01457               configname,
<a name="l01458"></a>01458               QuoteSpaces(os.path.normpath(os.path.join(gyp_to_build,
<a name="l01459"></a>01459                                                         self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d288825273ed7192429ab0474fb2d4a0">output</a>))),
<a name="l01460"></a>01460               QuoteSpaces(os.path.normpath(os.path.join(gyp_to_build,
<a name="l01461"></a>01461                                                         self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#9fac3d232e8876b6835d052a93b30bd0">output_binary</a>))))
<a name="l01462"></a>01462           <span class="keywordflow">if</span> target_postbuild:
<a name="l01463"></a>01463             target_postbuilds[configname] = target_postbuild
<a name="l01464"></a>01464         <span class="keywordflow">else</span>:
<a name="l01465"></a>01465           ldflags = config.get(<span class="stringliteral">'ldflags'</span>, [])
<a name="l01466"></a>01466           <span class="comment"># Compute an rpath for this output if needed.</span>
<a name="l01467"></a>01467           <span class="keywordflow">if</span> any(dep.endswith(<span class="stringliteral">'.so'</span>) <span class="keywordflow">or</span> <span class="stringliteral">'.so.'</span> <span class="keywordflow">in</span> dep <span class="keywordflow">for</span> dep <span class="keywordflow">in</span> deps):
<a name="l01468"></a>01468             <span class="comment"># We want to get the literal string "$ORIGIN" into the link command,</span>
<a name="l01469"></a>01469             <span class="comment"># so we need lots of escaping.</span>
<a name="l01470"></a>01470             ldflags.append(<span class="stringliteral">r'-Wl,-rpath=\$$ORIGIN/lib.%s/'</span> % self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">toolset</a>)
<a name="l01471"></a>01471             ldflags.append(<span class="stringliteral">r'-Wl,-rpath-link=\$(builddir)/lib.%s/'</span> %
<a name="l01472"></a>01472                            self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">toolset</a>)
<a name="l01473"></a>01473         library_dirs = config.get(<span class="stringliteral">'library_dirs'</span>, [])
<a name="l01474"></a>01474         ldflags += [(<span class="stringliteral">'-L%s'</span> % library_dir) <span class="keywordflow">for</span> library_dir <span class="keywordflow">in</span> library_dirs]
<a name="l01475"></a>01475         self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#93de12c6d9b1aa90c3f3a8b0bfc1fffa">WriteList</a>(ldflags, <span class="stringliteral">'LDFLAGS_%s'</span> % configname)
<a name="l01476"></a>01476         <span class="keywordflow">if</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'mac'</span>:
<a name="l01477"></a>01477           self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#93de12c6d9b1aa90c3f3a8b0bfc1fffa">WriteList</a>(self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>.GetLibtoolflags(configname),
<a name="l01478"></a>01478                          <span class="stringliteral">'LIBTOOLFLAGS_%s'</span> % configname)
<a name="l01479"></a>01479       libraries = spec.get(<span class="stringliteral">'libraries'</span>)
<a name="l01480"></a>01480       <span class="keywordflow">if</span> libraries:
<a name="l01481"></a>01481         <span class="comment"># Remove duplicate entries</span>
<a name="l01482"></a>01482         libraries = gyp.common.uniquer(libraries)
<a name="l01483"></a>01483         <span class="keywordflow">if</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'mac'</span>:
<a name="l01484"></a>01484           libraries = self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>.AdjustLibraries(libraries)
<a name="l01485"></a>01485       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#93de12c6d9b1aa90c3f3a8b0bfc1fffa">WriteList</a>(libraries, <span class="stringliteral">'LIBS'</span>)
<a name="l01486"></a>01486       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'%s: GYP_LDFLAGS := $(LDFLAGS_$(BUILDTYPE))'</span> %
<a name="l01487"></a>01487           QuoteSpaces(self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#9fac3d232e8876b6835d052a93b30bd0">output_binary</a>))
<a name="l01488"></a>01488       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'%s: LIBS := $(LIBS)'</span> % QuoteSpaces(self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#9fac3d232e8876b6835d052a93b30bd0">output_binary</a>))
<a name="l01489"></a>01489 
<a name="l01490"></a>01490       <span class="keywordflow">if</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'mac'</span>:
<a name="l01491"></a>01491         self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'%s: GYP_LIBTOOLFLAGS := $(LIBTOOLFLAGS_$(BUILDTYPE))'</span> %
<a name="l01492"></a>01492             QuoteSpaces(self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#9fac3d232e8876b6835d052a93b30bd0">output_binary</a>))
<a name="l01493"></a>01493 
<a name="l01494"></a>01494     <span class="comment"># Postbuild actions. Like actions, but implicitly depend on the target's</span>
<a name="l01495"></a>01495     <span class="comment"># output.</span>
<a name="l01496"></a>01496     postbuilds = []
<a name="l01497"></a>01497     <span class="keywordflow">if</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'mac'</span>:
<a name="l01498"></a>01498       <span class="keywordflow">if</span> target_postbuilds:
<a name="l01499"></a>01499         postbuilds.append(<span class="stringliteral">'$(TARGET_POSTBUILDS_$(BUILDTYPE))'</span>)
<a name="l01500"></a>01500       postbuilds.extend(
<a name="l01501"></a>01501           gyp.xcode_emulation.GetSpecPostbuildCommands(spec))
<a name="l01502"></a>01502 
<a name="l01503"></a>01503     <span class="keywordflow">if</span> postbuilds:
<a name="l01504"></a>01504       <span class="comment"># Envvars may be referenced by TARGET_POSTBUILDS_$(BUILDTYPE),</span>
<a name="l01505"></a>01505       <span class="comment"># so we must output its definition first, since we declare variables</span>
<a name="l01506"></a>01506       <span class="comment"># using ":=".</span>
<a name="l01507"></a>01507       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#59ac35713dfadc41287f7e81fc662db6">WriteSortedXcodeEnv</a>(self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d288825273ed7192429ab0474fb2d4a0">output</a>, self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#b16a12808d09d8e1714e7d9aca9f4819">GetSortedXcodePostbuildEnv</a>())
<a name="l01508"></a>01508 
<a name="l01509"></a>01509       <span class="keywordflow">for</span> configname <span class="keywordflow">in</span> target_postbuilds:
<a name="l01510"></a>01510         self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'%s: TARGET_POSTBUILDS_%s := %s'</span> %
<a name="l01511"></a>01511             (QuoteSpaces(self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d288825273ed7192429ab0474fb2d4a0">output</a>),
<a name="l01512"></a>01512              configname,
<a name="l01513"></a>01513              gyp.common.EncodePOSIXShellList(target_postbuilds[configname])))
<a name="l01514"></a>01514 
<a name="l01515"></a>01515       <span class="comment"># Postbuilds expect to be run in the gyp file's directory, so insert an</span>
<a name="l01516"></a>01516       <span class="comment"># implicit postbuild to cd to there.</span>
<a name="l01517"></a>01517       postbuilds.insert(0, gyp.common.EncodePOSIXShellList([<span class="stringliteral">'cd'</span>, self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#a28dc103258589d9cb421197fe2de90b">path</a>]))
<a name="l01518"></a>01518       <span class="keywordflow">for</span> i <span class="keywordflow">in</span> xrange(len(postbuilds)):
<a name="l01519"></a>01519         <span class="keywordflow">if</span> <span class="keywordflow">not</span> postbuilds[i].startswith(<span class="stringliteral">'$'</span>):
<a name="l01520"></a>01520           postbuilds[i] = EscapeShellArgument(postbuilds[i])
<a name="l01521"></a>01521       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'%s: builddir := $(abs_builddir)'</span> % QuoteSpaces(self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d288825273ed7192429ab0474fb2d4a0">output</a>))
<a name="l01522"></a>01522       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'%s: POSTBUILDS := %s'</span> % (
<a name="l01523"></a>01523           QuoteSpaces(self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d288825273ed7192429ab0474fb2d4a0">output</a>), <span class="stringliteral">' '</span>.join(postbuilds)))
<a name="l01524"></a>01524 
<a name="l01525"></a>01525     <span class="comment"># A bundle directory depends on its dependencies such as bundle resources</span>
<a name="l01526"></a>01526     <span class="comment"># and bundle binary. When all dependencies have been built, the bundle</span>
<a name="l01527"></a>01527     <span class="comment"># needs to be packaged.</span>
<a name="l01528"></a>01528     <span class="keywordflow">if</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#e9044354be1c8bc6f5f25fc45ec6f5df">is_mac_bundle</a>:
<a name="l01529"></a>01529       <span class="comment"># If the framework doesn't contain a binary, then nothing depends</span>
<a name="l01530"></a>01530       <span class="comment"># on the actions -- make the framework depend on them directly too.</span>
<a name="l01531"></a>01531       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#c724c6ed3de1c3504c09448340a228bc">WriteDependencyOnExtraOutputs</a>(self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d288825273ed7192429ab0474fb2d4a0">output</a>, extra_outputs)
<a name="l01532"></a>01532 
<a name="l01533"></a>01533       <span class="comment"># Bundle dependencies. Note that the code below adds actions to this</span>
<a name="l01534"></a>01534       <span class="comment"># target, so if you move these two lines, move the lines below as well.</span>
<a name="l01535"></a>01535       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#93de12c6d9b1aa90c3f3a8b0bfc1fffa">WriteList</a>(map(QuoteSpaces, bundle_deps), <span class="stringliteral">'BUNDLE_DEPS'</span>)
<a name="l01536"></a>01536       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'%s: $(BUNDLE_DEPS)'</span> % QuoteSpaces(self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d288825273ed7192429ab0474fb2d4a0">output</a>))
<a name="l01537"></a>01537 
<a name="l01538"></a>01538       <span class="comment"># After the framework is built, package it. Needs to happen before</span>
<a name="l01539"></a>01539       <span class="comment"># postbuilds, since postbuilds depend on this.</span>
<a name="l01540"></a>01540       <span class="keywordflow">if</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> <span class="keywordflow">in</span> (<span class="stringliteral">'shared_library'</span>, <span class="stringliteral">'loadable_module'</span>):
<a name="l01541"></a>01541         self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'\t@$(call do_cmd,mac_package_framework,,,%s)'</span> %
<a name="l01542"></a>01542             self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>.GetFrameworkVersion())
<a name="l01543"></a>01543 
<a name="l01544"></a>01544       <span class="comment"># Bundle postbuilds can depend on the whole bundle, so run them after</span>
<a name="l01545"></a>01545       <span class="comment"># the bundle is packaged, not already after the bundle binary is done.</span>
<a name="l01546"></a>01546       <span class="keywordflow">if</span> postbuilds:
<a name="l01547"></a>01547         self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'\t@$(call do_postbuilds)'</span>)
<a name="l01548"></a>01548       postbuilds = []  <span class="comment"># Don't write postbuilds for target's output.</span>
<a name="l01549"></a>01549 
<a name="l01550"></a>01550       <span class="comment"># Needed by test/mac/gyptest-rebuild.py.</span>
<a name="l01551"></a>01551       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'\t@true  # No-op, used by tests'</span>)
<a name="l01552"></a>01552 
<a name="l01553"></a>01553       <span class="comment"># Since this target depends on binary and resources which are in</span>
<a name="l01554"></a>01554       <span class="comment"># nested subfolders, the framework directory will be older than</span>
<a name="l01555"></a>01555       <span class="comment"># its dependencies usually. To prevent this rule from executing</span>
<a name="l01556"></a>01556       <span class="comment"># on every build (expensive, especially with postbuilds), expliclity</span>
<a name="l01557"></a>01557       <span class="comment"># update the time on the framework directory.</span>
<a name="l01558"></a>01558       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'\t@touch -c %s'</span> % QuoteSpaces(self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d288825273ed7192429ab0474fb2d4a0">output</a>))
<a name="l01559"></a>01559 
<a name="l01560"></a>01560     <span class="keywordflow">if</span> postbuilds:
<a name="l01561"></a>01561       <span class="keyword">assert</span> <span class="keywordflow">not</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#e9044354be1c8bc6f5f25fc45ec6f5df">is_mac_bundle</a>, (<span class="stringliteral">'Postbuilds for bundles should be done '</span>
<a name="l01562"></a>01562           <span class="stringliteral">'on the bundle, not the binary (target \'%s\')'</span> % self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>)
<a name="l01563"></a>01563       <span class="keyword">assert</span> <span class="stringliteral">'product_dir'</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> spec, (<span class="stringliteral">'Postbuilds do not work with '</span>
<a name="l01564"></a>01564           <span class="stringliteral">'custom product_dir'</span>)
<a name="l01565"></a>01565 
<a name="l01566"></a>01566     <span class="keywordflow">if</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> == <span class="stringliteral">'executable'</span>:
<a name="l01567"></a>01567       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'%s: LD_INPUTS := %s'</span> % (
<a name="l01568"></a>01568           QuoteSpaces(self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#9fac3d232e8876b6835d052a93b30bd0">output_binary</a>),
<a name="l01569"></a>01569           <span class="stringliteral">' '</span>.join(map(QuoteSpaces, link_deps))))
<a name="l01570"></a>01570       <span class="keywordflow">if</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">toolset</a> == <span class="stringliteral">'host'</span> <span class="keywordflow">and</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'android'</span>:
<a name="l01571"></a>01571         self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#2e909e33b1c662b05d5b2e5cfcb67d52">WriteDoCmd</a>([self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#9fac3d232e8876b6835d052a93b30bd0">output_binary</a>], link_deps, <span class="stringliteral">'link_host'</span>,
<a name="l01572"></a>01572                         part_of_all, postbuilds=postbuilds)
<a name="l01573"></a>01573       <span class="keywordflow">else</span>:
<a name="l01574"></a>01574         self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#2e909e33b1c662b05d5b2e5cfcb67d52">WriteDoCmd</a>([self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#9fac3d232e8876b6835d052a93b30bd0">output_binary</a>], link_deps, <span class="stringliteral">'link'</span>, part_of_all,
<a name="l01575"></a>01575                         postbuilds=postbuilds)
<a name="l01576"></a>01576 
<a name="l01577"></a>01577     <span class="keywordflow">elif</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> == <span class="stringliteral">'static_library'</span>:
<a name="l01578"></a>01578       <span class="keywordflow">for</span> link_dep <span class="keywordflow">in</span> link_deps:
<a name="l01579"></a>01579         <span class="keyword">assert</span> <span class="stringliteral">' '</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> link_dep, (
<a name="l01580"></a>01580             <span class="stringliteral">"Spaces in alink input filenames not supported (%s)"</span>  % link_dep)
<a name="l01581"></a>01581       <span class="keywordflow">if</span> (self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> <span class="keywordflow">not</span> <span class="keywordflow">in</span> (<span class="stringliteral">'mac'</span>, <span class="stringliteral">'openbsd'</span>, <span class="stringliteral">'win'</span>) <span class="keywordflow">and</span> <span class="keywordflow">not</span>
<a name="l01582"></a>01582           self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#33917fd9cc5a5320b45b7f9db0754069">is_standalone_static_library</a>):
<a name="l01583"></a>01583         self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#2e909e33b1c662b05d5b2e5cfcb67d52">WriteDoCmd</a>([self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#9fac3d232e8876b6835d052a93b30bd0">output_binary</a>], link_deps, <span class="stringliteral">'alink_thin'</span>,
<a name="l01584"></a>01584                         part_of_all, postbuilds=postbuilds)
<a name="l01585"></a>01585       <span class="keywordflow">else</span>:
<a name="l01586"></a>01586         self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#2e909e33b1c662b05d5b2e5cfcb67d52">WriteDoCmd</a>([self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#9fac3d232e8876b6835d052a93b30bd0">output_binary</a>], link_deps, <span class="stringliteral">'alink'</span>, part_of_all,
<a name="l01587"></a>01587                         postbuilds=postbuilds)
<a name="l01588"></a>01588     <span class="keywordflow">elif</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> == <span class="stringliteral">'shared_library'</span>:
<a name="l01589"></a>01589       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'%s: LD_INPUTS := %s'</span> % (
<a name="l01590"></a>01590             QuoteSpaces(self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#9fac3d232e8876b6835d052a93b30bd0">output_binary</a>),
<a name="l01591"></a>01591             <span class="stringliteral">' '</span>.join(map(QuoteSpaces, link_deps))))
<a name="l01592"></a>01592       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#2e909e33b1c662b05d5b2e5cfcb67d52">WriteDoCmd</a>([self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#9fac3d232e8876b6835d052a93b30bd0">output_binary</a>], link_deps, <span class="stringliteral">'solink'</span>, part_of_all,
<a name="l01593"></a>01593                       postbuilds=postbuilds)
<a name="l01594"></a>01594     <span class="keywordflow">elif</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> == <span class="stringliteral">'loadable_module'</span>:
<a name="l01595"></a>01595       <span class="keywordflow">for</span> link_dep <span class="keywordflow">in</span> link_deps:
<a name="l01596"></a>01596         <span class="keyword">assert</span> <span class="stringliteral">' '</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> link_dep, (
<a name="l01597"></a>01597             <span class="stringliteral">"Spaces in module input filenames not supported (%s)"</span>  % link_dep)
<a name="l01598"></a>01598       <span class="keywordflow">if</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">toolset</a> == <span class="stringliteral">'host'</span> <span class="keywordflow">and</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'android'</span>:
<a name="l01599"></a>01599         self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#2e909e33b1c662b05d5b2e5cfcb67d52">WriteDoCmd</a>([self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#9fac3d232e8876b6835d052a93b30bd0">output_binary</a>], link_deps, <span class="stringliteral">'solink_module_host'</span>,
<a name="l01600"></a>01600                         part_of_all, postbuilds=postbuilds)
<a name="l01601"></a>01601       <span class="keywordflow">else</span>:
<a name="l01602"></a>01602         self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#2e909e33b1c662b05d5b2e5cfcb67d52">WriteDoCmd</a>(
<a name="l01603"></a>01603             [self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#9fac3d232e8876b6835d052a93b30bd0">output_binary</a>], link_deps, <span class="stringliteral">'solink_module'</span>, part_of_all,
<a name="l01604"></a>01604             postbuilds=postbuilds)
<a name="l01605"></a>01605     <span class="keywordflow">elif</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> == <span class="stringliteral">'none'</span>:
<a name="l01606"></a>01606       <span class="comment"># Write a stamp line.</span>
<a name="l01607"></a>01607       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#2e909e33b1c662b05d5b2e5cfcb67d52">WriteDoCmd</a>([self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#9fac3d232e8876b6835d052a93b30bd0">output_binary</a>], deps, <span class="stringliteral">'touch'</span>, part_of_all,
<a name="l01608"></a>01608                       postbuilds=postbuilds)
<a name="l01609"></a>01609     <span class="keywordflow">else</span>:
<a name="l01610"></a>01610       <span class="keywordflow">print</span> <span class="stringliteral">"WARNING: no output for"</span>, self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a>, target
<a name="l01611"></a>01611 
<a name="l01612"></a>01612     <span class="comment"># Add an alias for each target (if there are any outputs).</span>
<a name="l01613"></a>01613     <span class="comment"># Installable target aliases are created below.</span>
<a name="l01614"></a>01614     <span class="keywordflow">if</span> ((self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d288825273ed7192429ab0474fb2d4a0">output</a> <span class="keywordflow">and</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d288825273ed7192429ab0474fb2d4a0">output</a> != self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>) <span class="keywordflow">and</span>
<a name="l01615"></a>01615         (self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> <span class="keywordflow">not</span> <span class="keywordflow">in</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#1985b310632a1a5c5aa3a5e312938987">_INSTALLABLE_TARGETS</a>)):
<a name="l01616"></a>01616       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d263804a57c217978e3a1d034c1cc320">WriteMakeRule</a>([self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>], [self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d288825273ed7192429ab0474fb2d4a0">output</a>],
<a name="l01617"></a>01617                          comment=<span class="stringliteral">'Add target alias'</span>, phony = <span class="keyword">True</span>)
<a name="l01618"></a>01618       <span class="keywordflow">if</span> part_of_all:
<a name="l01619"></a>01619         self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d263804a57c217978e3a1d034c1cc320">WriteMakeRule</a>([<span class="stringliteral">'all'</span>], [self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>],
<a name="l01620"></a>01620                            comment = <span class="stringliteral">'Add target alias to "all" target.'</span>,
<a name="l01621"></a>01621                            phony = <span class="keyword">True</span>)
<a name="l01622"></a>01622 
<a name="l01623"></a>01623     <span class="comment"># Add special-case rules for our installable targets.</span>
<a name="l01624"></a>01624     <span class="comment"># 1) They need to install to the build dir or "product" dir.</span>
<a name="l01625"></a>01625     <span class="comment"># 2) They get shortcuts for building (e.g. "make chrome").</span>
<a name="l01626"></a>01626     <span class="comment"># 3) They are part of "make all".</span>
<a name="l01627"></a>01627     <span class="keywordflow">if</span> (self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> <span class="keywordflow">in</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#1985b310632a1a5c5aa3a5e312938987">_INSTALLABLE_TARGETS</a> <span class="keywordflow">or</span>
<a name="l01628"></a>01628         self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#33917fd9cc5a5320b45b7f9db0754069">is_standalone_static_library</a>):
<a name="l01629"></a>01629       <span class="keywordflow">if</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> == <span class="stringliteral">'shared_library'</span>:
<a name="l01630"></a>01630         file_desc = <span class="stringliteral">'shared library'</span>
<a name="l01631"></a>01631       <span class="keywordflow">elif</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> == <span class="stringliteral">'static_library'</span>:
<a name="l01632"></a>01632         file_desc = <span class="stringliteral">'static library'</span>
<a name="l01633"></a>01633       <span class="keywordflow">else</span>:
<a name="l01634"></a>01634         file_desc = <span class="stringliteral">'executable'</span>
<a name="l01635"></a>01635       install_path = self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d308655bbaac8e8cf75347b4ec62577e">_InstallableTargetInstallPath</a>()
<a name="l01636"></a>01636       installable_deps = [self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d288825273ed7192429ab0474fb2d4a0">output</a>]
<a name="l01637"></a>01637       <span class="keywordflow">if</span> (self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#0e211f0b0d4eacb53ffb5f68e4e8dd01">flavor</a> == <span class="stringliteral">'mac'</span> <span class="keywordflow">and</span> <span class="keywordflow">not</span> <span class="stringliteral">'product_dir'</span> <span class="keywordflow">in</span> spec <span class="keywordflow">and</span>
<a name="l01638"></a>01638           self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">toolset</a> == <span class="stringliteral">'target'</span>):
<a name="l01639"></a>01639         <span class="comment"># On mac, products are created in install_path immediately.</span>
<a name="l01640"></a>01640         <span class="keyword">assert</span> install_path == self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d288825273ed7192429ab0474fb2d4a0">output</a>, <span class="stringliteral">'%s != %s'</span> % (
<a name="l01641"></a>01641             install_path, self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d288825273ed7192429ab0474fb2d4a0">output</a>)
<a name="l01642"></a>01642 
<a name="l01643"></a>01643       <span class="comment"># Point the target alias to the final binary output.</span>
<a name="l01644"></a>01644       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d263804a57c217978e3a1d034c1cc320">WriteMakeRule</a>([self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>], [install_path],
<a name="l01645"></a>01645                          comment=<span class="stringliteral">'Add target alias'</span>, phony = <span class="keyword">True</span>)
<a name="l01646"></a>01646       <span class="keywordflow">if</span> install_path != self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d288825273ed7192429ab0474fb2d4a0">output</a>:
<a name="l01647"></a>01647         <span class="keyword">assert</span> <span class="keywordflow">not</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#e9044354be1c8bc6f5f25fc45ec6f5df">is_mac_bundle</a>  <span class="comment"># See comment a few lines above.</span>
<a name="l01648"></a>01648         self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#2e909e33b1c662b05d5b2e5cfcb67d52">WriteDoCmd</a>([install_path], [self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d288825273ed7192429ab0474fb2d4a0">output</a>], <span class="stringliteral">'copy'</span>,
<a name="l01649"></a>01649                         comment = <span class="stringliteral">'Copy this to the %s output path.'</span> %
<a name="l01650"></a>01650                         file_desc, part_of_all=part_of_all)
<a name="l01651"></a>01651         installable_deps.append(install_path)
<a name="l01652"></a>01652       <span class="keywordflow">if</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d288825273ed7192429ab0474fb2d4a0">output</a> != self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#e67d6c6e342775a03bd935d100b5b8fa">alias</a> <span class="keywordflow">and</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#e67d6c6e342775a03bd935d100b5b8fa">alias</a> != self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>:
<a name="l01653"></a>01653         self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d263804a57c217978e3a1d034c1cc320">WriteMakeRule</a>([self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#e67d6c6e342775a03bd935d100b5b8fa">alias</a>], installable_deps,
<a name="l01654"></a>01654                            comment = <span class="stringliteral">'Short alias for building this %s.'</span> %
<a name="l01655"></a>01655                            file_desc, phony = <span class="keyword">True</span>)
<a name="l01656"></a>01656       <span class="keywordflow">if</span> part_of_all:
<a name="l01657"></a>01657         self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d263804a57c217978e3a1d034c1cc320">WriteMakeRule</a>([<span class="stringliteral">'all'</span>], [install_path],
<a name="l01658"></a>01658                            comment = <span class="stringliteral">'Add %s to "all" target.'</span> % file_desc,
<a name="l01659"></a>01659                            phony = <span class="keyword">True</span>)
<a name="l01660"></a>01660 
<a name="l01661"></a>01661 
<a name="l01662"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#93de12c6d9b1aa90c3f3a8b0bfc1fffa">01662</a>   <span class="keyword">def </span><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#93de12c6d9b1aa90c3f3a8b0bfc1fffa">WriteList</a>(self, value_list, variable=None, prefix='',
<a name="l01663"></a>01663                 quoter=QuoteIfNecessary):
<a name="l01664"></a>01664     <span class="stringliteral">"""Write a variable definition that is a list of values.</span>
<a name="l01665"></a>01665 <span class="stringliteral"></span>
<a name="l01666"></a>01666 <span class="stringliteral">    E.g. WriteList(['a','b'], 'foo', prefix='blah') writes out</span>
<a name="l01667"></a>01667 <span class="stringliteral">         foo = blaha blahb</span>
<a name="l01668"></a>01668 <span class="stringliteral">    but in a pretty-printed style.</span>
<a name="l01669"></a>01669 <span class="stringliteral">    """</span>
<a name="l01670"></a>01670     values = <span class="stringliteral">''</span>
<a name="l01671"></a>01671     <span class="keywordflow">if</span> value_list:
<a name="l01672"></a>01672       value_list = [quoter(prefix + l) <span class="keywordflow">for</span> l <span class="keywordflow">in</span> value_list]
<a name="l01673"></a>01673       values = <span class="stringliteral">' \\\n\t'</span> + <span class="stringliteral">' \\\n\t'</span>.join(value_list)
<a name="l01674"></a>01674     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#883a1b899b644be7fc6d704c1d8e0c04">fp</a>.write(<span class="stringliteral">'%s :=%s\n\n'</span> % (variable, values))
<a name="l01675"></a>01675 
<a name="l01676"></a>01676 
<a name="l01677"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#2e909e33b1c662b05d5b2e5cfcb67d52">01677</a>   <span class="keyword">def </span><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#2e909e33b1c662b05d5b2e5cfcb67d52">WriteDoCmd</a>(self, outputs, inputs, command, part_of_all, comment=None,
<a name="l01678"></a>01678                  postbuilds=<span class="keyword">False</span>):
<a name="l01679"></a>01679     <span class="stringliteral">"""Write a Makefile rule that uses do_cmd.</span>
<a name="l01680"></a>01680 <span class="stringliteral"></span>
<a name="l01681"></a>01681 <span class="stringliteral">    This makes the outputs dependent on the command line that was run,</span>
<a name="l01682"></a>01682 <span class="stringliteral">    as well as support the V= make command line flag.</span>
<a name="l01683"></a>01683 <span class="stringliteral">    """</span>
<a name="l01684"></a>01684     suffix = <span class="stringliteral">''</span>
<a name="l01685"></a>01685     <span class="keywordflow">if</span> postbuilds:
<a name="l01686"></a>01686       <span class="keyword">assert</span> <span class="stringliteral">','</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> command
<a name="l01687"></a>01687       suffix = <span class="stringliteral">',,1'</span>  <span class="comment"># Tell do_cmd to honor $POSTBUILDS</span>
<a name="l01688"></a>01688     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d263804a57c217978e3a1d034c1cc320">WriteMakeRule</a>(outputs, inputs,
<a name="l01689"></a>01689                        actions = [<span class="stringliteral">'$(call do_cmd,%s%s)'</span> % (command, suffix)],
<a name="l01690"></a>01690                        comment = comment,
<a name="l01691"></a>01691                        force = <span class="keyword">True</span>)
<a name="l01692"></a>01692     <span class="comment"># Add our outputs to the list of targets we read depfiles from.</span>
<a name="l01693"></a>01693     <span class="comment"># all_deps is only used for deps file reading, and for deps files we replace</span>
<a name="l01694"></a>01694     <span class="comment"># spaces with ? because escaping doesn't work with make's $(sort) and</span>
<a name="l01695"></a>01695     <span class="comment"># other functions.</span>
<a name="l01696"></a>01696     outputs = [QuoteSpaces(o, SPACE_REPLACEMENT) <span class="keywordflow">for</span> o <span class="keywordflow">in</span> outputs]
<a name="l01697"></a>01697     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'all_deps += %s'</span> % <span class="stringliteral">' '</span>.join(outputs))
<a name="l01698"></a>01698 
<a name="l01699"></a>01699 
<a name="l01700"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d263804a57c217978e3a1d034c1cc320">01700</a>   <span class="keyword">def </span><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d263804a57c217978e3a1d034c1cc320">WriteMakeRule</a>(self, outputs, inputs, actions=None, comment=None,
<a name="l01701"></a>01701                     order_only=<span class="keyword">False</span>, force=<span class="keyword">False</span>, phony=<span class="keyword">False</span>):
<a name="l01702"></a>01702     <span class="stringliteral">"""Write a Makefile rule, with some extra tricks.</span>
<a name="l01703"></a>01703 <span class="stringliteral"></span>
<a name="l01704"></a>01704 <span class="stringliteral">    outputs: a list of outputs for the rule (note: this is not directly</span>
<a name="l01705"></a>01705 <span class="stringliteral">             supported by make; see comments below)</span>
<a name="l01706"></a>01706 <span class="stringliteral">    inputs: a list of inputs for the rule</span>
<a name="l01707"></a>01707 <span class="stringliteral">    actions: a list of shell commands to run for the rule</span>
<a name="l01708"></a>01708 <span class="stringliteral">    comment: a comment to put in the Makefile above the rule (also useful</span>
<a name="l01709"></a>01709 <span class="stringliteral">             for making this Python script's code self-documenting)</span>
<a name="l01710"></a>01710 <span class="stringliteral">    order_only: if true, makes the dependency order-only</span>
<a name="l01711"></a>01711 <span class="stringliteral">    force: if true, include FORCE_DO_CMD as an order-only dep</span>
<a name="l01712"></a>01712 <span class="stringliteral">    phony: if true, the rule does not actually generate the named output, the</span>
<a name="l01713"></a>01713 <span class="stringliteral">           output is just a name to run the rule</span>
<a name="l01714"></a>01714 <span class="stringliteral">    """</span>
<a name="l01715"></a>01715     outputs = map(QuoteSpaces, outputs)
<a name="l01716"></a>01716     inputs = map(QuoteSpaces, inputs)
<a name="l01717"></a>01717 
<a name="l01718"></a>01718     <span class="keywordflow">if</span> comment:
<a name="l01719"></a>01719       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'# '</span> + comment)
<a name="l01720"></a>01720     <span class="keywordflow">if</span> phony:
<a name="l01721"></a>01721       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'.PHONY: '</span> + <span class="stringliteral">' '</span>.join(outputs))
<a name="l01722"></a>01722     <span class="comment"># TODO(evanm): just make order_only a list of deps instead of these hacks.</span>
<a name="l01723"></a>01723     <span class="keywordflow">if</span> order_only:
<a name="l01724"></a>01724       order_insert = <span class="stringliteral">'| '</span>
<a name="l01725"></a>01725       pick_output = <span class="stringliteral">' '</span>.join(outputs)
<a name="l01726"></a>01726     <span class="keywordflow">else</span>:
<a name="l01727"></a>01727       order_insert = <span class="stringliteral">''</span>
<a name="l01728"></a>01728       pick_output = outputs[0]
<a name="l01729"></a>01729     <span class="keywordflow">if</span> force:
<a name="l01730"></a>01730       force_append = <span class="stringliteral">' FORCE_DO_CMD'</span>
<a name="l01731"></a>01731     <span class="keywordflow">else</span>:
<a name="l01732"></a>01732       force_append = <span class="stringliteral">''</span>
<a name="l01733"></a>01733     <span class="keywordflow">if</span> actions:
<a name="l01734"></a>01734       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">"%s: TOOLSET := $(TOOLSET)"</span> % outputs[0])
<a name="l01735"></a>01735     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'%s: %s%s%s'</span> % (pick_output, order_insert, <span class="stringliteral">' '</span>.join(inputs),
<a name="l01736"></a>01736                                  force_append))
<a name="l01737"></a>01737     <span class="keywordflow">if</span> actions:
<a name="l01738"></a>01738       <span class="keywordflow">for</span> action <span class="keywordflow">in</span> actions:
<a name="l01739"></a>01739         self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'\t%s'</span> % action)
<a name="l01740"></a>01740     <span class="keywordflow">if</span> <span class="keywordflow">not</span> order_only <span class="keywordflow">and</span> len(outputs) &gt; 1:
<a name="l01741"></a>01741       <span class="comment"># If we have more than one output, a rule like</span>
<a name="l01742"></a>01742       <span class="comment">#   foo bar: baz</span>
<a name="l01743"></a>01743       <span class="comment"># that for *each* output we must run the action, potentially</span>
<a name="l01744"></a>01744       <span class="comment"># in parallel.  That is not what we're trying to write -- what</span>
<a name="l01745"></a>01745       <span class="comment"># we want is that we run the action once and it generates all</span>
<a name="l01746"></a>01746       <span class="comment"># the files.</span>
<a name="l01747"></a>01747       <span class="comment"># http://www.gnu.org/software/hello/manual/automake/Multiple-Outputs.html</span>
<a name="l01748"></a>01748       <span class="comment"># discusses this problem and has this solution:</span>
<a name="l01749"></a>01749       <span class="comment"># 1) Write the naive rule that would produce parallel runs of</span>
<a name="l01750"></a>01750       <span class="comment"># the action.</span>
<a name="l01751"></a>01751       <span class="comment"># 2) Make the outputs seralized on each other, so we won't start</span>
<a name="l01752"></a>01752       <span class="comment"># a parallel run until the first run finishes, at which point</span>
<a name="l01753"></a>01753       <span class="comment"># we'll have generated all the outputs and we're done.</span>
<a name="l01754"></a>01754       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'%s: %s'</span> % (<span class="stringliteral">' '</span>.join(outputs[1:]), outputs[0]))
<a name="l01755"></a>01755       <span class="comment"># Add a dummy command to the "extra outputs" rule, otherwise make seems to</span>
<a name="l01756"></a>01756       <span class="comment"># think these outputs haven't (couldn't have?) changed, and thus doesn't</span>
<a name="l01757"></a>01757       <span class="comment"># flag them as changed (i.e. include in '$?') when evaluating dependent</span>
<a name="l01758"></a>01758       <span class="comment"># rules, which in turn causes do_cmd() to skip running dependent commands.</span>
<a name="l01759"></a>01759       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'%s: ;'</span> % (<span class="stringliteral">' '</span>.join(outputs[1:])))
<a name="l01760"></a>01760     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>()
<a name="l01761"></a>01761 
<a name="l01762"></a>01762 
<a name="l01763"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#b7fd02bec95eb01dcda47aae3ea6797f">01763</a>   <span class="keyword">def </span><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#b7fd02bec95eb01dcda47aae3ea6797f">WriteAndroidNdkModuleRule</a>(self, module_name, all_sources, link_deps):
<a name="l01764"></a>01764     <span class="stringliteral">"""Write a set of LOCAL_XXX definitions for Android NDK.</span>
<a name="l01765"></a>01765 <span class="stringliteral"></span>
<a name="l01766"></a>01766 <span class="stringliteral">    These variable definitions will be used by Android NDK but do nothing for</span>
<a name="l01767"></a>01767 <span class="stringliteral">    non-Android applications.</span>
<a name="l01768"></a>01768 <span class="stringliteral"></span>
<a name="l01769"></a>01769 <span class="stringliteral">    Arguments:</span>
<a name="l01770"></a>01770 <span class="stringliteral">      module_name: Android NDK module name, which must be unique among all</span>
<a name="l01771"></a>01771 <span class="stringliteral">          module names.</span>
<a name="l01772"></a>01772 <span class="stringliteral">      all_sources: A list of source files (will be filtered by Compilable).</span>
<a name="l01773"></a>01773 <span class="stringliteral">      link_deps: A list of link dependencies, which must be sorted in</span>
<a name="l01774"></a>01774 <span class="stringliteral">          the order from dependencies to dependents.</span>
<a name="l01775"></a>01775 <span class="stringliteral">    """</span>
<a name="l01776"></a>01776     <span class="keywordflow">if</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> <span class="keywordflow">not</span> <span class="keywordflow">in</span> (<span class="stringliteral">'executable'</span>, <span class="stringliteral">'shared_library'</span>, <span class="stringliteral">'static_library'</span>):
<a name="l01777"></a>01777       <span class="keywordflow">return</span>
<a name="l01778"></a>01778 
<a name="l01779"></a>01779     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'# Variable definitions for Android applications'</span>)
<a name="l01780"></a>01780     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'include $(CLEAR_VARS)'</span>)
<a name="l01781"></a>01781     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'LOCAL_MODULE := '</span> + module_name)
<a name="l01782"></a>01782     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'LOCAL_CFLAGS := $(CFLAGS_$(BUILDTYPE)) '</span>
<a name="l01783"></a>01783                  <span class="stringliteral">'$(DEFS_$(BUILDTYPE)) '</span>
<a name="l01784"></a>01784                  <span class="comment"># LOCAL_CFLAGS is applied to both of C and C++.  There is</span>
<a name="l01785"></a>01785                  <span class="comment"># no way to specify $(CFLAGS_C_$(BUILDTYPE)) only for C</span>
<a name="l01786"></a>01786                  <span class="comment"># sources.</span>
<a name="l01787"></a>01787                  <span class="stringliteral">'$(CFLAGS_C_$(BUILDTYPE)) '</span>
<a name="l01788"></a>01788                  <span class="comment"># $(INCS_$(BUILDTYPE)) includes the prefix '-I' while</span>
<a name="l01789"></a>01789                  <span class="comment"># LOCAL_C_INCLUDES does not expect it.  So put it in</span>
<a name="l01790"></a>01790                  <span class="comment"># LOCAL_CFLAGS.</span>
<a name="l01791"></a>01791                  <span class="stringliteral">'$(INCS_$(BUILDTYPE))'</span>)
<a name="l01792"></a>01792     <span class="comment"># LOCAL_CXXFLAGS is obsolete and LOCAL_CPPFLAGS is preferred.</span>
<a name="l01793"></a>01793     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'LOCAL_CPPFLAGS := $(CFLAGS_CC_$(BUILDTYPE))'</span>)
<a name="l01794"></a>01794     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'LOCAL_C_INCLUDES :='</span>)
<a name="l01795"></a>01795     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'LOCAL_LDLIBS := $(LDFLAGS_$(BUILDTYPE)) $(LIBS)'</span>)
<a name="l01796"></a>01796 
<a name="l01797"></a>01797     <span class="comment"># Detect the C++ extension.</span>
<a name="l01798"></a>01798     cpp_ext = {<span class="stringliteral">'.cc'</span>: 0, <span class="stringliteral">'.cpp'</span>: 0, <span class="stringliteral">'.cxx'</span>: 0}
<a name="l01799"></a>01799     default_cpp_ext = <span class="stringliteral">'.cpp'</span>
<a name="l01800"></a>01800     <span class="keywordflow">for</span> filename <span class="keywordflow">in</span> all_sources:
<a name="l01801"></a>01801       ext = os.path.splitext(filename)[1]
<a name="l01802"></a>01802       <span class="keywordflow">if</span> ext <span class="keywordflow">in</span> cpp_ext:
<a name="l01803"></a>01803         cpp_ext[ext] += 1
<a name="l01804"></a>01804         <span class="keywordflow">if</span> cpp_ext[ext] &gt; cpp_ext[default_cpp_ext]:
<a name="l01805"></a>01805           default_cpp_ext = ext
<a name="l01806"></a>01806     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'LOCAL_CPP_EXTENSION := '</span> + default_cpp_ext)
<a name="l01807"></a>01807 
<a name="l01808"></a>01808     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#93de12c6d9b1aa90c3f3a8b0bfc1fffa">WriteList</a>(map(self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#486b5604f4bc6403b8378c81db254cae">Absolutify</a>, filter(Compilable, all_sources)),
<a name="l01809"></a>01809                    <span class="stringliteral">'LOCAL_SRC_FILES'</span>)
<a name="l01810"></a>01810 
<a name="l01811"></a>01811     <span class="comment"># Filter out those which do not match prefix and suffix and produce</span>
<a name="l01812"></a>01812     <span class="comment"># the resulting list without prefix and suffix.</span>
<a name="l01813"></a>01813     <span class="keyword">def </span>DepsToModules(deps, prefix, suffix):
<a name="l01814"></a>01814       modules = []
<a name="l01815"></a>01815       <span class="keywordflow">for</span> filepath <span class="keywordflow">in</span> deps:
<a name="l01816"></a>01816         filename = os.path.basename(filepath)
<a name="l01817"></a>01817         <span class="keywordflow">if</span> filename.startswith(prefix) <span class="keywordflow">and</span> filename.endswith(suffix):
<a name="l01818"></a>01818           modules.append(filename[len(prefix):-len(suffix)])
<a name="l01819"></a>01819       <span class="keywordflow">return</span> modules
<a name="l01820"></a>01820 
<a name="l01821"></a>01821     <span class="comment"># Retrieve the default value of 'SHARED_LIB_SUFFIX'</span>
<a name="l01822"></a>01822     params = {<span class="stringliteral">'flavor'</span>: <span class="stringliteral">'linux'</span>}
<a name="l01823"></a>01823     default_variables = {}
<a name="l01824"></a>01824     CalculateVariables(default_variables, params)
<a name="l01825"></a>01825 
<a name="l01826"></a>01826     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#93de12c6d9b1aa90c3f3a8b0bfc1fffa">WriteList</a>(
<a name="l01827"></a>01827         DepsToModules(link_deps,
<a name="l01828"></a>01828                       generator_default_variables[<span class="stringliteral">'SHARED_LIB_PREFIX'</span>],
<a name="l01829"></a>01829                       default_variables[<span class="stringliteral">'SHARED_LIB_SUFFIX'</span>]),
<a name="l01830"></a>01830         <span class="stringliteral">'LOCAL_SHARED_LIBRARIES'</span>)
<a name="l01831"></a>01831     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#93de12c6d9b1aa90c3f3a8b0bfc1fffa">WriteList</a>(
<a name="l01832"></a>01832         DepsToModules(link_deps,
<a name="l01833"></a>01833                       generator_default_variables[<span class="stringliteral">'STATIC_LIB_PREFIX'</span>],
<a name="l01834"></a>01834                       generator_default_variables[<span class="stringliteral">'STATIC_LIB_SUFFIX'</span>]),
<a name="l01835"></a>01835         <span class="stringliteral">'LOCAL_STATIC_LIBRARIES'</span>)
<a name="l01836"></a>01836 
<a name="l01837"></a>01837     <span class="keywordflow">if</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> == <span class="stringliteral">'executable'</span>:
<a name="l01838"></a>01838       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'include $(BUILD_EXECUTABLE)'</span>)
<a name="l01839"></a>01839     <span class="keywordflow">elif</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> == <span class="stringliteral">'shared_library'</span>:
<a name="l01840"></a>01840       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'include $(BUILD_SHARED_LIBRARY)'</span>)
<a name="l01841"></a>01841     <span class="keywordflow">elif</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> == <span class="stringliteral">'static_library'</span>:
<a name="l01842"></a>01842       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'include $(BUILD_STATIC_LIBRARY)'</span>)
<a name="l01843"></a>01843     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>()
<a name="l01844"></a>01844 
<a name="l01845"></a>01845 
<a name="l01846"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">01846</a>   <span class="keyword">def </span><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(self, text=''):
<a name="l01847"></a>01847     self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#883a1b899b644be7fc6d704c1d8e0c04">fp</a>.write(text + <span class="stringliteral">'\n'</span>)
<a name="l01848"></a>01848 
<a name="l01849"></a>01849 
<a name="l01850"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#1e807b9147c1af2adaa10b07e93b51a4">01850</a>   <span class="keyword">def </span><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#1e807b9147c1af2adaa10b07e93b51a4">GetSortedXcodeEnv</a>(self, additional_settings=None):
<a name="l01851"></a>01851     <span class="keywordflow">return</span> gyp.xcode_emulation.GetSortedXcodeEnv(
<a name="l01852"></a>01852         self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>, <span class="stringliteral">"$(abs_builddir)"</span>,
<a name="l01853"></a>01853         os.path.join(<span class="stringliteral">"$(abs_srcdir)"</span>, self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#a28dc103258589d9cb421197fe2de90b">path</a>), <span class="stringliteral">"$(BUILDTYPE)"</span>,
<a name="l01854"></a>01854         additional_settings)
<a name="l01855"></a>01855 
<a name="l01856"></a>01856 
<a name="l01857"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#b16a12808d09d8e1714e7d9aca9f4819">01857</a>   <span class="keyword">def </span><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#b16a12808d09d8e1714e7d9aca9f4819">GetSortedXcodePostbuildEnv</a>(self):
<a name="l01858"></a>01858     <span class="comment"># CHROMIUM_STRIP_SAVE_FILE is a chromium-specific hack.</span>
<a name="l01859"></a>01859     <span class="comment"># TODO(thakis): It would be nice to have some general mechanism instead.</span>
<a name="l01860"></a>01860     strip_save_file = self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#82fdd7ef33787844f2f47ec02555786b">xcode_settings</a>.GetPerTargetSetting(
<a name="l01861"></a>01861         <span class="stringliteral">'CHROMIUM_STRIP_SAVE_FILE'</span>, <span class="stringliteral">''</span>)
<a name="l01862"></a>01862     <span class="comment"># Even if strip_save_file is empty, explicitly write it. Else a postbuild</span>
<a name="l01863"></a>01863     <span class="comment"># might pick up an export from an earlier target.</span>
<a name="l01864"></a>01864     <span class="keywordflow">return</span> self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#1e807b9147c1af2adaa10b07e93b51a4">GetSortedXcodeEnv</a>(
<a name="l01865"></a>01865         additional_settings={<span class="stringliteral">'CHROMIUM_STRIP_SAVE_FILE'</span>: strip_save_file})
<a name="l01866"></a>01866 
<a name="l01867"></a>01867 
<a name="l01868"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#59ac35713dfadc41287f7e81fc662db6">01868</a>   <span class="keyword">def </span><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#59ac35713dfadc41287f7e81fc662db6">WriteSortedXcodeEnv</a>(self, target, env):
<a name="l01869"></a>01869     <span class="keywordflow">for</span> k, v <span class="keywordflow">in</span> env:
<a name="l01870"></a>01870       <span class="comment"># For</span>
<a name="l01871"></a>01871       <span class="comment">#  foo := a\ b</span>
<a name="l01872"></a>01872       <span class="comment"># the escaped space does the right thing. For</span>
<a name="l01873"></a>01873       <span class="comment">#  export foo := a\ b</span>
<a name="l01874"></a>01874       <span class="comment"># it does not -- the backslash is written to the env as literal character.</span>
<a name="l01875"></a>01875       <span class="comment"># So don't escape spaces in |env[k]|.</span>
<a name="l01876"></a>01876       self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'%s: export %s := %s'</span> % (QuoteSpaces(target), k, v))
<a name="l01877"></a>01877 
<a name="l01878"></a>01878 
<a name="l01879"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#5cdfe11e7d56d367238d8ff795d686bf">01879</a>   <span class="keyword">def </span><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#5cdfe11e7d56d367238d8ff795d686bf">Objectify</a>(self, path):
<a name="l01880"></a>01880     <span class="stringliteral">"""Convert a path to its output directory form."""</span>
<a name="l01881"></a>01881     <span class="keywordflow">if</span> <span class="stringliteral">'$('</span> <span class="keywordflow">in</span> path:
<a name="l01882"></a>01882       path = path.replace(<span class="stringliteral">'$(obj)/'</span>, <span class="stringliteral">'$(obj).%s/$(TARGET)/'</span> % self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">toolset</a>)
<a name="l01883"></a>01883     <span class="keywordflow">if</span> <span class="keywordflow">not</span> <span class="stringliteral">'$(obj)'</span> <span class="keywordflow">in</span> path:
<a name="l01884"></a>01884       path = <span class="stringliteral">'$(obj).%s/$(TARGET)/%s'</span> % (self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">toolset</a>, path)
<a name="l01885"></a>01885     <span class="keywordflow">return</span> path
<a name="l01886"></a>01886 
<a name="l01887"></a>01887 
<a name="l01888"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#a5a2c7aa87a8a9889f33ddf2b3ead3c4">01888</a>   <span class="keyword">def </span><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#a5a2c7aa87a8a9889f33ddf2b3ead3c4">Pchify</a>(self, path, lang):
<a name="l01889"></a>01889     <span class="stringliteral">"""Convert a prefix header path to its output directory form."""</span>
<a name="l01890"></a>01890     path = self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#486b5604f4bc6403b8378c81db254cae">Absolutify</a>(path)
<a name="l01891"></a>01891     <span class="keywordflow">if</span> <span class="stringliteral">'$('</span> <span class="keywordflow">in</span> path:
<a name="l01892"></a>01892       path = path.replace(<span class="stringliteral">'$(obj)/'</span>, <span class="stringliteral">'$(obj).%s/$(TARGET)/pch-%s'</span> %
<a name="l01893"></a>01893                           (self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">toolset</a>, lang))
<a name="l01894"></a>01894       <span class="keywordflow">return</span> path
<a name="l01895"></a>01895     <span class="keywordflow">return</span> <span class="stringliteral">'$(obj).%s/$(TARGET)/pch-%s/%s'</span> % (self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">toolset</a>, lang, path)
<a name="l01896"></a>01896 
<a name="l01897"></a>01897 
<a name="l01898"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#486b5604f4bc6403b8378c81db254cae">01898</a>   <span class="keyword">def </span><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#486b5604f4bc6403b8378c81db254cae">Absolutify</a>(self, path):
<a name="l01899"></a>01899     <span class="stringliteral">"""Convert a subdirectory-relative path into a base-relative path.</span>
<a name="l01900"></a>01900 <span class="stringliteral">    Skips over paths that contain variables."""</span>
<a name="l01901"></a>01901     <span class="keywordflow">if</span> <span class="stringliteral">'$('</span> <span class="keywordflow">in</span> path:
<a name="l01902"></a>01902       <span class="comment"># Don't call normpath in this case, as it might collapse the</span>
<a name="l01903"></a>01903       <span class="comment"># path too aggressively if it features '..'. However it's still</span>
<a name="l01904"></a>01904       <span class="comment"># important to strip trailing slashes.</span>
<a name="l01905"></a>01905       <span class="keywordflow">return</span> path.rstrip(<span class="stringliteral">'/'</span>)
<a name="l01906"></a>01906     <span class="keywordflow">return</span> os.path.normpath(os.path.join(self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#a28dc103258589d9cb421197fe2de90b">path</a>, path))
<a name="l01907"></a>01907 
<a name="l01908"></a>01908 
<a name="l01909"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#88c6708e9588f546826f6886970f724d">01909</a>   <span class="keyword">def </span><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#88c6708e9588f546826f6886970f724d">ExpandInputRoot</a>(self, template, expansion, dirname):
<a name="l01910"></a>01910     <span class="keywordflow">if</span> <span class="stringliteral">'%(INPUT_ROOT)s'</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> template <span class="keywordflow">and</span> <span class="stringliteral">'%(INPUT_DIRNAME)s'</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> template:
<a name="l01911"></a>01911       <span class="keywordflow">return</span> template
<a name="l01912"></a>01912     path = template % {
<a name="l01913"></a>01913         <span class="stringliteral">'INPUT_ROOT'</span>: expansion,
<a name="l01914"></a>01914         <span class="stringliteral">'INPUT_DIRNAME'</span>: dirname,
<a name="l01915"></a>01915         }
<a name="l01916"></a>01916     <span class="keywordflow">return</span> path
<a name="l01917"></a>01917 
<a name="l01918"></a>01918 
<a name="l01919"></a><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d308655bbaac8e8cf75347b4ec62577e">01919</a>   <span class="keyword">def </span><a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#d308655bbaac8e8cf75347b4ec62577e">_InstallableTargetInstallPath</a>(self):
<a name="l01920"></a>01920     <span class="stringliteral">"""Returns the location of the final output for an installable target."""</span>
<a name="l01921"></a>01921     <span class="comment"># Xcode puts shared_library results into PRODUCT_DIR, and some gyp files</span>
<a name="l01922"></a>01922     <span class="comment"># rely on this. Emulate this behavior for mac.</span>
<a name="l01923"></a>01923 
<a name="l01924"></a>01924     <span class="comment"># XXX(TooTallNate): disabling this code since we don't want this behavior...</span>
<a name="l01925"></a>01925     <span class="comment">#if (self.type == 'shared_library' and</span>
<a name="l01926"></a>01926     <span class="comment">#    (self.flavor != 'mac' or self.toolset != 'target')):</span>
<a name="l01927"></a>01927     <span class="comment">#  # Install all shared libs into a common directory (per toolset) for</span>
<a name="l01928"></a>01928     <span class="comment">#  # convenient access with LD_LIBRARY_PATH.</span>
<a name="l01929"></a>01929     <span class="comment">#  return '$(builddir)/lib.%s/%s' % (self.toolset, self.alias)</span>
<a name="l01930"></a>01930     <span class="keywordflow">return</span> <span class="stringliteral">'$(builddir)/'</span> + self.<a class="code" href="../../d5/da1/classgyp_1_1generator_1_1make_1_1_makefile_writer.html#e67d6c6e342775a03bd935d100b5b8fa">alias</a>
<a name="l01931"></a>01931 
<a name="l01932"></a>01932 
<a name="l01933"></a><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#7138e3b2d6cce317f5053bcd37235d34">01933</a> <span class="keyword">def </span><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#7138e3b2d6cce317f5053bcd37235d34">WriteAutoRegenerationRule</a>(params, root_makefile, makefile_name,
<a name="l01934"></a>01934                               build_files):
<a name="l01935"></a>01935   <span class="stringliteral">"""Write the target to regenerate the Makefile."""</span>
<a name="l01936"></a>01936   options = params[<span class="stringliteral">'options'</span>]
<a name="l01937"></a>01937   build_files_args = [gyp.common.RelativePath(filename, options.toplevel_dir)
<a name="l01938"></a>01938                       <span class="keywordflow">for</span> filename <span class="keywordflow">in</span> params[<span class="stringliteral">'build_files_arg'</span>]]
<a name="l01939"></a>01939 
<a name="l01940"></a>01940   gyp_binary = gyp.common.FixIfRelativePath(params[<span class="stringliteral">'gyp_binary'</span>],
<a name="l01941"></a>01941                                             options.toplevel_dir)
<a name="l01942"></a>01942   <span class="keywordflow">if</span> <span class="keywordflow">not</span> gyp_binary.startswith(os.sep):
<a name="l01943"></a>01943     gyp_binary = os.path.join(<span class="stringliteral">'.'</span>, gyp_binary)
<a name="l01944"></a>01944 
<a name="l01945"></a>01945   root_makefile.write(
<a name="l01946"></a>01946       <span class="stringliteral">"quiet_cmd_regen_makefile = ACTION Regenerating $@\n"</span>
<a name="l01947"></a>01947       <span class="stringliteral">"cmd_regen_makefile = cd $(srcdir); %(cmd)s\n"</span>
<a name="l01948"></a>01948       <span class="stringliteral">"%(makefile_name)s: %(deps)s\n"</span>
<a name="l01949"></a>01949       <span class="stringliteral">"\t$(call do_cmd,regen_makefile)\n\n"</span> % {
<a name="l01950"></a>01950           <span class="stringliteral">'makefile_name'</span>: makefile_name,
<a name="l01951"></a>01951           <span class="stringliteral">'deps'</span>: <span class="stringliteral">' '</span>.join(map(Sourceify, build_files)),
<a name="l01952"></a>01952           <span class="stringliteral">'cmd'</span>: gyp.common.EncodePOSIXShellList(
<a name="l01953"></a>01953                      [gyp_binary, <span class="stringliteral">'-fmake'</span>] +
<a name="l01954"></a>01954                      gyp.RegenerateFlags(options) +
<a name="l01955"></a>01955                      build_files_args)})
<a name="l01956"></a>01956 
<a name="l01957"></a>01957 
<a name="l01958"></a><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#7873c2c292241c8c77c30012e0ffc717">01958</a> <span class="keyword">def </span><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#7873c2c292241c8c77c30012e0ffc717">PerformBuild</a>(data, configurations, params):
<a name="l01959"></a>01959   options = params[<span class="stringliteral">'options'</span>]
<a name="l01960"></a>01960   <span class="keywordflow">for</span> config <span class="keywordflow">in</span> configurations:
<a name="l01961"></a>01961     arguments = [<span class="stringliteral">'make'</span>]
<a name="l01962"></a>01962     <span class="keywordflow">if</span> options.toplevel_dir <span class="keywordflow">and</span> options.toplevel_dir != <span class="stringliteral">'.'</span>:
<a name="l01963"></a>01963       arguments += <span class="stringliteral">'-C'</span>, options.toplevel_dir
<a name="l01964"></a>01964     arguments.append(<span class="stringliteral">'BUILDTYPE='</span> + config)
<a name="l01965"></a>01965     <span class="keywordflow">print</span> <span class="stringliteral">'Building [%s]: %s'</span> % (config, arguments)
<a name="l01966"></a>01966     subprocess.check_call(arguments)
<a name="l01967"></a>01967 
<a name="l01968"></a>01968 
<a name="l01969"></a><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#e4ecf8b077b98fa0d560978309c82d89">01969</a> <span class="keyword">def </span><a class="code" href="../../dc/d96/namespacegyp_1_1generator_1_1make.html#e4ecf8b077b98fa0d560978309c82d89">GenerateOutput</a>(target_list, target_dicts, data, params):
<a name="l01970"></a>01970   options = params[<span class="stringliteral">'options'</span>]
<a name="l01971"></a>01971   flavor = gyp.common.GetFlavor(params)
<a name="l01972"></a>01972   generator_flags = params.get(<span class="stringliteral">'generator_flags'</span>, {})
<a name="l01973"></a>01973   builddir_name = generator_flags.get(<span class="stringliteral">'output_dir'</span>, <span class="stringliteral">'out'</span>)
<a name="l01974"></a>01974   android_ndk_version = generator_flags.get(<span class="stringliteral">'android_ndk_version'</span>, <span class="keywordtype">None</span>)
<a name="l01975"></a>01975   default_target = generator_flags.get(<span class="stringliteral">'default_target'</span>, <span class="stringliteral">'all'</span>)
<a name="l01976"></a>01976 
<a name="l01977"></a>01977   <span class="keyword">def </span>CalculateMakefilePath(build_file, base_name):
<a name="l01978"></a>01978     <span class="stringliteral">"""Determine where to write a Makefile for a given gyp file."""</span>
<a name="l01979"></a>01979     <span class="comment"># Paths in gyp files are relative to the .gyp file, but we want</span>
<a name="l01980"></a>01980     <span class="comment"># paths relative to the source root for the master makefile.  Grab</span>
<a name="l01981"></a>01981     <span class="comment"># the path of the .gyp file as the base to relativize against.</span>
<a name="l01982"></a>01982     <span class="comment"># E.g. "foo/bar" when we're constructing targets for "foo/bar/baz.gyp".</span>
<a name="l01983"></a>01983     base_path = gyp.common.RelativePath(os.path.dirname(build_file),
<a name="l01984"></a>01984                                         options.depth)
<a name="l01985"></a>01985     <span class="comment"># We write the file in the base_path directory.</span>
<a name="l01986"></a>01986     output_file = os.path.join(options.depth, base_path, base_name)
<a name="l01987"></a>01987     <span class="keywordflow">if</span> options.generator_output:
<a name="l01988"></a>01988       output_file = os.path.join(
<a name="l01989"></a>01989           options.depth, options.generator_output, base_path, base_name)
<a name="l01990"></a>01990     base_path = gyp.common.RelativePath(os.path.dirname(build_file),
<a name="l01991"></a>01991                                         options.toplevel_dir)
<a name="l01992"></a>01992     <span class="keywordflow">return</span> base_path, output_file
<a name="l01993"></a>01993 
<a name="l01994"></a>01994   <span class="comment"># TODO:  search for the first non-'Default' target.  This can go</span>
<a name="l01995"></a>01995   <span class="comment"># away when we add verification that all targets have the</span>
<a name="l01996"></a>01996   <span class="comment"># necessary configurations.</span>
<a name="l01997"></a>01997   default_configuration = <span class="keywordtype">None</span>
<a name="l01998"></a>01998   toolsets = set([target_dicts[target][<span class="stringliteral">'toolset'</span>] <span class="keywordflow">for</span> target <span class="keywordflow">in</span> target_list])
<a name="l01999"></a>01999   <span class="keywordflow">for</span> target <span class="keywordflow">in</span> target_list:
<a name="l02000"></a>02000     spec = target_dicts[target]
<a name="l02001"></a>02001     <span class="keywordflow">if</span> spec[<span class="stringliteral">'default_configuration'</span>] != <span class="stringliteral">'Default'</span>:
<a name="l02002"></a>02002       default_configuration = spec[<span class="stringliteral">'default_configuration'</span>]
<a name="l02003"></a>02003       <span class="keywordflow">break</span>
<a name="l02004"></a>02004   <span class="keywordflow">if</span> <span class="keywordflow">not</span> default_configuration:
<a name="l02005"></a>02005     default_configuration = <span class="stringliteral">'Default'</span>
<a name="l02006"></a>02006 
<a name="l02007"></a>02007   srcdir = <span class="stringliteral">'.'</span>
<a name="l02008"></a>02008   makefile_name = <span class="stringliteral">'Makefile'</span> + options.suffix
<a name="l02009"></a>02009   makefile_path = os.path.join(options.toplevel_dir, makefile_name)
<a name="l02010"></a>02010   <span class="keywordflow">if</span> options.generator_output:
<a name="l02011"></a>02011     <span class="keyword">global</span> srcdir_prefix
<a name="l02012"></a>02012     makefile_path = os.path.join(
<a name="l02013"></a>02013         options.toplevel_dir, options.generator_output, makefile_name)
<a name="l02014"></a>02014     srcdir = gyp.common.RelativePath(srcdir, options.generator_output)
<a name="l02015"></a>02015     srcdir_prefix = <span class="stringliteral">'$(srcdir)/'</span>
<a name="l02016"></a>02016 
<a name="l02017"></a>02017   flock_command= <span class="stringliteral">'flock'</span>
<a name="l02018"></a>02018   header_params = {
<a name="l02019"></a>02019       <span class="stringliteral">'default_target'</span>: default_target,
<a name="l02020"></a>02020       <span class="stringliteral">'builddir'</span>: builddir_name,
<a name="l02021"></a>02021       <span class="stringliteral">'default_configuration'</span>: default_configuration,
<a name="l02022"></a>02022       <span class="stringliteral">'flock'</span>: flock_command,
<a name="l02023"></a>02023       <span class="stringliteral">'flock_index'</span>: 1,
<a name="l02024"></a>02024       <span class="stringliteral">'link_commands'</span>: LINK_COMMANDS_LINUX,
<a name="l02025"></a>02025       <span class="stringliteral">'extra_commands'</span>: <span class="stringliteral">''</span>,
<a name="l02026"></a>02026       <span class="stringliteral">'srcdir'</span>: srcdir,
<a name="l02027"></a>02027     }
<a name="l02028"></a>02028   <span class="keywordflow">if</span> flavor == <span class="stringliteral">'mac'</span>:
<a name="l02029"></a>02029     flock_command = <span class="stringliteral">'./gyp-mac-tool flock'</span>
<a name="l02030"></a>02030     header_params.update({
<a name="l02031"></a>02031         <span class="stringliteral">'flock'</span>: flock_command,
<a name="l02032"></a>02032         <span class="stringliteral">'flock_index'</span>: 2,
<a name="l02033"></a>02033         <span class="stringliteral">'link_commands'</span>: LINK_COMMANDS_MAC,
<a name="l02034"></a>02034         <span class="stringliteral">'extra_commands'</span>: SHARED_HEADER_MAC_COMMANDS,
<a name="l02035"></a>02035     })
<a name="l02036"></a>02036   <span class="keywordflow">elif</span> flavor == <span class="stringliteral">'android'</span>:
<a name="l02037"></a>02037     header_params.update({
<a name="l02038"></a>02038         <span class="stringliteral">'link_commands'</span>: LINK_COMMANDS_ANDROID,
<a name="l02039"></a>02039     })
<a name="l02040"></a>02040   <span class="keywordflow">elif</span> flavor == <span class="stringliteral">'solaris'</span>:
<a name="l02041"></a>02041     header_params.update({
<a name="l02042"></a>02042         <span class="stringliteral">'flock'</span>: <span class="stringliteral">'./gyp-flock-tool flock'</span>,
<a name="l02043"></a>02043         <span class="stringliteral">'flock_index'</span>: 2,
<a name="l02044"></a>02044     })
<a name="l02045"></a>02045   <span class="keywordflow">elif</span> flavor == <span class="stringliteral">'freebsd'</span>:
<a name="l02046"></a>02046     <span class="comment"># Note: OpenBSD has sysutils/flock. lockf seems to be FreeBSD specific.</span>
<a name="l02047"></a>02047     header_params.update({
<a name="l02048"></a>02048         <span class="stringliteral">'flock'</span>: <span class="stringliteral">'lockf'</span>,
<a name="l02049"></a>02049     })
<a name="l02050"></a>02050   <span class="keywordflow">elif</span> flavor == <span class="stringliteral">'aix'</span>:
<a name="l02051"></a>02051     header_params.update({
<a name="l02052"></a>02052         <span class="stringliteral">'link_commands'</span>: LINK_COMMANDS_AIX,
<a name="l02053"></a>02053         <span class="stringliteral">'flock'</span>: <span class="stringliteral">'./gyp-flock-tool flock'</span>,
<a name="l02054"></a>02054         <span class="stringliteral">'flock_index'</span>: 2,
<a name="l02055"></a>02055     })
<a name="l02056"></a>02056 
<a name="l02057"></a>02057   header_params.update({
<a name="l02058"></a>02058     <span class="stringliteral">'CC.target'</span>:   GetEnvironFallback((<span class="stringliteral">'CC_target'</span>, <span class="stringliteral">'CC'</span>), <span class="stringliteral">'$(CC)'</span>),
<a name="l02059"></a>02059     <span class="stringliteral">'AR.target'</span>:   GetEnvironFallback((<span class="stringliteral">'AR_target'</span>, <span class="stringliteral">'AR'</span>), <span class="stringliteral">'$(AR)'</span>),
<a name="l02060"></a>02060     <span class="stringliteral">'CXX.target'</span>:  GetEnvironFallback((<span class="stringliteral">'CXX_target'</span>, <span class="stringliteral">'CXX'</span>), <span class="stringliteral">'$(CXX)'</span>),
<a name="l02061"></a>02061     <span class="stringliteral">'LINK.target'</span>: GetEnvironFallback((<span class="stringliteral">'LINK_target'</span>, <span class="stringliteral">'LINK'</span>), <span class="stringliteral">'$(LINK)'</span>),
<a name="l02062"></a>02062     <span class="stringliteral">'CC.host'</span>:     GetEnvironFallback((<span class="stringliteral">'CC_host'</span>,), <span class="stringliteral">'gcc'</span>),
<a name="l02063"></a>02063     <span class="stringliteral">'AR.host'</span>:     GetEnvironFallback((<span class="stringliteral">'AR_host'</span>,), <span class="stringliteral">'ar'</span>),
<a name="l02064"></a>02064     <span class="stringliteral">'CXX.host'</span>:    GetEnvironFallback((<span class="stringliteral">'CXX_host'</span>,), <span class="stringliteral">'g++'</span>),
<a name="l02065"></a>02065     <span class="stringliteral">'LINK.host'</span>:   GetEnvironFallback((<span class="stringliteral">'LINK_host'</span>,), <span class="stringliteral">'$(CXX.host)'</span>),
<a name="l02066"></a>02066   })
<a name="l02067"></a>02067 
<a name="l02068"></a>02068   build_file, _, _ = gyp.common.ParseQualifiedTarget(target_list[0])
<a name="l02069"></a>02069   make_global_settings_array = data[build_file].get(<span class="stringliteral">'make_global_settings'</span>, [])
<a name="l02070"></a>02070   wrappers = {}
<a name="l02071"></a>02071   <span class="keywordflow">for</span> key, value <span class="keywordflow">in</span> make_global_settings_array:
<a name="l02072"></a>02072     <span class="keywordflow">if</span> key.endswith(<span class="stringliteral">'_wrapper'</span>):
<a name="l02073"></a>02073       wrappers[key[:-len(<span class="stringliteral">'_wrapper'</span>)]] = <span class="stringliteral">'$(abspath %s)'</span> % value
<a name="l02074"></a>02074   make_global_settings = <span class="stringliteral">''</span>
<a name="l02075"></a>02075   <span class="keywordflow">for</span> key, value <span class="keywordflow">in</span> make_global_settings_array:
<a name="l02076"></a>02076     <span class="keywordflow">if</span> re.match(<span class="stringliteral">'.*_wrapper'</span>, key):
<a name="l02077"></a>02077       <span class="keywordflow">continue</span>
<a name="l02078"></a>02078     <span class="keywordflow">if</span> value[0] != <span class="stringliteral">'$'</span>:
<a name="l02079"></a>02079       value = <span class="stringliteral">'$(abspath %s)'</span> % value
<a name="l02080"></a>02080     wrapper = wrappers.get(key)
<a name="l02081"></a>02081     <span class="keywordflow">if</span> wrapper:
<a name="l02082"></a>02082       value = <span class="stringliteral">'%s %s'</span> % (wrapper, value)
<a name="l02083"></a>02083       del wrappers[key]
<a name="l02084"></a>02084     <span class="keywordflow">if</span> key <span class="keywordflow">in</span> (<span class="stringliteral">'CC'</span>, <span class="stringliteral">'CC.host'</span>, <span class="stringliteral">'CXX'</span>, <span class="stringliteral">'CXX.host'</span>):
<a name="l02085"></a>02085       make_global_settings += (
<a name="l02086"></a>02086           <span class="stringliteral">'ifneq (,$(filter $(origin %s), undefined default))\n'</span> % key)
<a name="l02087"></a>02087       <span class="comment"># Let gyp-time envvars win over global settings.</span>
<a name="l02088"></a>02088       env_key = key.replace(<span class="stringliteral">'.'</span>, <span class="stringliteral">'_'</span>)  <span class="comment"># CC.host -&gt; CC_host</span>
<a name="l02089"></a>02089       <span class="keywordflow">if</span> env_key <span class="keywordflow">in</span> os.environ:
<a name="l02090"></a>02090         value = os.environ[env_key]
<a name="l02091"></a>02091       make_global_settings += <span class="stringliteral">'  %s = %s\n'</span> % (key, value)
<a name="l02092"></a>02092       make_global_settings += <span class="stringliteral">'endif\n'</span>
<a name="l02093"></a>02093     <span class="keywordflow">else</span>:
<a name="l02094"></a>02094       make_global_settings += <span class="stringliteral">'%s ?= %s\n'</span> % (key, value)
<a name="l02095"></a>02095   <span class="comment"># TODO(ukai): define cmd when only wrapper is specified in</span>
<a name="l02096"></a>02096   <span class="comment"># make_global_settings.</span>
<a name="l02097"></a>02097 
<a name="l02098"></a>02098   header_params[<span class="stringliteral">'make_global_settings'</span>] = make_global_settings
<a name="l02099"></a>02099 
<a name="l02100"></a>02100   gyp.common.EnsureDirExists(makefile_path)
<a name="l02101"></a>02101   root_makefile = open(makefile_path, <span class="stringliteral">'w'</span>)
<a name="l02102"></a>02102   root_makefile.write(SHARED_HEADER % header_params)
<a name="l02103"></a>02103   <span class="comment"># Currently any versions have the same effect, but in future the behavior</span>
<a name="l02104"></a>02104   <span class="comment"># could be different.</span>
<a name="l02105"></a>02105   <span class="keywordflow">if</span> android_ndk_version:
<a name="l02106"></a>02106     root_makefile.write(
<a name="l02107"></a>02107         <span class="stringliteral">'# Define LOCAL_PATH for build of Android applications.\n'</span>
<a name="l02108"></a>02108         <span class="stringliteral">'LOCAL_PATH := $(call my-dir)\n'</span>
<a name="l02109"></a>02109         <span class="stringliteral">'\n'</span>)
<a name="l02110"></a>02110   <span class="keywordflow">for</span> toolset <span class="keywordflow">in</span> toolsets:
<a name="l02111"></a>02111     root_makefile.write(<span class="stringliteral">'TOOLSET := %s\n'</span> % toolset)
<a name="l02112"></a>02112     WriteRootHeaderSuffixRules(root_makefile)
<a name="l02113"></a>02113 
<a name="l02114"></a>02114   <span class="comment"># Put build-time support tools next to the root Makefile.</span>
<a name="l02115"></a>02115   dest_path = os.path.dirname(makefile_path)
<a name="l02116"></a>02116   gyp.common.CopyTool(flavor, dest_path)
<a name="l02117"></a>02117 
<a name="l02118"></a>02118   <span class="comment"># Find the list of targets that derive from the gyp file(s) being built.</span>
<a name="l02119"></a>02119   needed_targets = set()
<a name="l02120"></a>02120   <span class="keywordflow">for</span> build_file <span class="keywordflow">in</span> params[<span class="stringliteral">'build_files'</span>]:
<a name="l02121"></a>02121     <span class="keywordflow">for</span> target <span class="keywordflow">in</span> gyp.common.AllTargets(target_list, target_dicts, build_file):
<a name="l02122"></a>02122       needed_targets.add(target)
<a name="l02123"></a>02123 
<a name="l02124"></a>02124   build_files = set()
<a name="l02125"></a>02125   include_list = set()
<a name="l02126"></a>02126   <span class="keywordflow">for</span> qualified_target <span class="keywordflow">in</span> target_list:
<a name="l02127"></a>02127     build_file, target, toolset = gyp.common.ParseQualifiedTarget(
<a name="l02128"></a>02128         qualified_target)
<a name="l02129"></a>02129 
<a name="l02130"></a>02130     this_make_global_settings = data[build_file].get(<span class="stringliteral">'make_global_settings'</span>, [])
<a name="l02131"></a>02131     <span class="keyword">assert</span> make_global_settings_array == this_make_global_settings, (
<a name="l02132"></a>02132         <span class="stringliteral">"make_global_settings needs to be the same for all targets. %s vs. %s"</span> %
<a name="l02133"></a>02133         (this_make_global_settings, make_global_settings))
<a name="l02134"></a>02134 
<a name="l02135"></a>02135     build_files.add(gyp.common.RelativePath(build_file, options.toplevel_dir))
<a name="l02136"></a>02136     included_files = data[build_file][<span class="stringliteral">'included_files'</span>]
<a name="l02137"></a>02137     <span class="keywordflow">for</span> included_file <span class="keywordflow">in</span> included_files:
<a name="l02138"></a>02138       <span class="comment"># The included_files entries are relative to the dir of the build file</span>
<a name="l02139"></a>02139       <span class="comment"># that included them, so we have to undo that and then make them relative</span>
<a name="l02140"></a>02140       <span class="comment"># to the root dir.</span>
<a name="l02141"></a>02141       relative_include_file = gyp.common.RelativePath(
<a name="l02142"></a>02142           gyp.common.UnrelativePath(included_file, build_file),
<a name="l02143"></a>02143           options.toplevel_dir)
<a name="l02144"></a>02144       abs_include_file = os.path.abspath(relative_include_file)
<a name="l02145"></a>02145       <span class="comment"># If the include file is from the ~/.gyp dir, we should use absolute path</span>
<a name="l02146"></a>02146       <span class="comment"># so that relocating the src dir doesn't break the path.</span>
<a name="l02147"></a>02147       <span class="keywordflow">if</span> (params[<span class="stringliteral">'home_dot_gyp'</span>] <span class="keywordflow">and</span>
<a name="l02148"></a>02148           abs_include_file.startswith(params[<span class="stringliteral">'home_dot_gyp'</span>])):
<a name="l02149"></a>02149         build_files.add(abs_include_file)
<a name="l02150"></a>02150       <span class="keywordflow">else</span>:
<a name="l02151"></a>02151         build_files.add(relative_include_file)
<a name="l02152"></a>02152 
<a name="l02153"></a>02153     base_path, output_file = CalculateMakefilePath(build_file,
<a name="l02154"></a>02154         target + <span class="stringliteral">'.'</span> + toolset + options.suffix + <span class="stringliteral">'.mk'</span>)
<a name="l02155"></a>02155 
<a name="l02156"></a>02156     spec = target_dicts[qualified_target]
<a name="l02157"></a>02157     configs = spec[<span class="stringliteral">'configurations'</span>]
<a name="l02158"></a>02158 
<a name="l02159"></a>02159     <span class="keywordflow">if</span> flavor == <span class="stringliteral">'mac'</span>:
<a name="l02160"></a>02160       gyp.xcode_emulation.MergeGlobalXcodeSettingsToSpec(data[build_file], spec)
<a name="l02161"></a>02161 
<a name="l02162"></a>02162     writer = MakefileWriter(generator_flags, flavor)
<a name="l02163"></a>02163     writer.Write(qualified_target, base_path, output_file, spec, configs,
<a name="l02164"></a>02164                  part_of_all=qualified_target <span class="keywordflow">in</span> needed_targets)
<a name="l02165"></a>02165 
<a name="l02166"></a>02166     <span class="comment"># Our root_makefile lives at the source root.  Compute the relative path</span>
<a name="l02167"></a>02167     <span class="comment"># from there to the output_file for including.</span>
<a name="l02168"></a>02168     mkfile_rel_path = gyp.common.RelativePath(output_file,
<a name="l02169"></a>02169                                               os.path.dirname(makefile_path))
<a name="l02170"></a>02170     include_list.add(mkfile_rel_path)
<a name="l02171"></a>02171 
<a name="l02172"></a>02172   <span class="comment"># Write out per-gyp (sub-project) Makefiles.</span>
<a name="l02173"></a>02173   depth_rel_path = gyp.common.RelativePath(options.depth, os.getcwd())
<a name="l02174"></a>02174   <span class="keywordflow">for</span> build_file <span class="keywordflow">in</span> build_files:
<a name="l02175"></a>02175     <span class="comment"># The paths in build_files were relativized above, so undo that before</span>
<a name="l02176"></a>02176     <span class="comment"># testing against the non-relativized items in target_list and before</span>
<a name="l02177"></a>02177     <span class="comment"># calculating the Makefile path.</span>
<a name="l02178"></a>02178     build_file = os.path.join(depth_rel_path, build_file)
<a name="l02179"></a>02179     gyp_targets = [target_dicts[target][<span class="stringliteral">'target_name'</span>] <span class="keywordflow">for</span> target <span class="keywordflow">in</span> target_list
<a name="l02180"></a>02180                    <span class="keywordflow">if</span> target.startswith(build_file) <span class="keywordflow">and</span>
<a name="l02181"></a>02181                    target <span class="keywordflow">in</span> needed_targets]
<a name="l02182"></a>02182     <span class="comment"># Only generate Makefiles for gyp files with targets.</span>
<a name="l02183"></a>02183     <span class="keywordflow">if</span> <span class="keywordflow">not</span> gyp_targets:
<a name="l02184"></a>02184       <span class="keywordflow">continue</span>
<a name="l02185"></a>02185     base_path, output_file = CalculateMakefilePath(build_file,
<a name="l02186"></a>02186         os.path.splitext(os.path.basename(build_file))[0] + <span class="stringliteral">'.Makefile'</span>)
<a name="l02187"></a>02187     makefile_rel_path = gyp.common.RelativePath(os.path.dirname(makefile_path),
<a name="l02188"></a>02188                                                 os.path.dirname(output_file))
<a name="l02189"></a>02189     writer.WriteSubMake(output_file, makefile_rel_path, gyp_targets,
<a name="l02190"></a>02190                         builddir_name)
<a name="l02191"></a>02191 
<a name="l02192"></a>02192 
<a name="l02193"></a>02193   <span class="comment"># Write out the sorted list of includes.</span>
<a name="l02194"></a>02194   root_makefile.write(<span class="stringliteral">'\n'</span>)
<a name="l02195"></a>02195   <span class="keywordflow">for</span> include_file <span class="keywordflow">in</span> sorted(include_list):
<a name="l02196"></a>02196     <span class="comment"># We wrap each .mk include in an if statement so users can tell make to</span>
<a name="l02197"></a>02197     <span class="comment"># not load a file by setting NO_LOAD.  The below make code says, only</span>
<a name="l02198"></a>02198     <span class="comment"># load the .mk file if the .mk filename doesn't start with a token in</span>
<a name="l02199"></a>02199     <span class="comment"># NO_LOAD.</span>
<a name="l02200"></a>02200     root_makefile.write(
<a name="l02201"></a>02201         <span class="stringliteral">"ifeq ($(strip $(foreach prefix,$(NO_LOAD),\\\n"</span>
<a name="l02202"></a>02202         <span class="stringliteral">"    $(findstring $(join ^,$(prefix)),\\\n"</span>
<a name="l02203"></a>02203         <span class="stringliteral">"                 $(join ^,"</span> + include_file + <span class="stringliteral">")))),)\n"</span>)
<a name="l02204"></a>02204     root_makefile.write(<span class="stringliteral">"  include "</span> + include_file + <span class="stringliteral">"\n"</span>)
<a name="l02205"></a>02205     root_makefile.write(<span class="stringliteral">"endif\n"</span>)
<a name="l02206"></a>02206   root_makefile.write(<span class="stringliteral">'\n'</span>)
<a name="l02207"></a>02207 
<a name="l02208"></a>02208   <span class="keywordflow">if</span> (<span class="keywordflow">not</span> generator_flags.get(<span class="stringliteral">'standalone'</span>)
<a name="l02209"></a>02209       <span class="keywordflow">and</span> generator_flags.get(<span class="stringliteral">'auto_regeneration'</span>, <span class="keyword">True</span>)):
<a name="l02210"></a>02210     WriteAutoRegenerationRule(params, root_makefile, makefile_name, build_files)
<a name="l02211"></a>02211 
<a name="l02212"></a>02212   root_makefile.write(SHARED_FOOTER)
<a name="l02213"></a>02213 
<a name="l02214"></a>02214   root_makefile.close()
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Wed Oct 7 19:26:26 2015 for Emeraldion Lodge (codename Zelda) by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.8 </small></address>
</body>
</html>
