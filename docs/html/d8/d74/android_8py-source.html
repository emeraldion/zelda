<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Emeraldion Lodge (codename Zelda): /Users/delphine/Development/SVN/emeraldion.it/zelda/node_modules/gulp-sass/node_modules/node-sass/node_modules/node-gyp/gyp/pylib/gyp/generator/android.py Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css">
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.8 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="../../main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="../../files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="../../globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>/Users/delphine/Development/SVN/emeraldion.it/zelda/node_modules/gulp-sass/node_modules/node-sass/node_modules/node-gyp/gyp/pylib/gyp/generator/android.py</h1><a href="../../de/d1c/android_8py.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a><a class="code" href="../../de/d18/namespacegyp_1_1generator_1_1android.html">00001</a> <span class="comment"># Copyright (c) 2012 Google Inc. All rights reserved.</span>
<a name="l00002"></a>00002 <span class="comment"># Use of this source code is governed by a BSD-style license that can be</span>
<a name="l00003"></a>00003 <span class="comment"># found in the LICENSE file.</span>
<a name="l00004"></a>00004 
<a name="l00005"></a>00005 <span class="comment"># Notes:</span>
<a name="l00006"></a>00006 <span class="comment">#</span>
<a name="l00007"></a>00007 <span class="comment"># This generates makefiles suitable for inclusion into the Android build system</span>
<a name="l00008"></a>00008 <span class="comment"># via an Android.mk file. It is based on make.py, the standard makefile</span>
<a name="l00009"></a>00009 <span class="comment"># generator.</span>
<a name="l00010"></a>00010 <span class="comment">#</span>
<a name="l00011"></a>00011 <span class="comment"># The code below generates a separate .mk file for each target, but</span>
<a name="l00012"></a>00012 <span class="comment"># all are sourced by the top-level GypAndroid.mk.  This means that all</span>
<a name="l00013"></a>00013 <span class="comment"># variables in .mk-files clobber one another, and furthermore that any</span>
<a name="l00014"></a>00014 <span class="comment"># variables set potentially clash with other Android build system variables.</span>
<a name="l00015"></a>00015 <span class="comment"># Try to avoid setting global variables where possible.</span>
<a name="l00016"></a>00016 
<a name="l00017"></a>00017 <span class="keyword">import</span> gyp
<a name="l00018"></a>00018 <span class="keyword">import</span> gyp.common
<a name="l00019"></a>00019 <span class="keyword">import</span> gyp.generator.make <span class="keyword">as</span> make  <span class="comment"># Reuse global functions from make backend.</span>
<a name="l00020"></a>00020 <span class="keyword">import</span> os
<a name="l00021"></a>00021 <span class="keyword">import</span> re
<a name="l00022"></a>00022 <span class="keyword">import</span> subprocess
<a name="l00023"></a>00023 
<a name="l00024"></a><a class="code" href="../../de/d18/namespacegyp_1_1generator_1_1android.html#723b572dde78d9a873e8b0c7936f0624">00024</a> generator_default_variables = {
<a name="l00025"></a>00025   <span class="stringliteral">'OS'</span>: <span class="stringliteral">'android'</span>,
<a name="l00026"></a>00026   <span class="stringliteral">'EXECUTABLE_PREFIX'</span>: <span class="stringliteral">''</span>,
<a name="l00027"></a>00027   <span class="stringliteral">'EXECUTABLE_SUFFIX'</span>: <span class="stringliteral">''</span>,
<a name="l00028"></a>00028   <span class="stringliteral">'STATIC_LIB_PREFIX'</span>: <span class="stringliteral">'lib'</span>,
<a name="l00029"></a>00029   <span class="stringliteral">'SHARED_LIB_PREFIX'</span>: <span class="stringliteral">'lib'</span>,
<a name="l00030"></a>00030   <span class="stringliteral">'STATIC_LIB_SUFFIX'</span>: <span class="stringliteral">'.a'</span>,
<a name="l00031"></a>00031   <span class="stringliteral">'SHARED_LIB_SUFFIX'</span>: <span class="stringliteral">'.so'</span>,
<a name="l00032"></a>00032   <span class="stringliteral">'INTERMEDIATE_DIR'</span>: <span class="stringliteral">'$(gyp_intermediate_dir)'</span>,
<a name="l00033"></a>00033   <span class="stringliteral">'SHARED_INTERMEDIATE_DIR'</span>: <span class="stringliteral">'$(gyp_shared_intermediate_dir)'</span>,
<a name="l00034"></a>00034   <span class="stringliteral">'PRODUCT_DIR'</span>: <span class="stringliteral">'$(gyp_shared_intermediate_dir)'</span>,
<a name="l00035"></a>00035   <span class="stringliteral">'SHARED_LIB_DIR'</span>: <span class="stringliteral">'$(builddir)/lib.$(TOOLSET)'</span>,
<a name="l00036"></a>00036   <span class="stringliteral">'LIB_DIR'</span>: <span class="stringliteral">'$(obj).$(TOOLSET)'</span>,
<a name="l00037"></a>00037   <span class="stringliteral">'RULE_INPUT_ROOT'</span>: <span class="stringliteral">'%(INPUT_ROOT)s'</span>,  <span class="comment"># This gets expanded by Python.</span>
<a name="l00038"></a>00038   <span class="stringliteral">'RULE_INPUT_DIRNAME'</span>: <span class="stringliteral">'%(INPUT_DIRNAME)s'</span>,  <span class="comment"># This gets expanded by Python.</span>
<a name="l00039"></a>00039   <span class="stringliteral">'RULE_INPUT_PATH'</span>: <span class="stringliteral">'$(RULE_SOURCES)'</span>,
<a name="l00040"></a>00040   <span class="stringliteral">'RULE_INPUT_EXT'</span>: <span class="stringliteral">'$(suffix $&lt;)'</span>,
<a name="l00041"></a>00041   <span class="stringliteral">'RULE_INPUT_NAME'</span>: <span class="stringliteral">'$(notdir $&lt;)'</span>,
<a name="l00042"></a>00042   <span class="stringliteral">'CONFIGURATION_NAME'</span>: <span class="stringliteral">'$(GYP_CONFIGURATION)'</span>,
<a name="l00043"></a>00043 }
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 <span class="comment"># Make supports multiple toolsets</span>
<a name="l00046"></a><a class="code" href="../../de/d18/namespacegyp_1_1generator_1_1android.html#2a27e7ea491d98a767cd9e3dc28eeb83">00046</a> generator_supports_multiple_toolsets = <span class="keyword">True</span>
<a name="l00047"></a>00047 
<a name="l00048"></a>00048 
<a name="l00049"></a>00049 <span class="comment"># Generator-specific gyp specs.</span>
<a name="l00050"></a><a class="code" href="../../de/d18/namespacegyp_1_1generator_1_1android.html#e3f6c5e948c3816610850b3c89f2dee4">00050</a> generator_additional_non_configuration_keys = [
<a name="l00051"></a>00051     <span class="comment"># Boolean to declare that this target does not want its name mangled.</span>
<a name="l00052"></a>00052     <span class="stringliteral">'android_unmangled_name'</span>,
<a name="l00053"></a>00053     <span class="comment"># Map of android build system variables to set.</span>
<a name="l00054"></a>00054     <span class="stringliteral">'aosp_build_settings'</span>,
<a name="l00055"></a>00055 ]
<a name="l00056"></a><a class="code" href="../../de/d18/namespacegyp_1_1generator_1_1android.html#1753481de22edc303822a2b99c378ecf">00056</a> generator_additional_path_sections = []
<a name="l00057"></a><a class="code" href="../../de/d18/namespacegyp_1_1generator_1_1android.html#e251ca3560612ed2140aea36d2b236fc">00057</a> generator_extra_sources_for_rules = []
<a name="l00058"></a>00058 
<a name="l00059"></a>00059 
<a name="l00060"></a><a class="code" href="../../de/d18/namespacegyp_1_1generator_1_1android.html#44b5393523d32ad5499b6c03068fb76b">00060</a> ALL_MODULES_FOOTER = <span class="stringliteral">"""\</span>
<a name="l00061"></a>00061 <span class="stringliteral"># "gyp_all_modules" is a concatenation of the "gyp_all_modules" targets from</span>
<a name="l00062"></a>00062 <span class="stringliteral"># all the included sub-makefiles. This is just here to clarify.</span>
<a name="l00063"></a>00063 <span class="stringliteral">gyp_all_modules:</span>
<a name="l00064"></a>00064 <span class="stringliteral">"""</span>
<a name="l00065"></a>00065 
<a name="l00066"></a><a class="code" href="../../de/d18/namespacegyp_1_1generator_1_1android.html#688c0e4d79df7681ef54007cc15cb567">00066</a> header = <span class="stringliteral">"""\</span>
<a name="l00067"></a>00067 <span class="stringliteral"># This file is generated by gyp; do not edit.</span>
<a name="l00068"></a>00068 <span class="stringliteral"></span>
<a name="l00069"></a>00069 <span class="stringliteral">"""</span>
<a name="l00070"></a>00070 
<a name="l00071"></a>00071 <span class="comment"># Map gyp target types to Android module classes.</span>
<a name="l00072"></a><a class="code" href="../../de/d18/namespacegyp_1_1generator_1_1android.html#161119bb6ca8e67575f130797c54781c">00072</a> MODULE_CLASSES = {
<a name="l00073"></a>00073     <span class="stringliteral">'static_library'</span>: <span class="stringliteral">'STATIC_LIBRARIES'</span>,
<a name="l00074"></a>00074     <span class="stringliteral">'shared_library'</span>: <span class="stringliteral">'SHARED_LIBRARIES'</span>,
<a name="l00075"></a>00075     <span class="stringliteral">'executable'</span>: <span class="stringliteral">'EXECUTABLES'</span>,
<a name="l00076"></a>00076 }
<a name="l00077"></a>00077 
<a name="l00078"></a>00078 
<a name="l00079"></a><a class="code" href="../../de/d18/namespacegyp_1_1generator_1_1android.html#aa4017e9fb989173c6794cc2d3d4124c">00079</a> <span class="keyword">def </span><a class="code" href="../../de/d18/namespacegyp_1_1generator_1_1android.html#aa4017e9fb989173c6794cc2d3d4124c">IsCPPExtension</a>(ext):
<a name="l00080"></a>00080   <span class="keywordflow">return</span> make.COMPILABLE_EXTENSIONS.get(ext) == <span class="stringliteral">'cxx'</span>
<a name="l00081"></a>00081 
<a name="l00082"></a>00082 
<a name="l00083"></a><a class="code" href="../../de/d18/namespacegyp_1_1generator_1_1android.html#0674ea18934faf8a5e8955a354e19129">00083</a> <span class="keyword">def </span><a class="code" href="../../de/d18/namespacegyp_1_1generator_1_1android.html#0674ea18934faf8a5e8955a354e19129">Sourceify</a>(path):
<a name="l00084"></a>00084   <span class="stringliteral">"""Convert a path to its source directory form. The Android backend does not</span>
<a name="l00085"></a>00085 <span class="stringliteral">     support options.generator_output, so this function is a noop."""</span>
<a name="l00086"></a>00086   <span class="keywordflow">return</span> path
<a name="l00087"></a>00087 
<a name="l00088"></a>00088 
<a name="l00089"></a>00089 <span class="comment"># Map from qualified target to path to output.</span>
<a name="l00090"></a>00090 <span class="comment"># For Android, the target of these maps is a tuple ('static', 'modulename'),</span>
<a name="l00091"></a>00091 <span class="comment"># ('dynamic', 'modulename'), or ('path', 'some/path') instead of a string,</span>
<a name="l00092"></a>00092 <span class="comment"># since we link by module.</span>
<a name="l00093"></a><a class="code" href="../../de/d18/namespacegyp_1_1generator_1_1android.html#af448ba5ff3b5d281fb4c4cd7c7eef16">00093</a> target_outputs = {}
<a name="l00094"></a>00094 <span class="comment"># Map from qualified target to any linkable output.  A subset</span>
<a name="l00095"></a>00095 <span class="comment"># of target_outputs.  E.g. when mybinary depends on liba, we want to</span>
<a name="l00096"></a>00096 <span class="comment"># include liba in the linker line; when otherbinary depends on</span>
<a name="l00097"></a>00097 <span class="comment"># mybinary, we just want to build mybinary first.</span>
<a name="l00098"></a><a class="code" href="../../de/d18/namespacegyp_1_1generator_1_1android.html#75b7056342503a647a743d951689e636">00098</a> target_link_deps = {}
<a name="l00099"></a>00099 
<a name="l00100"></a>00100 
<a name="l00101"></a><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html">00101</a> <span class="keyword">class </span><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html">AndroidMkWriter</a>(object):
<a name="l00102"></a>00102   <span class="stringliteral">"""AndroidMkWriter packages up the writing of one target-specific Android.mk.</span>
<a name="l00103"></a>00103 <span class="stringliteral"></span>
<a name="l00104"></a>00104 <span class="stringliteral">  Its only real entry point is Write(), and is mostly used for namespacing.</span>
<a name="l00105"></a>00105 <span class="stringliteral">  """</span>
<a name="l00106"></a>00106 
<a name="l00107"></a><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#c775ee34451fdfa742b318538164070e">00107</a>   <span class="keyword">def </span><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#c775ee34451fdfa742b318538164070e">__init__</a>(self, android_top_dir):
<a name="l00108"></a><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#a89a233ee068fdf968616b761ee37ca4">00108</a>     self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#a89a233ee068fdf968616b761ee37ca4">android_top_dir</a> = android_top_dir
<a name="l00109"></a>00109 
<a name="l00110"></a><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#fe042a271bd4d82d7c52a0a87e60f60a">00110</a>   <span class="keyword">def </span><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#fe042a271bd4d82d7c52a0a87e60f60a">Write</a>(self, qualified_target, relative_target, base_path, output_filename,
<a name="l00111"></a>00111             spec, configs, part_of_all, write_alias_target, sdk_version):
<a name="l00112"></a>00112     <span class="stringliteral">"""The main entry point: writes a .mk file for a single target.</span>
<a name="l00113"></a>00113 <span class="stringliteral"></span>
<a name="l00114"></a>00114 <span class="stringliteral">    Arguments:</span>
<a name="l00115"></a>00115 <span class="stringliteral">      qualified_target: target we're generating</span>
<a name="l00116"></a>00116 <span class="stringliteral">      relative_target: qualified target name relative to the root</span>
<a name="l00117"></a>00117 <span class="stringliteral">      base_path: path relative to source root we're building in, used to resolve</span>
<a name="l00118"></a>00118 <span class="stringliteral">                 target-relative paths</span>
<a name="l00119"></a>00119 <span class="stringliteral">      output_filename: output .mk file name to write</span>
<a name="l00120"></a>00120 <span class="stringliteral">      spec, configs: gyp info</span>
<a name="l00121"></a>00121 <span class="stringliteral">      part_of_all: flag indicating this target is part of 'all'</span>
<a name="l00122"></a>00122 <span class="stringliteral">      write_alias_target: flag indicating whether to create short aliases for</span>
<a name="l00123"></a>00123 <span class="stringliteral">                          this target</span>
<a name="l00124"></a>00124 <span class="stringliteral">      sdk_version: what to emit for LOCAL_SDK_VERSION in output</span>
<a name="l00125"></a>00125 <span class="stringliteral">    """</span>
<a name="l00126"></a>00126     gyp.common.EnsureDirExists(output_filename)
<a name="l00127"></a><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#883a1b899b644be7fc6d704c1d8e0c04">00127</a> 
<a name="l00128"></a>00128     self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#883a1b899b644be7fc6d704c1d8e0c04">fp</a> = open(output_filename, <span class="stringliteral">'w'</span>)
<a name="l00129"></a>00129 
<a name="l00130"></a>00130     self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#883a1b899b644be7fc6d704c1d8e0c04">fp</a>.write(header)
<a name="l00131"></a><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#073ea158f37820e141c05902aceb2889">00131</a> 
<a name="l00132"></a><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#848d705805c6b21b95d6b4794587e362">00132</a>     self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#073ea158f37820e141c05902aceb2889">qualified_target</a> = qualified_target
<a name="l00133"></a><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#a28dc103258589d9cb421197fe2de90b">00133</a>     self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#848d705805c6b21b95d6b4794587e362">relative_target</a> = relative_target
<a name="l00134"></a><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#5d2c023108742a1ce78ba9823c06ea35">00134</a>     self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#a28dc103258589d9cb421197fe2de90b">path</a> = base_path
<a name="l00135"></a><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">00135</a>     self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a> = spec[<span class="stringliteral">'target_name'</span>]
<a name="l00136"></a><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">00136</a>     self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> = spec[<span class="stringliteral">'type'</span>]
<a name="l00137"></a>00137     self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">toolset</a> = spec[<span class="stringliteral">'toolset'</span>]
<a name="l00138"></a>00138 
<a name="l00139"></a>00139     deps, link_deps = self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#d5018dacf3e72356c231736611d30af0">ComputeDeps</a>(spec)
<a name="l00140"></a>00140 
<a name="l00141"></a>00141     <span class="comment"># Some of the generation below can add extra output, sources, or</span>
<a name="l00142"></a>00142     <span class="comment"># link dependencies.  All of the out params of the functions that</span>
<a name="l00143"></a>00143     <span class="comment"># follow use names like extra_foo.</span>
<a name="l00144"></a>00144     extra_outputs = []
<a name="l00145"></a>00145     extra_sources = []
<a name="l00146"></a><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#3754838b5e2745870d9337a7e8d0eb85">00146</a> 
<a name="l00147"></a><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#22de76d3cfb57c7998f2b8e52128163c">00147</a>     self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#3754838b5e2745870d9337a7e8d0eb85">android_class</a> = MODULE_CLASSES.get(self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a>, <span class="stringliteral">'GYP'</span>)
<a name="l00148"></a>00148     self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#22de76d3cfb57c7998f2b8e52128163c">android_module</a> = self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#1ec74e7aef483c8ee80dc2134c44c49c">ComputeAndroidModule</a>(spec)
<a name="l00149"></a><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#9fac3d232e8876b6835d052a93b30bd0">00149</a>     (self.android_stem, self.android_suffix) = self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#1e78a00e0037943652f8f1cf42ecc99d">ComputeOutputParts</a>(spec)
<a name="l00150"></a>00150     self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#d288825273ed7192429ab0474fb2d4a0">output</a> = self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#9fac3d232e8876b6835d052a93b30bd0">output_binary</a> = self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#097c9e2913bffe213c7a56b1b1508997">ComputeOutput</a>(spec)
<a name="l00151"></a>00151 
<a name="l00152"></a>00152     <span class="comment"># Standard header.</span>
<a name="l00153"></a>00153     self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'include $(CLEAR_VARS)\n'</span>)
<a name="l00154"></a>00154 
<a name="l00155"></a>00155     <span class="comment"># Module class and name.</span>
<a name="l00156"></a>00156     self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'LOCAL_MODULE_CLASS := '</span> + self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#3754838b5e2745870d9337a7e8d0eb85">android_class</a>)
<a name="l00157"></a>00157     self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'LOCAL_MODULE := '</span> + self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#22de76d3cfb57c7998f2b8e52128163c">android_module</a>)
<a name="l00158"></a>00158     <span class="comment"># Only emit LOCAL_MODULE_STEM if it's different to LOCAL_MODULE.</span>
<a name="l00159"></a>00159     <span class="comment"># The library module classes fail if the stem is set. ComputeOutputParts</span>
<a name="l00160"></a>00160     <span class="comment"># makes sure that stem == modulename in these cases.</span>
<a name="l00161"></a>00161     <span class="keywordflow">if</span> self.android_stem != self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#22de76d3cfb57c7998f2b8e52128163c">android_module</a>:
<a name="l00162"></a>00162       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'LOCAL_MODULE_STEM := '</span> + self.android_stem)
<a name="l00163"></a>00163     self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'LOCAL_MODULE_SUFFIX := '</span> + self.android_suffix)
<a name="l00164"></a>00164     <span class="keywordflow">if</span> self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">toolset</a> == <span class="stringliteral">'host'</span>:
<a name="l00165"></a>00165       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'LOCAL_IS_HOST_MODULE := true'</span>)
<a name="l00166"></a>00166       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'LOCAL_MULTILIB := $(GYP_HOST_MULTILIB)'</span>)
<a name="l00167"></a>00167     <span class="keywordflow">else</span>:
<a name="l00168"></a>00168       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'LOCAL_MODULE_TARGET_ARCH := '</span>
<a name="l00169"></a>00169                    <span class="stringliteral">'$(TARGET_$(GYP_VAR_PREFIX)ARCH)'</span>)
<a name="l00170"></a>00170       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'LOCAL_SDK_VERSION := %s'</span> % sdk_version)
<a name="l00171"></a>00171 
<a name="l00172"></a>00172     <span class="comment"># Grab output directories; needed for Actions and Rules.</span>
<a name="l00173"></a>00173     <span class="keywordflow">if</span> self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">toolset</a> == <span class="stringliteral">'host'</span>:
<a name="l00174"></a>00174       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'gyp_intermediate_dir := '</span>
<a name="l00175"></a>00175                    <span class="stringliteral">'$(call local-intermediates-dir,,$(GYP_HOST_VAR_PREFIX))'</span>)
<a name="l00176"></a>00176     <span class="keywordflow">else</span>:
<a name="l00177"></a>00177       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'gyp_intermediate_dir := '</span>
<a name="l00178"></a>00178                    <span class="stringliteral">'$(call local-intermediates-dir,,$(GYP_VAR_PREFIX))'</span>)
<a name="l00179"></a>00179     self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'gyp_shared_intermediate_dir := '</span>
<a name="l00180"></a>00180                  <span class="stringliteral">'$(call intermediates-dir-for,GYP,shared,,,$(GYP_VAR_PREFIX))'</span>)
<a name="l00181"></a>00181     self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>()
<a name="l00182"></a>00182 
<a name="l00183"></a>00183     <span class="comment"># List files this target depends on so that actions/rules/copies/sources</span>
<a name="l00184"></a>00184     <span class="comment"># can depend on the list.</span>
<a name="l00185"></a>00185     <span class="comment"># TODO: doesn't pull in things through transitive link deps; needed?</span>
<a name="l00186"></a>00186     target_dependencies = [x[1] <span class="keywordflow">for</span> x <span class="keywordflow">in</span> deps <span class="keywordflow">if</span> x[0] == <span class="stringliteral">'path'</span>]
<a name="l00187"></a>00187     self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'# Make sure our deps are built first.'</span>)
<a name="l00188"></a>00188     self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#93de12c6d9b1aa90c3f3a8b0bfc1fffa">WriteList</a>(target_dependencies, <span class="stringliteral">'GYP_TARGET_DEPENDENCIES'</span>,
<a name="l00189"></a>00189                    local_pathify=<span class="keyword">True</span>)
<a name="l00190"></a>00190 
<a name="l00191"></a>00191     <span class="comment"># Actions must come first, since they can generate more OBJs for use below.</span>
<a name="l00192"></a>00192     <span class="keywordflow">if</span> <span class="stringliteral">'actions'</span> <span class="keywordflow">in</span> spec:
<a name="l00193"></a>00193       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#fc4b663ae8e353dfc043e4be9150bdc2">WriteActions</a>(spec[<span class="stringliteral">'actions'</span>], extra_sources, extra_outputs)
<a name="l00194"></a>00194 
<a name="l00195"></a>00195     <span class="comment"># Rules must be early like actions.</span>
<a name="l00196"></a>00196     <span class="keywordflow">if</span> <span class="stringliteral">'rules'</span> <span class="keywordflow">in</span> spec:
<a name="l00197"></a>00197       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#64a7ef6362ff4c4b9191e0761d97b247">WriteRules</a>(spec[<span class="stringliteral">'rules'</span>], extra_sources, extra_outputs)
<a name="l00198"></a>00198 
<a name="l00199"></a>00199     <span class="keywordflow">if</span> <span class="stringliteral">'copies'</span> <span class="keywordflow">in</span> spec:
<a name="l00200"></a>00200       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#cb7218d4227c7eb14ab546b33c2e7cb8">WriteCopies</a>(spec[<span class="stringliteral">'copies'</span>], extra_outputs)
<a name="l00201"></a>00201 
<a name="l00202"></a>00202     <span class="comment"># GYP generated outputs.</span>
<a name="l00203"></a>00203     self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#93de12c6d9b1aa90c3f3a8b0bfc1fffa">WriteList</a>(extra_outputs, <span class="stringliteral">'GYP_GENERATED_OUTPUTS'</span>, local_pathify=<span class="keyword">True</span>)
<a name="l00204"></a>00204 
<a name="l00205"></a>00205     <span class="comment"># Set LOCAL_ADDITIONAL_DEPENDENCIES so that Android's build rules depend</span>
<a name="l00206"></a>00206     <span class="comment"># on both our dependency targets and our generated files.</span>
<a name="l00207"></a>00207     self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'# Make sure our deps and generated files are built first.'</span>)
<a name="l00208"></a>00208     self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'LOCAL_ADDITIONAL_DEPENDENCIES := $(GYP_TARGET_DEPENDENCIES) '</span>
<a name="l00209"></a>00209                  <span class="stringliteral">'$(GYP_GENERATED_OUTPUTS)'</span>)
<a name="l00210"></a>00210     self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>()
<a name="l00211"></a>00211 
<a name="l00212"></a>00212     <span class="comment"># Sources.</span>
<a name="l00213"></a>00213     <span class="keywordflow">if</span> spec.get(<span class="stringliteral">'sources'</span>, []) <span class="keywordflow">or</span> extra_sources:
<a name="l00214"></a>00214       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#7c3bf79a4bd2f19944fc222c6bcfffc0">WriteSources</a>(spec, configs, extra_sources)
<a name="l00215"></a>00215 
<a name="l00216"></a>00216     self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#203d0a7515c00ce74d55f93e632eedfe">WriteTarget</a>(spec, configs, deps, link_deps, part_of_all,
<a name="l00217"></a>00217                      write_alias_target)
<a name="l00218"></a>00218 
<a name="l00219"></a>00219     <span class="comment"># Update global list of target outputs, used in dependency tracking.</span>
<a name="l00220"></a>00220     target_outputs[qualified_target] = (<span class="stringliteral">'path'</span>, self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#9fac3d232e8876b6835d052a93b30bd0">output_binary</a>)
<a name="l00221"></a>00221 
<a name="l00222"></a>00222     <span class="comment"># Update global list of link dependencies.</span>
<a name="l00223"></a>00223     <span class="keywordflow">if</span> self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> == <span class="stringliteral">'static_library'</span>:
<a name="l00224"></a>00224       target_link_deps[qualified_target] = (<span class="stringliteral">'static'</span>, self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#22de76d3cfb57c7998f2b8e52128163c">android_module</a>)
<a name="l00225"></a>00225     <span class="keywordflow">elif</span> self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> == <span class="stringliteral">'shared_library'</span>:
<a name="l00226"></a>00226       target_link_deps[qualified_target] = (<span class="stringliteral">'shared'</span>, self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#22de76d3cfb57c7998f2b8e52128163c">android_module</a>)
<a name="l00227"></a>00227 
<a name="l00228"></a>00228     self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#883a1b899b644be7fc6d704c1d8e0c04">fp</a>.close()
<a name="l00229"></a>00229     <span class="keywordflow">return</span> self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#22de76d3cfb57c7998f2b8e52128163c">android_module</a>
<a name="l00230"></a>00230 
<a name="l00231"></a>00231 
<a name="l00232"></a><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#fc4b663ae8e353dfc043e4be9150bdc2">00232</a>   <span class="keyword">def </span><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#fc4b663ae8e353dfc043e4be9150bdc2">WriteActions</a>(self, actions, extra_sources, extra_outputs):
<a name="l00233"></a>00233     <span class="stringliteral">"""Write Makefile code for any 'actions' from the gyp input.</span>
<a name="l00234"></a>00234 <span class="stringliteral"></span>
<a name="l00235"></a>00235 <span class="stringliteral">    extra_sources: a list that will be filled in with newly generated source</span>
<a name="l00236"></a>00236 <span class="stringliteral">                   files, if any</span>
<a name="l00237"></a>00237 <span class="stringliteral">    extra_outputs: a list that will be filled in with any outputs of these</span>
<a name="l00238"></a>00238 <span class="stringliteral">                   actions (used to make other pieces dependent on these</span>
<a name="l00239"></a>00239 <span class="stringliteral">                   actions)</span>
<a name="l00240"></a>00240 <span class="stringliteral">    """</span>
<a name="l00241"></a>00241     <span class="keywordflow">for</span> action <span class="keywordflow">in</span> actions:
<a name="l00242"></a>00242       name = make.StringToMakefileVariable(<span class="stringliteral">'%s_%s'</span> % (self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#848d705805c6b21b95d6b4794587e362">relative_target</a>,
<a name="l00243"></a>00243                                                       action[<span class="stringliteral">'action_name'</span>]))
<a name="l00244"></a>00244       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'### Rules for action "%s":'</span> % action[<span class="stringliteral">'action_name'</span>])
<a name="l00245"></a>00245       inputs = action[<span class="stringliteral">'inputs'</span>]
<a name="l00246"></a>00246       outputs = action[<span class="stringliteral">'outputs'</span>]
<a name="l00247"></a>00247 
<a name="l00248"></a>00248       <span class="comment"># Build up a list of outputs.</span>
<a name="l00249"></a>00249       <span class="comment"># Collect the output dirs we'll need.</span>
<a name="l00250"></a>00250       dirs = set()
<a name="l00251"></a>00251       <span class="keywordflow">for</span> out <span class="keywordflow">in</span> outputs:
<a name="l00252"></a>00252         <span class="keywordflow">if</span> <span class="keywordflow">not</span> out.startswith(<span class="stringliteral">'$'</span>):
<a name="l00253"></a>00253           <span class="keywordflow">print</span> (<span class="stringliteral">'WARNING: Action for target "%s" writes output to local path '</span>
<a name="l00254"></a>00254                  <span class="stringliteral">'"%s".'</span> % (self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>, out))
<a name="l00255"></a>00255         dir = os.path.split(out)[0]
<a name="l00256"></a>00256         <span class="keywordflow">if</span> dir:
<a name="l00257"></a>00257           dirs.add(dir)
<a name="l00258"></a>00258       <span class="keywordflow">if</span> int(action.get(<span class="stringliteral">'process_outputs_as_sources'</span>, <span class="keyword">False</span>)):
<a name="l00259"></a>00259         extra_sources += outputs
<a name="l00260"></a>00260 
<a name="l00261"></a>00261       <span class="comment"># Prepare the actual command.</span>
<a name="l00262"></a>00262       command = gyp.common.EncodePOSIXShellList(action[<span class="stringliteral">'action'</span>])
<a name="l00263"></a>00263       <span class="keywordflow">if</span> <span class="stringliteral">'message'</span> <span class="keywordflow">in</span> action:
<a name="l00264"></a>00264         quiet_cmd = <span class="stringliteral">'Gyp action: %s ($@)'</span> % action[<span class="stringliteral">'message'</span>]
<a name="l00265"></a>00265       <span class="keywordflow">else</span>:
<a name="l00266"></a>00266         quiet_cmd = <span class="stringliteral">'Gyp action: %s ($@)'</span> % name
<a name="l00267"></a>00267       <span class="keywordflow">if</span> len(dirs) &gt; 0:
<a name="l00268"></a>00268         command = <span class="stringliteral">'mkdir -p %s'</span> % <span class="stringliteral">' '</span>.join(dirs) + <span class="stringliteral">'; '</span> + command
<a name="l00269"></a>00269 
<a name="l00270"></a>00270       cd_action = <span class="stringliteral">'cd $(gyp_local_path)/%s; '</span> % self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#a28dc103258589d9cb421197fe2de90b">path</a>
<a name="l00271"></a>00271       command = cd_action + command
<a name="l00272"></a>00272 
<a name="l00273"></a>00273       <span class="comment"># The makefile rules are all relative to the top dir, but the gyp actions</span>
<a name="l00274"></a>00274       <span class="comment"># are defined relative to their containing dir.  This replaces the gyp_*</span>
<a name="l00275"></a>00275       <span class="comment"># variables for the action rule with an absolute version so that the</span>
<a name="l00276"></a>00276       <span class="comment"># output goes in the right place.</span>
<a name="l00277"></a>00277       <span class="comment"># Only write the gyp_* rules for the "primary" output (:1);</span>
<a name="l00278"></a>00278       <span class="comment"># it's superfluous for the "extra outputs", and this avoids accidentally</span>
<a name="l00279"></a>00279       <span class="comment"># writing duplicate dummy rules for those outputs.</span>
<a name="l00280"></a>00280       main_output = make.QuoteSpaces(self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#a58e8277df9571779e5a5ff7951c5022">LocalPathify</a>(outputs[0]))
<a name="l00281"></a>00281       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'%s: gyp_local_path := $(LOCAL_PATH)'</span> % main_output)
<a name="l00282"></a>00282       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'%s: gyp_var_prefix := $(GYP_VAR_PREFIX)'</span> % main_output)
<a name="l00283"></a>00283       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'%s: gyp_intermediate_dir := '</span>
<a name="l00284"></a>00284                    <span class="stringliteral">'$(abspath $(gyp_intermediate_dir))'</span> % main_output)
<a name="l00285"></a>00285       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'%s: gyp_shared_intermediate_dir := '</span>
<a name="l00286"></a>00286                    <span class="stringliteral">'$(abspath $(gyp_shared_intermediate_dir))'</span> % main_output)
<a name="l00287"></a>00287 
<a name="l00288"></a>00288       <span class="comment"># Android's envsetup.sh adds a number of directories to the path including</span>
<a name="l00289"></a>00289       <span class="comment"># the built host binary directory. This causes actions/rules invoked by</span>
<a name="l00290"></a>00290       <span class="comment"># gyp to sometimes use these instead of system versions, e.g. bison.</span>
<a name="l00291"></a>00291       <span class="comment"># The built host binaries may not be suitable, and can cause errors.</span>
<a name="l00292"></a>00292       <span class="comment"># So, we remove them from the PATH using the ANDROID_BUILD_PATHS variable</span>
<a name="l00293"></a>00293       <span class="comment"># set by envsetup.</span>
<a name="l00294"></a>00294       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'%s: export PATH := $(subst $(ANDROID_BUILD_PATHS),,$(PATH))'</span>
<a name="l00295"></a>00295                    % main_output)
<a name="l00296"></a>00296 
<a name="l00297"></a>00297       <span class="comment"># Don't allow spaces in input/output filenames, but make an exception for</span>
<a name="l00298"></a>00298       <span class="comment"># filenames which start with '$(' since it's okay for there to be spaces</span>
<a name="l00299"></a>00299       <span class="comment"># inside of make function/macro invocations.</span>
<a name="l00300"></a>00300       <span class="keywordflow">for</span> input <span class="keywordflow">in</span> inputs:
<a name="l00301"></a>00301         <span class="keywordflow">if</span> <span class="keywordflow">not</span> input.startswith(<span class="stringliteral">'$('</span>) <span class="keywordflow">and</span> <span class="stringliteral">' '</span> <span class="keywordflow">in</span> input:
<a name="l00302"></a>00302           <span class="keywordflow">raise</span> gyp.common.GypError(
<a name="l00303"></a>00303               <span class="stringliteral">'Action input filename "%s" in target %s contains a space'</span> %
<a name="l00304"></a>00304               (input, self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>))
<a name="l00305"></a>00305       <span class="keywordflow">for</span> output <span class="keywordflow">in</span> outputs:
<a name="l00306"></a>00306         <span class="keywordflow">if</span> <span class="keywordflow">not</span> output.startswith(<span class="stringliteral">'$('</span>) <span class="keywordflow">and</span> <span class="stringliteral">' '</span> <span class="keywordflow">in</span> output:
<a name="l00307"></a>00307           <span class="keywordflow">raise</span> gyp.common.GypError(
<a name="l00308"></a>00308               <span class="stringliteral">'Action output filename "%s" in target %s contains a space'</span> %
<a name="l00309"></a>00309               (output, self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>))
<a name="l00310"></a>00310 
<a name="l00311"></a>00311       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'%s: %s $(GYP_TARGET_DEPENDENCIES)'</span> %
<a name="l00312"></a>00312                    (main_output, <span class="stringliteral">' '</span>.join(map(self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#a58e8277df9571779e5a5ff7951c5022">LocalPathify</a>, inputs))))
<a name="l00313"></a>00313       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'\t@echo "%s"'</span> % quiet_cmd)
<a name="l00314"></a>00314       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'\t$(hide)%s\n'</span> % command)
<a name="l00315"></a>00315       <span class="keywordflow">for</span> output <span class="keywordflow">in</span> outputs[1:]:
<a name="l00316"></a>00316         <span class="comment"># Make each output depend on the main output, with an empty command</span>
<a name="l00317"></a>00317         <span class="comment"># to force make to notice that the mtime has changed.</span>
<a name="l00318"></a>00318         self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'%s: %s ;'</span> % (self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#a58e8277df9571779e5a5ff7951c5022">LocalPathify</a>(output), main_output))
<a name="l00319"></a>00319 
<a name="l00320"></a>00320       extra_outputs += outputs
<a name="l00321"></a>00321       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>()
<a name="l00322"></a>00322 
<a name="l00323"></a>00323     self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>()
<a name="l00324"></a>00324 
<a name="l00325"></a>00325 
<a name="l00326"></a><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#64a7ef6362ff4c4b9191e0761d97b247">00326</a>   <span class="keyword">def </span><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#64a7ef6362ff4c4b9191e0761d97b247">WriteRules</a>(self, rules, extra_sources, extra_outputs):
<a name="l00327"></a>00327     <span class="stringliteral">"""Write Makefile code for any 'rules' from the gyp input.</span>
<a name="l00328"></a>00328 <span class="stringliteral"></span>
<a name="l00329"></a>00329 <span class="stringliteral">    extra_sources: a list that will be filled in with newly generated source</span>
<a name="l00330"></a>00330 <span class="stringliteral">                   files, if any</span>
<a name="l00331"></a>00331 <span class="stringliteral">    extra_outputs: a list that will be filled in with any outputs of these</span>
<a name="l00332"></a>00332 <span class="stringliteral">                   rules (used to make other pieces dependent on these rules)</span>
<a name="l00333"></a>00333 <span class="stringliteral">    """</span>
<a name="l00334"></a>00334     <span class="keywordflow">if</span> len(rules) == 0:
<a name="l00335"></a>00335       <span class="keywordflow">return</span>
<a name="l00336"></a>00336 
<a name="l00337"></a>00337     <span class="keywordflow">for</span> rule <span class="keywordflow">in</span> rules:
<a name="l00338"></a>00338       <span class="keywordflow">if</span> len(rule.get(<span class="stringliteral">'rule_sources'</span>, [])) == 0:
<a name="l00339"></a>00339         <span class="keywordflow">continue</span>
<a name="l00340"></a>00340       name = make.StringToMakefileVariable(<span class="stringliteral">'%s_%s'</span> % (self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#848d705805c6b21b95d6b4794587e362">relative_target</a>,
<a name="l00341"></a>00341                                                       rule[<span class="stringliteral">'rule_name'</span>]))
<a name="l00342"></a>00342       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'\n### Generated for rule "%s":'</span> % name)
<a name="l00343"></a>00343       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'# "%s":'</span> % rule)
<a name="l00344"></a>00344 
<a name="l00345"></a>00345       inputs = rule.get(<span class="stringliteral">'inputs'</span>)
<a name="l00346"></a>00346       <span class="keywordflow">for</span> rule_source <span class="keywordflow">in</span> rule.get(<span class="stringliteral">'rule_sources'</span>, []):
<a name="l00347"></a>00347         (rule_source_dirname, rule_source_basename) = os.path.split(rule_source)
<a name="l00348"></a>00348         (rule_source_root, rule_source_ext) = \
<a name="l00349"></a>00349             os.path.splitext(rule_source_basename)
<a name="l00350"></a>00350 
<a name="l00351"></a>00351         outputs = [self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#88c6708e9588f546826f6886970f724d">ExpandInputRoot</a>(out, rule_source_root,
<a name="l00352"></a>00352                                         rule_source_dirname)
<a name="l00353"></a>00353                    <span class="keywordflow">for</span> out <span class="keywordflow">in</span> rule[<span class="stringliteral">'outputs'</span>]]
<a name="l00354"></a>00354 
<a name="l00355"></a>00355         dirs = set()
<a name="l00356"></a>00356         <span class="keywordflow">for</span> out <span class="keywordflow">in</span> outputs:
<a name="l00357"></a>00357           <span class="keywordflow">if</span> <span class="keywordflow">not</span> out.startswith(<span class="stringliteral">'$'</span>):
<a name="l00358"></a>00358             <span class="keywordflow">print</span> (<span class="stringliteral">'WARNING: Rule for target %s writes output to local path %s'</span>
<a name="l00359"></a>00359                    % (self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>, out))
<a name="l00360"></a>00360           dir = os.path.dirname(out)
<a name="l00361"></a>00361           <span class="keywordflow">if</span> dir:
<a name="l00362"></a>00362             dirs.add(dir)
<a name="l00363"></a>00363         extra_outputs += outputs
<a name="l00364"></a>00364         <span class="keywordflow">if</span> int(rule.get(<span class="stringliteral">'process_outputs_as_sources'</span>, <span class="keyword">False</span>)):
<a name="l00365"></a>00365           extra_sources.extend(outputs)
<a name="l00366"></a>00366 
<a name="l00367"></a>00367         components = []
<a name="l00368"></a>00368         <span class="keywordflow">for</span> component <span class="keywordflow">in</span> rule[<span class="stringliteral">'action'</span>]:
<a name="l00369"></a>00369           component = self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#88c6708e9588f546826f6886970f724d">ExpandInputRoot</a>(component, rule_source_root,
<a name="l00370"></a>00370                                            rule_source_dirname)
<a name="l00371"></a>00371           <span class="keywordflow">if</span> <span class="stringliteral">'$(RULE_SOURCES)'</span> <span class="keywordflow">in</span> component:
<a name="l00372"></a>00372             component = component.replace(<span class="stringliteral">'$(RULE_SOURCES)'</span>,
<a name="l00373"></a>00373                                           rule_source)
<a name="l00374"></a>00374           components.append(component)
<a name="l00375"></a>00375 
<a name="l00376"></a>00376         command = gyp.common.EncodePOSIXShellList(components)
<a name="l00377"></a>00377         cd_action = <span class="stringliteral">'cd $(gyp_local_path)/%s; '</span> % self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#a28dc103258589d9cb421197fe2de90b">path</a>
<a name="l00378"></a>00378         command = cd_action + command
<a name="l00379"></a>00379         <span class="keywordflow">if</span> dirs:
<a name="l00380"></a>00380           command = <span class="stringliteral">'mkdir -p %s'</span> % <span class="stringliteral">' '</span>.join(dirs) + <span class="stringliteral">'; '</span> + command
<a name="l00381"></a>00381 
<a name="l00382"></a>00382         <span class="comment"># We set up a rule to build the first output, and then set up</span>
<a name="l00383"></a>00383         <span class="comment"># a rule for each additional output to depend on the first.</span>
<a name="l00384"></a>00384         outputs = map(self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#a58e8277df9571779e5a5ff7951c5022">LocalPathify</a>, outputs)
<a name="l00385"></a>00385         main_output = outputs[0]
<a name="l00386"></a>00386         self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'%s: gyp_local_path := $(LOCAL_PATH)'</span> % main_output)
<a name="l00387"></a>00387         self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'%s: gyp_var_prefix := $(GYP_VAR_PREFIX)'</span> % main_output)
<a name="l00388"></a>00388         self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'%s: gyp_intermediate_dir := '</span>
<a name="l00389"></a>00389                      <span class="stringliteral">'$(abspath $(gyp_intermediate_dir))'</span> % main_output)
<a name="l00390"></a>00390         self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'%s: gyp_shared_intermediate_dir := '</span>
<a name="l00391"></a>00391                      <span class="stringliteral">'$(abspath $(gyp_shared_intermediate_dir))'</span> % main_output)
<a name="l00392"></a>00392 
<a name="l00393"></a>00393         <span class="comment"># See explanation in WriteActions.</span>
<a name="l00394"></a>00394         self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'%s: export PATH := '</span>
<a name="l00395"></a>00395                      <span class="stringliteral">'$(subst $(ANDROID_BUILD_PATHS),,$(PATH))'</span> % main_output)
<a name="l00396"></a>00396 
<a name="l00397"></a>00397         main_output_deps = self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#a58e8277df9571779e5a5ff7951c5022">LocalPathify</a>(rule_source)
<a name="l00398"></a>00398         <span class="keywordflow">if</span> inputs:
<a name="l00399"></a>00399           main_output_deps += <span class="stringliteral">' '</span>
<a name="l00400"></a>00400           main_output_deps += <span class="stringliteral">' '</span>.join([self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#a58e8277df9571779e5a5ff7951c5022">LocalPathify</a>(f) <span class="keywordflow">for</span> f <span class="keywordflow">in</span> inputs])
<a name="l00401"></a>00401 
<a name="l00402"></a>00402         self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'%s: %s $(GYP_TARGET_DEPENDENCIES)'</span> %
<a name="l00403"></a>00403                      (main_output, main_output_deps))
<a name="l00404"></a>00404         self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'\t%s\n'</span> % command)
<a name="l00405"></a>00405         <span class="keywordflow">for</span> output <span class="keywordflow">in</span> outputs[1:]:
<a name="l00406"></a>00406           <span class="comment"># Make each output depend on the main output, with an empty command</span>
<a name="l00407"></a>00407           <span class="comment"># to force make to notice that the mtime has changed.</span>
<a name="l00408"></a>00408           self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'%s: %s ;'</span> % (output, main_output))
<a name="l00409"></a>00409         self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>()
<a name="l00410"></a>00410 
<a name="l00411"></a>00411     self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>()
<a name="l00412"></a>00412 
<a name="l00413"></a>00413 
<a name="l00414"></a><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#cb7218d4227c7eb14ab546b33c2e7cb8">00414</a>   <span class="keyword">def </span><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#cb7218d4227c7eb14ab546b33c2e7cb8">WriteCopies</a>(self, copies, extra_outputs):
<a name="l00415"></a>00415     <span class="stringliteral">"""Write Makefile code for any 'copies' from the gyp input.</span>
<a name="l00416"></a>00416 <span class="stringliteral"></span>
<a name="l00417"></a>00417 <span class="stringliteral">    extra_outputs: a list that will be filled in with any outputs of this action</span>
<a name="l00418"></a>00418 <span class="stringliteral">                   (used to make other pieces dependent on this action)</span>
<a name="l00419"></a>00419 <span class="stringliteral">    """</span>
<a name="l00420"></a>00420     self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'### Generated for copy rule.'</span>)
<a name="l00421"></a>00421 
<a name="l00422"></a>00422     variable = make.StringToMakefileVariable(self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#848d705805c6b21b95d6b4794587e362">relative_target</a> + <span class="stringliteral">'_copies'</span>)
<a name="l00423"></a>00423     outputs = []
<a name="l00424"></a>00424     <span class="keywordflow">for</span> copy <span class="keywordflow">in</span> copies:
<a name="l00425"></a>00425       <span class="keywordflow">for</span> path <span class="keywordflow">in</span> copy[<span class="stringliteral">'files'</span>]:
<a name="l00426"></a>00426         <span class="comment"># The Android build system does not allow generation of files into the</span>
<a name="l00427"></a>00427         <span class="comment"># source tree. The destination should start with a variable, which will</span>
<a name="l00428"></a>00428         <span class="comment"># typically be $(gyp_intermediate_dir) or</span>
<a name="l00429"></a>00429         <span class="comment"># $(gyp_shared_intermediate_dir). Note that we can't use an assertion</span>
<a name="l00430"></a>00430         <span class="comment"># because some of the gyp tests depend on this.</span>
<a name="l00431"></a>00431         <span class="keywordflow">if</span> <span class="keywordflow">not</span> copy[<span class="stringliteral">'destination'</span>].startswith(<span class="stringliteral">'$'</span>):
<a name="l00432"></a>00432           <span class="keywordflow">print</span> (<span class="stringliteral">'WARNING: Copy rule for target %s writes output to '</span>
<a name="l00433"></a>00433                  <span class="stringliteral">'local path %s'</span> % (self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>, copy[<span class="stringliteral">'destination'</span>]))
<a name="l00434"></a>00434 
<a name="l00435"></a>00435         <span class="comment"># LocalPathify() calls normpath, stripping trailing slashes.</span>
<a name="l00436"></a>00436         path = Sourceify(self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#a58e8277df9571779e5a5ff7951c5022">LocalPathify</a>(path))
<a name="l00437"></a>00437         filename = os.path.split(path)[1]
<a name="l00438"></a>00438         output = Sourceify(self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#a58e8277df9571779e5a5ff7951c5022">LocalPathify</a>(os.path.join(copy[<span class="stringliteral">'destination'</span>],
<a name="l00439"></a>00439                                                           filename)))
<a name="l00440"></a>00440 
<a name="l00441"></a>00441         self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'%s: %s $(GYP_TARGET_DEPENDENCIES) | $(ACP)'</span> %
<a name="l00442"></a>00442                      (output, path))
<a name="l00443"></a>00443         self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'\t@echo Copying: $@'</span>)
<a name="l00444"></a>00444         self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'\t$(hide) mkdir -p $(dir $@)'</span>)
<a name="l00445"></a>00445         self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'\t$(hide) $(ACP) -rpf $&lt; $@'</span>)
<a name="l00446"></a>00446         self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>()
<a name="l00447"></a>00447         outputs.append(output)
<a name="l00448"></a>00448     self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'%s = %s'</span> % (variable,
<a name="l00449"></a>00449                               <span class="stringliteral">' '</span>.join(map(make.QuoteSpaces, outputs))))
<a name="l00450"></a>00450     extra_outputs.append(<span class="stringliteral">'$(%s)'</span> % variable)
<a name="l00451"></a>00451     self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>()
<a name="l00452"></a>00452 
<a name="l00453"></a>00453 
<a name="l00454"></a><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#42911f7172f605283acf6b4430e0865c">00454</a>   <span class="keyword">def </span><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#42911f7172f605283acf6b4430e0865c">WriteSourceFlags</a>(self, spec, configs):
<a name="l00455"></a>00455     <span class="stringliteral">"""Write out the flags and include paths used to compile source files for</span>
<a name="l00456"></a>00456 <span class="stringliteral">    the current target.</span>
<a name="l00457"></a>00457 <span class="stringliteral"></span>
<a name="l00458"></a>00458 <span class="stringliteral">    Args:</span>
<a name="l00459"></a>00459 <span class="stringliteral">      spec, configs: input from gyp.</span>
<a name="l00460"></a>00460 <span class="stringliteral">    """</span>
<a name="l00461"></a>00461     <span class="keywordflow">for</span> configname, config <span class="keywordflow">in</span> sorted(configs.iteritems()):
<a name="l00462"></a>00462       extracted_includes = []
<a name="l00463"></a>00463 
<a name="l00464"></a>00464       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'\n# Flags passed to both C and C++ files.'</span>)
<a name="l00465"></a>00465       cflags, includes_from_cflags = self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#1494ad5cf0f0409e2a2afd9b9c859eaa">ExtractIncludesFromCFlags</a>(
<a name="l00466"></a>00466           config.get(<span class="stringliteral">'cflags'</span>, []) + config.get(<span class="stringliteral">'cflags_c'</span>, []))
<a name="l00467"></a>00467       extracted_includes.extend(includes_from_cflags)
<a name="l00468"></a>00468       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#93de12c6d9b1aa90c3f3a8b0bfc1fffa">WriteList</a>(cflags, <span class="stringliteral">'MY_CFLAGS_%s'</span> % configname)
<a name="l00469"></a>00469 
<a name="l00470"></a>00470       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#93de12c6d9b1aa90c3f3a8b0bfc1fffa">WriteList</a>(config.get(<span class="stringliteral">'defines'</span>), <span class="stringliteral">'MY_DEFS_%s'</span> % configname,
<a name="l00471"></a>00471                      prefix=<span class="stringliteral">'-D'</span>, quoter=make.EscapeCppDefine)
<a name="l00472"></a>00472 
<a name="l00473"></a>00473       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'\n# Include paths placed before CFLAGS/CPPFLAGS'</span>)
<a name="l00474"></a>00474       includes = list(config.get(<span class="stringliteral">'include_dirs'</span>, []))
<a name="l00475"></a>00475       includes.extend(extracted_includes)
<a name="l00476"></a>00476       includes = map(Sourceify, map(self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#a58e8277df9571779e5a5ff7951c5022">LocalPathify</a>, includes))
<a name="l00477"></a>00477       includes = self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#1c2f49d1ce981cd03bd461de6f14b8f0">NormalizeIncludePaths</a>(includes)
<a name="l00478"></a>00478       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#93de12c6d9b1aa90c3f3a8b0bfc1fffa">WriteList</a>(includes, <span class="stringliteral">'LOCAL_C_INCLUDES_%s'</span> % configname)
<a name="l00479"></a>00479 
<a name="l00480"></a>00480       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'\n# Flags passed to only C++ (and not C) files.'</span>)
<a name="l00481"></a>00481       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#93de12c6d9b1aa90c3f3a8b0bfc1fffa">WriteList</a>(config.get(<span class="stringliteral">'cflags_cc'</span>), <span class="stringliteral">'LOCAL_CPPFLAGS_%s'</span> % configname)
<a name="l00482"></a>00482 
<a name="l00483"></a>00483     self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'\nLOCAL_CFLAGS := $(MY_CFLAGS_$(GYP_CONFIGURATION)) '</span>
<a name="l00484"></a>00484                  <span class="stringliteral">'$(MY_DEFS_$(GYP_CONFIGURATION))'</span>)
<a name="l00485"></a>00485     <span class="comment"># Undefine ANDROID for host modules</span>
<a name="l00486"></a>00486     <span class="comment"># TODO: the source code should not use macro ANDROID to tell if it's host</span>
<a name="l00487"></a>00487     <span class="comment"># or target module.</span>
<a name="l00488"></a>00488     <span class="keywordflow">if</span> self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">toolset</a> == <span class="stringliteral">'host'</span>:
<a name="l00489"></a>00489       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'# Undefine ANDROID for host modules'</span>)
<a name="l00490"></a>00490       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'LOCAL_CFLAGS += -UANDROID'</span>)
<a name="l00491"></a>00491     self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'LOCAL_C_INCLUDES := $(GYP_COPIED_SOURCE_ORIGIN_DIRS) '</span>
<a name="l00492"></a>00492                                      <span class="stringliteral">'$(LOCAL_C_INCLUDES_$(GYP_CONFIGURATION))'</span>)
<a name="l00493"></a>00493     self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'LOCAL_CPPFLAGS := $(LOCAL_CPPFLAGS_$(GYP_CONFIGURATION))'</span>)
<a name="l00494"></a>00494     <span class="comment"># Android uses separate flags for assembly file invocations, but gyp expects</span>
<a name="l00495"></a>00495     <span class="comment"># the same CFLAGS to be applied:</span>
<a name="l00496"></a>00496     self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'LOCAL_ASFLAGS := $(LOCAL_CFLAGS)'</span>)
<a name="l00497"></a>00497 
<a name="l00498"></a>00498 
<a name="l00499"></a><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#7c3bf79a4bd2f19944fc222c6bcfffc0">00499</a>   <span class="keyword">def </span><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#7c3bf79a4bd2f19944fc222c6bcfffc0">WriteSources</a>(self, spec, configs, extra_sources):
<a name="l00500"></a>00500     <span class="stringliteral">"""Write Makefile code for any 'sources' from the gyp input.</span>
<a name="l00501"></a>00501 <span class="stringliteral">    These are source files necessary to build the current target.</span>
<a name="l00502"></a>00502 <span class="stringliteral">    We need to handle shared_intermediate directory source files as</span>
<a name="l00503"></a>00503 <span class="stringliteral">    a special case by copying them to the intermediate directory and</span>
<a name="l00504"></a>00504 <span class="stringliteral">    treating them as a genereated sources. Otherwise the Android build</span>
<a name="l00505"></a>00505 <span class="stringliteral">    rules won't pick them up.</span>
<a name="l00506"></a>00506 <span class="stringliteral"></span>
<a name="l00507"></a>00507 <span class="stringliteral">    Args:</span>
<a name="l00508"></a>00508 <span class="stringliteral">      spec, configs: input from gyp.</span>
<a name="l00509"></a>00509 <span class="stringliteral">      extra_sources: Sources generated from Actions or Rules.</span>
<a name="l00510"></a>00510 <span class="stringliteral">    """</span>
<a name="l00511"></a>00511     sources = filter(make.Compilable, spec.get(<span class="stringliteral">'sources'</span>, []))
<a name="l00512"></a>00512     generated_not_sources = [x <span class="keywordflow">for</span> x <span class="keywordflow">in</span> extra_sources <span class="keywordflow">if</span> <span class="keywordflow">not</span> make.Compilable(x)]
<a name="l00513"></a>00513     extra_sources = filter(make.Compilable, extra_sources)
<a name="l00514"></a>00514 
<a name="l00515"></a>00515     <span class="comment"># Determine and output the C++ extension used by these sources.</span>
<a name="l00516"></a>00516     <span class="comment"># We simply find the first C++ file and use that extension.</span>
<a name="l00517"></a>00517     all_sources = sources + extra_sources
<a name="l00518"></a>00518     local_cpp_extension = <span class="stringliteral">'.cpp'</span>
<a name="l00519"></a>00519     <span class="keywordflow">for</span> source <span class="keywordflow">in</span> all_sources:
<a name="l00520"></a>00520       (root, ext) = os.path.splitext(source)
<a name="l00521"></a>00521       <span class="keywordflow">if</span> IsCPPExtension(ext):
<a name="l00522"></a>00522         local_cpp_extension = ext
<a name="l00523"></a>00523         <span class="keywordflow">break</span>
<a name="l00524"></a>00524     <span class="keywordflow">if</span> local_cpp_extension != <span class="stringliteral">'.cpp'</span>:
<a name="l00525"></a>00525       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'LOCAL_CPP_EXTENSION := %s'</span> % local_cpp_extension)
<a name="l00526"></a>00526 
<a name="l00527"></a>00527     <span class="comment"># We need to move any non-generated sources that are coming from the</span>
<a name="l00528"></a>00528     <span class="comment"># shared intermediate directory out of LOCAL_SRC_FILES and put them</span>
<a name="l00529"></a>00529     <span class="comment"># into LOCAL_GENERATED_SOURCES. We also need to move over any C++ files</span>
<a name="l00530"></a>00530     <span class="comment"># that don't match our local_cpp_extension, since Android will only</span>
<a name="l00531"></a>00531     <span class="comment"># generate Makefile rules for a single LOCAL_CPP_EXTENSION.</span>
<a name="l00532"></a>00532     local_files = []
<a name="l00533"></a>00533     <span class="keywordflow">for</span> source <span class="keywordflow">in</span> sources:
<a name="l00534"></a>00534       (root, ext) = os.path.splitext(source)
<a name="l00535"></a>00535       <span class="keywordflow">if</span> <span class="stringliteral">'$(gyp_shared_intermediate_dir)'</span> <span class="keywordflow">in</span> source:
<a name="l00536"></a>00536         extra_sources.append(source)
<a name="l00537"></a>00537       <span class="keywordflow">elif</span> <span class="stringliteral">'$(gyp_intermediate_dir)'</span> <span class="keywordflow">in</span> source:
<a name="l00538"></a>00538         extra_sources.append(source)
<a name="l00539"></a>00539       <span class="keywordflow">elif</span> IsCPPExtension(ext) <span class="keywordflow">and</span> ext != local_cpp_extension:
<a name="l00540"></a>00540         extra_sources.append(source)
<a name="l00541"></a>00541       <span class="keywordflow">else</span>:
<a name="l00542"></a>00542         local_files.append(os.path.normpath(os.path.join(self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#a28dc103258589d9cb421197fe2de90b">path</a>, source)))
<a name="l00543"></a>00543 
<a name="l00544"></a>00544     <span class="comment"># For any generated source, if it is coming from the shared intermediate</span>
<a name="l00545"></a>00545     <span class="comment"># directory then we add a Make rule to copy them to the local intermediate</span>
<a name="l00546"></a>00546     <span class="comment"># directory first. This is because the Android LOCAL_GENERATED_SOURCES</span>
<a name="l00547"></a>00547     <span class="comment"># must be in the local module intermediate directory for the compile rules</span>
<a name="l00548"></a>00548     <span class="comment"># to work properly. If the file has the wrong C++ extension, then we add</span>
<a name="l00549"></a>00549     <span class="comment"># a rule to copy that to intermediates and use the new version.</span>
<a name="l00550"></a>00550     final_generated_sources = []
<a name="l00551"></a>00551     <span class="comment"># If a source file gets copied, we still need to add the orginal source</span>
<a name="l00552"></a>00552     <span class="comment"># directory as header search path, for GCC searches headers in the</span>
<a name="l00553"></a>00553     <span class="comment"># directory that contains the source file by default.</span>
<a name="l00554"></a>00554     origin_src_dirs = []
<a name="l00555"></a>00555     <span class="keywordflow">for</span> source <span class="keywordflow">in</span> extra_sources:
<a name="l00556"></a>00556       local_file = source
<a name="l00557"></a>00557       <span class="keywordflow">if</span> <span class="keywordflow">not</span> <span class="stringliteral">'$(gyp_intermediate_dir)/'</span> <span class="keywordflow">in</span> local_file:
<a name="l00558"></a>00558         basename = os.path.basename(local_file)
<a name="l00559"></a>00559         local_file = <span class="stringliteral">'$(gyp_intermediate_dir)/'</span> + basename
<a name="l00560"></a>00560       (root, ext) = os.path.splitext(local_file)
<a name="l00561"></a>00561       <span class="keywordflow">if</span> IsCPPExtension(ext) <span class="keywordflow">and</span> ext != local_cpp_extension:
<a name="l00562"></a>00562         local_file = root + local_cpp_extension
<a name="l00563"></a>00563       <span class="keywordflow">if</span> local_file != source:
<a name="l00564"></a>00564         self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'%s: %s'</span> % (local_file, self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#a58e8277df9571779e5a5ff7951c5022">LocalPathify</a>(source)))
<a name="l00565"></a>00565         self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'\tmkdir -p $(@D); cp $&lt; $@'</span>)
<a name="l00566"></a>00566         origin_src_dirs.append(os.path.dirname(source))
<a name="l00567"></a>00567       final_generated_sources.append(local_file)
<a name="l00568"></a>00568 
<a name="l00569"></a>00569     <span class="comment"># We add back in all of the non-compilable stuff to make sure that the</span>
<a name="l00570"></a>00570     <span class="comment"># make rules have dependencies on them.</span>
<a name="l00571"></a>00571     final_generated_sources.extend(generated_not_sources)
<a name="l00572"></a>00572     self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#93de12c6d9b1aa90c3f3a8b0bfc1fffa">WriteList</a>(final_generated_sources, <span class="stringliteral">'LOCAL_GENERATED_SOURCES'</span>)
<a name="l00573"></a>00573 
<a name="l00574"></a>00574     origin_src_dirs = gyp.common.uniquer(origin_src_dirs)
<a name="l00575"></a>00575     origin_src_dirs = map(Sourceify, map(self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#a58e8277df9571779e5a5ff7951c5022">LocalPathify</a>, origin_src_dirs))
<a name="l00576"></a>00576     self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#93de12c6d9b1aa90c3f3a8b0bfc1fffa">WriteList</a>(origin_src_dirs, <span class="stringliteral">'GYP_COPIED_SOURCE_ORIGIN_DIRS'</span>)
<a name="l00577"></a>00577 
<a name="l00578"></a>00578     self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#93de12c6d9b1aa90c3f3a8b0bfc1fffa">WriteList</a>(local_files, <span class="stringliteral">'LOCAL_SRC_FILES'</span>)
<a name="l00579"></a>00579 
<a name="l00580"></a>00580     <span class="comment"># Write out the flags used to compile the source; this must be done last</span>
<a name="l00581"></a>00581     <span class="comment"># so that GYP_COPIED_SOURCE_ORIGIN_DIRS can be used as an include path.</span>
<a name="l00582"></a>00582     self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#42911f7172f605283acf6b4430e0865c">WriteSourceFlags</a>(spec, configs)
<a name="l00583"></a>00583 
<a name="l00584"></a>00584 
<a name="l00585"></a><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#1ec74e7aef483c8ee80dc2134c44c49c">00585</a>   <span class="keyword">def </span><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#1ec74e7aef483c8ee80dc2134c44c49c">ComputeAndroidModule</a>(self, spec):
<a name="l00586"></a>00586     <span class="stringliteral">"""Return the Android module name used for a gyp spec.</span>
<a name="l00587"></a>00587 <span class="stringliteral"></span>
<a name="l00588"></a>00588 <span class="stringliteral">    We use the complete qualified target name to avoid collisions between</span>
<a name="l00589"></a>00589 <span class="stringliteral">    duplicate targets in different directories. We also add a suffix to</span>
<a name="l00590"></a>00590 <span class="stringliteral">    distinguish gyp-generated module names.</span>
<a name="l00591"></a>00591 <span class="stringliteral">    """</span>
<a name="l00592"></a>00592 
<a name="l00593"></a>00593     <span class="keywordflow">if</span> int(spec.get(<span class="stringliteral">'android_unmangled_name'</span>, 0)):
<a name="l00594"></a>00594       <span class="keyword">assert</span> self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> != <span class="stringliteral">'shared_library'</span> <span class="keywordflow">or</span> self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>.startswith(<span class="stringliteral">'lib'</span>)
<a name="l00595"></a>00595       <span class="keywordflow">return</span> self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>
<a name="l00596"></a>00596 
<a name="l00597"></a>00597     <span class="keywordflow">if</span> self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> == <span class="stringliteral">'shared_library'</span>:
<a name="l00598"></a>00598       <span class="comment"># For reasons of convention, the Android build system requires that all</span>
<a name="l00599"></a>00599       <span class="comment"># shared library modules are named 'libfoo' when generating -l flags.</span>
<a name="l00600"></a>00600       prefix = <span class="stringliteral">'lib_'</span>
<a name="l00601"></a>00601     <span class="keywordflow">else</span>:
<a name="l00602"></a>00602       prefix = <span class="stringliteral">''</span>
<a name="l00603"></a>00603 
<a name="l00604"></a>00604     <span class="keywordflow">if</span> spec[<span class="stringliteral">'toolset'</span>] == <span class="stringliteral">'host'</span>:
<a name="l00605"></a>00605       suffix = <span class="stringliteral">'_$(TARGET_$(GYP_VAR_PREFIX)ARCH)_host_gyp'</span>
<a name="l00606"></a>00606     <span class="keywordflow">else</span>:
<a name="l00607"></a>00607       suffix = <span class="stringliteral">'_gyp'</span>
<a name="l00608"></a>00608 
<a name="l00609"></a>00609     <span class="keywordflow">if</span> self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#a28dc103258589d9cb421197fe2de90b">path</a>:
<a name="l00610"></a>00610       middle = make.StringToMakefileVariable(<span class="stringliteral">'%s_%s'</span> % (self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#a28dc103258589d9cb421197fe2de90b">path</a>, self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>))
<a name="l00611"></a>00611     <span class="keywordflow">else</span>:
<a name="l00612"></a>00612       middle = make.StringToMakefileVariable(self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>)
<a name="l00613"></a>00613 
<a name="l00614"></a>00614     <span class="keywordflow">return</span> <span class="stringliteral">''</span>.join([prefix, middle, suffix])
<a name="l00615"></a>00615 
<a name="l00616"></a>00616 
<a name="l00617"></a><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#1e78a00e0037943652f8f1cf42ecc99d">00617</a>   <span class="keyword">def </span><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#1e78a00e0037943652f8f1cf42ecc99d">ComputeOutputParts</a>(self, spec):
<a name="l00618"></a>00618     <span class="stringliteral">"""Return the 'output basename' of a gyp spec, split into filename + ext.</span>
<a name="l00619"></a>00619 <span class="stringliteral"></span>
<a name="l00620"></a>00620 <span class="stringliteral">    Android libraries must be named the same thing as their module name,</span>
<a name="l00621"></a>00621 <span class="stringliteral">    otherwise the linker can't find them, so product_name and so on must be</span>
<a name="l00622"></a>00622 <span class="stringliteral">    ignored if we are building a library, and the "lib" prepending is</span>
<a name="l00623"></a>00623 <span class="stringliteral">    not done for Android.</span>
<a name="l00624"></a>00624 <span class="stringliteral">    """</span>
<a name="l00625"></a>00625     <span class="keyword">assert</span> self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> != <span class="stringliteral">'loadable_module'</span> <span class="comment"># TODO: not supported?</span>
<a name="l00626"></a>00626 
<a name="l00627"></a>00627     target = spec[<span class="stringliteral">'target_name'</span>]
<a name="l00628"></a>00628     target_prefix = <span class="stringliteral">''</span>
<a name="l00629"></a>00629     target_ext = <span class="stringliteral">''</span>
<a name="l00630"></a>00630     <span class="keywordflow">if</span> self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> == <span class="stringliteral">'static_library'</span>:
<a name="l00631"></a>00631       target = self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#1ec74e7aef483c8ee80dc2134c44c49c">ComputeAndroidModule</a>(spec)
<a name="l00632"></a>00632       target_ext = <span class="stringliteral">'.a'</span>
<a name="l00633"></a>00633     <span class="keywordflow">elif</span> self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> == <span class="stringliteral">'shared_library'</span>:
<a name="l00634"></a>00634       target = self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#1ec74e7aef483c8ee80dc2134c44c49c">ComputeAndroidModule</a>(spec)
<a name="l00635"></a>00635       target_ext = <span class="stringliteral">'.so'</span>
<a name="l00636"></a>00636     <span class="keywordflow">elif</span> self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> == <span class="stringliteral">'none'</span>:
<a name="l00637"></a>00637       target_ext = <span class="stringliteral">'.stamp'</span>
<a name="l00638"></a>00638     <span class="keywordflow">elif</span> self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> != <span class="stringliteral">'executable'</span>:
<a name="l00639"></a>00639       <span class="keywordflow">print</span> (<span class="stringliteral">"ERROR: What output file should be generated?"</span>,
<a name="l00640"></a>00640              <span class="stringliteral">"type"</span>, self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a>, <span class="stringliteral">"target"</span>, target)
<a name="l00641"></a>00641 
<a name="l00642"></a>00642     <span class="keywordflow">if</span> self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> != <span class="stringliteral">'static_library'</span> <span class="keywordflow">and</span> self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> != <span class="stringliteral">'shared_library'</span>:
<a name="l00643"></a>00643       target_prefix = spec.get(<span class="stringliteral">'product_prefix'</span>, target_prefix)
<a name="l00644"></a>00644       target = spec.get(<span class="stringliteral">'product_name'</span>, target)
<a name="l00645"></a>00645       product_ext = spec.get(<span class="stringliteral">'product_extension'</span>)
<a name="l00646"></a>00646       <span class="keywordflow">if</span> product_ext:
<a name="l00647"></a>00647         target_ext = <span class="stringliteral">'.'</span> + product_ext
<a name="l00648"></a>00648 
<a name="l00649"></a>00649     target_stem = target_prefix + target
<a name="l00650"></a>00650     <span class="keywordflow">return</span> (target_stem, target_ext)
<a name="l00651"></a>00651 
<a name="l00652"></a>00652 
<a name="l00653"></a><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#467201aad2a9154c6557a43e0f6080b1">00653</a>   <span class="keyword">def </span><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#467201aad2a9154c6557a43e0f6080b1">ComputeOutputBasename</a>(self, spec):
<a name="l00654"></a>00654     <span class="stringliteral">"""Return the 'output basename' of a gyp spec.</span>
<a name="l00655"></a>00655 <span class="stringliteral"></span>
<a name="l00656"></a>00656 <span class="stringliteral">    E.g., the loadable module 'foobar' in directory 'baz' will produce</span>
<a name="l00657"></a>00657 <span class="stringliteral">      'libfoobar.so'</span>
<a name="l00658"></a>00658 <span class="stringliteral">    """</span>
<a name="l00659"></a>00659     <span class="keywordflow">return</span> <span class="stringliteral">''</span>.join(self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#1e78a00e0037943652f8f1cf42ecc99d">ComputeOutputParts</a>(spec))
<a name="l00660"></a>00660 
<a name="l00661"></a>00661 
<a name="l00662"></a><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#097c9e2913bffe213c7a56b1b1508997">00662</a>   <span class="keyword">def </span><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#097c9e2913bffe213c7a56b1b1508997">ComputeOutput</a>(self, spec):
<a name="l00663"></a>00663     <span class="stringliteral">"""Return the 'output' (full output path) of a gyp spec.</span>
<a name="l00664"></a>00664 <span class="stringliteral"></span>
<a name="l00665"></a>00665 <span class="stringliteral">    E.g., the loadable module 'foobar' in directory 'baz' will produce</span>
<a name="l00666"></a>00666 <span class="stringliteral">      '$(obj)/baz/libfoobar.so'</span>
<a name="l00667"></a>00667 <span class="stringliteral">    """</span>
<a name="l00668"></a>00668     <span class="keywordflow">if</span> self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> == <span class="stringliteral">'executable'</span>:
<a name="l00669"></a>00669       <span class="comment"># We install host executables into shared_intermediate_dir so they can be</span>
<a name="l00670"></a>00670       <span class="comment"># run by gyp rules that refer to PRODUCT_DIR.</span>
<a name="l00671"></a>00671       path = <span class="stringliteral">'$(gyp_shared_intermediate_dir)'</span>
<a name="l00672"></a>00672     <span class="keywordflow">elif</span> self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> == <span class="stringliteral">'shared_library'</span>:
<a name="l00673"></a>00673       <span class="keywordflow">if</span> self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">toolset</a> == <span class="stringliteral">'host'</span>:
<a name="l00674"></a>00674         path = <span class="stringliteral">'$($(GYP_HOST_VAR_PREFIX)HOST_OUT_INTERMEDIATE_LIBRARIES)'</span>
<a name="l00675"></a>00675       <span class="keywordflow">else</span>:
<a name="l00676"></a>00676         path = <span class="stringliteral">'$($(GYP_VAR_PREFIX)TARGET_OUT_INTERMEDIATE_LIBRARIES)'</span>
<a name="l00677"></a>00677     <span class="keywordflow">else</span>:
<a name="l00678"></a>00678       <span class="comment"># Other targets just get built into their intermediate dir.</span>
<a name="l00679"></a>00679       <span class="keywordflow">if</span> self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">toolset</a> == <span class="stringliteral">'host'</span>:
<a name="l00680"></a>00680         path = (<span class="stringliteral">'$(call intermediates-dir-for,%s,%s,true,,'</span>
<a name="l00681"></a>00681                 <span class="stringliteral">'$(GYP_HOST_VAR_PREFIX))'</span> % (self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#3754838b5e2745870d9337a7e8d0eb85">android_class</a>,
<a name="l00682"></a>00682                                              self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#22de76d3cfb57c7998f2b8e52128163c">android_module</a>))
<a name="l00683"></a>00683       <span class="keywordflow">else</span>:
<a name="l00684"></a>00684         path = (<span class="stringliteral">'$(call intermediates-dir-for,%s,%s,,,$(GYP_VAR_PREFIX))'</span>
<a name="l00685"></a>00685                 % (self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#3754838b5e2745870d9337a7e8d0eb85">android_class</a>, self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#22de76d3cfb57c7998f2b8e52128163c">android_module</a>))
<a name="l00686"></a>00686 
<a name="l00687"></a>00687     <span class="keyword">assert</span> spec.get(<span class="stringliteral">'product_dir'</span>) <span class="keywordflow">is</span> <span class="keywordtype">None</span> <span class="comment"># TODO: not supported?</span>
<a name="l00688"></a>00688     <span class="keywordflow">return</span> os.path.join(path, self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#467201aad2a9154c6557a43e0f6080b1">ComputeOutputBasename</a>(spec))
<a name="l00689"></a>00689 
<a name="l00690"></a><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#1c2f49d1ce981cd03bd461de6f14b8f0">00690</a>   <span class="keyword">def </span><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#1c2f49d1ce981cd03bd461de6f14b8f0">NormalizeIncludePaths</a>(self, include_paths):
<a name="l00691"></a>00691     <span class="stringliteral">""" Normalize include_paths.</span>
<a name="l00692"></a>00692 <span class="stringliteral">    Convert absolute paths to relative to the Android top directory.</span>
<a name="l00693"></a>00693 <span class="stringliteral"></span>
<a name="l00694"></a>00694 <span class="stringliteral">    Args:</span>
<a name="l00695"></a>00695 <span class="stringliteral">      include_paths: A list of unprocessed include paths.</span>
<a name="l00696"></a>00696 <span class="stringliteral">    Returns:</span>
<a name="l00697"></a>00697 <span class="stringliteral">      A list of normalized include paths.</span>
<a name="l00698"></a>00698 <span class="stringliteral">    """</span>
<a name="l00699"></a>00699     normalized = []
<a name="l00700"></a>00700     <span class="keywordflow">for</span> path <span class="keywordflow">in</span> include_paths:
<a name="l00701"></a>00701       <span class="keywordflow">if</span> path[0] == <span class="stringliteral">'/'</span>:
<a name="l00702"></a>00702         path = gyp.common.RelativePath(path, self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#a89a233ee068fdf968616b761ee37ca4">android_top_dir</a>)
<a name="l00703"></a>00703       normalized.append(path)
<a name="l00704"></a>00704     <span class="keywordflow">return</span> normalized
<a name="l00705"></a>00705 
<a name="l00706"></a><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#1494ad5cf0f0409e2a2afd9b9c859eaa">00706</a>   <span class="keyword">def </span><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#1494ad5cf0f0409e2a2afd9b9c859eaa">ExtractIncludesFromCFlags</a>(self, cflags):
<a name="l00707"></a>00707     <span class="stringliteral">"""Extract includes "-I..." out from cflags</span>
<a name="l00708"></a>00708 <span class="stringliteral"></span>
<a name="l00709"></a>00709 <span class="stringliteral">    Args:</span>
<a name="l00710"></a>00710 <span class="stringliteral">      cflags: A list of compiler flags, which may be mixed with "-I.."</span>
<a name="l00711"></a>00711 <span class="stringliteral">    Returns:</span>
<a name="l00712"></a>00712 <span class="stringliteral">      A tuple of lists: (clean_clfags, include_paths). "-I.." is trimmed.</span>
<a name="l00713"></a>00713 <span class="stringliteral">    """</span>
<a name="l00714"></a>00714     clean_cflags = []
<a name="l00715"></a>00715     include_paths = []
<a name="l00716"></a>00716     <span class="keywordflow">for</span> flag <span class="keywordflow">in</span> cflags:
<a name="l00717"></a>00717       <span class="keywordflow">if</span> flag.startswith(<span class="stringliteral">'-I'</span>):
<a name="l00718"></a>00718         include_paths.append(flag[2:])
<a name="l00719"></a>00719       <span class="keywordflow">else</span>:
<a name="l00720"></a>00720         clean_cflags.append(flag)
<a name="l00721"></a>00721 
<a name="l00722"></a>00722     <span class="keywordflow">return</span> (clean_cflags, include_paths)
<a name="l00723"></a>00723 
<a name="l00724"></a><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#5f994582604be8173f38f7c20882c0c1">00724</a>   <span class="keyword">def </span><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#5f994582604be8173f38f7c20882c0c1">FilterLibraries</a>(self, libraries):
<a name="l00725"></a>00725     <span class="stringliteral">"""Filter the 'libraries' key to separate things that shouldn't be ldflags.</span>
<a name="l00726"></a>00726 <span class="stringliteral"></span>
<a name="l00727"></a>00727 <span class="stringliteral">    Library entries that look like filenames should be converted to android</span>
<a name="l00728"></a>00728 <span class="stringliteral">    module names instead of being passed to the linker as flags.</span>
<a name="l00729"></a>00729 <span class="stringliteral"></span>
<a name="l00730"></a>00730 <span class="stringliteral">    Args:</span>
<a name="l00731"></a>00731 <span class="stringliteral">      libraries: the value of spec.get('libraries')</span>
<a name="l00732"></a>00732 <span class="stringliteral">    Returns:</span>
<a name="l00733"></a>00733 <span class="stringliteral">      A tuple (static_lib_modules, dynamic_lib_modules, ldflags)</span>
<a name="l00734"></a>00734 <span class="stringliteral">    """</span>
<a name="l00735"></a>00735     static_lib_modules = []
<a name="l00736"></a>00736     dynamic_lib_modules = []
<a name="l00737"></a>00737     ldflags = []
<a name="l00738"></a>00738     <span class="keywordflow">for</span> libs <span class="keywordflow">in</span> libraries:
<a name="l00739"></a>00739       <span class="comment"># Libs can have multiple words.</span>
<a name="l00740"></a>00740       <span class="keywordflow">for</span> lib <span class="keywordflow">in</span> libs.split():
<a name="l00741"></a>00741         <span class="comment"># Filter the system libraries, which are added by default by the Android</span>
<a name="l00742"></a>00742         <span class="comment"># build system.</span>
<a name="l00743"></a>00743         <span class="keywordflow">if</span> (lib == <span class="stringliteral">'-lc'</span> <span class="keywordflow">or</span> lib == <span class="stringliteral">'-lstdc++'</span> <span class="keywordflow">or</span> lib == <span class="stringliteral">'-lm'</span> <span class="keywordflow">or</span>
<a name="l00744"></a>00744             lib.endswith(<span class="stringliteral">'libgcc.a'</span>)):
<a name="l00745"></a>00745           <span class="keywordflow">continue</span>
<a name="l00746"></a>00746         match = re.search(<span class="stringliteral">r'([^/]+)\.a$'</span>, lib)
<a name="l00747"></a>00747         <span class="keywordflow">if</span> match:
<a name="l00748"></a>00748           static_lib_modules.append(match.group(1))
<a name="l00749"></a>00749           <span class="keywordflow">continue</span>
<a name="l00750"></a>00750         match = re.search(<span class="stringliteral">r'([^/]+)\.so$'</span>, lib)
<a name="l00751"></a>00751         <span class="keywordflow">if</span> match:
<a name="l00752"></a>00752           dynamic_lib_modules.append(match.group(1))
<a name="l00753"></a>00753           <span class="keywordflow">continue</span>
<a name="l00754"></a>00754         <span class="keywordflow">if</span> lib.startswith(<span class="stringliteral">'-l'</span>):
<a name="l00755"></a>00755           ldflags.append(lib)
<a name="l00756"></a>00756     <span class="keywordflow">return</span> (static_lib_modules, dynamic_lib_modules, ldflags)
<a name="l00757"></a>00757 
<a name="l00758"></a>00758 
<a name="l00759"></a><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#d5018dacf3e72356c231736611d30af0">00759</a>   <span class="keyword">def </span><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#d5018dacf3e72356c231736611d30af0">ComputeDeps</a>(self, spec):
<a name="l00760"></a>00760     <span class="stringliteral">"""Compute the dependencies of a gyp spec.</span>
<a name="l00761"></a>00761 <span class="stringliteral"></span>
<a name="l00762"></a>00762 <span class="stringliteral">    Returns a tuple (deps, link_deps), where each is a list of</span>
<a name="l00763"></a>00763 <span class="stringliteral">    filenames that will need to be put in front of make for either</span>
<a name="l00764"></a>00764 <span class="stringliteral">    building (deps) or linking (link_deps).</span>
<a name="l00765"></a>00765 <span class="stringliteral">    """</span>
<a name="l00766"></a>00766     deps = []
<a name="l00767"></a>00767     link_deps = []
<a name="l00768"></a>00768     <span class="keywordflow">if</span> <span class="stringliteral">'dependencies'</span> <span class="keywordflow">in</span> spec:
<a name="l00769"></a>00769       deps.extend([target_outputs[dep] <span class="keywordflow">for</span> dep <span class="keywordflow">in</span> spec[<span class="stringliteral">'dependencies'</span>]
<a name="l00770"></a>00770                    <span class="keywordflow">if</span> target_outputs[dep]])
<a name="l00771"></a>00771       <span class="keywordflow">for</span> dep <span class="keywordflow">in</span> spec[<span class="stringliteral">'dependencies'</span>]:
<a name="l00772"></a>00772         <span class="keywordflow">if</span> dep <span class="keywordflow">in</span> target_link_deps:
<a name="l00773"></a>00773           link_deps.append(target_link_deps[dep])
<a name="l00774"></a>00774       deps.extend(link_deps)
<a name="l00775"></a>00775     <span class="keywordflow">return</span> (gyp.common.uniquer(deps), gyp.common.uniquer(link_deps))
<a name="l00776"></a>00776 
<a name="l00777"></a>00777 
<a name="l00778"></a><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#3808a7bd751d109e4f8e27559b48c22a">00778</a>   <span class="keyword">def </span><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#3808a7bd751d109e4f8e27559b48c22a">WriteTargetFlags</a>(self, spec, configs, link_deps):
<a name="l00779"></a>00779     <span class="stringliteral">"""Write Makefile code to specify the link flags and library dependencies.</span>
<a name="l00780"></a>00780 <span class="stringliteral"></span>
<a name="l00781"></a>00781 <span class="stringliteral">    spec, configs: input from gyp.</span>
<a name="l00782"></a>00782 <span class="stringliteral">    link_deps: link dependency list; see ComputeDeps()</span>
<a name="l00783"></a>00783 <span class="stringliteral">    """</span>
<a name="l00784"></a>00784     <span class="comment"># Libraries (i.e. -lfoo)</span>
<a name="l00785"></a>00785     <span class="comment"># These must be included even for static libraries as some of them provide</span>
<a name="l00786"></a>00786     <span class="comment"># implicit include paths through the build system.</span>
<a name="l00787"></a>00787     libraries = gyp.common.uniquer(spec.get(<span class="stringliteral">'libraries'</span>, []))
<a name="l00788"></a>00788     static_libs, dynamic_libs, ldflags_libs = self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#5f994582604be8173f38f7c20882c0c1">FilterLibraries</a>(libraries)
<a name="l00789"></a>00789 
<a name="l00790"></a>00790     <span class="keywordflow">if</span> self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> != <span class="stringliteral">'static_library'</span>:
<a name="l00791"></a>00791       <span class="keywordflow">for</span> configname, config <span class="keywordflow">in</span> sorted(configs.iteritems()):
<a name="l00792"></a>00792         ldflags = list(config.get(<span class="stringliteral">'ldflags'</span>, []))
<a name="l00793"></a>00793         self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">''</span>)
<a name="l00794"></a>00794         self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#93de12c6d9b1aa90c3f3a8b0bfc1fffa">WriteList</a>(ldflags, <span class="stringliteral">'LOCAL_LDFLAGS_%s'</span> % configname)
<a name="l00795"></a>00795       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#93de12c6d9b1aa90c3f3a8b0bfc1fffa">WriteList</a>(ldflags_libs, <span class="stringliteral">'LOCAL_GYP_LIBS'</span>)
<a name="l00796"></a>00796       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'LOCAL_LDFLAGS := $(LOCAL_LDFLAGS_$(GYP_CONFIGURATION)) '</span>
<a name="l00797"></a>00797                    <span class="stringliteral">'$(LOCAL_GYP_LIBS)'</span>)
<a name="l00798"></a>00798 
<a name="l00799"></a>00799     <span class="comment"># Link dependencies (i.e. other gyp targets this target depends on)</span>
<a name="l00800"></a>00800     <span class="comment"># These need not be included for static libraries as within the gyp build</span>
<a name="l00801"></a>00801     <span class="comment"># we do not use the implicit include path mechanism.</span>
<a name="l00802"></a>00802     <span class="keywordflow">if</span> self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> != <span class="stringliteral">'static_library'</span>:
<a name="l00803"></a>00803       static_link_deps = [x[1] <span class="keywordflow">for</span> x <span class="keywordflow">in</span> link_deps <span class="keywordflow">if</span> x[0] == <span class="stringliteral">'static'</span>]
<a name="l00804"></a>00804       shared_link_deps = [x[1] <span class="keywordflow">for</span> x <span class="keywordflow">in</span> link_deps <span class="keywordflow">if</span> x[0] == <span class="stringliteral">'shared'</span>]
<a name="l00805"></a>00805     <span class="keywordflow">else</span>:
<a name="l00806"></a>00806       static_link_deps = []
<a name="l00807"></a>00807       shared_link_deps = []
<a name="l00808"></a>00808 
<a name="l00809"></a>00809     <span class="comment"># Only write the lists if they are non-empty.</span>
<a name="l00810"></a>00810     <span class="keywordflow">if</span> static_libs <span class="keywordflow">or</span> static_link_deps:
<a name="l00811"></a>00811       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">''</span>)
<a name="l00812"></a>00812       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#93de12c6d9b1aa90c3f3a8b0bfc1fffa">WriteList</a>(static_libs + static_link_deps,
<a name="l00813"></a>00813                      <span class="stringliteral">'LOCAL_STATIC_LIBRARIES'</span>)
<a name="l00814"></a>00814       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'# Enable grouping to fix circular references'</span>)
<a name="l00815"></a>00815       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'LOCAL_GROUP_STATIC_LIBRARIES := true'</span>)
<a name="l00816"></a>00816     <span class="keywordflow">if</span> dynamic_libs <span class="keywordflow">or</span> shared_link_deps:
<a name="l00817"></a>00817       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">''</span>)
<a name="l00818"></a>00818       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#93de12c6d9b1aa90c3f3a8b0bfc1fffa">WriteList</a>(dynamic_libs + shared_link_deps,
<a name="l00819"></a>00819                      <span class="stringliteral">'LOCAL_SHARED_LIBRARIES'</span>)
<a name="l00820"></a>00820 
<a name="l00821"></a>00821 
<a name="l00822"></a><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#203d0a7515c00ce74d55f93e632eedfe">00822</a>   <span class="keyword">def </span><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#203d0a7515c00ce74d55f93e632eedfe">WriteTarget</a>(self, spec, configs, deps, link_deps, part_of_all,
<a name="l00823"></a>00823                   write_alias_target):
<a name="l00824"></a>00824     <span class="stringliteral">"""Write Makefile code to produce the final target of the gyp spec.</span>
<a name="l00825"></a>00825 <span class="stringliteral"></span>
<a name="l00826"></a>00826 <span class="stringliteral">    spec, configs: input from gyp.</span>
<a name="l00827"></a>00827 <span class="stringliteral">    deps, link_deps: dependency lists; see ComputeDeps()</span>
<a name="l00828"></a>00828 <span class="stringliteral">    part_of_all: flag indicating this target is part of 'all'</span>
<a name="l00829"></a>00829 <span class="stringliteral">    write_alias_target: flag indicating whether to create short aliases for this</span>
<a name="l00830"></a>00830 <span class="stringliteral">                        target</span>
<a name="l00831"></a>00831 <span class="stringliteral">    """</span>
<a name="l00832"></a>00832     self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'### Rules for final target.'</span>)
<a name="l00833"></a>00833 
<a name="l00834"></a>00834     <span class="keywordflow">if</span> self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> != <span class="stringliteral">'none'</span>:
<a name="l00835"></a>00835       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#3808a7bd751d109e4f8e27559b48c22a">WriteTargetFlags</a>(spec, configs, link_deps)
<a name="l00836"></a>00836 
<a name="l00837"></a>00837     settings = spec.get(<span class="stringliteral">'aosp_build_settings'</span>, {})
<a name="l00838"></a>00838     <span class="keywordflow">if</span> settings:
<a name="l00839"></a>00839       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'### Set directly by aosp_build_settings.'</span>)
<a name="l00840"></a>00840       <span class="keywordflow">for</span> k, v <span class="keywordflow">in</span> settings.iteritems():
<a name="l00841"></a>00841         <span class="keywordflow">if</span> isinstance(v, list):
<a name="l00842"></a>00842           self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#93de12c6d9b1aa90c3f3a8b0bfc1fffa">WriteList</a>(v, k)
<a name="l00843"></a>00843         <span class="keywordflow">else</span>:
<a name="l00844"></a>00844           self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'%s := %s'</span> % (k, make.QuoteIfNecessary(v)))
<a name="l00845"></a>00845       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">''</span>)
<a name="l00846"></a>00846 
<a name="l00847"></a>00847     <span class="comment"># Add to the set of targets which represent the gyp 'all' target. We use the</span>
<a name="l00848"></a>00848     <span class="comment"># name 'gyp_all_modules' as the Android build system doesn't allow the use</span>
<a name="l00849"></a>00849     <span class="comment"># of the Make target 'all' and because 'all_modules' is the equivalent of</span>
<a name="l00850"></a>00850     <span class="comment"># the Make target 'all' on Android.</span>
<a name="l00851"></a>00851     <span class="keywordflow">if</span> part_of_all <span class="keywordflow">and</span> write_alias_target:
<a name="l00852"></a>00852       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'# Add target alias to "gyp_all_modules" target.'</span>)
<a name="l00853"></a>00853       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'.PHONY: gyp_all_modules'</span>)
<a name="l00854"></a>00854       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'gyp_all_modules: %s'</span> % self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#22de76d3cfb57c7998f2b8e52128163c">android_module</a>)
<a name="l00855"></a>00855       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">''</span>)
<a name="l00856"></a>00856 
<a name="l00857"></a>00857     <span class="comment"># Add an alias from the gyp target name to the Android module name. This</span>
<a name="l00858"></a>00858     <span class="comment"># simplifies manual builds of the target, and is required by the test</span>
<a name="l00859"></a>00859     <span class="comment"># framework.</span>
<a name="l00860"></a>00860     <span class="keywordflow">if</span> self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a> != self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#22de76d3cfb57c7998f2b8e52128163c">android_module</a> <span class="keywordflow">and</span> write_alias_target:
<a name="l00861"></a>00861       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'# Alias gyp target name.'</span>)
<a name="l00862"></a>00862       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'.PHONY: %s'</span> % self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>)
<a name="l00863"></a>00863       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'%s: %s'</span> % (self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#5d2c023108742a1ce78ba9823c06ea35">target</a>, self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#22de76d3cfb57c7998f2b8e52128163c">android_module</a>))
<a name="l00864"></a>00864       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">''</span>)
<a name="l00865"></a>00865 
<a name="l00866"></a>00866     <span class="comment"># Add the command to trigger build of the target type depending</span>
<a name="l00867"></a>00867     <span class="comment"># on the toolset. Ex: BUILD_STATIC_LIBRARY vs. BUILD_HOST_STATIC_LIBRARY</span>
<a name="l00868"></a>00868     <span class="comment"># NOTE: This has to come last!</span>
<a name="l00869"></a>00869     modifier = <span class="stringliteral">''</span>
<a name="l00870"></a>00870     <span class="keywordflow">if</span> self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">toolset</a> == <span class="stringliteral">'host'</span>:
<a name="l00871"></a>00871       modifier = <span class="stringliteral">'HOST_'</span>
<a name="l00872"></a>00872     <span class="keywordflow">if</span> self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> == <span class="stringliteral">'static_library'</span>:
<a name="l00873"></a>00873       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'include $(BUILD_%sSTATIC_LIBRARY)'</span> % modifier)
<a name="l00874"></a>00874     <span class="keywordflow">elif</span> self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> == <span class="stringliteral">'shared_library'</span>:
<a name="l00875"></a>00875       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'LOCAL_PRELINK_MODULE := false'</span>)
<a name="l00876"></a>00876       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'include $(BUILD_%sSHARED_LIBRARY)'</span> % modifier)
<a name="l00877"></a>00877     <span class="keywordflow">elif</span> self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#7aead736a07eaf25623ad7bfa1f0ee2d">type</a> == <span class="stringliteral">'executable'</span>:
<a name="l00878"></a>00878       <span class="comment"># Executables are for build and test purposes only, so they're installed</span>
<a name="l00879"></a>00879       <span class="comment"># to a directory that doesn't get included in the system image.</span>
<a name="l00880"></a>00880       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'LOCAL_MODULE_PATH := $(gyp_shared_intermediate_dir)'</span>)
<a name="l00881"></a>00881       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'include $(BUILD_%sEXECUTABLE)'</span> % modifier)
<a name="l00882"></a>00882     <span class="keywordflow">else</span>:
<a name="l00883"></a>00883       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'LOCAL_MODULE_PATH := $(PRODUCT_OUT)/gyp_stamp'</span>)
<a name="l00884"></a>00884       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'LOCAL_UNINSTALLABLE_MODULE := true'</span>)
<a name="l00885"></a>00885       <span class="keywordflow">if</span> self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#6edae3b79ea9d3c401b57c70a3a1e24b">toolset</a> == <span class="stringliteral">'target'</span>:
<a name="l00886"></a>00886         self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'LOCAL_2ND_ARCH_VAR_PREFIX := $(GYP_VAR_PREFIX)'</span>)
<a name="l00887"></a>00887       <span class="keywordflow">else</span>:
<a name="l00888"></a>00888         self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'LOCAL_2ND_ARCH_VAR_PREFIX := $(GYP_HOST_VAR_PREFIX)'</span>)
<a name="l00889"></a>00889       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>()
<a name="l00890"></a>00890       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'include $(BUILD_SYSTEM)/base_rules.mk'</span>)
<a name="l00891"></a>00891       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>()
<a name="l00892"></a>00892       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'$(LOCAL_BUILT_MODULE): $(LOCAL_ADDITIONAL_DEPENDENCIES)'</span>)
<a name="l00893"></a>00893       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'\t$(hide) echo "Gyp timestamp: $@"'</span>)
<a name="l00894"></a>00894       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'\t$(hide) mkdir -p $(dir $@)'</span>)
<a name="l00895"></a>00895       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'\t$(hide) touch $@'</span>)
<a name="l00896"></a>00896       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>()
<a name="l00897"></a>00897       self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(<span class="stringliteral">'LOCAL_2ND_ARCH_VAR_PREFIX :='</span>)
<a name="l00898"></a>00898 
<a name="l00899"></a>00899 
<a name="l00900"></a><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#93de12c6d9b1aa90c3f3a8b0bfc1fffa">00900</a>   <span class="keyword">def </span><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#93de12c6d9b1aa90c3f3a8b0bfc1fffa">WriteList</a>(self, value_list, variable=None, prefix='',
<a name="l00901"></a>00901                 quoter=make.QuoteIfNecessary, local_pathify=<span class="keyword">False</span>):
<a name="l00902"></a>00902     <span class="stringliteral">"""Write a variable definition that is a list of values.</span>
<a name="l00903"></a>00903 <span class="stringliteral"></span>
<a name="l00904"></a>00904 <span class="stringliteral">    E.g. WriteList(['a','b'], 'foo', prefix='blah') writes out</span>
<a name="l00905"></a>00905 <span class="stringliteral">         foo = blaha blahb</span>
<a name="l00906"></a>00906 <span class="stringliteral">    but in a pretty-printed style.</span>
<a name="l00907"></a>00907 <span class="stringliteral">    """</span>
<a name="l00908"></a>00908     values = <span class="stringliteral">''</span>
<a name="l00909"></a>00909     <span class="keywordflow">if</span> value_list:
<a name="l00910"></a>00910       value_list = [quoter(prefix + l) <span class="keywordflow">for</span> l <span class="keywordflow">in</span> value_list]
<a name="l00911"></a>00911       <span class="keywordflow">if</span> local_pathify:
<a name="l00912"></a>00912         value_list = [self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#a58e8277df9571779e5a5ff7951c5022">LocalPathify</a>(l) <span class="keywordflow">for</span> l <span class="keywordflow">in</span> value_list]
<a name="l00913"></a>00913       values = <span class="stringliteral">' \\\n\t'</span> + <span class="stringliteral">' \\\n\t'</span>.join(value_list)
<a name="l00914"></a>00914     self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#883a1b899b644be7fc6d704c1d8e0c04">fp</a>.write(<span class="stringliteral">'%s :=%s\n\n'</span> % (variable, values))
<a name="l00915"></a>00915 
<a name="l00916"></a>00916 
<a name="l00917"></a><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">00917</a>   <span class="keyword">def </span><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#21df5251912ca34026d59a0933fc1b0a">WriteLn</a>(self, text=''):
<a name="l00918"></a>00918     self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#883a1b899b644be7fc6d704c1d8e0c04">fp</a>.write(text + <span class="stringliteral">'\n'</span>)
<a name="l00919"></a>00919 
<a name="l00920"></a>00920 
<a name="l00921"></a><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#a58e8277df9571779e5a5ff7951c5022">00921</a>   <span class="keyword">def </span><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#a58e8277df9571779e5a5ff7951c5022">LocalPathify</a>(self, path):
<a name="l00922"></a>00922     <span class="stringliteral">"""Convert a subdirectory-relative path into a normalized path which starts</span>
<a name="l00923"></a>00923 <span class="stringliteral">    with the make variable $(LOCAL_PATH) (i.e. the top of the project tree).</span>
<a name="l00924"></a>00924 <span class="stringliteral">    Absolute paths, or paths that contain variables, are just normalized."""</span>
<a name="l00925"></a>00925     <span class="keywordflow">if</span> <span class="stringliteral">'$('</span> <span class="keywordflow">in</span> path <span class="keywordflow">or</span> os.path.isabs(path):
<a name="l00926"></a>00926       <span class="comment"># path is not a file in the project tree in this case, but calling</span>
<a name="l00927"></a>00927       <span class="comment"># normpath is still important for trimming trailing slashes.</span>
<a name="l00928"></a>00928       <span class="keywordflow">return</span> os.path.normpath(path)
<a name="l00929"></a>00929     local_path = os.path.join(<span class="stringliteral">'$(LOCAL_PATH)'</span>, self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#a28dc103258589d9cb421197fe2de90b">path</a>, path)
<a name="l00930"></a>00930     local_path = os.path.normpath(local_path)
<a name="l00931"></a>00931     <span class="comment"># Check that normalizing the path didn't ../ itself out of $(LOCAL_PATH)</span>
<a name="l00932"></a>00932     <span class="comment"># - i.e. that the resulting path is still inside the project tree. The</span>
<a name="l00933"></a>00933     <span class="comment"># path may legitimately have ended up containing just $(LOCAL_PATH), though,</span>
<a name="l00934"></a>00934     <span class="comment"># so we don't look for a slash.</span>
<a name="l00935"></a>00935     <span class="keyword">assert</span> local_path.startswith(<span class="stringliteral">'$(LOCAL_PATH)'</span>), (
<a name="l00936"></a>00936            <span class="stringliteral">'Path %s attempts to escape from gyp path %s !)'</span> % (path, self.<a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#a28dc103258589d9cb421197fe2de90b">path</a>))
<a name="l00937"></a>00937     <span class="keywordflow">return</span> local_path
<a name="l00938"></a>00938 
<a name="l00939"></a>00939 
<a name="l00940"></a><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#88c6708e9588f546826f6886970f724d">00940</a>   <span class="keyword">def </span><a class="code" href="../../d5/dc3/classgyp_1_1generator_1_1android_1_1_android_mk_writer.html#88c6708e9588f546826f6886970f724d">ExpandInputRoot</a>(self, template, expansion, dirname):
<a name="l00941"></a>00941     <span class="keywordflow">if</span> <span class="stringliteral">'%(INPUT_ROOT)s'</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> template <span class="keywordflow">and</span> <span class="stringliteral">'%(INPUT_DIRNAME)s'</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> template:
<a name="l00942"></a>00942       <span class="keywordflow">return</span> template
<a name="l00943"></a>00943     path = template % {
<a name="l00944"></a>00944         <span class="stringliteral">'INPUT_ROOT'</span>: expansion,
<a name="l00945"></a>00945         <span class="stringliteral">'INPUT_DIRNAME'</span>: dirname,
<a name="l00946"></a>00946         }
<a name="l00947"></a>00947     <span class="keywordflow">return</span> os.path.normpath(path)
<a name="l00948"></a>00948 
<a name="l00949"></a>00949 
<a name="l00950"></a><a class="code" href="../../de/d18/namespacegyp_1_1generator_1_1android.html#ece4c096e51f33b2d44fcfd65ba78051">00950</a> <span class="keyword">def </span><a class="code" href="../../de/d18/namespacegyp_1_1generator_1_1android.html#ece4c096e51f33b2d44fcfd65ba78051">PerformBuild</a>(data, configurations, params):
<a name="l00951"></a>00951   <span class="comment"># The android backend only supports the default configuration.</span>
<a name="l00952"></a>00952   options = params[<span class="stringliteral">'options'</span>]
<a name="l00953"></a>00953   makefile = os.path.abspath(os.path.join(options.toplevel_dir,
<a name="l00954"></a>00954                                           <span class="stringliteral">'GypAndroid.mk'</span>))
<a name="l00955"></a>00955   env = dict(os.environ)
<a name="l00956"></a>00956   env[<span class="stringliteral">'ONE_SHOT_MAKEFILE'</span>] = makefile
<a name="l00957"></a>00957   arguments = [<span class="stringliteral">'make'</span>, <span class="stringliteral">'-C'</span>, os.environ[<span class="stringliteral">'ANDROID_BUILD_TOP'</span>], <span class="stringliteral">'gyp_all_modules'</span>]
<a name="l00958"></a>00958   <span class="keywordflow">print</span> <span class="stringliteral">'Building: %s'</span> % arguments
<a name="l00959"></a>00959   subprocess.check_call(arguments, env=env)
<a name="l00960"></a>00960 
<a name="l00961"></a>00961 
<a name="l00962"></a><a class="code" href="../../de/d18/namespacegyp_1_1generator_1_1android.html#61055082552b604aba289ae2f981c45d">00962</a> <span class="keyword">def </span><a class="code" href="../../de/d18/namespacegyp_1_1generator_1_1android.html#61055082552b604aba289ae2f981c45d">GenerateOutput</a>(target_list, target_dicts, data, params):
<a name="l00963"></a>00963   options = params[<span class="stringliteral">'options'</span>]
<a name="l00964"></a>00964   generator_flags = params.get(<span class="stringliteral">'generator_flags'</span>, {})
<a name="l00965"></a>00965   builddir_name = generator_flags.get(<span class="stringliteral">'output_dir'</span>, <span class="stringliteral">'out'</span>)
<a name="l00966"></a>00966   limit_to_target_all = generator_flags.get(<span class="stringliteral">'limit_to_target_all'</span>, <span class="keyword">False</span>)
<a name="l00967"></a>00967   write_alias_targets = generator_flags.get(<span class="stringliteral">'write_alias_targets'</span>, <span class="keyword">True</span>)
<a name="l00968"></a>00968   sdk_version = generator_flags.get(<span class="stringliteral">'aosp_sdk_version'</span>, 19)
<a name="l00969"></a>00969   android_top_dir = os.environ.get(<span class="stringliteral">'ANDROID_BUILD_TOP'</span>)
<a name="l00970"></a>00970   <span class="keyword">assert</span> android_top_dir, <span class="stringliteral">'$ANDROID_BUILD_TOP not set; you need to run lunch.'</span>
<a name="l00971"></a>00971 
<a name="l00972"></a>00972   <span class="keyword">def </span>CalculateMakefilePath(build_file, base_name):
<a name="l00973"></a>00973     <span class="stringliteral">"""Determine where to write a Makefile for a given gyp file."""</span>
<a name="l00974"></a>00974     <span class="comment"># Paths in gyp files are relative to the .gyp file, but we want</span>
<a name="l00975"></a>00975     <span class="comment"># paths relative to the source root for the master makefile.  Grab</span>
<a name="l00976"></a>00976     <span class="comment"># the path of the .gyp file as the base to relativize against.</span>
<a name="l00977"></a>00977     <span class="comment"># E.g. "foo/bar" when we're constructing targets for "foo/bar/baz.gyp".</span>
<a name="l00978"></a>00978     base_path = gyp.common.RelativePath(os.path.dirname(build_file),
<a name="l00979"></a>00979                                         options.depth)
<a name="l00980"></a>00980     <span class="comment"># We write the file in the base_path directory.</span>
<a name="l00981"></a>00981     output_file = os.path.join(options.depth, base_path, base_name)
<a name="l00982"></a>00982     <span class="keyword">assert</span> <span class="keywordflow">not</span> options.generator_output, (
<a name="l00983"></a>00983         <span class="stringliteral">'The Android backend does not support options.generator_output.'</span>)
<a name="l00984"></a>00984     base_path = gyp.common.RelativePath(os.path.dirname(build_file),
<a name="l00985"></a>00985                                         options.toplevel_dir)
<a name="l00986"></a>00986     <span class="keywordflow">return</span> base_path, output_file
<a name="l00987"></a>00987 
<a name="l00988"></a>00988   <span class="comment"># TODO:  search for the first non-'Default' target.  This can go</span>
<a name="l00989"></a>00989   <span class="comment"># away when we add verification that all targets have the</span>
<a name="l00990"></a>00990   <span class="comment"># necessary configurations.</span>
<a name="l00991"></a>00991   default_configuration = <span class="keywordtype">None</span>
<a name="l00992"></a>00992   toolsets = set([target_dicts[target][<span class="stringliteral">'toolset'</span>] <span class="keywordflow">for</span> target <span class="keywordflow">in</span> target_list])
<a name="l00993"></a>00993   <span class="keywordflow">for</span> target <span class="keywordflow">in</span> target_list:
<a name="l00994"></a>00994     spec = target_dicts[target]
<a name="l00995"></a>00995     <span class="keywordflow">if</span> spec[<span class="stringliteral">'default_configuration'</span>] != <span class="stringliteral">'Default'</span>:
<a name="l00996"></a>00996       default_configuration = spec[<span class="stringliteral">'default_configuration'</span>]
<a name="l00997"></a>00997       <span class="keywordflow">break</span>
<a name="l00998"></a>00998   <span class="keywordflow">if</span> <span class="keywordflow">not</span> default_configuration:
<a name="l00999"></a>00999     default_configuration = <span class="stringliteral">'Default'</span>
<a name="l01000"></a>01000 
<a name="l01001"></a>01001   srcdir = <span class="stringliteral">'.'</span>
<a name="l01002"></a>01002   makefile_name = <span class="stringliteral">'GypAndroid'</span> + options.suffix + <span class="stringliteral">'.mk'</span>
<a name="l01003"></a>01003   makefile_path = os.path.join(options.toplevel_dir, makefile_name)
<a name="l01004"></a>01004   <span class="keyword">assert</span> <span class="keywordflow">not</span> options.generator_output, (
<a name="l01005"></a>01005       <span class="stringliteral">'The Android backend does not support options.generator_output.'</span>)
<a name="l01006"></a>01006   gyp.common.EnsureDirExists(makefile_path)
<a name="l01007"></a>01007   root_makefile = open(makefile_path, <span class="stringliteral">'w'</span>)
<a name="l01008"></a>01008 
<a name="l01009"></a>01009   root_makefile.write(header)
<a name="l01010"></a>01010 
<a name="l01011"></a>01011   <span class="comment"># We set LOCAL_PATH just once, here, to the top of the project tree. This</span>
<a name="l01012"></a>01012   <span class="comment"># allows all the other paths we use to be relative to the Android.mk file,</span>
<a name="l01013"></a>01013   <span class="comment"># as the Android build system expects.</span>
<a name="l01014"></a>01014   root_makefile.write(<span class="stringliteral">'\nLOCAL_PATH := $(call my-dir)\n'</span>)
<a name="l01015"></a>01015 
<a name="l01016"></a>01016   <span class="comment"># Find the list of targets that derive from the gyp file(s) being built.</span>
<a name="l01017"></a>01017   needed_targets = set()
<a name="l01018"></a>01018   <span class="keywordflow">for</span> build_file <span class="keywordflow">in</span> params[<span class="stringliteral">'build_files'</span>]:
<a name="l01019"></a>01019     <span class="keywordflow">for</span> target <span class="keywordflow">in</span> gyp.common.AllTargets(target_list, target_dicts, build_file):
<a name="l01020"></a>01020       needed_targets.add(target)
<a name="l01021"></a>01021 
<a name="l01022"></a>01022   build_files = set()
<a name="l01023"></a>01023   include_list = set()
<a name="l01024"></a>01024   android_modules = {}
<a name="l01025"></a>01025   <span class="keywordflow">for</span> qualified_target <span class="keywordflow">in</span> target_list:
<a name="l01026"></a>01026     build_file, target, toolset = gyp.common.ParseQualifiedTarget(
<a name="l01027"></a>01027         qualified_target)
<a name="l01028"></a>01028     relative_build_file = gyp.common.RelativePath(build_file,
<a name="l01029"></a>01029                                                   options.toplevel_dir)
<a name="l01030"></a>01030     build_files.add(relative_build_file)
<a name="l01031"></a>01031     included_files = data[build_file][<span class="stringliteral">'included_files'</span>]
<a name="l01032"></a>01032     <span class="keywordflow">for</span> included_file <span class="keywordflow">in</span> included_files:
<a name="l01033"></a>01033       <span class="comment"># The included_files entries are relative to the dir of the build file</span>
<a name="l01034"></a>01034       <span class="comment"># that included them, so we have to undo that and then make them relative</span>
<a name="l01035"></a>01035       <span class="comment"># to the root dir.</span>
<a name="l01036"></a>01036       relative_include_file = gyp.common.RelativePath(
<a name="l01037"></a>01037           gyp.common.UnrelativePath(included_file, build_file),
<a name="l01038"></a>01038           options.toplevel_dir)
<a name="l01039"></a>01039       abs_include_file = os.path.abspath(relative_include_file)
<a name="l01040"></a>01040       <span class="comment"># If the include file is from the ~/.gyp dir, we should use absolute path</span>
<a name="l01041"></a>01041       <span class="comment"># so that relocating the src dir doesn't break the path.</span>
<a name="l01042"></a>01042       <span class="keywordflow">if</span> (params[<span class="stringliteral">'home_dot_gyp'</span>] <span class="keywordflow">and</span>
<a name="l01043"></a>01043           abs_include_file.startswith(params[<span class="stringliteral">'home_dot_gyp'</span>])):
<a name="l01044"></a>01044         build_files.add(abs_include_file)
<a name="l01045"></a>01045       <span class="keywordflow">else</span>:
<a name="l01046"></a>01046         build_files.add(relative_include_file)
<a name="l01047"></a>01047 
<a name="l01048"></a>01048     base_path, output_file = CalculateMakefilePath(build_file,
<a name="l01049"></a>01049         target + <span class="stringliteral">'.'</span> + toolset + options.suffix + <span class="stringliteral">'.mk'</span>)
<a name="l01050"></a>01050 
<a name="l01051"></a>01051     spec = target_dicts[qualified_target]
<a name="l01052"></a>01052     configs = spec[<span class="stringliteral">'configurations'</span>]
<a name="l01053"></a>01053 
<a name="l01054"></a>01054     part_of_all = qualified_target <span class="keywordflow">in</span> needed_targets
<a name="l01055"></a>01055     <span class="keywordflow">if</span> limit_to_target_all <span class="keywordflow">and</span> <span class="keywordflow">not</span> part_of_all:
<a name="l01056"></a>01056       <span class="keywordflow">continue</span>
<a name="l01057"></a>01057 
<a name="l01058"></a>01058     relative_target = gyp.common.QualifiedTarget(relative_build_file, target,
<a name="l01059"></a>01059                                                  toolset)
<a name="l01060"></a>01060     writer = AndroidMkWriter(android_top_dir)
<a name="l01061"></a>01061     android_module = writer.Write(qualified_target, relative_target, base_path,
<a name="l01062"></a>01062                                   output_file, spec, configs,
<a name="l01063"></a>01063                                   part_of_all=part_of_all,
<a name="l01064"></a>01064                                   write_alias_target=write_alias_targets,
<a name="l01065"></a>01065                                   sdk_version=sdk_version)
<a name="l01066"></a>01066     <span class="keywordflow">if</span> android_module <span class="keywordflow">in</span> android_modules:
<a name="l01067"></a>01067       <span class="keywordflow">print</span> (<span class="stringliteral">'ERROR: Android module names must be unique. The following '</span>
<a name="l01068"></a>01068              <span class="stringliteral">'targets both generate Android module name %s.\n  %s\n  %s'</span> %
<a name="l01069"></a>01069              (android_module, android_modules[android_module],
<a name="l01070"></a>01070               qualified_target))
<a name="l01071"></a>01071       <span class="keywordflow">return</span>
<a name="l01072"></a>01072     android_modules[android_module] = qualified_target
<a name="l01073"></a>01073 
<a name="l01074"></a>01074     <span class="comment"># Our root_makefile lives at the source root.  Compute the relative path</span>
<a name="l01075"></a>01075     <span class="comment"># from there to the output_file for including.</span>
<a name="l01076"></a>01076     mkfile_rel_path = gyp.common.RelativePath(output_file,
<a name="l01077"></a>01077                                               os.path.dirname(makefile_path))
<a name="l01078"></a>01078     include_list.add(mkfile_rel_path)
<a name="l01079"></a>01079 
<a name="l01080"></a>01080   root_makefile.write(<span class="stringliteral">'GYP_CONFIGURATION ?= %s\n'</span> % default_configuration)
<a name="l01081"></a>01081   root_makefile.write(<span class="stringliteral">'GYP_VAR_PREFIX ?=\n'</span>)
<a name="l01082"></a>01082   root_makefile.write(<span class="stringliteral">'GYP_HOST_VAR_PREFIX ?=\n'</span>)
<a name="l01083"></a>01083   root_makefile.write(<span class="stringliteral">'GYP_HOST_MULTILIB ?=\n'</span>)
<a name="l01084"></a>01084 
<a name="l01085"></a>01085   <span class="comment"># Write out the sorted list of includes.</span>
<a name="l01086"></a>01086   root_makefile.write(<span class="stringliteral">'\n'</span>)
<a name="l01087"></a>01087   <span class="keywordflow">for</span> include_file <span class="keywordflow">in</span> sorted(include_list):
<a name="l01088"></a>01088     root_makefile.write(<span class="stringliteral">'include $(LOCAL_PATH)/'</span> + include_file + <span class="stringliteral">'\n'</span>)
<a name="l01089"></a>01089   root_makefile.write(<span class="stringliteral">'\n'</span>)
<a name="l01090"></a>01090 
<a name="l01091"></a>01091   <span class="keywordflow">if</span> write_alias_targets:
<a name="l01092"></a>01092     root_makefile.write(ALL_MODULES_FOOTER)
<a name="l01093"></a>01093 
<a name="l01094"></a>01094   root_makefile.close()
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Wed Oct 7 19:26:26 2015 for Emeraldion Lodge (codename Zelda) by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.8 </small></address>
</body>
</html>
